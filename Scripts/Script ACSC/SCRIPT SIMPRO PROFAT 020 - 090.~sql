WITH SAI_PRO AS (SELECT 
       PD.CD_PRODUTO,
       PD.CD_ESPECIE ,
       ESP.DS_ESPECIE,
       PD.CD_CLASSE,
       CLS.DS_CLASSE,
       PD.CD_SUB_CLA,
       SCLS.DS_SUB_CLA,
       SCLS.SN_SAIDA_PACIENTE,
       SCLS.SN_SAIDA_CC
FROM
PRODUTO PD
INNER JOIN ESPECIE ESP ON ESP.CD_ESPECIE = PD.CD_ESPECIE 
INNER JOIN CLASSE CLS ON CLS.CD_ESPECIE = ESP.CD_ESPECIE AND PD.CD_CLASSE = CLS.CD_CLASSE
INNER JOIN SUB_CLAS SCLS ON SCLS.CD_CLASSE = PD.CD_CLASSE AND PD.CD_SUB_CLA = SCLS.CD_SUB_CLA
AND SCLS.CD_ESPECIE = PD.CD_ESPECIE
WHERE 1 = 1)
(
SELECT 
X.CD_PRO_FAT,
X.DS_PRO_FAT,
--X.CD_GRU_PRO,
PD.CD_PRODUTO,
SPR.SN_SAIDA_PACIENTE SAIDA_PACIENTE,
SPR.SN_SAIDA_CC SAIDA_SETOR,
PD.CD_ESPECIE,
PD.VL_ULTIMA_ENTRADA,
SP.CD_SIMPRO,
VP.CD_TAB_FAT,
TRUNC(VP.DT_VIGENCIA)DT_VIGENCIA,
VP.VL_TOTAL

FROM 
PRO_FAT X 
LEFT JOIN IMP_SIMPRO SP ON SP.CD_PRO_FAT = X.CD_PRO_FAT
LEFT JOIN VAL_PRO VP ON VP.CD_PRO_FAT = X.CD_PRO_FAT AND VP.CD_TAB_FAT = SP.CD_TAB_FAT
INNER JOIN PRODUTO PD ON PD.CD_PRO_FAT = X.CD_PRO_FAT 
INNER JOIN SAI_PRO SPR ON SPR.CD_PRODUTO = PD.CD_PRODUTO 
WHERE VP.DT_VIGENCIA = (SELECT MAX(VPX.DT_VIGENCIA)FROM VAL_PRO VPX WHERE VPX.CD_PRO_FAT = VP.CD_PRO_FAT AND VPX.CD_TAB_FAT = VP.CD_TAB_FAT) 
AND (X.CD_PRO_FAT LIKE '020%' OR X.CD_PRO_FAT LIKE '090%')
AND X.CD_GRU_PRO IN (8,95,89,96)
AND SP.CD_TAB_FAT = 2 
--ORDER BY 1 
)
ORDER BY 1
      
--TABELAS IN (2)




SELECT * FROM PRODUTO WHERE CD_PRODUTO IN (80690,2040923)
