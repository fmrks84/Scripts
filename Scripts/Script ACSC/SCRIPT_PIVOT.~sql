SELECT 
*
FROM
(
SELECT 
TO_CHAR(A.DT_ATENDIMENTO,'DD')DIA_MES,
TO_CHAR(A.DT_ATENDIMENTO,'MM')MES
FROM 
ATENDIME A 
WHERE TO_CHAR(A.DT_ATENDIMENTO,'DD') BETWEEN '01' AND '31' -- DIA
AND TO_CHAR(A.DT_ATENDIMENTO,'MM') BETWEEN '01' AND '01' -- MES
AND TO_CHAR(A.DT_ATENDIMENTO,'RRRR') = '2023' -- ANO
AND A.TP_ATENDIMENTO = 'I'
AND A.CD_MULTI_EMPRESA = 7

)
PIVOT
(COUNT(MES)
  FOR MES IN ('01' AS JANEIRO,
              '02'AS FEVEREIRO,
              '03' AS MARÇO,
              '04' AS ABRIL,
              '05' AS MAIO,
              '06' AS JUNHO,
              '07' AS JULHO,
              '08' AS AGOSTO,
              '09' AS SETEMBRO,
              '10' AS OUTUBRO,
              '11' AS NOVEMBRO,
              '12' AS DEZEMBRO))
ORDER BY 1 
;

SELECT 
       
       TO_CHAR(X.DT_AGENDA,'DAY')DIA_SEMANA,
       X.DT_AGENDA,
       TO_CHAR(XI.HR_AGENDA,'HH24:MI')HORA,
       XI.NM_PACIENTE,
       X.CD_SETOR,
       ST.NM_SETOR,
       X.CD_PRESTADOR,
       PR.NM_PRESTADOR,
       CASE WHEN NM_PACIENTE IS NOT NULL THEN 1 ELSE 0 END QTD_AGENDAMENTOS

 FROM 
AGENDA_CENTRAL X 
INNER JOIN It_Agenda_Central XI ON XI.CD_AGENDA_CENTRAL = X.CD_AGENDA_CENTRAL
INNER JOIN SETOR ST ON ST.CD_SETOR = X.CD_SETOR
INNER JOIN PRESTADOR PR ON PR.CD_PRESTADOR = X.CD_PRESTADOR
WHERE X.DT_AGENDA BETWEEN '01/03/2023' AND '31/03/2023'
AND X.CD_MULTI_EMPRESA = 7
AND X.CD_SETOR = 151
AND X.CD_PRESTADOR = 28103
AND XI.NM_PACIENTE IS NOT NULL
--AND TO_CHAR(X.DT_AGENDA,'D') = 4
--AND TO_CHAR(XI.HR_AGENDA,'HH24:MI') = '13:00'
ORDER BY 2 
;


SELECT 
*
FROM
(
SELECT 
DIA_SEMANA,
HORA,
MES
FROM
(
SELECT 
       X.DT_AGENDA,
       TO_CHAR(X.DT_AGENDA,'D')DIA_SEMANA,
       TO_CHAR(X.DT_AGENDA,'DD')DIA,
       TO_CHAR(X.DT_AGENDA,'MM')MES,
       TO_CHAR(XI.HR_AGENDA,'HH24:MI')HORA,
       XI.NM_PACIENTE,
       X.CD_SETOR,
       ST.NM_SETOR,
       X.CD_PRESTADOR,
       PR.NM_PRESTADOR,
       CASE WHEN NM_PACIENTE IS NOT NULL THEN 1 ELSE 0 END QTD

 FROM 
AGENDA_CENTRAL X 
INNER JOIN It_Agenda_Central XI ON XI.CD_AGENDA_CENTRAL = X.CD_AGENDA_CENTRAL
INNER JOIN SETOR ST ON ST.CD_SETOR = X.CD_SETOR
INNER JOIN PRESTADOR PR ON PR.CD_PRESTADOR = X.CD_PRESTADOR
WHERE --TO_CHAR(X.DT_AGENDA,'DD') BETWEEN '01' AND '31' -- DIA
/*AND*/  TO_CHAR(X.DT_AGENDA,'MM')  BETWEEN '03' AND '03' -- MES
AND TO_CHAR(X.DT_AGENDA,'RRRR') = 2023 --ANO 
--AND  TO_CHAR(X.DT_AGENDA,'D') IN (4)--(1,2,3,4,5,6,7)
--AND TO_CHAR(XI.HR_AGENDA,'HH24:MI') = '13:00'
AND X.CD_MULTI_EMPRESA = 7
AND X.CD_SETOR = 151
AND X.CD_PRESTADOR = 28103
AND XI.NM_PACIENTE IS NOT NULL 
--AND XI.NM_PACIENTE IS NULL 

ORDER BY 2
) 
)
PIVOT
  (COUNT(MES)
    FOR (DIA_SEMANA) IN ('2' AS SEGUNDA,
                  '3' AS TERÇA,
                  '4'AS QUARTA,
                  '5'AS QUINTA,
                  '6'AS SEXTA,
                  '7'AS SÁBADO,
                  '1'AS DOMINGO))
                 

ORDER BY 1



