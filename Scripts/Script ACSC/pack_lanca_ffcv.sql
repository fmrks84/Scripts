CREATE OR REPLACE PACKAGE dbamv.pack_lanca_ffcv IS



  --PDA 157595(INICIO) 22/04/2008 Jansen  Gallindo

  -- Estes cursores abaixo foram transformados em fun????o e sua chamada ser?? a partir da DBAMV.PKG_FFCV_CONTA

  --   CURSOR c_conta (

  --   CURSOR c_contaambu (

  --   CURSOR c_contapart (

  --   CURSOR c_contapartambu (

  --   CURSOR c_contapartambu_loteunico (

  --PDA 157595(FIM) 22/04/2008 Jansen Gallindo

  CURSOR c_Maxlcto(Nconta IN Dbamv.Itreg_Fat.Cd_Reg_Fat%TYPE /*number PDA 254997*/

  ) IS

  --PDA 147506 - 31/03/20006 (Inicio)

  --Alterada a maneira de obter o sequencial da itre_fat para buscar tamb??m da tabela log_pro_fat_empresa para

  -- SELECT NVL (MAX (itreg_fat.cd_lancamento), 0) + 1 cd_max

  --   FROM dbamv.itreg_fat

  --  WHERE itreg_fat.cd_reg_fat = nconta;

    SELECT Dbamv.Pkg_Ffcv_It_Conta.Fnc_Obtem_Sequencia(Nconta, 'H') Cd_Max

      FROM Dual;



  --PDA 147506 - 31/03/20006 (Fim)

  CURSOR c_Maxlctoambu(Nconta IN Dbamv.Itreg_Amb.Cd_Reg_Amb%TYPE /*number PDA 254997*/

  ) IS

    SELECT Nvl(MAX(Itreg_Amb.Cd_Lancamento), 0) + 1 Cd_Max

      FROM Dbamv.Itreg_Amb

     WHERE Itreg_Amb.Cd_Reg_Amb = Nconta;



  CURSOR c_Itregfat(Nconta IN Dbamv.Itreg_Fat.Cd_Reg_Fat%TYPE /*number PDA 254997*/

  , Cprofat IN VARCHAR2) IS

    SELECT Itreg_Fat.Cd_Lancamento,

           Itreg_Fat.Qt_Lancamento

           -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

          ,

           Itreg_Fat.Cd_Reg_Fat

    -- PDA 167142 (Fim)

    /* --PDA 173136 (inicio)

                      ,itreg_fat.dt_lancamento

                      --PDA 173136 (fim)    */

      FROM Dbamv.Itreg_Fat

     WHERE Itreg_Fat.Cd_Reg_Fat = Nconta

       AND Itreg_Fat.Cd_Pro_Fat = Cprofat

    -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

    --ORDER BY itreg_fat.qt_lancamento DESC;

    UNION

    SELECT Itreg_Fat.Cd_Lancamento,

           Itreg_Fat.Qt_Lancamento,

           Itreg_Fat.Cd_Reg_Fat

    -- ,itreg_fat.dt_lancamento

      FROM Dbamv.Itreg_Fat

     WHERE Itreg_Fat.Cd_Conta_Pai = Nconta

       AND Itreg_Fat.Cd_Pro_Fat = Cprofat

     ORDER BY 2 DESC;



  -- PDA 167142 (Fim)

  /* pdas 162293/158955 - Corigindo filtro do cd_mvto */

  --

  /* pda 141006 - 06/06/2006 - Amalia Ara?jo

  Corrigindo condi????o do cd_mvto, pois por causa desta condi????o o cursor n??o traz o

  registro se o cd_mvto estiver nulo.      (nos dois cursores abaixo)         */

  --

  /*PDA 303739(inicio) - 18/08/2009 - Jansen Gallindo

  Retirado o trunc do campo dt_lancamento das tabelas abaixo e inclu??do o comando + 86399/86400 para garantir

  que a hora da compara????o do lado direito sempre ser?? maior que o lado esquerdo. Inclu?da a tabela reg_fat

  na segunda query para fazer join com a itreg_fat e a tabela hospital na coluna cd_multi_empresa. Estas

  solu??es forma dadas por conta de um problema de performance no cliente Unimed Vitoria.*/

  -- pda 81303 - 06/11/2003 - Amalia Ara??jo

  -- inclus??o do par??metro pdt_mvto para controlar a subtra????o de itens devolvidos, retirando

  -- do documento referente a data informada na devolu????o.

  CURSOR c_Itregfat_Dt(Nconta IN Dbamv.Itreg_Fat.Cd_Reg_Fat%TYPE /*number PDA 254997*/

  , Cprofat IN VARCHAR2, Cdsetor NUMBER, Pcd_Mvto NUMBER DEFAULT NULL, Pdt_Mvto DATE DEFAULT NULL, Pcd_Itemmvto NUMBER DEFAULT NULL) IS

    SELECT Itreg_Fat.Cd_Lancamento,

           Itreg_Fat.Qt_Lancamento

           -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

          ,

           Itreg_Fat.Cd_Reg_Fat

           -- PDA 167142 (Fim)

           --PDA 173136 (inicio)

          ,

           Itreg_Fat.Dt_Lancamento

    --PDA 173136 (fim)

      FROM Dbamv.Itreg_Fat

     WHERE Itreg_Fat.Cd_Reg_Fat = Nconta

       AND Itreg_Fat.Cd_Pro_Fat = Cprofat

       AND Itreg_Fat.Cd_Setor = Cdsetor

          --AND ( itreg_fat.cd_mvto = pcd_mvto or itreg_fat.cd_mvto is null )

          --AND itreg_fat.cd_mvto = NVL (pcd_mvto, itreg_fat.cd_mvto)

       AND (Itreg_Fat.Cd_Mvto = Nvl(Pcd_Mvto, Itreg_Fat.Cd_Mvto) OR

           Itreg_Fat.Cd_Mvto IS NULL) -- pdas 162293/158955

          --PDA 100545 -- Alexandre Erik C. M. Costa -- 06/10/2004 (INICIO)

          --Pegar uma data menor ou igual

          --and trunc(itreg_fat.dt_lancamento) = nvl(trunc(pdt_mvto),trunc(itreg_fat.dt_lancamento)) -- pda 81303

          /*AND TRUNC (itreg_fat.dt_lancamento) <= NVL (TRUNC (pdt_mvto), TRUNC (itreg_fat.dt_lancamento))*/ -- pda 81303

       AND Itreg_Fat.Dt_Lancamento <=

           Trunc(Nvl(Pdt_Mvto, Itreg_Fat.Dt_Lancamento)) + 86399 / 86400

    --PDA 100545 -- (FIM)

    -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

    --ORDER BY itreg_fat.qt_lancamento DESC;

    UNION

    SELECT Itreg_Fat.Cd_Lancamento,

           Itreg_Fat.Qt_Lancamento,

           Itreg_Fat.Cd_Reg_Fat,

           Itreg_Fat.Dt_Lancamento

      FROM Dbamv.Itreg_Fat,

           Dbamv.Hospital -- PDA 200218

          ,

           Dbamv.Reg_Fat

     WHERE Itreg_Fat.Cd_Conta_Pai = Nconta

       AND Itreg_Fat.Cd_Pro_Fat = Cprofat

       AND Itreg_Fat.Cd_Setor = Cdsetor

       AND Hospital.Cd_Hospital = '719' -- PDA 200218

       AND Reg_Fat.Cd_Reg_Fat = Itreg_Fat.Cd_Reg_Fat

       AND Reg_Fat.Cd_Multi_Empresa = Hospital.Cd_Multi_Empresa

       AND (Itreg_Fat.Cd_Mvto = Nvl(Pcd_Mvto, Itreg_Fat.Cd_Mvto) OR

           Itreg_Fat.Cd_Mvto IS NULL)

          /*AND TRUNC (itreg_fat.dt_lancamento) <= NVL (TRUNC (pdt_mvto), TRUNC (itreg_fat.dt_lancamento))*/

       AND Itreg_Fat.Dt_Lancamento <=

           Trunc(Nvl(Pdt_Mvto, Itreg_Fat.Dt_Lancamento)) + 86399 / 86400

    -- PDA 182149 (In??cio) - 27/04/2007 - FL??VIO LAGO

    --

    UNION ALL

    SELECT Itreg_Fat.Cd_Lancamento,

           Itreg_Fat.Qt_Lancamento,

           Itreg_Fat.Cd_Reg_Fat,

           Itreg_Fat.Dt_Lancamento

      FROM Dbamv.Itreg_Fat

     WHERE Itreg_Fat.Cd_Conta_Pai = Nconta

       AND Itreg_Fat.Cd_Pro_Fat = Cprofat

       AND Itreg_Fat.Cd_Setor = Cdsetor

       AND (Itreg_Fat.Cd_Mvto = Nvl(Pcd_Mvto, Itreg_Fat.Cd_Mvto) OR

           Itreg_Fat.Cd_Mvto IS NULL)

          /*AND TRUNC (itreg_fat.dt_lancamento) <= NVL (TRUNC (pdt_mvto), TRUNC (itreg_fat.dt_lancamento))*/

       AND Itreg_Fat.Dt_Lancamento <=

           Trunc(Nvl(Pdt_Mvto, Itreg_Fat.Dt_Lancamento)) + 86399 / 86400

       AND (Itreg_Fat.Cd_Itmvto = Nvl(Pcd_Itemmvto, Itreg_Fat.Cd_Itmvto) OR

           Itreg_Fat.Cd_Itmvto IS NULL)

    -- PDA 264001 (Inicio) - Henrique Antunes - 16/12/2008

    UNION

    SELECT Itreg_Fat.Cd_Lancamento,

           Itreg_Fat.Qt_Lancamento,

           Itreg_Fat.Cd_Reg_Fat,

           Itreg_Fat.Dt_Lancamento

      FROM Dbamv.Itreg_Fat,

           Dbamv.Reg_Fat Reg_Fat_Lancamento,

           Dbamv.Reg_Fat

     WHERE Reg_Fat_Lancamento.Cd_Reg_Fat = Nconta

       AND Reg_Fat.Cd_Atendimento = Reg_Fat_Lancamento.Cd_Atendimento

       AND Reg_Fat.Cd_Convenio = Reg_Fat_Lancamento.Cd_Convenio

       AND Reg_Fat.Cd_Multi_Empresa = Reg_Fat_Lancamento.Cd_Multi_Empresa

       AND Reg_Fat.Sn_Fechada = 'N'

       AND Nvl(Reg_Fat.Sn_Importa_Auto, 'S') = 'S'

          -- PDA 264001 (Inicio) - Henrique Antunes - 17/12/2008

       AND Itreg_Fat.Cd_Reg_Fat = Reg_Fat.Cd_Reg_Fat

          -- PDA 264001 (Fim)

       AND Itreg_Fat.Cd_Pro_Fat = Cprofat

       AND Itreg_Fat.Cd_Setor = Cdsetor

    -- PDA 264001 (Fim)

    --

    -- PDA 182149 (FIM) - 27/04/2007 - FL??VIO LAGO

     ORDER BY 4 DESC,

              2 DESC;



  -- PDA 167142 (Fim)

  -- pda 81303 - fim

  -- pdas 162293/158955 - fim

  /*PDA 303739(Fim) - 18/08/2009 - Jansen Gallindo*/



  -- FATURCONV-2030 - Cursor que considera o setor da movimenta????o de devolu????o.

  CURSOR c_itregamb_st( Nconta IN Dbamv.Itreg_Amb.Cd_Reg_Amb%TYPE, Cprofat IN VARCHAR2, Natend IN NUMBER, nSetor NUMBER, Pcd_Mvto NUMBER DEFAULT NULL ) IS

    SELECT Itreg_Amb.Cd_Lancamento,

           Itreg_Amb.Qt_Lancamento

      FROM Dbamv.Itreg_Amb

     WHERE Itreg_Amb.Cd_Reg_Amb = Nconta

       AND Itreg_Amb.Cd_Pro_Fat = Cprofat

       AND Itreg_Amb.Cd_Atendimento = Natend

       AND itreg_amb.cd_setor = nSetor

       AND (Itreg_Amb.Cd_Mvto = Nvl(Pcd_Mvto, Itreg_Amb.Cd_Mvto) OR Itreg_Amb.Cd_Mvto IS NULL)

       AND Itreg_Amb.Sn_Fechada = 'N'

     ORDER BY Itreg_Amb.Qt_Lancamento DESC;



  CURSOR c_Itregamb(Nconta IN Dbamv.Itreg_Amb.Cd_Reg_Amb%TYPE /*number PDA 254997*/

  , Cprofat IN VARCHAR2, Natend IN NUMBER, Pcd_Mvto NUMBER DEFAULT NULL) IS

    SELECT Itreg_Amb.Cd_Lancamento,

           Itreg_Amb.Qt_Lancamento

      FROM Dbamv.Itreg_Amb

     WHERE Itreg_Amb.Cd_Reg_Amb = Nconta

       AND Itreg_Amb.Cd_Pro_Fat = Cprofat

       AND Itreg_Amb.Cd_Atendimento = Natend

          --AND itreg_amb.cd_mvto = NVL (pcd_mvto, itreg_amb.cd_mvto)

          --           AND ( itreg_amb.cd_mvto = pcd_mvto or itreg_amb.cd_mvto is null ) -- PDA 168851 Inicio/Fim

       AND (Itreg_Amb.Cd_Mvto = Nvl(Pcd_Mvto, Itreg_Amb.Cd_Mvto) OR

           Itreg_Amb.Cd_Mvto IS NULL) -- PDA 168851 Inicio/Fim

       AND Itreg_Amb.Sn_Fechada = 'N'

     ORDER BY Itreg_Amb.Qt_Lancamento DESC;



  /* pda 141006 - fim */

  CURSOR c_Guia(Cprofat IN VARCHAR2, Natend IN NUMBER) IS

  -- Keilla 21/09/2004 pda 106335 inicio

  -- alterado o cursor pois o sistema estava sugerindo uma guia  que j?? tinha toda sua quantidade utilizada

  /* Select guia.cd_guia

                 From dbamv.guia,

                         dbamv.it_guia

                Where guia.cd_atendimento = nAtend

                   and it_guia.cd_pro_fat = cProFat

                   and guia.cd_guia = it_guia.cd_guia ;*/

    SELECT Guia.Cd_Guia

      FROM Dbamv.Guia,

           Dbamv.It_Guia,

           Dbamv.Atendime /* PDA 118607/130619 */

     WHERE Guia.Cd_Atendimento = Atendime.Cd_Atendimento /* PDA 118607/130619 */

       AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /*PDA 118607/130619 */

       AND Guia.Cd_Guia = It_Guia.Cd_Guia

       AND Guia.Cd_Atendimento = Natend

       AND Guia.Dt_Negacao IS NULL

       AND Guia.Dt_Suspensao IS NULL

       AND It_Guia.Cd_Pro_Fat = Cprofat

          --             AND qt_autorizado >  -- pda 108337

       AND Nvl(It_Guia.Qt_Autorizada_Convenio, It_Guia.Qt_Autorizado) >

           (SELECT SUM(Nvl(Qt_Lancamento, 0))

              FROM (SELECT Cd_Guia,

                           Cd_Convenio,

                           Nvl(Qt_Lancamento, 0) Qt_Lancamento

                      FROM Dbamv.Itreg_Amb

                     WHERE Cd_Atendimento = Natend

                       AND Cd_Pro_Fat = Cprofat -- PDA 115593 (In??cio) - Henrique Antunes - 05/08/2005

                       AND Cd_Guia IS NULL

                    -- PDA 115593 (Fim)

                    UNION ALL

                    SELECT Itf.Cd_Guia,

                           Fat.Cd_Convenio,

                           Nvl(Qt_Lancamento, 0) Qt_Lancamento

                      FROM Dbamv.Reg_Fat   Fat,

                           Dbamv.Itreg_Fat Itf

                     WHERE Fat.Cd_Atendimento = Natend

                       AND Fat.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /*PDA 118607/127754*/

                       AND Fat.Cd_Reg_Fat = Itf.Cd_Reg_Fat

                       AND Itf.Cd_Pro_Fat = Cprofat

                          -- PDA 115593 (In??cio) - Henrique Antunes - 05/08/2005

                       AND Itf.Cd_Guia IS NULL) Item

                   -- PDA 115593 (Fim)

                  ,

                   Dbamv.Guia,

                   Dbamv.Atendime /* PDA 118607/130619 */

             WHERE Guia.Cd_Atendimento = Atendime.Cd_Atendimento /* PDA 118607/130619 */

               AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /*PDA 118607/130619 */

               AND Guia.Cd_Guia = It_Guia.Cd_Guia

               AND Guia.Cd_Guia = Item.Cd_Guia(+)

               AND Guia.Cd_Convenio = Item.Cd_Convenio(+));



  -- pda 106335 fim

  CURSOR c_Itguia(Cprofat IN VARCHAR2, Natend IN NUMBER) IS

  -- SELECT SUM (it_guia.qt_autorizado) qt_autorizado --  pda 108337

    SELECT SUM(Nvl(It_Guia.Qt_Autorizada_Convenio, It_Guia.Qt_Autorizado)) Qt_Autorizado -- pda 108337

      FROM Dbamv.Guia,

           Dbamv.It_Guia,

           Dbamv.Atendime /* PDA 118607/130619 */

     WHERE Guia.Cd_Atendimento = Atendime.Cd_Atendimento /* PDA 118607/130619 */

       AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

       AND Guia.Cd_Atendimento = Natend /*PDA 118607/130619 */

       AND It_Guia.Cd_Pro_Fat = Cprofat

       AND Guia.Cd_Guia = It_Guia.Cd_Guia;



  CURSOR c_Itguia_Proc_Auto(Cprofat IN VARCHAR2, Natend IN NUMBER) IS

  -- SELECT SUM (it_guia.qt_autorizado) qt_autorizado --  pda 108337

    SELECT SUM(Nvl(It_Guia.Qt_Autorizada_Convenio, It_Guia.Qt_Autorizado)) Qt_Autorizado -- pda 108337

      FROM Dbamv.Guia,

           Dbamv.It_Guia,

           Dbamv.Atendime /* PDA 118607/130619 */

     WHERE Guia.Cd_Atendimento = Atendime.Cd_Atendimento /* PDA 118607/130619 */

       AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

       AND Guia.Cd_Atendimento = Natend /*PDA 118607/130619 */

       AND It_Guia.Cd_Pro_Fat = Cprofat

       AND Guia.Cd_Guia = It_Guia.Cd_Guia

       AND Guia.Dt_Negacao IS NULL

       AND Guia.Dt_Suspensao IS NULL;



  /* PDA.: 298512 - 21/09/2009 - Emanoel Deivison

     Descri????o: Adicionado o campo: "cd_pro_fat_solicitado" da tabela: "dbamv.reg_fat" ao cursor: "c_pacotehosp"

  */

  CURSOR c_Pacotehosp(Nconta IN Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*number PDA 254997*/

  ) IS

    SELECT Nvl(Pro_Fat.Sn_Pacote, 'N') Sn_Pacote,

           Reg_Fat.Cd_Pro_Fat_Solicitado Cd_Pro_Fat_Solicitado

      FROM Dbamv.Pro_Fat,

           Dbamv.Reg_Fat

     WHERE Pro_Fat.Cd_Pro_Fat = Reg_Fat.Cd_Pro_Fat_Solicitado

       AND Reg_Fat.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /*PDA 118607/127754*/

       AND Reg_Fat.Cd_Reg_Fat = Nconta;



  /* PDA.: 298512 - 21/09/2009 - Emanoel Deivison (fim)*/

  /*Cursor C_Pacote( nAtend IN Number, nConta in Number ) is

  Select Nvl( pro_fat.sn_pacote, 'N' ) sn_pacote

     From dbamv.pro_fat,

             dbamv.itreg_amb

    Where itreg_amb.cd_pro_fat = pro_fat.cd_pro_fat

       and itreg_amb.cd_atendimento = nAtend

       and itreg_amb.cd_reg_amb = nConta

  Order by pro_fat.sn_pacote desc ;*/

  /*PDA.: 298512 - 21/09/2009 - Emanoel Deivison

    Descri????o: Adicionado ao cursor "c_pacote" o campo: "cd_pro_int" da tabela: "dbamv.atendime"

  */

  CURSOR c_Pacote(Natend IN NUMBER, Nconta IN Dbamv.Itreg_Fat.Cd_Reg_Fat%TYPE /*NUMBER PDA 254997*/

  ) IS

    SELECT Nvl(Pro_Fat.Sn_Pacote, 'N') Sn_Pacote,

           Atendime.Cd_Pro_Int Cd_Pro_Int

      FROM Dbamv.Pro_Fat,

           Dbamv.Atendime

     WHERE Atendime.Cd_Pro_Int = Pro_Fat.Cd_Pro_Fat

       AND Atendime.Cd_Atendimento = Natend

       AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;



  /*PDA.: 298512 - 21/09/2009 - Emanoel Deivison (fim)*/

  /* pda 288806 - 03/06/2009 - Amalia Ara??jo - Incluindo a data de vig??ncia na ordena????o, para considerar a mais atual.   */

  /* PDA 106102 -- Alexandre Erik C. M. Costa -- 13/09/2004

  Alterar o cursor abaixo para restringir pelo tipo de atendimento e multi-empresa. A restri??o pelo tipo de atendimento

  j?? existia, mas n??o respeitava a informa????o mais espec?fica, ou seja, caso existisse um tipo de proibi????o para o

  tipo de atendimento 'A' e um para todos 'T', o sistema n??o restringia pelo 'A', agora est?? restringindo.                       */

  CURSOR c_Proibicao(Cprofat IN VARCHAR2, Nconv IN NUMBER, Nplano IN Dbamv.Proibicao.Cd_Con_Pla%TYPE /*NUMBER PDA 254997*/

  , Ctpatend IN VARCHAR2, Drefer IN DATE, Nsetor IN NUMBER) IS

    SELECT Tp_Proibicao

      FROM (SELECT Proibicao.Tp_Proibicao,

                   Proibicao.Dt_Inicial_Proibicao,

                   0 Ds_Ordem

              FROM Dbamv.Proibicao

             WHERE Proibicao.Cd_Pro_Fat = Substr(Cprofat, 1, 8)

               AND Cd_Multi_Empresa =

                   Nvl(Substr(Cprofat, 10, Length(Cprofat)),

                       Cd_Multi_Empresa)

               AND Proibicao.Cd_Convenio = Nconv

               AND Proibicao.Cd_Con_Pla = Nplano

               AND Proibicao.Tp_Atendimento = Ctpatend

               AND Trunc(Nvl(Proibicao.Dt_Inicial_Proibicao, SYSDATE)) <=

                   Drefer

               AND Proibicao.Cd_Setor = Nsetor

               AND Proibicao.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /*PDA 147099 - Sp??ndola - 08/03/2006 - Restringir a multi-empresa*/

            UNION

            SELECT Proibicao.Tp_Proibicao,

                   Proibicao.Dt_Inicial_Proibicao,

                   1 Ds_Ordem

              FROM Dbamv.Proibicao

             WHERE Proibicao.Cd_Pro_Fat = Substr(Cprofat, 1, 8)

               AND Cd_Multi_Empresa =

                   Nvl(Substr(Cprofat, 10, Length(Cprofat)),

                       Cd_Multi_Empresa)

               AND Proibicao.Cd_Convenio = Nconv

               AND Proibicao.Cd_Con_Pla = Nplano

               AND Proibicao.Tp_Atendimento = 'T'

               AND Trunc(Nvl(Proibicao.Dt_Inicial_Proibicao, SYSDATE)) <=

                   Drefer

               AND Proibicao.Cd_Setor = Nsetor

               AND Proibicao.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /*PDA 147099 - Sp??ndola - 08/03/2006 - Restringir a multi-empresa*/

            UNION

            SELECT Proibicao.Tp_Proibicao,

                   Proibicao.Dt_Inicial_Proibicao,

                   2 Ds_Ordem

              FROM Dbamv.Proibicao

             WHERE Proibicao.Cd_Pro_Fat = Substr(Cprofat, 1, 8)

               AND Cd_Multi_Empresa =

                   Nvl(Substr(Cprofat, 10, Length(Cprofat)),

                       Cd_Multi_Empresa)

               AND Proibicao.Cd_Convenio = Nconv

               AND Proibicao.Cd_Con_Pla = Nplano

               AND Proibicao.Tp_Atendimento = Ctpatend

               AND Trunc(Nvl(Proibicao.Dt_Inicial_Proibicao, SYSDATE)) <=

                   Drefer

               AND Proibicao.Cd_Setor IS NULL

               AND Proibicao.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /*PDA 147099 - Sp??ndola - 08/03/2006 - Restringir a multi-empresa*/

            UNION

            SELECT Proibicao.Tp_Proibicao,

                   Proibicao.Dt_Inicial_Proibicao,

                   3 Ds_Ordem

              FROM Dbamv.Proibicao

             WHERE Proibicao.Cd_Pro_Fat = Substr(Cprofat, 1, 8)

               AND Cd_Multi_Empresa =

                   Nvl(Substr(Cprofat, 10, Length(Cprofat)),

                       Cd_Multi_Empresa)

               AND Proibicao.Cd_Convenio = Nconv

               AND Proibicao.Cd_Con_Pla = Nplano

               AND Proibicao.Tp_Atendimento = 'T'

               AND Trunc(Nvl(Proibicao.Dt_Inicial_Proibicao, SYSDATE)) <=

                   Drefer

               AND Proibicao.Cd_Setor IS NULL

               AND Proibicao.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /*PDA 147099 - Sp??ndola - 08/03/2006 - Restringir a multi-empresa*/

            )

     ORDER BY Dt_Inicial_Proibicao DESC,

              Ds_Ordem;



  CURSOR c_Forapre(Nconv IN NUMBER, Ngrfa IN NUMBER) IS

    SELECT Nvl(Itfor_Apre.Sn_Cadastra_Crm, 'N') Sn_Prestador

      FROM Dbamv.Itfor_Apre,

           Dbamv.For_Apre,

           Dbamv.Convenio,

           Dbamv.Empresa_Convenio

     WHERE Convenio.Cd_Convenio = Nconv

       AND Convenio.Cd_Convenio = Empresa_Convenio.Cd_Convenio /* PDA 118607/129023*/

       AND Empresa_Convenio.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/129023*/

       AND For_Apre.Cd_For_Apre = Convenio.Cd_For_Apre

       AND Itfor_Apre.Cd_For_Apre = For_Apre.Cd_For_Apre

       AND Itfor_Apre.Cd_Gru_Fat = Ngrfa;



  -- op 38143 (inicio)

  CURSOR c_forapreatimed(nconv in number, ngrfa in number) is

    SELECT nvl(itfor_apre.sn_cadastra_ati_med, 'n') sn_cadastra_ati_med

      FROM dbamv.itfor_apre,

           dbamv.for_apre,

           dbamv.convenio,

           dbamv.empresa_convenio

     WHERE convenio.cd_convenio = nconv

       AND convenio.cd_convenio = empresa_convenio.cd_convenio /* pda 118607/129023*/

       AND empresa_convenio.cd_multi_empresa = dbamv.pkg_mv2000.le_empresa /* pda 118607/129023*/

       AND for_apre.cd_for_apre = convenio.cd_for_apre

       AND itfor_apre.cd_for_apre = for_apre.cd_for_apre

       AND itfor_apre.cd_gru_fat = ngrfa;



  -- op 38143 (fim)



  CURSOR c_Existelfa(Nconta IN Dbamv.Log_Falha_Importacao.Cd_Reg_Fat%TYPE /*NUMBER*/

  , Nmvtofalha IN NUMBER, Nitemfalha IN NUMBER, Ctperro IN VARCHAR2, Ctpimportacao IN VARCHAR2) IS

    SELECT Lfa.Cd_Log_Falha_Importacao

      FROM Dbamv.Log_Falha_Importacao Lfa

     WHERE Nvl(Lfa.Cd_Reg_Fat, 0) = Nvl(Nconta, 0)

       AND Lfa.Cd_Mvto_Falha = Nmvtofalha

       AND Lfa.Cd_Item_Falha = Nitemfalha

       AND Lfa.Tp_Erro = Ctperro

       AND Lfa.Tp_Importacao = Ctpimportacao

       AND Lfa.Nm_Usuario_Baixou IS NULL;



  CURSOR c_Existelfaamb(Nconta IN Dbamv.Log_Falha_Importacao.Cd_Reg_Amb%TYPE /*NUMBER*/

  , Nmvtofalha IN NUMBER, Nitemfalha IN NUMBER, Ctperro IN VARCHAR2, Ctpimportacao IN VARCHAR2) IS

    SELECT Lfa.Cd_Log_Falha_Importacao

      FROM Dbamv.Log_Falha_Importacao Lfa

     WHERE Nvl(Lfa.Cd_Reg_Amb, 0) = Nvl(Nconta, 0)

       AND Lfa.Cd_Mvto_Falha = Nmvtofalha

       AND Lfa.Cd_Item_Falha = Nitemfalha

       AND Lfa.Tp_Erro = Ctperro

       AND Lfa.Tp_Importacao = Ctpimportacao;



  CURSOR c_Prescon(Nprest IN NUMBER, Nconv IN NUMBER) IS

    SELECT Pres_Con.Sn_Paga_Pelo_Convenio

      FROM Dbamv.Pres_Con

     WHERE Pres_Con.Cd_Prestador = Nprest

       AND Pres_Con.Cd_Convenio = Nconv

       AND (Pres_Con.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa OR

           Pres_Con.Cd_Multi_Empresa IS NULL) -- OP 3396 - 25/04/2013

    ;



  -- pda 96511 - 23/06/2004 - Amalia Ara??jo

  -- Alterado o processo, para verificar os novos campos da tabela GABARITO_PRO :

  --  QT_GABARITO e SN_PACOTE.  Por isso o cursor original foi substituido por tr?s.

  -- pda 96511 - 18/05/2004 - Amalia Ara??jo

  -- Cursor para verificar a rotina de pacote por gabarito para contas hospitalares

  /*Cursor cGabaritoHosp( nConta in number, vProced in varchar2 ) is

  select 'S'

     from dbamv.gabarito,

            dbamv.gabarito_pro,

            dbamv.reg_fat

   where gabarito.cd_pro_fat     = reg_fat.cd_pro_fat_solicitado

      and gabarito.cd_gabarito   = gabarito_pro.cd_gabarito

      and reg_fat.cd_regra          = gabarito_pro.cd_regra

      and gabarito_pro.cd_pro_fat = vProced

      and reg_fat.cd_reg_fat        = nConta

      and rownum = 1;     */

  CURSOR Cgabaritohosp(Nconta IN Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*NUMBER PDA 254997*/

  ) IS

    SELECT Gabarito.Cd_Gabarito

      FROM Dbamv.Gabarito,

           Dbamv.Reg_Fat

     WHERE Gabarito.Cd_Pro_Fat = Reg_Fat.Cd_Pro_Fat_Solicitado

       AND Reg_Fat.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /*PDA 118607/127754*/

       AND Reg_Fat.Cd_Reg_Fat = Nconta

          --PDA 202347 (Inicio) -- Pedro Neiva - 10/10/2007

       AND EXISTS

     (SELECT 'X'

              FROM Dbamv.Gabarito_Pro

             WHERE Gabarito_Pro.Cd_Regra = Reg_Fat.Cd_Regra

               AND Gabarito_Pro.Cd_Gabarito = Gabarito.Cd_Gabarito);



  --PDA 202347 (Fim) -- Pedro Neiva - 10/10/2007

  CURSOR Citgabaritohosp(Vproced IN VARCHAR2, Ngabarito IN NUMBER) IS

    SELECT Gabarito_Pro.Qt_Gabarito,

           Gabarito_Pro.Sn_Pacote

      FROM Dbamv.Gabarito,

           Dbamv.Gabarito_Pro

     WHERE Gabarito.Cd_Gabarito = Ngabarito

       AND Gabarito.Cd_Gabarito = Gabarito_Pro.Cd_Gabarito

       AND Gabarito_Pro.Cd_Pro_Fat = Vproced;



  CURSOR Cquantgabarito(Nconta IN Dbamv.Itreg_Fat.Cd_Reg_Fat%TYPE /*NUMBER PDA 254997*/

  , Vproced IN VARCHAR2) IS

    SELECT SUM(Itreg_Fat.Qt_Lancamento) Qt_Lancamento

      FROM Dbamv.Itreg_Fat

     WHERE Itreg_Fat.Cd_Reg_Fat = Nconta

       AND Itreg_Fat.Cd_Pro_Fat = Vproced

       AND Nvl(Itreg_Fat.Sn_Pertence_Pacote, 'N') = 'S';



  -- pda 96511 - fim

  -- PDA 123016 (Inicio) - Henrique Antunes - 06/07/2005

  CURSOR Cauditoriainloco(Pcdregfat IN Dbamv.Auditoria_In_Loco.Cd_Reg_Fat%TYPE /*NUMBER PDA 254997*/

  , Pddt_Referencia IN DATE, Pdhr_Referencia IN DATE) IS

    SELECT COUNT(1)

      FROM Dbamv.Auditoria_In_Loco

     WHERE Auditoria_In_Loco.Cd_Reg_Fat = Pcdregfat

       AND ((Trunc(Pddt_Referencia) = Trunc(Auditoria_In_Loco.Dt_Inicio) AND

           To_Number(To_Char(Pdhr_Referencia, 'HH24MI')) BETWEEN

           To_Number(To_Char(Auditoria_In_Loco.Hr_Inicio, 'HH24MI')) AND 2359) OR

           (Trunc(Pddt_Referencia) = Trunc(Auditoria_In_Loco.Dt_Termino) AND

           To_Number(To_Char(Pdhr_Referencia, 'HH24MI')) BETWEEN 0000 AND

           To_Number(To_Char(Auditoria_In_Loco.Hr_Termino, 'HH24MI'))) OR

           (Trunc(Pddt_Referencia) > Trunc(Auditoria_In_Loco.Dt_Inicio) AND

           Trunc(Pddt_Referencia) < Trunc(Auditoria_In_Loco.Dt_Termino)))

       AND USER IN (SELECT Cd_Usuario

                      FROM Dbasgu.Usuarios

                     WHERE Sn_Altera_Auditoria_In_Loco = 'N')

       AND Auditoria_In_Loco.Cd_Usuario_Cancelou IS NULL;



  -- PDA 123016 (Fim)

  /*OP 41394*/

  CURSOR cSnReplicaProcHe(nregra IN NUMBER,

                        ngrupro IN NUMBER,

                        pProFat IN VARCHAR2,

                        ndia    IN  NUMBER,

                        dhora   IN  DATE,

                        ctpatdt IN  VARCHAR2) IS

    SELECT sn_replica_proc,vl_percentual,ordem FROM (

      SELECT horario_especial.sn_replica_proc,

              horario_especial.vl_percentual,

              1 ordem

        FROM   dbamv.horario_especial_proced hep,

              dbamv.ithorario_especial,

              dbamv.regra,

              dbamv.horario_especial

        WHERE hep.cd_regra       = nregra

          AND hep.cd_gru_pro     = ngrupro

          AND hep.cd_pro_Fat     = pProFat

          AND horario_especial.cd_horario = ithorario_especial.cd_horario

          AND horario_especial.cd_horario = hep.cd_horario

          AND ithorario_especial.cd_dia = ndia

          AND ithorario_especial.cd_horario = hep.cd_horario

          AND regra.cd_regra = hep.cd_regra

          AND TO_CHAR(dhora, 'hh24:mi') BETWEEN TO_CHAR(ithorario_especial.hr_inicio, 'hh24:mi')

                                                AND TO_CHAR(ithorario_especial.hr_fim, 'hh24:mi')

    UNION ALL

        SELECT horario_especial.sn_replica_proc ,

                horario_especial.vl_percentual,

                2 ordem

          FROM dbamv.horario_especial

            , dbamv.regra

            , dbamv.itregra

        ,      dbamv.tab_fat

        WHERE itregra.cd_regra = regra.cd_regra

              AND itregra.cd_tab_fat = tab_fat.cd_tab_fat

              AND itregra.cd_horario = horario_especial.cd_horario AND itregra.cd_regra = nregra

              AND itregra.cd_gru_pro = ngrupro )

        ORDER BY ordem ;

 /*OP 41394*/



     /* ALLS OP 42241 */

    CURSOR cSnCargoPaciente(Natend IN NUMBER) IS

      SELECT DISTINCT Nvl(sn_carga_familiar, 'N') sn_carga_familiar

       FROM dbamv.atendime,

            dbamv.carteira

      WHERE atendime.cd_paciente = carteira.cd_paciente

      AND atendime.cd_convenio = carteira.cd_convenio

      AND atendime.cd_con_pla = carteira.cd_con_pla

      AND atendime.cd_atendimento = Natend

      AND carteira.sn_carteira_ativo = 'S'

      AND carteira.nr_carteira IS NOT NULL; /* ALLS FATURCONV-1828 */

    /* fim ALLS OP 42241 */



  FUNCTION Val_Proc(Cprocedimento IN VARCHAR2,

                    Ddatarefer    IN DATE,

                    Dhorarefer    IN DATE,

                    Ncodconvenio  IN NUMBER,

                    Ncodplano     IN Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*NUMBER PDA 254997*/,

                    Ctipoatend    IN VARCHAR2,

                    Ncodtipoaco   IN NUMBER,

                    Ctpatimed     IN VARCHAR2,

                    Nvlpercirmult IN NUMBER,

                    Nvalproced    IN NUMBER) RETURN NUMBER;



  FUNCTION Nr_Auxiliar(Cprocedimento IN VARCHAR2,

                       Ddatarefer    IN DATE,

                       Ncodconvenio  IN NUMBER,

                       Ncodplano     IN Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*NUMBER PDA 254997*/,

                       Ntipo         IN VARCHAR2) RETURN NUMBER;



  PROCEDURE Lanca_Ciru_Ffcv(Ncdavisocirurgia IN NUMBER,

                            Caction          IN VARCHAR2 DEFAULT 'I');



  PROCEDURE Lanca_Eqpto_Ffcv(Ncdavisocirurgia       IN NUMBER,

                             Ncdaparelhoequipamento IN NUMBER,

                             Ndiferenca             IN NUMBER,

                             Caction                IN VARCHAR2,

                             Ncdprestador           IN NUMBER,

                             Ncditemmvto            IN NUMBER,

                             p_Ddtinicio            IN DATE DEFAULT NULL --PDA: 159237

                            ,

                             p_Ddtfim               IN DATE DEFAULT NULL --PDA: 159237

                             );



  PROCEDURE Lanca_Sangue_Ffcv(Ncdavisocirurgia   IN NUMBER,

                              Ncdsanguederivados IN NUMBER,

                              Ndiferenca         IN NUMBER,

                              Caction            IN VARCHAR2,

                              Ncditemmvto        IN NUMBER);



  PROCEDURE Confirma_Lcto_Ciru_Ffcv(Ncdavisocirurgia IN NUMBER,

                                    Caction          IN VARCHAR2 DEFAULT 'I');



  FUNCTION Lanca_Mges_Ffcv(Ncdproduto            IN NUMBER,

                           Ncdmvtoestoque        IN NUMBER,

                           Ncdunipro             IN NUMBER,

                           Nqtmovnew             IN NUMBER,

                           Nqtmovold             IN NUMBER,

                           Caction               IN VARCHAR2,

                           Csnitempertencepacote IN VARCHAR2, /*Incluido este parametro por Marcelo em 14/01/2002*/

                           Ncditemmvto           IN NUMBER,

                           Ncdfornec             IN NUMBER DEFAULT NULL

                           -- PDA 170696(Inicio) - Henrique Antunes - 23/11/2006

                          ,

                           Ncdformula IN NUMBER DEFAULT NULL,

                           Nqtformula IN NUMBER DEFAULT NULL

                           -- PDA 170696 (Fim)

                          ,

                           Ptp_Execucao IN VARCHAR2 DEFAULT NULL --PDA 175557 - 20/01/2009 - Jansen Gallindo

                           ) RETURN VARCHAR2;



  PROCEDURE Lanca_Psnd_Ffcv(Ncdopcao       IN NUMBER,

                            Ncdmovcardapio IN NUMBER,

                            Nqtmovnew      IN NUMBER,

                            Nqtmovold      IN NUMBER,

                            Caction        IN VARCHAR2,

                            Ccobranca      IN VARCHAR2,

                            Ncditemmvto    IN NUMBER);



  PROCEDURE Lanca_Pagu_Ffcv(Ncdpremed          IN NUMBER,

                            Ncddevpre          IN NUMBER,

                            Ncdtippresc        IN NUMBER,

                            Ncdprestador       IN NUMBER,

                            Ncdsetexa          IN NUMBER,

                            Nqtnew             IN NUMBER,

                            Nqtold             IN NUMBER,

                            Caction            IN VARCHAR2,

                            Ncditemmvto        IN NUMBER,

                            Ncd_Setor          IN NUMBER,

                            Vdh_Cancelado      IN DATE, -- pda 86938 - 05/02/2004 - Amalia Ara??jo - novos par??metros

                            Pncdatendimento    IN NUMBER,

                            Pddtpremed         IN DATE,

                            Pdhrpremed         IN DATE,

                            Pncdunidint        IN NUMBER,

                            Pncdprestadorpresc IN NUMBER);



  -- pda 86938 - fim

  PROCEDURE Lanca_Componente_Ffcv(Ncditpremed        IN NUMBER,

                                  Ncdtippresc        IN NUMBER,

                                  Nqtnew             IN NUMBER,

                                  Nqtold             IN NUMBER,

                                  Caction            IN VARCHAR2, -- pda 86938 - 10/02/2004 - Amalia Ara??jo

                                  Pncdatendimento    IN NUMBER,

                                  Pddtpremed         IN DATE,

                                  Pdhrpremed         IN DATE,

                                  Pncdunidint        IN NUMBER,

                                  Pncdprestadorpresc IN NUMBER,

                                  Pncdsetor          IN NUMBER);



  -- pda 86938 - fim

  PROCEDURE Lanca_Psdi_Ffcv(Ncdpedrx           IN NUMBER,

                            Ncditpedrx         IN NUMBER,

                            Ncdexarx           IN NUMBER,

                            Ddtrealiznew       IN DATE,

                            Ddtrealizold       IN DATE,

                            Nrfaturado         IN NUMBER,

                            Nrcdprestador      IN NUMBER,

                            Pcfaturado         IN NUMBER,

                            Ncditemformula     IN NUMBER DEFAULT NULL -- PDA 159898 Inicio

                           ,

                            Nsnincidenciaexame IN VARCHAR2 DEFAULT 'N' --PDA 145551 - HSR - RODRIGO VALENTIM

                            );



  PROCEDURE Lanca_Pssd_Ffcv(Ncdpedlab    IN NUMBER,

                            Ncdexalab    IN NUMBER,

                            Ddtrealiznew IN DATE,

                            Ddtrealizold IN DATE,

                            Ncditemmvto  IN NUMBER,

                            Nitsetexa    IN NUMBER,

                            Nitmedexe    IN NUMBER); --************************************ acrescentado no PDA 76175 par??metro: Cd_Set_Exa

  PROCEDURE Lanca_Para_Ffcv(Ncdatendimento IN NUMBER,

                            Cprofat        IN VARCHAR2,

                            Nqtde          IN Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*NUMBER PDA 254997*/,

                            Caction        IN VARCHAR2);



  FUNCTION Is_Hor_Esp(Nconv    IN NUMBER,

                      Nplano   IN Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*number pda 254997*/,

                      Ctpatend IN VARCHAR2,

                      Ddtlanc  IN DATE,

                      Dhrlanc  IN DATE,

                      Ncdgrfat IN NUMBER,

                      Cprofat  IN VARCHAR2,

                      Nregra   IN NUMBER DEFAULT NULL, --PDA 108041 / 108039 12/11/2004 Sp??ndola

                      --Inserido o c??digo do prestador / setor para permitir exce????es de convenios e planos tamb??m por prestador.

                      Pncdprestador IN NUMBER DEFAULT NULL,

                      Pncdsetor     IN NUMBER DEFAULT NULL

                      --PDA 108041 / 108039 (FIM)

                      ) RETURN BOOLEAN;



  FUNCTION Cria_Conta_Pacparthosp(Ncdatendimento IN NUMBER,

                                  Ddatalanc      IN DATE DEFAULT NULL -- pda  125871 (passar a data  de lancamento)

                                  ) RETURN NUMBER;



  FUNCTION Criacontapacpartambu(Natendimento IN NUMBER) RETURN NUMBER;



  PROCEDURE Verif_Franquia_Hosp(Nregfat IN Dbamv.Itreg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/,

                                Ncdlcto IN Dbamv.Itreg_Fat.Cd_Lancamento%TYPE /*number pda 254997*/,

                                Caction IN VARCHAR2);



  PROCEDURE Verif_Franquia_Ambu(Nregamb IN Dbamv.Itreg_Amb.Cd_Reg_Amb%TYPE /*number pda 254997*/,

                                Ncdlcto IN Dbamv.Itreg_Amb.Cd_Lancamento%TYPE /*number pda 254997*/,

                                Caction IN VARCHAR2 DEFAULT 'I');



  PROCEDURE Lanca_Atend_Ffcv(Ncdatend  IN NUMBER,

                             Ctpatend  IN VARCHAR2,

                             Ncdconv   IN NUMBER,

                             Ncdplano  IN Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*number pda 254997*/,

                             Ncdorigem IN NUMBER,

                             Ddtatend  IN DATE,

                             Dhratend  IN DATE,

                             Ncodprest IN NUMBER,

                             Nsetor    IN NUMBER,

                             Nconta    IN Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/);



  FUNCTION Lanca_Mges_Consumo_Ffcv(Ncdproduto  IN NUMBER,

                                   Ncdconsumo  IN NUMBER,

                                   Ncdunipro   IN NUMBER,

                                   Nqtmovnew   IN NUMBER,

                                   Nqtmovold   IN NUMBER,

                                   Caction     IN VARCHAR2,

                                   Ncditemmvto IN NUMBER) RETURN VARCHAR2;



  PROCEDURE Gera_Log_Falha(Ncdregfat      IN Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/,

                           Ncdregamb      IN Dbamv.Reg_Amb.Cd_Reg_Amb%TYPE /*number pda 254997*/,

                           Ncdmvto        IN NUMBER,

                           Ncditmvto      IN NUMBER,

                           Ccdprofat      IN VARCHAR2,

                           Ctperro        IN VARCHAR2,

                           Ccoderro       IN VARCHAR2,

                           Cmsgerro       IN VARCHAR2,

                           Ctpatend       IN VARCHAR2,

                           Ncdatendimento IN NUMBER,

                           Btestalfa      IN BOOLEAN DEFAULT TRUE,

                           Bexclui        IN BOOLEAN DEFAULT FALSE,

                           Dtmvto         IN DATE

                           -- PDA 167334 (Inicio) - Henrique Antunes - 14/03/2007

                          ,

                           Ncdintegracao IN NUMBER DEFAULT NULL

                           -- PDA 167334 (Fim)

                           );



  FUNCTION Verifica_Conta_Secundaria(Pcdatendimento    IN NUMBER,

                                     Pdtreferencia     IN DATE,

                                     Pcdconvenio       IN NUMBER,

                                     Pcdatendimentopai IN NUMBER)

    RETURN NUMBER;



  /********************************************************************************************

  | Nome    : FNC_SUBSTITUICAO_PROCEDIMENTO

  | Utilidade : fun????o para verificar se existe regra de substitui????o para o procedimento lan??ado, fazendo

  |             a substitui????o pelo procedimento substituto se ouver

  | Parametros: <pnCdEmpresa>       Codigo da empresa

  |             <pnCdSetor>         Codigo do setor

  |             <pvCdProFat>

  |             <pdDtVigencia>      Data de vigencia

  |             <pvTpAtend>         Tipo de atendimento

  |             <pvTpRetorno>       Tipo de retorno

  | Autor: Anderson Marcel

  |********************************************************************************************

  | Historico das modifica????es

  | PDA      Autor            Data                Comentarios

  | -------- ---------------- ------------------  -------------------------------------------------

  |  174061  Anderson Marcel   02/03/2007         implementa????o.

  |

  |

  */

  FUNCTION Fnc_Substituicao_Procedimento(Pncdempresa  NUMBER,

                                         Pncdsetor    NUMBER,

                                         Pvprofat     VARCHAR2,

                                         Pddtvigencia DATE,

                                         Pvtpatend    VARCHAR2,

                                         Pvtpretorno  VARCHAR2,

					                     PcdConvenio  NUMBER DEFAULT NULL,   /*OP 28803*/

                                         pnRegraSubs  IN OUT NOCOPY NUMBER,  /*OP 44895*/

                                         pnCdPlano    NUMBER DEFAULT NULL,   /*OP 44895*/

                                         pnCdRegra    NUMBER DEFAULT NULL    /*OP 44895*/

                                         )

    RETURN VARCHAR2;



  FUNCTION Fnc_Substituicao_Procedimento2(Pncdempresa  NUMBER,

                                         Pncdsetor    NUMBER,

                                         Pvprofat     VARCHAR2,

                                         Pddtvigencia DATE,

                                         Pvtpatend    VARCHAR2,

                                         Pvtpretorno  VARCHAR2,

										                     PcdConvenio  NUMBER DEFAULT NULL,   /*OP 28803*/

                                         --pnRegraSubs  IN OUT NOCOPY NUMBER,  /*OP 44895*/

                                         pnCdPlano    NUMBER DEFAULT NULL,   /*OP 44895*/

                                         pnCdRegra    NUMBER DEFAULT NULL    /*OP 44895*/

                                         )

    RETURN VARCHAR2;



  /********************************************************************************************

  | Nome    : FNC_SUBSTITUICAO_PROCED_FATOR

  | Utilidade : fun????o para verificar se existe regra de substitui????o para o procedimento lan??ado, fazendo

  |             a substitui????o pelo procedimento substituto se ouver

  | Parametros: <pnCdEmpresa>       Codigo da empresa

  |             <pnCdSetor>         Codigo do setor

  |             <pvCdProFat>

  |             <pdDtVigencia>      Data de vigencia

  |             <pvTpAtend>         Tipo de atendimento

  |             <pvTpRetorno>       Tipo de retorno

  | Autor: Anderson Marcel

  |********************************************************************************************

  | Historico das modifica????es

  | PDA      Autor            Data                Comentarios

  | -------- ---------------- ------------------  -------------------------------------------------

  |  174061  Anderson Marcel   02/03/2007         implementa????o.

  |

  |

  */

  FUNCTION Fnc_Substituicao_Proced_Fator(Pncdempresa  NUMBER,

                                         Pncdsetor    NUMBER,

                                         Pvprofat     VARCHAR2,

                                         Pddtvigencia DATE,

                                         Pvtpatend    VARCHAR2,

                                         Pvtpretorno  VARCHAR2,

                                         Pnvalor      NUMBER,

                                         PcdConvenio  NUMBER DEFAULT NULL,   /*OP 28803*/

                                         pnCdPlano    NUMBER DEFAULT NULL,   /*OP 44895*/

                                         pnCdRegra    NUMBER DEFAULT NULL    /*OP 44895*/

                                         ) RETURN NUMBER;



-- PDA 174061 Fim

--PRAGMA RESTRICT_REFERENCES ( VAL_PROC, WNDS ) ;

END; -- Package Specification PACK_LANCA_FFCV
/

CREATE OR REPLACE PACKAGE BODY dbamv.pack_lanca_ffcv IS



  FUNCTION Is_Hor_Esp(Nconv    IN NUMBER,

                      Nplano   IN Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*number pda 254997*/,

                      Ctpatend IN VARCHAR2,

                      Ddtlanc  IN DATE,

                      Dhrlanc  IN DATE,

                      Ncdgrfat IN NUMBER,

                      Cprofat  IN VARCHAR2,

                      Nregra   IN NUMBER DEFAULT NULL, --PDA 108041 / 108039 12/11/2004 Sp?ola

                      --Inserido o codigo do prestador / setor para permitir exce?s de convenios e planos tamb?por prestador.

                      Pncdprestador IN NUMBER DEFAULT NULL,

                      Pncdsetor     IN NUMBER DEFAULT NULL

                      --PDA 108041 / 108039 (FIM)

                      ) RETURN BOOLEAN IS

  BEGIN

    RETURN Dbamv.Pack_Aux_Ffcv.Is_Hor_Esp(Nconv,

                                          Nplano,

                                          Ctpatend,

                                          Ddtlanc,

                                          Dhrlanc,

                                          Ncdgrfat,

                                          Cprofat,

                                          Nregra, --PDA 108041 / 108039 12/11/2004 Sp?ola (INICIO)

                                          --Inserido o parametro do c??o do prestador / setor para permitir exce?s de convenios e planos por prestador

                                          Pncdprestador,

                                          Pncdsetor --PDA 108041 / 108039 (FIM)

                                          );

  END;



  FUNCTION Cria_Conta_Pacparthosp(Ncdatendimento IN NUMBER,

                                  Ddatalanc      IN DATE DEFAULT NULL -- pda  125871 (passar a data  de lancamento)

                                  ) RETURN NUMBER IS

  BEGIN

    RETURN Dbamv.Pack_Aux_Ffcv.Cria_Conta_Pacparthosp(Ncdatendimento,

                                                      Ddatalanc); -- pda 125871 (acrescentada a data)

  END;



  FUNCTION Criacontapacpartambu(Natendimento IN NUMBER) RETURN NUMBER IS

  BEGIN

    RETURN Dbamv.Pack_Aux_Ffcv.Criacontapacpartambu(Natendimento);

  END;



  FUNCTION Val_Proc(Cprocedimento IN VARCHAR2,

                    Ddatarefer    IN DATE,

                    Dhorarefer    IN DATE,

                    Ncodconvenio  IN NUMBER,

                    Ncodplano     IN Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*NUMBER PDA 254997*/,

                    Ctipoatend    IN VARCHAR2,

                    Ncodtipoaco   IN NUMBER,

                    Ctpatimed     IN VARCHAR2,

                    Nvlpercirmult IN NUMBER,

                    Nvalproced    IN NUMBER) RETURN NUMBER IS

    Nretval NUMBER;

    Cmsgret VARCHAR2(2000);

    Ndummy  NUMBER;

  BEGIN

    Nretval := Dbamv.Val_Proc_Ffcv(Cprocedimento,

                                   Ddatarefer,

                                   Dhorarefer,

                                   Ncodconvenio,

                                   Ncodplano,

                                   Ctipoatend,

                                   Ncodtipoaco,

                                   Ctpatimed,

                                   Nvlpercirmult,

                                   Cmsgret,

                                   Ndummy,

                                   Ndummy,

                                   Ndummy,

                                   Ndummy,

                                   Ndummy,

                                   Ndummy,

                                   Ndummy,

                                   Ndummy,

                                   Nvalproced,

                                   1,

                                   Ndummy,

                                   NULL,

                                   NULL,

                                   NULL,

                                   NULL,

                                   NULL,

                                   NULL,

                                   NULL,

                                   NULL,

                                   NULL,

                                   NULL, --PDA 108041 / 108041 09/11/2004 Sp?ola (INICIO)

                                   --Inserido o parametro do c??o do prestador / Setor

                                   NULL,

                                   NULL --PDA 108041 / 108039 (FIM)

                                   -- PDA 102034 29/11/2004 Pollyane (In?o)

                                   -- Passando o valor NULL para o c??o da conta e c??o do lan?ento.

                                  ,

                                   NULL,

                                   NULL -- PDA 102034 (Fim)

                                   );

    RETURN Nretval;

  END Val_Proc;



  FUNCTION Nr_Auxiliar(Cprocedimento IN VARCHAR2,

                       Ddatarefer    IN DATE,

                       Ncodconvenio  IN NUMBER,

                       Ncodplano     IN Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*NUMBER PDA 254997*/,

                       Ntipo         IN VARCHAR2) RETURN NUMBER IS

    CURSOR c_Auxiliar IS

      SELECT Decode(Ntipo,

                    'P',

                    Por_Ane_Tab.Cd_Por_Ane,

                    'N',

                    Por_Ane_Tab.Nr_Auxiliares)

        FROM Dbamv.Por_Ane_Tab,

             Dbamv.Itregra,

             Dbamv.Pro_Fat,

             Dbamv.Con_Pla,

             Dbamv.Empresa_Con_Pla /* PDA 118607/131598 */

       WHERE Empresa_Con_Pla.Cd_Convenio = Con_Pla.Cd_Convenio /* PDA 118607/131598 */

         AND Empresa_Con_Pla.Cd_Con_Pla = Con_Pla.Cd_Con_Pla /* PDA 118607/131598 */

         AND Empresa_Con_Pla.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/131598 */

         AND Con_Pla.Cd_Con_Pla = Ncodplano

         AND Con_Pla.Cd_Convenio = Ncodconvenio

         AND Itregra.Cd_Regra = Con_Pla.Cd_Regra

         AND Itregra.Cd_Gru_Pro = Pro_Fat.Cd_Gru_Pro

         AND Por_Ane_Tab.Cd_Pro_Fat = Pro_Fat.Cd_Pro_Fat

         AND Por_Ane_Tab.Cd_Tab_Fat = Itregra.Cd_Tab_Fat

         AND Por_Ane_Tab.Cd_Pro_Fat = Cprocedimento

         AND Por_Ane_Tab.Dt_Vigencia =

             (SELECT MAX(Por_Ane_Tab.Dt_Vigencia)

                FROM Dbamv.Por_Ane_Tab,

                     Dbamv.Itregra,

                     Dbamv.Pro_Fat,

                     Dbamv.Con_Pla,

                     Dbamv.Empresa_Con_Pla /* PDA 118607/131598 */

               WHERE Empresa_Con_Pla.Cd_Convenio = Con_Pla.Cd_Convenio /* PDA 118607/131598 */

                 AND Empresa_Con_Pla.Cd_Con_Pla = Con_Pla.Cd_Con_Pla /* PDA 118607/131598 */

                 AND Empresa_Con_Pla.Cd_Multi_Empresa =

                     Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/131598 */

                 AND Con_Pla.Cd_Con_Pla = Ncodplano

                 AND Con_Pla.Cd_Convenio = Ncodconvenio

                 AND Itregra.Cd_Regra = Con_Pla.Cd_Regra

                 AND Itregra.Cd_Gru_Pro = Pro_Fat.Cd_Gru_Pro

                 AND Por_Ane_Tab.Cd_Pro_Fat = Pro_Fat.Cd_Pro_Fat

                 AND Por_Ane_Tab.Cd_Tab_Fat = Itregra.Cd_Tab_Fat

                 AND Por_Ane_Tab.Cd_Pro_Fat = Cprocedimento

                 AND Por_Ane_Tab.Dt_Vigencia <= Ddatarefer);

    Nretval NUMBER;

  BEGIN

    OPEN c_Auxiliar;

    FETCH c_Auxiliar

      INTO Nretval;

    CLOSE c_Auxiliar;

    RETURN Nretval;

  END Nr_Auxiliar;



  PROCEDURE Gera_Log_Falha(Ncdregfat      IN Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/,

                           Ncdregamb      IN Dbamv.Reg_Amb.Cd_Reg_Amb%TYPE /*number pda 254997*/,

                           Ncdmvto        IN NUMBER,

                           Ncditmvto      IN NUMBER,

                           Ccdprofat      IN VARCHAR2,

                           Ctperro        IN VARCHAR2,

                           Ccoderro       IN VARCHAR2,

                           Cmsgerro       IN VARCHAR2,

                           Ctpatend       IN VARCHAR2,

                           Ncdatendimento IN NUMBER,

                           Btestalfa      IN BOOLEAN DEFAULT TRUE,

                           Bexclui        IN BOOLEAN DEFAULT FALSE,

                           Dtmvto         IN DATE

                           -- PDA 167334 (Inicio) - Henrique Antunes - 14/03/2007

                          ,

                           Ncdintegracao IN NUMBER DEFAULT NULL

                           -- PDA 167334 (Fim)

                           ) IS

    Ncdlfa NUMBER;

    CURSOR c_Conta_Hosp(Natend IN NUMBER, Dlcto IN DATE) IS

      SELECT Reg_Fat.Cd_Reg_Fat,

             Atendime_Pai.Tp_Atendimento

        FROM Dbamv.Reg_Fat,

             Dbamv.Convenio,

             Dbamv.Atendime,

             Dbamv.Atendime Atendime_Pai

       WHERE Atendime.Cd_Atendimento = Natend

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

         AND Reg_Fat.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /*PDA 118607/127754*/

         AND Atendime_Pai.Cd_Atendimento =

             Nvl(Atendime.Cd_Atendimento_Pai, Atendime.Cd_Atendimento)

         AND Reg_Fat.Cd_Atendimento = Atendime_Pai.Cd_Atendimento

         AND Reg_Fat.Cd_Multi_Empresa = Atendime_Pai.Cd_Multi_Empresa

         AND Reg_Fat.Cd_Convenio = Atendime_Pai.Cd_Convenio

         AND (Reg_Fat.Sn_Fechada = 'S' -->> Checa somente as contas fechadas

             OR Reg_Fat.Sn_Importa_Auto = 'N')

            --PDA 184670(In?o)

         AND Dlcto BETWEEN Nvl(Reg_Fat.Dt_Inicio, Dlcto) AND

             Nvl(Reg_Fat.Dt_Final, Dlcto)

            --AND TRUNC (dlcto) BETWEEN TRUNC (NVL (reg_fat.dt_inicio, dlcto)) AND TRUNC (NVL (reg_fat.dt_final, dlcto))

            --PDA 184670(Fim)

         AND Convenio.Cd_Convenio = Reg_Fat.Cd_Convenio;

    Vconta_Hosp c_Conta_Hosp%ROWTYPE;

    Vusr_Baixou VARCHAR2(40);





	-- OP 33980 - Inicio

	CURSOR  cConvAtendimento (pCdAtendimento dbamv.atendime.cd_atendimento%TYPE ) IS

     SELECT cd_convenio

      FROM dbamv.atendime

      WHERE cd_atendimento = pCdAtendimento ;



   nCdConvenio dbamv.convenio.cd_convenio%TYPE ;

   -- OP 33980 - Fim



  BEGIN



	-- OP 33980 - Inicio

	-- OP35506 - Validar todos os tipos de Atendimento

    -- IF  Ctpatend IN ('A','U','E') AND Ccoderro = '04' THEN

    IF  Ccoderro IN ('04','13') THEN    -- OP 46678

      -- OP35506  - Inicio

      OPEN c_Conta_Hosp(Ncdatendimento, Dtmvto);

      FETCH c_Conta_Hosp

        INTO Vconta_Hosp;

      CLOSE c_Conta_Hosp;

      -- OP35506  - Fim



      OPEN cConvAtendimento (Ncdatendimento);

      FETCH cConvAtendimento INTO nCdConvenio ;

      CLOSE  cConvAtendimento ;

        -- OP35506 -   Incluido o nvl : Nvl( Vconta_Hosp.Cd_Reg_Fat,Ncdregamb)

        dbamv.prc_ffcv_bloq_conta(nCdConvenio , Ncdatendimento , Nvl( Vconta_Hosp.Cd_Reg_Fat,Ncdregamb) )  ;

    END IF ;

	-- OP 33980 - Fim





	IF (Ctperro = 'Diaria' AND Ccoderro = '07')

      --         OR (ctperro = 'Produto' AND ccoderro = '09') -- pda 249648 - Pedro Neiva - 17/09/2008

       OR Ccoderro = '08' OR

       (Substr(Cmsgerro, 1, 1) = '#' AND Ccoderro = '03') THEN

      -- pda 112176

      Vusr_Baixou := 'DBAMV';

    ELSE

      Vusr_Baixou := NULL;

    END IF;





    IF Btestalfa THEN

      -- pda 249648(In?o) - Pedro Neiva - 17/09/2008

      -- PDA 123016 (Inicio) - Henrique Antunes - 06/072005

      --IF   ccoderro IN ('04', '09')

      --IF ccoderro IN ('04', '10')

      IF Ccoderro IN ('10')

        -- PDA 123016 (Fim)

        -- pda 249648(Fim)

         AND Ncdregfat IS NULL AND Ncdregamb IS NULL THEN

        --PDA 86237

        --Foi adicionado o tipo de erro 09 para devolu? de estoque sem conta dispon?l

        OPEN c_Conta_Hosp(Ncdatendimento, Dtmvto);

        FETCH c_Conta_Hosp

          INTO Vconta_Hosp;

        CLOSE c_Conta_Hosp;

        IF Vconta_Hosp.Tp_Atendimento NOT IN ('I', 'H') THEN

          Vconta_Hosp.Cd_Reg_Fat := Ncdregfat;

        END IF;

      ELSE

        Vconta_Hosp.Cd_Reg_Fat := Ncdregfat;

      END IF;

      IF Ctpatend NOT IN ('A', 'E', 'U') THEN

        OPEN Dbamv.Pack_Lanca_Ffcv.c_Existelfa(Vconta_Hosp.Cd_Reg_Fat, --nCdRegFat,

                                               Ncdmvto,

                                               Ncditmvto,

                                               Ccoderro,

                                               Ctperro);

        FETCH Dbamv.Pack_Lanca_Ffcv.c_Existelfa

          INTO Ncdlfa;

        CLOSE Dbamv.Pack_Lanca_Ffcv.c_Existelfa;

      ELSE

        OPEN Dbamv.Pack_Lanca_Ffcv.c_Existelfaamb(Ncdregamb,

                                                  Ncdmvto,

                                                  Ncditmvto,

                                                  Ccoderro,

                                                  Ctperro);

        FETCH Dbamv.Pack_Lanca_Ffcv.c_Existelfaamb

          INTO Ncdlfa;

        CLOSE Dbamv.Pack_Lanca_Ffcv.c_Existelfaamb;

      END IF;

    END IF;

    IF Ncdlfa IS NULL THEN

      INSERT INTO Dbamv.Log_Falha_Importacao

        (Cd_Reg_Fat,

         Cd_Reg_Amb,

         Cd_Mvto_Falha,

         Cd_Pro_Fat,

         Cd_Item_Falha,

         Dt_Importacao,

         Tp_Importacao,

         Tp_Erro,

         Nm_Usuario_Gerou,

         Nm_Usuario_Baixou,

         Cd_Log_Falha_Importacao,

         Ds_Msg_Erro,

         Cd_Atendimento

         -- PDA 167334 (Inicio) - Henrique Antunes - 14/03/2007

        ,

         Cd_Integracao

         -- PDA 167334 (Fim)

         )

      VALUES

        (Vconta_Hosp.Cd_Reg_Fat,

         Ncdregamb,

         Ncdmvto

         -- PDA 233164 (In?o) - 23/06/2008 - Diego Costa

         --,ccdprofat

        ,

         Substr(Ccdprofat, 1, 8)

         -- PDA 233164 (Fim)

        ,

         Ncditmvto,

         Nvl(Dtmvto, SYSDATE),

         Ctperro,

         Ccoderro,

         USER,

         Vusr_Baixou, --null,

         Seq_Log_Falha_Importacao.NEXTVAL,

         Cmsgerro,

         Ncdatendimento

         -- PDA 167334 (Inicio) - Henrique Antunes - 14/03/2007

        ,

         Ncdintegracao

         -- PDA 167334 (Fim)

         );

    ELSE

      IF Bexclui THEN

        DELETE Dbamv.Log_Falha_Importacao

         WHERE Cd_Log_Falha_Importacao = Ncdlfa;

      END IF;

    END IF;

  END;



  PROCEDURE Verif_Franquia_Hosp(Nregfat IN Dbamv.Itreg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/,

                                Ncdlcto IN Dbamv.Itreg_Fat.Cd_Lancamento%TYPE /*number pda 254997*/,

                                Caction IN VARCHAR2) IS

  BEGIN

    Dbamv.Pack_Aux_Ffcv.Verif_Franquia_Hosp(Nregfat, Ncdlcto, Caction);

  END;



  PROCEDURE Verif_Franquia_Ambu(Nregamb IN Dbamv.Itreg_Amb.Cd_Reg_Amb%TYPE /*number pda 254997*/,

                                Ncdlcto IN Dbamv.Itreg_Amb.Cd_Lancamento%TYPE /*number pda 254997*/,

                                Caction IN VARCHAR2 DEFAULT 'I') IS

  BEGIN

    Dbamv.Pack_Aux_Ffcv.Verif_Franquia_Ambu(Nregamb, Ncdlcto, Caction);

  END;



  PROCEDURE Lanca_Ciru_Ffcv(Ncdavisocirurgia IN NUMBER,

                            Caction          IN VARCHAR2 DEFAULT 'I') IS

  BEGIN

    Dbamv.Pack_Aux_Ffcv.Lanca_Ciru_Ffcv(Ncdavisocirurgia, Caction);

  END;



  -----------------------------------------------------------------------------------

  PROCEDURE Lanca_Eqpto_Ffcv(Ncdavisocirurgia       IN NUMBER,

                             Ncdaparelhoequipamento IN NUMBER,

                             Ndiferenca             IN NUMBER,

                             Caction                IN VARCHAR2,

                             Ncdprestador           IN NUMBER,

                             Ncditemmvto            IN NUMBER,

                             p_Ddtinicio            IN DATE DEFAULT NULL -- pda 159237

                            ,

                             p_Ddtfim               IN DATE DEFAULT NULL -- pda 159237

                             ) IS

  BEGIN

    Dbamv.Pack_Aux_Ffcv.Lanca_Eqpto_Ffcv(Ncdavisocirurgia,

                                         Ncdaparelhoequipamento,

                                         Ndiferenca,

                                         Caction,

                                         Ncdprestador,

                                         Ncditemmvto,

                                         p_Ddtinicio -- PDA: 159237

                                        ,

                                         p_Ddtfim -- PDA: 159237

                                         );

  END;



  FUNCTION Lanca_Mges_Ffcv(Ncdproduto            IN NUMBER,

                           Ncdmvtoestoque        IN NUMBER,

                           Ncdunipro             IN NUMBER,

                           Nqtmovnew             IN NUMBER,

                           Nqtmovold             IN NUMBER,

                           Caction               IN VARCHAR2,

                           Csnitempertencepacote IN VARCHAR2, /*Incluido este parametro por Marcelo em 14/01/2002*/

                           Ncditemmvto           IN NUMBER,

                           Ncdfornec             IN NUMBER DEFAULT NULL

                           -- PDA 170696(Inicio) - Henrique Antunes - 23/11/2006

                          ,

                           Ncdformula IN NUMBER DEFAULT NULL,

                           Nqtformula IN NUMBER DEFAULT NULL

                           -- PDA 170696 (Fim)

                          ,

                           Ptp_Execucao IN VARCHAR2 DEFAULT NULL --PDA 175557 - 20/01/2009 - Jansen Gallindo

                           ) RETURN VARCHAR2 IS

    /*PDA 202951(Inicio) - 02/07/2009 - Jansen Gallindo

    Inclu?da a coluna sn_lanca_mges_data_valid_presc, para identificar qual data considerar

    no lan?ento do item na conta*/

    CURSOR c_Importar IS

      SELECT Config_Ffcv.Sn_Estoque_Automatica,

             Config_Ffcv.Tp_Import_Mges,

             Config_Ffcv.Tp_Controle_Lote,

             Config_Ffcv.Sn_Consignado_Nf,

             Config_Ffcv.Sn_Checa_Preco_Lcto

             -- PDA 170696 (Inicio) - Henrique Antunes - 23/11/2006

            ,

             Config_Ffcv.Sn_Devolve_Mges_Kit

             -- PDA 170696 (Fim)

            ,

             Config_Ffcv.Sn_Guia_Proc_Auto /* pda 141006 */,

             Config_Ffcv.Sn_Lanca_Mges_Data_Valid_Presc,

             Config_Ffcv.Tp_Mges_Conta_Fechada /* Pda 519340 */

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    /*PDA 202951(fim) - 02/07/2009 - Jansen Gallindo*/

    CURSOR c_Setorcount IS

      SELECT COUNT(1) Qtdsetor

        FROM Dbamv.Setor_Lanca_Ffcv;

    CURSOR c_Setor(Nsetor NUMBER) IS

      SELECT Cd_Setor

        FROM Dbamv.Setor_Lanca_Ffcv

       WHERE Cd_Setor = Nsetor;

    CURSOR c_Proced IS

      SELECT Produto.Cd_Pro_Fat,

             Produto.Cd_Classe,

             Produto.Cd_Especie,

			 Produto.Cd_sub_cla,

			 Produto.Cd_produto,

             /*OP 26149 In?o.

             --Nvl(Produto.Vl_Fator_Pro_Fat, 1) Vl_Fator_Pro_Fat,*/

             Decode(Nvl(Produto.Vl_Fator_Pro_Fat, 1),0,1,Nvl(Produto.Vl_Fator_Pro_Fat,1)) Vl_Fator_Pro_Fat,

             /*OP 26149 Fim*/

             Produto.Sn_Consignado -- pda 528737

            ,

             Produto.Sn_Opme -- pda 528737

        FROM Dbamv.Produto

       WHERE Produto.Cd_Produto = Ncdproduto

         AND EXISTS

       (SELECT Empresa_Produto.Cd_Produto

                FROM Dbamv.Empresa_Produto

               WHERE Cd_Multi_Empresa = Pkg_Mv2000.Le_Empresa

                 AND Empresa_Produto.Cd_Produto = Produto.Cd_Produto); -- PDA 118607/125883



    -- OP 33697 *2 - 08/10/2015 - Identificar os dados pelo procedimento, por causa da regra de substitui? de procedimento.

    CURSOR cProcedProFat( vProFat in varchar2 ) IS

      SELECT Produto.Cd_Pro_Fat,

             Produto.Cd_Classe,

             Produto.Cd_Especie,

			 Produto.Cd_produto,

			 Produto.Cd_sub_cla,

             Decode(Nvl(Produto.Vl_Fator_Pro_Fat, 1),0,1,Nvl(Produto.Vl_Fator_Pro_Fat,1)) Vl_Fator_Pro_Fat,

             Produto.Sn_Consignado

            ,Produto.Sn_Opme

        FROM Dbamv.Produto

       WHERE Produto.Cd_pro_fat = vProFat

         AND EXISTS

       (SELECT Empresa_Produto.Cd_Produto

                FROM Dbamv.Empresa_Produto

               WHERE Cd_Multi_Empresa = Pkg_Mv2000.Le_Empresa

                 AND Empresa_Produto.Cd_Produto = Produto.Cd_Produto);

    cursor cGruProSub( vProFat in varchar2 ) is

      select gru_pro.cd_gru_fat, gru_fat.tp_gru_fat

        from dbamv.pro_fat, dbamv.gru_pro, dbamv.gru_fat

       where pro_fat.cd_pro_fat = vProFat

         and gru_pro.cd_gru_pro = pro_fat.cd_gru_pro

		 and gru_fat.cd_gru_fat = gru_pro.cd_gru_fat;

    vProFatAnterior   dbamv.pro_fat.cd_pro_fat%type;   -- OP 33697 *2



    CURSOR c_Orteseprotese(Cdprofat IN VARCHAR2) IS

      SELECT Pro_Fat.Cd_Pro_Fat,

             Dbamv.Fnc_Ffcv_Sn_Opme(Cdprofat) Sn_Opme /* pda 354260 - pro_fat.sn_opme*/

        FROM Dbamv.Pro_Fat Pro_Fat,

             Dbamv.Gru_Pro Gru_Pro

       WHERE Pro_Fat.Cd_Sus IS NULL

         AND Pro_Fat.Cd_Gru_Pro = Gru_Pro.Cd_Gru_Pro

         AND Pro_Fat.Cd_Pro_Fat = Cdprofat

            -- PDA 208386 (In?o) 01/12/2007 FL?IO LAGO

            --AND gru_pro.tp_gru_pro = 'OP';

         AND (Gru_Pro.Tp_Gru_Pro = 'OP' OR

             Dbamv.Fnc_Ffcv_Sn_Opme(Cdprofat) = 'S');

    -- PDA 208386 (fim)

    -- OP 5830 - 21/03/2013 - alterando mascara dos campos de data para considerar tamb?os segundos

    -- PDA 171524(inicio) -- adicionada nvl na data da movimenta? para

    -- inclus?da nova coluna dt_faturamento que ser?opulada quando for

    -- feita a confirma? da cirurgia ( p_mov_estoque_s_atende ) que ? gravada

    -- com o valor da data do atendimento ou da movimenta?

    CURSOR c_Mvto IS

      SELECT Mvto.Cd_Atendimento,

             Convenio.Sn_Lanca_Consignado_Na_Conta -- PDA 162402 -20/03/2007- Pedro Neiva (Apply)

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- ,nvl( mvto.dt_faturamento, mvto.dt_mvto_estoque ) dt_mvto_estoque

            ,

             Nvl(Mvto.Dt_Faturamento,

                 To_Date(To_Char(Mvto.Dt_Mvto_Estoque, 'DD/MM/YYYY') || ' ' ||

                         To_Char(Mvto.Hr_Mvto_Estoque, 'HH24:Mi:SS'),

                         'DD/MM/YYYY HH24:MI:SS')) Dt_Mvto_Estoque

             -- PDA 229502 (Fim)

            ,

             Nvl(Mvto.Dt_Faturamento, Mvto.Hr_Mvto_Estoque) Hr_Mvto_Estoque,

             Mvto.Cd_Setor,

             Mvto.Tp_Mvto_Estoque

             --PDA 353315(In?o)

            ,

             Mvto.Cd_Itped_Rx

             --PDA 353315(fim)

            ,

             Atendime.Tp_Atendimento,

             Atendime.Sn_Importa_Auto,

             Atendime.Cd_Convenio,

             Atendime.Cd_Con_Pla,

             Atendime.Cd_Atendimento_Pai,

             Convenio.Tp_Convenio,

             Atendime.Dt_Alta,

             Atendime.Dt_Atendimento,

             Atendime.Cd_Tip_Acom,

             Mvto.Tp_Convenio_Da_Cirurgia,

             To_Date(To_Char(Mvto.Dt_Mvto_Estoque, 'dd/mm/yyyy') ||

                     To_Char(Mvto.Hr_Mvto_Estoque, 'hh24:mi:ss'),

                     'dd/mm/yyyy hh24:mi:ss') Data_Estoque,

             To_Date(To_Char(Atendime.Dt_Alta, 'dd/mm/yyyy') ||

                     To_Char(Atendime.Hr_Alta, 'hh24:mi:ss'),

                     'dd/mm/yyyy hh24:mi:ss') Data_Alta,

             To_Date(To_Char(Atendime.Dt_Atendimento, 'dd/mm/yyyy') ||

                     To_Char(Atendime.Hr_Atendimento, 'hh24:mi:ss'),

                     'dd/mm/yyyy hh24:mi:ss') Data_Atendimento,

             Atendime.Cd_Convenio_Secundario,

             Atendime.Cd_Con_Pla_Secundario,

             Mvto.Cd_Estoque -- pda 131086

             -- PDA 162402 (Inicio) - Henrique Antunes - 04/05/2007

            ,

             Convenio.Sn_Cria_Guia_Opme_Fscc,

             convenio.TP_ATUALIZA_GUIA_OPME_FSCC ,



             Mvto.Cd_Aviso_Cirurgia

             -- PDA 162402 (Fim)

            ,

             Mvto.Dt_Faturamento -- pda 211463 - 03/01/2007 - Pedro Neiva

        FROM Dbamv.Mvto_Estoque Mvto,

             Dbamv.Atendime,

             Dbamv.Convenio,

             Dbamv.Estoque -->> pda 118607 (ACGM)

       WHERE Mvto.Cd_Mvto_Estoque = Ncdmvtoestoque

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

            -- inicio PDA 118607 / 120681 (acgm)

         AND Mvto.Cd_Estoque = Estoque.Cd_Estoque

         AND Estoque.Cd_Multi_Empresa = Pkg_Mv2000.Le_Empresa

            -- fim pda118607

         AND Atendime.Cd_Atendimento = Mvto.Cd_Atendimento

         AND Convenio.Cd_Convenio = Atendime.Cd_Convenio

         AND Convenio.Tp_Convenio IN ('H', 'P', 'C');

    -- PDA 171524(fim)

    -- PDA 180890 -- Alexandre erik -- 23/03/2007 -- (Inicio)

    -- cursor para verificar as solicita??es de devolu?

    CURSOR c_Mvto_Sol IS

      SELECT Solsai.Cd_Atendimento,

             Convenio.Sn_Lanca_Consignado_Na_Conta -- PDA 162402 -20/03/2007- Pedro Neiva (Apply)

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- ,solsai.dt_solsai_pro dt_mvto_estoque

            ,

             To_Date(To_Char(Solsai.Dt_Solsai_Pro, 'DD/MM/YYYY') || ' ' ||

                     To_Char(Solsai.Hr_Solsai_Pro, 'HH24:Mi:SS'),

                     'DD/MM/YYYY HH24:MI:SS') Dt_Mvto_Estoque

             -- PDA 229502 (Fim)

            ,

             Solsai.Hr_Solsai_Pro Hr_Mvto_Estoque,

             Solsai.Cd_Setor,

             'C' Tp_Mvto_Estoque

             --PDA 353315(In?o)

            ,

             NULL Cd_Itped_Rx

             --PDA 353315(fim)

            ,

             Atendime.Tp_Atendimento,

             Atendime.Sn_Importa_Auto,

             Atendime.Cd_Convenio,

             Atendime.Cd_Con_Pla,

             Atendime.Cd_Atendimento_Pai,

             Convenio.Tp_Convenio,

             Atendime.Dt_Alta,

             Atendime.Dt_Atendimento,

             Atendime.Cd_Tip_Acom,

             Convenio.Tp_Convenio Tp_Convenio_Da_Cirurgia,

             To_Date(To_Char(Solsai.Dt_Solsai_Pro, 'dd/mm/yyyy') ||

                     To_Char(Solsai.Hr_Solsai_Pro, 'hh24:mi:ss'),

                     'dd/mm/yyyy hh24:mi:ss') Data_Estoque,

             To_Date(To_Char(Atendime.Dt_Alta, 'dd/mm/yyyy') ||

                     To_Char(Atendime.Hr_Alta, 'hh24:mi:ss'),

                     'dd/mm/yyyy hh24:mi:ss') Data_Alta,

             To_Date(To_Char(Atendime.Dt_Atendimento, 'dd/mm/yyyy') ||

                     To_Char(Atendime.Hr_Atendimento, 'hh24:mi:ss'),

                     'dd/mm/yyyy hh24:mi:ss') Data_Atendimento,

             Atendime.Cd_Convenio_Secundario,

             Atendime.Cd_Con_Pla_Secundario,

             Solsai.Cd_Estoque -- pda 131086

             -- PDA 162402 (Inicio) - Henrique Antunes - 04/05/2007

            ,

             Convenio.Sn_Cria_Guia_Opme_Fscc,

             convenio.TP_ATUALIZA_GUIA_OPME_FSCC ,

             NULL Cd_Aviso_Cirurgia

             -- PDA 162402 (Fim)

            ,

             NULL Dt_Faturamento -- pda 211463 - 03/01/2007 - Pedro Neiva

        FROM Dbamv.Solsai_Pro Solsai,

             Dbamv.Atendime,

             Dbamv.Convenio,

             Dbamv.Estoque

       WHERE Solsai.Cd_Solsai_Pro = Ncdmvtoestoque

         AND Solsai.Cd_Estoque = Estoque.Cd_Estoque

         AND Estoque.Cd_Multi_Empresa = Pkg_Mv2000.Le_Empresa

         AND Atendime.Cd_Atendimento = Solsai.Cd_Atendimento

         AND Convenio.Cd_Convenio = Atendime.Cd_Convenio

         AND Convenio.Tp_Convenio IN ('H', 'P', 'C')

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    -- PDA 180890 -- (Fim)

    CURSOR c_Fator IS

      SELECT Nvl(Uni_Pro.Vl_Fator, 1) Vl_Fator

        FROM Dbamv.Uni_Pro

       WHERE Uni_Pro.Cd_Uni_Pro = Ncdunipro;

    CURSOR c_Grfat(Ncdclasse IN NUMBER, Ncdespecie IN NUMBER, Ncdsetor IN NUMBER, Ncdestoq IN NUMBER, Ncdproduto IN NUMBER, Ncdsubclasse IN NUMBER) IS

    SELECT CD_GRU_FAT
	,Tp_Gru_Fat
	FROM (
	SELECT 1 PRI
		,cnf.CD_GRU_FAT
		,gru.Tp_Gru_Fat
	FROM DBAMV.CONFIGU_IMPORTACAO_GRU_FAT cnf
		,DBAMV.GRU_FAT gru
	WHERE gru.CD_GRU_FAT = cnf.CD_GRU_FAT
		AND (CD_PRODUTO IS NOT NULL AND cnf.CD_PRODUTO = Ncdproduto)
    AND CD_SETOR = Ncdsetor
		AND CD_ESPECIE = Ncdespecie
		AND CD_CLASSE = Ncdclasse
		AND (CD_SUB_CLA IS NOT NULL AND CD_SUB_CLA = Ncdsubclasse)
    AND (CD_ESTOQUE IS NOT NULL AND CD_ESTOQUE = Ncdestoq)

	UNION

  SELECT 2 PRI
		,cnf.CD_GRU_FAT
		,gru.Tp_Gru_Fat
	FROM DBAMV.CONFIGU_IMPORTACAO_GRU_FAT cnf
		,DBAMV.GRU_FAT gru
	WHERE gru.CD_GRU_FAT = cnf.CD_GRU_FAT
		AND (CD_PRODUTO IS NOT NULL AND cnf.CD_PRODUTO = Ncdproduto)
    AND CD_SETOR = Ncdsetor
		AND CD_ESPECIE = Ncdespecie
		AND CD_CLASSE = Ncdclasse
		AND (CD_SUB_CLA IS NOT NULL AND CD_SUB_CLA = Ncdsubclasse)
    AND CD_ESTOQUE IS NULL

	UNION

	SELECT 3 PRI
		,cnf.CD_GRU_FAT
		,gru.Tp_Gru_Fat
	FROM DBAMV.CONFIGU_IMPORTACAO_GRU_FAT cnf
		,DBAMV.GRU_FAT gru
	WHERE gru.CD_GRU_FAT = cnf.CD_GRU_FAT
		AND CD_PRODUTO IS NULL
		AND (CD_ESTOQUE IS NOT NULL AND CD_ESTOQUE = Ncdestoq)
		AND (CD_SUB_CLA IS NOT NULL AND CD_SUB_CLA = Ncdsubclasse)
		AND CD_SETOR = Ncdsetor
		AND CD_ESPECIE = Ncdespecie
		AND CD_CLASSE = Ncdclasse

	UNION

	SELECT 4 PRI
		,cnf.CD_GRU_FAT
		,gru.Tp_Gru_Fat
	FROM DBAMV.CONFIGU_IMPORTACAO_GRU_FAT cnf
		,DBAMV.GRU_FAT gru
	WHERE gru.CD_GRU_FAT = cnf.CD_GRU_FAT
		AND CD_PRODUTO IS NULL
		AND CD_ESTOQUE IS NULL
		AND (CD_SUB_CLA IS NOT NULL AND CD_SUB_CLA = 2)
		AND CD_SETOR = Ncdsetor
		AND CD_ESPECIE = Ncdespecie
		AND CD_CLASSE = Ncdclasse

	UNION

	SELECT 5 PRI
		,cnf.CD_GRU_FAT
		,gru.Tp_Gru_Fat
	FROM DBAMV.CONFIGU_IMPORTACAO_GRU_FAT cnf
		,DBAMV.GRU_FAT gru
	WHERE gru.CD_GRU_FAT = cnf.CD_GRU_FAT
		AND CD_PRODUTO IS NULL
		AND CD_SUB_CLA IS NULL
		AND (CD_ESTOQUE IS NOT NULL AND CD_ESTOQUE = Ncdestoq)
		AND CD_SETOR = Ncdsetor
		AND CD_ESPECIE = Ncdespecie
		AND CD_CLASSE = Ncdclasse

	UNION

	SELECT 6 PRI
		,cnf.CD_GRU_FAT
		,gru.Tp_Gru_Fat
	FROM DBAMV.CONFIGU_IMPORTACAO_GRU_FAT cnf
		,DBAMV.GRU_FAT gru
	WHERE gru.CD_GRU_FAT = cnf.CD_GRU_FAT
		AND CD_PRODUTO IS NULL
		AND CD_ESTOQUE IS NULL
		AND CD_SETOR = Ncdsetor
		AND CD_ESPECIE = Ncdespecie
		AND CD_CLASSE = Ncdclasse
		AND CD_SUB_CLA IS NULL
	ORDER BY PRI
	);

    -- pda 131086 inicio

    CURSOR c_Grfat_Estoq(Ncdclasse IN NUMBER, Ncdespecie IN NUMBER, Ncdsetor IN NUMBER, Ncdestoq IN NUMBER, Ncdproduto IN NUMBER, Ncdsubclasse IN NUMBER) IS

	SELECT CD_GRU_FAT
	,Tp_Gru_Fat
FROM (
	SELECT 1 PRI
		,cnf.CD_GRU_FAT
		,gru.Tp_Gru_Fat
	FROM DBAMV.CONFIGU_IMPORTACAO_GRU_FAT cnf
		,DBAMV.GRU_FAT gru
	WHERE gru.CD_GRU_FAT = cnf.CD_GRU_FAT
		AND (CD_PRODUTO IS NOT NULL AND cnf.CD_PRODUTO = Ncdproduto)
    AND CD_SETOR = Ncdsetor
		AND CD_ESPECIE = Ncdespecie
		AND CD_CLASSE = Ncdclasse
		AND (CD_SUB_CLA IS NOT NULL AND CD_SUB_CLA = Ncdsubclasse)
    AND (CD_ESTOQUE IS NOT NULL AND CD_ESTOQUE = Ncdestoq)

	UNION

  SELECT 2 PRI
		,cnf.CD_GRU_FAT
		,gru.Tp_Gru_Fat
	FROM DBAMV.CONFIGU_IMPORTACAO_GRU_FAT cnf
		,DBAMV.GRU_FAT gru
	WHERE gru.CD_GRU_FAT = cnf.CD_GRU_FAT
		AND (CD_PRODUTO IS NOT NULL AND cnf.CD_PRODUTO = Ncdproduto)
    AND CD_SETOR = Ncdsetor
		AND CD_ESPECIE = Ncdespecie
		AND CD_CLASSE = Ncdclasse
		AND (CD_SUB_CLA IS NOT NULL AND CD_SUB_CLA = Ncdsubclasse)
    AND CD_ESTOQUE IS NULL

	UNION

	SELECT 3 PRI
		,cnf.CD_GRU_FAT
		,gru.Tp_Gru_Fat
	FROM DBAMV.CONFIGU_IMPORTACAO_GRU_FAT cnf
		,DBAMV.GRU_FAT gru
	WHERE gru.CD_GRU_FAT = cnf.CD_GRU_FAT
		AND CD_PRODUTO IS NULL
		AND (CD_ESTOQUE IS NOT NULL AND CD_ESTOQUE = Ncdestoq)
		AND (CD_SUB_CLA IS NOT NULL AND CD_SUB_CLA = Ncdsubclasse)
		AND CD_SETOR = Ncdsetor
		AND CD_ESPECIE = Ncdespecie
		AND CD_CLASSE = Ncdclasse

	UNION

	SELECT 4 PRI
		,cnf.CD_GRU_FAT
		,gru.Tp_Gru_Fat
	FROM DBAMV.CONFIGU_IMPORTACAO_GRU_FAT cnf
		,DBAMV.GRU_FAT gru
	WHERE gru.CD_GRU_FAT = cnf.CD_GRU_FAT
		AND CD_PRODUTO IS NULL
		AND CD_ESTOQUE IS NULL
		AND (CD_SUB_CLA IS NOT NULL AND CD_SUB_CLA = 2)
		AND CD_SETOR = Ncdsetor
		AND CD_ESPECIE = Ncdespecie
		AND CD_CLASSE = Ncdclasse

	UNION

	SELECT 5 PRI
		,cnf.CD_GRU_FAT
		,gru.Tp_Gru_Fat
	FROM DBAMV.CONFIGU_IMPORTACAO_GRU_FAT cnf
		,DBAMV.GRU_FAT gru
	WHERE gru.CD_GRU_FAT = cnf.CD_GRU_FAT
		AND CD_PRODUTO IS NULL
		AND CD_SUB_CLA IS NULL
		AND (CD_ESTOQUE IS NOT NULL AND CD_ESTOQUE = Ncdestoq)
		AND CD_SETOR = Ncdsetor
		AND CD_ESPECIE = Ncdespecie
		AND CD_CLASSE = Ncdclasse

	UNION

	SELECT 6 PRI
		,cnf.CD_GRU_FAT
		,gru.Tp_Gru_Fat
	FROM DBAMV.CONFIGU_IMPORTACAO_GRU_FAT cnf
		,DBAMV.GRU_FAT gru
	WHERE gru.CD_GRU_FAT = cnf.CD_GRU_FAT
		AND CD_PRODUTO IS NULL
		AND CD_ESTOQUE IS NULL
		AND CD_SETOR = Ncdsetor
		AND CD_ESPECIE = Ncdespecie
		AND CD_CLASSE = Ncdclasse
		AND CD_SUB_CLA IS NULL
	ORDER BY PRI
	);


    -- PDA 131086 fim

    CURSOR c_Config_Particular IS

      SELECT Cd_Convenio_Fat_Extra Cd_Convenio,

             Cd_Con_Pla_Fat_Extra  Cd_Con_Pla

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    -- PDA 99224(inicio) - 03/09/2004 - Fabianna A. Cavalcante

    -- Adicionado join com o codigo da multi_empresa pois a tabela

    -- produto_ultimas_Compras armazenar? as ultimas 3 entradas por empresa.

    CURSOR c_Ultimas_Compras IS

      SELECT Cd_Fornecedor,

             Vl_Custo_Real

        FROM Dbamv.Produto_Ultimas_Compras

       WHERE Cd_Produto = Ncdproduto

            --PDA 189645 (In?o)

         AND ((Cd_Fornecedor = Ncdfornec AND

             Dbamv.Pkg_Mv2000.Le_Cliente <> 420) OR

             Dbamv.Pkg_Mv2000.Le_Cliente = 420)

            --PDA 189645 (FIm)

         AND Cd_Multi_Empresa = Pkg_Mv2000.Le_Empresa

       ORDER BY Dt_Entrada DESC,

                Hr_Entrada DESC;

    CURSOR c_Entrada_Prod IS

      SELECT e.Cd_Fornecedor,

             i.Vl_Custo_Real

        FROM Dbamv.Ent_Pro   e,

             Dbamv.Itent_Pro i

       WHERE e.Cd_Ent_Pro = i.Cd_Ent_Pro

         AND i.Cd_Produto = Ncdproduto

         AND Cd_Fornecedor = Ncdfornec

         AND e.Cd_Estoque IN

             (SELECT Estoque.Cd_Estoque

                FROM Dbamv.Estoque

               WHERE Estoque.Cd_Multi_Empresa = Pkg_Mv2000.Le_Empresa)

       ORDER BY e.Dt_Entrada DESC,

                e.Hr_Entrada DESC;

    -- PDA 208386 (In?o) 01/12/2007 FL?IO LAGO

    -- Entrada de Materiais ou Medicamentos marcados como OPME.

    CURSOR c_Entrada_Prod_Sn_Opme(Pccdatendimento IN NUMBER) IS

      SELECT e.Cd_Fornecedor,

             i.Vl_Custo_Real

        FROM Dbamv.Ent_Pro   e,

             Dbamv.Itent_Pro i

       WHERE e.Cd_Ent_Pro = i.Cd_Ent_Pro

         AND i.Cd_Produto = Ncdproduto

         AND Cd_Fornecedor = Ncdfornec

         AND i.Cd_Atendimento = Pccdatendimento

            -- 2o. pessoal do mges, n?precisa: AND e.cd_atendimento = i.cd_atendimento

         AND e.Cd_Estoque IN

             (SELECT Estoque.Cd_Estoque

                FROM Dbamv.Estoque

               WHERE Estoque.Cd_Multi_Empresa = Pkg_Mv2000.Le_Empresa)

       ORDER BY e.Dt_Entrada DESC,

                e.Hr_Entrada DESC;

    -- PDA 208386 (fim)

    /* OP 3319 - 27/03/2013 - cursores n?ser?mais utilizados

    --PDA 497780 - Jansen Gallindo -  desfazendo implementa? abaixo do pda 253547, pois esta foi de adiantamento antes da migra? do soulmv

    -- PDA 253547 - Substituido pela nova fun? que retorna o percentual

        CURSOR c_percentual_consignado (

           ncdconvenio   IN   NUMBER

          ,ncdprofat     IN   VARCHAR2

        ) IS

           SELECT vl_percentual

             FROM dbamv.percentual_consignado

                 ,dbamv.empresa_convenio

            WHERE percentual_consignado.cd_convenio = empresa_convenio.cd_convenio

              AND empresa_convenio.cd_multi_empresa = dbamv.pkg_mv2000.le_empresa

              AND percentual_consignado.cd_convenio = ncdconvenio

              AND cd_pro_fat = ncdprofat;



        CURSOR c_percentual_consignado_conv (

           ncdconvenio   IN   NUMBER

        ) IS

           SELECT vl_percentual

             FROM dbamv.percentual_consignado

                 ,dbamv.empresa_convenio

            WHERE percentual_consignado.cd_convenio = empresa_convenio.cd_convenio

              AND empresa_convenio.cd_multi_empresa = dbamv.pkg_mv2000.le_empresa

              AND percentual_consignado.cd_convenio = ncdconvenio

              AND cd_pro_fat IS NULL;

    --PDA 497780 - Jansen Gallindo(fim)

      OP 3319 - fim */

    CURSOR Cvalorizacao(Ncdatendimento IN NUMBER, Vprofat VARCHAR2, Nfornecedor IN NUMBER, Pncdguia IN NUMBER) IS /*427112*/

      SELECT Vl_Total_Autorizado

        FROM Dbamv.Val_Opme_It_Guia,

             Dbamv.Guia,

             Dbamv.It_Guia

       WHERE Guia.Cd_Guia = It_Guia.Cd_Guia

         AND Guia.Cd_Guia = Val_Opme_It_Guia.Cd_Guia

         AND It_Guia.Cd_It_Guia = Val_Opme_It_Guia.Cd_It_Guia

         AND Val_Opme_It_Guia.Sn_Fornecedor_Autorizado = 'S'

         AND Val_Opme_It_Guia.Cd_Fornecedor = Nfornecedor

         AND Guia.Cd_Atendimento = Ncdatendimento

         AND Guia.Tp_Situacao = 'A' /*427112*/

         AND Guia.Cd_Guia = Nvl(Pncdguia, Guia.Cd_Guia) /*427112*/

         AND It_Guia.Cd_Pro_Fat = Vprofat;

    /* OP 3319 - buscando empresa direto na tabela */

    CURSOR c_Total_Percentual_Consignado IS

      SELECT COUNT(*)

        FROM Dbamv.Percentual_Consignado

       WHERE Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    --     ,dbamv.empresa_convenio

    --WHERE percentual_consignado.cd_convenio = empresa_convenio.cd_convenio

    --  AND empresa_convenio.cd_multi_empresa = dbamv.pkg_mv2000.le_empresa;

    CURSOR c_Eh_Consignado IS

      SELECT COUNT(*)

        FROM Dbamv.Produto

       WHERE Cd_Produto = Ncdproduto

         AND EXISTS

       (SELECT Empresa_Produto.Cd_Produto

                FROM Dbamv.Empresa_Produto

               WHERE Cd_Multi_Empresa = Pkg_Mv2000.Le_Empresa

                 AND Empresa_Produto.Cd_Produto = Produto.Cd_Produto) -- PDA 118607/125883

         AND Sn_Consignado = 'S';

    CURSOR c_Config IS

      SELECT Sn_Guia_Proc_Auto

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    --PDA 99802 09/07/2004 Sp?ola (INICIO)

    --Cursor para coletar dados de atendimento ambulatorial por sess?para o atendimento pai

    CURSOR Catendsessao(Pncdatedimento IN NUMBER --N??o do atendimento de sessao filho

    ) IS

    -- PDA 206003 (Inicio) - Henrique Antunes - 19/02/2008

    --SELECT NVL (atendime_sessao.sn_retorno, 'N') sn_retorno

      SELECT 'S' Sn_Retorno

             -- PDA 206003 (Fim)

            ,

             Nvl(Atendime.Qt_Sessoes, 0) Qt_Sessoes,

             Atendime_Sessao.Dt_Atendimento Dt_Atendimento

        FROM Dbamv.Atendime Atendime,

             Dbamv.Atendime Atendime_Sessao

       WHERE Atendime_Sessao.Cd_Atendimento = Pncdatedimento

         AND Atendime_Sessao.Cd_Atendimento_Pai = Atendime.Cd_Atendimento

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    -- PDA 170696 (Inicio) - Henrique Antunes - 23/11/2006

    CURSOR c_Kit IS

      SELECT Formula.Cd_Padrao

        FROM Dbamv.Formula

       WHERE Formula.Cd_Formula = Ncdformula;

    --

    -- pda 245240 - 20/08/2008 - Amalia Ara??- n?filtrar pela hora, para n?duplicar registros na DBAMV.CONTA_KIT

    --PDA  186048 (INICIO) - Jansen Gallindo - 19/04/2007

    CURSOR c_Conta_Kit(Ncdconta IN Dbamv.Conta_Kit.Cd_Reg_Fat%TYPE /*number PDA 254997*/

    , Ddtmvto IN DATE, Dhrmvto IN DATE, Ncdpadrao IN NUMBER) IS

      SELECT Conta_Kit.Cd_Conta_Kit

        FROM Dbamv.Conta_Kit

       WHERE (Conta_Kit.Cd_Reg_Fat = Ncdconta OR

             Conta_Kit.Cd_Reg_Amb = Ncdconta)

         AND Trunc(Conta_Kit.Dt_Lancamento) = Trunc(Ddtmvto) -- pda 245240 - colocado trunc

            --and conta_kit.dt_lancamento = dDtMvto               -- pda 245240 - comentado

            --and conta_kit.hr_lancamento = dHrMvto               -- pda 245240 - comentado

         AND Conta_Kit.Cd_Padrao = Ncdpadrao;

    --PDA 186048 (FIM)

    -- pda 245240 - fim

    --

    CURSOR c_Seq_Conta_Kit IS

      SELECT Dbamv.Seq_Conta_Kit.NEXTVAL

        FROM Sys.Dual;

    -- PDA 170696 (Fim)

    -- PDA 166225 (Inicio) - Henrique Antunes - 12/01/2007

    CURSOR Ccapconfiguracao IS

      SELECT 1

        FROM Dbamv.Configuracao

       WHERE Chave = 'SN_LANCA_FATOR_INTEIRO'

         AND Valor = 'S'

         AND (Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa OR

             Cd_Multi_Empresa IS NULL) -- OP 12525 - 29/10/2013

      ;

    --PDA 175557(inicio) - 20/01/2009 - Jansen Gallindo

    -- PDA 180890 -- Alexandre erik -- 23/03/2007 -- (Inicio)

    -- Cursor para ler configura? se a integra? ser?ela Solicita? ou confirma?.

    /*cursor cconfigGlobal is

    select valor

      from dbamv.configuracao

     where cd_sistema = 'FFCV'

       and chave = 'SN_DEVOLUCAO_FAT_SOLIC';*/

    -- PDA 180890 -- (Fim)

    CURSOR Csnestornosolicdev IS

      SELECT Sn_Estorno_Solic_Devol

        FROM Dbamv.Config_Ffcv

       WHERE Cd_Multi_Empresa = Pkg_Mv2000.Le_Empresa;

    Vsnest Csnestornosolicdev%ROWTYPE;

    --PDA 175557(fim) - 20/01/2009 - Jansen Gallindo

    Cdadosconfiguracao Ccapconfiguracao%ROWTYPE;

    Fator_Inteiro      BOOLEAN;

    -- PDA 166225 (Fim)

    -- PDA 162402 (In?o) - 20/03/2007 - Pedro Neiva (Apply)

    CURSOR Csnfaturadireta(Pvcdprofat IN VARCHAR2, Pncdguia IN NUMBER) IS

      SELECT It_Guia.Sn_Fatura_Direto

        FROM Dbamv.It_Guia

       WHERE It_Guia.Cd_Guia = Pncdguia

         AND It_Guia.Cd_Pro_Fat = Pvcdprofat;

    -- PDA 162402 (Fim) - 20/03/2007 - Pedro Neiva (Apply)

    --PDA 186048 (INICIO) - Jansen Gallindo - 19/04/2007

    CURSOR Cdevkithosp(Pncdregfat Dbamv.Itreg_Fat.Cd_Reg_Fat%TYPE /* Number PDA 254997*/

    , Pncdlancamento Dbamv.Itreg_Fat.Cd_Lancamento%TYPE /* Number PDA 254997*/

    ) IS

      SELECT Cd_Conta_Kit

        FROM Dbamv.Itreg_Fat

       WHERE Cd_Reg_Fat = Pncdregfat

         AND Cd_Lancamento = Pncdlancamento;

    --

    CURSOR Cdevkitamb(Pncdregamb Dbamv.Itreg_Amb.Cd_Reg_Amb%TYPE /* Number PDA 254997*/

    , Pncdlancamento Dbamv.Itreg_Amb.Cd_Lancamento%TYPE /* Number PDA 254997*/

    ) IS

      SELECT Cd_Conta_Kit

        FROM Dbamv.Itreg_Amb

       WHERE Cd_Reg_Amb = Pncdregamb

         AND Cd_Lancamento = Pncdlancamento;

    Ncdctkit  NUMBER;

    Ncontakit NUMBER;

    --PDA 186048 (fim)

    -- pda 196459 (Inicio)

    --

    CURSOR Cvalguia(Pncd_Pro_Fat VARCHAR2, Pncd_Atend VARCHAR2, Pncd_Fornec NUMBER, Pncd_Guia IN NUMBER) IS /* pda 427112*/

      SELECT Guia.Cd_Guia,

             Guia.Nr_Guia,

             Val_Opme.Cd_Fornecedor,

             (Val_Opme.Vl_Total_Autorizado /

             Decode(Nvl(It_Guia.Qt_Autorizada_Convenio,

                         It_Guia.Qt_Autorizado),

                     0,

                     1,

                     Nvl(It_Guia.Qt_Autorizada_Convenio,

                         It_Guia.Qt_Autorizado))) Vl_Unitario,

             Val_Opme.Vl_Total_Autorizado,

             Fornecedor.Nm_Fornecedor,

             It_Guia.Ds_Observacao

        FROM Dbamv.Val_Opme_It_Guia Val_Opme,

             Dbamv.It_Guia,

             Dbamv.Guia,

             Dbamv.Fornecedor

       WHERE It_Guia.Cd_Pro_Fat = Pncd_Pro_Fat

         AND Guia.Cd_Guia = It_Guia.Cd_Guia

         AND Guia.Cd_Atendimento = Pncd_Atend

            --

         AND Guia.Cd_Guia = Nvl(Pncd_Guia, Guia.Cd_Guia) /* pda 427112*/

         AND Val_Opme.Cd_Fornecedor = Pncd_Fornec

         AND Guia.Tp_Guia = 'O'

         AND Guia.Tp_Situacao = 'A'

            --

         AND Val_Opme.Cd_Guia = It_Guia.Cd_Guia

         AND Val_Opme.Cd_It_Guia = It_Guia.Cd_It_Guia

         AND Nvl(Val_Opme.Vl_Total_Autorizado, 0) > 0

         AND Fornecedor.Cd_Fornecedor = Val_Opme.Cd_Fornecedor;

    CURSOR Clancvalguia IS

      SELECT '1'

        FROM Dbamv.Configuracao

       WHERE Cd_Sistema = 'FFCV'

         AND Chave = 'SN_RETORNA_VALOR_OPME'

         AND Valor = 'S'

         AND (Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa OR

             Cd_Multi_Empresa IS NULL) -- OP 12525 - 29/10/2013

      ;

    -- pda 200497 (In?o) 06/09/2007

    CURSOR Chospital IS

      SELECT Cd_Hospital

        FROM Dbamv.Hospital

       WHERE Hospital.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    -- PDA 208884 (Inicio)

    CURSOR Cleconfig IS

      SELECT Valor

        FROM Dbamv.Configuracao

       WHERE Cd_Sistema = 'FFCV'

         AND Chave = 'SN_VALOR_GUIA'

         AND Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    Vsnvalorguia VARCHAR2(1);

    -- PDA 208884 (Fim)

    --pda 234939(In?o) Pedro Neiva - 02/07/2008

    CURSOR Csnfaturadireta2(Pvcdprofat IN VARCHAR2, Ncdconv IN NUMBER) IS

      SELECT 'S' Sn_Fatura_Direto

        FROM Dbamv.Convenio_Pro_Fat

       WHERE Convenio_Pro_Fat.Cd_Convenio = Ncdconv

         AND Convenio_Pro_Fat.Cd_Pro_Fat = Pvcdprofat;

    --pda 234939(Fim)

    -- PDA 353315(In?o)

    --Verifica indice configurado para o IPE quando for clinica.

    CURSOR Cindiceipeclinica IS

      SELECT Valor,

             COUNT(*) Existe

        FROM Dbamv.Configuracao

       WHERE Cd_Sistema = 'FFCV'

         AND Chave = 'VL_INDICE_IPE_CLINICA'

         AND (Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa OR

             Cd_Multi_Empresa IS NULL) -- OP 12525 - 29/10/2013

       GROUP BY Valor;

    Rindiceipeclinica Cindiceipeclinica%ROWTYPE;

    -- PDA 353315(Fim)

    -- PDA 353315(Inicio)

    CURSOR Cexamerelacionado(Pncdmvtoestoque Dbamv.Mvto_Estoque.Cd_Mvto_Estoque%TYPE, Pncditpedrx Dbamv.Itped_Rx.Cd_Itped_Rx%TYPE) IS

      SELECT Cd_Reg_Amb    Cd_Reg_Amb_Rel,

             Cd_Lancamento Cd_Lancamento_Rel

        FROM Dbamv.Itreg_Amb    Itcta,

             Dbamv.Mvto_Estoque Mvto,

             Dbamv.Ped_Rx       Ped,

             Dbamv.Itped_Rx     Itped,

             Dbamv.Exa_Rx       Exa

       WHERE Itcta.Cd_Atendimento = Ped.Cd_Atendimento

         AND Mvto.Cd_Mvto_Estoque = Pncdmvtoestoque

         AND Mvto.Cd_Itped_Rx = Itcta.Cd_Itmvto

         AND Itped.Cd_Itped_Rx = Pncditpedrx

         AND Itcta.Cd_Mvto = Itped.Cd_Ped_Rx

         AND Itcta.Tp_Mvto IN ('Imagem', 'Kit-Exame')

         AND Ped.Cd_Ped_Rx = Itped.Cd_Ped_Rx

         AND Itcta.Cd_Itmvto = Itped.Cd_Itped_Rx

         AND Itped.Cd_Exa_Rx = Exa.Cd_Exa_Rx

         AND Exa.Exa_Rx_Cd_Pro_Fat = Itcta.Cd_Pro_Fat;

    Rexamerelacionado Cexamerelacionado%ROWTYPE;

    -- PDA 353315(In?o)

    /*PDA 202951(Inicio) - 02/07/2009 - Jansen Gallindo

    retornando a data inicial da prescri? para o item da movimenta? do estoque */

    CURSOR Cdtpresc(Pcdmvto IN NUMBER) IS

      SELECT Dt_Pre_Med Dt_Inicio_Validade,

             Hr_Pre_Med Hr_Inicio_Validade

        FROM Dbamv.Pre_Med

       WHERE Cd_Pre_Med IN

             (SELECT Cd_Pre_Med

                FROM Dbamv.Solsai_Pro

               WHERE Cd_Solsai_Pro IN

                     (SELECT Cd_Solsai_Pro

                        FROM Dbamv.Mvto_Estoque

                       WHERE Cd_Mvto_Estoque = Pcdmvto));

    /*PDA 202951(Fim) - 02/07/2009 - Jansen Gallindo*/

    /* pda 330455 - 05/02/2010 - Amalia Ara??- Este cursor n?sera mais utilizado porque esta procurando nos itens

                da conta utilizando a movimenta? da devolu?. Dessa forma a rotina exclui o item da conta, mas

    por causa desse cursor acaba gerando o consumo n?lan?o indevidamente.  */

    /*PDA.: 289129 - 14/08/2009 - Emanoel Deivison (inicio)

      Descri?: Criado o cursor: "cVerificaItemConta" para verificar se o item existe mesmo na conta antes de chamar

                 o raise: "conta_sem_item". Pois estava exibindo o Consumo n?lan?o com a seguinte mensagem:

                 "devolu? ou Exclusao n?encontrou item na conta para efetuar a exclusao."

                 Isso mesmo com a movimenta? efetuada dentro do periodo da conta.

    */

    /*

    cursor cVerificaItemConta (pnCdConta in number,

                               pnCdMvto in number,

                               pvCdProFat in VARCHAR2,

                               pnCdItMvto in number) is

       select 'S' Existe

         from dbamv.itreg_fat

        where cd_reg_fat = pnCdConta

          and cd_mvto    = pnCdMvto

          and cd_pro_fat = pvCdProFat

          and cd_itmvto  = pnCdItMvto



       union



       select 'S' Existe

         from dbamv.itreg_amb

        where cd_reg_amb = pnCdConta

          and cd_mvto    = pnCdMvto

          and cd_pro_fat = pvCdProFat

          and cd_itmvto  = pnCdItMvto;    */

    /*PDA.: 289129 - 14/08/2009 - Emanoel Deivison (fim)*/

    /* Pda 519340 */

    CURSOR Ccontafechada(Natend IN NUMBER, Ncdmvto IN NUMBER) IS

      SELECT DISTINCT Sn_Fechada

        FROM (SELECT Reg_Fat.Sn_Fechada Sn_Fechada

                FROM Dbamv.Reg_Fat,

                     Dbamv.Itreg_Fat

               WHERE Reg_Fat.Cd_Reg_Fat = Itreg_Fat.Cd_Reg_Fat

                 AND Reg_Fat.Cd_Atendimento = Natend

                 AND Itreg_Fat.Cd_Mvto = Ncdmvto

                 AND Itreg_Fat.Tp_Mvto = 'Produto'

              UNION

              SELECT MIN(Sn_Fechada) Sn_Fechada

                FROM Dbamv.Itreg_Amb

               WHERE Cd_Atendimento = Natend

                 AND Cd_Mvto = Ncdmvto

                 AND Tp_Mvto = 'Produto')

       WHERE Sn_Fechada IS NOT NULL;

    /*pda 307025 - Thiago Miranda de Oliveira - criando cursores para pegar a qunatidade original do item da conta apra comprara com o que vai ser alerado

    nos dados da nota para manuten? desta tabela */

    CURSOR Ccobpre(Nconta IN NUMBER, Nlanc IN NUMBER) IS

      SELECT i.Qt_Lancamento

        FROM Dbamv.Itreg_Fat i,

             Dbamv.Itcob_Pre c

       WHERE i.Cd_Reg_Fat = c.Cd_Reg_Fat

         AND i.Cd_Lancamento = c.Cd_Lancamento

         AND i.Cd_Reg_Fat = Nconta

         AND i.Cd_Lancamento = Nlanc;

    --

    CURSOR Ccobpreamb(Nconta IN NUMBER, Natend IN NUMBER, Nlanc IN NUMBER) IS

      SELECT i.Qt_Lancamento

        FROM Dbamv.Itreg_Amb      i,

             Dbamv.Itcob_Pre_Ambu c

       WHERE i.Cd_Reg_Amb = c.Cd_Reg_Amb

         AND i.Cd_Lancamento = c.Cd_Lancamento

         AND i.Cd_Reg_Amb = Nconta

         AND i.Cd_Lancamento = Nlanc

         AND i.Cd_Atendimento = Natend;

    /*fim pda 307025*/



    Vcdhospital          Dbamv.Hospital.Cd_Hospital%TYPE;

    Npreco_Unitario_Opme NUMBER;

    Npreco_Total_Opme    NUMBER;

    -- pda 200497 (Fim) 06/09/2007

    Vcvalguia          Cvalguia%ROWTYPE;

    Vclancvalguia      Clancvalguia%ROWTYPE;

    Nvl_Preco_Unitario NUMBER;

    Nvl_Preco_Total    NUMBER;

    --

    -- pda 196459 (Fim)

    Vcatendsessao Catendsessao%ROWTYPE;

    --PDA 99802 (FIM)

    Prod_Nao_Conf EXCEPTION;

    Setor_Nao_Conf EXCEPTION;

    Proc_Sem_Preco EXCEPTION;

    Auditoria_In_Loco EXCEPTION;

    Atend_Sem_Conta EXCEPTION;

    Proc_Proibido EXCEPTION;

	proc_proibido_idade                 EXCEPTION;    -- OP 32555

    Fora_Da_Conta EXCEPTION;

    Devolucao_Sem_Conta EXCEPTION;

    --PDA 100545 Alexandre Erik C. M. Costa -- 06/10/2004(INICIO)

    --Caso n?seja encontrado um item para ser excluido pela devolu? ou pela exclusao. Caso isso acontre?a

    --sera registrado no LOG_FALHA_IMPORTACAO. Caso a conta esteja gravada no consumo, a rotina achou a conta,

    --caso contrario n?achou o item porque a conta estava vazia.

    Conta_Sem_Item EXCEPTION;

    --PDA 100545 (FIM)

    v_Proced c_Proced%ROWTYPE;

    v_ProcedNew c_Proced%ROWTYPE; -- OP 46123

    v_Mvto   c_Mvto%ROWTYPE;

    v_Fator  c_Fator%ROWTYPE;

    --PDA 157595(INICIO) 14/04/2008 - Jansen Gallindo

    --v_conta                   dbamv.pack_lanca_ffcv.c_conta%ROWTYPE;

    v_Conta Dbamv.Pkg_Ffcv_Conta.Tpconta;

    --v_contaambu               dbamv.pack_lanca_ffcv.c_contaambu%ROWTYPE;

    v_Contaambu Dbamv.Pkg_Ffcv_Conta.Tpcontaambu;

    --v_ambupart                dbamv.pack_lanca_ffcv.c_contapartambu%ROWTYPE;

    --v_contapart               dbamv.pack_lanca_ffcv.c_contapart%ROWTYPE;

    --PDA 157595(FIM) 14/04/2008 - Jansen Gallindo

    v_Grfat       c_Grfat%ROWTYPE;

    v_Itregfat    Dbamv.Pack_Lanca_Ffcv.c_Itregfat%ROWTYPE;

    v_Itregfat_Dt Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt%ROWTYPE;

    v_Itregamb    Dbamv.Pack_Lanca_Ffcv.c_Itregamb%ROWTYPE;

    -- pda 96511 - 23/06/2004 - Amalia Ara??

    Vcgabaritohosp   Dbamv.Pack_Lanca_Ffcv.Cgabaritohosp%ROWTYPE;

    Vcitgabaritohosp Dbamv.Pack_Lanca_Ffcv.Citgabaritohosp%ROWTYPE;

    Vcquantgabarito  Dbamv.Pack_Lanca_Ffcv.Cquantgabarito%ROWTYPE;

    -- pda 96511 - fim

    v_Particular      c_Config_Particular%ROWTYPE;

    Qtdsetor          NUMBER;

    Ncdsetorlanca     NUMBER;

    Nqtprofat         Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Noldqtprofat      Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Ncdlcto           Dbamv.Itreg_Fat.Cd_Lancamento%TYPE /*NUMBER PDA 254997*/

    ;

    Nqtlcto           Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Csnpacote         VARCHAR2(1);

    Binsert           BOOLEAN;

    Ctpproibicao      VARCHAR2(2);

    Nqtautorizado     NUMBER;

    Ncdguia           NUMBER;

    Bpartic           BOOLEAN := FALSE;

    Ncdregfat         Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*NUMBER PDA 254997*/

    ;

    Ndiferenca        NUMBER;

    Nqtregrateio      NUMBER;

    Csnimportar       VARCHAR2(1);

    Ncdlfa            NUMBER;

    Ncdregamb         Dbamv.Reg_Amb.Cd_Reg_Amb%TYPE /*NUMBER PDA 254997*/

    ;

    Updating          BOOLEAN := FALSE;

    Deleting          BOOLEAN := FALSE;

    Inserting         BOOLEAN := FALSE;

    Cgravaatend       VARCHAR2(1);

    Ctpimport         VARCHAR2(1);

    Ddtreferencia     DATE;

    Ncdconvconta      NUMBER;

    Ncdplanconta      Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*NUMBER PDA 254997*/

    ;

    Vtp_Controle_Lote VARCHAR2(1);

    -- PDA 170696 (Inicio) - Henrique Antunes - 23/11/2006

    Csndevolverkit VARCHAR2(1);

    Ncdpadrao      NUMBER;

    Ncdcontakit    NUMBER;

    -- PDA 170696 (Fim)

    Nvlpercconsig           NUMBER := 0;

    Nvlunitconsig           NUMBER := 0;

	nVlTaxaConsig           number := 0;    -- OP 36996

    Nprodconsignado         NUMBER := 0;

    Ncdfornecedor           NUMBER;

    Nqtdregpercconsig       NUMBER := 0;

    Nqtpart                 Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Nqtconv                 Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    p_Conv                  NUMBER;

    Nqtlivre                NUMBER;

    v_Qtdexistente_Amb      NUMBER;

    v_Qtdexistente_Fat      NUMBER;

    v_Qtdexistente_Amb_Part NUMBER;

    v_Qtdexistente_Fat_Part NUMBER;

    Totallancado            NUMBER := 0;

    Totallancado_Part       NUMBER := 0;

    Limite                  NUMBER := 0;

    Nqtaux                  Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    := 0;

    Vtpimportacao           VARCHAR2(15) := 'Produto';

    -- PDA 208386 (In?o) 01/12/2007 FL?IO LAGO

    --cprodorteseprotese        VARCHAR2 (08);

    Cprodorteseprotese c_Orteseprotese%ROWTYPE;

    -- PDA 208386 (fim)

    Vsnconsignadonf     VARCHAR2(01);

    Vsnchecapreconolcto VARCHAR2(01);

    Bexistepreco        BOOLEAN := TRUE;

    Cmensret            VARCHAR2(2000);

    Pcd_Mvto            NUMBER;

    Vfim                NUMBER;

    Nqtdevolvido        NUMBER;

    -- PDA 96161 -- Alexandre Erik C. M. Costa 25/05/2004

    -- Declara? de variaveis

    Vsnguiaprocauto VARCHAR2(1);

    Nqtdguia        NUMBER;

    Ndtlancamento   DATE; --PDA 173136 -- Jansen Gallindo

    Nguiapendente   Dbamv.Guia.Cd_Guia%TYPE; -- pda 145435 - Jose Roberto

    Ncdguiaitem     Dbamv.Guia.Cd_Guia%TYPE; /* pda 141006 */

    -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

    Ncdconta  Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE;

    Ncdpacote Dbamv.Conta_Pacote.Cd_Conta_Pacote%TYPE;

    Csnguia   VARCHAR2(1) := 'N';

    -- PDA 157145 (Fim)

    Vauxprofat           Dbamv.Regra_Substituicao_Proced.Cd_Pro_Fat%TYPE; -- PDA 175061

    Vcsnfaturadireta     Csnfaturadireta%ROWTYPE; -- PDA 162402 - 20/03/2007 - Pedro Neiva (Apply)

    Bflag                BOOLEAN := TRUE; -- PDA 162402 - 20/03/2007 - Pedro Neiva (Apply)

    Vsndevolucaofatsolic Dbamv.Configuracao.Valor%TYPE; -- PDA 180890

    Vaction              VARCHAR2(1); -- PDA 180890

    Vorigem              VARCHAR2(1); -- PDA 180890

    -- PDA 162402 (Inicio) - Henrique Antunes - 04/05/2007

    Pnaviso VARCHAR2(7);

    -- PDA 162402 (Fim)

    Vmsgauditinloc          VARCHAR2(100); --PDA 143076 29/10/2007 Jansen Gallindo

    Vsnlancmgesdtvalidpresc VARCHAR2(1); /*PDA 202951 - 03/07/2009 - Jansen Gallindo*/

    Vdtpresc                Cdtpresc%ROWTYPE; /*PDA 202951 - 03/07/2009 - Jansen Gallindo*/

    /*vcVerificaItemConta       cVerificaItemConta%rowtype;*/ /*PDA.: 289129 - 14/08/2009 - Emanoel Deivison */ /* pda 330455 */

    /*pda 307025 - Thiago Miranda de Oliveira - criando variavel que ira quardar a quantidade real do item nas contas*/

    Nqtllanc NUMBER;

    /*fim pda 307025*/

    Vmgescontafechada VARCHAR2(01); -- Pda 519340

    Vmgessnfechada    VARCHAR2(01); -- Pda 519340

    Ndivisor          NUMBER; -- pda 545312

    Nqtexcedeu        NUMBER := NULL; -- OP 387

    Vtpcontapart      Dbamv.Itreg_Fat.Tp_Mvto%TYPE := NULL; -- OP 387

    Nconta            NUMBER := NULL; -- OP 387

    Nlanc             NUMBER := NULL; -- OP 387

    vsnregrconsig     VARCHAR2(01) := NULL;   -- OP 34293



  vpCdLogRastro       Number ;     -- OP 35103

  vSnRastreabilidade  varchar2(1); -- OP 35103

  nCdItGuia              NUMBER;   -- OP 35103

  vTemRegraCriaContaAuto BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

  vSnCriouContaAuto      BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

  vSnCriouContaAutoAmb   BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

  vRegraCriaContaAuto    Dbamv.Pkg_Ffcv_Conta.TpContaAutomatica; /*OP 35916 - regra para cria? autom?ca de conta*/

  v_ContaCargoPac        Dbamv.Pkg_Ffcv_Conta.Tpconta;     /*ALLS OP 42241 */

  v_ContaCargoPacAmbu    Dbamv.Pkg_Ffcv_Conta.Tpcontaambu; /*ALLS OP 42241 */

  vRegraCriaContaAutoCP  Dbamv.Pkg_Ffcv_Conta.TpContaAutomaticaCP; /*ALLS OP 42241* - regra para cria? autom?ca de conta referente a Cargo Paciente*/

  vSnCargoPaciente       Dbamv.Pack_Lanca_Ffcv.cSnCargoPaciente%ROWTYPE; /*ALLS OP 42241*/

  vSnCriouContaAutoCP    BOOLEAN := FALSE; /*ALLS OP 42241 */

  vSnCriouContaAutoAmbCP BOOLEAN := FALSE; /*ALLS OP 42241 */

  NcdlctoCp              NUMBER  ; /*ALLS OP 42241 */

  NcdlctoAmbCp           NUMBER  ; /*ALLS OP 42241 */

  pEmpresa               NUMBER := Pkg_Mv2000.Le_Empresa;/*43289*/

  pvSnJaExcedeuQtd      Varchar2(1):= 'N'; /*43289*/

  pvMensagem             VARCHAR2(2000);    /*43289*/

  pSnChamadoDaTela       VARCHAR2(1) := 'N';       /*43289*/

  nRegraSubstituicao     NUMBER := null;      /*OP 44895*/



	--  OP 32555 -  planserv

	 CURSOR cRgraSubstituMesmoProfat( Pncdempresa NUMBER, Pncdsetor NUMBER, Pvprofat VARCHAR2, Pddtvigencia DATE, PcdConvenio NUMBER,
                                       Pvtpatend VARCHAR, pnPlano NUMBER, pnRegra NUMBER )   IS
       SELECT Regra_Substituicao_Proced.Cd_Pro_Fat
           FROM Dbamv.Regra_Substituicao_Proced
          WHERE Regra_Substituicao_Proced.Cd_Multi_Empresa = Pncdempresa
             AND (Regra_Substituicao_Proced.Cd_Setor = Pncdsetor OR Regra_Substituicao_Proced.cd_setor IS NULL) --FATURCONV-5478 OR Regra_Substituicao_Proced.cd_setor IS NULL
            AND Regra_Substituicao_Proced.Cd_Pro_Fat_Substituto = Pvprofat
            AND Regra_Substituicao_Proced.Cd_Pro_Fat = Pvprofat
            AND Regra_Substituicao_Proced.Dt_Vigencia <= Pddtvigencia
            AND Regra_Substituicao_Proced.Tp_Atendimento IN (Pvtpatend, 'T')
    		     AND (Regra_Substituicao_Proced.cd_convenio = PcdConvenio OR Regra_Substituicao_Proced.cd_convenio IS NULL)
   		     AND (Regra_Substituicao_Proced.cd_con_pla = pnPlano OR Regra_Substituicao_Proced.cd_con_pla IS NULL)       /* OP 44895 */
   		     AND (Regra_Substituicao_Proced.cd_regra = pnRegra OR Regra_Substituicao_Proced.cd_regra IS NULL)           /* OP 44895 */
            ORDER BY cd_convenio, cd_con_pla, cd_regra ;                                                               /* OP 44895 */
                                           /* OP 44895 */

       SnRgraSubstituMesmoProfat VARCHAR2(8);

	   --  OP 32555 -  planserv



    -- OP 34293 - 20/11/2015 - Se estiver configurado para valorizar pela tab_fat, e o npreco_unitario_opme for zero, n?inserir itboc_pre.

    CURSOR cIncideTab is

      SELECT sn_incid_regr_conv_prod_consig

        FROM dbamv.config_ffcv

       WHERE cd_multi_empresa = dbamv.pkg_mv2000.le_empresa;



    /*OP 44895*/

    CURSOR cRregra(pConvenio IN NUMBER ,

                   pPlano IN NUMBER) IS

      SELECT p.cd_regra

        FROM dbamv.empresa_con_pla p,

             dbamv.empresa_convenio c

       WHERE p.cd_convenio = c.cd_convenio

         AND p.cd_con_pla  = pPlano

         AND c.cd_convenio = pConvenio

         AND c.cd_multi_empresa = DBAMV.PKG_MV2000.LE_EMPRESA;

    vcRregra   cRregra%ROWTYPE;



  BEGIN

     -- OP 39244

    DBAMV.PKG_FFCV_RASTREABILIDADE.PRC_EXISTE_ROTINA_RASTRO('LANCAMENTO_AUTOMATICO (MGES)',

                                                            'PROCEDURE DE LANCAMENTO AUTOMATICO (MGES)'); /*verifica se a rotina ja existe, caso n? cadastra.*/

    VSNRASTREABILIDADE := DBAMV.PKG_FFCV_RASTREABILIDADE.FNC_SN_ATIVO_RASTO('LANCAMENTO_AUTOMATICO (MGES)'); /*verifica se a rotina esta ativa para gerar log de rastreabilidade*/

    /*#################################LOG_RASTREABILIDADE################################*/

    IF Vsnrastreabilidade = 'S' THEN



      DBAMV.PKG_FFCV_RASTREABILIDADE.PRC_GRAVA_RASTREABILIDADE(PROTINA      => 'LANCAMENTO_AUTOMATICO (MGES)',

                                                               PEMPRESA     => dbamv.pkg_mv2000.le_empresa,

                                                               PDSCONFIG    => ' # Ncdproduto = ' ||

                                                                               Ncdproduto ||

                                                                               ' # Ncdmvtoestoque = ' ||

                                                                               Ncdmvtoestoque ||

                                                                               ' # Ncdunipro = ' ||

                                                                               Ncdunipro ||

                                                                               ' # Nqtmovnew = ' ||

                                                                               Nqtmovnew ||

                                                                               ' # Nqtmovold = ' ||

                                                                               Nqtmovold ||

                                                                               ' # Caction = ' ||

                                                                               Caction ||

                                                                               ' # Csnitempertencepacote = ' ||

                                                                               Csnitempertencepacote ||

                                                                               ' # Ncditemmvto = ' ||

                                                                               Ncditemmvto ||

                                                                               ' # Ncdfornec = ' ||

                                                                               Ncdfornec ||

                                                                               ' # Ncdformula = ' ||

                                                                               Ncdformula ||

                                                                               ' # Nqtformula = ' ||

                                                                               Nqtformula || ' #',

                                                               PCDLOGRASTRO => Vpcdlograstro);

      dbamv.Pkg_Ffcv_Rastreabilidade.Prc_Grava_It_Rastreabilidade(Pcdlograstro    => Vpcdlograstro,

                                                                  Pcdpasso        => 'PPASSO1',

                                                                  Patend          => Ncdmvtoestoque,

                                                                  Pdsparametros   => ' # Ncdproduto = ' ||

                                                                                     Ncdproduto ||

                                                                                     ' # Ncdmvtoestoque = ' ||

                                                                                     Ncdmvtoestoque ||

                                                                                     ' # Ncdunipro = ' ||

                                                                                     Ncdunipro ||

                                                                                     ' # Nqtmovnew = ' ||

                                                                                     Nqtmovnew ||

                                                                                     ' # Nqtmovold = ' ||

                                                                                     Nqtmovold ||

                                                                                     ' # Caction = ' ||

                                                                                     Caction ||

                                                                                     ' # Csnitempertencepacote = ' ||

                                                                                     Csnitempertencepacote ||

                                                                                     ' # Ncditemmvto = ' ||

                                                                                     Ncditemmvto ||

                                                                                     ' # Ncdfornec = ' ||

                                                                                     Ncdfornec ||

                                                                                     ' # Ncdformula = ' ||

                                                                                     Ncdformula ||

                                                                                     ' # Nqtformula = ' ||

                                                                                     Nqtformula || ' #',

                                                                  Pdspasso        => 'verifica? do lan?ento',

                                                                  Pdspassotecnico => 'Inicio da Pack_lanca_ffcv.lanca_mges_ffcv.',

                                                                  Pdssolucao      => NULL,

                                                                  Psnsucesso      => 'S',

                                                                  Ptpinfopasso    => 'I', /*(I - informa? , A = ALerta , E = Erro)*/

                                                                  Preserva        => NULL);

    END IF;

   -- OP 39244



    -- Pda 200497 06/09/2007

    OPEN Chospital;

    FETCH Chospital

      INTO Vcdhospital;

    CLOSE Chospital;

    -- Pda 200497 06/09/2007

    Ncdregfat := NULL;

    Ncdregamb := NULL;

    --

    -- PDA 175557(inicio) - 22/01/2009 - Jansen Gallindo

    -- PDA 180890 (Inicio) - Tratamento do parametro caction.

    /*if length(caction) = 3 then

      --

      vOrigem := substr(caction,3,1);

      --

    end if;*/

    --

    IF Ptp_Execucao IS NOT NULL THEN

      Vorigem := Ptp_Execucao;

    END IF;

    -- PDA 175557(fim) - 22/01/2009 - Jansen Gallindo

    Vaction := Substr(Caction, 1, 1);

    --

    IF Vaction = 'I' THEN

      Inserting := TRUE;

    ELSIF Vaction = 'U' THEN

      Updating := TRUE;

    ELSIF Vaction = 'D' THEN

      Deleting := TRUE;

    END IF;

    -- PDA 180890 (Fim)



    -- OP 34293 - 20/11/2015 - Se estiver configurado para valorizar pela tab_fat, e o npreco_unitario_opme for zero, n?inserir itboc_pre.

    OPEN  cIncideTab;

    FETCH cIncideTab INTO vsnregrconsig;

    CLOSE cIncideTab;



    --PDA 353315(In?o)

    --Verifica valor do indice para o convenio IPE para clinica.

    OPEN Cindiceipeclinica;

    FETCH Cindiceipeclinica

      INTO Rindiceipeclinica;

    CLOSE Cindiceipeclinica;

    --PDA 353315(Fim)

    OPEN c_Importar;

    FETCH c_Importar

      INTO Csnimportar, Ctpimport, Vtp_Controle_Lote, Vsnconsignadonf, Vsnchecapreconolcto

    -- PDA 170696 (Inicio) - Henrique Antunes - 23/11/2006

    , Csndevolverkit

    -- PDA 170696 (Fim)

    , Vsnguiaprocauto /* pda 141006 */

    , Vsnlancmgesdtvalidpresc /*PDA 202951 - 03/07/2009 - Jansen Gallindo*/

    , Vmgescontafechada /* Pda 519340 */

    ;

    CLOSE c_Importar;

    IF Nvl(Csnimportar, 'S') <> 'N' AND Ctpimport = 'P' THEN

      -- PDA 175557(inicio) - 22/01/2009 - Jansen Gallindo

      -- PDA 180890 -- Alexandre erik -- 23/03/2007 -- (Inicio)

      /*open cconfigGlobal;

      fetch cconfigGlobal into vSnDevolucaoFatSolic;

      close cconfigGlobal;*/

      OPEN Csnestornosolicdev;

      FETCH Csnestornosolicdev

        INTO Vsnest;

      CLOSE Csnestornosolicdev;

      --

      --PDA 353315(In?o)

      Rexamerelacionado.Cd_Reg_Amb_Rel    := NULL;

      Rexamerelacionado.Cd_Lancamento_Rel := NULL;

      --PDA 353315(fim)

      -- PDA 180890 (Inicio) - Buscar dados da Solicita? quando estiver configurado para devolu? pela Solicita? e a origem foi a Solicita?.

      --if nvl(vSnDevolucaoFatSolic, 'N') = 'S' and

      IF Nvl(Vsnest.Sn_Estorno_Solic_Devol, 'N') = 'S' AND

        -- PDA 175557(fim) - 22/01/2009 - Jansen Gallindo

         Nvl(Vorigem, 'N') = 'C' THEN

        --

        OPEN c_Mvto_Sol;

        FETCH c_Mvto_Sol

          INTO v_Mvto;

        CLOSE c_Mvto_Sol;

        --

      ELSE

        --

        OPEN c_Mvto;

        FETCH c_Mvto

          INTO v_Mvto;

        CLOSE c_Mvto;

        --

        --PDA 353315(In?o)

        IF Rindiceipeclinica.Existe IS NOT NULL AND

           v_Mvto.Cd_Itped_Rx IS NOT NULL THEN

          OPEN Cexamerelacionado(Ncdmvtoestoque, v_Mvto.Cd_Itped_Rx);

          FETCH Cexamerelacionado

            INTO Rexamerelacionado;

          CLOSE Cexamerelacionado;

        END IF;

        --PDA 353315(fim)

      END IF;

      -- PDA 180890 (Fim)

      --

      OPEN c_Proced;

      FETCH c_Proced

        INTO v_Proced;

      CLOSE c_Proced;



      /*OP 44895*/

      vcRregra := NULL;

      OPEN  cRregra( v_mvto.cd_convenio, v_mvto.cd_con_pla );

      FETCH cRregra INTO vcRregra;

      CLOSE cRregra;



      -- PDA 174061 02/03/2007 - Anderson Marcel - Apply

      Vauxprofat          := v_Proced.Cd_Pro_Fat;

	    vProFatAnterior     := v_Proced.Cd_Pro_Fat;   -- OP 33697 *2

      nRegraSubstituicao  := NULL;      /*OP 44895*/

      v_Proced.Cd_Pro_Fat := Fnc_Substituicao_Procedimento(Pkg_Mv2000.Le_Empresa,

                                                           v_Mvto.Cd_Setor,

                                                           v_Proced.Cd_Pro_Fat,

                                                           v_Mvto.Dt_Mvto_Estoque,

                                                           v_Mvto.Tp_Atendimento,

                                                           'S',

                                                           v_Mvto.Cd_Convenio,  /*OP 28803*/

                                                           nRegraSubstituicao,  /*OP 44895*/

                                                           v_mvto.cd_con_pla,   /*OP 44895*/

                                                           vcRregra.cd_regra    /*OP 44895*/

                                                           );

      -- PDA 174061 Fim

		if dbamv.fnc_ffcv_proibicao_idade( v_mvto.cd_atendimento, v_mvto.cd_convenio, v_mvto.cd_con_pla, v_proced.cd_pro_fat ) <> 'OK' then

		  raise proc_proibido_idade;

		end if;

		-- OP 32555 - fim



	  -- OP 33697 *2 - 08/10/2015 - Buscando as demais informa?s do produto, caso o procedimento tenha sido substituido pela Regra de substitui?.

	  --    e necess?o porque mais abaixo faz busca do grupo de faturamento pela classe, Esp?e e setor.

	  if v_Proced.Cd_Pro_Fat <> vProFatAnterior then

         --v_ProcedNew := NULL;      ----- ALTERADO CHAMADO HSC C2012/0244 / SUP-248196 07-01-2021
         --open  cProcedProFat( v_Proced.Cd_Pro_Fat );
		 --fetch cProcedProFat into v_ProcedNew;
		 --close cProcedProFat;

      IF v_ProcedNew.cd_pro_fat IS NOT NULL THEN   -- OP 46123 ini

        v_Proced.Cd_Classe := v_ProcedNew.Cd_Classe;

        v_Proced.Cd_Especie := v_ProcedNew.Cd_Especie;

        v_Proced.Vl_Fator_Pro_Fat := v_ProcedNew.Vl_Fator_Pro_Fat;

        v_Proced.Sn_Consignado := v_ProcedNew.Sn_Consignado;

        v_Proced.Sn_Opme := v_ProcedNew.Sn_Opme;

      END IF;                             -- OP 46123 fim

	  end if;

	  -- OP 33697 - fim



      Ctpproibicao := NULL; -- pda 541128 - limpar antes de verificar novo registro



/* OP 38292 (Inicio)

      OPEN Dbamv.Pack_Lanca_Ffcv.c_Proibicao(v_Proced.Cd_Pro_Fat,

                                             v_Mvto.Cd_Convenio,

                                             v_Mvto.Cd_Con_Pla,

                                             v_Mvto.Tp_Atendimento,

                                             v_Mvto.Dt_Mvto_Estoque,

                                             v_Mvto.Cd_Setor);

      FETCH Dbamv.Pack_Lanca_Ffcv.c_Proibicao

        INTO Ctpproibicao;

      CLOSE Dbamv.Pack_Lanca_Ffcv.c_Proibicao;*/



      Ctpproibicao := dbamv.pack_ffcv_proibicao.fnc_ffcv_proibicao(v_Proced.Cd_Pro_Fat,

                                               v_Mvto.Cd_Convenio,

                                               v_Mvto.Cd_Con_Pla,

                                               v_Mvto.Tp_Atendimento,

                                               v_Mvto.Dt_Mvto_Estoque,

                                               v_Mvto.Cd_Setor,

                                               v_mvto.cd_atendimento,

                                               NULL); /* OP 38292 (Fim) */



      IF Ctpproibicao = 'FC' THEN

        RAISE Fora_Da_Conta;

      END IF;

      --PDA 175957 (In?o) 16/03/2007 - Pedro Neiva(Apply)

      Vsnchecapreconolcto := Dbamv.Fnc_Ffcv_Verifica_Preco_Lcto(v_Mvto.Tp_Atendimento);

      IF Nvl(Vsnchecapreconolcto, 'N') = 'S' AND NOT Deleting THEN

        -- pda 118991 (colocada 2 condi? p/ n?verificar prego ao excluir)

        -- IF NVL (vsnchecapreconolcto, 'N') = 'S' AND NOT DELETING THEN -- pda 118991 (colocada 2 condi? p/ n?verificar prego ao excluir)

        --PDA 175957 (Fim) 16/03/2007 - Pedro Neiva(Apply)

        Bexistepreco := Dbamv.Val_Proc_Ffcv_Resumido(v_Proced.Cd_Pro_Fat ||

                                                     v_Mvto.Cd_Setor -- PDA 194962 - Pedro Neiva - 23/08/2007

                                                    ,

                                                     v_Mvto.Dt_Mvto_Estoque,

                                                     v_Mvto.Hr_Mvto_Estoque,

                                                     v_Mvto.Cd_Convenio,

                                                     v_Mvto.Cd_Con_Pla,

                                                     v_Mvto.Tp_Atendimento,

                                                     v_Mvto.Cd_Tip_Acom,

                                                     Cmensret,

                                                     'Produto',

                                                     Ncdproduto);

        IF Bexistepreco = FALSE THEN

          Raise_Application_Error(-20050, Cmensret);

        END IF;

      END IF;

      OPEN c_Config_Particular;

      FETCH c_Config_Particular

        INTO v_Particular;

      CLOSE c_Config_Particular;

      IF v_Proced.Cd_Pro_Fat IS NULL THEN

        RAISE Prod_Nao_Conf;

      END IF;

      IF Nvl(Csnitempertencepacote, 'S') = 'N' THEN

        --  um kit

        Vtpimportacao := 'Produto-Kit';

      END IF;

      IF v_Mvto.Tp_Atendimento IN ('A', 'E', 'U') AND

         v_Mvto.Sn_Importa_Auto = 'S' THEN

        -- PDA 138061 (Inicio) - Henrique Antunes - 26/11/2005

        IF v_Mvto.Tp_Mvto_Estoque = 'C' THEN

          RAISE Devolucao_Sem_Conta;

        END IF;

        -- PDA 138061 (Fim)

        Raise_Application_Error(-20040

                                --MULTI-IDIOMA: Utiliza? do pkg_rmi_traducao.extrair_msg para mensagens (MSG_1)

                               ,

                                Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_1',

                                                                  'PACK_LANCA_FFCV',

                                                                  'A Conta deste atendimento est?loqueada! A movimenta? da mesma dever?er lan?a para o atendimento de interna? %s',

                                                                  Arg_List(v_Mvto.Cd_Atendimento_Pai)));

      END IF;

      OPEN c_Setorcount;

      FETCH c_Setorcount

        INTO Qtdsetor;

      CLOSE c_Setorcount;

      OPEN c_Setor(v_Mvto.Cd_Setor);

      FETCH c_Setor

        INTO Ncdsetorlanca;

      CLOSE c_Setor;

      IF Nvl(Qtdsetor, 0) = 0 OR Ncdsetorlanca IS NOT NULL THEN

        IF (v_Mvto.Tp_Mvto_Estoque IN ('P', 'C')) AND

           (v_Mvto.Tp_Atendimento <> 'S') AND

           ((v_Mvto.Tp_Atendimento IN ('H', 'I') AND

           Nvl(Csnimportar, 'S') IN ('H', 'S')) OR

           (v_Mvto.Tp_Atendimento IN ('A', 'E', 'U') AND

           Nvl(Csnimportar, 'S') IN ('A', 'S'))) THEN

          Cgravaatend := v_Mvto.Tp_Atendimento;

          IF v_Mvto.Tp_Mvto_Estoque = 'P' OR

             v_Mvto.Tp_Atendimento IN ('A', 'E', 'U') OR

             v_Mvto.Dt_Alta IS NULL THEN

            --pda 211463(In?o) - Pedro Neiva - 03/01/2007

            --ddtreferencia := v_mvto.data_estoque; --.dt_mvto_estoque;

            Ddtreferencia := Nvl(v_Mvto.Dt_Faturamento, v_Mvto.Data_Estoque); --.dt_mvto_estoque;

            --pda 211463(fim)

            IF v_Mvto.Tp_Atendimento IN ('A', 'E', 'U') THEN

              -- Ambulatorial

              Ddtreferencia := v_Mvto.Data_Atendimento;

            END IF;

          ELSE

            IF v_Mvto.Dt_Mvto_Estoque < v_Mvto.Data_Alta THEN

              --pda 211463(In?o) - Pedro Neiva - 03/01/2007

              --ddtreferencia := v_mvto.data_estoque; --.dt_mvto_estoque;

              Ddtreferencia := Nvl(v_Mvto.Dt_Faturamento,

                                   v_Mvto.Data_Estoque); --.dt_mvto_estoque;

              --pda 211463(fim)

            ELSE

              Ddtreferencia := v_Mvto.Data_Alta; --dt_alta;

            END IF;

          END IF;

          /*PDA 202951(Inicio) - 03/07/2009 - Jansen Gallindo */

          IF Vsnlancmgesdtvalidpresc = 'S' THEN

            OPEN Cdtpresc(Ncdmvtoestoque);

            FETCH Cdtpresc

              INTO Vdtpresc;

            IF Cdtpresc%FOUND THEN

              Ddtreferencia := To_Date(To_Char(Vdtpresc.Dt_Inicio_Validade,

                                               'dd/mm/yyyy') ||

                                       To_Char(Vdtpresc.Hr_Inicio_Validade,

                                               'hh24:mi'),

                                       'dd/mm/yyyy hh24:mi');

            END IF;

          END IF;

          /*PDA 202951(fim) - 03/07/2009 - Jansen Gallindo */

          -- PDA 229502 (In?o) - 19/05/2008 - Diego Costa

          -- Compara a data de refer?ia com a data de atendimento, se a data de refer?ia for menor,

          -- entao utiliza a data de atendimento, para evitar item lan?os fora da conta.

          IF Ddtreferencia < v_Mvto.Data_Atendimento THEN

            Ddtreferencia := v_Mvto.Data_Atendimento;

          END IF;

          -- PDA 229502 (Fim)

          -- PDA 229502 (In?o) - 04/06/2008 - Henrique Antunes

          IF Ddtreferencia > v_Mvto.Data_Alta THEN

            Ddtreferencia := v_Mvto.Data_Alta;

          END IF;

          -- PDA 229502 (Fim)

          -- pda 90527 inicio

          --       if nvl(V_Mvto.tp_convenio_da_cirurgia, 'C') = 'C' then

          IF Nvl(v_Mvto.Tp_Convenio_Da_Cirurgia, 'C') = 'C' OR

             (Nvl(v_Mvto.Tp_Convenio_Da_Cirurgia, 'C') = 'P' AND

              v_Mvto.Tp_Convenio = 'P') THEN

            -- pda 90527 fim

            IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

              --PDA 157595(INICIO) 14/04/2008 - Jansen Gallindo

              /*OPEN dbamv.pack_lanca_ffcv.c_conta (v_mvto.cd_atendimento

                                                 ,ddtreferencia

                                                 ,NULL

                                                 ,v_mvto.cd_atendimento_pai

                                                 );

              FETCH dbamv.pack_lanca_ffcv.c_conta INTO v_conta;

              CLOSE dbamv.pack_lanca_ffcv.c_conta;*/



              vTemRegraCriaContaAuto  := Dbamv.Pkg_Ffcv_Conta.FNC_TEM_REG_CRIA_CONTA_AUTO;

              IF (vTemRegraCriaContaAuto) THEN



                      /*ALLS OP 42241*/

                      OPEN dbamv.pack_lanca_ffcv.cSnCargoPaciente(v_Mvto.Cd_Atendimento);

                      FETCH dbamv.pack_lanca_ffcv.cSnCargoPaciente INTO vSnCargoPaciente;

					            CLOSE dbamv.pack_lanca_ffcv.cSnCargoPaciente;



					            IF Nvl(vSnCargoPaciente.sn_carga_familiar,'N') = 'S' THEN



                          vRegraCriaContaAutoCP := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTCP(v_Mvto.Cd_Atendimento,

                                                                                                       v_Proced.Cd_Pro_Fat,

                                                                                                       Ddtreferencia); --FATURCONV-1383 - AMBS



                          IF (vRegraCriaContaAutoCP(1).cd_regra_cria_conta IS NOT NULL ) THEN



                              v_ContaCargoPac :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_HOSP_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                                  null,

                                                                                                  v_Mvto.Cd_Atendimento,

                                                                                                  v_Mvto.Cd_Atendimento_Pai,

                                                                                                  vRegraCriaContaAutoCP(1).cd_convenio_destino,

                                                                                                  vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                                                                                                  Ddtreferencia,

                                                                                                  vRegraCriaContaAutoCP(1).cd_tipo_arq_cta_envio,

                                                                                                  vRegraCriaContaAutoCP(1).cd_desconto_inst); /*ALLS OP 35921*/

                              vSnCriouContaAutoCP := TRUE;

                          END IF;

                      /*fim ALLS OP 42241*/

                      ELSE



                          vRegraCriaContaAuto := Dbamv.Pkg_Ffcv_Conta.FNC_VERIFIC_REG_CRIA_CONTA_AUT(v_Mvto.Cd_Atendimento,

                                                                                                     v_Proced.Cd_Pro_Fat,

                                                                                                     Ddtreferencia); --FATURCONV-1383 - AMBS



                          IF (vRegraCriaContaAuto(1).cd_regra_cria_conta IS NOT NULL ) THEN



                              v_Conta :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_HOSP_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                          null,

                                                                                          v_Mvto.Cd_Atendimento,

                                                                                          v_Mvto.Cd_Atendimento_Pai,

                                                                                          vRegraCriaContaAuto(1).cd_convenio_destino,

                                                                                          vRegraCriaContaAuto(1).cd_con_pla_destino,

                                                                                          Ddtreferencia,

                                                                                          vRegraCriaContaAuto(1).cd_tipo_arq_cta_envio,

                                                                                          vRegraCriaContaAuto(1).cd_desconto_inst); /*ALLS OP 35921*/

                              vSnCriouContaAuto := TRUE;

                          END IF;



                      END IF;



              END IF;



              IF (NOT vSnCriouContaAuto) THEN

                  /*OP 35916 - regra para cria? autom?ca de conta*/

                  v_Conta := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Conta(v_Mvto.Cd_Atendimento,

                                                                Ddtreferencia,

                                                                NULL,

                                                                v_Mvto.Cd_Atendimento_Pai);

              END IF;/*OP 35916*/



              --IF v_conta.cd_reg_fat IS NULL THEN

              IF v_Conta(1).Cd_Reg_Fat IS NULL THEN

                --PDA 157595(FIM) 14/04/2008 - Jansen Gallindo

                /* Pda 519340 - n?Continuar Se Estiver Deletando, Se A Conta Estiver Fechada E A Configura? Proibir */

                IF Vaction = 'D' AND

                   Dbamv.Pkg_Mv2000.Le_Formulario = 'M_CONSIGNADO_ENT' THEN

                  IF Deleting AND v_Mvto.Tp_Mvto_Estoque = 'P' AND

                     Vmgescontafechada = 'P' THEN

                    OPEN Ccontafechada(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                           v_Mvto.Cd_Atendimento),

                                       Ncdmvtoestoque);

                    FETCH Ccontafechada

                      INTO Vmgessnfechada;

                    CLOSE Ccontafechada;

                    IF Nvl(Vmgessnfechada, 'N') = 'S' THEN

                      --MULTI-IDIOMA: Utiliza? do pkg_rmi_traducao.extrair_msg para mensagens (MSG_3)

                      Raise_Application_Error(-20040,

                                              Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_3',

                                                                                'PACK_LANCA_FFCV',

                                                                                'N??oss?l excluir movimenta?, pois a Conta no Faturamento j?e encontra Fechada!'));

                    END IF;

                  END IF;

                END IF;

                /* Pda 519340 - Fim */

                IF v_Mvto.Cd_Convenio_Secundario IS NOT NULL THEN

                  Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Verifica_Conta_Secundaria(v_Mvto.Cd_Atendimento,

                                                                                  Ddtreferencia,

                                                                                  v_Mvto.Cd_Convenio_Secundario,

                                                                                  v_Mvto.Cd_Atendimento_Pai);

                  Ncdconvconta := v_Mvto.Cd_Convenio_Secundario;

                  Ncdplanconta := v_Mvto.Cd_Con_Pla_Secundario;

                  IF Ncdregfat IS NULL THEN

                    -- pda 90527 inicio

                    IF v_Mvto.Tp_Mvto_Estoque = 'C' THEN

                      RAISE Devolucao_Sem_Conta;

                    ELSE

                      RAISE Atend_Sem_Conta;

                    END IF;

                    -- pda 90527 fim

                  END IF;

                ELSE

                  IF v_Mvto.Tp_Convenio = 'P' THEN

                    /* pda 310863 - Thiago Miranda de Oliveira - quando for uma devolu? do estoque e n?tiver uma conta aberta, n?deve ser

                                  criado uma nova conta e sim gerar um log na falha de imoprta? informando que n?existe conta aberta no periodo

                                  informado.

                    */

                    IF v_Mvto.Tp_Mvto_Estoque = 'C' THEN

                      RAISE Devolucao_Sem_Conta;

                    END IF;

                    /*fim pda 310863*/

                    Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento,

                                                                                 Ddtreferencia); -- pda 125871 (acrescentada a data)

                    Ncdconvconta := v_Mvto.Cd_Convenio;

                    Ncdplanconta := v_Mvto.Cd_Con_Pla;

                  ELSE

                    -- pda 90527 inicio

                    IF v_Mvto.Tp_Mvto_Estoque = 'C' THEN

                      RAISE Devolucao_Sem_Conta;

                    ELSE

                      RAISE Atend_Sem_Conta;

                    END IF;

                    -- pda 90527 fim

                  END IF;

                END IF;

              ELSE

                --PDA 157595(INICIO)

                Ncdregfat    := v_Conta(1).Cd_Reg_Fat; --ncdregfat := v_conta.cd_reg_fat;

                Ncdconvconta := v_Conta(1).Cd_Convenio; --ncdconvconta := v_conta.cd_convenio;

                Ncdplanconta := v_Conta(1).Cd_Con_Pla; --ncdplanconta := v_conta.cd_con_pla;

                --PDA 157595(FIM)

              END IF;

            ELSE

              --PDA 157595(INICIO) 15/04/2008 Jansen Gallindo

              /*IF dbamv.pack_lanca_ffcv.c_contaambu%ISOPEN THEN

                 CLOSE dbamv.pack_lanca_ffcv.c_contaambu;

              END IF;*/

              /*OPEN dbamv.pack_lanca_ffcv.c_contaambu (v_mvto.cd_atendimento

                                                     ,ddtreferencia

                                                     ,NULL

                                                     ,v_mvto.cd_atendimento_pai

                                                     );

              FETCH dbamv.pack_lanca_ffcv.c_contaambu INTO v_contaambu;

              CLOSE dbamv.pack_lanca_ffcv.c_contaambu;*/

			        /*OP 35916 - regra para cria? autom?ca de conta*/

              vTemRegraCriaContaAuto  := Dbamv.Pkg_Ffcv_Conta.FNC_TEM_REG_CRIA_CONTA_AUTO;

              IF (vTemRegraCriaContaAuto) THEN



                    /*ALLS OP 42241*/

                    OPEN dbamv.pack_lanca_ffcv.cSnCargoPaciente(v_Mvto.Cd_Atendimento);

                    FETCH dbamv.pack_lanca_ffcv.cSnCargoPaciente INTO vSnCargoPaciente;

					          CLOSE dbamv.pack_lanca_ffcv.cSnCargoPaciente;



					          IF Nvl(vSnCargoPaciente.sn_carga_familiar,'N') = 'S' THEN



                        vRegraCriaContaAutoCP := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTCP(v_Mvto.Cd_Atendimento,

                                                                                                     v_Proced.Cd_Pro_Fat,

                                                                                                     Ddtreferencia); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAutoCP(1).cd_regra_cria_conta IS NOT NULL ) THEN



                            v_ContaCargoPacAmbu :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_AMB_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                                    null,

                                                                                                    v_Mvto.Cd_Atendimento,

                                                                                                    v_Mvto.Cd_Atendimento_Pai,

                                                                                                    vRegraCriaContaAutoCP(1).cd_convenio_destino,

                                                                                                    vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                                                                                                    Ddtreferencia,

                                                                                                    vRegraCriaContaAutoCP(1).cd_tipo_arq_cta_envio,

                                                                                                    vRegraCriaContaAutoCP(1).cd_desconto_inst); /*ALLS OP 35921*/

                            vSnCriouContaAutoAmbCP := TRUE;

                        END IF;

                        /*fim ALLS OP 42241*/

                    ELSE



                        vRegraCriaContaAuto := Dbamv.Pkg_Ffcv_Conta.FNC_VERIFIC_REG_CRIA_CONTA_AUT(v_Mvto.Cd_Atendimento,

                                                                                                   v_Proced.Cd_Pro_Fat,

                                                                                                   Ddtreferencia); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAuto(1).cd_regra_cria_conta IS NOT NULL)  THEN



                            v_Contaambu :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_AMB_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                            null,

                                                                                            v_Mvto.Cd_Atendimento,

                                                                                            v_Mvto.Cd_Atendimento_Pai,

                                                                                            vRegraCriaContaAuto(1).cd_convenio_destino,

                                                                                            vRegraCriaContaAuto(1).cd_con_pla_destino,

                                                                                            Ddtreferencia,

                                                                                            vRegraCriaContaAuto(1).cd_tipo_arq_cta_envio,

                                                                                            vRegraCriaContaAuto(1).cd_desconto_inst); /*ALLS OP 35921*/

                            vSnCriouContaAutoAmb := TRUE;

                        END IF;



                    END IF;



              END IF;



              IF (NOT vSnCriouContaAutoAmb) THEN

                  /*OP 35916 - regra para cria? autom?ca de conta*/

                  v_Contaambu := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Ccontaambu(v_Mvto.Cd_Atendimento,

                                                                         Ddtreferencia,

                                                                         NULL,

                                                                         v_Mvto.Cd_Atendimento_Pai);

              END IF; /*OP 35916*/



              /* Pda 519340 - n?Continuar Se Estiver Deletando, Se A Conta Estiver Fechada E A configura? Proibir */

              IF Vaction = 'D' AND

                 Dbamv.Pkg_Mv2000.Le_Formulario = 'M_CONSIGNADO_ENT' THEN

                IF Deleting AND v_Mvto.Tp_Mvto_Estoque = 'P' AND

                   Vmgescontafechada = 'P' THEN

                  OPEN Ccontafechada(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                         v_Mvto.Cd_Atendimento),

                                     Ncdmvtoestoque);

                  FETCH Ccontafechada

                    INTO Vmgessnfechada;

                  CLOSE Ccontafechada;

                  IF Nvl(Vmgessnfechada, 'N') = 'S' THEN

                    --MULTI-IDIOMA: Utiliza? do pkg_rmi_traducao.extrair_msg para mensagens (MSG_3)

                    Raise_Application_Error(-20040,

                                            Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_3',

                                                                              'PACK_LANCA_FFCV',

                                                                              'N??oss?l excluir movimenta?, pois a Conta no Faturamento j?e encontra Fechada!'));

                  END IF;

                END IF;

              END IF;

              /* Pda 519340 - Fim */

              --IF NVL (v_contaambu.sn_fechada, 'N') = 'S' THEN

              IF Nvl(v_Contaambu(1).Sn_Fechada, 'N') = 'S' THEN

                --PDA 157595(FIM) 15/04/2008 Jansen Gallindo

                IF v_Mvto.Tp_Mvto_Estoque = 'C' THEN

                  RAISE Devolucao_Sem_Conta;

                ELSE

                  RAISE Atend_Sem_Conta;

                END IF;

              END IF;

              --IF v_contaambu.cd_reg_amb IS NULL THEN --PDA 157595

              IF v_Contaambu(1).Cd_Reg_Amb IS NULL THEN

                --PDA 157595

                IF v_Mvto.Tp_Convenio = 'P' THEN

                  Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(v_Mvto.Cd_Atendimento);

                ELSE

                  Ncdregamb := Dbamv.Pack_Ffcv.Cria_Conta_Acoplamentoambu(v_Mvto.Cd_Atendimento,

                                                                          'N');

                END IF;

                Ncdconvconta := v_Mvto.Cd_Convenio;

                Ncdplanconta := v_Mvto.Cd_Con_Pla;

              ELSE

                Ncdregamb    := v_Contaambu(1).Cd_Reg_Amb; --ncdregamb := v_contaambu.cd_reg_amb; --PDA 157595

                Ncdconvconta := v_Contaambu(1).Cd_Convenio; --ncdconvconta := v_contaambu.cd_convenio; --PDA 157595

                Ncdplanconta := v_Contaambu(1).Cd_Con_Pla; --ncdplanconta := v_contaambu.cd_con_pla; --PDA 157595

              END IF;

              IF Ncdregamb IS NULL THEN

                RAISE Atend_Sem_Conta;

              END IF;

            END IF;

          ELSE

            IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

              Ncdregfat := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento,

                                                                        Ddtreferencia); -- pda 125871(acrescentada a data)

            ELSE

              Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(v_Mvto.Cd_Atendimento);

              IF Ncdregamb IS NULL THEN

                RAISE Atend_Sem_Conta;

              END IF;

            END IF;

            Ncdconvconta := v_Particular.Cd_Convenio;

            Ncdplanconta := v_Particular.Cd_Con_Pla;

          END IF;

          -- pda 131086 inicio (verifica se tem  configura? espec?fica p/ o estoque)

          OPEN c_Grfat_Estoq(v_Proced.Cd_Classe,

                             v_Proced.Cd_Especie,

                             v_Mvto.Cd_Setor,

                             v_Mvto.Cd_Estoque,

							               v_Proced.Cd_produto,

                             v_Proced.Cd_sub_cla);

          FETCH c_Grfat_Estoq

            INTO v_Grfat;

          CLOSE c_Grfat_Estoq;

          IF v_Grfat.Cd_Gru_Fat IS NULL THEN

            -- verifica configura? geral

            OPEN c_Grfat(v_Proced.Cd_Classe,

                         v_Proced.Cd_Especie,

                         v_Mvto.Cd_Setor,

                         v_Mvto.Cd_estoque,

						             v_Proced.Cd_produto,

						             v_Proced.Cd_sub_cla);

            FETCH c_Grfat

              INTO v_Grfat;

            CLOSE c_Grfat;

            IF v_Grfat.Cd_Gru_Fat IS NULL THEN

			   -- OP 33697 *2 - Usar o grupo de faturamento do procedimento de substitui?.

	          if v_Proced.Cd_Pro_Fat <> vProFatAnterior then

			    open  cGruProSub( v_Proced.Cd_Pro_Fat );

			    fetch cGruProSub into v_Grfat;

				close cGruProSub;

			  end if;

            END IF;

          END IF;

          -- pda 131086 fim



          -- OP 34416 - 16/11/2015 - Acerto local da verifica? do Grupo de Faturamento.

  	      IF v_Grfat.Cd_Gru_Fat IS NULL THEN

             RAISE Setor_Nao_Conf;

	      end if;



          IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

            IF Ctpproibicao = 'NA' THEN

              Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento,

                                                                           Ddtreferencia); -- pda 125871(acrescentada a data)

              Ncdconvconta := v_Particular.Cd_Convenio;

              Ncdplanconta := v_Particular.Cd_Con_Pla;

              IF Ncdregfat IS NULL THEN

                RAISE Atend_Sem_Conta;

              END IF;

            END IF;

          ELSE

            IF Ctpproibicao = 'NA' THEN

              -- PDA 139897 (In?o) - Comentado o trecho abaixo para usar a fun?

              -- criacontapacpartambu.

              /*IF vtp_controle_lote = 'A' THEN

                 OPEN dbamv.pack_lanca_ffcv.c_contapartambu (v_mvto.cd_atendimento

                                                            ,ddtreferencia);

                 FETCH dbamv.pack_lanca_ffcv.c_contapartambu INTO v_ambupart;

                 CLOSE dbamv.pack_lanca_ffcv.c_contapartambu;

              ELSE

                 OPEN dbamv.pack_lanca_ffcv.c_contapartambu_loteunico (v_mvto.cd_atendimento

                                                                      ,ddtreferencia);

                 FETCH dbamv.pack_lanca_ffcv.c_contapartambu_loteunico INTO v_ambupart;

                 CLOSE dbamv.pack_lanca_ffcv.c_contapartambu_loteunico;

              END IF;



              IF v_ambupart.cd_reg_amb IS NULL THEN

                 ncdregamb :=

                    dbamv.pack_lanca_ffcv.criacontapacpartambu (v_mvto.cd_atendimento);

              ELSE

                 ncdregamb := v_ambupart.cd_reg_amb;

              END IF;*/

              Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(v_Mvto.Cd_Atendimento);

              -- PDA 139897 (Fim)

              Ncdconvconta := v_Particular.Cd_Convenio;

              Ncdplanconta := v_Particular.Cd_Con_Pla;

              IF Ncdregamb IS NULL THEN

                RAISE Atend_Sem_Conta;

              END IF;

            END IF;

          END IF;

          OPEN c_Fator;

          FETCH c_Fator

            INTO v_Fator;

          CLOSE c_Fator;

          -- PDA 166225 (Inicio) - Henrique Antunes - 12/01/2007

          OPEN Ccapconfiguracao;

          FETCH Ccapconfiguracao

            INTO Cdadosconfiguracao;

          IF Ccapconfiguracao%FOUND THEN

            Fator_Inteiro := TRUE;

          ELSE

            Fator_Inteiro := FALSE;

          END IF;

          CLOSE Ccapconfiguracao;

          -- PDA 166225 (Fim)

		      -- OP 32555 - planserv Inicio

		      OPEN cRgraSubstituMesmoProfat (Pkg_Mv2000.Le_Empresa,

                                                     v_Mvto.Cd_Setor,

                                                     v_Proced.Cd_Pro_Fat,



                                                     Ddtreferencia,

                                                     v_Mvto.Cd_Convenio,

                                                     v_Mvto.Tp_Atendimento,

                                                     v_mvto.cd_con_pla,    /*OP 44895*/

                                                     vcRregra.cd_regra     /*OP 44895*/

                                                     );

          FETCH  cRgraSubstituMesmoProfat INTO SnRgraSubstituMesmoProfat ;

          CLOSE  cRgraSubstituMesmoProfat ;

		  -- OP 32555 - planserv fim

          -- PDA 174061 Inicio

          Nqtprofat := Fnc_Substituicao_Proced_Fator(Pkg_Mv2000.Le_Empresa,

                                                     v_Mvto.Cd_Setor,

                                                     v_Proced.Cd_Pro_Fat,

                                                     /*PDA 202951(inicio) - 14/07/2009 - Jansen Gallindo

                                                                     substituindo no c??o o dt_mvto_estoque por ddtreferencia

                                                                                   v_mvto.dt_mvto_estoque,*/

                                                     Ddtreferencia,

                                                     /*PDA 202951(fim)*/

                                                     v_Mvto.Tp_Atendimento,

                                                     'S',

                                                     Nqtmovnew,          -- 197494

                                                      v_Mvto.Cd_Convenio,  /*OP 28803*/

                                                      v_mvto.cd_con_pla,   /*OP 44895*/

                                                      vcRregra.cd_regra     /*OP 44895*/

                                                      );

          -- nQtProFat); -- 197494

          Noldqtprofat := Fnc_Substituicao_Proced_Fator(Pkg_Mv2000.Le_Empresa,

                                                        v_Mvto.Cd_Setor,

                                                        v_Proced.Cd_Pro_Fat,

                                                        /*PDA 202951(inicio) - 14/07/2009 - Jansen Gallindo

                                                                           substituindo no c??o o dt_mvto_estoque por ddtreferencia

                                                                                         v_mvto.dt_mvto_estoque,*/

                                                        Ddtreferencia,

                                                        /*PDA 202951(fim)*/

                                                        v_Mvto.Tp_Atendimento,

                                                        'S',

                                                        Nqtmovold,  -- 197494

                                                      v_Mvto.Cd_Convenio,  /*OP 28803*/

                                                      v_mvto.cd_con_pla,   /*OP 44895*/

                                                      vcRregra.cd_regra     /*OP 44895*/

                                                      );

          -- nOldQtProFat); -- 197494

          -- pda 545312 - evitar erro de divisor por zero

          IF v_Proced.Vl_Fator_Pro_Fat IS NULL OR

             v_Proced.Vl_Fator_Pro_Fat = 0 THEN

            Ndivisor := 1;

          ELSE

            Ndivisor := v_Proced.Vl_Fator_Pro_Fat;

          END IF;

          -- pda 545312 - fim

          -- PDA 174061 Fim

          IF Nvl(Nqtmovnew, 0) = 0 THEN

            Nqtprofat := 1;

          ELSE

            -- PDA 166225 (Inicio) - Henrique Antunes - 12/01/2007

            --nqtprofat := ROUND ((nqtmovnew * v_fator.vl_fator) / v_proced.vl_fator_pro_fat);

            IF NOT Fator_Inteiro THEN

              IF Vauxprofat = v_Proced.Cd_Pro_Fat AND SnRgraSubstituMesmoProfat IS NULL THEN -- OP 32555 - planserv

                -- PDA 174061 Inicio

                Nqtprofat := Round((Nqtmovnew * v_Fator.Vl_Fator) /

                                   Ndivisor); -- v_proced.vl_fator_pro_fat);  -- pda 545312

              END IF; -- PDA 174061 Fim

            ELSE

              Nqtprofat := Trunc((Nqtmovnew * v_Fator.Vl_Fator) / Ndivisor); -- v_proced.vl_fator_pro_fat);  -- pda 545312

              IF MOD(Nqtmovnew * v_Fator.Vl_Fator,

                     v_Proced.Vl_Fator_Pro_Fat) <> 0 THEN

                Nqtprofat := Nqtprofat + 1;

              END IF;

            END IF;

            IF Vauxprofat <> v_Proced.Cd_Pro_Fat THEN

              -- PDA 174061 Inicio

              Nqtprofat := Round(Nqtprofat);

            END IF; -- PDA 174061 Fim

            -- PDA 166225 (Fim)

            IF Nvl(Nqtprofat, 0) = 0 THEN

              Nqtprofat := 1;

            END IF;

          END IF;

          IF Nvl(Nqtmovold, 0) = 0 THEN

            Noldqtprofat := 1;

          ELSE

            -- PDA 166225 (Inicio) - Henrique Antunes - 12/01/2007

            --noldqtprofat := ROUND ((nqtmovold * v_fator.vl_fator) / v_proced.vl_fator_pro_fat);

            IF NOT Fator_Inteiro THEN

              IF Vauxprofat = v_Proced.Cd_Pro_Fat THEN

                -- PDA 174061 Inicio

                Noldqtprofat := Round((Nqtmovold * v_Fator.Vl_Fator) /

                                      Ndivisor); -- v_proced.vl_fator_pro_fat);  -- pda 545312

              END IF; -- PDA 174061 Fim

            ELSE

              Noldqtprofat := Trunc((Nqtmovold * v_Fator.Vl_Fator) /

                                    Ndivisor); -- v_proced.vl_fator_pro_fat);  -- pda 545312

              IF MOD(Nqtmovold * v_Fator.Vl_Fator,

                     v_Proced.Vl_Fator_Pro_Fat) <> 0 THEN

                Noldqtprofat := Nqtprofat + 1;

              END IF;

            END IF;

            -- PDA 166225 (Fim)

            IF Vauxprofat <> v_Proced.Cd_Pro_Fat THEN

              -- PDA 174061 Inicio

              Noldqtprofat := Round(Noldqtprofat);

            END IF; -- PDA 174061 Fim

            IF Nvl(Noldqtprofat, 0) = 0 THEN

              Noldqtprofat := 1;

            END IF;

          END IF;

          -- PDA 100545 -- Alexandre Erik C. M. Costa -- 13/10/2004 (INICIO)

          -- Caso esteja sendo exclu?do uma devolu?, deve ser lan?o na conta do paciente a quantidade que est?endo

          -- exclu?do. Neste Caso a quantidade est?ontida na vari?l nOldQtProFat.

          IF DELETING  THEN

            Nqtprofat := Noldqtprofat;

          END IF;

          /* pda 145435 - 23/03/2006 - Jose Roberto                          (*)

          Alterando a verifica? da guia, retirando os cursores c_qtdexistente_amb e

          c_qtdexistente_fat para utilizar a nova fun? FNC_RETORNA_GUIA_DISPONIVEL;

          Retiradas as verifica?s nos cursores c_guia, c_itguia e c_itguia_proc_auto;

          Retirado o uso das vari?is totallancado e nqtautorizado;

          Caso NCDGUIA for Nulo, chamando a fun? F_GRAVA_GUIA, alterando o terceiro

          par?tro para nqtprofat;

          Retirado todo o c?ulo feito para atribuir valor as vari?is nqtpart,

          nqtconv e limite;

          Caso retorne uma Guia dispon?l, atribu?a ?ari?l NCDGUIA.         */

          -- PDA 162402 (Inicio) - Henrique Antunes - 04/05/2007

          --if ctpproibicao = 'AG' then

          OPEN c_Orteseprotese(v_Proced.Cd_Pro_Fat);

          FETCH c_Orteseprotese

            INTO Cprodorteseprotese;

          CLOSE c_Orteseprotese;

          -- PDA 208386 (In?o) 01/12/2007 FL?IO LAGO

          --

          --if ctpproibicao = 'AG' or

          --  (nvl(v_mvto.sn_cria_guia_opme_fscc,'N') = 'S' and

          --  cprodorteseprotese IS NOT NULL) then

          --

          -- PDA 262456 (Inicio) - Henrique Antunes - 03/12/2008

          --if ctpproibicao = 'AG' or

          --   ( nvl(v_mvto.sn_cria_guia_opme_fscc,'N') = 'S' and

          --     cprodorteseprotese.cd_pro_fat IS NOT NULL    and

          --     nvl(cprodorteseprotese.sn_opme,'N')='N' ) then

          IF (Ctpproibicao = 'AG' OR

             (Nvl(v_Mvto.Sn_Cria_Guia_Opme_Fscc, 'N') = 'S' AND

             Cprodorteseprotese.Cd_Pro_Fat IS NOT NULL AND

             /*nvl(cprodorteseprotese.sn_opme,'N')='N' )*/

             Nvl(Cprodorteseprotese.Sn_Opme, 'N') = 'S') /*OP 3828 - l??a estava invertida.*/

             ) AND



             ((Dbamv.Pkg_Mv2000.Le_Cliente = 759 AND Ctpproibicao = 'AG' AND

             v_Proced.Sn_Consignado = 'N' AND v_Proced.Sn_Opme = 'N') OR

             Dbamv.Pkg_Mv2000.Le_Cliente <> 759 -- pda 542487

             -- pda 528737 - fim

             ) AND v_Mvto.Tp_Convenio IN ('C', 'P') -- pda 513519 - criar guia em atendimento particular (antes era <> 'P')

             AND v_Mvto.Tp_Mvto_Estoque <> 'C' THEN

            -- PDA 162402 (Inicio) - Henrique Antunes - 04/05/2007

			-- OP 27608 (735938) - Incluido : OR Nvl(v_Mvto.TP_ATUALIZA_GUIA_OPME_FSCC, 'X') = 'C'   .

            IF Nvl(v_Mvto.Sn_Cria_Guia_Opme_Fscc, 'N') = 'S' OR Nvl(v_Mvto.TP_ATUALIZA_GUIA_OPME_FSCC, 'X') = 'C' THEN

              Pnaviso := '@' || v_Mvto.Cd_Aviso_Cirurgia;

            ELSE

              Pnaviso := NULL;

            END IF;

            -- PDA 162402 (Fim)

            /*295861 - 13/08/2009 - Jansen Gallindo

            fun? abaixo so devera ser chamada se o tipo de movimenta? fro diferente de

            devolucao para paciente*/

            IF v_Mvto.Tp_Mvto_Estoque <> 'C' THEN

              /*pda 312488 - Thiago Miranda de Oliveira - na chamada da fun? que retorna se tem uma guia dispon?l, passar sempre o codigo do atendimento

                      pai caso tiver, pois o sistma pode criar atendimentos de recem nascido onde n?existe conta para ele e n??ecess?o

              crioar guias para os atendimentos filhos.*/

              Ncdguia := Dbamv.Pkg_Ffcv_Guia.Fnc_Retorna_Guia_Disponivel(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                             v_Mvto.Cd_Atendimento),

                                                                         Nvl(Ncdregfat,

                                                                             Ncdregamb),

                                                                         NULL,

                                                                         v_Proced.Cd_Pro_Fat,

                                                                         Nqtprofat,

                                                                         NULL,

                                                                         -- PDA 162402 (Inicio) - Henrique Antunes - 04/05/2007

                                                                         --null,

                                                                         Pnaviso,

                                                                         -- PDA 162402 (Fim)

                                                                         Nguiapendente);



                        -- OP 35103 - 06/01/2016 - Se a fun? retornar apenas uma guia pendente j?elecionada, utilizar essa guia.

                        IF Ncdguia IS NULL AND Nguiapendente IS NOT NULL THEN

                          select dbamv.seq_it_guia.nextval

                            into nCdItGuia

                            from sys.dual;

                          --

		                      insert into dbamv.it_guia(cd_guia,cd_it_guia,cd_pro_fat,qt_autorizado,dt_geracao,cd_usu_geracao, tp_pre_pos_cirurgico)

		                        values(Nguiapendente,nCdItGuia,v_Proced.Cd_Pro_Fat,nvl(Nqtprofat,1),sysdate,USER,'POS');

                          --

                          Ncdguia := Nguiapendente;

                        END IF;



                        -- OP 35103 - 06/01/2016 - rastro do processo de guia

		                    if vSnRastreabilidade = 'S' THEN

		                      dbamv.PKG_FFCV_RASTREABILIDADE.prc_grava_rastreabilidade(pRotina    => 'FNC_RETORNA_GUIA_DISPONIVEL',

											                      pEmpresa   => Dbamv.Pkg_Mv2000.Le_Empresa,

											                      pDsConfig  => NULL,

												                    pCdLogRastro => vpCdLogRastro

															                      );

			                    dbamv.PKG_FFCV_RASTREABILIDADE.prc_grava_it_rastreabilidade(

							                    pCdLogRastro     => vpCdLogRastro,

							                    pCdPasso         => 'PASSO100',

							                    pAtend           => Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

							                    pDsParametros    =>'#Atendimento = '||Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento) ||'# #'||

                                                      'Procedimento = '||v_Proced.Cd_Pro_Fat ||'# #'||'Ncdguia = '||Ncdguia||'# #'||

                                                      'Pnaviso = '||Pnaviso ||'# #'||'Guia Pendente = '||Nguiapendente,

							                    pDsPasso         => 'pack_lanca_ffcv - 1 ',

							                    pDsPassoTecnico  => 'pack_lanca_ffcv - 1 ',

							                    pDsSolucao       =>  NULL,

							                    pSnSucesso       => 'S',

							                    pTpInfoPasso     => 'I' ,   /*(I - informa? , A = ALerta , E = Erro)*/

							                    pReserva         => null

																			                    );

		                    end if;

                        -- OP 35103 - fim



            END IF;

            /*295861 (fim)*/

            --PDA 162402 (In?o) 20/03/2007 - Pedro Neiva (Apply)

            OPEN Csnfaturadireta(v_Proced.Cd_Pro_Fat, Ncdguia);

            FETCH Csnfaturadireta

              INTO Vcsnfaturadireta;

            CLOSE Csnfaturadireta;

            --PDA 162402 (Fim) 20/03/2007 - Pedro Neiva (Apply)

            --pda 234939(In?o) Pedro Neiva - 02/07/2008

            IF Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'N' THEN

              OPEN Csnfaturadireta2(v_Proced.Cd_Pro_Fat,

                                    v_Mvto.Cd_Convenio);

              FETCH Csnfaturadireta2

                INTO Vcsnfaturadireta;

              CLOSE Csnfaturadireta2;

            END IF;

            --pda 234939(Fim)

            IF Nvl(Vsnguiaprocauto, 'N') = 'S' THEN

              IF Ncdguia IS NULL AND v_Mvto.Tp_Mvto_Estoque <> 'C' THEN

                /*295861 13/08/2009 - Jansen Gallindo

                                                                        S??ver?hamar a fun? se o tipo de movimenta? for diferente de devolucao para paciente*/

                /*pda 312488 - Thiago Miranda de Oliveira - na chamada da fun? que retorna se tem uma guia dispon?l, passar sempre o codigo do atendimento

                        pai caso tiver, pois o sistma pode criar atendimentos de recem nascido onde n?existe conta para ele e n??ecess?o

                criar guias para os atendimentos filhos.*/

                Ncdguia := Dbamv.f_Grava_Guia(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                  v_Mvto.Cd_Atendimento),

                                              v_Mvto.Cd_Convenio,

                                              Nqtprofat,

                                              v_Proced.Cd_Pro_Fat,

                                              'P');

              END IF;

              Nqtpart := 0;

              Nqtconv := Nqtprofat;

              Limite  := 0;

              /* pda 164822 - 28/09/2006 - Amalia Ara??



              else

                nQtPart := nQtProFat;

                nQtConv := 0;

                limite  := 1;

              pda 164822 - fim       */

            END IF;

          END IF;

          -- pda 145435 (Fim)

          IF Nvl(Csnitempertencepacote, 'S') = 'N' THEN

            --  um kit

            Csnpacote     := Csnitempertencepacote;

            Vtpimportacao := 'Produto-Kit';

          ELSIF Csnitempertencepacote = 'S' THEN

            -- Itens do Kit conforme config_con_pla_kit

            Csnpacote     := Csnitempertencepacote;

            Vtpimportacao := 'Produto';

          ELSE

            Vtpimportacao := 'Produto';

            -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

            IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

              Ncdconta := Ncdregfat;

            ELSE

              Ncdconta := Ncdregamb;

            END IF;

            IF Ctpproibicao = 'AG' THEN

              Csnguia := 'S';

            END IF;

            /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

            nQtExcedeu a vari?l retorna justamente a quantidade de procedimentos que deve ser lan?o no procedimento

            que pertence ao pacote, em seguida deve ser inserdio um outro procedimento com o que restou do lan?ento*/

            Nqtexcedeu := NULL;

            --

            /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

            vTpContaPart a vari?l retorna justamente se o procedimento vai ser inserido em uma conta particular ou ira seguir

            o processo normalmente.*/

            Ncdpacote := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Gera_Pacote(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                     v_Mvto.Cd_Atendimento),

                                                                 v_Mvto.Tp_Atendimento,

                                                                 Ncdconvconta -- ,v_mvto.cd_convenio OP 6182

                                                                ,

                                                                 Ncdplanconta -- ,v_mvto.cd_con_pla OP 6182

                                                                ,

                                                                 Ncdconta,

                                                                 v_Grfat.Cd_Gru_Fat,

                                                                 v_Proced.Cd_Pro_Fat,

                                                                 v_Mvto.Cd_Setor,

                                                                 NULL,

                                                                 Nvl(Ddtreferencia,

                                                                     SYSDATE),

                                                                 Ncdmvtoestoque,

                                                                 Ncditemmvto,

                                                                 'Produto',

                                                                 Csnguia,

                                                                 Nqtprofat,

                                                                 Csnpacote,

                                                                 Nqtexcedeu -- OP 387

                                                                ,

                                                                 Vtpcontapart -- OP 387

                                                                ,

                                                                 NULL

                                                                 -- PDA 225086 (Inicio)

                                                                ,

                                                                 v_Mvto.Cd_Atendimento,

                                                                 NULL --pCdProFatPacote

                                                                ,

                                                                 Ncdlcto --pCdLancamento_pac

                                                                ,

                                                                 NULL); --preserva

            -- PDA 225086 (fim)

            /* pda 481126 - depois da FNC_GERA_PACOTE regravando o cd_lancamento_pac */



            --

            IF Ncdpacote IS NOT NULL THEN

              UPDATE Dbamv.Conta_Pacote

                 SET Cd_Lancamento_Pac = Ncdlcto

               WHERE Cd_Conta_Pacote = Ncdpacote;

            END IF;

            /* pda 481126 - fim */

          END IF;

          -- OP 42102 trazendo o codigo para fora da condi?

          IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncdregfat);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                INTO Ncdlcto;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

            ELSE

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Ncdregamb);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                INTO Ncdlcto;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;

            END IF;



          -- PDA 137045 (Inicio) - Henrique Antunes - 26/10/2005

          IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

            DECLARE

              Vqtd NUMBER;

            BEGIN

              OPEN Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco(Ncdregfat,

                                                          Ddtreferencia,

                                                          v_Mvto.Hr_Mvto_Estoque);

              FETCH Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco

                INTO Vqtd;

              CLOSE Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco;

              IF Nvl(Vqtd, 0) <> 0 THEN

                RAISE Auditoria_In_Loco;

              END IF;

            END;

          END IF;

          -- PDA 137045 (Fim)

          IF Inserting AND v_Mvto.Tp_Mvto_Estoque <> 'C' OR

             (Deleting AND v_Mvto.Tp_Mvto_Estoque = 'C') THEN

            -- PDA 97238

            OPEN c_Orteseprotese(v_Proced.Cd_Pro_Fat);

            FETCH c_Orteseprotese

              INTO Cprodorteseprotese;

            CLOSE c_Orteseprotese;

            OPEN c_Eh_Consignado;

            FETCH c_Eh_Consignado

              INTO Nprodconsignado;

            CLOSE c_Eh_Consignado;

            -- PDA 208386 (In?o) 01/12/2007 FL?IO LAGO

            --IF NVL (nprodconsignado, 0) > 0 AND cprodorteseprotese IS NOT NULL THEN

            IF Nvl(Nprodconsignado, 0) > 0 AND Cprodorteseprotese.Cd_Pro_Fat IS NOT NULL THEN

              -- PDA 208386

              Nvlpercconsig := NULL;



			      /* OP 32555 - 23/09/2015 - Refazendo processo, pois a fun? Fnc_Ffcv_Retorna_Percent_Cnsg agora j?ai retornar o valor calculado,

                   por causa da verifica? do teto de cobran?implementado na faixa de percentual consignado.			  */

            /*  Nvlpercconsig := Dbamv.Fnc_Ffcv_Retorna_Percent_Cnsg(Dbamv.Pkg_Mv2000.Le_Empresa,

                                                                   Ncdconvconta,

                                                                   v_Proced.Cd_Pro_Fat,

                                                                   Nvl(Nvlunitconsig,0),

                                                                   'I',

																   Ddtreferencia  );      */



             -- IF Nvlpercconsig IS NOT NULL and Nvlpercconsig <> Nvl(Nvlunitconsig,0) THEN

                -- PDA 208884 (Inicio)

                OPEN Cleconfig;

                FETCH Cleconfig

                  INTO Vsnvalorguia;

                CLOSE Cleconfig;

                IF Nvl(Vsnvalorguia, 'N') = 'S' THEN

                  -- PDA 230530 - inclus?do NVL

                  OPEN Cvalorizacao(v_Mvto.Cd_Atendimento,

                                    v_Proced.Cd_Pro_Fat,

                                    Ncdfornec,

                                    Ncdguia); /*pda 427112*/

                  FETCH Cvalorizacao

                    INTO Nvlunitconsig;

                  CLOSE Cvalorizacao;

                ELSIF Nvl(Cprodorteseprotese.Sn_Opme, 'N') = 'S' THEN

                  -- PDA 208386 (In?o) 01/12/2007 FL?IO LAGO

                  --*1

                  --if nvl(cprodorteseprotese.sn_opme,'N') = 'S' then

                  -- PDA 208884 (Fim)

                  Nvlunitconsig := NULL; -- PDA 536659

                  OPEN c_Entrada_Prod_Sn_Opme(v_Mvto.Cd_Atendimento);

                  FETCH c_Entrada_Prod_Sn_Opme

                    INTO Ncdfornecedor, Nvlunitconsig;

                  CLOSE c_Entrada_Prod_Sn_Opme;

                  -- PDA 536659 - Inicio - Raphanelli de barros

                  -- Caso n?tenha encontrado valores na entrada da Nota , procura pela ultimas NF ou pela ultimas entradas do produto , de acordo com o

                  -- o configurado no cadastro de parametros do FFCV .

                  IF Nvlunitconsig IS NULL THEN

                    IF Vsnconsignadonf = 'S' THEN

                      OPEN c_Ultimas_Compras;

                      FETCH c_Ultimas_Compras

                        INTO Ncdfornecedor, Nvlunitconsig;

                      CLOSE c_Ultimas_Compras;

                    ELSE

                      OPEN c_Entrada_Prod;

                      FETCH c_Entrada_Prod

                        INTO Ncdfornecedor, Nvlunitconsig;

                      CLOSE c_Entrada_Prod;

                    END IF;

                  END IF;

                  -- PDA 536659 - Fim

                ELSE

                  --*1 -- PDA 208386 (fim)

                  IF Vsnconsignadonf = 'S' THEN

                    OPEN c_Ultimas_Compras;

                    FETCH c_Ultimas_Compras

                      INTO Ncdfornecedor, Nvlunitconsig;

                    CLOSE c_Ultimas_Compras;

                  ELSE

                    OPEN c_Entrada_Prod;

                    FETCH c_Entrada_Prod

                      INTO Ncdfornecedor, Nvlunitconsig;

                    CLOSE c_Entrada_Prod;

                  END IF;

                  -- PDA 253547(Inicio)

                END IF; --*1 -- PDA 208386



                OPEN c_Total_Percentual_Consignado;

                FETCH c_Total_Percentual_Consignado

                  INTO Nqtdregpercconsig;

                CLOSE c_Total_Percentual_Consignado;



                -- OP 32555 - A fun? vai passar o valor calculado acima, e j?etornar o valor com o percentual consignado

                Nvlpercconsig := Dbamv.Fnc_Ffcv_Retorna_Percent_Cnsg(Dbamv.Pkg_Mv2000.Le_Empresa,

                                                                     Ncdconvconta,

                                                                     v_Proced.Cd_Pro_Fat,

                                                                     Nvl(Nvlunitconsig,0),

                                                                     'I',

																     Ddtreferencia ,

                                                                     'VP'	 );



				IF Nvl(Vsnvalorguia, 'N') = 'N' AND Nvl(Nvlpercconsig,0) > 0 THEN

					Nvlunitconsig := Round(Nvlpercconsig,2);

				END IF;



                -- OP 36996 - Buscando valor da taxa de percentual consignado.

                nVlTaxaConsig := Dbamv.Fnc_Ffcv_Retorna_Percent_Cnsg(Dbamv.Pkg_Mv2000.Le_Empresa,

                                                                     Ncdconvconta,

                                                                     v_Proced.Cd_Pro_Fat,

                                                                     Nvl(Nvlunitconsig,0),

                                                                     'I',

																     Ddtreferencia ,

                                                                     'VT'	 );



            END IF;

            -- PDA 170696 (Inicio) - Henrique Antunes - 23/11/2006

            OPEN c_Kit;

            FETCH c_Kit

              INTO Ncdpadrao;

            CLOSE c_Kit;

            IF Ncdpadrao IS NOT NULL AND Nqtformula IS NOT NULL THEN

              /*PDA 202951(inicio) - 14/07/2009

              substituindo no c??o o dt_mvto_estoque por ddtreferencia*/

              -- PDA 186048 (INICIO) - Jansen Gallindo

              -- Incluir condi? de conta

              OPEN c_Conta_Kit(Nvl(Ncdregfat, Ncdregamb), /*v_mvto.dt_mvto_estoque*/

                               Ddtreferencia,

                               /*v_mvto.hr_mvto_estoque*/

                               Ddtreferencia,

                               Ncdpadrao);

              /*PDA 202951(fim) - 14/07/2009*/

              -- PDA 186048 (FIm)

              FETCH c_Conta_Kit

                INTO Ncdcontakit;

              CLOSE c_Conta_Kit;

              IF Ncdcontakit IS NULL THEN

                OPEN c_Seq_Conta_Kit;

                FETCH c_Seq_Conta_Kit

                  INTO Ncdcontakit;

                CLOSE c_Seq_Conta_Kit;

                IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

                  Ncdregamb := NULL;

                ELSE

                  OPEN Catendsessao(v_Mvto.Cd_Atendimento);

                  FETCH Catendsessao

                    INTO Vcatendsessao;

                  CLOSE Catendsessao;

                  Ncdregfat := NULL;

                END IF;

                INSERT INTO Dbamv.Conta_Kit

                  (Cd_Conta_Kit,

                   Cd_Padrao,

                   Dt_Lancamento,

                   Hr_Lancamento,

                   Cd_Atendimento,

                   Cd_Reg_Fat,

                   Cd_Reg_Amb,

                   Cd_Setor,

                   Qt_Lancamento,

                   Dt_Sessao)

                VALUES

                  (Ncdcontakit,

                   Ncdpadrao

                   /*PDA 202951(inicio) - 14/07/2009 - Jansen Gallindo

                                                       substituindo dt_mvto_estoque por ddtreferencia

                                                       ,v_mvto.dt_mvto_estoque

                                                       ,v_mvto.hr_mvto_estoque*/,

                   Ddtreferencia,

                   Ddtreferencia

                   /*PDA 202951(fim)*/,

                   v_Mvto.Cd_Atendimento,

                   Ncdregfat,

                   Ncdregamb,

                   v_Mvto.Cd_Setor,

                   Nqtformula,

                   Decode(Vcatendsessao.Sn_Retorno,

                          'N',

                          NULL,

                          Decode(Vcatendsessao.Qt_Sessoes,

                                 0,

                                 NULL,

                                 Vcatendsessao.Dt_Atendimento)));

              END IF;

            END IF;

            -- PDA 170696 (Fim)

            IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

              -- PDA 164020 Inicio

              DECLARE

                Vqtd NUMBER;

              BEGIN

                OPEN Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco(Ncdregfat,

                                                            Ddtreferencia,

                                                            v_Mvto.Hr_Mvto_Estoque);

                FETCH Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco

                  INTO Vqtd;

                CLOSE Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco;

                IF Nvl(Vqtd, 0) <> 0 THEN

                  RAISE Auditoria_In_Loco;

                END IF;

              END;

              -- PDA 164020 Fim

              IF Limite <> 1 THEN

                --PDA 162402(In?o) - 20/03/2007 - Pedro Neiva(Apply)

                IF (Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'N' OR

                   (Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'S' AND

                   Nvl(v_Mvto.Sn_Lanca_Consignado_Na_Conta, 'S') = 'S')) THEN

                  --PDA 162402(Fim) - 20/03/2007 - Pedro Neiva(Apply)

                  /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa



*/

               /* OP 387 - Thiago Miranda - fazendo tratamento caso o procedimento esteja configurado no gabarito para ser inserido dentro de uma conta particular



                  caso a variavel vTpContaPart esteja preenchida e a quantidade de lan?ento extra esteja nula. com iso deve ser procurado uma conta particular

                  e um lan?ento para inseririr nesta conta.*/

                  Nconta := NULL;

                  Nlanc  := NULL;



				/*43289 - quebra de conta por quantidade de procedimento por atendimento*/

				/*A regra de pacote tem prioridade sobre essa regra, conforme vari?l Nqtexcedeu abaixo*/

				IF Nqtexcedeu IS NULL THEN



					if (not vSnCriouContaAuto) then /*OP 46768*/



						  IF DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_EXISTE_CONF_QTD_ATEND_PAC(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

                                                                                 v_proced.cd_pro_fat,

                                                                                 pEmpresa) THEN



				    	      Nqtexcedeu := DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_RETORNA_QTD_LANC_PERIODO(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																										                                            v_proced.cd_pro_fat,

																										                                            pEmpresa,

																										                                            ncdregfat,

																										                                            nvl(nqtconv, nqtprofat),

																											                                          pSnChamadoDaTela,

																											                                          pvSnJaExcedeuQtd,

																											                                          pvMensagem

																											                                          );

							  IF pvSnJaExcedeuQtd = 'S' THEN

								  Vtpcontapart := 'ProcPorAtend';

								  Nqtexcedeu   := NULL;

							  ELSE

									IF NVL(Nqtexcedeu,0) > 0 THEN

										Vtpcontapart := 'ProcPorAtend';

									END IF;

							  END IF;

					    END IF;

					end if;/*OP 46768*/

                END IF;

		        /*43289*/

                  IF Nvl(Vtpcontapart, 'X') <> 'X' AND Nqtexcedeu IS NULL THEN

                    Nconta := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                               v_Mvto.Cd_Atendimento),

                                                                           Ddtreferencia);

                    OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Nconta);

                    FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                      INTO Nlanc;

                    CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

                  END IF;

                  INSERT INTO Dbamv.Itreg_Fat

                    (Cd_Reg_Fat,

                     Cd_Lancamento,

                     Dt_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Vl_Percentual_Multipla,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Sn_Pertence_Pacote,

                     Cd_Guia,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto,

                     Cd_Itmvto

                     -- PDA 170696 (Inicio) - Henrique Antunes - 23/11/2006

                    ,

                     Cd_Padrao,

                     Cd_Conta_Kit

                     -- PDA 170696 (Fim)

                     -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                    ,

                     Cd_Conta_Pacote

                     -- PDA 157145 (Fim)

                     ,cd_regra_substituicao_proced

                     )

                  VALUES

                    (Nvl(Nconta, Ncdregfat) -- OP 387

                    ,

                     Nvl(Nlanc, Ncdlcto) -- OP 387

                    ,

                     Ddtreferencia

                     -- PDA 229502 (Inicio) - Henrique Antunes - 06/06/2008

                     --,v_mvto.hr_mvto_estoque

                    ,

                     Nvl(Ddtreferencia, v_Mvto.Hr_Mvto_Estoque)

                     -- PDA 229502 (Fim)

                    ,

                     Nvl(Nqtexcedeu, Nvl(Nqtconv, Nqtprofat)) -- OP 387

                    ,

                     100,

                     v_Grfat.Cd_Gru_Fat,

                     v_Proced.Cd_Pro_Fat,

                     Nvl(Csnpacote, 'N'),

                     Ncdguia,

                     v_Mvto.Cd_Setor,

                     v_Mvto.Cd_Setor,

                     'N',

                     USER,

                     Ncdmvtoestoque,

                     Nvl(Vtpcontapart, 'Produto') -- OP 387

                    ,

                     Ncditemmvto

                     -- PDA 170696 (Inicio) - Henrique Antunes - 23/11/2006

                    ,

                     Ncdpadrao,

                     Ncdcontakit

                     -- PDA 170696 (Fim)

                     -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                    ,

                     Ncdpacote

                     -- PDA 157145 (Fim)

                     ,nRegraSubstituicao

                     );



                  /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

                  que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

                  os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

                  IF Nqtexcedeu IS NOT NULL THEN

                    Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregfat,

                                                                        Ncdlcto,

                                                                        (Nvl(Nqtconv,

                                                                             Nqtprofat) -

                                                                        Nqtexcedeu),

                                                                        Vtpcontapart,

                                                                        Ddtreferencia,

																		Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                               v_Mvto.Cd_Atendimento)); /*ALLS OP 43289*/

                  END IF;



				  -- FATURCONV 1260

                  DBAMV.PRC_FFCV_COMPOE_APRES_PRODUTO('H',Ncdregfat, Ncdlcto, Ncdproduto, Nvl(Nqtmovnew,Nqtmovold));



                  IF Nvl(Vtpcontapart, 'X') = 'X' THEN

                    IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                                  Ncdlcto,

                                                                  'I') THEN

                      IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                                    Ncdlcto,

                                                                    'I') THEN

                        Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'I');

                      END IF;

                    END IF;

                  END IF;

                END IF; --PDA 162402 - 20/03/2007 - Pedro Neiva(Apply)

              END IF;

              IF v_Mvto.Tp_Convenio <> 'P' AND Nvl(Nqtpart, 0) > 0 AND

                 Ctpproibicao = 'AG' THEN

                Ncdregfat := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento,

                                                                          Ddtreferencia); -- pda 125871(acrescentada a data)

                --PDA 162402(In?o) - 20/03/2007 - Pedro Neiva(Apply)

                IF (Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'N' OR

                   (Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'S' AND

                   Nvl(v_Mvto.Sn_Lanca_Consignado_Na_Conta, 'S') = 'S')) THEN

                  --PDA 162402(Fim) - 20/03/2007 - Pedro Neiva(Apply)

                  INSERT INTO Dbamv.Itreg_Fat

                    (Cd_Reg_Fat,

                     Cd_Lancamento,

                     Dt_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Vl_Percentual_Multipla,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Sn_Pertence_Pacote,

                     Cd_Guia,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto,

                     Cd_Itmvto

                     -- PDA 170696 (Inicio) - Henrique Antunes - 23/11/2006

                    ,

                     Cd_Padrao,

                     Cd_Conta_Kit

                     -- PDA 170696 (Fim)

                     -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                    ,

                     Cd_Conta_Pacote

                     -- PDA 157145 (Fim)

                     ,cd_regra_substituicao_proced

                     )

                  VALUES

                    (Ncdregfat,

                     Ncdlcto,

                     Ddtreferencia

                     -- PDA 229502 (Inicio) - Henrique Antunes - 06/06/2008

                     --,v_mvto.hr_mvto_estoque

                    ,

                     Nvl(Ddtreferencia, v_Mvto.Hr_Mvto_Estoque)

                     -- PDA 229502 (Fim)

                    ,

                     Nqtpart,

                     100,

                     v_Grfat.Cd_Gru_Fat,

                     v_Proced.Cd_Pro_Fat,

                     Nvl(Csnpacote, 'N'),

                     Ncdguia,

                     v_Mvto.Cd_Setor,

                     v_Mvto.Cd_Setor,

                     'N',

                     USER,

                     Ncdmvtoestoque,

                     'Produto',

                     Ncditemmvto

                     -- PDA 170696 (Inicio) - Henrique Antunes - 23/11/2006

                    ,

                     Ncdpadrao,

                     Ncdcontakit

                     -- PDA 170696 (Fim)

                     -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                    ,

                     Ncdpacote

                     -- PDA 157145 (Fim)

                     ,nRegraSubstituicao

                     );

                END IF; --PDA 162402 - 20/03/2007 - Pedro Neiva(Apply)

              END IF;



              /*OP 42241 - Caso tenha criado a conta por cargo paciente, devemos lan? o item para o convenio, plano, percentual definido na configura

              de quebra de conta por cargo paciente*/

              IF (vSnCriouContaAutoCP) THEN

                  vSnCriouContaAutoCP := FALSE;



                  OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(v_ContaCargoPac(1).cd_reg_fat);

                  FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                  INTO NcdlctoCp;

                  CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;



                   INSERT INTO Dbamv.Itreg_Fat

                    (Cd_Reg_Fat,

                     Cd_Lancamento,

                     Dt_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Vl_Percentual_Multipla,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Sn_Pertence_Pacote,

                     Cd_Guia,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto,

                     Cd_Itmvto,

                     cd_regra_substituicao_proced

                     )

                  VALUES

                    (v_ContaCargoPac(1).cd_reg_fat,

                     NcdlctoCp,

                     Ddtreferencia,

                     Nvl(Ddtreferencia, v_Mvto.Hr_Mvto_Estoque),

                     Nvl(Nqtexcedeu, Nvl(Nqtconv, Nqtprofat)),

                     vRegraCriaContaAutoCP(1).vl_percentual_carga_familiar,

                     v_Grfat.Cd_Gru_Fat,

                     v_Proced.Cd_Pro_Fat,

                     'N',

                     Ncdguia,

                     v_Mvto.Cd_Setor,

                     v_Mvto.Cd_Setor,

                     'N',

                     USER,

                     Ncdmvtoestoque,

                     'Produto',

                     Ncditemmvto,

                     nRegraSubstituicao

                     );

              END IF;

              /*OP 42241*/



              -- /* Lancamento dos Valores Relacionados */ --

              DECLARE      -- OP 42641

                CURSOR c_Relacionados IS

                  SELECT Rela.Cd_Pro_Fat,

                         Rela.Tp_Atend_Homecare,

                         Rela.Tp_Atend_Externo,

                         Rela.Tp_Atend_Urgeme,

                         Rela.Tp_Atend_Ambulatorial,

                         Rela.Tp_Atend_Internacao,

                         Rela.Sn_Faturamento_Direto,

                         Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

                    FROM Dbamv.Regra,

                         Dbamv.Val_Pro_Relacionado Rela,

                         Dbamv.Empresa_Con_Pla

                   WHERE Empresa_Con_Pla.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

                     AND Rela.Tp_Lancamento = 'A'

                     AND EMPRESA_CON_PLA.CD_CONVENIO = V_MVTO.CD_CONVENIO

                     AND EMPRESA_CON_PLA.CD_CON_PLA = V_MVTO.CD_CON_PLA

                     AND Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat

				             AND ((v_Mvto.Tp_Atendimento = 'H' AND

                         Rela.Tp_Atend_Homecare = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'E' AND

                         Rela.Tp_Atend_Externo = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'U' AND

                         Rela.Tp_Atend_Urgeme = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'A' AND

                         Rela.Tp_Atend_Ambulatorial = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'I' AND

                         Rela.Tp_Atend_Internacao = 'S'))

                    AND Empresa_Con_Pla.Cd_Regra = Regra.Cd_Regra

                    AND Rela.Cd_Regra = Regra.Cd_Regra

                    AND RELA.DT_VIGENCIA IN

                     (SELECT MAX(VPR.DT_VIGENCIA)

                        FROM DBAMV.VAL_PRO_RELACIONADO VPR

                       WHERE VPR.DT_VIGENCIA <= Ddtreferencia

                         AND VPR.CD_REGRA = RELA.CD_REGRA

                         AND VPR.CD_PRO_FAT_PAI = RELA.CD_PRO_FAT_PAI

                         AND VPR.CD_PRO_FAT = RELA.CD_PRO_FAT)



					      UNION ALL



              SELECT Rela.Cd_Pro_Fat,

                         Rela.Tp_Atend_Homecare,

                         Rela.Tp_Atend_Externo,

                         Rela.Tp_Atend_Urgeme,

                         Rela.Tp_Atend_Ambulatorial,

                         Rela.Tp_Atend_Internacao,

                         Rela.Sn_Faturamento_Direto,

                         Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

                FROM DBAMV.REGRA,

                     DBAMV.VAL_PRO_RELACIONADO RELA,

                     DBAMV.EMPRESA_CON_PLA --,



               WHERE EMPRESA_CON_PLA.CD_MULTI_EMPRESA = DBAMV.PKG_MV2000.LE_EMPRESA

                 AND RELA.CD_PRO_FAT_PAI IS NULL

                 AND RELA.CD_GRU_PRO_PAI = (SELECT P.CD_GRU_PRO

                                              FROM DBAMV.PRO_FAT P

                                             WHERE CD_PRO_FAT = V_PROCED.CD_PRO_FAT)

                 AND EMPRESA_CON_PLA.CD_CONVENIO = V_MVTO.CD_CONVENIO

                 AND EMPRESA_CON_PLA.CD_CON_PLA = V_MVTO.CD_CON_PLA

                 AND RELA.TP_LANCAMENTO = 'A'

                 AND ((V_MVTO.TP_ATENDIMENTO = 'H' AND RELA.TP_ATEND_HOMECARE = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'E' AND RELA.TP_ATEND_EXTERNO = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'U' AND RELA.TP_ATEND_URGEME = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'A' AND RELA.TP_ATEND_AMBULATORIAL = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'I' AND RELA.TP_ATEND_INTERNACAO = 'S'))

                 AND EMPRESA_CON_PLA.CD_REGRA = REGRA.CD_REGRA

                 AND RELA.CD_REGRA = REGRA.CD_REGRA

                 AND RELA.DT_VIGENCIA IN

                     (SELECT MAX(VPR.DT_VIGENCIA)

                        FROM DBAMV.VAL_PRO_RELACIONADO VPR

                       WHERE VPR.DT_VIGENCIA <= Ddtreferencia

                         AND VPR.CD_REGRA = RELA.CD_REGRA

                          AND VPR.CD_GRU_PRO_PAI = RELA.CD_GRU_PRO_PAI

                          AND VPR.CD_PRO_FAT = RELA.CD_PRO_FAT

                      );

                -- PDA 105921 -- (Fim)

                --PDA 97407 - Eduardo Santis 08/07/2004 - (Fim)

                Cretorno VARCHAR2(1);

              BEGIN

                FOR Rec_Rela IN c_Relacionados

                LOOP

                  -- PDA 162402 (In?o) 20/03/2007 - Pedro Neiva(Apply)

                  IF Nvl(v_Mvto.Sn_Lanca_Consignado_Na_Conta, 'S') = 'N' AND

                     Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'S' THEN

                    IF Rec_Rela.Sn_Faturamento_Direto = 'S' THEN

                      Ncdlcto := 0;

                      Bflag   := TRUE;

                    ELSIF Rec_Rela.Sn_Faturamento_Direto = 'N' THEN

                      Bflag := FALSE;

                    END IF;

                  END IF;

                  IF Bflag THEN

                    -- PDA 162402 (Fim) 20/03/2007 - Pedro Neiva(Apply)

                    Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(v_Mvto.Cd_Atendimento,

                                                                  Ncdregfat,

                                                                  Ncdlcto,

                                                                  Ncdmvtoestoque,

                                                                  v_Proced.Cd_Pro_Fat

                                                                  /*PDA 116436 14/03/2005 Sp?ola(INICIO)

                                                                                                                                    A data de passagem de parametro deve ser ddtreferencia utilizado no insert da fun?*/,

                                                                  Ddtreferencia

                                                                  /*PDA 116436 (FIM)*/,

                                                                  v_Mvto.Hr_Mvto_Estoque,

                                                                  v_Mvto.Cd_Setor,

                                                                  v_Mvto.Tp_Mvto_Estoque,

                                                                  v_Mvto.Tp_Atendimento,

                                                                  NULL /*PDA 116436 14/03/2005 Sp?ola - Parametro dt_atendimento n?utilizado pela fun?*/,

                                                                  Ncdconvconta,

                                                                  Ncdplanconta,

                                                                  NULL,

                                                                  NULL /*PDA 116436 14/03/2005 Sp?ola - Parametro tp_convenio n?utilizado pela fun?*/,

                                                                  v_Mvto.Dt_Alta,

                                                                  Rec_Rela.Cd_Pro_Fat, --PDA 108042 22/11/2004 Sp?ola (INICIO)

                                                                  --As quantidades lan?a ser?ultiplicadas pelo fator de quantidade qt_lancamento



                                                                  Rec_Rela.Qt_Lancamento *

                                                                  Nvl(Nqtconv,

                                                                      Nqtprofat),

                                                                  Rec_Rela.Qt_Lancamento *

                                                                  Nvl(Nqtconv,

                                                                      Nqtprofat), --PDA 108042 (FIM)

                                                                  Vaction

                                                                  --PDA 108070 29/12/2004 Sp?ola (INICIO)

                                                                  --Inserido o campo do prestador que ser?tilizado apenas para os procedimentos relacionados de ambulatorio

                                                                  --lancadados pela prc_ffcv_lanca_atendimento - lancamento automatico do procedimento principal na criacao do atendimento

                                                                 ,

                                                                  NULL --cd_prestador

                                                                  --PDA 108070 (FIM)

                                                                  -- pda 119975 - 29/05/2005 - Amalia Ara??

                                                                  -- par?tro de fator relacionado para insert nas tabelas itreg_amb e itreg_fat

                                                                 ,

                                                                  Rec_Rela.Qt_Lancamento

                                                                  -- pda 119975 - fim

                                                                  );

                  END IF; --PDA 162402 - 20/03/2007 - Pedro Neiva(Apply)

                END LOOP;

              END;

              /* pda 330243 - 09/12/2009 - Amalia Ara??

              O cliente 759 n?trabalha com percentual consignado porque a tabela n?

               multi-empresa, mas precisa valorizar os Dados da Nota pela guia de OPME. */

              IF Nvl(Nqtdregpercconsig, 0) > 0 THEN

                --IF ( NVL (nqtdregpercconsig, 0) > 0 ) OR

                --   ( NVL (nqtdregpercconsig, 0) = 0 AND dbamv.pkg_mv2000.le_cliente = 759 and

                --   cprodorteseprotese.cd_pro_fat IS NOT NULL ) THEN

                /* pda 330243 - fim */

                -- pda 115637 - 14/02/2005 - Amalia Ara??

                -- Colocados NVL para n?tentar gravar com valores nulos em colunas NOT NULL.

                -- Isto estava ocorrendo em produtos consignados que ainda n?tem informa? na

                -- tabela dbamv.produto_ultimas_compras.   orienta? de T?io.

                --PDA 162402(In?o) - 20/03/2007 - Pedro Neiva(Apply)

                IF (Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'N' OR

                   (Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'S' AND

                   Nvl(v_Mvto.Sn_Lanca_Consignado_Na_Conta, 'S') = 'S')) THEN

                  --PDA 162402(Fim) - 20/03/2007 - Pedro Neiva(Apply)

                  -- pda ( Inicio ) 196459

                  --

                  OPEN Cvalguia(v_Proced.Cd_Pro_Fat,

                                v_Mvto.Cd_Atendimento,

                                Ncdfornec,

                                Ncdguia); /*pda 427112*/

                  FETCH Cvalguia

                    INTO Vcvalguia;

                  CLOSE Cvalguia;

                  OPEN Clancvalguia;

                  FETCH Clancvalguia

                    INTO Vclancvalguia;

                  IF Clancvalguia%FOUND AND

                     Nvl(Vcvalguia.Vl_Unitario, 0) > 0 AND

                     Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'N' -- pda 234939 - Pedro Neiva - 09/10/2008

                   THEN

                    /* pda 321502 - 18/11/2009 - Acerto no valor total do item considerando a qtde do item na conta. */

                    INSERT INTO Dbamv.Itcob_Pre

                      (Cd_Reg_Fat,

                       Cd_Lancamento,

                       Vl_Preco_Unitario,

                       Vl_Preco_Total,

                       Cd_Fornecedor,

                       Tp_Valorizacao) -- pda 253547

                    VALUES

                      (Nvl(nConta, nCdRegFat), /* Ncdregfat OP 43289 */

                       Nvl(nLanc, Ncdlcto), /* Ncdlcto OP 43289 */

                       Vcvalguia.Vl_Unitario,

                       (Vcvalguia.Vl_Unitario * Nvl(Nqtconv, Nqtprofat)) /* pda 321502 - ,vcValGuia.vl_total_autorizado*/,

                       Nvl(Ncdfornecedor, Ncdfornec) -- nCdFornecedor  -- pda 115637

                      ,

                       'L' -- pda 253547

                       );

                    /* pda 321502 - fim */

                  ELSE

                    -- Pda 200497 (In?o) 06/09/2007

                    /* pda 304235 - Thiago Miranda de Oliveira - Na Clinica S??icente  a vari?l nqtdregpercconsig que e justamente a que vai dizer se

                    vai entrar nessas valida?s abaixo, vem sempre carregada, pois no cadastro de percentual de consignado para todos os

                    convenios foi colocado o percentual zero, para poder preencher os dados da nota, sendo que sempre estava carregando as informa?s

                    de entrada da nota fiscal, e na verdade deveria pegar os valores que est?na tela de guias. Com isso nesta valida? que

                    ja existia para o cliente moinhos de vento, foi adicionado o c??o 338 para a clinica S??icente, para preencher os dados da nota

                    na tela do faturamento com valores zerados, que depois ser?carregados na tela de guias.*/

                    IF Vcdhospital IN (429, 338) THEN

                      Npreco_Unitario_Opme := 0;

                      Npreco_Total_Opme    := 0;

                    ELSE

                      -- if v_mvto.sn_lanca_consignado_na_conta = 'S'  then -- pda 234939 - Pedro Neiva - 02/07/2008

                      IF Vcsnfaturadireta.Sn_Fatura_Direto = 'S' THEN

                        Npreco_Unitario_Opme := 0;

                        Npreco_Total_Opme    := 0;

                      ELSE

                        Npreco_Unitario_Opme := Nvl(Nvlunitconsig, 0);

                        Npreco_Total_Opme    := Nvl(Nvlunitconsig *

                                                    Nqtprofat,

                                                    1);

                      END IF;

                      -- pda 234939(In?o) - Pedro Neiva - 02/07/2008

                      /*

                      else

                                                   npreco_unitario_opme := NVL (nvlunitconsig, 0);

                                                   npreco_total_opme    := NVL (nvlunitconsig * nqtprofat, 1);

                                              end if;

                                              */

                      -- pda 234939(Fim)

                    END IF;

                    -- Pda 200497 (Fim) 06/09/2007

                    --PDA 162402(Fim) - 20/03/2007 - Pedro Neiva(Apply)



                    -- OP 34293 - 20/11/2015 - Se estiver configurado para valorizar pela tab_fat, e o npreco_unitario_opme for zero, n?inserir itboc_pre.

                    IF Nvl(vsnregrconsig,'N') = 'S' AND Nvl(npreco_unitario_opme,0) = 0 THEN

                      NULL;

                    ELSE

                    -- OP 34293 - fim

                      INSERT INTO Dbamv.Itcob_Pre

                        (Cd_Reg_Fat,

                        Cd_Lancamento,

                        Vl_Preco_Unitario,

                        Vl_Preco_Total,

                        Cd_Fornecedor,

                        Tp_Valorizacao,              -- pda 253547

			            vl_taxa_consignado           -- OP 36996

                        )

                      VALUES

                        (Nvl(nConta, Ncdregfat), /* Ncdregfat OP 43289  */

                        Nvl(nLanc, Ncdlcto), /* Ncdlcto OP 43289 */

                        Npreco_Unitario_Opme,

                        Npreco_Total_Opme,

                        Nvl(Ncdfornecedor, Ncdfornec),

                        'L',

						nVlTaxaConsig                -- OP 36996

                        );

                    END IF;

                  END IF;

                  CLOSE Clancvalguia;

                  --

                  -- pda ( Fim ) 196459

                  -- pda 115637 - fim

                END IF; --PDA 162402 - 20/03/2007 - Pedro Neiva(Apply)

              END IF;

            ELSE

              --Ambulatorial

              --PDA 99802 21/07/2004 Sp?ola (INICIO)

              --Abertura do cursor utilizado para recuperar a data de sess?do atendimento

              OPEN Catendsessao(v_Mvto.Cd_Atendimento);

              FETCH Catendsessao

                INTO Vcatendsessao;

              CLOSE Catendsessao;

              --PDA 99802 (FIM)

              IF Limite <> 1 THEN

                --PDA 162402(In?o) - 20/03/2007 - Pedro Neiva(Apply)

                IF (Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'N' OR

                   (Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'S' AND

                   Nvl(v_Mvto.Sn_Lanca_Consignado_Na_Conta, 'S') = 'S')) THEN

                  --PDA 162402(Fim) - 20/03/2007 - Pedro Neiva(Apply)

                  /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

                  que o procedimento que ira ser inserido abaixo pertence a um pacote, e a qunatidade que sera inserida sera menor que a lan?a, a diferen?

                  sera lan?a na rotina mais abaixo atravez da procedure PRC_DESVINCULA_PROCEDIMENTO*/

                  /* OP 387 - Thiago Miranda - fazendo tratamento caso o procedimento esteja configurado no gabarito para ser inserido dentro de uma conta particular

                  caso a variavel vTpContaPart esteja preenchida e a quantidade de lan?ento extra esteja nula. com iso deve ser procurado uma conta particular

                  e um lan?ento para inseririr nesta conta.*/

                  Nconta := NULL;

                  Nlanc  := NULL;

				/*43289 - quebra de conta por quantidade de procedimento por atendimento*/

				/*A regra de pacote tem prioridade sobre essa regra, conforme vari?l Nqtexcedeu abaixo*/

				IF Nqtexcedeu IS NULL THEN

				    if (not vSnCriouContaAutoAmb) then /*OP 46768*/

						  IF DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_EXISTE_CONF_QTD_ATEND_PAC(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

                                                                                             v_proced.cd_pro_fat,

                                                                                             pEmpresa) THEN



				    	      Nqtexcedeu := DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_RETORNA_QTD_LANC_PERIODO(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																										   v_proced.cd_pro_fat,

																										   pEmpresa,

																										   ncdregamb,

																										   nvl(nqtconv, nQtProFat),

																										   pSnChamadoDaTela,

																										   pvSnJaExcedeuQtd,

																										   pvMensagem

																										   );

							  IF pvSnJaExcedeuQtd = 'S' THEN

								  Vtpcontapart := 'ProcPorAtend';

								  Nqtexcedeu   := NULL;

							  ELSE

									IF NVL(Nqtexcedeu,0) > 0 THEN

										Vtpcontapart := 'ProcPorAtend';

									END IF;

							  END IF;

					    END IF;

					END IF;/*OP 46768*/

                END IF;

		        /*43289*/

                  IF Nvl(Vtpcontapart, 'X') <> 'X' AND Nqtexcedeu IS NULL THEN

                    Nconta := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                             v_Mvto.Cd_Atendimento));

                    OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Nconta);

                    FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                      INTO Nlanc;

                    CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;



                    /*43289*/

                    ncdconvconta := v_particular.cd_convenio;

                    ncdplanconta := v_particular.cd_con_pla;

					/*43289*/



                  END IF;

                  INSERT INTO Dbamv.Itreg_Amb

                    (Cd_Reg_Amb,

                     Cd_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Cd_Atendimento,

                     Cd_Con_Pla,

                     Cd_Convenio,

                     Sn_Fatura_Impressa,

                     Sn_Fechada,

                     Sn_Conta_Calculada,

                     Cd_Guia,

                     Sn_Pertence_Pacote,

                     Vl_Percentual_Multipla,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto, --PDA 99802 09/07/2004 Sp?ola (INICIO) (Comentario mais abaixo)

                     Dt_Sessao,

                     Cd_Itmvto -- pda 114164

                     -- PDA 170696 (Inicio) - Henrique Antunes - 23/11/2006

                    ,

                     Cd_Padrao,

                     Cd_Conta_Kit

                     -- PDA 170696 (Fim)

                     -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                    ,

                     Cd_Conta_Pacote

                     -- PDA 157145 (Fim)

                     -- PDA 353315(In?o)

                    ,

                     Cd_Reg_Amb_Rel,

                     Cd_Lancamento_Rel

                     -- PDA 353315(fim)

                     ,cd_regra_substituicao_proced

                     )

                  --PDA 99802 (FIM)

                  VALUES

                    (Nvl(Nconta, Ncdregamb) -- OP 387

                    ,

                     Nvl(Nlanc, Ncdlcto) -- OP 387

                    ,

                     Nvl(Ddtreferencia, v_Mvto.Hr_Mvto_Estoque) -- PDA 550968

                    ,

                     Nvl(Nqtexcedeu, Nvl(Nqtconv, Nqtprofat)) -- OP 387

                    ,

                     v_Grfat.Cd_Gru_Fat,

                     v_Proced.Cd_Pro_Fat,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     Ncdplanconta,

                     Ncdconvconta,

                     'N',

                     'N',

                     'N',

                     Ncdguia,

                     Nvl(Csnpacote, 'N'),

                     100,

                     v_Mvto.Cd_Setor,

                     v_Mvto.Cd_Setor,

                     'N',

                     USER,

                     Ncdmvtoestoque,

                     Nvl(Vtpcontapart, 'Produto') -- OP 387

                    , --PDA 99802 09/07/2004 Sp?ola (INICIO)

                     --Se o quantidade de sesS??for maior que zero e o atendimento filho for de retorno,

                     --preencher a data da sessao com a data do atendimento filho.

                     Decode(Vcatendsessao.Sn_Retorno,

                            'N',

                            NULL,

                            Decode(Vcatendsessao.Qt_Sessoes,

                                   0,

                                   NULL,

                                   Vcatendsessao.Dt_Atendimento))

                     --PDA 99802 (FIM)

                    ,

                     Ncditemmvto -- pda 114164

                     -- PDA 170696 (Inicio) - Henrique Antunes - 23/11/2006

                    ,

                     Ncdpadrao,

                     Ncdcontakit

                     -- PDA 170696 (Fim)

                     -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                    ,

                     Ncdpacote

                     -- PDA 157145 (Fim)

                     -- PDA 353315(In?o)

                    ,

                     Rexamerelacionado.Cd_Reg_Amb_Rel,

                     Rexamerelacionado.Cd_Lancamento_Rel

                     -- PDA 353315(fim)

                     ,nRegraSubstituicao

                     );

                  /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

                  que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

                  os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

                  IF Nqtexcedeu IS NOT NULL THEN

                    Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregamb,

                                                                        Ncdlcto,

                                                                        (Nvl(Nqtconv,

                                                                             Nqtprofat) -

                                                                        Nqtexcedeu),

                                                                        Vtpcontapart,

                                                                        v_Mvto.Hr_Mvto_Estoque,

																		 nvl(v_mvto.cd_atendimento_pai,v_mvto.cd_atendimento)); /*ALLS OP 43289*/

                  END IF;



				  -- FATURCONV 1260

                  DBAMV.PRC_FFCV_COMPOE_APRES_PRODUTO('A',Ncdregamb, Ncdlcto, Ncdproduto, Nvl(Nqtmovnew,Nqtmovold));



                  /* OP 387 - Thiago Miranda de oliveira - este trecho de c??o somente sera utilizado se a configura? de gerar o item em conta de particular

                  por causa do pacote, n?estiver preenchido*/

                  IF Nvl(Vtpcontapart, 'X') = 'X' THEN

                    -- PDA 197953 (In?o) - 08/08/2007 - Diego Costa

                    -- inclus?de verifica? a regra de atendimento pro_fat antes da regra de acoplamaneto

                    IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Ambu(Ncdregamb,

                                                                  Ncdlcto,

                                                                  'I') THEN

                      IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Ambu(Ncdregamb,

                                                                    Ncdlcto,

                                                                    'I') THEN

                        Verif_Franquia_Ambu(Ncdregamb, Ncdlcto);

                      END IF;

                    END IF;

                    -- PDA 197953 (Fim)

                  END IF;

                END IF; -- PDA 162402 -20/03/2007 - Pedro Neiva(Apply)

              END IF;

              IF v_Mvto.Tp_Convenio <> 'P' AND Nvl(Nqtpart, 0) > 0 AND

                 Ctpproibicao = 'AG' THEN

                Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(v_Mvto.Cd_Atendimento);

                -- PDA 139897 (In?o) - Atribuindo convenio e plano particular, pois antes

                -- estava passando o convenio e o plano do atendimento (convenio).

                Ncdconvconta := v_Particular.Cd_Convenio;

                Ncdplanconta := v_Particular.Cd_Con_Pla;

                -- PDA 139897 (Fim)

                --PDA 162402(In?o) - 20/03/2007 - Pedro Neiva(Apply)

                IF (Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'N' OR

                   (Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'S' AND

                   Nvl(v_Mvto.Sn_Lanca_Consignado_Na_Conta, 'S') = 'S')) THEN

                  --PDA 162402(Fim) - 20/03/2007 - Pedro Neiva(Apply)

                  INSERT INTO Dbamv.Itreg_Amb

                    (Cd_Reg_Amb,

                     Cd_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Cd_Atendimento,

                     Cd_Con_Pla,

                     Cd_Convenio,

                     Sn_Fatura_Impressa,

                     Sn_Fechada,

                     Sn_Conta_Calculada,

                     Cd_Guia,

                     Sn_Pertence_Pacote,

                     Vl_Percentual_Multipla,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto, --PDA 99802 09/07/2004 Sp?ola (INICIO) (Comentario mais abaixo)

                     Dt_Sessao,

                     Cd_Itmvto

                     -- PDA 170696 (Inicio) - Henrique Antunes - 23/11/2006

                    ,

                     Cd_Padrao,

                     Cd_Conta_Kit

                     -- PDA 170696 (Fim)

                     -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                    ,

                     Cd_Conta_Pacote

                     -- PDA 157145 (Fim)

                     -- PDA 353315(In?o)

                    ,

                     Cd_Reg_Amb_Rel,

                     Cd_Lancamento_Rel

                     -- PDA 353315(fim)

                     ,cd_regra_substituicao_proced

                     )

                  --PDA 99802 (FIM)

                  VALUES

                    (Ncdregamb,

                     Ncdlcto,

                     v_Mvto.Hr_Mvto_Estoque,

                     Nqtpart,

                     v_Grfat.Cd_Gru_Fat,

                     v_Proced.Cd_Pro_Fat,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     Ncdplanconta,

                     Ncdconvconta,

                     'N',

                     'N',

                     'N',

                     Ncdguia,

                     Nvl(Csnpacote, 'N'),

                     100,

                     v_Mvto.Cd_Setor,

                     v_Mvto.Cd_Setor,

                     'N',

                     USER,

                     Ncdmvtoestoque,

                     'Produto', --PDA 99802 09/07/2004 Sp?ola (INICIO)

                     --Se o quantidade de sesS??for maior que zero e o atendimento filho for de retorno,

                     --preencher a data da sessao com a data do atendimento filho.

                     Decode(Vcatendsessao.Sn_Retorno,

                            'N',

                            NULL,

                            Decode(Vcatendsessao.Qt_Sessoes,

                                   0,

                                   NULL,

                                   Vcatendsessao.Dt_Atendimento))

                     --PDA 99802 (FIM)

                    ,

                     Ncditemmvto -- pda 114164

                     -- PDA 170696 (Inicio) - Henrique Antunes - 23/11/2006

                    ,

                     Ncdpadrao,

                     Ncdcontakit

                     -- PDA 170696 (Fim)

                     -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                    ,

                     Ncdpacote

                     -- PDA 157145 (Fim)

                     --PDA 353315(In?o)

                    ,

                     Rexamerelacionado.Cd_Reg_Amb_Rel,

                     Rexamerelacionado.Cd_Lancamento_Rel

                     --PDA 353315(fim)

                     ,nRegraSubstituicao

                     );

                END IF; -- PDA 162402 -20/03/2007 - Pedro Neiva(Apply)

              END IF;



              /*OP 42241 - Caso tenha criado a conta por cargo paciente, devemos lan? o item para o convenio, plano, percentual definido na configura

              de quebra de conta por cargo paciente*/

              IF (vSnCriouContaAutoAmbCP) THEN

                   OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(v_ContaCargoPacAmbu(1).cd_reg_amb);

                   FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                      INTO NcdlctoAmbCp;

                   CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;



                   INSERT INTO Dbamv.Itreg_Amb

                    (Cd_Reg_Amb,

                     Cd_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Cd_Atendimento,

                     Cd_Con_Pla,

                     Cd_Convenio,

                     Sn_Fatura_Impressa,

                     Sn_Fechada,

                     Sn_Conta_Calculada,

                     Cd_Guia,

                     Sn_Pertence_Pacote,

                     Vl_Percentual_Multipla,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto,

                     Dt_Sessao,

                     Cd_Itmvto,

                     Cd_Reg_Amb_Rel,

                     Cd_Lancamento_Rel ,

                     cd_regra_substituicao_proced

                     )

                  VALUES

                    (v_ContaCargoPacAmbu(1).cd_reg_amb,

                     NcdlctoAmbCp,

                     v_Mvto.Hr_Mvto_Estoque,

                     Nvl(Nqtexcedeu, Nvl(Nqtconv, Nqtprofat)),

                     v_Grfat.Cd_Gru_Fat,

                     v_Proced.Cd_Pro_Fat,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                     vRegraCriaContaAutoCP(1).cd_convenio_destino,

                     'N',

                     'N',

                     'N',

                     Ncdguia,

                     'N',

                     vRegraCriaContaAutoCP(1).vl_percentual_carga_familiar,

                     v_Mvto.Cd_Setor,

                     v_Mvto.Cd_Setor,

                     'N',

                     USER,

                     Ncdmvtoestoque,

                     'Produto',

                     Decode(Vcatendsessao.Sn_Retorno,

                            'N',

                            NULL,

                            Decode(Vcatendsessao.Qt_Sessoes,

                                   0,

                                   NULL,

                                   Vcatendsessao.Dt_Atendimento)),

                     Ncditemmvto,

                     Rexamerelacionado.Cd_Reg_Amb_Rel,

                     Rexamerelacionado.Cd_Lancamento_Rel

                     ,nRegraSubstituicao

                     );

              END IF;

              /*OP 42241*/



              -- /* Lancamento dos Valores Relacionados */ --

              DECLARE

                 CURSOR c_Relacionados IS

                  SELECT Rela.Cd_Pro_Fat,

                         Rela.Tp_Atend_Homecare,

                         Rela.Tp_Atend_Externo,

                         Rela.Tp_Atend_Urgeme,

                         Rela.Tp_Atend_Ambulatorial,

                         Rela.Tp_Atend_Internacao,

                         Rela.Sn_Faturamento_Direto,

                         Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

                    FROM Dbamv.Regra,

                         Dbamv.Val_Pro_Relacionado Rela,

                         Dbamv.Empresa_Con_Pla

                   WHERE Empresa_Con_Pla.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

                     AND Rela.Tp_Lancamento = 'A'

                     AND EMPRESA_CON_PLA.CD_CONVENIO = V_MVTO.CD_CONVENIO

                     AND EMPRESA_CON_PLA.CD_CON_PLA = V_MVTO.CD_CON_PLA

                     AND Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat

				             AND ((v_Mvto.Tp_Atendimento = 'H' AND

                         Rela.Tp_Atend_Homecare = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'E' AND

                         Rela.Tp_Atend_Externo = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'U' AND

                         Rela.Tp_Atend_Urgeme = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'A' AND

                         Rela.Tp_Atend_Ambulatorial = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'I' AND

                         Rela.Tp_Atend_Internacao = 'S'))

                    AND Empresa_Con_Pla.Cd_Regra = Regra.Cd_Regra

                    AND Rela.Cd_Regra = Regra.Cd_Regra

                    AND RELA.DT_VIGENCIA IN

                     (SELECT MAX(VPR.DT_VIGENCIA)

                        FROM DBAMV.VAL_PRO_RELACIONADO VPR

                       WHERE VPR.DT_VIGENCIA <= Ddtreferencia

                         AND VPR.CD_REGRA = RELA.CD_REGRA

                         AND VPR.CD_PRO_FAT_PAI = RELA.CD_PRO_FAT_PAI

                         AND VPR.CD_PRO_FAT = RELA.CD_PRO_FAT)



					      UNION ALL



              SELECT Rela.Cd_Pro_Fat,

                         Rela.Tp_Atend_Homecare,

                         Rela.Tp_Atend_Externo,

                         Rela.Tp_Atend_Urgeme,

                         Rela.Tp_Atend_Ambulatorial,

                         Rela.Tp_Atend_Internacao,

                         Rela.Sn_Faturamento_Direto,

                         Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

                FROM DBAMV.REGRA,

                     DBAMV.VAL_PRO_RELACIONADO RELA,

                     DBAMV.EMPRESA_CON_PLA --,



               WHERE EMPRESA_CON_PLA.CD_MULTI_EMPRESA = DBAMV.PKG_MV2000.LE_EMPRESA

                 AND RELA.CD_PRO_FAT_PAI IS NULL

                 AND RELA.CD_GRU_PRO_PAI = (SELECT P.CD_GRU_PRO

                                              FROM DBAMV.PRO_FAT P

                                             WHERE CD_PRO_FAT = V_PROCED.CD_PRO_FAT)

                 AND EMPRESA_CON_PLA.CD_CONVENIO = V_MVTO.CD_CONVENIO

                 AND EMPRESA_CON_PLA.CD_CON_PLA = V_MVTO.CD_CON_PLA

                 AND RELA.TP_LANCAMENTO = 'A'

                 AND ((V_MVTO.TP_ATENDIMENTO = 'H' AND RELA.TP_ATEND_HOMECARE = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'E' AND RELA.TP_ATEND_EXTERNO = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'U' AND RELA.TP_ATEND_URGEME = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'A' AND RELA.TP_ATEND_AMBULATORIAL = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'I' AND RELA.TP_ATEND_INTERNACAO = 'S'))

                 AND EMPRESA_CON_PLA.CD_REGRA = REGRA.CD_REGRA

                 AND RELA.CD_REGRA = REGRA.CD_REGRA

                 AND RELA.DT_VIGENCIA IN

                     (SELECT MAX(VPR.DT_VIGENCIA)

                        FROM DBAMV.VAL_PRO_RELACIONADO VPR

                       WHERE VPR.DT_VIGENCIA <= Ddtreferencia

                         AND VPR.CD_REGRA = RELA.CD_REGRA

                          AND VPR.CD_GRU_PRO_PAI = RELA.CD_GRU_PRO_PAI

                          AND VPR.CD_PRO_FAT = RELA.CD_PRO_FAT

                      );

                -- PDA 105921 -- (Fim)

                Cretorno VARCHAR2(1);

                Lentrar  VARCHAR2(1) := 'N';

                --

              BEGIN

                --

                FOR Rec_Rela IN c_Relacionados

                LOOP

                  IF v_Mvto.Tp_Atendimento = 'U' AND

                     Rec_Rela.Tp_Atend_Urgeme = 'S' THEN

                    Lentrar := 'S';

                  ELSIF v_Mvto.Tp_Atendimento = 'E' AND

                        Rec_Rela.Tp_Atend_Externo = 'S' THEN

                    Lentrar := 'S';

                  ELSIF v_Mvto.Tp_Atendimento = 'A' AND

                        Rec_Rela.Tp_Atend_Ambulatorial = 'S' THEN

                    Lentrar := 'S';

                  END IF;

                  --

                  IF Lentrar = 'S' THEN

                    --

                    -- PDA 162402 (In?o) 20/03/2007 - Pedro Neiva(Apply)

                    IF Nvl(v_Mvto.Sn_Lanca_Consignado_Na_Conta, 'S') = 'N' AND

                       Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'S' THEN

                      IF Rec_Rela.Sn_Faturamento_Direto = 'S' THEN

                        Ncdlcto := 0;

                        Bflag   := TRUE;

                      ELSIF Rec_Rela.Sn_Faturamento_Direto = 'N' THEN

                        Bflag := FALSE;

                      END IF;

                    END IF;

                    IF Bflag THEN

                      -- PDA 162402 (Fim) 20/03/2007 - Pedro Neiva(Apply)

                      Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(v_Mvto.Cd_Atendimento,

                                                                    Ncdregamb,

                                                                    Ncdlcto,

                                                                    Ncdmvtoestoque,

                                                                    v_Proced.Cd_Pro_Fat

                                                                    /*PDA 202951(inicio) - 14/07/2009 - Jansen Gallindo

                                                                                                                                       ,v_mvto.dt_mvto_estoque

                                                                                                                                       ,v_mvto.hr_mvto_estoque*/,

                                                                    Ddtreferencia,

                                                                    Ddtreferencia

                                                                    /*PDA 202951(fim)*/,

                                                                    v_Mvto.Cd_Setor,

                                                                    v_Mvto.Tp_Mvto_Estoque,

                                                                    v_Mvto.Tp_Atendimento,

                                                                    NULL /*PDA 116436 14/03/2005 Sp?ola - Parametro tp_convenio n?utilizado pela fun?*/,

                                                                    Ncdconvconta, --Nvl( Nvl( V_ContaAmbu.cd_convenio, V_AmbuPart.cd_convenio ), V_Mvto.cd_convenio ) ,

                                                                    Ncdplanconta, --V_Mvto.cd_con_pla    ,

                                                                    NULL

                                                                    /*nCd_atendimento_pai*/,

                                                                    NULL /*PDA 116436 14/03/2005 Sp?ola - Parametro tp_convenio n?utilizado pela fun?*/,

                                                                    v_Mvto.Dt_Alta,

                                                                    Rec_Rela.Cd_Pro_Fat, --PDA 108042 22/11/2004 Sp?ola (INICIO)

                                                                    --As quantidades lan?a ser?ultiplicadas pelo fator de quantidade qt_lancamento

                                                                    Rec_Rela.Qt_Lancamento *

                                                                    Nvl(Nqtconv,

                                                                        Nqtprofat),

                                                                    Rec_Rela.Qt_Lancamento *

                                                                    Nvl(Nqtconv,

                                                                        Nqtprofat), --PDA 108042 (FIM)

                                                                    Vaction

                                                                    --PDA 108070 29/12/2004 Sp?ola (INICIO)

                                                                    --Inserido o campo do prestador que ser?tilizado apenas para os procedimentos relacionados de ambulatorio

                                                                    --lancadados pela prc_ffcv_lanca_atendimento - lancamento automatico do procedimento principal na criacao do atendimento

                                                                   ,

                                                                    NULL --cd_prestador

                                                                    --PDA 108070 (FIM)

                                                                    -- pda 119975 - 29/05/2005 - Amalia Ara??

                                                                    -- par?tro de fator relacionado para insert nas tabelas itreg_amb e itreg_fat

                                                                   ,

                                                                    Rec_Rela.Qt_Lancamento

                                                                    -- pda 119975 - fim

                                                                    );

                    END IF; --PDA 162402 - 20/03/2007 - Pedro Neiva(Apply)

                  END IF;

                END LOOP;

              END;

              /* pda 330243 - 09/12/2009 - Amalia Ara??

              O cliente 759 n?trabalha com percentual consignado porque a tabela n?

               multi-empresa, mas precisa valorizar os Dados da Nota pela guia de OPME. */

              IF Nvl(Nqtdregpercconsig, 0) > 0 THEN

                --IF ( NVL (nqtdregpercconsig, 0) > 0 ) OR

                --   ( NVL (nqtdregpercconsig, 0) = 0 AND dbamv.pkg_mv2000.le_cliente = 759 and

                --     cprodorteseprotese.cd_pro_fat IS NOT NULL ) THEN

                /* pda 330243 - fim */

                -- pda 115637 - 14/02/2005 - Amalia Ara??

                -- Colocados NVL para n?tentar gravar com valores nulos em colunas NOT NULL.

                -- Isto estava ocorrendo em produtos consignados que ainda n?tem informa? na

                -- tabela dbamv.produto_ultimas_compras.   orienta? de T?io.

                --PDA 162402(In?o) - 20/03/2007 - Pedro Neiva(Apply)

                IF (Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'N' OR

                   (Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'S' AND

                   Nvl(v_Mvto.Sn_Lanca_Consignado_Na_Conta, 'S') = 'S')) THEN

                  --PDA 162402(Fim) - 20/03/2007 - Pedro Neiva(Apply)

                  -- pda ( Inicio ) 196459

                  --

                  OPEN Cvalguia(v_Proced.Cd_Pro_Fat,

                                v_Mvto.Cd_Atendimento,

                                Ncdfornec,

                                Ncdguia); /* tmdo 427112*/

                  FETCH Cvalguia

                    INTO Vcvalguia;

                  CLOSE Cvalguia;

                  OPEN Clancvalguia;

                  FETCH Clancvalguia

                    INTO Vclancvalguia;

                  IF Clancvalguia%FOUND AND

                     Nvl(Vcvalguia.Vl_Unitario, 0) > 0 AND

                     Nvl(Vcsnfaturadireta.Sn_Fatura_Direto, 'N') = 'N' -- pda 234939 - Pedro Neiva - 09/10/2008

                   THEN

                    /* pda 321502 - 18/11/2009 - Acerto no valor total do item considerando a qtde do item na conta. */

                    INSERT INTO Dbamv.Itcob_Pre_Ambu

                      (Cd_Reg_Amb,

                       Cd_Lancamento,

                       Vl_Preco_Unitario,

                       Vl_Preco_Total,

                       Cd_Fornecedor,

                       Tp_Valorizacao) -- pda 253547

                    VALUES



                      (NVL(nConta, nCdRegAmb), /*nCdRegAmb,  OP 43289*/

                       NVL(nLanc, nCdLcto), /* OP 43289 --nCdLcto */

                       Vcvalguia.Vl_Unitario,

                       (Vcvalguia.Vl_Unitario * Nvl(Nqtconv, Nqtprofat)) /* pda 321502 - ,vcValGuia.vl_total_autorizado*/,

                       Nvl(Ncdfornecedor, Ncdfornec),

                       'L'); -- pda 253547

                    /* pda 321502 - fim */

                  ELSE

                    -- Pda 200497 (In?o) 06/09/2007

                    --

                    IF Vcdhospital = 429 THEN

                      Npreco_Unitario_Opme := 0;

                      Npreco_Total_Opme    := 0;

                    ELSE

                      -- if v_mvto.sn_lanca_consignado_na_conta = 'S'  then -- pda 234939 - Pedro Neiva - 02/07/2008

                      IF Vcsnfaturadireta.Sn_Fatura_Direto = 'S' THEN

                        Npreco_Unitario_Opme := 0;

                        Npreco_Total_Opme    := 0;

                      ELSE

                        Npreco_Unitario_Opme := Nvl(Nvlunitconsig, 0);

                        Npreco_Total_Opme    := Nvl(Nvlunitconsig *

                                                    Nqtprofat,

                                                    1);

                      END IF;

                      -- pda 234939(In?o) - Pedro Neiva - 02/07/2008

                      /*

                      else

                                                   npreco_unitario_opme := NVL (nvlunitconsig, 0);

                                                   npreco_total_opme    := NVL (nvlunitconsig * nqtprofat, 1);

                                              end if;

                      */

                      -- pda 234939(Fim)

                    END IF;

                    -- Pda 200497 (Fim) 06/09/2007

                    -- OP 34293 - 20/11/2015 - Se estiver configurado para valorizar pela tab_fat, e o npreco_unitario_opme for zero, n?inserir itboc_pre_ambu.

                    IF Nvl(vsnregrconsig,'N') = 'S' AND Nvl(Npreco_Unitario_Opme,0) = 0 THEN

                      NULL;

                    ELSE

                    -- OP 34293 - fim

                      INSERT INTO Dbamv.Itcob_Pre_Ambu

                        (Cd_Reg_Amb,

                        Cd_Lancamento,

                        Vl_Preco_Unitario,

                        Vl_Preco_Total,

                        Cd_Fornecedor,

                        Tp_Valorizacao,           -- pda 253547

						vl_taxa_consignado        -- OP 36996

						)

                      VALUES



                        (NVL(nConta, Ncdregamb), /*Ncdregamb,  OP 43289*/

                        NVL(nLanc, Ncdlcto), /* OP 43289 --Ncdlcto */

                        Npreco_Unitario_Opme,

                        Npreco_Total_Opme,

                        Nvl(Ncdfornecedor, Ncdfornec) --nCdFornecedor  -- pda 115637

                        ,

                        'L',                         -- pda 253547

						nVlTaxaConsig                -- OP 36996

						);

                      -- pda 115637 - fim

                    END IF;

                  END IF;

                  CLOSE Clancvalguia;

                  --

                  -- pda ( Fim ) 196459

                  -- pda 115637 - fim

                END IF; --PDA 162402 - 20/03/2007 - Pedro Neiva(Apply)

              END IF;

            END IF;

          ELSE

            /* Inicia processo de devolu? */

            -- PDA 170696 (Inicio) - Henrique Antunes - 23/11/2006

            IF Nvl(Csndevolverkit, 'S') = 'N' THEN

              RETURN Cgravaatend;

            END IF;

            -- PDA 170696 (Fim)

            IF Nvl(Nqtdevolvido, 0) = 0 THEN

              -- Se n?for um lan?ento com proibi? do tipo autorizado por guia

              IF Nvl(Nqtmovnew, 0) = 0 THEN

                Nqtpart := 0;

                -- multiplicar pelo fator da unidade e dividir pelo fator do produto, para se ter o valor exato p/ exclus?

                Nqtconv := Round((Nqtmovold * v_Fator.Vl_Fator) / v_Proced.Vl_Fator_Pro_Fat);

                -- OP 48707 - 10/08/2017 - N?deve considerar o c?ulo acima que desfaz o que j?oi calculado com o fator da regra de substitui?.

	            Nqtconv := Nqtprofat;

              ELSE

                Nqtpart := 0;

                Nqtconv := Round((Nqtmovnew * v_Fator.Vl_Fator) / v_Proced.Vl_Fator_Pro_Fat);

                -- OP 48707 - 10/08/2017 - N?deve considerar o c?ulo acima que desfaz o que j?oi calculado com o fator da regra de substitui?.

	            Nqtconv := Nqtprofat;

              END IF;

              --

              IF Nvl(Nqtconv, 0) = 0 THEN

                Nqtconv := 1;

              END IF;

              --

              -- Pda 123849 (Inicio) -- Carlos Diego -- 13/06/2005

              -- Verificando se o procedimento e n?autorizado

              IF Ctpproibicao = 'NA' THEN

                Nqtpart := Nqtconv;

                Nqtconv := 0;

              END IF;

              -- Pda 123849 (Fim)

            END IF;

            --

            Vfim := 0;

            --

            IF Nqtpart > 0 THEN

              -- Indica que ha lan?entos na conta-particular

              Vfim := Vfim + 1;

            END IF;

            --

            IF Nqtconv > 0 THEN

              -- Indica que ha lan?entos na conta-convenio

              Vfim := Vfim + 1;

            END IF;

            --

            FOR Vindex IN 1 .. Vfim

            LOOP

              -- In?o do loop que trata da devolu? de itens para o estoque

              Pcd_Mvto := Ncdmvtoestoque;

              IF Deleting AND Nqtprofat = 1 THEN

                Nqtprofat := 0;

                IF Nqtpart > 0 THEN

                  Noldqtprofat := Nqtpart;

                  Nqtpart      := 0;

                  p_Conv       := v_Particular.Cd_Convenio; -- Indica o c??o do convenio da conta-particular

                ELSIF Nqtconv > 0 THEN

                  Noldqtprofat := Nqtconv;

                  Nqtconv      := 0;

                  p_Conv       := NULL;

                END IF;

              ELSE

                IF Nqtpart > 0 THEN

                  Nqtprofat := Nqtpart;

                  Nqtpart   := 0;

                  p_Conv    := v_Particular.Cd_Convenio;

                ELSIF Nqtconv > 0 THEN

                  Nqtprofat := Nqtconv;

                  Nqtconv   := 0;

                  p_Conv    := NULL;

                END IF;

              END IF;

              IF v_Mvto.Tp_Mvto_Estoque = 'C' THEN

                Pcd_Mvto := NULL;

                IF Updating OR Deleting THEN

                  Noldqtprofat := Nqtprofat - Noldqtprofat;

                ELSE

                  Noldqtprofat := Nqtprofat;

                END IF;

                Nqtprofat := 0;

              END IF;

               --FATURCONV-3603 - Adicionando o If Abaixo.
                 IF  DELETING THEN
                     Nqtprofat := 0;
                 END IF;

               /*SUP-284151: tratamento para garantir a que a quantidade deletada do faturamento obedea a regra de substituio de procedimento */

               IF SnRgraSubstituMesmoProfat IS NOT NULL THEN
                  Noldqtprofat := Fnc_Substituicao_Proced_Fator(Pkg_Mv2000.Le_Empresa,

                                                            v_Mvto.Cd_Setor,

                                                            v_Proced.Cd_Pro_Fat,

                                                            /*PDA 202951(inicio) - 14/07/2009 - Jansen Gallindo

                                                                              substituindo no c??o o dt_mvto_estoque por ddtreferencia

                                                                                            v_mvto.dt_mvto_estoque,*/

                                                            Ddtreferencia,

                                                            /*PDA 202951(fim)*/

                                                            v_Mvto.Tp_Atendimento,

                                                            'S',

                                                            Nqtmovold,  -- 197494

                                                          v_Mvto.Cd_Convenio,  /*OP 28803*/

                                                          v_mvto.cd_con_pla,   /*OP 44895*/

                                                          vcRregra.cd_regra     /*OP 44895*/

                                                          );
               END IF;


              Ndiferenca := Nqtprofat - Noldqtprofat;

              -- PDA 216786 (Inicio) - Jamerson Nunes Delfino

              IF p_Conv IS NULL AND

                 Nvl(v_Mvto.Tp_Convenio_Da_Cirurgia, 'C') = 'P' AND

                 v_Mvto.Tp_Convenio <> 'P' -- pda 233190 - 11/06/2008 - Amalia Ara??

              -- n?pode entrar aqui se o convenio do atendimento for particular.

               THEN

                p_Conv := v_Particular.Cd_Convenio;

              END IF;

              -- PDA 216786 (Fim) - Jamerson Nunes Delfino

              IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

                --PDA 157595(INICIO) 14/04/2008 - Jansen Gallindo

                /*IF dbamv.pack_lanca_ffcv.c_conta%ISOPEN THEN

                   CLOSE pack_lanca_ffcv.c_conta;

                END IF;*/

                --v_conta := NULL; --PDA 100545

                v_Conta.DELETE; --PDA 157595

                Ncdregfat := NULL; --PDA 100545

                /*OPEN dbamv.pack_lanca_ffcv.c_conta (v_mvto.cd_atendimento

                                                   ,ddtreferencia

                                                   ,p_conv

                                                   ,v_mvto.cd_atendimento_pai

                                                   );

                FETCH dbamv.pack_lanca_ffcv.c_conta INTO v_conta;

                CLOSE dbamv.pack_lanca_ffcv.c_conta;

                ncdregfat := v_conta.cd_reg_fat;*/

                v_Conta   := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Conta(v_Mvto.Cd_Atendimento,

                                                                    Ddtreferencia,

                                                                    p_Conv,

                                                                    v_Mvto.Cd_Atendimento_Pai);

                Ncdregfat := v_Conta(1).Cd_Reg_Fat;

                --PDA 157595(FIM) 14/04/2008 - Jansen Gallindo

                -- PDA 182149 (In?o) - 27/04/2007 - FL?IO LAGO

                --

                IF Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt%ISOPEN THEN

                  CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt;

                END IF;

                OPEN Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt(Ncdregfat,

                                                         v_Proced.Cd_Pro_Fat,

                                                         v_Mvto.Cd_Setor,

                                                         Pcd_Mvto,

                                                         Ddtreferencia,

                                                         Ncditemmvto);

                FETCH Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt

                  INTO Ncdlcto, Nqtlcto, Ncdregfat, Ndtlancamento;

                IF Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt%NOTFOUND THEN

                  --*1

                  --

                  -- PDA 182149 (FIM) - 27/04/2007 - FL?IO LAGO

                  IF Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt%ISOPEN THEN

                    CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt;

                  END IF;

                  Ncdlcto := NULL; --PDA 100545

                  Nqtlcto := NULL; --PDA 100545

                  -- pda 81303 - 06/11/2003 - Amalia Ara??

                  -- Com o novo par?tro de data, o cursor C_ItRegFat_DT ser?berto duas vezes.

                  -- Na primeira usando a dDtReferencia como par?tro. Se n?retornar, roda sem

                  -- a data.

                  OPEN Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt(Ncdregfat,

                                                           v_Proced.Cd_Pro_Fat,

                                                           v_Mvto.Cd_Setor,

                                                           Pcd_Mvto,

                                                           Ddtreferencia);

                  -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

                  --FETCH dbamv.pack_lanca_ffcv.c_itregfat_dt INTO ncdlcto, nqtlcto;

                  FETCH Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt

                    INTO Ncdlcto, Nqtlcto, Ncdregfat, Ndtlancamento;

                  -- PDA 167142 (Fim)

                  IF Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt%NOTFOUND THEN

                    CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt;

                    OPEN Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt(Ncdregfat,

                                                             v_Proced.Cd_Pro_Fat,

                                                             v_Mvto.Cd_Setor,

                                                             Pcd_Mvto);

                    -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

                    --FETCH dbamv.pack_lanca_ffcv.c_itregfat_dt INTO ncdlcto, nqtlcto;

                    FETCH Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt

                      INTO Ncdlcto, Nqtlcto, Ncdregfat, Ndtlancamento;

                    -- PDA 167142 (Fim)

                  END IF;

                END IF; --*1 -- PDA 182149 - 27/04/2007 - FL?IO LAGO

                -- pda 81303 - fim

                --PDA 100545 -- Alexandre Erik C. M. Costa -- 06/10/2004 -- (INICIO)

                --Caso n?encontre um item na conta procura este item sem o c??o de movimenta?

                IF Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt%NOTFOUND AND

                   v_Mvto.Tp_Mvto_Estoque <> 'C' THEN

                  CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt;

                  OPEN Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt(Ncdregfat,

                                                           v_Proced.Cd_Pro_Fat,

                                                           v_Mvto.Cd_Setor,

                                                           NULL,

                                                           Ddtreferencia);

                  -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

                  --FETCH dbamv.pack_lanca_ffcv.c_itregfat_dt INTO ncdlcto, nqtlcto;

                  FETCH Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt

                    INTO Ncdlcto, Nqtlcto, Ncdregfat, Ndtlancamento;

                  -- PDA 167142 (Fim)

                  CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt;

                END IF;

                --PDA 100545 -- (FIM)

                --PDA 100545 -- Alexandre Erik C. M. Costa -- 06/10/2004 -- (INICIO)

                --Verifica se existe lancamentos disponiveis para excluir.

                IF Ncdlcto IS NULL THEN

                  RAISE Conta_Sem_Item;

                END IF;

                -- PDA 100545 -- (FIM)

                IF v_Mvto.Tp_Mvto_Estoque = 'C' AND

                   Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt%NOTFOUND THEN

                  --PDA - 86237 (In?o)

                  IF Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt%ISOPEN THEN

                    CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt;

                  END IF;

                  --PDA - 86237 (Fim)

                  -- pda 97238 (comentado pois se n?encontrar o item n?pode mostrar erro de atendimento sem conta)

                  -- RAISE devolucao_sem_conta;

                END IF;

                IF Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt%ISOPEN THEN

                  CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt;

                END IF;

                IF Ncdlcto IS NOT NULL THEN

                  --

                  /* pda 141006 - 06/06/2006 - Amalia Ara??

                  Identificando a guia do item. Caso encontre e a mesma ainda esteja Pendente,

                  ir?etirar mais abaixo a mesma quantidade que est?etirando da conta.       */

                  --

                  Ncdguiaitem := NULL;

                  OPEN Dbamv.Pkg_Ffcv_Guia.Cguianoitem(Ncdregfat,

                                                       Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                           v_Mvto.Cd_Atendimento),

                                                       Ncdlcto);

                  FETCH Dbamv.Pkg_Ffcv_Guia.Cguianoitem

                    INTO Ncdguiaitem;

                  CLOSE Dbamv.Pkg_Ffcv_Guia.Cguianoitem;

                  /* pda 141006 - fim */

                  --

                  IF Nqtlcto + Ndiferenca <= 0 THEN

                    --IF NVL (v_conta.sn_abate_devolucao, 'S') = 'S' THEN --PDA 157595

                    IF Nvl(v_Conta(1).Sn_Abate_Devolucao, 'S') = 'S' THEN

                      --PDA 157595

                      Nqtaux := Noldqtprofat;

                      LOOP

                        Nqtaux := Nqtaux - Nvl(Nqtlcto, 0);

                        IF Ncdlcto IS NOT NULL THEN

                          IF NOT

                              Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                                     Ncdlcto,

                                                                     'E') THEN

                            IF NOT

                                Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                                       Ncdlcto,

                                                                       'E') THEN

                              Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'E');

                            END IF;

                          END IF;

                          IF Nqtaux >= 0 THEN

                            --

                            --PDA 77809 / 85742 27/11/2003 Sp?ola Inicio

                            DELETE Dbamv.Itcob_Pre

                             WHERE (Cd_Reg_Fat, Cd_Lancamento) IN

                                   (SELECT DISTINCT Cd_Reg_Fat,

                                                    Cd_Lancamento

                                      FROM Dbamv.Itreg_Fat

                                     WHERE Cd_Reg_Fat_Rel = Ncdregfat

                                       AND Cd_Lancamento_Rel = Ncdlcto);

                            DELETE Dbamv.Itcob_Pre

                             WHERE Cd_Reg_Fat = Ncdregfat

                               AND Cd_Lancamento = Ncdlcto;

                            --PDA 77809 / 85742 Fim

                            DELETE Dbamv.Itreg_Fat

                             WHERE Cd_Reg_Fat_Rel = Ncdregfat

                               AND Cd_Lancamento_Rel = Ncdlcto;

                            -- PDA 186048 (Inicio) - 19/04/2007 - Jansen Gallindo

                            Ncdctkit := NULL;

                            OPEN Cdevkithosp(Ncdregfat, Ncdlcto);

                            FETCH Cdevkithosp

                              INTO Ncdctkit;

                            CLOSE Cdevkithosp;

                            -- PDA 186048 (Fim)

                            DELETE Dbamv.Itreg_Fat

                             WHERE Cd_Reg_Fat = Ncdregfat

                               AND Cd_Lancamento = Ncdlcto;

                            -- PDA 186048(Inicio) - 19/04/2007 - Jansen Gallindo

                            Ncontakit := 0;

                            SELECT COUNT(*)

                              INTO Ncontakit

                              FROM Dbamv.Itreg_Fat

                             WHERE Cd_Reg_Fat = Ncdregfat

                               AND Cd_Conta_Kit = Ncdctkit;

                            IF Ncontakit = 0 THEN

                              DELETE Dbamv.Conta_Kit

                               WHERE Cd_Reg_Fat = Ncdregfat

                                 AND Cd_Conta_Kit = Ncdctkit;

                            END IF;

                            -- PDA 186048 (Fim)

                            /* PDA 288525 - 05/06/2009 - In?o - Fabr?o Oliveira de Miranda

                            A chamada desta procedure estava ocorrendo antes de apagar o item da conta e podia

                            ocorrer erro caso a guia fosse deletada sem deletar o item da conta antes. */

                            /* pda 141006 - 06/06/2006 - Amalia Ara??

                            Retirando o item da guia, caso haja e a guia ainda esteja Pendente. */

                            IF Ncdguiaitem IS NOT NULL THEN

                              Dbamv.Pkg_Ffcv_Guia.Prc_Retirar_Item_Guia(Ncdguiaitem,

                                                                        v_Proced.Cd_Pro_Fat,

                                                                        Nvl(Nqtlcto,

                                                                            0));

                            END IF;

                            /* pda 141006 - fim */

                            /* PDA 288525 - 05/06/2009 - Fim - Fabr?o Oliveira de Miranda */

                          ELSE

                            --

                            /* pda 141006 - 06/06/2006 - Amalia Ara??

                            Retirando o item da guia, caso haja e a guia ainda esteja Pendente. */

                            IF Ncdguiaitem IS NOT NULL THEN

                              Dbamv.Pkg_Ffcv_Guia.Prc_Retirar_Item_Guia(Ncdguiaitem,

                                                                        v_Proced.Cd_Pro_Fat,

                                                                        Nvl(Nqtlcto,

                                                                            0) -

                                                                        Abs(Nqtaux));

                            END IF;

                            /* pda 141006 - fim */

                            --

                            /*pda 307025 - Thiago Miranda de Oliveira - quando for ser feito uma devolu? de algum OPMe sempre dar manuten? aos dados da note*/

                            Nqtllanc := NULL;

                            --

                            OPEN Ccobpre(Ncdregfat, Ncdlcto);

                            FETCH Ccobpre

                              INTO Nqtllanc;

                            CLOSE Ccobpre;

                            --

                            IF Nqtllanc IS NOT NULL THEN

                              IF Abs(Nqtaux) < Nqtllanc THEN

                                UPDATE Dbamv.Itcob_Pre

                                   SET Vl_Preco_Total = ((Vl_Preco_Total /

                                                        Nqtllanc) *

                                                        Abs(Nqtaux))

                                 WHERE Cd_Reg_Fat = Ncdregfat

                                   AND Cd_Lancamento = Ncdlcto;

                              END IF;

                            END IF;

                            /*fim pda 307025*/


                            UPDATE Dbamv.Itreg_Fat

                               SET Qt_Lancamento           = Abs(Nqtaux),

                                   Vl_Unitario             = NULL,

                                   Vl_Filme_Unitario       = NULL,

                                   Vl_Acrescimo            = NULL,

                                   Vl_Desconto             = NULL,

                                   Vl_Honorario_Unitario   = NULL,

                                   Vl_Operacional_Unitario = NULL,

                                   Vl_Total_Conta          = NULL

                             WHERE Cd_Reg_Fat = Ncdregfat

                               AND Cd_Lancamento = Ncdlcto;

                            -- PDA 245116 (Inicio) - Henrique Antunes - 21/08/2008

                            --UPDATE dbamv.itreg_fat

                            --   SET qt_lancamento = ABS (nqtaux)

                            --      ,vl_unitario = NULL

                            --      ,vl_filme_unitario = NULL

                            --      ,vl_acrescimo = NULL

                            --      ,vl_desconto = NULL

                            --      ,vl_honorario_unitario = NULL

                            --      ,vl_operacional_unitario = NULL

                            --      ,vl_total_conta = NULL

                            -- WHERE cd_reg_fat_rel = ncdregfat AND cd_lancamento_rel = ncdlcto;

                            DECLARE

                              CURSOR c_Relacionado(Pncdlcto IN NUMBER, Pncdregfat IN NUMBER) IS

                                SELECT Qt_Lancamento,

                                       Cd_Lancamento

                                  FROM Dbamv.Itreg_Fat

                                 WHERE Cd_Reg_Fat_Rel = Pncdregfat

                                   AND Cd_Lancamento_Rel = Pncdlcto;

                            BEGIN

                              FOR v_Relacionado IN c_Relacionado(Ncdlcto,

                                                                 Ncdregfat)

                              LOOP

                                IF Abs(Nqtaux) > 0 THEN

                                  UPDATE Dbamv.Itreg_Fat

                                     SET Qt_Lancamento           = Abs(Nqtaux),

                                         Vl_Unitario             = NULL,

                                         Vl_Filme_Unitario       = NULL,

                                         Vl_Acrescimo            = NULL,

                                         Vl_Desconto             = NULL,

                                         Vl_Honorario_Unitario   = NULL,

                                         Vl_Operacional_Unitario = NULL,

                                         Vl_Total_Conta          = NULL

                                   WHERE Cd_Reg_Fat = Ncdregfat

                                     AND Cd_Lancamento =

                                         v_Relacionado.Cd_Lancamento;

                                ELSE

                                  DELETE FROM Dbamv.Itreg_Fat

                                   WHERE Cd_Reg_Fat = Ncdregfat

                                     AND Cd_Lancamento =

                                         v_Relacionado.Cd_Lancamento;

                                END IF;

                              END LOOP;

                            END;

                            -- PDA 245116 (Fim)

                            IF NOT

                                Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                                       Ncdlcto,

                                                                       'A') THEN

                              IF NOT

                                  Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                                         Ncdlcto,

                                                                         'A') THEN

                                Verif_Franquia_Hosp(Ncdregfat,

                                                    Ncdlcto,

                                                    'A');

                              END IF;

                            END IF;

                          END IF;

                          -- pda 81303 - 06/11/2003 - Amalia Ara??

                          -- Novamente aqui vai abrir primeiro o cursor com a dDtReferencia,

                          -- e se n?houver dados o abre sem o par?tro da data.

                          Ncdlcto := NULL; -- PDA 100545

                          Nqtlcto := NULL; -- PDA 100545

                          OPEN Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt(Ncdregfat,

                                                                   v_Proced.Cd_Pro_Fat,

                                                                   v_Mvto.Cd_Setor,

                                                                   Pcd_Mvto,

                                                                   Ddtreferencia);

                          -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

                          --FETCH dbamv.pack_lanca_ffcv.c_itregfat_dt INTO ncdlcto, nqtlcto;

                          FETCH Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt

                            INTO Ncdlcto, Nqtlcto, Ncdregfat, Ndtlancamento;

                          -- PDA 167142 (Fim)

                          IF Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt%NOTFOUND THEN

                            CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt;

                            OPEN Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt(Ncdregfat,

                                                                     v_Proced.Cd_Pro_Fat,

                                                                     v_Mvto.Cd_Setor,

                                                                     Pcd_Mvto);

                            -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

                            --FETCH dbamv.pack_lanca_ffcv.c_itregfat_dt INTO ncdlcto, nqtlcto;

                            FETCH Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt

                              INTO Ncdlcto, Nqtlcto, Ncdregfat, Ndtlancamento;

                            -- PDA 167142 (Fim)

                          END IF;

                          --PDA 100545 -- Alexandre Erik C. M. Costa -- 06/10/2004 -- (INICIO)

                          --Caso n?encontre um item na conta procura este item sem o c??o de movimenta?

                          IF Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt%NOTFOUND AND

                             v_Mvto.Tp_Mvto_Estoque <> 'C' THEN

                            CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt;

                            OPEN Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt(Ncdregfat,

                                                                     v_Proced.Cd_Pro_Fat,

                                                                     v_Mvto.Cd_Setor,

                                                                     NULL,

                                                                     Ddtreferencia);

                            -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

                            --FETCH dbamv.pack_lanca_ffcv.c_itregfat_dt INTO ncdlcto, nqtlcto;

                            FETCH Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt

                              INTO Ncdlcto, Nqtlcto, Ncdregfat, Ndtlancamento;

                            -- PDA 167142 (Fim)

                            CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt;

                          END IF;

                          -- PDA 100545 -- Alexandre Erik C. M. Costa -- 06/10/2004 -- (INICIO)

                          -- Verifica se existe lancamentos disponiveis para excluir.

                          IF Ncdlcto IS NULL AND Nqtaux > 0 THEN

                            RAISE Conta_Sem_Item;

                          END IF;

                          -- PDA 100545 -- ALEXANDRE -- (FIM)

                          IF Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt%ISOPEN THEN

                            CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregfat_Dt;

                          END IF;

                          -- pda 81303 - fim

                        ELSE

                          EXIT;

                        END IF;

                        EXIT WHEN Nqtaux <= 0;

                      END LOOP;

                    END IF;

                  ELSE

                    /*PDA 295861 - 13/08/2009 - Jansen Gallindo

                    Retirar o item da guia caso exista pois esta sendo subtraido da conta a quantidade

                    referente a uma devolu? para o estoque.*/

                    IF Ncdguiaitem IS NOT NULL THEN

                      Dbamv.Pkg_Ffcv_Guia.Prc_Retirar_Item_Guia(Ncdguiaitem,

                                                                v_Proced.Cd_Pro_Fat,

                                                                Nvl(Abs(Ndiferenca),

                                                                    0));

                    END IF;

                    /*PDA 295861(fim) */

                    /*pda 307025 - Thiago Miranda de Oliveira - quando for ser feito uma devolu? de algum OPMe sempre dar manuten? aos dados da note*/

                    Nqtllanc := NULL;

                    --

                    OPEN Ccobpre(Ncdregfat, Ncdlcto);

                    FETCH Ccobpre

                      INTO Nqtllanc;

                    CLOSE Ccobpre;

                    --

                    IF Nqtllanc IS NOT NULL THEN

                      IF (Nqtllanc + Ndiferenca) < Nqtllanc THEN

                        UPDATE Dbamv.Itcob_Pre

                           SET Vl_Preco_Total = ((Vl_Preco_Total / Nqtllanc) *

                                                (Nqtllanc + Ndiferenca))

                         WHERE Cd_Reg_Fat = Ncdregfat

                           AND Cd_Lancamento = Ncdlcto;

                      END IF;

                    END IF;

                    /*fim pda 307025*/


                    UPDATE Dbamv.Itreg_Fat

                       SET Qt_Lancamento           = Qt_Lancamento +

                                                     Ndiferenca,

                           Vl_Unitario             = NULL,

                           Vl_Filme_Unitario       = NULL,

                           Vl_Acrescimo            = NULL,

                           Vl_Desconto             = NULL,

                           Vl_Honorario_Unitario   = NULL,

                           Vl_Operacional_Unitario = NULL,

                           Vl_Total_Conta          = NULL

                     WHERE Cd_Reg_Fat = Ncdregfat

                       AND Cd_Lancamento = Ncdlcto;

                    -- PDA 245116 (Inicio) - Henrique Antunes - 21/08/2008

                    --UPDATE dbamv.itreg_fat

                    --SET qt_lancamento = qt_lancamento + ndiferenca

                    --   ,vl_unitario = NULL

                    --   ,vl_filme_unitario = NULL

                    --   ,vl_acrescimo = NULL

                    --   ,vl_desconto = NULL

                    --   ,vl_honorario_unitario = NULL

                    --   ,vl_operacional_unitario = NULL

                    --   ,vl_total_conta = NULL

                    --WHERE cd_reg_fat_rel = ncdregfat AND cd_lancamento_rel = ncdlcto;

                    DECLARE

                      CURSOR c_Relacionado(Pncdlcto IN NUMBER, Pncdregfat IN NUMBER) IS

                        SELECT Qt_Lancamento,

                               Cd_Lancamento

                          FROM Dbamv.Itreg_Fat

                         WHERE Cd_Reg_Fat_Rel = Pncdregfat

                           AND Cd_Lancamento_Rel = Pncdlcto;

                    BEGIN

                      FOR v_Relacionado IN c_Relacionado(Ncdlcto, Ncdregfat)

                      LOOP

                        IF v_Relacionado.Qt_Lancamento + Ndiferenca > 0 THEN

                          UPDATE Dbamv.Itreg_Fat

                             SET Qt_Lancamento           = Qt_Lancamento +

                                                           Ndiferenca,

                                 Vl_Unitario             = NULL,

                                 Vl_Filme_Unitario       = NULL,

                                 Vl_Acrescimo            = NULL,

                                 Vl_Desconto             = NULL,

                                 Vl_Honorario_Unitario   = NULL,

                                 Vl_Operacional_Unitario = NULL,

                                 Vl_Total_Conta          = NULL

                           WHERE Cd_Reg_Fat = Ncdregfat

                             AND Cd_Lancamento =

                                 v_Relacionado.Cd_Lancamento;

                        ELSE

                          DELETE FROM Dbamv.Itreg_Fat

                           WHERE Cd_Reg_Fat = Ncdregfat

                             AND Cd_Lancamento =

                                 v_Relacionado.Cd_Lancamento;

                        END IF;

                      END LOOP;

                    END;

                    -- PDA 245116 (Fim)

                    IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                                  Ncdlcto,

                                                                  'A') THEN

                      IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                                    Ncdlcto,

                                                                    'A') THEN

                        Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'A');

                      END IF;

                    END IF;

                  END IF;

                END IF;

              ELSE

                --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

                /*IF dbamv.pack_lanca_ffcv.c_contaambu%ISOPEN THEN

                   CLOSE dbamv.pack_lanca_ffcv.c_contaambu;

                END IF;*/

                Ncdregamb := NULL; -- PDA 100545

                --v_contaambu := NULL; -- PDA 100545

                v_Contaambu.DELETE; --PDA 157595

                /*OPEN dbamv.pack_lanca_ffcv.c_contaambu (v_mvto.cd_atendimento

                                                       ,ddtreferencia

                                                       ,p_conv

                                                       ,v_mvto.cd_atendimento_pai

                                                       );

                FETCH dbamv.pack_lanca_ffcv.c_contaambu INTO v_contaambu;

                CLOSE dbamv.pack_lanca_ffcv.c_contaambu;*/

                v_Contaambu := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Ccontaambu(v_Mvto.Cd_Atendimento,

                                                                           Ddtreferencia,

                                                                           p_Conv,

                                                                           v_Mvto.Cd_Atendimento_Pai);

                --ncdregamb := v_contaambu.cd_reg_amb;

                Ncdregamb := v_Contaambu(1).Cd_Reg_Amb;

                --PDA 157595(FIM) 15/04/2008 -- Jansen Gallindo

                v_Itregamb := NULL; -- PDA 100545

                -- pda 103016 - 10/09/2004 - Amalia Ara??

                -- Colocando NVL do V_Mvto.cd_atendimento com o V_Mvto.cd_atendimento_pai,

                -- porque n?estava retirando da conta a devolu? ou exclus?de documento

                -- na movimenta? do estoque quando se tratava de atendimento filho.

                -- Na chamada do cursor C_ItRegAmb e na Atualiza? das tabelas de itens.





                -- FATURCONV-2030 - Usar preferencialmente o cursor que filtra pelo setor, para n?devolver de um setor diferente.

                IF Dbamv.Pack_Lanca_Ffcv.c_itregamb_st%ISOPEN THEN

                  CLOSE Dbamv.Pack_Lanca_Ffcv.c_itregamb_st;

                END IF;

                OPEN Dbamv.Pack_Lanca_Ffcv.c_itregamb_st(Ncdregamb,

                                                      v_Proced.Cd_Pro_Fat,

                                                      Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                                                      v_Mvto.cd_setor,

                                                      Pcd_Mvto);

                FETCH Dbamv.Pack_Lanca_Ffcv.c_itregamb_st INTO v_Itregamb;

                IF Dbamv.Pack_Lanca_Ffcv.c_itregamb_st%NOTFOUND THEN

                -- FATURCONV-2030 - fim



                  IF Dbamv.Pack_Lanca_Ffcv.c_Itregamb%ISOPEN THEN

                    CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregamb;

                  END IF;

                  OPEN Dbamv.Pack_Lanca_Ffcv.c_Itregamb(Ncdregamb,

                                                        v_Proced.Cd_Pro_Fat,

                                                        Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                            v_Mvto.Cd_Atendimento),

                                                        Pcd_Mvto);

                  FETCH Dbamv.Pack_Lanca_Ffcv.c_Itregamb

                    INTO v_Itregamb;

                  --PDA 100545 -- Alexandre Erik C. M. Costa -- 06/10/2004 -- (INICIO)

                  --Caso n?encontre um item na conta procura este item sem o c??o de movimenta?

                  IF Dbamv.Pack_Lanca_Ffcv.c_Itregamb%NOTFOUND AND

                    v_Mvto.Tp_Mvto_Estoque <> 'C' THEN

                    CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregamb;

                    OPEN Dbamv.Pack_Lanca_Ffcv.c_Itregamb(Ncdregamb,

                                                          v_Proced.Cd_Pro_Fat,

                                                          Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                              v_Mvto.Cd_Atendimento),

                                                          NULL);

                    FETCH Dbamv.Pack_Lanca_Ffcv.c_Itregamb

                      INTO v_Itregamb;

                    CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregamb;

                  END IF;

                  -- PDA 100545 -- (FIM)

                  IF v_Mvto.Tp_Mvto_Estoque = 'C' AND

                    Dbamv.Pack_Lanca_Ffcv.c_Itregamb%NOTFOUND THEN

                    IF Dbamv.Pack_Lanca_Ffcv.c_Itregamb%ISOPEN THEN

                      CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregamb;

                    END IF;

                    -- pda 97238 (comentado pois se n?encontrar o item n?pode mostrar erro de atendimento sem conta)

                    -- RAISE devolucao_sem_conta;

                  END IF;

                END IF;

                CLOSE Dbamv.Pack_Lanca_Ffcv.c_itregamb_st;   -- FATURCONV-2030 - fim do IF



                --Verifica se existe conta dispon?l.

                IF v_Itregamb.Cd_Lancamento IS NULL THEN

                  RAISE Conta_Sem_Item;

                END IF;



                IF Dbamv.Pack_Lanca_Ffcv.c_Itregamb%ISOPEN THEN

                  CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregamb;

                END IF;

                IF v_Itregamb.Cd_Lancamento IS NOT NULL THEN

                  IF v_Itregamb.Qt_Lancamento + Ndiferenca <= 0 THEN

                    --IF NVL (v_contaambu.sn_abate_devolucao, 'S') = 'S' THEN --PDA 157595

                    IF Nvl(v_Contaambu(1).Sn_Abate_Devolucao, 'S') = 'S' THEN

                      --PDA 157595

                      Nqtaux := Noldqtprofat;

                      LOOP

                        Nqtlcto := v_Itregamb.Qt_Lancamento;

                        Ncdlcto := v_Itregamb.Cd_Lancamento;

                        Nqtaux  := Nqtaux - Nvl(Nqtlcto, 0);

                        IF Ncdlcto IS NOT NULL THEN

                          -- PDA 197953 (In?o) - 08/08/2007 - Diego Costa

                          -- inclus?de verifica? a regra de atendimento pro_fat antes da regra de acoplamaneto

                          IF NOT

                              Dbamv.Pack_Ffcv.Regra_Atendimento_Ambu(Ncdregamb,

                                                                     Ncdlcto,

                                                                     'E') THEN

                            IF NOT

                                Dbamv.Pack_Ffcv.Verif_Acoplamento_Ambu(Ncdregamb,

                                                                       Ncdlcto,

                                                                       'E') THEN

                              Verif_Franquia_Ambu(Ncdregamb, Ncdlcto, 'E');

                            END IF;

                          END IF;

                          -- PDA 197953 (Fim)

                          --

                          /* pda 141006 - 06/06/2006 - Amalia Ara??

                          Identificando a guia do item. Caso encontre e a mesma ainda esteja Pendente,

                          ir?etirar mais abaixo a mesma quantidade que est?etirando da conta.       */

                          Ncdguiaitem := NULL;

                          OPEN Dbamv.Pkg_Ffcv_Guia.Cguianoitem(Ncdregamb,

                                                               Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                   v_Mvto.Cd_Atendimento),

                                                               Ncdlcto);

                          FETCH Dbamv.Pkg_Ffcv_Guia.Cguianoitem

                            INTO Ncdguiaitem;

                          CLOSE Dbamv.Pkg_Ffcv_Guia.Cguianoitem;

                          /* pda 141006 - fim */

                          --

                          IF Nqtaux >= 0 THEN

                            --

                            --PDA 77809 / 85742 27/11/2003 Sp?ola Inicio

                            DELETE Dbamv.Itcob_Pre_Ambu

                             WHERE (Cd_Reg_Amb, Cd_Lancamento) IN

                                   (SELECT DISTINCT Cd_Reg_Amb,

                                                    Cd_Lancamento

                                      FROM Dbamv.Itreg_Amb

                                     WHERE Cd_Reg_Amb_Rel = Ncdregamb

                                       AND Cd_Lancamento_Rel = Ncdlcto

                                       AND Cd_Atendimento =

                                           Nvl(v_Mvto.Cd_Atendimento_Pai,

                                               v_Mvto.Cd_Atendimento));

                            DELETE Dbamv.Itcob_Pre_Ambu

                             WHERE Cd_Reg_Amb = Ncdregamb

                               AND Cd_Lancamento = Ncdlcto;

                            /* pda 374244 - 06/07/2010 - Amalia Ara??- corre? de erro de FK */

                            UPDATE Dbamv.Itreg_Amb

                               SET Cd_Reg_Amb_Pai    = NULL,

                                   Cd_Lancamento_Pai = NULL

                             WHERE Cd_Reg_Amb_Pai = Ncdregamb

                               AND Cd_Lancamento_Pai = Ncdlcto;

                            /* pda 374244 - fim */

                            --PDA 77809 / 85742 Fim

                            DELETE Dbamv.Itreg_Amb

                             WHERE Cd_Reg_Amb_Rel = Ncdregamb

                               AND Cd_Lancamento_Rel = Ncdlcto

                               AND Cd_Atendimento =

                                   Nvl(v_Mvto.Cd_Atendimento_Pai,

                                       v_Mvto.Cd_Atendimento);

                            -- PDA 186048 (Inicio) - 19/07/2007 - Jansen Gallindo

                            Ncdctkit := NULL;

                            OPEN Cdevkitamb(Ncdregamb, Ncdlcto);

                            FETCH Cdevkitamb

                              INTO Ncdctkit;

                            CLOSE Cdevkitamb;

                            -- PDA 186048 (Fim)

                            DELETE Dbamv.Itreg_Amb

                             WHERE Cd_Reg_Amb = Ncdregamb

                               AND Cd_Lancamento = Ncdlcto

                               AND Cd_Atendimento =

                                   Nvl(v_Mvto.Cd_Atendimento_Pai,

                                       v_Mvto.Cd_Atendimento);

                            -- PDA 186048 (Inicio) - 19/04/2007 - Jansen Gallindo

                            Ncontakit := 0;

                            SELECT COUNT(*)

                              INTO Ncontakit

                              FROM Dbamv.Itreg_Amb

                             WHERE Cd_Reg_Amb = Ncdregamb

                               AND Cd_Conta_Kit = Ncdctkit;

                            IF Ncontakit = 0 THEN

                              DELETE Dbamv.Conta_Kit

                               WHERE Cd_Conta_Kit = Ncdctkit;

                            END IF;

                            -- PDA 186048 (Fim)

                            /* PDA 288525 - 05/06/2009 - In?o - Fabr?o Oliveira de Miranda

                            A chamada desta procedure estava ocorrendo antes de apagar o item da conta e podia

                            ocorrer erro caso a guia fosse deletada sem deletar o item da conta antes. */

                            /* pda 141006 - 06/06/2006 - Amalia Ara??

                            Retirando o item da guia, caso haja e a guia ainda esteja Pendente. */

                            IF Ncdguiaitem IS NOT NULL THEN

                              Dbamv.Pkg_Ffcv_Guia.Prc_Retirar_Item_Guia(Ncdguiaitem,

                                                                        v_Proced.Cd_Pro_Fat,

                                                                        Nvl(Nqtlcto,

                                                                            0));

                            END IF;

                            /* pda 141006 - fim */

                            /* PDA 288525 - 05/06/2009 - Fim - Fabr?o Oliveira de Miranda */

                          ELSE

                            --

                            /* pda 141006 - 06/06/2006 - Amalia Ara??

                            Retirando o item da guia, caso haja e a guia ainda esteja Pendente. */

                            IF Ncdguiaitem IS NOT NULL THEN

                              Dbamv.Pkg_Ffcv_Guia.Prc_Retirar_Item_Guia(Ncdguiaitem,

                                                                        v_Proced.Cd_Pro_Fat,

                                                                        Nvl(Nqtlcto,

                                                                            0) -

                                                                        Abs(Nqtaux));

                            END IF;

                            /* pda 141006 - fim */

                            --

                            -- PDA 245116 (Inicio) - Henrique Antunes - 21/08/2008

                            --UPDATE dbamv.itreg_amb

                            --   SET qt_lancamento = ABS (nqtaux)

                            --      ,vl_unitario = NULL

                            --      ,vl_filme_unitario = NULL

                            --      ,vl_acrescimo = NULL

                            --      ,vl_desconto = NULL

                            --      ,vl_honorario_unitario = NULL

                            --      ,vl_operacional_unitario = NULL

                            --      ,vl_total_conta = NULL

                            -- WHERE cd_reg_amb_rel = ncdregamb

                            --   AND cd_lancamento_rel = ncdlcto

                            --   AND cd_atendimento = NVL (v_mvto.cd_atendimento_pai, v_mvto.cd_atendimento);

                            DECLARE

                              CURSOR c_Relacionado(Pncdlcto IN Dbamv.Itreg_Amb.Cd_Lancamento_Rel%TYPE /*number pda 254997*/

                              , Pncdregamb IN Dbamv.Itreg_Amb.Cd_Reg_Amb_Rel%TYPE /*number pda 254997*/

                              , Pcd_Atendimento_Pai IN NUMBER, Pcd_Atendimento IN NUMBER) IS

                                SELECT Qt_Lancamento,

                                       Cd_Lancamento

                                  FROM Dbamv.Itreg_Amb

                                 WHERE Cd_Reg_Amb_Rel = Pncdregamb

                                   AND Cd_Lancamento_Rel = Pncdlcto

                                   AND Cd_Atendimento =

                                       Nvl(Pcd_Atendimento_Pai,

                                           Pcd_Atendimento);

                            BEGIN

                              FOR v_Relacionado IN c_Relacionado(Ncdlcto,

                                                                 Ncdregamb,

                                                                 v_Mvto.Cd_Atendimento_Pai,

                                                                 v_Mvto.Cd_Atendimento)

                              LOOP

                                IF Abs(Nqtaux) > 0 THEN

                                  UPDATE Dbamv.Itreg_Amb

                                     SET Qt_Lancamento           = Abs(Nqtaux),

                                         Vl_Unitario             = NULL,

                                         Vl_Filme_Unitario       = NULL,

                                         Vl_Acrescimo            = NULL,

                                         Vl_Desconto             = NULL,

                                         Vl_Honorario_Unitario   = NULL,

                                         Vl_Operacional_Unitario = NULL,

                                         Vl_Total_Conta          = NULL

                                   WHERE Cd_Reg_Amb = Ncdregamb

                                     AND Cd_Lancamento =

                                         v_Relacionado.Cd_Lancamento

                                     AND Cd_Atendimento =

                                         Nvl(v_Mvto.Cd_Atendimento_Pai,

                                             v_Mvto.Cd_Atendimento);

                                ELSE

                                  DELETE FROM Dbamv.Itreg_Amb

                                   WHERE Cd_Reg_Amb = Ncdregamb

                                     AND Cd_Lancamento =

                                         v_Relacionado.Cd_Lancamento

                                     AND Cd_Atendimento =

                                         Nvl(v_Mvto.Cd_Atendimento_Pai,

                                             v_Mvto.Cd_Atendimento);

                                END IF;

                              END LOOP;

                            END;

                            -- PDA 245116 (Fim)

                            /*pda 307025 - Thiago Miranda de Oliveira - quando for ser feito uma devolu? de algum OPMe sempre dar manuten? aos dados da note*/

                            Nqtllanc := NULL;

                            --

                            OPEN Ccobpreamb(Ncdregamb,

                                            Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                v_Mvto.Cd_Atendimento),

                                            Ncdlcto);

                            FETCH Ccobpreamb

                              INTO Nqtllanc;

                            CLOSE Ccobpreamb;

                            --

                            IF Nqtllanc IS NOT NULL THEN

                              IF Abs(Nqtaux) < Nqtllanc THEN

                                UPDATE Dbamv.Itcob_Pre_Ambu

                                   SET Vl_Preco_Total = ((Vl_Preco_Total /

                                                        Nqtllanc) *

                                                        Abs(Nqtaux))

                                 WHERE Cd_Reg_Amb = Ncdregamb

                                   AND Cd_Lancamento = Ncdlcto;

                              END IF;

                            END IF;

                            /*fim pda 307025*/

                            UPDATE Dbamv.Itreg_Amb

                               SET Qt_Lancamento           = Abs(Nqtaux),

                                   Vl_Unitario             = NULL,

                                   Vl_Filme_Unitario       = NULL,

                                   Vl_Acrescimo            = NULL,

                                   Vl_Desconto             = NULL,

                                   Vl_Honorario_Unitario   = NULL,

                                   Vl_Operacional_Unitario = NULL,

                                   Vl_Total_Conta          = NULL

                             WHERE Cd_Reg_Amb = Ncdregamb

                               AND Cd_Lancamento = Ncdlcto

                               AND Cd_Atendimento =

                                   Nvl(v_Mvto.Cd_Atendimento_Pai,

                                       v_Mvto.Cd_Atendimento);

                          END IF;

                          v_Itregamb := NULL; -- PDA 100545



                          -- FATURCONV-2030 - Usar preferencialmente o cursor que filtra pelo setor, para n?devolver de um setor diferente.

                          IF Dbamv.Pack_Lanca_Ffcv.c_itregamb_st%ISOPEN THEN

                            CLOSE Dbamv.Pack_Lanca_Ffcv.c_itregamb_st;

                          END IF;

                          OPEN Dbamv.Pack_Lanca_Ffcv.c_itregamb_st(Ncdregamb,

                                                                v_Proced.Cd_Pro_Fat,

                                                                Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                                                                v_Mvto.cd_setor,

                                                                Pcd_Mvto);

                          FETCH Dbamv.Pack_Lanca_Ffcv.c_itregamb_st INTO v_Itregamb;

                          IF Dbamv.Pack_Lanca_Ffcv.c_itregamb_st%NOTFOUND THEN

                          -- FATURCONV-2030 - fim

                            OPEN Dbamv.Pack_Lanca_Ffcv.c_Itregamb(Ncdregamb,

                                                                  v_Proced.Cd_Pro_Fat,

                                                                  Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                      v_Mvto.Cd_Atendimento),

                                                                  Pcd_Mvto);

                            FETCH Dbamv.Pack_Lanca_Ffcv.c_Itregamb

                              INTO v_Itregamb;

                            --PDA 100545 -- Alexandre Erik C. M. Costa -- 06/10/2004 -- (INICIO)

                            --Caso n?encontre um item na conta procura este item sem o c??o de movimenta?

                            IF Dbamv.Pack_Lanca_Ffcv.c_Itregamb%NOTFOUND AND

                              v_Mvto.Tp_Mvto_Estoque <> 'C' THEN

                              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregamb;

                              OPEN Dbamv.Pack_Lanca_Ffcv.c_Itregamb(Ncdregamb,

                                                                    v_Proced.Cd_Pro_Fat,

                                                                    Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                        v_Mvto.Cd_Atendimento),

                                                                    NULL);

                              FETCH Dbamv.Pack_Lanca_Ffcv.c_Itregamb

                                INTO v_Itregamb;

                              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregamb;

                            END IF;

                            -- PDA 100545 -- (FIM)

                          END IF;

                          CLOSE Dbamv.Pack_Lanca_Ffcv.c_itregamb_st;   -- FATURCONV-2030 - fim do IF



                          -- PDA 100545 -- Alexandre Erik C. M. Costa -- 06/10/2004 -- (INICIO)

                          -- Verifica se existe item para ser excluido.

                          IF v_Itregamb.Cd_Lancamento IS NULL AND

                             Nqtaux > 0 THEN

                            RAISE Conta_Sem_Item;

                          END IF;

                          -- PDA 100545 -- (FIM)

                          IF Dbamv.Pack_Lanca_Ffcv.c_Itregamb%ISOPEN THEN

                            CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregamb;

                          END IF;

                        ELSE

                          EXIT;

                        END IF;

                        EXIT WHEN Nqtaux <= 0;

                      END LOOP;

                    END IF;

                  ELSE

                    DECLARE

                      CURSOR c_Relacionado(Pncdlcto IN Dbamv.Itreg_Amb.Cd_Lancamento_Rel%TYPE /*number pda 254997*/

                      , Pncdregamb IN Dbamv.Itreg_Amb.Cd_Reg_Amb_Rel%TYPE /*number pda 254997*/

                      , Pcd_Atendimento_Pai IN NUMBER, Pcd_Atendimento IN NUMBER) IS

                        SELECT Qt_Lancamento,

                               Cd_Lancamento

                          FROM Dbamv.Itreg_Amb

                         WHERE Cd_Reg_Amb_Rel = Pncdregamb

                           AND Cd_Lancamento_Rel = Pncdlcto

                           AND Cd_Atendimento =

                               Nvl(Pcd_Atendimento_Pai, Pcd_Atendimento);

                    BEGIN

                      FOR v_Relacionado IN c_Relacionado(Ncdlcto,

                                                         Ncdregamb,

                                                         v_Mvto.Cd_Atendimento_Pai,

                                                         v_Mvto.Cd_Atendimento)

                      LOOP

                        IF v_Relacionado.Qt_Lancamento + Ndiferenca > 0 THEN

                          UPDATE Dbamv.Itreg_Amb

                             SET Qt_Lancamento           = Qt_Lancamento +

                                                           Ndiferenca,

                                 Vl_Unitario             = NULL,

                                 Vl_Filme_Unitario       = NULL,

                                 Vl_Acrescimo            = NULL,

                                 Vl_Desconto             = NULL,

                                 Vl_Honorario_Unitario   = NULL,

                                 Vl_Operacional_Unitario = NULL,

                                 Vl_Total_Conta          = NULL

                           WHERE Cd_Reg_Amb = Ncdregamb

                             AND Cd_Lancamento =

                                 v_Relacionado.Cd_Lancamento

                             AND Cd_Atendimento =

                                 Nvl(v_Mvto.Cd_Atendimento_Pai,

                                     v_Mvto.Cd_Atendimento);

                        ELSE

                          DELETE FROM Dbamv.Itreg_Amb

                           WHERE Cd_Reg_Amb = Ncdregamb

                             AND Cd_Lancamento =

                                 v_Relacionado.Cd_Lancamento

                             AND Cd_Atendimento =

                                 Nvl(v_Mvto.Cd_Atendimento_Pai,

                                     v_Mvto.Cd_Atendimento);

                        END IF;

                      END LOOP;

                    END;

                    -- PDA 245116 (Fim)

                    /*pda 307025 - Thiago Miranda de Oliveira - quando for ser feito uma devolu? de algum OPMe sempre dar manuten? aos dados da note*/

                    Nqtllanc := NULL;

                    --

                    OPEN Ccobpreamb(Ncdregamb,

                                    Nvl(v_Mvto.Cd_Atendimento_Pai,

                                        v_Mvto.Cd_Atendimento),

                                    v_Itregamb.Cd_Lancamento);

                    FETCH Ccobpreamb

                      INTO Nqtllanc;

                    CLOSE Ccobpreamb;

                    --

                    IF Nqtllanc IS NOT NULL THEN

                      IF (Nqtllanc + Ndiferenca) < Nqtllanc THEN

                        UPDATE Dbamv.Itcob_Pre_Ambu

                           SET Vl_Preco_Total = ((Vl_Preco_Total / Nqtllanc) *

                                                (Nqtllanc + Ndiferenca))

                         WHERE Cd_Reg_Amb = Ncdregamb

                           AND Cd_Lancamento = v_Itregamb.Cd_Lancamento;

                      END IF;

                    END IF;

                    /*fim pda 307025*/

                    UPDATE Dbamv.Itreg_Amb

                       SET Qt_Lancamento           = Qt_Lancamento +

                                                     Ndiferenca,

                           Vl_Unitario             = NULL,

                           Vl_Filme_Unitario       = NULL,

                           Vl_Acrescimo            = NULL,

                           Vl_Desconto             = NULL,

                           Vl_Honorario_Unitario   = NULL,

                           Vl_Operacional_Unitario = NULL,

                           Vl_Total_Conta          = NULL

                     WHERE Cd_Reg_Amb = Ncdregamb

                       AND Cd_Lancamento = v_Itregamb.Cd_Lancamento

                       AND Cd_Atendimento =

                           Nvl(v_Mvto.Cd_Atendimento_Pai,

                               v_Mvto.Cd_Atendimento);

                    -- PDA 197953 (In?o) - 08/08/2007 - Diego Costa

                    -- inclus?de verifica? a regra de atendimento pro_fat antes da regra de acoplamaneto

                    IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Ambu(Ncdregamb,

                                                                  Ncdlcto,

                                                                  'A') THEN

                      IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Ambu(Ncdregamb,

                                                                    Ncdlcto,

                                                                    'A') THEN

                        Verif_Franquia_Ambu(Ncdregamb, Ncdlcto, 'A');

                      END IF;

                    END IF;

                    -- PDA 197953 (Fim)

                  END IF;

                END IF;

              END IF;

              -- pda 103016 - fim

            END LOOP; -- Fim do loop que trata da devolu? de itens para o estoque

          END IF;

        END IF;

      END IF;

    END IF;

    RETURN Cgravaatend;

  EXCEPTION

    WHEN Atend_Sem_Conta THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdmvtoestoque,

                     Ncditemmvto,

                     Nvl(v_Proced.Cd_Pro_Fat, Vauxprofat) /* PDA.: 291576 - Adicionado um nvl pois em alguns casos o c??o do procedimento estava chegando nulo*/,

                     Vtpimportacao,

                     '04'



                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_4',

                                                       'PACK_LANCA_FFCV',

                                                       'Atendimento %s n?possui Conta aberta/disponivel.',

                                                       Arg_List(v_Mvto.Cd_Atendimento)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;

    WHEN Prod_Nao_Conf THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat  --PDA 157595

                    ,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdmvtoestoque,

                     Ncditemmvto,

                     Nvl(v_Proced.Cd_Pro_Fat, Vauxprofat) /* PDA.: 291576 - Adicionado um nvl pois em alguns casos o c??o do procedimento estava chegando nulo*/,

                     Vtpimportacao,

                     '01'

                     --, 'Produto No ' || ncdproduto || ' do Estoque(MGES) n?tem relacionamento com Faturamento de Convenio(FFCV)'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_5',

                                                       'PACK_LANCA_FFCV',

                                                       'Produto %s do Estoque n?tem relacionamento com Faturamento de Convenio.',

                                                       Arg_List(Ncdproduto)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;

    WHEN Setor_Nao_Conf THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdmvtoestoque,

                     Ncditemmvto,

                     Nvl(v_Proced.Cd_Pro_Fat, Vauxprofat) /* PDA.: 291576 - Adicionado um nvl pois em alguns casos o c??o do procedimento estava chegando nulo*/,

                     Vtpimportacao,

                     '02'

                     --,    'Setor '

                     --  || LTRIM (TO_CHAR (v_mvto.cd_setor))

                     --  || ', Esp?e '

                     --  || LTRIM (TO_CHAR (v_proced.cd_especie))

                     --  || ' e Classe '

                     --  || LTRIM (TO_CHAR (v_proced.cd_classe))

                     --  || ' n?configurado para lan?ento'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_6',

                                                       'PACK_LANCA_FFCV',

                                                       'Setor %s, Esp?e %s e classe %s n?configurados para Lan?ento.',



                                                       Arg_List(Ltrim(To_Char(v_Mvto.Cd_Setor)),

                                                                Ltrim(To_Char(v_Proced.Cd_Especie)),

                                                                Ltrim(To_Char(v_Proced.Cd_Classe)))) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;

    WHEN Proc_Proibido THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdmvtoestoque,

                     Ncditemmvto,

                     Nvl(v_Proced.Cd_Pro_Fat, Vauxprofat) /* PDA.: 291576 - Adicionado um nvl pois em alguns casos o c??o do procedimento estava chegando nulo*/,

                     Vtpimportacao,

                     '05'

                     --, 'Procedimento proibido para o Convenio ' || LTRIM (TO_CHAR (nCdConvConta)) || ' e Plano ' || LTRIM (TO_CHAR (nCdPlanConta)) --PDA 157595

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_7',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento proibido para o Convenio %s e Plano %s.',

                                                       Arg_List(Ltrim(To_Char(Ncdconvconta)),

                                                                Ltrim(To_Char(Ncdplanconta)))) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;



	-- OP 32555

    WHEN Proc_Proibido_Idade THEN

	  -- OP 33697 - 05/10/2015 - Substituindo Gera_Log_Falha por Raise_Application_Error.

      Raise_Application_Error(-20054, Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20','PACK_LANCA_FFCV',

                                'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                Arg_List(Nvl(v_Proced.Cd_Pro_Fat, Vauxprofat))));

      /*

      Gera_Log_Falha(Ncdregfat,

                     Ncdregamb,

                     Ncdmvtoestoque,

                     Ncditemmvto,

                     Nvl(v_Proced.Cd_Pro_Fat, Vauxprofat)

                     Vtpimportacao,

                     '05',

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                                       Arg_List(Nvl(v_Proced.Cd_Pro_Fat, Vauxprofat)))

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;  */



    WHEN Fora_Da_Conta THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdmvtoestoque,

                     Ncditemmvto,

                     Nvl(v_Proced.Cd_Pro_Fat, Vauxprofat) /* PDA.: 291576 - Adicionado um nvl pois em alguns casos o c??o do procedimento estava chegando nulo*/,

                     Vtpimportacao,

                     '08'

                     --,'Procedimento com proibi? tipo Fora da Conta'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_8',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento com proibi? tipo Fora da Conta.',



                                                       Arg_List()) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;

    WHEN Devolucao_Sem_Conta THEN

      -- adicionado a partir do PDA 77082

      Gera_Log_Falha(Ncdregfat, -- V_Conta.cd_reg_fat, -- pda 90527 (alterado pois da forma anterior pegava sempre  conta do convenio do atendimento)

                     Ncdregamb --PDA 233500--v_contaambu(1).cd_reg_amb -- v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdmvtoestoque,

                     Ncditemmvto,

                     Nvl(v_Proced.Cd_Pro_Fat, Vauxprofat) /* PDA.: 291576 - Adicionado um nvl pois em alguns casos o c??o do procedimento estava chegando nulo*/,

                     Vtpimportacao,

                     '09'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_9',

                                                       'PACK_LANCA_FFCV',

                                                       'devolu? %s n?possui Conta aberta/disponivel.',



                                                       Arg_List(Ncditemmvto)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;

      --PDA 100545 -- Alexandre Erik C. M. Costa -- 06/10/2004

    -- Descri? da exce? est?etalhada na Declara? da exce?.

    WHEN Conta_Sem_Item THEN

      Gera_Log_Falha(Ncdregfat,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdmvtoestoque,

                     Ncditemmvto,

                     Nvl(v_Proced.Cd_Pro_Fat, Vauxprofat) /* PDA.: 291576 - Adicionado um nvl pois em alguns casos o c??o do procedimento estava chegando nulo*/,

                     Vtpimportacao,

                     '09'

                     --,'devolu? ou exclus?n?encontrou item na conta para efetuar a exclus?'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_10',

                                                       'PACK_LANCA_FFCV',

                                                       'devolu? ou Exclus?n?encontrou item na conta para efetuar a exclus?',

                                                       Arg_List()) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;

      --PDA 100545 (FIM)

    WHEN Auditoria_In_Loco THEN

      --PDA 143076 (inicio) 26/10/2007 Jansen Gallindo

      IF Nvl(v_Mvto.Tp_Mvto_Estoque, 'X') = 'C' THEN

        --vMsgAuditInLoc :=  'O periodo da conta ' || v_conta.cd_reg_fat || ' est?m auditoria in-loco no momento da devolu? do Procedimento'; --PDA 157595

        --vMsgAuditInLoc :=  'O periodo da conta ' || nCdRegFat || ' est?m auditoria in-loco no momento da devolu? do Procedimento'; --PDA 157595

        Vmsgauditinloc := Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_11',

                                                            'PACK_LANCA_FFCV',

                                                            'O periodo da Conta %s est?m auditoria in-loco no momento da devolu? do Procedimento.',

                                                            Arg_List(Ncdregfat)); -- OP 10402

      ELSE

        --vMsgAuditInLoc :=  'O periodo da conta ' || v_conta.cd_reg_fat || ' est?m auditoria in-loco no momento da importa? do Procedimento'; --PDA 157595 14/04/2008 - Jansen Gallindo

        --vMsgAuditInLoc :=  'O periodo da conta ' || nCdRegFat || ' est?m auditoria in-loco no momento da importa? do Procedimento'; --PDA 157595 14/04/2008 - Jansen Gallindo

        Vmsgauditinloc := Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_12',

                                                            'PACK_LANCA_FFCV',

                                                            'O periodo da Conta %s est?m auditoria in-loco no momento da importa? do Procedimento.',

                                                            Arg_List(Ncdregfat)); -- OP 10402

      END IF;

      --PDA 143076 (fim) 26/10/2007 Jansen Gallindo

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdmvtoestoque,

                     Ncditemmvto,

                     Nvl(v_Proced.Cd_Pro_Fat, Vauxprofat) /* PDA.: 291576 - Adicionado um nvl pois em alguns casos o c??o do procedimento estava chegando nulo*/,

                     Vtpimportacao,

                     '10'

                     --PDA 143076(inicio)

                    ,

                     Vmsgauditinloc

                     --PDA 143076(fim)

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;

  END;



  PROCEDURE Lanca_Sangue_Ffcv(Ncdavisocirurgia   IN NUMBER,

                              Ncdsanguederivados IN NUMBER,

                              Ndiferenca         IN NUMBER,

                              Caction            IN VARCHAR2,

                              Ncditemmvto        IN NUMBER) IS

  BEGIN

    Dbamv.Pack_Aux_Ffcv.Lanca_Sangue_Ffcv(Ncdavisocirurgia,

                                          Ncdsanguederivados,

                                          Ndiferenca,

                                          Caction,

                                          Ncditemmvto);

  END;



  PROCEDURE Confirma_Lcto_Ciru_Ffcv(Ncdavisocirurgia IN NUMBER,

                                    Caction          IN VARCHAR2 DEFAULT 'I') IS

  BEGIN

    -- PDA 204721 (In?o) 16/11/2007 FL?IO LAGO

    -- Evitar duplicidade nos lan?entos dos procedimentos que 'startam' pacote

    IF Caction = 'I' THEN

      Dbamv.Pack_Aux_Ffcv.Confirma_Lcto_Ciru_Ffcv(Ncdavisocirurgia, 'D');

    END IF;

    -- PDA 204721 fim

    Dbamv.Pack_Aux_Ffcv.Confirma_Lcto_Ciru_Ffcv(Ncdavisocirurgia, Caction);

  END;



  --------------------------------------------------------------------------------------------

  PROCEDURE Lanca_Psnd_Ffcv(Ncdopcao       IN NUMBER,

                            Ncdmovcardapio IN NUMBER,

                            Nqtmovnew      IN NUMBER,

                            Nqtmovold      IN NUMBER,

                            Caction        IN VARCHAR2,

                            Ccobranca      IN VARCHAR2,

                            Ncditemmvto    IN NUMBER) IS

    CURSOR c_Config IS

      SELECT Config_Ffcv.Sn_Nutricao_Automatica,

             Config_Ffcv.Sn_Checa_Preco_Lcto,

             Config_Ffcv.Sn_Guia_Proc_Auto

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    CURSOR c_Proced IS

      SELECT Opcao_Cardapio.Cd_Pro_Fat,

             Gru_Pro.Cd_Gru_Fat,

             Pro_Fat.Cd_Gru_Pro

        FROM Dbamv.Opcao_Cardapio,

             Dbamv.Pro_Fat,

             Dbamv.Gru_Pro

       WHERE Opcao_Cardapio.Cd_Opcao = Ncdopcao

         AND Pro_Fat.Cd_Pro_Fat(+) = Opcao_Cardapio.Cd_Pro_Fat

         AND Pro_Fat.Cd_Gru_Pro = Gru_Pro.Cd_Gru_Pro(+);

    CURSOR c_Mvto IS

      SELECT Mov_Cardapio.Cd_Atendimento,

             Mov_Cardapio.Dt_Mov_Cardapio,

             Mov_Cardapio.Cd_Setor,

             Atendime.Tp_Atendimento,

             Atendime.Cd_Convenio,

             Atendime.Cd_Con_Pla,

             Atendime.Cd_Atendimento_Pai,

             Convenio.Tp_Convenio,

             Atendime.Cd_Tip_Acom,

             Atendime.Cd_Convenio_Secundario,

             Atendime.Cd_Con_Pla_Secundario,

             Atendime.Sn_Importa_Auto

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- atendime.dt_atendimento

            ,

             To_Date(To_Char(Atendime.Dt_Atendimento, 'DD/MM/YYYY') || ' ' ||

                     To_Char(Atendime.Hr_Atendimento, 'HH24:Mi:SS'),

                     'DD/MM/YYYY HH24:MI:SS') Dt_Atendimento

             -- PDA 229502 (Fim)

            ,

             Atendime.Hr_Atendimento

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- ,atendime.dt_alta

            ,

             To_Date(To_Char(Atendime.Dt_Alta, 'dd/mm/yyyy') ||

                     To_Char(Atendime.Hr_Alta, 'hh24:mi'),

                     'dd/mm/yyyy hh24:mi') Dt_Alta

      -- PDA 229502 (Fim)

        FROM Dbamv.Mov_Cardapio,

             Dbamv.Atendime,

             Dbamv.Convenio,

             Dbamv.Empresa_Convenio

       WHERE Mov_Cardapio.Cd_Mov_Cardapio = Ncdmovcardapio

         AND Convenio.Cd_Convenio = Empresa_Convenio.Cd_Convenio /* PDA 118607/129023*/

         AND Empresa_Convenio.Cd_Multi_Empresa =

             Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/129023*/

         AND Atendime.Cd_Atendimento = Mov_Cardapio.Cd_Atendimento

         AND Convenio.Cd_Convenio = Atendime.Cd_Convenio

         AND Convenio.Tp_Convenio IN ('P', 'C')

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    CURSOR c_Grfat(Ngrpr IN NUMBER, Nsetor IN NUMBER) IS

      SELECT Setor_Gru_Fat.Cd_Gru_Fat

        FROM Dbamv.Setor_Gru_Fat

       WHERE Setor_Gru_Fat.Cd_Setor = Nsetor

         AND Setor_Gru_Fat.Cd_Gru_Pro = Ngrpr;

    /* PDA 476298 - 475670*/

    CURSOR c_Itregfatmvto(Nconta IN NUMBER, Cprofat IN VARCHAR2, Pncdmvto IN NUMBER) IS

      SELECT Itreg_Fat.Cd_Lancamento,

             Itreg_Fat.Qt_Lancamento,

             Itreg_Fat.Cd_Reg_Fat

        FROM Dbamv.Itreg_Fat

       WHERE Itreg_Fat.Cd_Reg_Fat = Nconta

         AND Itreg_Fat.Cd_Pro_Fat = Cprofat

         AND Itreg_Fat.Cd_Mvto = Nvl(Pncdmvto, Itreg_Fat.Cd_Mvto)

      UNION

      SELECT Itreg_Fat.Cd_Lancamento,

             Itreg_Fat.Qt_Lancamento,

             Itreg_Fat.Cd_Reg_Fat

        FROM Dbamv.Itreg_Fat

       WHERE Itreg_Fat.Cd_Conta_Pai = Nconta

         AND Itreg_Fat.Cd_Pro_Fat = Cprofat

         AND Itreg_Fat.Cd_Mvto = Nvl(Pncdmvto, Itreg_Fat.Cd_Mvto)

       ORDER BY 2 DESC;

    v_Itregfatmov c_Itregfatmvto%ROWTYPE;

    /* FIM PDA 476298 - 475670*/

    Prod_Nao_Conf EXCEPTION;

    Setor_Nao_Conf EXCEPTION;

    Proc_Sem_Preco EXCEPTION;

    Auditoria_In_Loco EXCEPTION;

    Atend_Sem_Conta EXCEPTION;

    Proc_Proibido EXCEPTION;

	proc_proibido_idade   exception;   -- OP 32555

    Fora_Da_Conta EXCEPTION;

    v_Config c_Config%ROWTYPE;

    v_Proced c_Proced%ROWTYPE;

    v_Mvto   c_Mvto%ROWTYPE;

    --PDA 157595(INICIO) 14/04/2008 - Jansen Gallindo

    --v_conta              dbamv.pack_lanca_ffcv.c_conta%ROWTYPE;

    v_Conta      Dbamv.Pkg_Ffcv_Conta.Tpconta;

    Ncdconvconta NUMBER; --PDA 233500

    Ncdplanconta Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*number pda 254997*/

    ; --PDA 233500

    --v_contapart          dbamv.pack_lanca_ffcv.c_contapart%ROWTYPE;

    --PDA 157595(FIM) 14/04/2008 - Jansen Gallindo

    v_Itregfat          Dbamv.Pack_Lanca_Ffcv.c_Itregfat%ROWTYPE;

    v_Forapre           Dbamv.Pack_Lanca_Ffcv.c_Forapre%ROWTYPE;

    Nqtprofat           Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Noldqtprofat        Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Ncdlcto             Dbamv.Itreg_Amb.Cd_Lancamento%TYPE /*number pda 254997*/

    ;

    Csnpacote           VARCHAR2(1);

    Binsert             BOOLEAN;

    Ctpproibicao        VARCHAR2(2);

    Ncdgrufat           NUMBER;

    Nqtautorizado       NUMBER;

    Ncdguia             NUMBER;

    Bpartic             BOOLEAN := FALSE;

    Ncdregfat           Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/

    ;

    Ndiferenca          NUMBER;

    Ncdlfa              NUMBER;

    Ncdsetor            NUMBER;

    Updating            BOOLEAN := FALSE;

    Deleting            BOOLEAN := FALSE;

    Inserting           BOOLEAN := FALSE;

    Bexistepreco        BOOLEAN := TRUE;

    Cmensret            VARCHAR2(2000);

    Nguiapendente       Dbamv.Guia.Cd_Guia%TYPE; -- pda 145435 - 23/03/2006 - Jose Roberto

    Ncdguiaitem         Dbamv.Guia.Cd_Guia%TYPE; /* pda 141006 */

    Vsnchecapreconolcto VARCHAR2(01); -- PDA 175957 - 16/03/2007 - Pedro Neiva(Apply)

    -- PDA 96161 -- Alexandre Erik C. M. Costa 25/05/2004

    -- Declara? de vari?is

    --

    Nqtdguia           NUMBER;

    v_Qtdexistente_Fat NUMBER;

    Totallancado       NUMBER;

    -- PDA 96161 -- (FIM)

    -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

    Ncdpacote Dbamv.Conta_Pacote.Cd_Conta_Pacote%TYPE;

    Csnguia   VARCHAR2(1) := 'N';

    -- PDA 157145 (Fim)\par

    Nqtexcedeu   NUMBER := NULL; -- OP 387

    Vtpcontapart Dbamv.Itreg_Fat.Tp_Mvto%TYPE := NULL; -- OP 387

    Nconta       NUMBER := NULL; -- OP 387

    Nlanc        NUMBER := NULL; -- OP 387

    vTemRegraCriaContaAuto BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnCriouContaAuto      BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnCriouContaAutoAmb   BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vRegraCriaContaAuto    Dbamv.Pkg_Ffcv_Conta.TpContaAutomatica; /*OP 35916 - regra para cria? autom?ca de conta*/

    v_ContaCargoPac        Dbamv.Pkg_Ffcv_Conta.Tpconta;     /*ALLS OP 42241 */

    v_ContaCargoPacAmbu    Dbamv.Pkg_Ffcv_Conta.Tpcontaambu; /*ALLS OP 42241 */

    vRegraCriaContaAutoCP  Dbamv.Pkg_Ffcv_Conta.TpContaAutomaticaCP; /*ALLS OP 42241* - regra para cria? autom?ca de conta referente a Cargo Paciente*/

    vSnCargoPaciente       Dbamv.Pack_Lanca_Ffcv.cSnCargoPaciente%ROWTYPE; /*ALLS OP 42241*/

    vSnCriouContaAutoCP    BOOLEAN := FALSE; /*ALLS OP 42241 */

    vSnCriouContaAutoAmbCP BOOLEAN := FALSE; /*ALLS OP 42241 */

    NcdlctoCp              NUMBER  ; /*ALLS OP 42241 */

    NcdlctoAmbCp           NUMBER  ; /*ALLS OP 42241 */

    pEmpresa               NUMBER := Pkg_Mv2000.Le_Empresa;/*43289*/

    pvSnJaExcedeuQtd      Varchar2(1):= 'N'; /*43289*/

    pvMensagem             VARCHAR2(2000);    /*43289*/

    pSnChamadoDaTela       VARCHAR2(1) := 'N';       /*43289*/



  BEGIN

    IF Caction = 'I' THEN

      Inserting := TRUE;

    ELSIF Caction = 'U' THEN

      Updating := TRUE;

    ELSIF Caction = 'D' THEN

      Deleting := TRUE;

    END IF;

    OPEN c_Config;

    FETCH c_Config

      INTO v_Config;

    CLOSE c_Config;

    /*PDA 306659(inicio) - 28/09/2009 - Jansen Gallindo

    A quantidade passada pela trigger de lan?ento da nutri? TRG_LANCA_PSDN_FFCV,

    n?estava sendo atribu? a vari?l nqtprofat, causando erro na cria? da guia de

    procedimentos para intes autorizados por guia.*/

    Nqtprofat := Nvl(Nqtmovnew, 0);

    /*PDA 306659(fim) - 28/09/2009 - Jansen Gallindo*/

    IF Nvl(v_Config.Sn_Nutricao_Automatica, 'S') = 'S' THEN

      OPEN c_Mvto;

      FETCH c_Mvto

        INTO v_Mvto;

      CLOSE c_Mvto;

      --PDA 97603 18/05/2004 Sp?ola (INICIO)

      --Mofido para o inicio da rotina o CURSOR C_PROCED de forma que AS torinas que utilizao os dados deste pudesse ser inicializadas corretamente.

      OPEN c_Proced;

      FETCH c_Proced

        INTO v_Proced;

      IF c_Proced%NOTFOUND THEN

        CLOSE c_Proced;

        Raise_Application_Error(-20039

                                --MULTI-IDIOMA: Utiliza? do pkg_rmi_traducao.extrair_msg para mensagens (MSG_2)

                               ,

                                Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_2',

                                                                  'PACK_LANCA_FFCV',

                                                                  'n?foram encontrados dados para o CURSOR c_proced da rotina PACK_LANCA_FFCV.LANCA_PSND_FFCV com a op? = %s%s%s',



                                                                  Arg_List(Ncdopcao,

                                                                           Chr(12),

                                                                           SQLERRM)));

      END IF;

      CLOSE c_Proced;

      --DPA 97603 (FIM)

      -- 93411 -- 10/03/2004 -- Alexandre Erik C. M. Costa (INICIO)

      -- Verificar se o atendimento ambulatorial foi transferido para interna?

      IF v_Mvto.Tp_Atendimento IN ('A', 'E', 'U') AND

         v_Mvto.Sn_Importa_Auto = 'S' THEN

        Raise_Application_Error(-20040

                                --MULTI-IDIOMA: Utiliza? do pkg_rmi_traducao.extrair_msg para mensagens (MSG_1)

                               ,

                                Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_1',

                                                                  'PACK_LANCA_FFCV',

                                                                  'A Conta deste atendimento est?loqueada! A movimenta? da mesma dever?er lan?a para o atendimento de interna? %s',



                                                                  Arg_List(v_Mvto.Cd_Atendimento_Pai)));

      END IF;

		if dbamv.fnc_ffcv_proibicao_idade( v_mvto.cd_atendimento, v_mvto.cd_convenio, v_mvto.cd_con_pla, v_proced.cd_pro_fat ) <> 'OK' then

		  raise proc_proibido_idade;

		end if;

		-- OP 32555 - fim



      --PDA 97603 18/05/2004 Sp?ola (INICIO)

      --Colocado verifica? de proibi?

/* OP 38292 (Inicio)

      OPEN Dbamv.Pack_Lanca_Ffcv.c_Proibicao(v_Proced.Cd_Pro_Fat,

                                             v_Mvto.Cd_Convenio,

                                             v_Mvto.Cd_Con_Pla,

                                             v_Mvto.Tp_Atendimento,

                                             v_Mvto.Dt_Mov_Cardapio,

                                             v_Mvto.Cd_Setor);

      FETCH Dbamv.Pack_Lanca_Ffcv.c_Proibicao

        INTO Ctpproibicao;

      CLOSE Dbamv.Pack_Lanca_Ffcv.c_Proibicao;

*/



      Ctpproibicao := dbamv.pack_ffcv_proibicao.fnc_ffcv_proibicao(v_Proced.Cd_Pro_Fat,

                                             v_Mvto.Cd_Convenio,

                                             v_Mvto.Cd_Con_Pla,

                                             v_Mvto.Tp_Atendimento,

                                             v_Mvto.Dt_Mov_Cardapio,

                                             v_Mvto.Cd_Setor,

                                                                   v_mvto.cd_atendimento,

                                                                   NULL);

      -- OP 38292 (Fim)





      --PDA 97603 (FIM)

      IF v_Mvto.Tp_Atendimento = 'I' THEN

        --PDA 97603 18/05/2004 Sp?ola (INICIO)

        --Colocada verifica? para proibi? de NA (n?Autorizado)

        IF Ccobranca = 'S' OR Ctpproibicao = 'NA' THEN

          --PDA 97603 (FIM)

          --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

          /*OPEN dbamv.pack_lanca_ffcv.c_contapart (v_mvto.cd_atendimento, v_mvto.dt_mov_cardapio);

          FETCH dbamv.pack_lanca_ffcv.c_contapart INTO v_conta;

          CLOSE dbamv.pack_lanca_ffcv.c_contapart;*/

          v_Conta := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Ccontapart(v_Mvto.Cd_Atendimento,

                                                                 v_Mvto.Dt_Mov_Cardapio);

          --IF v_conta.cd_reg_fat IS NULL THEN

          IF v_Conta(1).Cd_Reg_Fat IS NULL THEN

            --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

            Ncdregfat := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento);

          ELSE

            --ncdregfat := v_conta.cd_reg_fat; --PDA 157595

            Ncdregfat    := v_Conta(1).Cd_Reg_Fat; --PDA 157595

            Ncdconvconta := v_Conta(1).Cd_Convenio; --PDA 233500

            Ncdplanconta := v_Conta(1).Cd_Con_Pla; --PDA 233500

          END IF;

          IF Ncdregfat IS NULL THEN

            RAISE Atend_Sem_Conta;

          END IF;

        ELSE

        /* OP 38292 (Inicio)



          OPEN Dbamv.Pack_Lanca_Ffcv.c_Proibicao(v_Proced.Cd_Pro_Fat,

                                                 v_Mvto.Cd_Convenio,

                                                 v_Mvto.Cd_Con_Pla,

                                                 v_Mvto.Tp_Atendimento,

                                                 v_Mvto.Dt_Mov_Cardapio,

                                                 v_Mvto.Cd_Setor);

          FETCH Dbamv.Pack_Lanca_Ffcv.c_Proibicao

            INTO Ctpproibicao;

          CLOSE Dbamv.Pack_Lanca_Ffcv.c_Proibicao;*/





      Ctpproibicao := dbamv.pack_ffcv_proibicao.fnc_ffcv_proibicao(v_Proced.Cd_Pro_Fat,

                                               v_Mvto.Cd_Convenio,

                                               v_Mvto.Cd_Con_Pla,

                                               v_Mvto.Tp_Atendimento,

                                               v_Mvto.Dt_Mov_Cardapio,

                                               v_Mvto.Cd_Setor,

                                                                       v_mvto.cd_atendimento,

                                                                       NULL);

      -- OP 38292 (Fim)



          IF Ctpproibicao = 'FC' THEN

            RAISE Fora_Da_Conta;

          END IF;

          --PDA 157595(INICIO) 14/04/2008 - Jansen Gallindo

          /*OPEN dbamv.pack_lanca_ffcv.c_conta (v_mvto.cd_atendimento

                                             ,v_mvto.dt_mov_cardapio

                                             ,v_mvto.cd_convenio

                                             ,v_mvto.cd_atendimento_pai

                                             );

          FETCH dbamv.pack_lanca_ffcv.c_conta INTO v_conta;

          CLOSE dbamv.pack_lanca_ffcv.c_conta;*/

          /*OP 35916 - regra para cria? autom?ca de conta*/

          vTemRegraCriaContaAuto  := Dbamv.Pkg_Ffcv_Conta.FNC_TEM_REG_CRIA_CONTA_AUTO;

          IF (vTemRegraCriaContaAuto) THEN



                    /*ALLS OP 42241*/

                    OPEN dbamv.pack_lanca_ffcv.cSnCargoPaciente(v_Mvto.Cd_Atendimento);

                    FETCH dbamv.pack_lanca_ffcv.cSnCargoPaciente INTO vSnCargoPaciente;

					          CLOSE dbamv.pack_lanca_ffcv.cSnCargoPaciente;



					          IF Nvl(vSnCargoPaciente.sn_carga_familiar,'N') = 'S' THEN



                        vRegraCriaContaAutoCP := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTCP(v_Mvto.Cd_Atendimento,

                                                                                                     v_Proced.Cd_Pro_Fat,

                                                                                                     v_Mvto.Dt_Mov_Cardapio); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAutoCP(1).cd_regra_cria_conta IS NOT NULL ) THEN



                            v_ContaCargoPac :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_HOSP_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                                  null,

                                                                                                  v_Mvto.Cd_Atendimento,

                                                                                                  v_Mvto.Cd_Atendimento_Pai,

                                                                                                  vRegraCriaContaAutoCP(1).cd_convenio_destino,

                                                                                                  vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                                                                                                  v_Mvto.Dt_Mov_Cardapio,

                                                                                                  vRegraCriaContaAutoCP(1).cd_tipo_arq_cta_envio,

                                                                                                  vRegraCriaContaAutoCP(1).cd_desconto_inst); /*ALLS OP 35921*/

                            vSnCriouContaAutoCP := TRUE;

                        END IF;

                    /*fim ALLS OP 42241*/

                    ELSE



                        vRegraCriaContaAuto := Dbamv.Pkg_Ffcv_Conta.FNC_VERIFIC_REG_CRIA_CONTA_AUT(v_Mvto.Cd_Atendimento,

                                                                                                   v_Proced.Cd_Pro_Fat,

                                                                                                   v_Mvto.Dt_Mov_Cardapio); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAuto(1).cd_regra_cria_conta IS NOT NULL ) THEN



                            v_Conta :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_HOSP_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                          null,

                                                                                          v_Mvto.Cd_Atendimento,

                                                                                          v_Mvto.Cd_Atendimento_Pai,

                                                                                          vRegraCriaContaAuto(1).cd_convenio_destino,

                                                                                          vRegraCriaContaAuto(1).cd_con_pla_destino,

                                                                                          v_Mvto.Dt_Mov_Cardapio,

                                                                                          vRegraCriaContaAuto(1).cd_tipo_arq_cta_envio,

                                                                                          vRegraCriaContaAuto(1).cd_desconto_inst); /*ALLS OP 35921*/

                            vSnCriouContaAuto := TRUE;

                        END IF;



                    END IF;

          END IF;



          IF (NOT vSnCriouContaAuto) THEN

          /*OP 35916 - regra para cria? autom?ca de conta*/

              v_Conta := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Conta(v_Mvto.Cd_Atendimento,

                                                            v_Mvto.Dt_Mov_Cardapio,

                                                            v_Mvto.Cd_Convenio,

                                                            v_Mvto.Cd_Atendimento_Pai);

          END IF; /*OP 35916*/



          --IF v_conta.cd_reg_fat IS NULL THEN

          IF v_Conta(1).Cd_Reg_Fat IS NULL THEN

            --PDA 157595(FIM) 14/04/2008 - Jansen Gallindo

            IF v_Mvto.Cd_Convenio_Secundario IS NOT NULL THEN

              Ncdregfat := Dbamv.Pack_Lanca_Ffcv.Verifica_Conta_Secundaria(v_Mvto.Cd_Atendimento,

                                                                           v_Mvto.Dt_Mov_Cardapio,

                                                                           v_Mvto.Cd_Convenio_Secundario,

                                                                           v_Mvto.Cd_Atendimento_Pai);

              IF Ncdregfat IS NULL THEN

                RAISE Atend_Sem_Conta;

              END IF;

            ELSE

              IF v_Mvto.Tp_Convenio = 'P' THEN

                Ncdregfat := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento,

                                                                          v_Mvto.Dt_Mov_Cardapio); -- pda 125871(acrescentada a data)

              ELSE

                RAISE Atend_Sem_Conta;

              END IF;

            END IF;

          ELSE

            --ncdregfat := v_conta.cd_reg_fat; --PDA 157595

            Ncdregfat    := v_Conta(1).Cd_Reg_Fat; --PDA 157595

            Ncdconvconta := v_Conta(1).Cd_Convenio; --PDA 233500

            Ncdplanconta := v_Conta(1).Cd_Con_Pla; --PDA 233500

          END IF;

        END IF;

        Ncdsetor := v_Mvto.Cd_Setor;

        --PDA 97603 18/05/2004 Sp?ola (INICIO)

        --A abertura DO CURSOR C_PROCED estava sendo feita aqui. Este CURSOR foi movido para o inicio da rotina para que rotinas que

        --necessitam dos dados deste podessem utilizar.

        --PDA 97603 (FIM)

        IF v_Proced.Cd_Pro_Fat IS NULL THEN

          RAISE Prod_Nao_Conf;

        END IF;

        --PDA 175957 (In?o) 16/03/2007 - Pedro Neiva(Apply)

        Vsnchecapreconolcto := Dbamv.Fnc_Ffcv_Verifica_Preco_Lcto(v_Mvto.Tp_Atendimento);

        IF Nvl(Vsnchecapreconolcto, 'N') = 'S' AND NOT Deleting THEN

          -- pda 118991 (colocada 2 condi? p/ n?verificar pre?ao excluir)

          -- IF NVL (v_config.sn_checa_preco_lcto, 'N') = 'S' AND NOT DELETING THEN -- pda 118991 (colocada 2 condi? p/ n?verificar pre?ao excluir)

          --PDA 175957 (Fim) 16/03/2007 - Pedro Neiva(Apply)

          Bexistepreco := Dbamv.Val_Proc_Ffcv_Resumido(v_Proced.Cd_Pro_Fat ||

                                                       v_Mvto.Cd_Setor -- PDA 194962 - Pedro Neiva - 23/08/2007

                                                      ,

                                                       v_Mvto.Dt_Mov_Cardapio,

                                                       v_Mvto.Dt_Mov_Cardapio,

                                                       v_Mvto.Cd_Convenio,

                                                       v_Mvto.Cd_Con_Pla,

                                                       v_Mvto.Tp_Atendimento,

                                                       v_Mvto.Cd_Tip_Acom,

                                                       Cmensret,

                                                       'Nutricao',

                                                       Ncdopcao);

          IF Bexistepreco = FALSE THEN

            Raise_Application_Error(-20050, Cmensret);

          END IF;

        END IF;

        OPEN c_Grfat(v_Proced.Cd_Gru_Pro, Ncdsetor);

        FETCH c_Grfat

          INTO Ncdgrufat;

        CLOSE c_Grfat;

        IF Ncdgrufat IS NULL THEN

          Ncdgrufat := v_Proced.Cd_Gru_Fat;

        END IF;

        IF Ncdgrufat IS NULL THEN

          RAISE Setor_Nao_Conf;

        END IF;

        -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

        IF Ctpproibicao = 'AG' THEN

          Csnguia := 'S';

        END IF;

        /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

        nQtExcedeu a vari?l retorna justamente a quantidade de procedimentos que deve ser lan?o no procedimento

        que pertence ao pacote, em seguida deve ser inserdio um outro procedimento com o que restou do lan?ento*/

        Nqtexcedeu := NULL;

        --

        /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

        vTpContaPart a vari?l retorna justamente se o procedimento vai ser inserido em uma conta particular ou ira seguir

        o processo normalmente.*/

        Ncdpacote := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Gera_Pacote(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                 v_Mvto.Cd_Atendimento),

                                                             v_Mvto.Tp_Atendimento,

                                                             v_Mvto.Cd_Convenio,

                                                             v_Mvto.Cd_Con_Pla,

                                                             Ncdregfat,

                                                             Ncdgrufat,

                                                             v_Proced.Cd_Pro_Fat,

                                                             Ncdsetor,

                                                             NULL,

                                                             v_Mvto.Dt_Mov_Cardapio,

                                                             Ncdmovcardapio,

                                                             Ncditemmvto,

                                                             'Nutricao',

                                                             Csnguia,

                                                             Nqtprofat,

                                                             Csnpacote,

                                                             Nqtexcedeu -- OP 387

                                                            ,

                                                             Vtpcontapart -- OP 387

                                                            ,

                                                             NULL

                                                             -- PDA 225086 (Inicio)

                                                            ,

                                                             v_Mvto.Cd_Atendimento,

                                                             NULL --pCdProFatPacote

                                                            ,

                                                             Ncdlcto --pCdLancamento_pac

                                                            ,

                                                             NULL); --preserva

        -- PDA 225086 (fim)

        /* pda 481126 - depois da FNC_GERA_PACOTE regravando o cd_lancamento_pac */

        IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

          OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncdregfat);

          FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

            INTO Ncdlcto;

          CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

        END IF;

        --

        IF Ncdpacote IS NOT NULL THEN

          UPDATE Dbamv.Conta_Pacote

             SET Cd_Lancamento_Pac = Ncdlcto

           WHERE Cd_Conta_Pacote = Ncdpacote;

        END IF;

        /* pda 481126 - fim */

        /*OPEN dbamv.pack_lanca_ffcv.c_pacotehosp (ncdregfat);

        FETCH dbamv.pack_lanca_ffcv.c_pacotehosp INTO csnpacote;

        CLOSE dbamv.pack_lanca_ffcv.c_pacotehosp;*/

        -- PDA 157145 (Inicio)

        /* pda 145435 - 23/03/2006 - Jose Roberto                              (*)

        Alterando a verifica? da guia, retirando os cursores c_qtdexistente_amb e

        c_qtdexistente_fat para utilizar a nova fun? FNC_RETORNA_GUIA_DISPONIVEL;

        Retiradas as verifica?s nos cursores c_guia, c_itguia e c_itguia_proc_auto;

        Retirado o uso das vari?is totallancado e nqtautorizado;

        Caso NCDGUIA for Nulo, chamando a fun? F_GRAVA_GUIA, alterando o terceiro

        par?tro para nqtprofat;

        Retirado todo o c?ulo feito para atribuir valor as vari?is nqtpart,

        nqtconv e limite;

        Caso retorne uma Guia dispon?l, atribuI-la ?ari?l NCDGUIA.         */

        IF Ctpproibicao = 'AG' THEN

          /*PDA 374303 - 25/06/2010 - Juliana Vieira

          Replicando mesma altera? do PDA 312488, por?para outros lan?entos autom?cos.

          na chamada da fun? que retorna se tem uma guia dispon?l, passar sempre o codigo do atendimento

          pai caso tiver, pois o sistma pode criar atendimentos de recem nascido onde n?existe conta para ele e n??ecess?o

          crioar guias para os atendimentos filhos.*/

          Ncdguia := Dbamv.Pkg_Ffcv_Guia.Fnc_Retorna_Guia_Disponivel(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                         v_Mvto.Cd_Atendimento),

                                                                     Ncdregfat,

                                                                     NULL,

                                                                     v_Proced.Cd_Pro_Fat,

                                                                     Nqtprofat,

                                                                     NULL,

                                                                     NULL,

                                                                     Nguiapendente);

          IF Nvl(v_Config.Sn_Guia_Proc_Auto, 'N') = 'S' THEN

            IF Ncdguia IS NULL THEN

              Ncdguia := Dbamv.f_Grava_Guia(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                v_Mvto.Cd_Atendimento),

                                            v_Mvto.Cd_Convenio,

                                            Nqtprofat,

                                            v_Proced.Cd_Pro_Fat,

                                            'P');

            END IF;

          END IF;

        END IF;

        -- pda 145435 (Fim)

        IF Inserting THEN

          -- PDA 123016 (Inicio) - Henrique Antunes - 06/07/2005

          DECLARE

            Vqtd NUMBER;

          BEGIN

            OPEN Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco(Ncdregfat,

                                                        v_Mvto.Dt_Mov_Cardapio,

                                                        v_Mvto.Dt_Mov_Cardapio);

            FETCH Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco

              INTO Vqtd;

            CLOSE Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco;

            IF Nvl(Vqtd, 0) <> 0 THEN

              RAISE Auditoria_In_Loco;

            END IF;

          END;

          /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

          que o procedimento que ira ser inserido abaixo pertence a um pacote, e a qunatidade que sera inserida sera menor que a lan?a, a diferen?

          sera lan?a na rotina mais abaixo atravez da procedure PRC_DESVINCULA_PROCEDIMENTO*/

          /* Fazendo tratamento caso o procedimento esteja configurado no gabarito para ser inserido dentro de uma conta particular

          caso a variavel vTpContaPart esteja preenchida e a quantidade de lan?ento extra esteja nula. com iso deve ser procurado uma conta particular

          e um lan?ento para inseririr nesta conta.*/

          Nconta := NULL;

          Nlanc  := NULL;



			/*43289 - quebra de conta por quantidade de procedimento por atendimento*/

			/*A regra de pacote tem prioridade sobre essa regra, conforme vari?l Nqtexcedeu abaixo*/

			IF Nqtexcedeu IS NULL THEN

				if (not vSnCriouContaAuto) then /*OP 46768*/



					  IF DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_EXISTE_CONF_QTD_ATEND_PAC(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																						                                  v_proced.cd_pro_fat,

																						                                  pEmpresa) THEN



						  Nqtexcedeu := DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_RETORNA_QTD_LANC_PERIODO(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																									                                        v_proced.cd_pro_fat,

																									                                        pEmpresa,

																									                                        ncdregfat,

																									                                        nvl(nqtmovnew, 1),

																									                                        pSnChamadoDaTela,

																									                                        pvSnJaExcedeuQtd,

																									                                        pvMensagem

																									                                        );

						  IF pvSnJaExcedeuQtd = 'S' THEN

							  Vtpcontapart := 'ProcPorAtend';

							  Nqtexcedeu   := NULL;

						  ELSE

								IF NVL(Nqtexcedeu,0) > 0 THEN

									Vtpcontapart := 'ProcPorAtend';

								END IF;

						  END IF;

					END IF;

				END IF;	/*OP 46768*/

		    END IF;

			/*43289*/



          IF Nvl(Vtpcontapart, 'X') <> 'X' AND Nqtexcedeu IS NULL THEN

            Nconta := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                       v_Mvto.Cd_Atendimento),

                                                                   v_Mvto.Dt_Mov_Cardapio);

            OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Nconta);

            FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

              INTO Nlanc;

            CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

          END IF;

          -- PDA 123016 (Fim)

          INSERT INTO Dbamv.Itreg_Fat

            (Cd_Reg_Fat,

             Cd_Lancamento,

             Dt_Lancamento,

             Hr_Lancamento,

             Qt_Lancamento,

             Cd_Guia,

             Vl_Percentual_Multipla,

             Cd_Gru_Fat,

             Cd_Pro_Fat,

             Sn_Pertence_Pacote,

             Cd_Setor,

             Cd_Setor_Produziu,

             Sn_Horario_Especial,

             Cd_Usuario,

             Cd_Mvto,

             Tp_Mvto,

             Cd_Itmvto -- PDA 99872 - 29/12/2005

             -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

            ,

             Cd_Conta_Pacote

             -- PDA 157145 (Fim)

             )

          VALUES

            (Nvl(Nconta, Ncdregfat) -- OP 387

            ,

             Nvl(Nlanc, Ncdlcto) -- OP 387

            ,

             v_Mvto.Dt_Mov_Cardapio,

             v_Mvto.Dt_Mov_Cardapio,

             Nvl(Nqtexcedeu, Nvl(Nqtmovnew, 1)) -- OP 387

            ,

             Ncdguia,

             100,

             Ncdgrufat,

             v_Proced.Cd_Pro_Fat,

             Nvl(Csnpacote, 'N'),

             Ncdsetor,

             Ncdsetor,

             'N',

             USER,

             Ncdmovcardapio,

             Nvl(Vtpcontapart, 'Nutricao') -- OP 387

            ,

             Ncditemmvto -- PDA 99872 - 29/12/2005

             -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

            ,

             Ncdpacote

             -- PDA 157145 (Fim)

             );



              /*OP 42241 - Caso tenha criado a conta por cargo paciente, devemos lan? o item para o convenio, plano, percentual definido na configura

              de quebra de conta por cargo paciente*/

              IF (vSnCriouContaAutoCP) THEN

                  vSnCriouContaAutoCP := FALSE;



                  OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(v_ContaCargoPac(1).cd_reg_fat);

                  FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                  INTO NcdlctoCp;

                  CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;



                   INSERT INTO Dbamv.Itreg_Fat

                    (Cd_Reg_Fat,

                     Cd_Lancamento,

                     Dt_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Vl_Percentual_Multipla,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Sn_Pertence_Pacote,

                     Cd_Guia,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto,

                     Cd_Itmvto

                     )

                  VALUES

                    (v_ContaCargoPac(1).cd_reg_fat,

                     NcdlctoCp,

                     v_Mvto.Dt_Mov_Cardapio,

                     v_Mvto.Dt_Mov_Cardapio,

                     Nvl(Nqtexcedeu, Nvl(Nqtmovnew, 1)),

                     vRegraCriaContaAutoCP(1).vl_percentual_carga_familiar,

                     Ncdgrufat,

                     v_Proced.Cd_Pro_Fat,

                     'N',

                     Ncdguia,

                     Ncdsetor,

                     Ncdsetor,

                     'N',

                     USER,

                     Ncdmovcardapio,

                     Nvl(Vtpcontapart, 'Nutricao'),

                     Ncditemmvto

                     );

              END IF;

              /*OP 42241*/





          /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

          que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

          os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

          IF Nqtexcedeu IS NOT NULL THEN

            Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregfat,

                                                                Ncdlcto,

                                                                (Nvl(Nqtmovnew,

                                                                     1) -

                                                                Nqtexcedeu),

                                                                Vtpcontapart,

                                                                v_Mvto.Dt_Mov_Cardapio,

																nvl(v_mvto.cd_atendimento_pai, v_mvto.cd_atendimento)); /*ALLS OP 43289*/



          END IF;

          /* OP 387 - Thiago Miranda de oliveira - este trecho de c??o somente sera utilizado se a configura? de gerar o item em conta de particular

          por causa do pacote, n?estiver preenchido*/

          IF Nvl(Vtpcontapart, 'X') = 'X' THEN

            IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                          Ncdlcto,

                                                          'I') THEN

              IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                            Ncdlcto,

                                                            'I') THEN

                Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'I');

              END IF;

            END IF;

          END IF;

          --PDA 108042 22/11/2004 Sp?ola (INICIO)

          --Inserida a rotina de valores relacionados

          -- /* Lancamento dos Valores Relacionados */ --

          DECLARE

            CURSOR Crelacionados IS

              SELECT Rela.Cd_Pro_Fat,

                     Rela.Tp_Atend_Homecare,

                     Rela.Tp_Atend_Externo,

                     Rela.Tp_Atend_Urgeme,

                     Rela.Tp_Atend_Ambulatorial,

                     Rela.Tp_Atend_Internacao,

                     --PDA 108042 22/11/2004 Sp?ola (INICIO)

                     --Inserida a coluna qt_lancamento que ir?ultiplicar a quantidade na rotina Dbamv.lanca_ffcv_pro_relacionados

                     Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

              --PDA 108042 (FIM)

                FROM /*Dbamv.Con_Pla

                     ,*/ Dbamv.Regra,

                     Dbamv.Val_Pro_Relacionado Rela,

                     Dbamv.Empresa_Con_Pla /* PDA 118607/131598 */

                        ,dbamv.pro_fat             -- OP 32555 *2

               WHERE --Empresa_Con_Pla.Cd_Convenio = Con_Pla.Cd_Convenio /* PDA 118607/131598 */

--               AND Empresa_Con_Pla.Cd_Con_Pla = Con_Pla.Cd_Con_Pla /* PDA 118607/131598 */

--               AND

                Empresa_Con_Pla.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/131598 */



					 -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

                     --AND Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat

					 and ( ( rela.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = rela.cd_pro_fat and Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					    or ( rela.cd_pro_fat_pai is null and rela.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                             AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

					     )

				     -- OP 32555 - fim



               AND Empresa_Con_Pla.Cd_Convenio = v_Mvto.Cd_Convenio  -- PDA 674233

               AND Empresa_Con_Pla.Cd_Con_Pla = v_Mvto.Cd_Con_Pla   -- PDA 674233

               AND Rela.Tp_Lancamento = 'A'

               --PDA 114239 17/01/2005 Sp?ola (INICIO)

               --Incluida verifica? por tipo de atendimento para os procedimentos relacionados

               AND

                ((v_Mvto.Tp_Atendimento = 'H' AND

                Rela.Tp_Atend_Homecare = 'S') OR

                (v_Mvto.Tp_Atendimento = 'E' AND

                Rela.Tp_Atend_Externo = 'S') OR

                (v_Mvto.Tp_Atendimento = 'U' AND Rela.Tp_Atend_Urgeme = 'S') OR

                (v_Mvto.Tp_Atendimento = 'A' AND

                Rela.Tp_Atend_Ambulatorial = 'S') OR

                (v_Mvto.Tp_Atendimento = 'I' AND

                Rela.Tp_Atend_Internacao = 'S'))

               --PDA 114239 (FIM)

               /* pda 407641 - thiago miranda de oliveira*/

               --AND con_pla.cd_regra = regra.cd_regra

               AND Empresa_Con_Pla.Cd_Regra = Regra.Cd_Regra

               /* fim pda 407641*/

               AND Rela.Cd_Regra = Regra.Cd_Regra

               --PDA 97407 - Eduardo Santis 08/07/2004 - (Inicio)

               AND Dt_Vigencia IN

                (SELECT MAX(Vpr.Dt_Vigencia)

                   FROM Dbamv.Val_Pro_Relacionado Vpr

                  WHERE Vpr.Dt_Vigencia <= v_Mvto.Dt_Mov_Cardapio

                       -- PDA 105921 (In?o) - 14/09/2004 - Pollyane K. A. Nunes

                       -- Inclui a verifica? da vig?ia por regra e procedimento

                    AND Vpr.Cd_Regra = Rela.Cd_Regra

                             -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

					         -- AND Vpr.Cd_Pro_Fat_Pai = Rela.Cd_Pro_Fat_Pai

					         -- AND Vpr.Cd_Pro_Fat = Rela.Cd_Pro_Fat

					         and ( ( Vpr.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = Vpr.cd_pro_fat and Vpr.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					            or ( Vpr.cd_pro_fat_pai is null and Vpr.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                                     AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

						          )

						     -- OP 32555 - fim

					);

            -- PDA 105921 -- (Fim)

            --PDA 97407 - Eduardo Santis 08/07/2004 - (Fim)

            Cretorno       VARCHAR2(1);

            Vcrelacionados Crelacionados%ROWTYPE;

          BEGIN

            FOR Vcrelacionados IN Crelacionados

            LOOP

              Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(v_Mvto.Cd_Atendimento,

                                                            Ncdregfat,

                                                            Ncdlcto,

                                                            Ncdmovcardapio,

                                                            v_Proced.Cd_Pro_Fat,

                                                            v_Mvto.Dt_Mov_Cardapio,

                                                            v_Mvto.Dt_Mov_Cardapio,

                                                            v_Mvto.Cd_Setor,

                                                            'P',

                                                            v_Mvto.Tp_Atendimento,

                                                            NULL /*PDA 116436 14/03/2005 Sp?ola - Parametro dt_atendimento n?utilizado pela fun?*/,

                                                            v_Mvto.Cd_Convenio,

                                                            v_Mvto.Cd_Con_Pla,

                                                            v_Mvto.Cd_Atendimento_Pai,

                                                            NULL /*PDA 116436 14/03/2005 Sp?ola - Parametro tp_convenio n?utilizado pela fun?*/,

                                                            v_Mvto.Dt_Alta,

                                                            Vcrelacionados.Cd_Pro_Fat

                                                            --PDA 108042 22/11/2004 Sp?ola (INICIO)

                                                            --As quantidades lan?a ser?ultiplicadas pelo fator de quantidade qt_lancamento

                                                           ,

                                                            Vcrelacionados.Qt_Lancamento *

                                                            Nvl(Nqtmovnew, 1),

                                                            Vcrelacionados.Qt_Lancamento *

                                                            Nvl(Nqtmovnew, 1), --PDA 108042 (FIM)

                                                            'I'

                                                            --PDA 108070 29/12/2004 Sp?ola (INICIO)

                                                            --Inserido o campo do prestador que ser?tilizado apenas para os procedimentos relacionados de ambulatorio

                                                            --lancadados pela prc_ffcv_lanca_atendimento - lancamento automatico do procedimento principal na criacao do atendimento

                                                           ,

                                                            NULL --cd_prestador

                                                            --PDA 108070 (FIM)

                                                            -- pda 119975 - 29/05/2005 - Amalia Ara??

                                                            -- par?tro de fator relacionado para insert nas tabelas itreg_amb e itreg_fat

                                                           ,

                                                            Vcrelacionados.Qt_Lancamento

                                                            -- pda 119975 - fim

                                                            );

            END LOOP;

          END;

          --PDA 108042 (FIM)

        ELSE

          IF Deleting THEN

            Nqtprofat := 0;

          ELSE

            Nqtprofat := Nvl(Nqtmovnew, 1);

          END IF;

          Ndiferenca := Nvl(Nqtprofat, 1) - Nvl(Nqtmovold, 1);

          /* PDA 476298 - 475670

          OPEN dbamv.pack_lanca_ffcv.c_itregfat (ncdregfat, v_proced.cd_pro_fat);

          FETCH dbamv.pack_lanca_ffcv.c_itregfat INTO v_itregfat;

          CLOSE dbamv.pack_lanca_ffcv.c_itregfat;

          */

          OPEN c_Itregfatmvto(Ncdregfat,

                              v_Proced.Cd_Pro_Fat,

                              Ncdmovcardapio);

          FETCH c_Itregfatmvto

            INTO v_Itregfatmov;

          CLOSE c_Itregfatmvto;

          /* FIM PDA 476298 - 475670*/

          -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

          /* PDA 476298 - 475670

          ncdregfat := v_itregfat.cd_reg_fat;

          ncdlcto := v_itregfat.cd_lancamento;

          */

          Ncdregfat := v_Itregfatmov.Cd_Reg_Fat;

          Ncdlcto   := v_Itregfatmov.Cd_Lancamento;

          /* FIM PDA 476298 - 475670*/

          /*  PDA 476298 -  475670*/

          --IF v_itregfat.cd_lancamento IS NOT NULL THEN

          IF v_Itregfatmov.Cd_Lancamento IS NOT NULL THEN

            /* FIM PDA 476298 - 475670*/

            --

            /* pda 141006 - 06/06/2006 - Amalia Ara??

            Identificando a guia do item. Caso encontre e a mesma ainda esteja Pendente,

            ir?etirar mais abaixo a mesma quantidade que est?etirando da conta.       */

            Ncdguiaitem := NULL;

            OPEN Dbamv.Pkg_Ffcv_Guia.Cguianoitem(Ncdregfat,

                                                 Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                     v_Mvto.Cd_Atendimento),

                                                 Ncdlcto);

            FETCH Dbamv.Pkg_Ffcv_Guia.Cguianoitem

              INTO Ncdguiaitem;

            CLOSE Dbamv.Pkg_Ffcv_Guia.Cguianoitem;

            /* pda 141006 - fim */

            --

            --IF v_itregfat.qt_lancamento + ndiferenca <= 0 THEN

            IF v_Itregfatmov.Qt_Lancamento + Ndiferenca <= 0 THEN

              /*  FIM PDA 476298 - 475670*/

              --

              -- PDA 156270 (Inicio) - Marcelo Berenguer - 01/08/2006

              DECLARE

                Vqtd NUMBER;

              BEGIN

                OPEN Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco(Ncdregfat,

                                                            v_Mvto.Dt_Mov_Cardapio,

                                                            v_Mvto.Dt_Mov_Cardapio);

                FETCH Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco

                  INTO Vqtd;

                CLOSE Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco;

                IF Nvl(Vqtd, 0) <> 0 THEN

                  RAISE Auditoria_In_Loco;

                END IF;

              END;

              -- PDA 156270 (Fim)

              IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                            Ncdlcto,

                                                            'E') THEN

                IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                              Ncdlcto,

                                                              'E') THEN

                  Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'E');

                END IF;

              END IF;

              --

              DELETE Dbamv.Itreg_Fat

               WHERE Cd_Reg_Fat = Ncdregfat

                 AND Cd_Lancamento = Ncdlcto;

              --

              /* PDA 288525 - 05/06/2009 - In?o - Fabr?o Oliveira de Miranda

              A chamada desta procedure estava ocorrendo antes de apagar o item da conta e podia

              ocorrer erro caso a guia fosse deletada sem deletar o item da conta antes. */

              /* pda 141006 - 06/06/2006 - Amalia Ara??

              Retirando o item da guia, caso haja e a guia ainda esteja Pendente. */

              IF Ncdguiaitem IS NOT NULL THEN

                Dbamv.Pkg_Ffcv_Guia.Prc_Retirar_Item_Guia(Ncdguiaitem,

                                                          v_Proced.Cd_Pro_Fat,

                                                          /*  PDA 476298 - 475670*/

                                                          --v_itregfat.qt_lancamento );

                                                          v_Itregfatmov.Qt_Lancamento);

                /* FIM  PDA 476298 - 475670*/

              END IF;

              /* PDA 288525 - 05/06/2009 - Fim - Fabr?o Oliveira de Miranda */

              --

              /* pda 141006 - fim */

              --

            ELSE

              --

              UPDATE Dbamv.Itreg_Fat

                 SET Qt_Lancamento           = Qt_Lancamento + Ndiferenca,

                     Vl_Unitario             = NULL,

                     Vl_Filme_Unitario       = NULL,

                     Vl_Acrescimo            = NULL,

                     Vl_Desconto             = NULL,

                     Vl_Honorario_Unitario   = NULL,

                     Vl_Operacional_Unitario = NULL,

                     Vl_Total_Conta          = NULL

               WHERE Cd_Reg_Fat = Ncdregfat

                 AND Cd_Lancamento = Ncdlcto;

              IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                            Ncdlcto,

                                                            'A') THEN

                IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                              Ncdlcto,

                                                              'A') THEN

                  Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'A');

                END IF;

              END IF;

            END IF;

          END IF;

        END IF;

      END IF;

    END IF;

  EXCEPTION

    WHEN Atend_Sem_Conta THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 -- v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdmovcardapio,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Nutricao',

                     '04'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_4',

                                                       'PACK_LANCA_FFCV',

                                                       'Atendimento %s n?possui Conta aberta/disponivel.',



                                                       Arg_List(v_Mvto.Cd_Atendimento)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     v_Mvto.Cd_Atendimento,

                     TRUE,

                     Deleting,

                     v_Mvto.Dt_Mov_Cardapio);

    WHEN Fora_Da_Conta THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdmovcardapio,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Nutricao',

                     '08'

                     --,'Procedimento com proibi? tipo Fora da Conta'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_8',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento com proibi? tipo Fora da Conta.',



                                                       Arg_List()) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     v_Mvto.Cd_Atendimento,

                     TRUE,

                     Deleting,

                     v_Mvto.Dt_Mov_Cardapio);

    WHEN Prod_Nao_Conf THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdmovcardapio,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Nutricao',

                     '01'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_13',

                                                       'PACK_LANCA_FFCV',

                                                       'Op? de Cardapio %s n?tem relacionamento com Faturamento de Convenio.',

                                                       Arg_List(Ncdopcao)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     v_Mvto.Cd_Atendimento,

                     TRUE,

                     Deleting,

                     v_Mvto.Dt_Mov_Cardapio);

    WHEN Setor_Nao_Conf THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdmovcardapio,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Nutricao',

                     '02'

                     --, 'Grupo de Procedimento ' || v_proced.cd_gru_pro || ' n?tem Grupo de Faturamento relacionado'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_14',

                                                       'PACK_LANCA_FFCV',

                                                       'Grupo de Procedimento %s n?tem Grupo de Faturamento relacionado.',



                                                       Arg_List(v_Proced.Cd_Gru_Pro)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     v_Mvto.Cd_Atendimento,

                     TRUE,

                     Deleting,

                     v_Mvto.Dt_Mov_Cardapio);

    WHEN Proc_Proibido THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdmovcardapio,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Nutricao',

                     '05'

                     --, 'Procedimento proibido para o Convenio ' || LTRIM (TO_CHAR (v_conta.cd_convenio)) || ' e Plano ' || LTRIM (TO_CHAR (v_conta.cd_con_pla)) --PDA 157595

                     --, 'Procedimento proibido para o Convenio ' || LTRIM (TO_CHAR (nCdConvConta)) || ' e Plano ' || LTRIM (TO_CHAR (nCdPlanConta))--PDA 157595

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_7',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento proibido para o Convenio %s e Plano %s.',

                                                       Arg_List(Ltrim(To_Char(Ncdconvconta)),

                                                                Ltrim(To_Char(Ncdplanconta)))) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     v_Mvto.Cd_Atendimento,

                     TRUE,

                     Deleting,

                     v_Mvto.Dt_Mov_Cardapio);



	-- OP 32555

    WHEN Proc_Proibido_idade THEN

	  -- OP 33697 - 05/10/2015 - Substituindo Gera_Log_Falha por Raise_Application_Error.

      Raise_Application_Error(-20054, Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20','PACK_LANCA_FFCV',

                                'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                Arg_List(v_Proced.Cd_Pro_Fat)));

      /*Gera_Log_Falha(Ncdregfat,

                     NULL,

                     Ncdmovcardapio,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Nutricao',

                     '05',

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                                       Arg_List(v_Proced.Cd_Pro_Fat))

                    ,

                     v_Mvto.Tp_Atendimento,

                     v_Mvto.Cd_Atendimento,

                     TRUE,

                     Deleting,

                     v_Mvto.Dt_Mov_Cardapio); */





    WHEN Auditoria_In_Loco THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdmovcardapio,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Nutricao',

                     '10'

                     --, 'O periodo da conta ' || v_conta.cd_reg_fat || ' est?m auditoria in-loco no momento do lan?ento' --PDA 157595

                     --, 'O periodo da conta ' || nCdRegFat || ' est?m auditoria in-loco no momento do lan?ento' --PDA 157595

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_15',

                                                       'PACK_LANCA_FFCV',

                                                       'O periodo da conta %s est?m auditoria in-loco no momento do lan?ento.',

                                                       Arg_List(Ncdregfat)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     v_Mvto.Cd_Atendimento,

                     TRUE,

                     Deleting,

                     v_Mvto.Dt_Mov_Cardapio);

  END;



  PROCEDURE Lanca_Pagu_Ffcv(Ncdpremed          IN NUMBER,

                            Ncddevpre          IN NUMBER,

                            Ncdtippresc        IN NUMBER,

                            Ncdprestador       IN NUMBER,

                            Ncdsetexa          IN NUMBER,

                            Nqtnew             IN NUMBER,

                            Nqtold             IN NUMBER,

                            Caction            IN VARCHAR2,

                            Ncditemmvto        IN NUMBER,

                            Ncd_Setor          IN NUMBER,

                            Vdh_Cancelado      IN DATE, -- pda 86938 - 05/02/2004 - Amalia Ara??- novos par?tros

                            Pncdatendimento    IN NUMBER,

                            Pddtpremed         IN DATE,

                            Pdhrpremed         IN DATE,

                            Pncdunidint        IN NUMBER,

                            Pncdprestadorpresc IN NUMBER) IS

    -- pda 86938 - fim

    CURSOR c_Config IS

      SELECT Config_Ffcv.Sn_Prescricao_Automatica,

             Config_Ffcv.Cd_Ati_Med_Clinico,

             Config_Ffcv.Cd_Convenio_Fat_Extra,

             Config_Ffcv.Cd_Con_Pla_Fat_Extra,

             Config_Ffcv.Sn_Checa_Preco_Lcto,

             Config_Ffcv.Sn_Guia_Proc_Auto

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;



   CURSOR c_Proced IS

      SELECT Tip_Presc.Cd_Pro_Fat

             --PDA 200307 (Inicio)

             --,tip_presc.sn_fatura

            ,

             Decode(Tip_Presc.Cd_Pro_Fat, NULL, 'N', 'S') Sn_Fatura

             --PDA 200307 (Fim)

            ,

             Gru_Pro.Cd_Gru_Fat,

             Pro_Fat.Cd_Gru_Pro,

             Tip_Presc.Cd_Tip_Presc,

             Tip_Presc.Ds_Tip_Presc,

             Pro_Fat.Nr_Auxiliar

             -- PDA 182967 (Inicio) - Henrique Antunes - 01/06/2007

            ,

             Tip_Presc.Sn_Liga_Desligar

             -- PDA 182967 (Fim)

            , -- pda 106359

             Pro_Fat.Cd_Por_Ane -- pda 106359

        FROM Dbamv.Tip_Presc,

             Dbamv.Pro_Fat,

             Dbamv.Gru_Pro

       WHERE Tip_Presc.Cd_Tip_Presc = Ncdtippresc

         AND Pro_Fat.Cd_Pro_Fat(+) = Tip_Presc.Cd_Pro_Fat

         AND Pro_Fat.Cd_Gru_Pro = Gru_Pro.Cd_Gru_Pro(+);



    -- OP 33697 *2 - 08/10/2015 - Identificar os dados pelo procedimento, por causa da regra de substitui? de procedimento.

    CURSOR cProcedProFat( vProFat in varchar2 ) IS

      SELECT Tip_Presc.Cd_Pro_Fat

            ,Decode(Tip_Presc.Cd_Pro_Fat, NULL, 'N', 'S') Sn_Fatura

            ,Gru_Pro.Cd_Gru_Fat,

             Pro_Fat.Cd_Gru_Pro,

             Tip_Presc.Cd_Tip_Presc,

             Tip_Presc.Ds_Tip_Presc,

             Pro_Fat.Nr_Auxiliar

            ,Tip_Presc.Sn_Liga_Desligar

            ,Pro_Fat.Cd_Por_Ane

        FROM Dbamv.Tip_Presc,

             Dbamv.Pro_Fat,

             Dbamv.Gru_Pro

       WHERE Tip_Presc.Cd_Pro_Fat = vProFat

         AND Pro_Fat.Cd_Pro_Fat(+) = Tip_Presc.Cd_Pro_Fat

         AND Pro_Fat.Cd_Gru_Pro = Gru_Pro.Cd_Gru_Pro(+);

    cursor cGruProSub( vProFat in varchar2 ) is

      select gru_pro.cd_gru_fat

        from dbamv.pro_fat, dbamv.gru_pro

       where pro_fat.cd_pro_fat = vProFat

         and gru_pro.cd_gru_pro = pro_fat.cd_gru_pro;

    vProFatAnterior   dbamv.pro_fat.cd_pro_fat%type;   -- OP 33697 *2



	 CURSOR c_Mvto IS

    -- pda 86938 - 05/02/2004 - Amalia Ara??- substituindo os campos da pre_med pelos par?tros

    /*  Select pre_med.cd_atendimento,

                      pre_med.dt_pre_med,

                      pre_med.hr_pre_med,

                      pre_med.cd_unid_int,

                      pre_med.cd_prestador,

                      Nvl( pre_med.cd_setor, unid_int.cd_setor ) Cd_Setor,  */

      SELECT Pncdatendimento Cd_Atendimento

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- ,pddtpremed dt_pre_med

            ,

             To_Date(To_Char(Pddtpremed, 'DD/MM/YYYY') || ' ' ||

                     To_Char(Pdhrpremed, 'HH24:Mi:SS'),

                     'DD/MM/YYYY HH24:MI:SS') Dt_Pre_Med

             -- PDA 229502 (Fim)

            ,

             Pdhrpremed         Hr_Pre_Med,

             Pncdunidint        Cd_Unid_Int,

             Pncdprestadorpresc Cd_Prestador,

             Ncd_Setor          Cd_Setor,

             -- pda 86938 - fim

             Atendime.Tp_Atendimento,

             Atendime.Cd_Convenio,

             Atendime.Cd_Con_Pla

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- atendime.dt_atendimento

            ,

             To_Date(To_Char(Atendime.Dt_Atendimento, 'DD/MM/YYYY') || ' ' ||

                     To_Char(Atendime.Hr_Atendimento, 'HH24:Mi:SS'),

                     'DD/MM/YYYY HH24:MI:SS') Dt_Atendimento

             -- ,atendime.dt_alta

            ,

             To_Date(To_Char(Atendime.Dt_Alta, 'dd/mm/yyyy') ||

                     To_Char(Atendime.Hr_Alta, 'hh24:mi'),

                     'dd/mm/yyyy hh24:mi') Dt_Alta

             -- PDA 229502 (Fim)

            ,

             Convenio.Tp_Convenio,

             Atendime.Cd_Atendimento_Pai,

             Atendime.Sn_Importa_Auto,

             'P' Tp_Mvto_Estoque,

             Atendime.Cd_Tip_Acom,

             Atendime.Cd_Convenio_Secundario,

             Atendime.Cd_Con_Pla_Secundario

        FROM Dbamv.Empresa_Convenio,

             Dbamv.Atendime, -- dbamv.unid_int,  -- pda 86938

             --  dbamv.pre_med,  -- pda 86938

             Dbamv.Convenio

       WHERE Convenio.Cd_Convenio = Atendime.Cd_Convenio

         AND Convenio.Cd_Convenio = Empresa_Convenio.Cd_Convenio /* PDA 118607/129023*/

         AND Empresa_Convenio.Cd_Multi_Empresa =

             Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/129023*/

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

         AND Convenio.Tp_Convenio IN ('H', 'P', 'C')

            -- pda 86938 - 05/02/2004 - Amalia Ara??- localizar atendimento com o par?tro



         AND Atendime.Cd_Atendimento = Pncdatendimento -- pre_med.cd_atendimento

      -- and unid_int.cd_unid_int(+) = pnCdUnidInt        -- pre_med.cd_unid_int

      -- and pre_med.cd_pre_med = nCdPreMed

      -- pda 86938 - fim

      UNION

      SELECT Dev_Pre.Cd_Atendimento

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- ,TRUNC (dev_pre.dh_cancelado) dt_pre_med

            ,

             Dev_Pre.Dh_Cancelado Dt_Pre_Med

             -- PDA 229502 (Fim)

            ,

             Dev_Pre.Dh_Cancelado Hr_Pre_Med,

             Dev_Pre.Cd_Unid_Int,

             Dev_Pre.Cd_Prestador,

             Nvl(Dev_Pre.Cd_Setor, Unid_Int.Cd_Setor) Cd_Setor,

             Atendime.Tp_Atendimento,

             Atendime.Cd_Convenio,

             Atendime.Cd_Con_Pla

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- atendime.dt_atendimento

            ,

             To_Date(To_Char(Atendime.Dt_Atendimento, 'DD/MM/YYYY') || ' ' ||

                     To_Char(Atendime.Hr_Atendimento, 'HH24:Mi:SS'),

                     'DD/MM/YYYY HH24:MI:SS') Dt_Atendimento

             -- ,atendime.dt_alta

            ,

             To_Date(To_Char(Atendime.Dt_Alta, 'dd/mm/yyyy') ||

                     To_Char(Atendime.Hr_Alta, 'hh24:mi'),

                     'dd/mm/yyyy hh24:mi') Dt_Alta

             -- PDA 229502 (Fim)

            ,

             Convenio.Tp_Convenio,

             Atendime.Cd_Atendimento_Pai,

             Atendime.Sn_Importa_Auto,

             'C' Tp_Mvto_Estoque,

             Atendime.Cd_Tip_Acom,

             Atendime.Cd_Convenio_Secundario,

             Atendime.Cd_Con_Pla_Secundario

        FROM Dbamv.Dev_Pre,

             Dbamv.Unid_Int,

             Dbamv.Atendime,

             Dbamv.Convenio,

             Dbamv.Empresa_Convenio

       WHERE Ncdpremed IS NULL

         AND Convenio.Cd_Convenio = Empresa_Convenio.Cd_Convenio /* PDA 118607/129023*/

         AND Empresa_Convenio.Cd_Multi_Empresa =

             Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/129023*/

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

         AND Dev_Pre.Cd_Dev_Pre = Ncddevpre

            -- 86780 -- 10/12/2003 -- Alexandre Erik C. M Costa -- (Inicio)

            -- n??brigado informar a unidade de interna? na tela, por isso foi necess?o adicionar o simbolo de outer join

         AND Unid_Int.Cd_Unid_Int(+) = Dev_Pre.Cd_Unid_Int

            -- 86780 -- (Fim)

         AND Atendime.Cd_Atendimento = Dev_Pre.Cd_Atendimento

         AND Convenio.Cd_Convenio = Atendime.Cd_Convenio

         AND Convenio.Tp_Convenio IN ('H', 'P', 'C');

    CURSOR c_Grfasetorexame(Ngrpr IN NUMBER, Nsetor IN NUMBER) IS

      SELECT Setor_Gru_Fat.Cd_Gru_Fat

        FROM Dbamv.Setor_Gru_Fat

       WHERE Setor_Gru_Fat.Cd_Setor = Nsetor

         AND Setor_Gru_Fat.Cd_Gru_Pro = Ngrpr;

    CURSOR c_Setor IS

      SELECT Set_Exa.Cd_Setor,

             Set_Exa.Cd_Prestador

        FROM Dbamv.Set_Exa

       WHERE Set_Exa.Cd_Set_Exa = Ncdsetexa;

    CURSOR c_Config_Particular IS

      SELECT Cd_Convenio_Fat_Extra Cd_Convenio,

             Cd_Con_Pla_Fat_Extra  Cd_Con_Pla

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    -- PDA 229203 (In?o) - 22/05/2008 - Diego Costa

    -- inclus?do atendimento pai na consulta de existencia de conta.

    CURSOR c_Existeconta(Atendimento IN NUMBER, Ncdatendimentopai IN NUMBER) IS

      SELECT Reg_Fat.Cd_Reg_Fat

        FROM Dbamv.Reg_Fat,

             Dbamv.Itreg_Fat,

             Dbamv.Convenio

       WHERE Cd_Atendimento = Nvl(Ncdatendimentopai, Atendimento)

         AND Reg_Fat.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /*PDA 118607/127754*/

         AND Convenio.Cd_Convenio = Reg_Fat.Cd_Convenio

         AND Reg_Fat.Cd_Reg_Fat = Itreg_Fat.Cd_Reg_Fat

         AND Tp_Convenio = 'P'

         AND Sn_Fechada = 'N';

    -- PDA 229203 (fim)

    CURSOR c_Itregfat_Pagu(Nconta IN Dbamv.Itreg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/

    , Cprofat IN VARCHAR2, Pcd_Pre_Med IN NUMBER, Pcd_Prestador IN NUMBER, Pcd_Setor IN NUMBER, Pcd_Itemmvto IN NUMBER) IS

      SELECT Itreg_Fat.Cd_Lancamento,

             Itreg_Fat.Qt_Lancamento

             -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

            ,

             Itreg_Fat.Cd_Reg_Fat

      -- PDA 167142 (Fim)

        FROM Dbamv.Itreg_Fat

       WHERE Itreg_Fat.Cd_Reg_Fat = Nconta

         AND Itreg_Fat.Cd_Pro_Fat = Cprofat

            -- PDA 97519 -- Alexandre Erik C. M. Costa -- 04/08/2004

            -- Caso o prestador da conta esteja nulo e o par?tro preenchido o cursor falha

         AND Nvl(Nvl(Itreg_Fat.Cd_Prestador, Pcd_Prestador), 0) =

             Nvl(Pcd_Prestador, Nvl(Itreg_Fat.Cd_Prestador, 0))

         AND Nvl(Itreg_Fat.Cd_Setor, 0) =

             Nvl(Pcd_Setor, Nvl(Itreg_Fat.Cd_Setor, 0))

         AND Nvl(Itreg_Fat.Cd_Mvto, 0) =

             Nvl(Pcd_Pre_Med, Nvl(Itreg_Fat.Cd_Mvto, 0))

            -- PDA 114164 Elias Veloso - inclusao do item de movimento na itreg_fat

         AND Nvl(Itreg_Fat.Cd_Itmvto, 0) =

             Decode(Itreg_Fat.Cd_Itmvto, NULL, 0, Nvl(Pcd_Itemmvto, 0))

      -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

      UNION

      SELECT Itreg_Fat.Cd_Lancamento,

             Itreg_Fat.Qt_Lancamento,

             Itreg_Fat.Cd_Reg_Fat

        FROM Dbamv.Itreg_Fat

       WHERE Itreg_Fat.Cd_Conta_Pai = Nconta

         AND Itreg_Fat.Cd_Pro_Fat = Cprofat

         AND Nvl(Nvl(Itreg_Fat.Cd_Prestador, Pcd_Prestador), 0) =

             Nvl(Pcd_Prestador, Nvl(Itreg_Fat.Cd_Prestador, 0))

         AND Nvl(Itreg_Fat.Cd_Setor, 0) =

             Nvl(Pcd_Setor, Nvl(Itreg_Fat.Cd_Setor, 0))

         AND Nvl(Itreg_Fat.Cd_Mvto, 0) =

             Nvl(Pcd_Pre_Med, Nvl(Itreg_Fat.Cd_Mvto, 0))

         AND Nvl(Itreg_Fat.Cd_Itmvto, 0) =

             Decode(Itreg_Fat.Cd_Itmvto, NULL, 0, Nvl(Pcd_Itemmvto, 0))

      --ORDER BY itreg_fat.qt_lancamento DESC;

       ORDER BY 2 DESC;

    -- PDA 167142 (Fim)

    -- PDA 100970 26/07/2006 Thiago Holder Marcos Silva

    CURSOR Corigem IS

      SELECT Atendime.Cd_Ori_Ate

        FROM Dbamv.Atendime

       WHERE Atendime.Cd_Atendimento = Pncdatendimento

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    -- PDA 100970 (Fim)



        /*OP 41394*/

          CURSOR cProced(pProFat IN VARCHAR2) IS

         SELECT pro_fat.cd_gru_pro

           FROM dbamv.pro_fat

          WHERE pro_fat.cd_pro_fat = pProFat;





      CURSOR cRregra(pConvenio IN NUMBER ,

                     pPlano IN NUMBER) IS

        SELECT p.cd_regra

        FROM dbamv.empresa_con_pla p,

            dbamv.empresa_convenio c

        WHERE p.cd_convenio = c.cd_convenio

          AND p.cd_con_pla  = pPlano

          AND c.cd_convenio = pConvenio

          AND c.cd_multi_empresa = DBAMV.PKG_MV2000.LE_EMPRESA;

      /*OP 41394*/





    Prod_Nao_Conf EXCEPTION;

    Setor_Nao_Conf EXCEPTION;

    Proc_Sem_Preco EXCEPTION;

    Atend_Sem_Conta EXCEPTION;

    Auditoria_In_Loco EXCEPTION;

    Proc_Proibido EXCEPTION;

	proc_proibido_idade   exception;  -- OP 32555

    Fora_Da_Conta EXCEPTION;

    v_Config c_Config%ROWTYPE;

    v_Proced c_Proced%ROWTYPE;

    v_Mvto   c_Mvto%ROWTYPE;

    --PDA 157595(INICIO) 14/04/2008 - Jansen Gallindo

    --v_conta              dbamv.pack_lanca_ffcv.c_conta%ROWTYPE;

    v_Conta Dbamv.Pkg_Ffcv_Conta.Tpconta;

    --v_contapart          dbamv.pack_lanca_ffcv.c_contapart%ROWTYPE;

    --PDA 157595(FIM) 14/04/2008 - Jansen Gallindo

    v_Itregfat Dbamv.Pack_Lanca_Ffcv.c_Itregfat%ROWTYPE;

    v_Forapre  Dbamv.Pack_Lanca_Ffcv.c_Forapre%ROWTYPE;

    -- pda 96511 - 23/06/2004 - Amalia Ara??

    Vcgabaritohosp   Dbamv.Pack_Lanca_Ffcv.Cgabaritohosp%ROWTYPE;

    Vcitgabaritohosp Dbamv.Pack_Lanca_Ffcv.Citgabaritohosp%ROWTYPE;

    Vcquantgabarito  Dbamv.Pack_Lanca_Ffcv.Cquantgabarito%ROWTYPE;

    -- pda 96511 - fim

    v_Particular       c_Config_Particular%ROWTYPE;

    Nqtprofat          Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Noldqtprofat       Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Ncdlcto            Dbamv.Itreg_Fat.Cd_Lancamento%TYPE /*number pda 254997*/

    ;

    Csnpacote          VARCHAR2(1);

    Binsert            BOOLEAN;

    Ctpproibicao       VARCHAR2(2);

    Ncdgrufat          NUMBER;

    Nqtautorizado      NUMBER;

    Ncdguia            NUMBER;

    Bpartic            BOOLEAN := FALSE;

    Ncdregfat          Dbamv.Itreg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/

    ;

    Ndiferenca         NUMBER;

    Nprestador         NUMBER;

    Nprestsetexa       NUMBER;

    Nqtregrateio       NUMBER;

    Ncdlfa             NUMBER;

    Csnpgconv          VARCHAR2(1);

    Ctppgto            VARCHAR2(1);

    Ncdsetor           NUMBER;

    Ncdsetorexa        NUMBER;

    Updating           BOOLEAN := FALSE;

    Deleting           BOOLEAN := FALSE;

    Inserting          BOOLEAN := FALSE;

    Ncdconvconta       NUMBER;

    Ncdplanconta       Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*number pda 254997*/

    ;

    Csnhoresp          VARCHAR2(1);

    Ccdatimed          VARCHAR2(2);

    Nqtpart            Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Nqtconv            Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Nqtlivre           NUMBER;

    v_Qtdexistente_Amb NUMBER;

    v_Qtdexistente_Fat NUMBER;

    Totallancado       NUMBER;

    v_Existeconta      NUMBER;

    Nqtaux             Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    := 0;

    Limite             NUMBER := 0;

    Bexistepreco       BOOLEAN := TRUE;

    Cmensret           VARCHAR2(2000);

    -- PDA 96161 -- Alexandre Erik C. M. Costa 25/05/2004

    -- Declara? de vari?is

    Nqtdguia NUMBER;

    -- PDA 96161 -- (FIM)

    -- PDA 112220 -- Carlos Diego Cavalcanti Pereira -- Inicio

    -- Declara? da vari?l para armazenar o tipo de v?ulo do prestador

    Ntpvinculo VARCHAR2(1);

    -- PDA 112220 -- Fim

    Nguiapendente Dbamv.Guia.Cd_Guia%TYPE; -- pda 145435 - 23/03/2006 - Jose Roberto

    Ncdguiaitem   Dbamv.Guia.Cd_Guia%TYPE; /* pda 141006 */

    Ccdorigem     Dbamv.Atendime.Cd_Ori_Ate%TYPE; --PDA 100970 26/07/2006 - Thiago Holder Marcos Silva

    -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

    Ncdpacote Dbamv.Conta_Pacote.Cd_Conta_Pacote%TYPE;

    Csnguia   VARCHAR2(1) := 'N';

    -- PDA 157145 (Fim)\par

    Vsnchecapreconolcto VARCHAR2(01); -- PDA 175957 - 16/03/2007 - Pedro Neiva(Apply)

    Ddthraux            DATE; -- PDA 221500 - 27/03/2008 - Diego Costa

    Ddthraux1           DATE; -- PDA 257297 - 12/11/2008 - Jamerson Nunes

    /*PDA.: 294932 - 08/07/2009 - Emanoel Deivison (inicio)

      Decri?: vari?l criada para receber a quantidade lan?a na conta hospitalar e efetuar o arredondamento da mesma.

                Pois quando os itens est?sendo lan?os na conta hospitalar atrav?do m??o de prescri? (PAGU)

                com quantidade menor que 1 (por exemplo: 0,08) ele fica zerado na conta.

    */

    Vqtdaux Dbamv.Itreg_Fat.Qt_Lancamento%TYPE := 0;

    /*PDA.: 294932 - 08/07/2009 - Emanoel Deivison (fim)*/

    Nqtexcedeu   NUMBER := NULL; -- OP 387

    Vtpcontapart Dbamv.Itreg_Fat.Tp_Mvto%TYPE := NULL; -- OP 387

    Nconta       NUMBER := NULL; -- OP 387

    Nlanc        NUMBER := NULL; -- OP 387

    vTemRegraCriaContaAuto BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnCriouContaAuto      BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnCriouContaAutoAmb   BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vRegraCriaContaAuto    Dbamv.Pkg_Ffcv_Conta.TpContaAutomatica; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnIntegracaoIpsemg  varchar2(2) ;  -- OP 40186

    vRegraCriaContaAutoHE    Dbamv.Pkg_Ffcv_Conta.TpContaAutomatica; /*OP 41394*/

    vSnReplicaProcHe dbamv.pack_lanca_ffcv.cSnReplicaProcHe%ROWTYPE; /*OP 41394*/

    vSnReplicaProc   VARCHAR2(1);                                    /*OP 41394*/

    vRregra cRregra%ROWTYPE;                                         /*OP 41394*/

    vNlsBanco VARCHAR2(50);                                          /*OP 41394*/

    vProced   cProced%ROWTYPE;                                       /*OP 41394*/

    v_ContaCargoPac        Dbamv.Pkg_Ffcv_Conta.Tpconta;     /*ALLS OP 42241 */

    v_ContaCargoPacAmbu    Dbamv.Pkg_Ffcv_Conta.Tpcontaambu; /*ALLS OP 42241 */

    vRegraCriaContaAutoCP  Dbamv.Pkg_Ffcv_Conta.TpContaAutomaticaCP; /*ALLS OP 42241* - regra para cria? autom?ca de conta referente a Cargo Paciente*/

    vSnCargoPaciente       Dbamv.Pack_Lanca_Ffcv.cSnCargoPaciente%ROWTYPE; /*ALLS OP 42241*/

    vSnCriouContaAutoCP    BOOLEAN := FALSE; /*ALLS OP 42241 */

    vSnCriouContaAutoAmbCP BOOLEAN := FALSE; /*ALLS OP 42241 */

    NcdlctoCp              NUMBER  ; /*ALLS OP 42241 */

    NcdlctoAmbCp           NUMBER  ; /*ALLS OP 42241 */

    pEmpresa               NUMBER := Pkg_Mv2000.Le_Empresa;/*43289*/

    pvSnJaExcedeuQtd      Varchar2(1):= 'N'; /*43289*/

    pvMensagem             VARCHAR2(2000);    /*43289*/

    pSnChamadoDaTela       VARCHAR2(1) := 'N';       /*43289*/

    nRegraSubstituicao     NUMBER := NULL;       /*OP 44895*/



  BEGIN

    IF Caction = 'I' THEN

      Inserting := TRUE;

    ELSIF Caction = 'U' THEN

      Updating := TRUE;

    ELSIF Caction = 'D' THEN

      Deleting := TRUE;

    END IF;

    Nqtprofat    := Nvl(Nqtnew, 1);

    Noldqtprofat := Nvl(Nqtold, 1);

    OPEN c_Config;

    FETCH c_Config

      INTO v_Config;

    CLOSE c_Config;



    vSnIntegracaoIpsemg := Nvl(dbamv.pkg_mv2000.Le_Configuracao('FFCV','SN_AUTORIZACAO_LCTO_AUTO'),'N') ; -- OP 40186



    IF Nvl(v_Config.Sn_Prescricao_Automatica, 'S') IN ('S', 'C') THEN

      -- PDA 187098 -- JANSEN GALLINDO - 29/04/2007

      OPEN c_Proced;

      FETCH c_Proced

        INTO v_Proced;

      CLOSE c_Proced;



      -- OP 35248 - Consumo n?lan?o de prescri? - desfazendo OP 34416.

      -- OP 34416 - Colocando aqui para gerar o consumo n?lan?o corretamente.

      --IF v_Proced.Cd_Pro_Fat IS NULL THEN

      --  RAISE Prod_Nao_Conf;

      --END IF;



      -- PDA 182967 (Inicio) - Henrique Antunes - 01/06/2007

      --IF v_proced.sn_fatura = 'S' THEN

      IF v_Proced.Sn_Fatura = 'S' AND

         Nvl(v_Proced.Sn_Liga_Desligar, 'N') = 'N' THEN

        -- PDA 182967 (Fim)

        OPEN c_Mvto;

        FETCH c_Mvto

          INTO v_Mvto;

        CLOSE c_Mvto;



	    vProFatAnterior     := v_Proced.Cd_Pro_Fat;   -- OP 33697 *2



      /* OP 44895 */

        vRregra := NULL;

        OPEN cRregra(v_Mvto.Cd_Convenio,v_Mvto.Cd_con_pla);

        FETCH cRregra INTO vRregra;

        CLOSE cRregra;



        /* pda 374277 - 18/06/2010 - Amalia Ara??- Aplica? da regra de substitui? */

        nRegraSubstituicao := NULL;

        v_Proced.Cd_Pro_Fat := Fnc_Substituicao_Procedimento(Dbamv.Pkg_Mv2000.Le_Empresa,

                                                             v_Mvto.Cd_Setor,

                                                             v_Proced.Cd_Pro_Fat,

                                                             v_Mvto.Dt_Pre_Med,

                                                             v_Mvto.Tp_Atendimento,

                                                             'S',

                                                             v_Mvto.Cd_Convenio,   /*OP 28803*/

                                                             nRegraSubstituicao,   /*OP 44895*/

                                                             v_Mvto.cd_con_pla,    /*OP 44895*/

                                                             vRregra.cd_regra     /*OP 44895*/

                                                             );

        Nqtprofat           := Fnc_Substituicao_Proced_Fator(Dbamv.Pkg_Mv2000.Le_Empresa,

                                                             v_Mvto.Cd_Setor,

                                                             v_Proced.Cd_Pro_Fat,

                                                             v_Mvto.Dt_Pre_Med,

                                                             v_Mvto.Tp_Atendimento,

                                                             'S',

                                                             Nqtprofat,

                                                             v_Mvto.Cd_Convenio,   /*OP 28803*/

                                                             v_Mvto.cd_con_pla,    /*OP 44895*/

                                                             vRregra.cd_regra     /*OP 44895*/

                                                             );

        /* pda 374277 - fim */

        -- PDA 257297 (Inicio) - Jamerson Nunes Delfino

        Ddthraux1 := To_Date(To_Char(v_Mvto.Dt_Pre_Med, 'DD/MM/YYYY') || ' ' ||

                             To_Char(Nvl(v_Mvto.Hr_Pre_Med,

                                         v_Mvto.Dt_Pre_Med),

                                     'HH24:MI:SS'),

                             'DD/MM/YYYY HH24:MI:SS');

        IF Ddthraux1 < v_Mvto.Dt_Atendimento THEN

          Ddthraux1 := v_Mvto.Dt_Atendimento;

        END IF;

        IF Ddthraux1 > v_Mvto.Dt_Alta THEN

          Ddthraux1 := v_Mvto.Dt_Alta;

        END IF;

        -- PDA 257292 (Fim)

        /*PDA 142924 - 12/01/2005 - Sp?ola - Incluido Home-Care*/



		-- OP 32555 - 27/09/2015 - verifica? de proibi? por Idade. Retorna OK caso n?haja proibi?, e mensagem para o alert caso haja.

		if dbamv.fnc_ffcv_proibicao_idade( v_mvto.cd_atendimento, v_mvto.cd_convenio, v_mvto.cd_con_pla, v_proced.cd_pro_fat ) <> 'OK' then

		  raise proc_proibido_idade;

		end if;

		-- OP 32555 - fim



		  -- OP 33697 *2 - 08/10/2015 - Buscando as demais informa?s do produto, caso o procedimento tenha sido substituido pela Regra de substitui?.

		  --    ?ecess?o porque mais abaixo faz busca do grupo de faturamento pela classe, Esp?e e setor.

		  if v_Proced.Cd_Pro_Fat <> vProFatAnterior then

            v_Proced.Sn_Fatura := null;

            v_Proced.Cd_Gru_Fat := null;

            v_Proced.Cd_Gru_Pro := null;

            v_Proced.Cd_Tip_Presc := null;

            v_Proced.Ds_Tip_Presc := null;

            v_Proced.Nr_Auxiliar := null;

            v_Proced.Sn_Liga_Desligar := null;

            v_Proced.Cd_Por_Ane  := null;

			open  cProcedProFat( v_Proced.Cd_Pro_Fat );

			fetch cProcedProFat into v_Proced;

			close cProcedProFat;

		  end if;

		  -- OP 33697 - fim



        IF v_Mvto.Tp_Atendimento IN ('I', 'H') THEN

          -- PDA 112788 (In?o) - 19/01/2005 - Pollyane





/* OP 38292 (Inicio)



          OPEN Dbamv.Pack_Lanca_Ffcv.c_Proibicao(v_Proced.Cd_Pro_Fat,

                                                 v_Mvto.Cd_Convenio,

                                                 v_Mvto.Cd_Con_Pla,

                                                 v_Mvto.Tp_Atendimento

                                                 --,v_mvto.dt_pre_med -- PDA 257297

                                                ,

                                                 Ddthraux1 -- PDA 257297

                                                ,

                                                 v_Mvto.Cd_Setor);

          FETCH Dbamv.Pack_Lanca_Ffcv.c_Proibicao

            INTO Ctpproibicao;

          CLOSE Dbamv.Pack_Lanca_Ffcv.c_Proibicao; */



      Ctpproibicao := dbamv.pack_ffcv_proibicao.fnc_ffcv_proibicao(v_Proced.Cd_Pro_Fat,

                                               v_Mvto.Cd_Convenio,

                                               v_Mvto.Cd_Con_Pla,

                                               v_Mvto.Tp_Atendimento,

                                               Ddthraux1,

                                               v_Mvto.Cd_Setor,

                                                                       v_mvto.cd_atendimento,

                                                                       NULL);

      -- OP 38292 (Fim)



          IF Ctpproibicao = 'FC' THEN

            RAISE Fora_Da_Conta;

          END IF;

          -- PDA 112788 (Fim)

          IF Inserting THEN

            --PDA 157595(INICIO) 14/05/2008 - Jansen Gallindo

            /*OPEN dbamv.pack_lanca_ffcv.c_conta (v_mvto.cd_atendimento

                                                --PDA 184670(In?o)

                                                --,v_mvto.dt_pre_med

                                                ,to_date(to_char(v_mvto.dt_pre_med,'dd/mm/yyyy')||' '||to_char(v_mvto.hr_pre_med,'hh24:mi'),'dd/mm/yyyy hh24:mi')

                                                --PDA 184670(Fim)

                                               ,NULL

                                               ,v_mvto.cd_atendimento_pai

                                               );

            FETCH dbamv.pack_lanca_ffcv.c_conta INTO v_conta;

            CLOSE dbamv.pack_lanca_ffcv.c_conta;*/

            /*OP 35916 - regra para cria? autom?ca de conta*/

            vSnReplicaProc := NULL;      /*OP 41394*/

            vTemRegraCriaContaAuto  := Dbamv.Pkg_Ffcv_Conta.FNC_TEM_REG_CRIA_CONTA_AUTO;

            IF (vTemRegraCriaContaAuto) THEN



                    /*ALLS OP 42241*/

                    OPEN dbamv.pack_lanca_ffcv.cSnCargoPaciente(v_Mvto.Cd_Atendimento);

                    FETCH dbamv.pack_lanca_ffcv.cSnCargoPaciente INTO vSnCargoPaciente;

					          CLOSE dbamv.pack_lanca_ffcv.cSnCargoPaciente;



					          IF Nvl(vSnCargoPaciente.sn_carga_familiar,'N') = 'S' THEN



                        vRegraCriaContaAutoCP := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTCP(v_Mvto.Cd_Atendimento,

                                                                                                     v_Proced.Cd_Pro_Fat,

                                                                                                     Ddthraux1); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAutoCP(1).cd_regra_cria_conta IS NOT NULL ) THEN



                            v_ContaCargoPac :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_HOSP_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                                 null,

                                                                                                 v_Mvto.Cd_Atendimento,

                                                                                                 v_Mvto.Cd_Atendimento_Pai,

                                                                                                 vRegraCriaContaAutoCP(1).cd_convenio_destino,

                                                                                                 vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                                                                                                 Ddthraux1,

                                                                                                 vRegraCriaContaAutoCP(1).cd_tipo_arq_cta_envio,

                                                                                                 vRegraCriaContaAutoCP(1).cd_desconto_inst); /*ALLS OP 35921*/

                            vSnCriouContaAutoCP := TRUE;

                        END IF;

                    /*fim ALLS OP 42241*/

                    ELSE



                        vRegraCriaContaAuto := Dbamv.Pkg_Ffcv_Conta.FNC_VERIFIC_REG_CRIA_CONTA_AUT(v_Mvto.Cd_Atendimento,

                                                                                                   v_Proced.Cd_Pro_Fat,

                                                                                                   Ddthraux1); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAuto(1).cd_regra_cria_conta IS NOT NULL ) THEN



                            v_Conta :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_HOSP_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                         null,

                                                                                         v_Mvto.Cd_Atendimento,

                                                                                         v_Mvto.Cd_Atendimento_Pai,

                                                                                         vRegraCriaContaAuto(1).cd_convenio_destino,

                                                                                         vRegraCriaContaAuto(1).cd_con_pla_destino,

                                                                                         Ddthraux1,

                                                                                         vRegraCriaContaAuto(1).cd_tipo_arq_cta_envio,

                                                                                         vRegraCriaContaAuto(1).cd_desconto_inst); /*ALLS OP 35921*/

                            vSnCriouContaAuto := TRUE;

                        END IF;



                        /*OP 41394*/

                        vRegraCriaContaAutoHE := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTHE(v_Mvto.Cd_Atendimento,v_Proced.Cd_Pro_Fat,Ddthraux1); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAutoHE(1).cd_regra_cria_conta IS NOT NULL ) THEN

                          vSnReplicaProc := 'S';

                        END IF;

                        /*OP 41394*/



                    END IF;



            END IF;





            IF (NOT vSnCriouContaAuto) THEN

            /*OP 35916 - regra para cria? autom?ca de conta*/

                v_Conta := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Conta(v_Mvto.Cd_Atendimento

                                                              --,to_date(to_char(v_mvto.dt_pre_med,'dd/mm/yyyy')||' '||to_char(v_mvto.hr_pre_med,'hh24:mi'),'dd/mm/yyyy hh24:mi') -- PDA 257297

                                                             ,

                                                              Ddthraux1 -- PDA 257297

                                                             ,

                                                              NULL,

                                                              v_Mvto.Cd_Atendimento_Pai);

            END IF; /*OP 35916*/



            --PDA 157595(FIM) 14/05/2008 - Jansen Gallindo

            OPEN c_Config_Particular;

            FETCH c_Config_Particular

              INTO v_Particular;

            CLOSE c_Config_Particular;

            -- PDA 229203 (In?o) - 22/05/2008 - Diego Costa

            -- inclus?do atendimento Pai na Checagem da conta.

            OPEN c_Existeconta(v_Mvto.Cd_Atendimento,

                               v_Mvto.Cd_Atendimento_Pai);

            FETCH c_Existeconta

              INTO v_Existeconta;

            CLOSE c_Existeconta;

            -- PDA 229203 (Fim)

            -- pda 101844 inicio



            -- PDA 112788 (In?o) - 19/01/2005 - Pollyane

            -- Checa a proibi? depois de verificar se existe conta particular.

            IF Ctpproibicao = 'NA' THEN

              --                     ncdregfat := dbamv.pack_lanca_ffcv.cria_conta_pacparthosp (NVL (v_mvto.cd_atendimento_pai, v_mvto.cd_atendimento), v_mvto.dt_pre_med); -- pda 125871(acrescentada a data)

              Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                               v_Mvto.Cd_Atendimento),

                                                                           Ddthraux1); -- PDA 257297

              Ncdconvconta := v_Config.Cd_Convenio_Fat_Extra;

              Ncdplanconta := v_Config.Cd_Con_Pla_Fat_Extra;

              IF Ncdregfat IS NULL THEN

                RAISE Atend_Sem_Conta;

              END IF;

            END IF;

            -- PDA 112788 (Fim)

            -- pda 101844 fim

            IF v_Mvto.Tp_Atendimento IN ('A', 'E', 'U') AND

               v_Mvto.Sn_Importa_Auto = 'S' THEN

              Raise_Application_Error(-20040

                                      --MULTI-IDIOMA: Utiliza? do pkg_rmi_traducao.extrair_msg para mensagens (MSG_1)

                                     ,

                                      Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_1',

                                                                        'PACK_LANCA_FFCV',

                                                                        'A Conta deste atendimento est?loqueada! A movimenta? da mesma dever?er lan?a para o atendimento de interna? %s',



                                                                        Arg_List(v_Mvto.Cd_Atendimento_Pai)));

            END IF;

            --PDA 175957 (In?o) 16/03/2007 - Pedro Neiva(Apply)

            Vsnchecapreconolcto := Dbamv.Fnc_Ffcv_Verifica_Preco_Lcto(v_Mvto.Tp_Atendimento);

            -- PDA 187015 (Inicio) - Henrique Antunes - 14/05/2007

            IF Nvl(Vsnchecapreconolcto, 'N') = 'S' AND NOT Deleting AND

               Nvl(Pkg_Mv2000.Le_Configuracao('FFCV',

                                              'SN_CREDENCIADO_CENTAVOS'),

                   'N') = 'N' THEN

              -- PDA 187015 (Fim)

              --IF NVL (v_config.sn_checa_preco_lcto, 'N') = 'S' AND NOT DELETING THEN                                                                     -- pda 118991 (colocada 2 condi? p/ n?verificar pre?ao excluir)

              --PDA 175957 (Fim) 16/03/2007 - Pedro Neiva(Apply)

              -- pda 101844 inicio

              -- colocado o if p/ se for tipo de proibi? 'NA' passar convenio  e plano da conta extra

              IF Ctpproibicao = 'NA' THEN

                Bexistepreco := Dbamv.Val_Proc_Ffcv_Resumido(v_Proced.Cd_Pro_Fat ||

                                                             v_Mvto.Cd_Setor -- PDA 194962 - Pedro Neiva - 23/08/2007

                                                             --,v_mvto.dt_pre_med -- PDA 257297

                                                             --,v_mvto.hr_pre_med -- PDA 257297

                                                            ,

                                                             Trunc(Ddthraux1) -- PDA 257297

                                                            ,

                                                             Ddthraux1 -- PDA 257297

                                                            ,

                                                             Ncdconvconta, -- convenio  da conta extra

                                                             Ncdplanconta, -- plano da conta extra

                                                             v_Mvto.Tp_Atendimento,

                                                             v_Mvto.Cd_Tip_Acom,

                                                             Cmensret,

                                                             NULL,

                                                             v_Proced.Cd_Tip_Presc);

              ELSE

                Bexistepreco := Dbamv.Val_Proc_Ffcv_Resumido(v_Proced.Cd_Pro_Fat ||

                                                             v_Mvto.Cd_Setor -- PDA 194962 - Pedro Neiva - 23/08/2007

                                                             --,v_mvto.dt_pre_med -- PDA 257297

                                                             --,v_mvto.hr_pre_med -- PDA 257297

                                                            ,

                                                             Trunc(Ddthraux1) -- PDA 257297

                                                            ,

                                                             Ddthraux1 -- PDA 257297

                                                            ,

                                                             v_Mvto.Cd_Convenio,

                                                             v_Mvto.Cd_Con_Pla,

                                                             v_Mvto.Tp_Atendimento,

                                                             v_Mvto.Cd_Tip_Acom,

                                                             Cmensret,

                                                             NULL,

                                                             v_Proced.Cd_Tip_Presc);

              END IF;

              -- pda 101844 fim

              IF Bexistepreco = FALSE THEN

                Raise_Application_Error(-20050, Cmensret);

              END IF;

            END IF;

            --

            --IF v_conta.cd_reg_fat IS NULL THEN --PDA 157595

            IF v_Conta(1).Cd_Reg_Fat IS NULL THEN

              --PDA 157595

              IF v_Mvto.Cd_Convenio_Secundario IS NOT NULL THEN

                Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Verifica_Conta_Secundaria(v_Mvto.Cd_Atendimento

                                                                                --,v_mvto.dt_pre_med -- PDA 257297

                                                                               ,

                                                                                Ddthraux1 -- PDA 257297

                                                                               ,

                                                                                v_Mvto.Cd_Convenio_Secundario,

                                                                                v_Mvto.Cd_Atendimento_Pai);

                Ncdconvconta := v_Mvto.Cd_Convenio_Secundario;

                Ncdplanconta := v_Mvto.Cd_Con_Pla_Secundario;

                IF Ncdregfat IS NULL THEN

                  RAISE Atend_Sem_Conta;

                END IF;

              ELSE

                IF v_Mvto.Tp_Convenio = 'P' THEN

                  --                           ncdregfat := dbamv.pack_lanca_ffcv.cria_conta_pacparthosp (v_mvto.cd_atendimento, v_mvto.dt_pre_med); -- pda 125871(acrescentada a data)

                  Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento,

                                                                               Ddthraux1); -- PDA 257297

                  Ncdconvconta := v_Mvto.Cd_Convenio;

                  Ncdplanconta := v_Mvto.Cd_Con_Pla;

                ELSE

                  RAISE Atend_Sem_Conta;

                END IF;

              END IF;

            ELSE

              -- pda 101844 inicio

              -- se for proibido, os dados j?star?sendo  atribuidos  mais em cima.

              IF Nvl(Ctpproibicao, 'AA') <> 'NA' THEN

                Ncdregfat    := v_Conta(1).Cd_Reg_Fat; --ncdregfat := v_conta.cd_reg_fat; --PDA 157595

                Ncdconvconta := v_Conta(1).Cd_Convenio; --ncdconvconta := v_conta.cd_convenio; --PDA 157595

                Ncdplanconta := v_Conta(1).Cd_Con_Pla; --ncdplanconta := v_conta.cd_con_pla; --PDA 157595

              END IF;

              -- pda 101844 fim

            END IF;

            OPEN c_Setor;

            FETCH c_Setor

              INTO Ncdsetorexa, Nprestsetexa;

            CLOSE c_Setor;

            --

            Ncdsetor := v_Mvto.Cd_Setor;

            --

            -- pda 86938 - 12/02/2004 - Amalia Ara??

            -- se o setor vier nulo no cursor V_Mvto, buscar o setor da unidade de interna?

            IF Ncdsetor IS NULL AND v_Mvto.Cd_Unid_Int IS NOT NULL THEN

              BEGIN

                SELECT Unid_Int.Cd_Setor

                  INTO Ncdsetor

                  FROM Dbamv.Unid_Int

                 WHERE Unid_Int.Cd_Unid_Int = v_Mvto.Cd_Unid_Int;

              EXCEPTION

                WHEN OTHERS THEN

                  Ncdsetor := NULL;

              END;

            END IF;

            -- pda 86938 - fim

            OPEN c_Grfasetorexame(v_Proced.Cd_Gru_Pro, Ncdsetor);

            FETCH c_Grfasetorexame

              INTO Ncdgrufat;

            CLOSE c_Grfasetorexame;

            IF Ncdgrufat IS NULL THEN

              Ncdgrufat := v_Proced.Cd_Gru_Fat;

            END IF;

			      -- OP 33697 *2 - Usar o grupo de faturamento do procedimento de substitui?.

	          if v_Proced.Cd_Pro_Fat <> vProFatAnterior and Ncdgrufat is null then

			        open  cGruProSub( v_Proced.Cd_Pro_Fat );

			        fetch cGruProSub into Ncdgrufat;

				      close cGruProSub;

			      end if;



            --PDA 96800 - Eduardo Santis - 04/05/2004 (Inicio)

            /*Alterei as ordens dos ifs para a verifica? do cd_pro_fat vir primeiro

               que a do setor.

            */



            IF v_Proced.Cd_Pro_Fat IS NULL THEN

              RAISE Prod_Nao_Conf;

            END IF;



            IF Ncdgrufat IS NULL THEN

              RAISE Setor_Nao_Conf;

            END IF;



            --PDA 96800 - Eduardo Santis - 04/05/2004 (Fim)

            OPEN Dbamv.Pack_Lanca_Ffcv.c_Forapre(Ncdconvconta, Ncdgrufat);

            FETCH Dbamv.Pack_Lanca_Ffcv.c_Forapre

              INTO v_Forapre;

            CLOSE Dbamv.Pack_Lanca_Ffcv.c_Forapre;

            IF v_Forapre.Sn_Prestador = 'S' THEN

              Nprestador := Nvl(Nprestsetexa,

                                Nvl(Ncdprestador, v_Mvto.Cd_Prestador));

              Ccdatimed  := v_Config.Cd_Ati_Med_Clinico;

              -- pda 106359 - 26/10/2004 - Amalia Ara??

              -- Se o procedimento pedir equipe m?ca, o prestador para a itreg_fat ser?ulo

              IF Nvl(v_Proced.Nr_Auxiliar, 0) > 0 OR

                 v_Proced.Cd_Por_Ane IS NOT NULL THEN

                Nprestador := NULL;

                Ccdatimed  := NULL;

              END IF;

              -- pda 106359 - fim

            ELSE

              Nprestador := NULL;

              Ccdatimed  := NULL;

            END IF;

            IF Nprestador IS NOT NULL THEN

              -- PDA 100970 26/07/2006 Thiago Holder Marcos Silva

              -- Chamada da fun? dbamv.pkg_ffcv_it_conta.fnc_retorna_tp_pagamento();

              --

              --  OPEN dbamv.pack_lanca_ffcv.c_prescon (nprestador, ncdconvconta);

              --  FETCH dbamv.pack_lanca_ffcv.c_prescon INTO csnpgconv;

              --  CLOSE dbamv.pack_lanca_ffcv.c_prescon;

              OPEN Corigem;

              FETCH Corigem

                INTO Ccdorigem;

              CLOSE Corigem;

              Ctppgto := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Retorna_Tp_Pagamento(Nprestador,

                                                                          Ncdconvconta,

                                                                          v_Mvto.Tp_Atendimento,

                                                                          v_Proced.Cd_Pro_Fat,

                                                                          Ccdorigem

                                                                          -- PDA 166691 (Inicio) - Henrique Antunes - 28/11/2006

                                                                          --,v_mvto.dt_pre_med -- PDA 257297

                                                                          --,v_mvto.hr_pre_med -- PDA 257297

                                                                         ,

                                                                          Trunc(Ddthraux1) -- PDA 257297

                                                                         ,

                                                                          Ddthraux1 -- PDA 257297

                                                                          -- PDA 166691 (Fim)

																		  --FATURCONV-1726 INI

																		  ,Ncdplanconta

																		  ,vRregra.cd_regra

																		  ,v_Proced.Cd_Gru_Pro

																		  --FATURCONV-1726 FIM

                                                                          );

            ELSE

              --  csnpgconv := NULL;

              Ctppgto := NULL; -- pda 104455 desfazer o que foi feito no pda 84408 ('P'  ; --( pda 84408   setado de null p/ 'P'))

            END IF;

            -- PDA 187015 (Inicio) - Henrique Antunes - 14/05/2007

            IF Nvl(Vsnchecapreconolcto, 'N') = 'S' AND NOT Deleting AND

               Nvl(Ctppgto, 'P') <> 'C' AND

               Nvl(Pkg_Mv2000.Le_Configuracao('FFCV',

                                              'SN_CREDENCIADO_CENTAVOS'),

                   'N') = 'S' THEN

              IF Ctpproibicao = 'NA' THEN

                Bexistepreco := Dbamv.Val_Proc_Ffcv_Resumido(v_Proced.Cd_Pro_Fat ||

                                                             v_Mvto.Cd_Setor -- PDA 194962 - Pedro Neiva - 23/08/2007

                                                             --,v_mvto.dt_pre_med -- PDA 257297

                                                             --,v_mvto.hr_pre_med -- PDA 257297

                                                            ,

                                                             Trunc(Ddthraux1) -- PDA 257297

                                                            ,

                                                             Ddthraux1 -- PDA 257297

                                                            ,

                                                             Ncdconvconta, -- convenio  da conta extra

                                                             Ncdplanconta, -- plano da conta extra

                                                             v_Mvto.Tp_Atendimento,

                                                             v_Mvto.Cd_Tip_Acom,

                                                             Cmensret,

                                                             NULL,

                                                             v_Proced.Cd_Tip_Presc);

              ELSE

                Bexistepreco := Dbamv.Val_Proc_Ffcv_Resumido(v_Proced.Cd_Pro_Fat ||

                                                             v_Mvto.Cd_Setor -- PDA 194962 - Pedro Neiva - 23/08/2007

                                                             --,v_mvto.dt_pre_med -- PDA 257297

                                                             --,v_mvto.hr_pre_med -- PDA 257297

                                                            ,

                                                             Trunc(Ddthraux1) -- PDA 257297

                                                            ,

                                                             Ddthraux1 -- PDA 257297

                                                            ,

                                                             v_Mvto.Cd_Convenio,

                                                             v_Mvto.Cd_Con_Pla,

                                                             v_Mvto.Tp_Atendimento,

                                                             v_Mvto.Cd_Tip_Acom,

                                                             Cmensret,

                                                             NULL,

                                                             v_Proced.Cd_Tip_Presc);

              END IF;

              -- pda 101844 fim

              IF Bexistepreco = FALSE THEN

                Raise_Application_Error(-20050, Cmensret);

              END IF;

            END IF;

            -- PDA 187015 (Fim)

            -- IF csnpgconv IS NOT NULL THEN

            --   IF NVL (csnpgconv, 'N') = 'S' THEN

            --       ctppgto := 'C';

            --    ELSE

            --      ctppgto := 'P';

            --    END IF;

            -- ELSIF nprestador IS NOT NULL THEN

            --    ctppgto := 'P';

            -- END IF;

            -- PDA 112220 -- Carlos Diego Cavalcanti Pereira -- 15/12/2004

            -- Inserida a verifica? do v?ulo empregat?o do prestador

            -- PDA 112220 -- Inicio

            -- IF nprestador IS NOT NULL AND ctppgto = 'P' THEN

            --   SELECT tp_vinculo

            --     INTO ntpvinculo

            --     FROM dbamv.prestador

            --    WHERE cd_prestador = nprestador;

            --   IF ntpvinculo = 'U' THEN

            --      ctppgto := 'F';

            --   END IF;

            -- END IF;

            -- PDA 112220 -- Fim

            -- PDA 100970

            /* pda 365605 - thiago Miranda de oliveira - este trecheo de codigo ja foi colocado um pocuo mais acima, onde estava criando mais de uma conta particular

                                              no mesmo processo, mais precisamente na linha 5990 existe um codigo igual a este tratando os procedimentos nao autorizados

                              IF ctpproibicao = 'NA' THEN

            --                     ncdregfat := dbamv.pack_lanca_ffcv.cria_conta_pacparthosp (NVL (v_mvto.cd_atendimento_pai, v_mvto.cd_atendimento), v_mvto.dt_pre_med); -- pda 125871(acrescentada a data)

                                 -- PDA 325327 - Thiago miranda de oliveira - colocando uma variavel de dat no lugar da data da movimenta?

                                 ncdregfat := dbamv.pack_lanca_ffcv.cria_conta_pacparthosp (NVL (v_mvto.cd_atendimento_pai, v_mvto.cd_atendimento), dDthrAux1);

                                 ncdconvconta := v_config.cd_convenio_fat_extra;

                                 ncdplanconta := v_config.cd_con_pla_fat_extra;



                                 IF ncdregfat IS NULL THEN

                                    RAISE atend_sem_conta;

                                 END IF;

                              END IF;

                              fim pda 365605*/

            /* pda 145435 - 23/03/2006 - Jose Roberto                        (*)

            Alterando a verifica? da guia, retirando os cursores c_qtdexistente_amb e

            c_qtdexistente_fat para utilizar a nova fun? FNC_RETORNA_GUIA_DISPONIVEL;

            Retiradas as verifica?s nos cursores c_guia, c_itguia e c_itguia_proc_auto;

            Retirado o uso das vari?is totallancado e nqtautorizado;

            Caso NCDGUIA for Nulo, chamando a fun? F_GRAVA_GUIA, alterando o terceiro

            par?tro para nqtprofat;

            Retirado todo o c?ulo feito para atribuir valor as vari?is nqtpart,

            nqtconv e limite;

            Caso retorne uma Guia dispon?l, atribui-la ?ari?l NCDGUIA.         */

            IF Ctpproibicao = 'AG' THEN

              /*PDA 374303 - 25/06/2010 - Juliana Vieira

              na chamada da fun? que retorna se tem uma guia dispon?l, passar sempre o codigo do atendimento

              pai caso tiver, pois o sistma pode criar atendimentos de recem nascido onde n?existe conta para ele e n??ecess?o

                crioar guias para os atendimentos filhos.*/

             -- OP 40186 - incluido IF vSnIntegracaoIpsemg = 'S' THEN

             IF vSnIntegracaoIpsemg = 'S' THEN

					Ncdguia := NULL ;

              ELSE

              Ncdguia := Dbamv.Pkg_Ffcv_Guia.Fnc_Retorna_Guia_Disponivel(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                             v_Mvto.Cd_Atendimento),

                                                                         Ncdregfat,

                                                                         NULL,

                                                                         v_Proced.Cd_Pro_Fat,

                                                                         Nqtprofat,

                                                                         NULL,

                                                                         NULL,

                                                                         Nguiapendente);

              end if ;

              IF Nvl(v_Config.Sn_Guia_Proc_Auto, 'N') = 'S' THEN

                IF Ncdguia IS NULL THEN

                  Ncdguia := Dbamv.f_Grava_Guia(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                    v_Mvto.Cd_Atendimento),

                                                v_Mvto.Cd_Convenio,

                                                Nqtprofat,

                                                v_Proced.Cd_Pro_Fat,

                                                'P');

                END IF;

                Nqtpart := 0;

                Nqtconv := Nqtprofat;

                Limite  := 0;

                /* pda 164822 - 28/09/2006 - Amalia Ara??

                   Comentado para n?lan? procedimento com proibi? AG em conta particular.

                else

                  nQtPart := nQtProFat;

                  nQtConv := 0;

                  limite  := 1;

                pda 164822 - fim       */

              END IF;

            END IF;

            -- pda 145435 (Fim)

            -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

            IF Ctpproibicao = 'AG' THEN

              Csnguia := 'S';

            END IF;

            -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

            -- Prepara? da data que ser?assada na fun?.

            -- A data preparada ir?onter al?da data de lan?ento, a hora de lan?ento.

            Ddthraux := To_Date(To_Char(v_Mvto.Dt_Pre_Med, 'DD/MM/YYYY') || ' ' ||

                                To_Char(v_Mvto.Hr_Pre_Med, 'HH24:MI:SS'),

                                'DD/MM/YYYY HH24:MI:SS');

            -- PDA 221500 (Fim)

            /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

            nQtExcedeu a vari?l retorna justamente a quantidade de procedimentos que deve ser lan?o no procedimento

            que pertence ao pacote, em seguida deve ser inserdio um outro procedimento com o que restou do lan?ento*/

            Nqtexcedeu := NULL;

            --

            /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

            vTpContaPart a vari?l retorna justamente se o procedimento vai ser inserido em uma conta particular ou ira seguir

            o processo normalmente.*/

            Ncdpacote := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Gera_Pacote(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                     v_Mvto.Cd_Atendimento),

                                                                 v_Mvto.Tp_Atendimento,

                                                                 v_Mvto.Cd_Convenio,

                                                                 v_Mvto.Cd_Con_Pla,

                                                                 Ncdregfat,

                                                                 Ncdgrufat,

                                                                 v_Proced.Cd_Pro_Fat,

                                                                 Ncdsetor,

                                                                 Nprestador

                                                                 -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

                                                                 -- ,v_mvto.dt_pre_med

                                                                 --                               ,dDthrAux -- PDA 257297

                                                                ,

                                                                 Ddthraux1 -- PDA 257297

                                                                 -- PDA 221500 (Fim)

                                                                ,

                                                                 Ncdpremed,

                                                                 Ncditemmvto,

                                                                 'Prescricao',

                                                                 Csnguia,

                                                                 Nqtprofat,

                                                                 Csnpacote,

                                                                 Nqtexcedeu -- OP 387

                                                                ,

                                                                 Vtpcontapart -- OP 387

                                                                ,

                                                                 NULL

                                                                 -- PDA 225086 (Inicio)

                                                                ,

                                                                 v_Mvto.Cd_Atendimento,

                                                                 NULL --pCdProFatPacote

                                                                ,

                                                                 Ncdlcto --pCdLancamento_pac

                                                                ,

                                                                 NULL); --preserva

            -- PDA 225086 (fim)

            /* pda 481126 - depois da FNC_GERA_PACOTE regravando o cd_lancamento_pac */

            IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncdregfat);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                INTO Ncdlcto;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

            END IF;

            --

            IF Ncdpacote IS NOT NULL THEN

              UPDATE Dbamv.Conta_Pacote

                 SET Cd_Lancamento_Pac = Ncdlcto

               WHERE Cd_Conta_Pacote = Ncdpacote;

            END IF;

            /* pda 481126 - fim */

            /*OPEN dbamv.pack_lanca_ffcv.c_pacotehosp (ncdregfat);

            FETCH dbamv.pack_lanca_ffcv.c_pacotehosp INTO csnpacote;

            CLOSE dbamv.pack_lanca_ffcv.c_pacotehosp;*/

            -- pda 96511 - 23/06/2004 - Amalia Ara??

            -- Alterado o processo. Ap??erificar se ?acote normal, vai verificar se ?
            -- gabarito. Se o procedimento principal n?for gabarito, continua como era.

            -- Se o procedimento principal for gabarito, vai verificar se o item da conta

            -- est?elacionado no gabarito. Se n?estiver, o procedimento ser?ertencente

            -- a pacote (cSnPacote=N). Se estiver, ser?erificado se a quantidade

            -- deste procedimento na conta j?xcedeu a quantidade negociada com o convenio

            -- (qt_gabarito); se n?excedeu, o procedimento ser?acote; se excedeu, S??
            -- ser?acote se o campo SN_PACOTE do gabarito estiver marcado.

            -- pda 96511 - 18/05/2004 - Amalia Ara??

            -- Se n?for pacote, verificar se consta como pacote no cadastro de gabaritos

            /*if nvl(cSnPacote,'N') = 'N' then

               Open dbamv.pack_lanca_ffcv.cGabaritoHosp( nCdRegFat, V_Proced.cd_pro_fat );

               Fetch dbamv.pack_lanca_ffcv.cGabaritoHosp into cSnPacote;

               Close dbamv.pack_lanca_ffcv.cGabaritoHosp;

            end if;  */

            /*OPEN dbamv.pack_lanca_ffcv.cgabaritohosp (ncdregfat);

            FETCH dbamv.pack_lanca_ffcv.cgabaritohosp INTO vcgabaritohosp;



            IF dbamv.pack_lanca_ffcv.cgabaritohosp%NOTFOUND THEN

               NULL;

            ELSE

               OPEN dbamv.pack_lanca_ffcv.citgabaritohosp (v_proced.cd_pro_fat, vcgabaritohosp.cd_gabarito);

               FETCH dbamv.pack_lanca_ffcv.citgabaritohosp INTO vcitgabaritohosp;



               IF dbamv.pack_lanca_ffcv.citgabaritohosp%NOTFOUND THEN

                  csnpacote := 'N';

               ELSE

                  csnpacote := 'S';

                  vcquantgabarito.qt_lancamento := NULL;

                  OPEN dbamv.pack_lanca_ffcv.cquantgabarito (ncdregfat, v_proced.cd_pro_fat);

                  FETCH dbamv.pack_lanca_ffcv.cquantgabarito INTO vcquantgabarito;



                  IF NVL (nqtprofat + vcquantgabarito.qt_lancamento, 0) > NVL (vcitgabaritohosp.qt_gabarito, 0) THEN

                     csnpacote := NVL (vcitgabaritohosp.sn_pacote, 'N');

                  ELSE

                     csnpacote := 'S';

                  END IF;



                  CLOSE dbamv.pack_lanca_ffcv.cquantgabarito;

               END IF;



               CLOSE dbamv.pack_lanca_ffcv.citgabaritohosp;

            END IF;



            CLOSE dbamv.pack_lanca_ffcv.cgabaritohosp;*/

            -- pda 96511 - fim

            -- PDA 157145 (Inicio)

            IF Dbamv.Pack_Lanca_Ffcv.Is_Hor_Esp(Ncdconvconta,

                                                Ncdplanconta,

                                                v_Mvto.Tp_Atendimento

                                                --,v_mvto.dt_pre_med -- PDA 257297

                                                --,v_mvto.hr_pre_med -- PDA 257297

                                               ,

                                                Trunc(Ddthraux1) -- PDA 257297

                                               ,

                                                Ddthraux1 -- PDA 257297

                                               ,

                                                Ncdgrufat,

                                                v_Proced.Cd_Pro_Fat

                                                -- PDA 119427 11/04/2005 Henrique Antunes (In?o)

                                                -- Passar NULL para o par?tro de regra

                                               ,

                                                NULL

                                                -- PDA 119427 (FIM)

                                               , --PDA 108041 / 108039 12/11/2004 Sp?ola (INICIO)

                                                --Inserido o paremetro cd_prestador / cd_setor para permitir exce?s de convenios e planos por prestador

                                                Nprestador,

                                                Ncdsetor --PDA 108041 / 108039 (FIM)

                                                ) THEN

              Csnhoresp := 'S';

            ELSE

              Csnhoresp := 'N';

            END IF;

            -- PDA 123016 (Inicio) - Henrique Antunes - 06/07/2005

            DECLARE

              Vqtd NUMBER;

            BEGIN

              OPEN Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco(Ncdregfat

                                                          --,v_mvto.dt_pre_med -- PDA 257297

                                                          --,v_mvto.hr_pre_med -- PDA 257297

                                                         ,

                                                          Trunc(Ddthraux1) -- PDA 257297

                                                         ,

                                                          Ddthraux1 -- PDA 257297

                                                          );

              FETCH Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco

                INTO Vqtd;

              CLOSE Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco;

              IF Nvl(Vqtd, 0) <> 0 THEN

                RAISE Auditoria_In_Loco;

              END IF;

            END;

            -- PDA 123016 (Fim)

            /*PDA.: 294932 - 08/07/2009 - Emanoel Deivison (inicio)

              Decri?: vari?l criada para receber a quantidade lan?a na conta hospitalar e efetuar o arredondamento da mesma.

                        Pois quando os itens est?sendo lan?os na conta hospitalar atrav?do m??o de prescri? (PAGU)

                        com quantidade menor que 1 (por exemplo: 0,08) ele fica zerado na conta.

            */

            Vqtdaux := 0;

            Vqtdaux := Nvl(Nqtconv, Nqtprofat);

            IF Nvl(Vqtdaux, 0) < 1 THEN

              Vqtdaux := 1;

            END IF;

            /*PDA.: 294932 - 08/07/2009 - Emanoel Deivison (fim)*/

            IF Limite <> 1 THEN

              /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

              que o procedimento que ira ser inserido abaixo pertence a um pacote, e a qunatidade que sera inserida sera menor que a lan?a, a diferen?

              sera lan?a na rotina mais abaixo atravez da procedure PRC_DESVINCULA_PROCEDIMENTO*/

              /* Fazendo tratamento caso o procedimento esteja configurado no gabarito para ser inserido dentro de uma conta particular

              caso a variavel vTpContaPart esteja preenchida e a quantidade de lan?ento extra esteja nula. com iso deve ser procurado uma conta particular

              e um lan?ento para inseririr nesta conta.*/

              Nconta := NULL;

              Nlanc  := NULL;

				/*43289 - quebra de conta por quantidade de procedimento por atendimento*/

				/*A regra de pacote tem prioridade sobre essa regra, conforme vari?l Nqtexcedeu abaixo*/

				IF Nqtexcedeu IS NULL THEN

				    if (not vSnCriouContaAuto) then /*OP 46768*/

						  IF DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_EXISTE_CONF_QTD_ATEND_PAC(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

                                                                                             v_proced.cd_pro_fat,

                                                                                             pEmpresa) THEN



				    	      Nqtexcedeu := DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_RETORNA_QTD_LANC_PERIODO(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

                                                                                                           v_proced.cd_pro_fat,

																										   pEmpresa,

																										   ncdregfat,

																										   vQtdAux,

																										   pSnChamadoDaTela,

																										   pvSnJaExcedeuQtd,

																										   pvMensagem

																										   );

							  IF pvSnJaExcedeuQtd = 'S' THEN

								  Vtpcontapart := 'ProcPorAtend';

								  Nqtexcedeu   := NULL;

							  ELSE

									IF NVL(Nqtexcedeu,0) > 0 THEN

										Vtpcontapart := 'ProcPorAtend';

									END IF;

							  END IF;

					    END IF;

					END IF; /*OP 46768*/

                END IF;

		        /*43289*/

              IF Nvl(Vtpcontapart, 'X') <> 'X' AND Nqtexcedeu IS NULL THEN

                Nconta := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                           v_Mvto.Cd_Atendimento),

                                                                       Ddthraux1);

                OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Nconta);

                FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                  INTO Nlanc;

                CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

              END IF;

              INSERT INTO Dbamv.Itreg_Fat

                (Cd_Reg_Fat,

                 Cd_Lancamento,

                 Dt_Lancamento,

                 Hr_Lancamento,

                 Qt_Lancamento,

                 Cd_Guia,

                 Vl_Percentual_Multipla,

                 Cd_Gru_Fat,

                 Cd_Pro_Fat,

                 Sn_Pertence_Pacote,

                 Cd_Prestador,

                 Cd_Ati_Med,

                 Tp_Pagamento,

                 Cd_Setor,

                 Cd_Setor_Produziu,

                 Sn_Horario_Especial,

                 Cd_Usuario,

                 Cd_Mvto,

                 Tp_Mvto,

                 Cd_Itmvto

                 -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                ,

                 Cd_Conta_Pacote

                 -- PDA 157145 (Fim)

                 ,cd_regra_substituicao_proced

                 )

              VALUES

                (Nvl(Nconta, Ncdregfat) -- OP 387

                ,

                 Nvl(Nlanc, Ncdlcto) -- OP 387

                 --,v_mvto.dt_pre_med -- PDA 257297

                 --,v_mvto.hr_pre_med -- PDA 257297

                ,

                 Trunc(Ddthraux1) -- PDA 257297

                ,

                 Ddthraux1 -- PDA 257297

                 /*,NVL (nqtconv, nqtprofat)*/ /*PDA.: 294932*/,

                 Nvl(Nqtexcedeu, Vqtdaux) -- OP 387

                , /*Alterado por Erik Devido a Solicita? para lcto autom?co na CP, trocado por nqtprofat*/

                 Ncdguia,

                 100,

                 Ncdgrufat,

                 v_Proced.Cd_Pro_Fat,

                 Nvl(Csnpacote, 'N'),

                 Nprestador,

                 Ccdatimed,

                 Ctppgto,

                 Ncdsetor,

                 Nvl(Ncdsetorexa, Ncdsetor),

                 Csnhoresp,

                 USER,

                 Ncdpremed,

                 Nvl(Vtpcontapart, 'Prescricao') -- OP 387

                ,

                 Ncditemmvto

                 -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                ,

                 Ncdpacote

                 -- PDA 157145 (Fim)

                 ,nRegraSubstituicao

                 );



              /*OP 42241 - Caso tenha criado a conta por cargo paciente, devemos lan? o item para o convenio, plano, percentual definido na configura

              de quebra de conta por cargo paciente*/

              IF (vSnCriouContaAutoCP) THEN

                  vSnCriouContaAutoCP := FALSE;



                  OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(v_ContaCargoPac(1).cd_reg_fat);

                  FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                  INTO NcdlctoCp;

                  CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;



                   INSERT INTO Dbamv.Itreg_Fat

                    (Cd_Reg_Fat,

                     Cd_Lancamento,

                     Dt_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Vl_Percentual_Multipla,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Sn_Pertence_Pacote,

                     Cd_Prestador,

                     Cd_Ati_Med,

                     Tp_Pagamento,

                     Cd_Guia,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto,

                     Cd_Itmvto,

                     cd_regra_substituicao_proced

                     )

                  VALUES

                    (v_ContaCargoPac(1).cd_reg_fat,

                     NcdlctoCp,

                     Trunc(Ddthraux1),

                     Ddthraux1,

                     Nvl(Nqtexcedeu, Vqtdaux),

                     vRegraCriaContaAutoCP(1).vl_percentual_carga_familiar,

                     Ncdgrufat,

                     v_Proced.Cd_Pro_Fat,

                     'N',

                     Nprestador,

                     Ccdatimed,

                     Ctppgto,

                     Ncdguia,

                     Ncdsetor,

                     Nvl(Ncdsetorexa, Ncdsetor),

                     'N',

                     USER,

                     Ncdpremed,

                     Nvl(Vtpcontapart, 'Prescricao'),

                     Ncditemmvto ,

                     nRegraSubstituicao

                     );

              END IF;

              /*OP 42241*/





              /*OP 41394 - replicar horario especial no lan?ento autom?co. Incialmente implementa? pro cliente HOSCAR*/

              IF (nvl(Csnhoresp,'N') = 'S'

                  AND (NOT vSnCriouContaAuto) /*n??m item de regra de quebra de conta autom?ca*/

                  AND vSnReplicaProc = 'S' )  /*tem regra pra replicar proc de hor?o especial*/

                  THEN



                  OPEN cProced(v_Proced.Cd_Pro_Fat);

                  FETCH cProced INTO vProced;

                  CLOSE cProced;



                  vRregra := NULL;

                  OPEN cRregra(Ncdconvconta,Ncdplanconta);

                  FETCH cRregra INTO vRregra;

                  CLOSE cRregra;



                  vNlsBanco := dbamv.FNC_FFCV_FIRST_DAY_SEMANA_BR('S',null);

                  OPEN dbamv.pack_lanca_ffcv.cSnReplicaProcHe(vRregra.cd_regra,

                                        vProced.cd_gru_pro,

                                        v_Proced.Cd_Pro_Fat,

                                        TO_NUMBER(TO_CHAR(Trunc(Ddthraux1), 'd')),

                                        Ddthraux1,

                                        v_Mvto.Tp_Atendimento);

                  FETCH dbamv.pack_lanca_ffcv.cSnReplicaProcHe INTO vSnReplicaProcHe;

                  CLOSE dbamv.pack_lanca_ffcv.cSnReplicaProcHe;

                  vNlsBanco := dbamv.FNC_FFCV_FIRST_DAY_SEMANA_BR('N',vNlsBanco);



                  IF Nvl(vSnReplicaProcHe.sn_replica_proc,'N') = 'S' THEN



                      dbamv.prc_ffcv_replica_proc_he(Nvl(Nconta, Ncdregfat),     -- pCdConta IN NUMBER ,

                                                  Nvl(Nlanc, Ncdlcto),             --pCdLancConta IN NUMBER ,

                                                  'I',                            --pTpAtend     IN VARCHAR2,

                                                  vSnReplicaProcHe.vl_percentual, --pVlPercent   IN NUMBER DEFAULT null,

                                                  'N'                             --pSnInsereConta IN VARCHAR2

                                                  );



                      dbamv.prc_ffcv_replica_proc_he(Nvl(Nconta, Ncdregfat),

                                                  Nvl(Nlanc, Ncdlcto),

                                                  'I',

                                                  null,

                                                  'S');

                  END IF;

              END IF;

              /*OP 41394*/



              /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

              que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

              os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

              IF Nqtexcedeu IS NOT NULL THEN

                Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregfat,

                                                                    Ncdlcto,

                                                                    (Nvl(Nqtconv,

                                                                         Nqtprofat) -

                                                                    Nqtexcedeu),

                                                                    Vtpcontapart,

                                                                    Ddthraux1,

																	nvl(v_mvto.cd_atendimento_pai, v_mvto.cd_atendimento)); /*ALLS OP 43289*/



              END IF;

            END IF;

            -- pda 108337 - 29/10/2004 - Amalia Ara??

            -- Para n?lan? o procedimento com quantidade zerada na conta Particular

            --If (nqtpart is not null or nqtpart > 0) and cTpProibicao = 'AG'  then

            IF Nvl(Nqtpart, 0) > 0 AND Ctpproibicao = 'AG' THEN

              -- pda 108337 - fim

              IF v_Existeconta IS NOT NULL THEN

                /*PDA.: 294932 - 08/07/2009 - Emanoel Deivison (inicio)

                  Decri?: vari?l criada para receber a quantidade lan?a na conta hospitalar e efetuar o arredondamento da mesma.

                            Pois quando os itens est?sendo lan?os na conta hospitalar atrav?do m??o de prescri? (PAGU)

                            com quantidade menor que 1 (por exemplo: 0,08) ele fica zerado na conta.

                */

                Vqtdaux := 0;

                Vqtdaux := Nqtpart;

                IF Nvl(Vqtdaux, 0) < 1 THEN

                  Vqtdaux := 1;

                END IF;

                /*PDA.: 294932 - 08/07/2009 - Emanoel Deivison (fim)*/

                INSERT INTO Dbamv.Itreg_Fat

                  (Cd_Reg_Fat,

                   Cd_Lancamento,

                   Dt_Lancamento,

                   Hr_Lancamento,

                   Qt_Lancamento,

                   Cd_Guia,

                   Vl_Percentual_Multipla,

                   Cd_Gru_Fat,

                   Cd_Pro_Fat,

                   Sn_Pertence_Pacote,

                   Cd_Prestador,

                   Cd_Ati_Med,

                   Tp_Pagamento,

                   Cd_Setor,

                   Cd_Setor_Produziu,

                   Sn_Horario_Especial,

                   Cd_Usuario,

                   Cd_Mvto,

                   Tp_Mvto,

                   Cd_Itmvto -- pda 114164

                   -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                  ,

                   Cd_Conta_Pacote

                   -- PDA 157145 (Fim)

                   ,cd_regra_substituicao_proced

                   )

                VALUES

                  (v_Existeconta,

                   Ncdlcto

                   --,v_mvto.dt_pre_med -- PDA 257297

                   --,v_mvto.hr_pre_med -- PDA 257297

                  ,

                   Trunc(Ddthraux1) -- PDA 257297

                  ,

                   Ddthraux1 -- PDA 257297

                   /*,nqtpart*/ /*PDA.: 294932*/,

                   Vqtdaux /*PDA.: 294932*/, --Alterado por Erik Devido a Solicita? para lcto autom?co na CP, trocado por nqtprofat

                   Ncdguia,

                   100,

                   Ncdgrufat,

                   v_Proced.Cd_Pro_Fat,

                   Nvl(Csnpacote, 'N'),

                   Nprestador,

                   Ccdatimed,

                   Ctppgto,

                   Ncdsetor,

                   Nvl(Ncdsetorexa, Ncdsetor),

                   Csnhoresp,

                   USER,

                   Ncdpremed,

                   'Prescricao',

                   Ncditemmvto -- pda 114164

                   -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                  ,

                   Ncdpacote

                   -- PDA 157145 (Fim)

                   ,nRegraSubstituicao

                   );

              ELSE

                --                        ncdregfat := dbamv.pack_lanca_ffcv.cria_conta_pacparthosp (v_mvto.cd_atendimento, v_mvto.dt_pre_med); -- pda 125871(acrescentada a data)

                Ncdregfat := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento,

                                                                          Ddthraux1); -- PDA 257297

                /*PDA.: 294932 - 08/07/2009 - Emanoel Deivison (inicio)

                  Decri?: vari?l criada para receber a quantidade lan?a na conta hospitalar e efetuar o arredondamento da mesma.

                            Pois quando os itens est?sendo lan?os na conta hospitalar atrav?do m??o de prescri? (PAGU)

                            com quantidade menor que 1 (por exemplo: 0,08) ele fica zerado na conta.

                */

                Vqtdaux := 0;

                Vqtdaux := Nqtpart;

                IF Nvl(Vqtdaux, 0) < 1 THEN

                  Vqtdaux := 1;

                END IF;

                /*PDA.: 294932 - 08/07/2009 - Emanoel Deivison (fim)*/

                INSERT INTO Dbamv.Itreg_Fat

                  (Cd_Reg_Fat,

                   Cd_Lancamento,

                   Dt_Lancamento,

                   Hr_Lancamento,

                   Qt_Lancamento,

                   Cd_Guia,

                   Vl_Percentual_Multipla,

                   Cd_Gru_Fat,

                   Cd_Pro_Fat,

                   Sn_Pertence_Pacote,

                   Cd_Prestador,

                   Cd_Ati_Med,

                   Tp_Pagamento,

                   Cd_Setor,

                   Cd_Setor_Produziu,

                   Sn_Horario_Especial,

                   Cd_Usuario,

                   Cd_Mvto,

                   Tp_Mvto,

                   Cd_Itmvto --pda 114164

                   -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                  ,

                   Cd_Conta_Pacote

                   -- PDA 157145 (Fim)

                   ,cd_regra_substituicao_proced

                   )

                VALUES

                  (Ncdregfat,

                   Ncdlcto

                   --,v_mvto.dt_pre_med -- PDA 257297

                   --,v_mvto.hr_pre_med -- PDA 257297

                  ,

                   Trunc(Ddthraux1) -- PDA 257297

                  ,

                   Ddthraux1 -- PDA 257297

                   /*,nqtpart*/ /*PDA.: 294932*/,

                   Vqtdaux /*PDA.: 294932*/, --Alterado por Erik Devido a Solicita? para lcto autom?co na CP, trocado por nqtprofat

                   Ncdguia,

                   100,

                   Ncdgrufat,

                   v_Proced.Cd_Pro_Fat,

                   Nvl(Csnpacote, 'N'),

                   Nprestador,

                   Ccdatimed,

                   Ctppgto,

                   Ncdsetor,

                   Nvl(Ncdsetorexa, Ncdsetor),

                   Csnhoresp,

                   USER,

                   Ncdpremed,

                   'Prescricao',

                   Ncditemmvto -- pda 114164

                   -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                  ,

                   Ncdpacote

                   -- PDA 157145 (Fim)

                   ,nRegraSubstituicao

                   );

              END IF;

            END IF;



            IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                          Ncdlcto,

                                                          'I') THEN

              IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                            Ncdlcto,

                                                            'I') THEN

                Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'I');

              END IF;

            END IF;

            -- /* Lancamento dos Valores Relacionados */ --

            DECLARE

              CURSOR c_Relacionados IS

                  SELECT Rela.Cd_Pro_Fat,

                         Rela.Tp_Atend_Homecare,

                         Rela.Tp_Atend_Externo,

                         Rela.Tp_Atend_Urgeme,

                         Rela.Tp_Atend_Ambulatorial,

                         Rela.Tp_Atend_Internacao,

                         Rela.Sn_Faturamento_Direto,

                         Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

                    FROM Dbamv.Regra,

                         Dbamv.Val_Pro_Relacionado Rela,

                         Dbamv.Empresa_Con_Pla

                   WHERE Empresa_Con_Pla.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

                     AND Rela.Tp_Lancamento = 'A'

                     AND EMPRESA_CON_PLA.CD_CONVENIO = V_MVTO.CD_CONVENIO

                     AND EMPRESA_CON_PLA.CD_CON_PLA = V_MVTO.CD_CON_PLA

                     AND Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat

				             AND ((v_Mvto.Tp_Atendimento = 'H' AND

                         Rela.Tp_Atend_Homecare = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'E' AND

                         Rela.Tp_Atend_Externo = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'U' AND

                         Rela.Tp_Atend_Urgeme = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'A' AND

                         Rela.Tp_Atend_Ambulatorial = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'I' AND

                         Rela.Tp_Atend_Internacao = 'S'))

                    AND Empresa_Con_Pla.Cd_Regra = Regra.Cd_Regra

                    AND Rela.Cd_Regra = Regra.Cd_Regra

                    AND RELA.DT_VIGENCIA IN

                     (SELECT MAX(VPR.DT_VIGENCIA)

                        FROM DBAMV.VAL_PRO_RELACIONADO VPR

                       WHERE VPR.DT_VIGENCIA <= v_Mvto.Dt_Atendimento

                         AND VPR.CD_REGRA = RELA.CD_REGRA

                         AND VPR.CD_PRO_FAT_PAI = RELA.CD_PRO_FAT_PAI

                         AND VPR.CD_PRO_FAT = RELA.CD_PRO_FAT)



					      UNION ALL



              SELECT Rela.Cd_Pro_Fat,

                         Rela.Tp_Atend_Homecare,

                         Rela.Tp_Atend_Externo,

                         Rela.Tp_Atend_Urgeme,

                         Rela.Tp_Atend_Ambulatorial,

                         Rela.Tp_Atend_Internacao,

                         Rela.Sn_Faturamento_Direto,

                         Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

                FROM DBAMV.REGRA,

                     DBAMV.VAL_PRO_RELACIONADO RELA,

                     DBAMV.EMPRESA_CON_PLA --,



               WHERE EMPRESA_CON_PLA.CD_MULTI_EMPRESA = DBAMV.PKG_MV2000.LE_EMPRESA

                 AND RELA.CD_PRO_FAT_PAI IS NULL

                 AND RELA.CD_GRU_PRO_PAI = (SELECT P.CD_GRU_PRO

                                              FROM DBAMV.PRO_FAT P

                                             WHERE CD_PRO_FAT = V_PROCED.CD_PRO_FAT)

                 AND EMPRESA_CON_PLA.CD_CONVENIO = V_MVTO.CD_CONVENIO

                 AND EMPRESA_CON_PLA.CD_CON_PLA = V_MVTO.CD_CON_PLA

                 AND RELA.TP_LANCAMENTO = 'A'

                 AND ((V_MVTO.TP_ATENDIMENTO = 'H' AND RELA.TP_ATEND_HOMECARE = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'E' AND RELA.TP_ATEND_EXTERNO = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'U' AND RELA.TP_ATEND_URGEME = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'A' AND RELA.TP_ATEND_AMBULATORIAL = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'I' AND RELA.TP_ATEND_INTERNACAO = 'S'))

                 AND EMPRESA_CON_PLA.CD_REGRA = REGRA.CD_REGRA

                 AND RELA.CD_REGRA = REGRA.CD_REGRA

                 AND RELA.DT_VIGENCIA IN

                     (SELECT MAX(VPR.DT_VIGENCIA)

                        FROM DBAMV.VAL_PRO_RELACIONADO VPR

                       WHERE VPR.DT_VIGENCIA <= v_Mvto.Dt_Atendimento

                         AND VPR.CD_REGRA = RELA.CD_REGRA

                          AND VPR.CD_GRU_PRO_PAI = RELA.CD_GRU_PRO_PAI

                          AND VPR.CD_PRO_FAT = RELA.CD_PRO_FAT

                      );

              -- PDA 105921 - (Fim)

              Cretorno VARCHAR2(1);

              --

            BEGIN

              FOR Rec_Rela IN c_Relacionados

              LOOP

                Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(v_Mvto.Cd_Atendimento,

                                                              Ncdregfat,

                                                              Ncdlcto,

                                                              Ncdpremed,

                                                              v_Proced.Cd_Pro_Fat

                                                              --,v_mvto.dt_pre_med -- PDA 257297

                                                              --,v_mvto.hr_pre_med -- PDA 257297

                                                             ,

                                                              Trunc(Ddthraux1) -- PDA 257297

                                                             ,

                                                              Ddthraux1 -- PDA 257297

                                                             ,

                                                              Ncdsetor,

                                                              v_Mvto.Tp_Mvto_Estoque,

                                                              v_Mvto.Tp_Atendimento,

                                                              v_Mvto.Dt_Atendimento,

                                                              Ncdconvconta, --V_Conta.cd_convenio    ,

                                                              Ncdplanconta /*  ncdconvconta    pda 131200  */, --V_Conta.Cd_con_pla     ,

                                                              NULL

                                                              /*nCd_atendimento_pai*/,

                                                              v_Mvto.Tp_Convenio,

                                                              v_Mvto.Dt_Alta,

                                                              Rec_Rela.Cd_Pro_Fat, --PDA 108042 22/11/2004 Sp?ola (INICIO)

                                                              --As quantidades lan?a ser?ultiplicadas pelo fator de quantidade qt_lancamento

                                                              Rec_Rela.Qt_Lancamento *

                                                              Nvl(Nqtconv,

                                                                  Nqtprofat),

                                                              Rec_Rela.Qt_Lancamento *

                                                              Nvl(Nqtconv,

                                                                  Nqtprofat), --PDA 108042 (FIM)

                                                              Caction

                                                              --PDA 108070 29/12/2004 Sp?ola (INICIO)

                                                              --Inserido o campo do prestador que ser?tilizado apenas para os procedimentos relacionados de ambulatorio

                                                              --lancadados pela prc_ffcv_lanca_atendimento - lancamento automatico do procedimento principal na criacao do atendimento

                                                              -- PDA 135525 (Inicio) - Henrique Antunes - 14/11/2005

                                                              --,NULL        --cd_prestador

                                                             ,

                                                              Nprestador

                                                              -- PDA 135525 (Fim)

                                                              --PDA 108070 (FIM)

                                                              -- pda 119975 - 29/05/2005 - Amalia Ara??

                                                              -- par?tro de fator relacionado para insert nas tabelas itreg_amb e itreg_fat

                                                             ,

                                                              Rec_Rela.Qt_Lancamento

                                                              -- pda 119975 - fim

                                                              );

              END LOOP;

            END;

          ELSE

            -- PDA 112788 (INICIO) - 19/01/2004 - Pollyane/Alexandre

            -- Caso exista proibi? NA (n?Autorizado) pega o convenio particular, sen?preenche a vari?l com nulo

            IF Nvl(Ctpproibicao, 'AA') = 'NA' THEN

              -- n?Autorizado

              Ncdconvconta := v_Config.Cd_Convenio_Fat_Extra;

            ELSE

              Ncdconvconta := NULL;

            END IF;

            -- pois desta forma no cursor C_conta levar?m considera? o convenio do atendimento.

            -- PDA 112788 -- Incluir como par?tro o c??o do convenio que pode ser o convenio particular ou nulo (como era antes).

            --PDA 157595(INICIO) 14/04/2008 - Jansen Gallindo

            /*OPEN dbamv.pack_lanca_ffcv.c_conta (v_mvto.cd_atendimento

                                               ,NVL (vdh_cancelado

                                                --PDA 184670(In?o)

                                                --v_mvto.dt_pre_med)

                                                ,to_date(to_char(v_mvto.dt_pre_med,'dd/mm/yyyy')||' '||to_char(v_mvto.hr_pre_med,'hh24:mi'),'dd/mm/yyyy hh24:mi'))

                                                --PDA 184670(Fim)

                                               ,ncdconvconta

                                               ,v_mvto.cd_atendimento_pai

                                               );

            FETCH dbamv.pack_lanca_ffcv.c_conta INTO v_conta;

            CLOSE dbamv.pack_lanca_ffcv.c_conta;*/

            /*OP 35916 - regra para cria? autom?ca de conta*/

            vSnCriouContaAuto := FALSE;

            vTemRegraCriaContaAuto  := Dbamv.Pkg_Ffcv_Conta.FNC_TEM_REG_CRIA_CONTA_AUTO;

            IF (vTemRegraCriaContaAuto) THEN



                    /*ALLS OP 42241*/

                    OPEN dbamv.pack_lanca_ffcv.cSnCargoPaciente(v_Mvto.Cd_Atendimento);

                    FETCH dbamv.pack_lanca_ffcv.cSnCargoPaciente INTO vSnCargoPaciente;

					          CLOSE dbamv.pack_lanca_ffcv.cSnCargoPaciente;



					          IF Nvl(vSnCargoPaciente.sn_carga_familiar,'N') = 'S' THEN



                        vRegraCriaContaAutoCP := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTCP(v_Mvto.Cd_Atendimento,

                                                                                                     v_Proced.Cd_Pro_Fat,

                                                                                                     Ddthraux1); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAutoCP(1).cd_regra_cria_conta IS NOT NULL ) THEN



                            v_ContaCargoPac :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_HOSP_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                                 null,

                                                                                                 v_Mvto.Cd_Atendimento,

                                                                                                 v_Mvto.Cd_Atendimento_Pai,

                                                                                                 vRegraCriaContaAutoCP(1).cd_convenio_destino,

                                                                                                 vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                                                                                                 Ddthraux1,

                                                                                                 vRegraCriaContaAutoCP(1).cd_tipo_arq_cta_envio,

                                                                                                 vRegraCriaContaAutoCP(1).cd_desconto_inst); /*ALLS OP 35921*/

                            vSnCriouContaAutoCP := TRUE;

                        END IF;

                    /*fim ALLS OP 42241*/

                    ELSE



                        vRegraCriaContaAuto := Dbamv.Pkg_Ffcv_Conta.FNC_VERIFIC_REG_CRIA_CONTA_AUT(v_Mvto.Cd_Atendimento,

                                                                                                   v_Proced.Cd_Pro_Fat,

                                                                                                   Ddthraux1); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAuto(1).cd_regra_cria_conta IS NOT NULL ) THEN



                            v_Conta :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_HOSP_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                          null,

                                                                                          v_Mvto.Cd_Atendimento,

                                                                                          v_Mvto.Cd_Atendimento_Pai,

                                                                                          vRegraCriaContaAuto(1).cd_convenio_destino,

                                                                                          vRegraCriaContaAuto(1).cd_con_pla_destino,

                                                                                          Ddthraux1,

                                                                                          vRegraCriaContaAuto(1).cd_tipo_arq_cta_envio,

                                                                                          vRegraCriaContaAuto(1).cd_desconto_inst); /*ALLS OP 35921*/



                            vSnCriouContaAuto := TRUE;

                        END IF;



                    END IF;



            END IF;



            IF (NOT vSnCriouContaAuto) THEN

            /*OP 35916 - regra para cria? autom?ca de conta*/

               v_Conta := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Conta(v_Mvto.Cd_Atendimento,

                                                              Nvl(Vdh_Cancelado

                                       --      ,to_date(to_char(v_mvto.dt_pre_med,'dd/mm/yyyy')||' '||to_char(v_mvto.hr_pre_med,'hh24:mi'),'dd/mm/yyyy hh24:mi')) -- PDA 257297

                                                                 ,

                                                                  Ddthraux1) -- PDA 257297

                                                             ,

                                                              Ncdconvconta,

                                                              v_Mvto.Cd_Atendimento_Pai);

            END IF;/*OP 35916*/



            -- PDA 112788 -- Incluido a verifica? do tipo de proibi?.

            --IF v_conta.cd_reg_fat IS NULL AND NVL (ctpproibicao, 'AA') <> 'NA' THEN

            IF v_Conta(1)

            .Cd_Reg_Fat IS NULL AND Nvl(Ctpproibicao, 'AA') <> 'NA' THEN

              --PDA 157595(FIM) 14/04/2008 - Jansen Gallindo

              -- PDA 112788 (Fim)

              Ncdregfat := Dbamv.Pack_Lanca_Ffcv.Verifica_Conta_Secundaria(v_Mvto.Cd_Atendimento,

                                                                           Vdh_Cancelado,

                                                                           v_Mvto.Cd_Convenio_Secundario,

                                                                           v_Mvto.Cd_Atendimento_Pai);

            ELSE

              --ncdregfat := v_conta.cd_reg_fat; --PDA 157595

              Ncdregfat := v_Conta(1).Cd_Reg_Fat; --PDA 157595

            END IF;

            -- PDA 112788 (INICIO) - 19/01/2005 - Pollyane/Alexandre

            -- Verificar se exite conta dispon?l.

            IF Ncdregfat IS NULL THEN

              RAISE Atend_Sem_Conta;

            END IF;

            -- PDA 112788 (FIM)

            IF Deleting AND Nqtnew IS NULL THEN

              Nqtprofat := 0;

            END IF;

            -- PDA 113220 -- 28/01/2005 -- Alexandre Erik C. M. Costa (INICIO)

            -- Pegar o prestador associado ao setor e setar a variavel nPrestador conforme ?ealizado na inser? do item.

            OPEN c_Setor;

            FETCH c_Setor

              INTO Ncdsetorexa, Nprestsetexa;

            CLOSE c_Setor;

            Nprestador := Nvl(Nprestsetexa,

                              Nvl(Ncdprestador, v_Mvto.Cd_Prestador));

            -- PDA 113220 -- (FIM)

            Ndiferenca := Nqtprofat - Noldqtprofat;

            OPEN c_Itregfat_Pagu(Ncdregfat,

                                 v_Proced.Cd_Pro_Fat,

                                 Ncdpremed,

                                 Nprestador,

                                 Ncd_Setor,

                                 Ncditemmvto);

            FETCH c_Itregfat_Pagu

              INTO v_Itregfat;

            CLOSE c_Itregfat_Pagu;

            -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

            Ncdregfat := v_Itregfat.Cd_Reg_Fat;

            -- PDA 167142 (Fim)

            Ncdlcto := v_Itregfat.Cd_Lancamento;

            IF v_Itregfat.Cd_Lancamento IS NOT NULL THEN

              --

              /* pda 141006 - 06/06/2006 - Amalia Ara??

              Identificando a guia do item. Caso encontre e a mesma ainda esteja Pendente,

              ir?etirar mais abaixo a mesma quantidade que est?etirando da conta.       */

              --

              Ncdguiaitem := NULL;

              OPEN Dbamv.Pkg_Ffcv_Guia.Cguianoitem(Ncdregfat,

                                                   Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                       v_Mvto.Cd_Atendimento),

                                                   Ncdlcto);

              FETCH Dbamv.Pkg_Ffcv_Guia.Cguianoitem

                INTO Ncdguiaitem;

              CLOSE Dbamv.Pkg_Ffcv_Guia.Cguianoitem;

              /* pda 141006 - fim */

              --

              IF v_Itregfat.Qt_Lancamento + Ndiferenca <= 0 THEN

                Nqtaux := Noldqtprofat;

                LOOP

                  Nqtaux := Nqtaux - v_Itregfat.Qt_Lancamento;

                  IF Ncdlcto IS NOT NULL THEN

                    IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                                  Ncdlcto,

                                                                  'E') THEN

                      IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                                    Ncdlcto,

                                                                    'E') THEN

                        Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'E');

                      END IF;

                    END IF;

                    --

                    IF Nqtaux >= 0 THEN

                      -- pda 63015

                      --

                      DELETE Dbamv.Itreg_Fat

                       WHERE Cd_Reg_Fat = Ncdregfat

                         AND Cd_Lancamento = Ncdlcto;

                      /* PDA 288525 - 05/06/2009 - In?o - Fabr?o Oliveira de Miranda

                      A chamada desta procedure estava ocorrendo antes de apagar o item da conta e podia

                      ocorrer erro caso a guia fosse deletada sem deletar o item da conta antes. */

                      /* pda 141006 - 06/06/2006 - Amalia Ara??

                      Retirando o item da guia, caso haja e a guia ainda esteja Pendente. */

                      IF Ncdguiaitem IS NOT NULL THEN

                        Dbamv.Pkg_Ffcv_Guia.Prc_Retirar_Item_Guia(Ncdguiaitem,

                                                                  v_Proced.Cd_Pro_Fat,

                                                                  v_Itregfat.Qt_Lancamento);

                      END IF;

                      /* pda 141006 - fim */

                      --

                      /* PDA 288525 - 05/06/2009 - Fim - Fabr?o Oliveira de Miranda */

                    ELSE

                      --

                      /* pda 141006 - 06/06/2006 - Amalia Ara??

                      Retirando o item da guia, caso haja e a guia ainda esteja Pendente. */

                      IF Ncdguiaitem IS NOT NULL THEN

                        Dbamv.Pkg_Ffcv_Guia.Prc_Retirar_Item_Guia(Ncdguiaitem,

                                                                  v_Proced.Cd_Pro_Fat,

                                                                  v_Itregfat.Qt_Lancamento -

                                                                  Abs(Nqtaux));

                      END IF;

                      /* pda 141006 - fim */

                      --

                      UPDATE Dbamv.Itreg_Fat

                         SET Qt_Lancamento           = Abs(Nqtaux), --qt_lancamento + nDiferenca,

                             Vl_Unitario             = NULL,

                             Vl_Filme_Unitario       = NULL,

                             Vl_Acrescimo            = NULL,

                             Vl_Desconto             = NULL,

                             Vl_Honorario_Unitario   = NULL,

                             Vl_Operacional_Unitario = NULL,

                             Vl_Total_Conta          = NULL

                      -- PDA 113220 -- 28/01/2005 -- Alexandre Erik (INICIO)

                      -- Estava jogando nulo para o prestador.

                      -- cd_prestador = nPrestador

                      -- PDA 113220 -- (FIM)

                       WHERE Cd_Reg_Fat = Ncdregfat

                         AND Cd_Lancamento = Ncdlcto;

                    END IF; -- pda 63015

                    IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                                  Ncdlcto,

                                                                  'A') THEN

                      IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                                    Ncdlcto,

                                                                    'A') THEN

                        Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'A');

                      END IF;

                    END IF;

                    -- pda 63015

                    OPEN c_Itregfat_Pagu(Ncdregfat,

                                         v_Proced.Cd_Pro_Fat,

                                         Ncdpremed,

                                         Nprestador,

                                         Ncdsetor,

                                         Ncditemmvto);

                    FETCH c_Itregfat_Pagu

                      INTO v_Itregfat;

                    CLOSE c_Itregfat_Pagu;

                    -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

                    Ncdregfat := v_Itregfat.Cd_Reg_Fat;

                    -- PDA 167142 (Fim)

                    Ncdlcto := v_Itregfat.Cd_Lancamento;

                  ELSE

                    EXIT;

                  END IF;

                  EXIT WHEN Nqtaux <= 0;

                END LOOP;

              ELSE

                -- V_ItRegFat.qt_lancamento + nDiferenca > 0

                /* Update Dbamv.itreg_fat

                    Set qt_lancamento = qt_lancamento + nDiferenca,

                          vl_unitario = null,

                          vl_filme_unitario = null,

                          vl_acrescimo = null,

                          vl_desconto = null,

                          vl_honorario_unitario = null,

                          vl_operacional_unitario = null,

                          vl_total_conta = null,

                          cd_prestador = nPrestador

                 Where cd_reg_fat_rel = nCdRegFat

                    and cd_lancamento_rel = nCdLcto;

                */

                UPDATE Dbamv.Itreg_Fat

                   SET Qt_Lancamento           = Qt_Lancamento + Ndiferenca,

                       Vl_Unitario             = NULL,

                       Vl_Filme_Unitario       = NULL,

                       Vl_Acrescimo            = NULL,

                       Vl_Desconto             = NULL,

                       Vl_Honorario_Unitario   = NULL,

                       Vl_Operacional_Unitario = NULL,

                       Vl_Total_Conta          = NULL

                -- PDA 113220 -- 28/01/2005 -- Alexandre Erik (INICIO)

                -- Estava jogando nulo para o prestador.

                -- cd_prestador = nPrestador

                -- PDA 113220 -- (FIM)

                 WHERE Cd_Reg_Fat = Ncdregfat

                   AND Cd_Lancamento = Ncdlcto;

              END IF;

            END IF;

          END IF;

        END IF;

      END IF;

    END IF;

    -- OP 40186 - chamada da integra?

    if vSnIntegracaoIpsemg = 'S'  THEN

		dbamv.prc_ffcv_autor_auto_ipsemg(Ncdguia,null,'P', Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),null ,Nprestador ,Nprestador ,null ,null , Nvl(Vtpcontapart, 'Prescricao'));

	end if ;

  EXCEPTION

    WHEN Atend_Sem_Conta THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdpremed,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Prescricao',

                     '04'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_4',

                                                       'PACK_LANCA_FFCV',

                                                       'Atendimento %s n?possui Conta aberta/disponivel.',

                                                       Arg_List(v_Mvto.Cd_Atendimento)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     pnCdAtendimento,   -- OP 34416 - corre? para n?ficar nulo.  -- Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting

                     --,v_mvto.dt_pre_med -- PDA 257297

                    ,

                     Ddthraux1 -- PDA 257297

                     );

    WHEN Fora_Da_Conta THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdpremed,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Prescricao',

                     '08'

                     --,'Procedimento com proibi? tipo Fora da Conta'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_8',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento com proibi? tipo Fora da Conta.',

                                                       Arg_List()) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     pnCdAtendimento,   -- OP 34416 - corre? para n?ficar nulo.  -- Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),



                     TRUE,

                     Deleting

                     --,v_mvto.dt_pre_med -- PDA 257297

                    ,

                     Ddthraux1 -- PDA 257297

                     );

    WHEN Prod_Nao_Conf THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdpremed,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Prescricao',

                     '01'



                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_16',

                                                       'PACK_LANCA_FFCV',

                                                       'Item de Prescri? %s n?tem relacionamento com Faturamento de Convenio.',

                                                       Arg_List(Ncdtippresc)) -- OP 10402  -- OP 11158

                    ,

                     v_Mvto.Tp_Atendimento,

                     pnCdAtendimento,   -- OP 34416 - corre? para n?ficar nulo.  -- Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),



                     TRUE,

                     Deleting

                     --,v_mvto.dt_pre_med -- PDA 257297

                    ,

                     Ddthraux1 -- PDA 257297

                     );

    WHEN Setor_Nao_Conf THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdpremed,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Prescricao',

                     '02'

                     --, 'Grupo de Procedimento ' || v_proced.cd_gru_pro || ' n?tem Grupo de Faturamento relacionado'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_14',

                                                       'PACK_LANCA_FFCV',

                                                       'Grupo de Procedimento %s n?tem Grupo de Faturamento relacionado.',

                                                       Arg_List(v_Proced.Cd_Gru_Pro)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     pnCdAtendimento,   -- OP 34416 - corre? para n?ficar nulo.  -- Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),



                     TRUE,

                     Deleting

                     --,v_mvto.dt_pre_med -- PDA 257297

                    ,

                     Ddthraux1 -- PDA 257297

                     );

    WHEN Proc_Proibido THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdpremed,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Prescricao',

                     '05'

                     --, 'Procedimento proibido para o Convenio ' || LTRIM (TO_CHAR (v_conta.cd_convenio)) || ' e Plano ' || LTRIM (TO_CHAR (v_conta.cd_con_pla)) --PDA 157595

                     --, 'Procedimento proibido para o Convenio ' || LTRIM (TO_CHAR (nCdConvConta)) || ' e Plano ' || LTRIM (TO_CHAR (nCdPlanConta)) --PDA 157595

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_7',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento proibido para o Convenio %s e Plano %s.',

                                                       Arg_List(Ltrim(To_Char(Ncdconvconta)),

                                                                Ltrim(To_Char(Ncdplanconta)))) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     pnCdAtendimento,   -- OP 34416 - corre? para n?ficar nulo.  -- Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),



                     TRUE,

                     Deleting

                     --,v_mvto.dt_pre_med -- PDA 257297

                    ,

                     Ddthraux1 -- PDA 257297

                     );

     -- OP 32555

     WHEN Proc_Proibido_idade THEN

	  -- OP 33697 - 05/10/2015 - Substituindo Gera_Log_Falha por Raise_Application_Error.

      Raise_Application_Error(-20054, Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20','PACK_LANCA_FFCV',

                                'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                Arg_List(v_Proced.Cd_Pro_Fat)));

      /*Gera_Log_Falha(Ncdregfat,

                     NULL,

                     Ncdpremed,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Prescricao',

                     '05',

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                                       Arg_List(v_Proced.Cd_Pro_Fat))

                    ,

                     v_Mvto.Tp_Atendimento,



                     TRUE,

                     Deleting

                    ,

                     Ddthraux1 -- PDA 257297

                     );*/

    WHEN Auditoria_In_Loco THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdpremed,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Prescricao',

                     '10'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_15',

                                                       'PACK_LANCA_FFCV',

                                                       'O periodo da conta %s est?m auditoria in-loco no momento do lan?ento.',

                                                       Arg_List(Ncdregfat)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     pnCdAtendimento,   -- OP 34416 - corre? para n?ficar nulo.  -- Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),



                     TRUE,

                     Deleting

                     --,v_mvto.dt_pre_med -- PDA 257297

                    ,

                     Ddthraux1 -- PDA 257297

                     );

  END;



  PROCEDURE Lanca_Componente_Ffcv(Ncditpremed        IN NUMBER,

                                  Ncdtippresc        IN NUMBER,

                                  Nqtnew             IN NUMBER,

                                  Nqtold             IN NUMBER,

                                  Caction            IN VARCHAR2, -- pda 86938 - 10/02/2004 - Amalia Ara??

                                  Pncdatendimento    IN NUMBER,

                                  Pddtpremed         IN DATE,

                                  Pdhrpremed         IN DATE,

                                  Pncdunidint        IN NUMBER,

                                  Pncdprestadorpresc IN NUMBER,

                                  Pncdsetor          IN NUMBER) IS

    -- pda 86938 - fim

  BEGIN

    Dbamv.Pack_Aux_Ffcv.Lanca_Componente_Ffcv(Ncditpremed,

                                              Ncdtippresc,

                                              Nqtnew,

                                              Nqtold,

                                              Caction,

                                              Pncdatendimento,

                                              Pddtpremed,

                                              Pdhrpremed,

                                              Pncdunidint,

                                              Pncdprestadorpresc,

                                              Pncdsetor);

  END;



  /*********************************************************************************************

  | Hist??o das modifica?s

  | PDA      Autor             Data

  | -------- ----------------  ------------------

  |  410457  Sergio Jose Rech  21/01/2011

  |  cliente 420

  |  altera? procedure lanca_psdi_ffcv para que quando na prescri? de um exame

  |  configurado no PAGU nos itens da prescri? no campo "Diag.Imagem", para o

  |  esquema 'CAR'(Cardiologia) deve cair na conta o prestador do setor do exame

  |  e n?o prestador do laudo(configura? do FFCV)

  |********************************************************************************************/

  PROCEDURE Lanca_Psdi_Ffcv(Ncdpedrx           IN NUMBER,

                            Ncditpedrx         IN NUMBER,

                            Ncdexarx           IN NUMBER,

                            Ddtrealiznew       IN DATE,

                            Ddtrealizold       IN DATE,

                            Nrfaturado         IN NUMBER,

                            Nrcdprestador      IN NUMBER,

                            Pcfaturado         IN NUMBER,

                            Ncditemformula     IN NUMBER DEFAULT NULL -- PDA 159898 Inicio

                           ,

                            Nsnincidenciaexame IN VARCHAR2 DEFAULT 'N' --PDA 145551 - HSR - RODRIGO VALENTIM

                            ) IS

    CURSOR c_Config IS

      SELECT Config_Ffcv.Sn_Raiox_Automatica,

             Config_Ffcv.Cd_Convenio_Fat_Extra,

             Config_Ffcv.Cd_Con_Pla_Fat_Extra,

             Config_Ffcv.Cd_Ati_Med_Clinico,

             Config_Ffcv.Tp_Prestador_Psdi,

             Config_Ffcv.Sn_Psdi_Pedido,

             Config_Ffcv.Tp_Controle_Lote,

             Config_Ffcv.Sn_Checa_Preco_Lcto,

             Config_Ffcv.Sn_Guia_Proc_Auto

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    /* pda 545011 - inclus?colunas vl_fator_pro_fat e cd_uni_pro nos cursores cKitImagem e c_proced.  */

    CURSOR Ckitimagem(Ncditpedrx IN NUMBER) IS

      SELECT Itf.Cd_Produto,

             Pfat.Cd_Pro_Fat,

             Gpro.Cd_Gru_Fat,

             Pfat.Cd_Gru_Pro,

             0 Cd_Exa_Rx,

             Pfat.Nr_Auxiliar,

             Pfat.Cd_Por_Ane,

             Nvl(Prod.Vl_Fator_Pro_Fat, 1) Vl_Fator_Pro_Fat,

             Itformula.Cd_Uni_Pro

        FROM Dbamv.Itped_Rx_Produto Itf,

             Dbamv.Pro_Fat Pfat,

             Dbamv.Gru_Pro Gpro,

             Dbamv.Produto Prod,

             Dbamv.Itformula,

             Dbamv.Exa_Rx_Formula

       WHERE Gpro.Cd_Gru_Pro = Pfat.Cd_Gru_Pro

         AND Prod.Cd_Pro_Fat = Pfat.Cd_Pro_Fat

         AND Prod.Cd_Produto = Itf.Cd_Produto

         AND Itf.Cd_Itped_Rx_Produto = Ncditpedrx

         AND Exa_Rx_Formula.Cd_Exa_Rx = Ncdexarx

         AND Itformula.Cd_Formula = Exa_Rx_Formula.Cd_Formula

         AND Itformula.Cd_Produto_Tem = Itf.Cd_Produto;

    /* PDA 159898 Fim */



    CURSOR c_Proced IS

      SELECT 0 Cd_Produto -- PDA 159898

            ,

             Exa_Rx.Exa_Rx_Cd_Pro_Fat Cd_Pro_Fat,

             Gru_Pro.Cd_Gru_Fat,

             Pro_Fat.Cd_Gru_Pro,

             Exa_Rx.Cd_Exa_Rx,

             Pro_Fat.Nr_Auxiliar,

             Pro_Fat.Cd_Por_Ane,

             1 Vl_Fator_Pro_Fat,

             To_Number(NULL) Cd_Uni_Pro -- pda 545011

        FROM Dbamv.Exa_Rx,

             Dbamv.Pro_Fat,

             Dbamv.Gru_Pro

       WHERE Exa_Rx.Cd_Exa_Rx = Ncdexarx

         AND Pro_Fat.Cd_Pro_Fat(+) = Exa_Rx.Exa_Rx_Cd_Pro_Fat

         AND Gru_Pro.Cd_Gru_Pro = Pro_Fat.Cd_Gru_Pro;



    -- OP 33697 *2 - 08/10/2015 - Identificar os dados pelo procedimento, por causa da regra de substitui? de procedimento.

    CURSOR cProcedProFat( vProFat in varchar2 ) IS

      SELECT 0 Cd_Produto

            ,Exa_Rx.Exa_Rx_Cd_Pro_Fat Cd_Pro_Fat,

             Gru_Pro.Cd_Gru_Fat,

             Pro_Fat.Cd_Gru_Pro,

             Exa_Rx.Cd_Exa_Rx,

             Pro_Fat.Nr_Auxiliar,

             Pro_Fat.Cd_Por_Ane,

             1 Vl_Fator_Pro_Fat,

             To_Number(NULL) Cd_Uni_Pro

        FROM Dbamv.Exa_Rx,

             Dbamv.Pro_Fat,

             Dbamv.Gru_Pro

       WHERE Exa_Rx.Cd_Exa_Rx = Ncdexarx

         AND Pro_Fat.Cd_Pro_Fat(+) = Exa_Rx.Exa_Rx_Cd_Pro_Fat

         AND Gru_Pro.Cd_Gru_Pro = Pro_Fat.Cd_Gru_Pro;

    cursor cGruProSub( vProFat in varchar2 ) is

      select gru_pro.cd_gru_fat

        from dbamv.pro_fat, dbamv.gru_pro

       where pro_fat.cd_pro_fat = vProFat

         and gru_pro.cd_gru_pro = pro_fat.cd_gru_pro;

    vProFatAnterior   dbamv.pro_fat.cd_pro_fat%type;   -- OP 33697 *2



    /* pda 545011 - Identificar o fator de diviS??a unidade.  */

    CURSOR c_Fator(Pnunipro IN Dbamv.Uni_Pro.Cd_Uni_Pro%TYPE) IS

      SELECT Nvl(Uni_Pro.Vl_Fator, 1) Vl_Fator

        FROM Dbamv.Uni_Pro

       WHERE Uni_Pro.Cd_Uni_Pro = Pnunipro;

    CURSOR c_Atimed IS

      SELECT Cd_Ati_Med

        FROM Dbamv.Ati_Med

       WHERE Tp_Funcao = 'C'

       ORDER BY Cd_Ati_Med; -- PDA 167989 - Jo?Paulo - 26/10/2006 - corre? no lan?ento de exame.



    CURSOR c_Equipe IS

      SELECT Cd_Prestador,

             Cd_Ati_Med,

             Tp_Pagamento

        FROM Dbamv.Itped_Rx_Equipe

       WHERE Cd_Itped_Rx = Ncditpedrx;

    CURSOR c_Mvto IS

      SELECT Ped_Rx.Cd_Atendimento

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- ,ped_rx.dt_pedido

            ,

             To_Date(To_Char(Ped_Rx.Dt_Pedido, 'dd/mm/yyyy') ||

                     To_Char(Ped_Rx.Hr_Pedido, 'hh24:mi:ss'),

                     'dd/mm/yyyy hh24:mi:ss') Dt_Pedido -- PDA 263291

             -- PDA 229502 (Fim)

            ,

             Ped_Rx.Hr_Pedido,

             Ped_Rx.Cd_Setor,

             Ped_Rx.Cd_Set_Exa,

             Nvl(Set_Exa.Cd_Prestador, Ped_Rx.Cd_Prestador) Cd_Prest_Set,

             Laudo_Rx.Cd_Prestador Cd_Prest_Lau,

             Atendime.Tp_Atendimento

             -- PDA 487457 - Raphanelli de Barros - 24/01/2012

             -- Erro no formato da converS??o tipo utilizada na hr do atendimento :  to_char(atendime.hr_atendimento, 'HH24:MM:SS')

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- atendime.dt_atendimento

            ,

             To_Date(To_Char(Atendime.Dt_Atendimento, 'DD/MM/YYYY') || ' ' ||

                     To_Char(Atendime.Hr_Atendimento, 'HH24:Mi:SS'),

                     'DD/MM/YYYY HH24:MI:SS') Dt_Atendimento

             -- ,atendime.dt_alta

            ,

             To_Date(To_Char(Atendime.Dt_Alta, 'dd/mm/yyyy') ||

                     To_Char(Atendime.Hr_Alta, 'hh24:mi'),

                     'dd/mm/yyyy hh24:mi') Dt_Alta

             -- PDA 229502 (Fim)

            ,

             Atendime.Sn_Importa_Auto,

             Atendime.Cd_Ori_Ate -- 100970 26/07/2006 - Thiago Holder Marcos Silva

            ,

             Set_Exa.Cd_Setor Cd_Setor_Set_Exa,

             Atendime.Cd_Atendimento_Pai,

             Nvl(Ped_Rx.Cd_Convenio, Atendime.Cd_Convenio) Cd_Convenio,

             Nvl(Ped_Rx.Cd_Con_Pla, Atendime.Cd_Con_Pla) Cd_Con_Pla,

             Convenio.Tp_Convenio,

             Atendime.Cd_Tip_Acom,

             Atendime.Cd_Convenio_Secundario,

             Atendime.Cd_Con_Pla_Secundario,

             Atendime.Cd_Multi_Empresa,

             Ped_Rx.Cd_Pre_Med -- PDA 418754/410457

            ,

             Laudo_Rx.Dt_Laudo -- PDA 543660

			 ,set_exa.TP_ORIGEM_PREST_FAT  -- OP 41079

			 ,Ped_Rx.Cd_Prestador cd_prestador_soli -- OP 41079

        FROM Dbamv.Ped_Rx,

             Dbamv.Atendime,

             Dbamv.Set_Exa,

             Dbamv.Laudo_Rx,

             Dbamv.Convenio,

             Dbamv.Empresa_Convenio

       WHERE Ped_Rx.Cd_Ped_Rx = Ncdpedrx

         AND Convenio.Cd_Convenio = Empresa_Convenio.Cd_Convenio /* PDA 118607/129023*/

         AND Empresa_Convenio.Cd_Multi_Empresa =

             Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/129023*/

         AND Atendime.Cd_Atendimento = Ped_Rx.Cd_Atendimento

         AND Ped_Rx.Cd_Set_Exa = Set_Exa.Cd_Set_Exa

         AND Laudo_Rx.Cd_Ped_Rx(+) = Ped_Rx.Cd_Ped_Rx

         AND Convenio.Cd_Convenio =

             Nvl(Ped_Rx.Cd_Convenio, Atendime.Cd_Convenio)

         AND Convenio.Tp_Convenio IN ('H', 'P', 'C')

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    CURSOR c_Grfasetorexame(Ngrpr IN NUMBER, Nsetor IN NUMBER) IS

      SELECT Setor_Gru_Fat.Cd_Gru_Fat

        FROM Dbamv.Setor_Gru_Fat

       WHERE Setor_Gru_Fat.Cd_Setor = Nsetor

         AND Setor_Gru_Fat.Cd_Gru_Pro = Ngrpr;

    CURSOR c_Config_Particular IS

      SELECT Cd_Convenio_Fat_Extra Cd_Convenio,

             Cd_Con_Pla_Fat_Extra  Cd_Con_Pla

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    /*PDA.: 272669 - 18/02/2009 - Emanoel Deivison (inicio)

    Descri?: Comentada a linha: "AND ROWNUM < 2" da cl?ula Where e adicionada a linha: "AND ((itreg_fat.cd_itmvto = pcd_itpedrx and nCdFormula is null) or ncdformula is not null);"

               Pois quando estavamos lan?do em um pedido de exame 02 (dois) procedimentos identificos,

               e depois estava alterando o prestador executante dos 02 (dois) procedimentos o sistema altera

               apenas de um ??o procedimento.

    */

    CURSOR c_Conta_Mvto_Hosp(Pcd_Pedrx NUMBER, Pcd_Itpedrx NUMBER -- PDA 159898

    , Pcd_Pro_Fat VARCHAR2, Ncdformula NUMBER -- PDA 159898

    ) IS

      SELECT DISTINCT Itreg_Fat.Cd_Reg_Fat,

                      Itreg_Fat.Cd_Lancamento,

                      Reg_Fat.Cd_Atendimento /* pda 141006 */,

                      Itreg_Fat.Qt_Lancamento /* pda 141006 */

        FROM Dbamv.Itreg_Fat,

             Dbamv.Reg_Fat

       WHERE /* itreg_fat.tp_mvto = 'Imagem' */ -- PDA 159898

       Itreg_Fat.Tp_Mvto = Decode(Ncdformula, NULL, 'Imagem', 'Kit-Exame') -- PDA 159898

       AND Reg_Fat.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

      --                   AND itreg_fat.cd_mvto                  = pcd_pedrx                       -- PDA 159898

       AND Itreg_Fat.Cd_Mvto = Decode(Ncdformula, NULL, Pcd_Pedrx, Pcd_Itpedrx) -- PDA 159898

       AND Itreg_Fat.Cd_Pro_Fat = Pcd_Pro_Fat

       AND Nvl(Itreg_Fat.Cd_Conta_Pai, Itreg_Fat.Cd_Reg_Fat) =

       Reg_Fat.Cd_Reg_Fat -- PDA 201954

       AND Nvl(Reg_Fat.Sn_Importa_Auto, 'S') = 'S'

       AND Nvl(Reg_Fat.Sn_Fechada, 'N') = 'N'

       AND ((Itreg_Fat.Cd_Itmvto = Pcd_Itpedrx AND Ncdformula IS NULL) OR

       Ncdformula IS NOT NULL);

    /*AND ROWNUM < 2;*/

    /*PDA.: 272669 - (fim)*/

    /*PDA.: 272669 - 18/02/2009 - Emanoel Deivison (inicio)

    Descri?: Comentada a linha: "AND ROWNUM < 2" da cl?ula Where e adicionada a linha: "AND ((itreg_amb.cd_itmvto = pcd_itpedrx and ncdformula is null) or ncdformula is not null);"

               Pois quando estavamos lan?do em um pedido de exame 02 (dois) procedimentos identificos,

               e depois estava alterando o prestador executante dos 02 (dois) procedimentos o sistema altera

               apenas de um ??o procedimento.

    */

    CURSOR c_Conta_Mvto_Amb(Pcd_Pedrx NUMBER, Pcd_Itpedrx NUMBER -- PDA 159898

    , Pcd_Pro_Fat VARCHAR2, Ncdformula NUMBER -- PDa 159898

    ) IS

      SELECT DISTINCT Cd_Atendimento,

                      Cd_Reg_Amb,

                      Cd_Lancamento,

                      Qt_Lancamento /* pda 141006 */

        FROM Dbamv.Itreg_Amb

       WHERE /*tp_mvto = 'Imagem'*/ -- PDA 159898

       Itreg_Amb.Tp_Mvto = Decode(Ncdformula, NULL, 'Imagem', 'Kit-Exame') -- PDA 159898

      --                   AND cd_mvto               = pcd_pedrx                          -- PDA 159898

       AND Cd_Mvto = Decode(Ncdformula, NULL, Pcd_Pedrx, Pcd_Itpedrx) -- PDA 159898

       AND Cd_Pro_Fat = Pcd_Pro_Fat

       AND Nvl(Sn_Fechada, 'N') = 'N'

       AND ((Itreg_Amb.Cd_Itmvto = Pcd_Itpedrx AND Ncdformula IS NULL) OR

       Ncdformula IS NOT NULL);

    /*AND ROWNUM < 2;*/

    /*PDA.: 272669 - (fim)*/

    CURSOR c_Ped IS

      SELECT Ped_Rx.Hr_Pedido

        FROM Dbamv.Ped_Rx

       WHERE Ped_Rx.Cd_Ped_Rx = Ncdpedrx;

    --PDA 99802 09/07/2004 Sp?ola (INICIO)

    --Cursor para coletar dados de atendimento ambulatorial por sess?para o atendimento pai

    CURSOR Catendsessao(Pncdatedimento IN NUMBER --N??o do atendimento de sessao filho

    ) IS

      SELECT Nvl(Atendime_Sessao.Sn_Retorno, 'N') Sn_Retorno,

             Nvl(Atendime.Qt_Sessoes, 0) Qt_Sessoes,

             Atendime_Sessao.Dt_Atendimento Dt_Atendimento

        FROM Dbamv.Atendime Atendime,

             Dbamv.Atendime Atendime_Sessao

       WHERE Atendime_Sessao.Cd_Atendimento = Pncdatedimento

         AND Atendime_Sessao.Cd_Atendimento_Pai = Atendime.Cd_Atendimento

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    -- PDA 113300 - HENRIQUE ANTUNES - PRESTADOR AGENDA

    CURSOR c_Prestador(Pncdatedimento IN NUMBER) IS

      SELECT Escala_Dia.Cd_Prestador

        FROM Dbamv.Escala_Dia,

             Dbamv.It_Escala_Dia

       WHERE It_Escala_Dia.Cd_Atendimento = Pncdatedimento

         AND It_Escala_Dia.Cd_Escala_Dia = Escala_Dia.Cd_Escala_Dia;

    /*PDA 162744 - 24/10/06 - Jo?Paulo F. Ferraz - Comentado para corre?.

    -- PDA 147693 Inicio

    cursor chosp is

      Select cd_hospital

        From dbamv.hospital

       Where cd_multi_empresa = Dbamv.pkg_mv2000.le_empresa;



    cursor cPrestAtend (nCdPedRx number) is

      Select atendime.cd_prestador

        From dbamv.ped_rx

           , dbamv.atendime

       Where ped_rx.cd_atendimento = atendime.cd_atendimento

         And ped_rx.cd_ped_rx      = nCdPedRx

         and atendime.cd_multi_empresa = dbamv.Pkg_Mv2000.Le_Empresa;

    -- PDA 147693 Fim*/

    -- OP 1784     Replica? PDA  483828

    CURSOR Ccontaanteriorintegracao(Pncdatendimento IN NUMBER) IS

      SELECT DISTINCT Reg_Amb.Cd_Reg_Amb

        FROM Dbamv.Tiss_Guia,

             Dbamv.Reg_Amb

       WHERE Tiss_Guia.Cd_Reg_Amb IS NOT NULL

         AND Tiss_Guia.Cd_Reg_Amb = Reg_Amb.Cd_Reg_Amb

         AND Tiss_Guia.Cd_Atendimento = Pncdatendimento

         AND NOT EXISTS

       (SELECT 'X'

                FROM Dbamv.Itreg_Amb

               WHERE Reg_Amb.Cd_Reg_Amb = Itreg_Amb.Cd_Reg_Amb);

    --PDA 418754/410457(inicio)

    CURSOR Cpedidopsdiintpagu(Pncdpremed Dbamv.Pre_Med.Cd_Pre_Med%TYPE, Pnsetor Dbamv.Exa_Set.Cd_Set_Exa%TYPE) IS

      SELECT Itpre_Med.Cd_Set_Exa

        FROM Dbamv.Itpre_Med,

             Dbamv.Tip_Presc,

             Dbamv.Exa_Rx,

             Dbamv.Exa_Set,

             Dbamv.Set_Exa_Padrao

       WHERE Itpre_Med.Cd_Pre_Med = Pncdpremed

         AND Itpre_Med.Cd_Tip_Presc = Tip_Presc.Cd_Tip_Presc

         AND Itpre_Med.Cd_Tip_Esq = 'CAR'

         AND Tip_Presc.Cd_Tip_Esq = 'CAR'

         AND Tip_Presc.Cd_Exa_Rx = Exa_Rx.Cd_Exa_Rx

         AND Exa_Rx.Cd_Exa_Rx = Exa_Set.Cd_Exa_Rx

         AND Exa_Set.Cd_Set_Exa = Pnsetor

         AND Set_Exa_Padrao.Cd_Set_Exa = Pnsetor

         AND Set_Exa_Padrao.Cd_Tip_Esq = Tip_Presc.Cd_Tip_Esq;

    Nsetexapedido Ped_Rx.Cd_Set_Exa%TYPE;

    --PDA 418754/410457(fim)



     /*OP 41394*/

          CURSOR cProced(pProFat IN VARCHAR2) IS

         SELECT pro_fat.cd_gru_pro

           FROM dbamv.pro_fat

          WHERE pro_fat.cd_pro_fat = pProFat;





      CURSOR cRregra(pConvenio IN NUMBER ,

                     pPlano IN NUMBER) IS

        SELECT p.cd_regra

        FROM dbamv.empresa_con_pla p,

            dbamv.empresa_convenio c

        WHERE p.cd_convenio = c.cd_convenio

          AND p.cd_con_pla  = pPlano

          AND c.cd_convenio = pConvenio

          AND c.cd_multi_empresa = DBAMV.PKG_MV2000.LE_EMPRESA;

      /*OP 41394*/



    Vcatendsessao Catendsessao%ROWTYPE;

    --PDA 99802 (FIM)

    Prod_Nao_Conf EXCEPTION;

    Auditoria_In_Loco EXCEPTION;

    Setor_Nao_Conf EXCEPTION;

    Proc_Sem_Preco EXCEPTION;

    Atend_Sem_Conta EXCEPTION;

    Proc_Proibido EXCEPTION;

	proc_proibido_idade   exception;  -- OP 32555

    Fora_Da_Conta EXCEPTION;

    v_Config     c_Config%ROWTYPE;

    v_Proced     c_Proced%ROWTYPE;

    v_Mvto       c_Mvto%ROWTYPE;

    v_Particular c_Config_Particular%ROWTYPE;

    --PDA 157595(INICIO) 14/04/2008 - Jansen Gallindo

    --v_conta              dbamv.pack_lanca_ffcv.c_conta%ROWTYPE;

    v_Conta Dbamv.Pkg_Ffcv_Conta.Tpconta;

    --v_contaambu          dbamv.pack_lanca_ffcv.c_contaambu%ROWTYPE;

    v_Contaambu Dbamv.Pkg_Ffcv_Conta.Tpcontaambu;

    --v_contapartambu      dbamv.pack_lanca_ffcv.c_contapartambu%ROWTYPE;

    v_Contapartambu Dbamv.Pkg_Ffcv_Conta.Tpcontapartambu;

    --v_contapart          dbamv.pack_lanca_ffcv.c_contapart%ROWTYPE;

    --PDA 157595(FIM) 14/04/2008 - Jansen Gallindo

    v_Itregfat Dbamv.Pack_Lanca_Ffcv.c_Itregfat%ROWTYPE;

    v_Itregamb Dbamv.Pack_Lanca_Ffcv.c_Itregamb%ROWTYPE;

    v_Forapre  Dbamv.Pack_Lanca_Ffcv.c_Forapre%ROWTYPE;

    v_forapreatimed dbamv.pack_lanca_ffcv.c_forapreatimed%rowtype; -- op 38143

    vccdatimed      varchar2(2); -- op 38143

    -- pda 96511 - 23/06/2004 - Amalia Ara??

    Vcgabaritohosp   Dbamv.Pack_Lanca_Ffcv.Cgabaritohosp%ROWTYPE;

    Vcitgabaritohosp Dbamv.Pack_Lanca_Ffcv.Citgabaritohosp%ROWTYPE;

    Vcquantgabarito  Dbamv.Pack_Lanca_Ffcv.Cquantgabarito%ROWTYPE;

    -- pda 96511 - fim

    Nqtprofat          Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Ndiferenca         NUMBER;

    Ncdlcto            Dbamv.Itreg_Fat.Cd_Lancamento%TYPE /*number pda 254997*/

    ;

    Csnpacote          VARCHAR2(1);

    Binsert            BOOLEAN;

    Bequipe            BOOLEAN DEFAULT FALSE;

    Ctpproibicao       VARCHAR2(2);

    Ncdgrufat          NUMBER;

    Nqtautorizado      NUMBER;

    Ncdguia            NUMBER;

    Bpartic            BOOLEAN := FALSE;

    Ncdregfat          Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/

    ;

    Nprestador         NUMBER;

    Nprestadorequip    NUMBER;

    Nqtregrateio       NUMBER;

    Ncdlfa             NUMBER;

    Bexclui            BOOLEAN := FALSE;

    Ncdsetorexa        NUMBER;

    Ncdregamb          Dbamv.Reg_Amb.Cd_Reg_Amb%TYPE /*number pda 254997*/

    ;

    Csnpgconv          VARCHAR2(1);

    Ctppgto            VARCHAR2(1);

    Ncdconvconta       NUMBER;

    Ncdplanconta       Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*number pda 254997*/

    ;

    Hrlancamento       DATE;

    Csnhoresp          VARCHAR2(1);

    Ntpvinculo         VARCHAR2(1);

    Ccdatimed          VARCHAR2(2);

    Nqtpart            Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Nprestagenda       NUMBER;

    Nqtconv            Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Nqtlivre           NUMBER;

    v_Qtdexistente_Amb NUMBER;

    v_Qtdexistente_Fat NUMBER;

    Totallancado       NUMBER;

    Limite             NUMBER := 0;

    Cmensret           VARCHAR2(2000);

    Bexistepreco       BOOLEAN := TRUE;

    -- PDA 96161 -- Alexandre Erik C. M. Costa 25/05/2004

    -- Declara? de vari?is

    Nqtdguia      NUMBER;

    Nguiapendente Dbamv.Guia.Cd_Guia%TYPE; -- pda 145435 - 23/03/2006 - Jose Roberto

    /*PDA 162744 - 24/10/06 - Jo?Paulo F. Ferraz - Comentado para corre?.

      -- PDA 147693 Inicio

    vCdhospital         dbamv.hospital.cd_hospital%type;

    nCdPrestAtend       dbamv.atendime.cd_prestador%type := null;

    -- PDA 147693 Fim*/

    Ncdguiaitem Dbamv.Guia.Cd_Guia%TYPE; /* pda 141006 */

    -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

    Ncdconta  Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE;

    Ncdpacote Dbamv.Conta_Pacote.Cd_Conta_Pacote%TYPE;

    Csnguia   VARCHAR2(1) := 'N';

    -- PDA 157145 (Fim)

    -- PDA 159898 Inicio

    Npedrx NUMBER := Ncdpedrx;

    Nitnrx NUMBER := Ncditpedrx;

    Vmeio  VARCHAR2(10) := 'Imagem';

    -- PDA 159898 Fim

    Vsnchecapreconolcto VARCHAR2(01); -- PDA 175957 - 16/03/2007 - Pedro Neiva(Apply)

    Ncdlctoupdate       Dbamv.Itreg_Fat.Cd_Lancamento%TYPE /*number pda 254997*/

    ; -- PDA 189031 Inicio/Fim

    Ddthraux            DATE; -- PDA 221500 - 27/03/2008 - Diego Costa

    v_Fator             c_Fator%ROWTYPE; /* pda 545011 */

    Ncdunipro           Dbamv.Uni_Pro.Cd_Uni_Pro%TYPE := NULL; /* pda 545011 */

    Nqtexcedeu          NUMBER := NULL; -- OP 387

    Vtpcontapart        Dbamv.Itreg_Fat.Tp_Mvto%TYPE := NULL; -- OP 387

    Nconta              NUMBER := NULL; -- OP 387

    Nlanc               NUMBER := NULL; -- OP 387

	  vcentralizada       varchar2(1); /*OP 28704*/

    vTemRegraCriaContaAuto BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnCriouContaAuto      BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnCriouContaAutoAmb   BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vRegraCriaContaAuto    Dbamv.Pkg_Ffcv_Conta.TpContaAutomatica; /*OP 35916 - regra para cria? autom?ca de conta*/

    vRegraCriaContaAutoHE    Dbamv.Pkg_Ffcv_Conta.TpContaAutomatica; /*OP 41394*/

    vSnReplicaProcHe dbamv.pack_lanca_ffcv.cSnReplicaProcHe%ROWTYPE; /*OP 41394*/

    vSnReplicaProc   VARCHAR2(1);                                    /*OP 41394*/

    vRregra cRregra%ROWTYPE;                                         /*OP 41394*/

    vNlsBanco VARCHAR2(50);                                          /*OP 41394*/

    vProced   cProced%ROWTYPE;                                       /*OP 41394*/

    v_ContaCargoPac        Dbamv.Pkg_Ffcv_Conta.Tpconta;     /*ALLS OP 42241 */

    v_ContaCargoPacAmbu    Dbamv.Pkg_Ffcv_Conta.Tpcontaambu; /*ALLS OP 42241 */

    vRegraCriaContaAutoCP  Dbamv.Pkg_Ffcv_Conta.TpContaAutomaticaCP; /*ALLS OP 42241* - regra para cria? autom?ca de conta referente a Cargo Paciente*/

    vSnCargoPaciente       Dbamv.Pack_Lanca_Ffcv.cSnCargoPaciente%ROWTYPE; /*ALLS OP 42241*/

    vSnCriouContaAutoCP    BOOLEAN := FALSE; /*ALLS OP 42241 */

    vSnCriouContaAutoAmbCP BOOLEAN := FALSE; /*ALLS OP 42241 */

    NcdlctoCp              NUMBER  ; /*ALLS OP 42241 */

    NcdlctoAmbCp           NUMBER  ; /*ALLS OP 42241 */

    pEmpresa               NUMBER := Pkg_Mv2000.Le_Empresa;/*43289*/

    pvSnJaExcedeuQtd      Varchar2(1):= 'N'; /*43289*/

    pvMensagem             VARCHAR2(2000);    /*43289*/

    pSnChamadoDaTela       VARCHAR2(1) := 'N';       /*43289*/

    nRegraSubstituicao     NUMBER := NULL;    /*OP 44895*/





  BEGIN

    -- PDA 159898 Inicio

    IF Ncditemformula IS NOT NULL THEN

      -- PDA 183020 - 27/03/2007 - FL?IO LAGO: ncdItemformula is null

      Npedrx := Ncditpedrx;

      Nitnrx := Ncditemformula;

      Vmeio  := 'Kit-Exame';

    END IF;

    -- PDA 159898 Fim

    IF Ddtrealizold IS NULL AND Ddtrealiznew IS NOT NULL THEN

      Bexclui := FALSE;

      Binsert := TRUE;

    ELSIF Ddtrealizold IS NOT NULL AND Ddtrealiznew IS NULL THEN

      Bexclui := TRUE;

      Binsert := FALSE;

    ELSE

      RETURN;

    END IF;

    /* pda 326214 - 25/11/2009 - Amalia Ara??

    Caso a rotina seja chamada pela tela de laudos, e o tipo de atendimento

    esteja configurado no PSDI para lan? direto pelo pedido, ent? o laudo

    n?deve mais alterar a conta. */

    IF Dbamv.Pkg_Mv2000.Le_Cliente = 970 AND

       Dbamv.Pkg_Mv2000.Le_Formulario = 'M_LAU_EXA' THEN

      DECLARE

        CURSOR Cconfirmasolicpsdi IS

          SELECT Sn_Confirma_Exa_Internacao,

                 Sn_Confirma_Exa_Urgencia,

                 Sn_Confirma_Exa_Busca_Ativa,

                 Sn_Confirma_Exa_Ambulatorio,

                 Sn_Confirma_Exa_Externo,

                 Sn_Confirma_Exa_Home_Care

            FROM Dbamv.Config_Psdi

           WHERE Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

        CURSOR Catendped IS

          SELECT a.Tp_Atendimento

            FROM Dbamv.Atendime a,

                 Dbamv.Ped_Rx   p

           WHERE p.Cd_Atendimento = a.Cd_Atendimento

             AND p.Cd_Ped_Rx = Ncdpedrx;

        Vconfirmasolicpsdi Cconfirmasolicpsdi%ROWTYPE;

        Vtpatend           VARCHAR2(1);

      BEGIN

        OPEN Catendped;

        FETCH Catendped

          INTO Vtpatend;

        CLOSE Catendped;

        OPEN Cconfirmasolicpsdi;

        FETCH Cconfirmasolicpsdi

          INTO Vconfirmasolicpsdi;

        CLOSE Cconfirmasolicpsdi;

        IF ((Vconfirmasolicpsdi.Sn_Confirma_Exa_Internacao = 'S' AND

           Vtpatend IN ('I', 'H')) OR (Vconfirmasolicpsdi.Sn_Confirma_Exa_Urgencia = 'S' AND

           Vtpatend IN ('U')) OR (Vconfirmasolicpsdi.Sn_Confirma_Exa_Busca_Ativa = 'S' AND

           Vtpatend IN ('B')) OR (Vconfirmasolicpsdi.Sn_Confirma_Exa_Ambulatorio = 'S' AND

           Vtpatend IN ('A')) OR (Vconfirmasolicpsdi.Sn_Confirma_Exa_Externo = 'S' AND

           Vtpatend IN ('E')) OR (Vconfirmasolicpsdi.Sn_Confirma_Exa_Home_Care = 'S' AND

           Vtpatend IN ('H'))) THEN

          RETURN;

        END IF;

      END;

    END IF;

    /* pda 326214 - fim */

    OPEN c_Config;

    FETCH c_Config

      INTO v_Config;

    CLOSE c_Config;

    IF Nvl(v_Config.Sn_Psdi_Pedido, 'N') = 'S' THEN

      OPEN c_Ped;

      FETCH c_Ped

        INTO Hrlancamento;

      CLOSE c_Ped;

    END IF;

    --    PDA 159898 Inicio

    --    OPEN  c_proced;

    --    FETCH c_proced INTO v_proced;

    --    CLOSE c_proced;

    IF Ncditemformula IS NULL THEN

      OPEN c_Proced;

      FETCH c_Proced

        INTO v_Proced;

      CLOSE c_Proced;

    ELSE

      OPEN Ckitimagem(Ncditemformula);

      FETCH Ckitimagem

        INTO v_Proced;

      CLOSE Ckitimagem;

      Ncdunipro := v_Proced.Cd_Uni_Pro; /* pda 545011 - atirbuindo unidade */

    END IF;

    --    PDA 159898 Fim

    OPEN c_Mvto;

    FETCH c_Mvto

      INTO v_Mvto;

    CLOSE c_Mvto;

    -- PDA 234089 (In?o) - 13/06/2008 - Henrique Antunes

    IF Binsert AND Nvl(v_Config.Sn_Psdi_Pedido, 'N') = 'S' THEN

      IF Trunc(Ddtrealiznew) = Trunc(v_Mvto.Dt_Atendimento) AND

         To_Char(v_Mvto.Dt_Atendimento, 'hh24mi') >

         To_Char(Nvl(Hrlancamento, Ddtrealiznew), 'hh24mi') THEN

        Hrlancamento := v_Mvto.Dt_Atendimento;

      END IF;

      IF Trunc(Ddtrealiznew) = Trunc(v_Mvto.Dt_Alta) AND

         To_Char(v_Mvto.Dt_Alta, 'hh24mi') <

         To_Char(Nvl(Hrlancamento, Ddtrealiznew), 'hh24mi') THEN

        Hrlancamento := v_Mvto.Dt_Alta;

      END IF;

    END IF;

    -- PDA 234089 (Fim)

    -- pda 254202(Incio) - Pedro Neiva - 15/10/2008

    -- Compara a data de referncia com a data de atendimento, se a data de referncia for menor,

    -- ento utiliza a data de atendimento, para evitar item lanados fora da conta.

    -- PDA 263291 (Inicio) - 06/12/2008 - Diego Costa

    -- dDthrAux := to_date(to_char(v_mvto.dt_pedido, 'DD/MM/YYYY') || ' ' || to_char(nvl(v_mvto.hr_pedido, v_mvto.dt_pedido), 'HH24:MI:SS'), 'DD/MM/YYYY HH24:MI:SS');

    -- PDA 543660 (Inicio)

    DECLARE

      CURSOR Cconfig IS

        SELECT Sn_Psdi_Pedido

          FROM Dbamv.Config_Ffcv

         WHERE Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

      Vcconfig VARCHAR2(1);

    BEGIN

      OPEN Cconfig;

      FETCH Cconfig

        INTO Vcconfig;

      CLOSE Cconfig;

      IF Vcconfig = 'N' THEN

        Ddthraux := Nvl(v_Mvto.Dt_Laudo,v_Mvto.Dt_Pedido);  -- OP 17884 - 28/03/2014 - nvl para quando n?houver data de laudo

      ELSE

        Ddthraux := v_Mvto.Dt_Pedido;

        -- PDA 263291 (Fim)

      END IF;

    END;

    -- PDA 543660 (Fim)

    IF Ddthraux < v_Mvto.Dt_Atendimento THEN

      Ddthraux := v_Mvto.Dt_Atendimento;

    END IF;

    IF Ddthraux > v_Mvto.Dt_Alta THEN

      Ddthraux := v_Mvto.Dt_Alta;

    END IF;

    -- pda 254202(Fim)



    vProFatAnterior     := v_Proced.Cd_Pro_Fat;   -- OP 33697 *2



    /*OP 44895*/

    vRregra := NULL;

    OPEN cRregra(v_Mvto.Cd_Convenio,v_Mvto.cd_con_pla);

    FETCH cRregra INTO vRregra;

    CLOSE cRregra;



    -- PDA 174061 (Inicio) - Henrique Antunes - 07/06/2007

    /* pda 361853 - 14/04/2010 - Amalia Ara??- Henrique n?se recorda de porque tem esta condi? para chamar a rotina de substitui?,

                   e autorizou retirar. Na chamada da LANCA_PSDI_FFCV na trigger da ITPED_RX, este par?tro sempre vem nulo.

    if ncdItemformula is not null then */

    nRegraSubstituicao := NULL;

    v_Proced.Cd_Pro_Fat := Fnc_Substituicao_Procedimento(Dbamv.Pkg_Mv2000.Le_Empresa,

                                                         Nvl(v_Mvto.Cd_Setor_Set_Exa,

                                                             v_Mvto.Cd_Setor),

                                                         v_Proced.Cd_Pro_Fat,

                                                         Ddtrealiznew,

                                                         v_Mvto.Tp_Atendimento,

                                                         'S',

                                                         v_Mvto.Cd_Convenio,    /*OP 28803*/

                                                         nRegraSubstituicao,    /*OP 44895*/

                                                         v_Mvto.cd_con_pla,     /*OP 44895*/

                                                         vRregra.cd_regra       /*OP 44895*/

                                                         );

    /* end if;

    pda 361853 - fim */

    -- PDA 174061 Fim



	-- OP 32555 - 27/09/2015 - verifica? de proibi? por Idade. Retorna OK caso n?haja proibi?, e mensagem para o alert caso haja.

	if dbamv.fnc_ffcv_proibicao_idade( v_mvto.cd_atendimento, v_mvto.cd_convenio, v_mvto.cd_con_pla, v_proced.cd_pro_fat ) <> 'OK' then

	  raise proc_proibido_idade;

	end if;

	-- OP 32555 - fim



	  -- OP 33697 *2 - 08/10/2015 - Buscando as demais informa?s do produto, caso o procedimento tenha sido substituido pela Regra de substitui?.

	  --    ?ecess?o porque mais abaixo faz busca do grupo de faturamento pela classe, Esp?e e setor.

	  if v_Proced.Cd_Pro_Fat <> vProFatAnterior then

        v_Proced.Cd_Produto := null;

        v_Proced.Cd_Gru_Fat := null;

        v_Proced.Cd_Gru_Pro := null;

        v_Proced.Cd_Exa_Rx := null;

        v_Proced.Nr_Auxiliar := null;

        v_Proced.Cd_Por_Ane := null;

        v_Proced.Vl_Fator_Pro_Fat := null;

        v_Proced.Cd_Uni_Pro := null;

	    open  cProcedProFat( v_Proced.Cd_Pro_Fat );

		fetch cProcedProFat into v_Proced;

		close cProcedProFat;

	  end if;

	  -- OP 33697 - fim



    -- PDA 106102 -- Alexandre Erik C. M. Costa -- 13/09/2004

    -- Passar como par?tro o c??o do procedimento concatenado ao c??o da multi-empresa.

/*  OP 38292 (Inicio)

    OPEN Dbamv.Pack_Lanca_Ffcv.c_Proibicao(v_Proced.Cd_Pro_Fat || '@' ||

                                           v_Mvto.Cd_Multi_Empresa,

                                           v_Mvto.Cd_Convenio,

                                           v_Mvto.Cd_Con_Pla,

                                           v_Mvto.Tp_Atendimento,

                                           Ddtrealiznew,

                                           v_Mvto.Cd_Setor);

    FETCH Dbamv.Pack_Lanca_Ffcv.c_Proibicao

      INTO Ctpproibicao;

    CLOSE Dbamv.Pack_Lanca_Ffcv.c_Proibicao;

  */



    Ctpproibicao := dbamv.pack_ffcv_proibicao.fnc_ffcv_proibicao(v_Proced.Cd_Pro_Fat || '@' ||

                                             v_Mvto.Cd_Multi_Empresa,

                                             v_Mvto.Cd_Convenio,

                                             v_Mvto.Cd_Con_Pla,

                                             v_Mvto.Tp_Atendimento,

                                             Ddtrealiznew,

                                             v_Mvto.Cd_Setor,

                                                 v_mvto.cd_atendimento,

                                                 NULL);

      -- OP 38292 (Fim)



    IF Ctpproibicao = 'FC' THEN

      RAISE Fora_Da_Conta;

    END IF;

    IF v_Mvto.Tp_Atendimento IN ('A', 'E', 'U') AND

       v_Mvto.Sn_Importa_Auto = 'S' AND NOT Bexclui THEN

      Raise_Application_Error(-20040

                              --MULTI-IDIOMA: Utiliza? do pkg_rmi_traducao.extrair_msg para mensagens (MSG_1)

                             ,

                              Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_1',

                                                                'PACK_LANCA_FFCV',

                                                                'A Conta deste atendimento est?loqueada! A movimenta? da mesma dever?er lan?a para o atendimento de interna? %s',

                                                                Arg_List(v_Mvto.Cd_Atendimento_Pai)));

    END IF;

    --PDA 175957 (In?o) 16/03/2007 - Pedro Neiva (Apply)

    Vsnchecapreconolcto := Dbamv.Fnc_Ffcv_Verifica_Preco_Lcto(v_Mvto.Tp_Atendimento);

    -- PDA 187015 (Inicio) - Henrique Antunes - 14/05/2007

    IF Nvl(Vsnchecapreconolcto, 'N') = 'S' AND NOT Bexclui AND Nvl(Pkg_Mv2000.Le_Configuracao('FFCV', 'SN_CREDENCIADO_CENTAVOS'), 'N') = 'N' THEN



      Bexistepreco := Dbamv.Val_Proc_Ffcv_Resumido(v_Proced.Cd_Pro_Fat ||



                                                   v_Mvto.Cd_Setor -- PDA 194962 - Pedro Neiva - 23/08/2007

                                                  ,

                                                   v_Mvto.Dt_Pedido,

                                                   v_Mvto.Hr_Pedido,

                                                   v_Mvto.Cd_Convenio,

                                                   v_Mvto.Cd_Con_Pla,

                                                   v_Mvto.Tp_Atendimento,

                                                   v_Mvto.Cd_Tip_Acom,

                                                   Cmensret,

                                                   'Imagem',

                                                   Ncdexarx);

      IF Bexistepreco = FALSE THEN

        Raise_Application_Error(-20050, Cmensret);

      END IF;

    END IF;

    IF Bexclui THEN

      IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') OR

         v_Mvto.Sn_Importa_Auto = 'S' THEN

        --         PDA 156270 (Inicio) Marcelo Berenguer

        DECLARE

          Vqtd NUMBER;

        BEGIN

          OPEN Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco(Ncdregfat,

                                                      Ddtrealiznew,

                                                      Nvl(Hrlancamento,

                                                          Ddtrealiznew));

          FETCH Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco

            INTO Vqtd;

          CLOSE Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco;

          IF Nvl(Vqtd, 0) <> 0 THEN

            RAISE Auditoria_In_Loco;

          END IF;

        END;

        --         PDA 156270 (Inicio) Marcelo Berenguer

        --

        --         FOR c IN c_conta_mvto_hosp (ncdpedrx, v_proced.cd_pro_fat ) LOOP            -- PDA 159898

        FOR c IN c_Conta_Mvto_Hosp(Ncdpedrx,

                                   Ncditpedrx -- PDA 159898

                                  ,

                                   v_Proced.Cd_Pro_Fat,

                                   Ncditemformula) -- PDA 159898

        LOOP

          IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(c.Cd_Reg_Fat,

                                                        c.Cd_Lancamento,

                                                        'E') THEN

            IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(c.Cd_Reg_Fat,

                                                          c.Cd_Lancamento,

                                                          'E') THEN

              Verif_Franquia_Hosp(c.Cd_Reg_Fat, c.Cd_Lancamento, 'E');

            END IF;

          END IF;

          -- PDA 159898 (Inicio) - Henrique Antunes - 10/05/2007

          DELETE FROM Dbamv.Itreg_Fat

           WHERE (Cd_Lancamento_Pai, Cd_Reg_Fat_Pai) IN

                 (SELECT Cd_Lancamento,

                         Cd_Reg_Fat

                    FROM Dbamv.Itreg_Fat

                   WHERE Cd_Lancamento_Rel IS NOT NULL

                     AND Cd_Reg_Fat = c.Cd_Reg_Fat);

          -- PDA 159898 (Fim)

          DELETE FROM Dbamv.Itreg_Fat

           WHERE Cd_Reg_Fat = c.Cd_Reg_Fat

             AND Cd_Lancamento_Rel = c.Cd_Lancamento

             AND Cd_Reg_Fat_Rel = c.Cd_Reg_Fat;

          -- pda 548231/384821 - 17/10/2012 - Amalia Ara??- exclus?do pacote da conta, caso o item seja de pacote.

          Dbamv.Pkg_Ffcv_It_Conta.Prc_Remove_Pacote_Lanc_Auto(c.Cd_Atendimento,

                                                              c.Cd_Reg_Fat,

                                                              c.Cd_Lancamento);

          -- pda 548231/384821 - fim

          -- PDA 159898 (Inicio) - Henrique Antunes - 10/05/2007

          DELETE FROM Dbamv.Itreg_Fat

           WHERE Cd_Lancamento_Pai = c.Cd_Lancamento

             AND Cd_Reg_Fat_Pai = c.Cd_Reg_Fat;

          -- PDA 159898 (Fim)

          -- OP 684 - 13/12/2013 - corrigindo local de abertura do cursor, antes de deletar o registro na itreg_fat

          Ncdguiaitem := NULL;

          OPEN Dbamv.Pkg_Ffcv_Guia.Cguianoitem(c.Cd_Reg_Fat,

                                               c.Cd_Atendimento,

                                               c.Cd_Lancamento);

          FETCH Dbamv.Pkg_Ffcv_Guia.Cguianoitem

            INTO Ncdguiaitem;

          CLOSE Dbamv.Pkg_Ffcv_Guia.Cguianoitem;

          DELETE FROM Dbamv.Itreg_Fat

           WHERE Cd_Reg_Fat = c.Cd_Reg_Fat

             AND Cd_Lancamento = c.Cd_Lancamento;

          /* PDA 288525 - 05/06/2009 - In?o - Fabr?o Oliveira de Miranda

          A chamada desta procedure estava ocorrendo antes de apagar o item da conta e podia

          ocorrer erro caso a guia fosse deletada sem deletar o item da conta antes. */

          IF Ncdguiaitem IS NOT NULL THEN

					  -- OP 18042 - 01/04/2014 - passando texto concatenado no pro_fat para identificar que ?a rotina de lan?ento autom?co

            Dbamv.Pkg_Ffcv_Guia.Prc_Retirar_Item_Guia(Ncdguiaitem,

                                                      v_Proced.Cd_Pro_Fat||'LANCA_PSDI_FFCV',

                                                      c.Qt_Lancamento);

          END IF;

          /* PDA 288525 - 05/06/2009 - Fim - Fabr?o Oliveira de Miranda */

        END LOOP;

        --

      ELSE

        --

        --         FOR c IN c_conta_mvto_amb (ncdpedrx, v_proced.cd_pro_fat ) LOOP                 -- PDA 159898

        FOR c IN c_Conta_Mvto_Amb(Ncdpedrx,

                                  Ncditpedrx -- PDA 159898

                                 ,

                                  v_Proced.Cd_Pro_Fat,

                                  Ncditemformula)

        LOOP

          -- PDA 159898

          --

          -- PDA 197953 (In?o) - 08/08/2007 - Diego Costa

          -- inclus?de verifica? a regra de atendimento pro_fat antes da regra de acoplamaneto

          IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Ambu(c.Cd_Reg_Amb,

                                                        c.Cd_Lancamento,

                                                        'E') THEN

            IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Ambu(c.Cd_Reg_Amb,

                                                          c.Cd_Lancamento,

                                                          'E') THEN

              --

              Verif_Franquia_Ambu(c.Cd_Reg_Amb, c.Cd_Lancamento, 'E');

              --

            END IF;

          END IF;

          -- PDA 197953 (Fim)

          --

          -- PDA 159898 (Inicio) - Henrique Antunes - 10/05/2007

          DELETE FROM Dbamv.Itreg_Amb

           WHERE (Cd_Lancamento_Pai, Cd_Reg_Amb_Pai) IN

                 (SELECT Cd_Lancamento,

                         Cd_Reg_Amb

                    FROM Dbamv.Itreg_Amb

                   WHERE Cd_Lancamento_Rel IS NOT NULL

                     AND Cd_Reg_Amb = c.Cd_Reg_Amb

                     AND Cd_Atendimento = c.Cd_Atendimento);

          -- PDA 159898 (Fim)

          -- pda 137698 inicio (excluir os itens relacionados)

          DELETE FROM Dbamv.Itreg_Amb

           WHERE Cd_Reg_Amb_Rel = c.Cd_Reg_Amb

             AND Cd_Lancamento_Rel = c.Cd_Lancamento

             AND Cd_Atendimento = c.Cd_Atendimento

             AND sn_fechada = 'N';

          -- pda 137698 fim

          -- pda 548231/384821 - 17/10/2012 - Amalia Ara??- exclus?do pacote da conta, caso o item seja de pacote.

          Dbamv.Pkg_Ffcv_It_Conta.Prc_Remove_Pacote_Lanc_Auto(c.Cd_Atendimento,

                                                              c.Cd_Reg_Amb,

                                                              c.Cd_Lancamento);

          -- pda 548231/384821 - fim

          -- PDA 159898 (Inicio) - Henrique Antunes - 10/05/2007

          DELETE FROM Dbamv.Itreg_Amb

           WHERE Cd_Lancamento_Pai = c.Cd_Lancamento

             AND Cd_Reg_Amb_Pai = c.Cd_Reg_Amb

             AND Cd_Atendimento = c.Cd_Atendimento;

          -- PDA 159898 (Fim)

          --

          /* pda 141006 - 06/06/2006 - Amalia Ara??

          Identificando a guia do item. Caso encontre e a mesma ainda esteja Pendente.

          Retirando o item da guia, caso haja e a guia ainda esteja Pendente.          */

          -- OP 684 - 13/12/2013 - corrigindo local de abertura do cursor, antes de deletar o registro na itreg_fat

          Ncdguiaitem := NULL;

          OPEN Dbamv.Pkg_Ffcv_Guia.Cguianoitem(c.Cd_Reg_Amb,

                                               c.Cd_Atendimento,

                                               c.Cd_Lancamento);

          FETCH Dbamv.Pkg_Ffcv_Guia.Cguianoitem

            INTO Ncdguiaitem;

          CLOSE Dbamv.Pkg_Ffcv_Guia.Cguianoitem;

          --

          DELETE FROM Dbamv.Itreg_Amb

           WHERE Cd_Reg_Amb = c.Cd_Reg_Amb

             AND Cd_Lancamento = c.Cd_Lancamento

             AND Cd_Atendimento = c.Cd_Atendimento;

          --

          /* PDA 288525 - 05/06/2009 - In?o - Fabr?o Oliveira de Miranda

          A chamada desta procedure estava ocorrendo antes de apagar o item da conta e podia

          ocorrer erro caso a guia fosse deletada sem deletar o item da conta antes. */

          IF Ncdguiaitem IS NOT NULL THEN

					  -- OP 18042 - 01/04/2014 - passando texto concatenado no pro_fat para identificar que ?a rotina de lan?ento autom?co

            Dbamv.Pkg_Ffcv_Guia.Prc_Retirar_Item_Guia(Ncdguiaitem,

                                                      v_Proced.Cd_Pro_Fat||'LANCA_PSDI_FFCV',

                                                      c.Qt_Lancamento);

          END IF;

          /* pda 141006 - fim */

        /* PDA 288525 - 05/06/2009 - Fim - Fabr?o Oliveira de Miranda */

        END LOOP;

        --

      END IF;

      --

      BEGIN

        DELETE Dbamv.Log_Falha_Importacao

         WHERE Cd_Mvto_Falha = Ncdpedrx

           AND Cd_Item_Falha = Ncditpedrx;

      END;

    ELSE

      IF (v_Proced.Cd_Por_Ane IS NOT NULL) OR

         (Nvl(v_Proced.Nr_Auxiliar, 0) > 0) THEN

        Bequipe := TRUE;

      END IF;

      OPEN c_Config_Particular;

      FETCH c_Config_Particular

        INTO v_Particular;

      CLOSE c_Config_Particular;

      IF (v_Mvto.Tp_Atendimento <> 'S') AND

         ((v_Mvto.Tp_Atendimento IN ('H', 'I') AND

         Nvl(v_Config.Sn_Raiox_Automatica, 'S') IN ('H', 'S')) OR

         (v_Mvto.Tp_Atendimento IN ('A', 'E', 'U') AND

         Nvl(v_Config.Sn_Raiox_Automatica, 'S') IN ('A', 'S'))) THEN

        IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

          --PDA 157595(INICIO) 14/04/2008 - Jansen Gallindo

          /*OPEN dbamv.pack_lanca_ffcv.c_conta (v_mvto.cd_atendimento

                                             ,ddtrealiznew

                                             ,v_mvto.cd_convenio

                                             ,v_mvto.cd_atendimento_pai

                                             );

          FETCH dbamv.pack_lanca_ffcv.c_conta INTO v_conta;

          CLOSE dbamv.pack_lanca_ffcv.c_conta;*/

          /*OP 35916 - regra para cria? autom?ca de conta*/

          vSnReplicaProc := NULL;      /*OP 41394*/

          vTemRegraCriaContaAuto  := Dbamv.Pkg_Ffcv_Conta.FNC_TEM_REG_CRIA_CONTA_AUTO;

          IF (vTemRegraCriaContaAuto) THEN



                    /*ALLS OP 42241*/

                    OPEN dbamv.pack_lanca_ffcv.cSnCargoPaciente(v_Mvto.Cd_Atendimento);

                    FETCH dbamv.pack_lanca_ffcv.cSnCargoPaciente INTO vSnCargoPaciente;

					          CLOSE dbamv.pack_lanca_ffcv.cSnCargoPaciente;



					          IF Nvl(vSnCargoPaciente.sn_carga_familiar,'N') = 'S' THEN



                        vRegraCriaContaAutoCP := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTCP(v_Mvto.Cd_Atendimento,

                                                                                                     v_Proced.Cd_Pro_Fat,

                                                                                                     Ddthraux); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAutoCP(1).cd_regra_cria_conta IS NOT NULL ) THEN



                            v_ContaCargoPac :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_HOSP_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                                 null,

                                                                                                 v_Mvto.Cd_Atendimento,

                                                                                                 v_Mvto.Cd_Atendimento_Pai,

                                                                                                 vRegraCriaContaAutoCP(1).cd_convenio_destino,

                                                                                                 vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                                                                                                 Ddthraux,

                                                                                                 vRegraCriaContaAutoCP(1).cd_tipo_arq_cta_envio,

                                                                                                 vRegraCriaContaAutoCP(1).cd_desconto_inst); /*ALLS OP 35921*/

                            vSnCriouContaAutoCP := TRUE;

                        END IF;

                    /*fim ALLS OP 42241*/

                    ELSE

						vRegraCriaContaAuto := Dbamv.Pkg_Ffcv_Conta.FNC_VERIFIC_REG_CRIA_CONTA_AUT(v_Mvto.Cd_Atendimento,

                                                                                                   v_Proced.Cd_Pro_Fat,

                                                                                                   Ddthraux); --FATURCONV-1383 - AMBS

                        IF (vRegraCriaContaAuto(1).cd_regra_cria_conta IS NOT NULL ) THEN



                            v_Conta :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_HOSP_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                         null,

                                                                                         v_Mvto.Cd_Atendimento,

                                                                                         v_Mvto.Cd_Atendimento_Pai,

                                                                                         vRegraCriaContaAuto(1).cd_convenio_destino,

                                                                                         vRegraCriaContaAuto(1).cd_con_pla_destino,

                                                                                         Ddthraux,

                                                                                         vRegraCriaContaAuto(1).cd_tipo_arq_cta_envio,

                                                                                         vRegraCriaContaAuto(1).cd_desconto_inst); /*ALLS OP 35921*/

                            vSnCriouContaAuto := TRUE;

                        END IF;



                        /*OP 41394*/

                        vRegraCriaContaAutoHE := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTHE(v_Mvto.Cd_Atendimento,v_Proced.Cd_Pro_Fat,Ddthraux); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAutoHE(1).cd_regra_cria_conta IS NOT NULL ) THEN

                          vSnReplicaProc := 'S';

                        END IF;

                        /*OP 41394*/



                    END IF;



          END IF;



          IF (NOT vSnCriouContaAuto) THEN

          /*OP 35916 - regra para cria? autom?ca de conta*/

             v_Conta := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Conta(v_Mvto.Cd_Atendimento

                                                            --pda 254202(In?o) - 15/10/2008

                                                            --,ddtrealiznew

                                                           ,

                                                            Ddthraux

                                                            --pda 254202(Fim) - 15/10/2008

                                                           ,

                                                            v_Mvto.Cd_Convenio,

                                                            v_Mvto.Cd_Atendimento_Pai);

           END IF;/*OP 35916*/



          --IF v_conta.cd_reg_fat IS NULL THEN

          IF v_Conta(1).Cd_Reg_Fat IS NULL THEN

            --PDA 157595(FIM) 14/04/2008 - Jansen Gallindo

            IF v_Mvto.Cd_Convenio_Secundario IS NOT NULL THEN

              Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Verifica_Conta_Secundaria(v_Mvto.Cd_Atendimento

                                                                              --pda 254202(In?o) - 15/10/2008

                                                                              --,ddtrealiznew

                                                                             ,

                                                                              Ddthraux

                                                                              --pda 254202(Fim) - 15/10/2008

                                                                             ,

                                                                              v_Mvto.Cd_Convenio_Secundario,

                                                                              v_Mvto.Cd_Atendimento_Pai);

              Ncdconvconta := v_Mvto.Cd_Convenio_Secundario;

              Ncdplanconta := v_Mvto.Cd_Con_Pla_Secundario;

              IF Ncdregfat IS NULL THEN

                RAISE Atend_Sem_Conta;

              END IF;

            ELSE

              IF v_Mvto.Tp_Convenio = 'P' THEN

                Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento

                                                                             --pda 254202(In?o) - 15/10/2008

                                                                             --,ddtrealiznew

                                                                            ,

                                                                             Ddthraux

                                                                             --pda 254202(Fim) - 15/10/2008

                                                                             ); -- pda 125871(acrescentada a data)

                Ncdconvconta := v_Mvto.Cd_Convenio;

                Ncdplanconta := v_Mvto.Cd_Con_Pla;

              ELSE

                RAISE Atend_Sem_Conta;

              END IF;

            END IF;

          ELSE

            Ncdregfat    := v_Conta(1).Cd_Reg_Fat; --ncdregfat := v_conta.cd_reg_fat; --PDA 157595

            Ncdconvconta := v_Conta(1).Cd_Convenio; --ncdconvconta := v_conta.cd_convenio; --PDA 157595

            Ncdplanconta := v_Conta(1).Cd_Con_Pla; --ncdplanconta := v_conta.cd_con_pla; --PDA 157595

          END IF;

        ELSE

          --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

          /*OPEN dbamv.pack_lanca_ffcv.c_contaambu (v_mvto.cd_atendimento

                                                 ,ddtrealiznew

                                                 ,v_mvto.cd_convenio

                                                 ,v_mvto.cd_atendimento_pai

                                                 );

          FETCH dbamv.pack_lanca_ffcv.c_contaambu INTO v_contaambu;

          CLOSE dbamv.pack_lanca_ffcv.c_contaambu;*/

          /*OP 35916 - regra para cria? autom?ca de conta*/

          vSnReplicaProc := NULL;      /*OP 41394*/

          vTemRegraCriaContaAuto  := Dbamv.Pkg_Ffcv_Conta.FNC_TEM_REG_CRIA_CONTA_AUTO;

          IF (vTemRegraCriaContaAuto) THEN



                    /*ALLS OP 42241*/

                    OPEN dbamv.pack_lanca_ffcv.cSnCargoPaciente(v_Mvto.Cd_Atendimento);

                    FETCH dbamv.pack_lanca_ffcv.cSnCargoPaciente INTO vSnCargoPaciente;

					          CLOSE dbamv.pack_lanca_ffcv.cSnCargoPaciente;



					          IF Nvl(vSnCargoPaciente.sn_carga_familiar,'N') = 'S' THEN



                        vRegraCriaContaAutoCP := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTCP(v_Mvto.Cd_Atendimento,

                                                                                                     v_Proced.Cd_Pro_Fat,

                                                                                                     Ddtrealiznew); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAutoCP(1).cd_regra_cria_conta IS NOT NULL ) THEN



                            v_ContaCargoPacAmbu :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_AMB_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                                    null,

                                                                                                    v_Mvto.Cd_Atendimento,

                                                                                                    v_Mvto.Cd_Atendimento_Pai,

                                                                                                    vRegraCriaContaAutoCP(1).cd_convenio_destino,

                                                                                                    vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                                                                                                    Ddtrealiznew,

                                                                                                    vRegraCriaContaAutoCP(1).cd_tipo_arq_cta_envio,

                                                                                                    vRegraCriaContaAutoCP(1).cd_desconto_inst); /*ALLS OP 35921*/

                            vSnCriouContaAutoAmbCP := TRUE;

                        END IF;

                    /*fim ALLS OP 42241*/

                    ELSE



                        vRegraCriaContaAuto := Dbamv.Pkg_Ffcv_Conta.FNC_VERIFIC_REG_CRIA_CONTA_AUT(v_Mvto.Cd_Atendimento,

                                                                                                   v_Proced.Cd_Pro_Fat,

                                                                                                   Ddtrealiznew); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAuto(1).cd_regra_cria_conta IS NOT NULL)  THEN



                            v_Contaambu :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_AMB_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                            null,

                                                                                            v_Mvto.Cd_Atendimento,

                                                                                            v_Mvto.Cd_Atendimento_Pai,

                                                                                            vRegraCriaContaAuto(1).cd_convenio_destino,

                                                                                            vRegraCriaContaAuto(1).cd_con_pla_destino,

                                                                                            Ddtrealiznew,

                                                                                            vRegraCriaContaAuto(1).cd_tipo_arq_cta_envio,

                                                                                            vRegraCriaContaAuto(1).cd_desconto_inst); /*ALLS OP 35921*/

                            vSnCriouContaAutoAmb := TRUE;

                        END IF;



                        /*OP 41394*/

                        vRegraCriaContaAutoHE := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTHE(v_Mvto.Cd_Atendimento,v_Proced.Cd_Pro_Fat,Ddtrealiznew); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAutoHE(1).cd_regra_cria_conta IS NOT NULL ) THEN

                          vSnReplicaProc := 'S';

                        END IF;

                        /*OP 41394*/



                    END IF;



          END IF;



          IF (NOT vSnCriouContaAutoAmb) THEN

          /*OP 35916 - regra para cria? autom?ca de conta*/

             v_Contaambu := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Ccontaambu(v_Mvto.Cd_Atendimento,

                                                                     Ddtrealiznew,

                                                                     v_Mvto.Cd_Convenio,

                                                                     v_Mvto.Cd_Atendimento_Pai);

          END IF;/*OP 35916*/



          --IF NVL (v_contaambu.sn_fechada, 'N') = 'S' THEN

          IF Nvl(v_Contaambu(1).Sn_Fechada, 'N') = 'S' THEN

            --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

            RAISE Atend_Sem_Conta;

          END IF;

          --IF v_contaambu.cd_reg_amb IS NULL THEN --PDA 157595

          IF v_Contaambu(1).Cd_Reg_Amb IS NULL THEN

            --PDA 157595

            IF v_Mvto.Tp_Convenio = 'P' THEN

              Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(v_Mvto.Cd_Atendimento);

            ELSE

              /* PDA 483828 (In?o) - 04/01/2012 - Diego Costa - O HMD possui uma integra? que altera o item do

              * pedido de imagem Ap?? lan?ento na conta. Com isso a trigger trg_lanca_psdi_ffcv remove o item

              * original e insere o novo item.

              * Ao fazer essa a? para atendimentos de externo, onde a itreg_amb S??ssui um item, e ao utilizar a

              * a configura? de um atendimento por lote, a rotina n?reutiliza o c??o da primeira reg_amb gerada.

              * Com isso era gerada uma nova reg_amb, mudando o N??o da senha na guia que havia sido assinada pelo

              * paciente.

              * para corrigir o problema, na inser? ser?ealizada uma busca pelo N??o da conta original. Se for

              * localizada ela ser?tilizada para reinserir o tiem de pedido.

              */

              -- OP 1784 - altera? na rotina do PDA 483828 para que seja realizado este processos para todos os clientes.

              OPEN Ccontaanteriorintegracao(v_Mvto.Cd_Atendimento);

              FETCH Ccontaanteriorintegracao

                INTO Ncdregamb;

              CLOSE Ccontaanteriorintegracao;

              IF Ncdregamb IS NULL THEN

                Ncdregamb := Dbamv.Pack_Ffcv.Cria_Conta_Acoplamentoambu(v_Mvto.Cd_Atendimento,

                                                                        'N');

              END IF;

              -- PDA 483828 (Fim)

            END IF;

            Ncdconvconta := v_Mvto.Cd_Convenio;

            Ncdplanconta := v_Mvto.Cd_Con_Pla;

          ELSE

            Ncdregamb    := v_Contaambu(1).Cd_Reg_Amb; --ncdregamb := v_contaambu.cd_reg_amb; --PDA 157595

            Ncdconvconta := v_Contaambu(1).Cd_Convenio; --ncdconvconta := v_contaambu.cd_convenio;--PDA 157595

            Ncdplanconta := v_Contaambu(1).Cd_Con_Pla; --ncdplanconta := v_contaambu.cd_con_pla;--PDA 157595

          END IF;

          IF Ncdregamb IS NULL THEN

            RAISE Atend_Sem_Conta;

          END IF;

        END IF;

        IF v_Proced.Cd_Pro_Fat IS NULL THEN

          RAISE Prod_Nao_Conf;

        END IF;

        OPEN c_Grfasetorexame(v_Proced.Cd_Gru_Pro, v_Mvto.Cd_Setor);

        FETCH c_Grfasetorexame

          INTO Ncdgrufat;

        CLOSE c_Grfasetorexame;

        IF Ncdgrufat IS NULL THEN

          Ncdgrufat := v_Proced.Cd_Gru_Fat;

        END IF;

		    -- OP 33697 *2 - Usar o grupo de faturamento do procedimento de substitui?.

		    if v_Proced.Cd_Pro_Fat <> vProFatAnterior and Ncdgrufat is null then

			    open  cGruProSub( v_Proced.Cd_Pro_Fat );

			    fetch cGruProSub into Ncdgrufat;

			    close cGruProSub;

		    end if;

        IF Ncdgrufat IS NULL THEN

          RAISE Setor_Nao_Conf;

        END IF;

        IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

          OPEN Dbamv.Pack_Lanca_Ffcv.c_Forapre(Ncdconvconta, Ncdgrufat);

          FETCH Dbamv.Pack_Lanca_Ffcv.c_Forapre

            INTO v_Forapre;

          CLOSE Dbamv.Pack_Lanca_Ffcv.c_Forapre;

        ELSE

          OPEN Dbamv.Pack_Lanca_Ffcv.c_Forapre(Ncdconvconta, Ncdgrufat);

          FETCH Dbamv.Pack_Lanca_Ffcv.c_Forapre

            INTO v_Forapre;

          CLOSE Dbamv.Pack_Lanca_Ffcv.c_Forapre;

        END IF;

        IF v_Forapre.Sn_Prestador = 'S' OR Bequipe THEN



		-- OP 41079 - verificar se vai utilizar a configura? do cadastro de parametros do FFCV

		IF v_Mvto.TP_ORIGEM_PREST_FAT = 'G' THEN

          -- PDA 147693 (Inicio) - Henrique Antunes - 16/05/2006

          --IF NVL (v_config.tp_prestador_psdi, 'S') = 'L' AND NVL (v_mvto.cd_prest_lau, nrcdprestador) IS NOT NULL THEN

          -- PDA 168353 (Inicio) - Henrique Antunes - 29/01/2007

          --IF NVL (v_config.tp_prestador_psdi, 'S') in ('A','L') AND NVL (v_mvto.cd_prest_lau, nrcdprestador) IS NOT NULL THEN

          IF Nvl(v_Config.Tp_Prestador_Psdi, 'S') IN ('A', 'L') AND

             Nrcdprestador IS NOT NULL THEN

            -- PDA 168353 (Fim)

            -- PDA 147693 (Fim)

            --PDA 418754/410457(inicio)

            IF Pkg_Mv2000.Le_Cliente = 420 THEN

              --Exame com origem de uma prescri?

              IF v_Mvto.Cd_Pre_Med IS NOT NULL THEN

                OPEN Cpedidopsdiintpagu(v_Mvto.Cd_Pre_Med,

                                        v_Mvto.Cd_Set_Exa);

                FETCH Cpedidopsdiintpagu

                  INTO Nsetexapedido;

                CLOSE Cpedidopsdiintpagu;

                IF Nsetexapedido IS NOT NULL THEN

                  Nprestador      := v_Mvto.Cd_Prest_Set;

                  Nprestadorequip := v_Mvto.Cd_Prest_Set;

                ELSE

                  Nprestador      := Nrcdprestador;

                  Nprestadorequip := Nrcdprestador;

                END IF;

              ELSE

                Nprestador      := Nrcdprestador;

                Nprestadorequip := Nrcdprestador;

              END IF;

            ELSE

              --PDA 418754/410457(fim)

              -- PDA 168353 (Inicio) - Henrique Antunes - 29/01/2007

              --nprestador := NVL (v_mvto.cd_prest_lau, nrcdprestador);

              --nprestadorequip := NVL (v_mvto.cd_prest_lau, nrcdprestador);

              Nprestador      := Nrcdprestador;

              Nprestadorequip := Nrcdprestador;

              -- PDA 168353 (Fim)

            END IF;

          ELSE

            -- PDA 147693 (Inicio) - Henrique Antunes - 16/05/2006

            --nprestador := v_mvto.cd_prest_set;

            --nprestadorequip := v_mvto.cd_prest_set;

            IF Nvl(v_Config.Tp_Prestador_Psdi, 'S') = 'A' THEN

              OPEN c_Prestador(v_Mvto.Cd_Atendimento);

              FETCH c_Prestador

                INTO Nprestagenda;

              CLOSE c_Prestador;

              Nprestador      := Nvl(Nprestagenda, v_Mvto.Cd_Prest_Set);

              Nprestadorequip := Nvl(Nprestagenda, v_Mvto.Cd_Prest_Set);

            ELSE

              Nprestador      := v_Mvto.Cd_Prest_Set;

              Nprestadorequip := v_Mvto.Cd_Prest_Set;

            END IF;

            -- PDA 147693 (Fim)

          END IF;

          -- PDA 147693 (Inicio) - Henrique Antunes - 16/05/2006

          -- PDA 113300 - HENRIQUE ANTUNES - PRESTADOR AGENDA

          /*IF NVL (v_config.tp_prestador_psdi, 'S') = 'A' THEN

             OPEN c_prestador (v_mvto.cd_atendimento);

             FETCH c_prestador INTO nprestagenda;

             CLOSE c_prestador;



             IF nprestagenda IS NOT NULL THEN

                nprestador := nprestagenda;

                nprestadorequip := nprestagenda;

             ELSE

                nprestador := v_mvto.cd_prest_set;

                nprestadorequip := v_mvto.cd_prest_set;

             END IF;

          END IF;*/

          -- PDA 147693 (Fim)

		  ELSE -- OP 41079 - Inicio  - if v_Mvto.TP_ORIGEM_PREST_FAT = 'G' then



			  IF v_Mvto.TP_ORIGEM_PREST_FAT = 'L' THEN  -- Laudo

				  nprestador := NVL (v_mvto.Cd_Prest_Lau, v_mvto.Cd_Prest_Set);

          Nprestadorequip:= NVL (v_mvto.Cd_Prest_Lau, v_mvto.Cd_Prest_Set); -- OP 48486

			  ELSIF v_Mvto.TP_ORIGEM_PREST_FAT = 'S' THEN  -- Solicitante

				  nprestador :=  Nvl(v_mvto.cd_prestador_soli,v_mvto.Cd_Prest_Set);

          Nprestadorequip :=  Nvl(v_mvto.cd_prestador_soli,v_mvto.Cd_Prest_Set);       -- OP 48486

			  ELSIF v_Mvto.TP_ORIGEM_PREST_FAT = 'T' THEN --  Setor

				    nprestador:= v_mvto.Cd_Prest_Set;

            Nprestadorequip := v_mvto.Cd_Prest_Set; -- OP 48486

			  END IF;



		  END IF; -- OP 41079 - Fim

          Ccdatimed := v_Config.Cd_Ati_Med_Clinico;

        ELSE

          Nprestador := NULL;

          Ccdatimed  := NULL;

        END IF;

        -- PDA 147693 Inicio

        /*Open chosp;

        Fetch chosp into vCdhospital;

        Close chosp;

        If vCdhospital = '970' Then

          Open cPrestAtend(ncdpedrx);

          Fetch cPrestAtend into nCdPrestAtend;

          Close cPrestAtend;

          If nCdPrestAtend is not null Then

            nprestador := nCdPrestAtend;

          End if;

        End if;*/

        -- PDA 147693 Fim

        IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

          IF Nprestador IS NOT NULL THEN

            -- PDA 100970(inicio) 26/07/2006 Thiago Holder Marcos Silva

            -- Chamada da fun? dbamv.pkg_ffcv_it_conta.fnc_retorna_tp_pagamento();

            -- Esta fun? tamb?verifica se o prestador credenciado tem alguma exce?

            -- cadastrada, caso tenha, o tipo de pagamento ser? - Produ?.

            --

            --

            --   OPEN dbamv.pack_lanca_ffcv.c_prescon (nprestador, ncdconvconta);

            --   FETCH dbamv.pack_lanca_ffcv.c_prescon INTO csnpgconv;

            --   CLOSE dbamv.pack_lanca_ffcv.c_prescon;

            --   IF NVL (csnpgconv, 'N') = 'S' THEN

            --      ctppgto := 'C';

            --   ELSE

            --      ctppgto := 'P';

            --   END IF;

            Ctppgto := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Retorna_Tp_Pagamento(Nprestador,

                                                                        Ncdconvconta,

                                                                        v_Mvto.Tp_Atendimento,

                                                                        v_Proced.Cd_Pro_Fat,

                                                                        v_Mvto.Cd_Ori_Ate

                                                                        -- PDA 166691 (Inicio) - Henrique Antunes - 28/11/2006

                                                                       ,

                                                                        Ddtrealiznew,

                                                                        Nvl(Hrlancamento,

                                                                            Ddtrealiznew)

                                                                        -- PDA 166691 (Fim)

                                                                        );

          ELSE

            Ctppgto := NULL; -- pda 104455 desfazer o que foi feito no pda 84408 ('P'  ;-- ( pda 84408  setado de null p/ 'P' ))

          END IF;

        ELSE

          IF Nprestador IS NOT NULL THEN

            --      OPEN dbamv.pack_lanca_ffcv.c_prescon (nprestador, ncdconvconta);

            --      FETCH dbamv.pack_lanca_ffcv.c_prescon INTO csnpgconv;

            --      CLOSE dbamv.pack_lanca_ffcv.c_prescon;

            --      IF NVL (csnpgconv, 'N') = 'S' THEN

            --         ctppgto := 'C';

            --      ELSE

            --         ctppgto := 'P';

            --      END IF;

            Ctppgto := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Retorna_Tp_Pagamento(Nprestador,

                                                                        Ncdconvconta,

                                                                        v_Mvto.Tp_Atendimento,

                                                                        v_Proced.Cd_Pro_Fat,

                                                                        v_Mvto.Cd_Ori_Ate

                                                                        -- PDA 166691 (Inicio) - Henrique Antunes - 28/11/2006

                                                                       ,

                                                                        Ddtrealiznew,

                                                                        Nvl(Hrlancamento,

                                                                            Ddtrealiznew)

                                                                        -- PDA 166691 (Fim)

																		--FATURCONV-1726 INI

																		,Ncdplanconta

																		,vRregra.cd_regra

																		,v_Proced.Cd_Gru_Pro

																		--FATURCONV-1726 FIM

                                                                        );

          ELSE

            Ctppgto := NULL; -- 'P'; -- ( pda 84408  setado de null p/ 'P') -- pda 104455 desfazer o que foi feito no pda 84408

          END IF;

        END IF;

        -- PDA 187015 (Inicio) - Henrique Antunes - 14/05/2007

        IF Nvl(Vsnchecapreconolcto, 'N') = 'S' AND NOT Bexclui AND

           Nvl(Ctppgto, 'P') <> 'C' AND

           Nvl(Pkg_Mv2000.Le_Configuracao('FFCV', 'SN_CREDENCIADO_CENTAVOS'),

               'N') = 'S' THEN

          Bexistepreco := Dbamv.Val_Proc_Ffcv_Resumido(v_Proced.Cd_Pro_Fat ||

                                                       v_Mvto.Cd_Setor -- PDA 194962 - Pedro Neiva - 23/08/2007

                                                      ,

                                                       v_Mvto.Dt_Pedido,

                                                       v_Mvto.Hr_Pedido,

                                                       v_Mvto.Cd_Convenio,

                                                       v_Mvto.Cd_Con_Pla,

                                                       v_Mvto.Tp_Atendimento,

                                                       v_Mvto.Cd_Tip_Acom,

                                                       Cmensret,

                                                       'Imagem',

                                                       Ncdexarx);

          IF Bexistepreco = FALSE THEN

            Raise_Application_Error(-20050, Cmensret);

          END IF;

        END IF;

        -- PDA 187015 (Fim

        -- IF nprestador IS NOT NULL AND ctppgto = 'P' THEN

        --    SELECT tp_vinculo

        --      INTO ntpvinculo

        --      FROM dbamv.prestador

        --     WHERE cd_prestador = nprestador;

        --    IF ntpvinculo = 'U' THEN

        --       ctppgto := 'F';

        --    END IF;

        -- END IF;

        -- PDA 100970(Fim)

        IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

          IF Ctpproibicao = 'NA' THEN

            Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento

                                                                         -- pda 254202(In?o) - Pedro Neiva - 15/10/2008

                                                                         --,ddtrealiznew

                                                                        ,

                                                                         Ddthraux

                                                                         -- pda 254202(Fim) - 15/10/2008

                                                                         ); -- pda 125871 (acrescentada a data)

            Ncdconvconta := v_Config.Cd_Convenio_Fat_Extra;

            Ncdplanconta := v_Config.Cd_Con_Pla_Fat_Extra;

            IF Ncdregfat IS NULL THEN

              RAISE Proc_Proibido;

            END IF;

          END IF;

        ELSE

          IF Ctpproibicao = 'NA' THEN

            IF v_Config.Tp_Controle_Lote = 'A' THEN

              --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

              /*OPEN dbamv.pack_lanca_ffcv.c_contapartambu (v_mvto.cd_atendimento, ddtrealiznew);

              FETCH dbamv.pack_lanca_ffcv.c_contapartambu INTO v_contapartambu;

              CLOSE dbamv.pack_lanca_ffcv.c_contapartambu;*/

              v_Contapartambu := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Ccontapartambu(v_Mvto.Cd_Atendimento,

                                                                                 Ddtrealiznew);

              --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

            ELSE

              --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

              /*OPEN dbamv.pack_lanca_ffcv.c_contapartambu_loteunico (v_mvto.cd_atendimento, ddtrealiznew);

              FETCH dbamv.pack_lanca_ffcv.c_contapartambu_loteunico INTO v_contapartambu;

              CLOSE dbamv.pack_lanca_ffcv.c_contapartambu_loteunico;*/

              v_Contapartambu := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Contpartambulotun(v_Mvto.Cd_Atendimento,

                                                                                    Ddtrealiznew);

              --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

            END IF;

            Ncdconvconta := v_Config.Cd_Convenio_Fat_Extra;

            Ncdplanconta := v_Config.Cd_Con_Pla_Fat_Extra;

            --IF v_contapartambu.cd_reg_amb IS NULL THEN --PDA 157595

            IF v_Contapartambu(1).Cd_Reg_Amb IS NULL THEN

              --PDA 157595

              Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(v_Mvto.Cd_Atendimento);

              IF Ncdregamb IS NULL THEN

                RAISE Atend_Sem_Conta;

              END IF;

            ELSE

              --ncdregamb := v_contapartambu.cd_reg_amb; --PDA 157595

              Ncdregamb := v_Contapartambu(1).Cd_Reg_Amb; --PDA 157595

            END IF;

          END IF;

        END IF;

        Nqtprofat := Nvl(Nrfaturado, 1);

        -- PDA 174061 (Inicio) - Henrique Antunes - 07/06/2007

        IF Ncditemformula IS NOT NULL THEN

          /* pda 545011 - Verificando o fator da unidade utilizada, igual como ?eito no MGES, para os Kit-Exame. */

          OPEN c_Fator(Ncdunipro);

          FETCH c_Fator

            INTO v_Fator;

          CLOSE c_Fator;

          Nqtprofat := Fnc_Substituicao_Proced_Fator(Dbamv.Pkg_Mv2000.Le_Empresa,

                                                     Nvl(v_Mvto.Cd_Setor_Set_Exa,

                                                         v_Mvto.Cd_Setor),

                                                     v_Proced.Cd_Pro_Fat,

                                                     Ddtrealiznew,

                                                     v_Mvto.Tp_Atendimento,

                                                     'S',

                                                     Nqtprofat,

                                                      v_Mvto.Cd_Convenio,  /*OP 28803*/

                                                      v_mvto.cd_con_pla,   /*OP 44895*/

                                                      To_Number(NULL)      /*OP 44895*/

                                                      );



		    -- Erro divisor por zero

			IF Nvl(v_Proced.Vl_Fator_Pro_Fat,0) = 0 THEN

              v_Proced.Vl_Fator_Pro_Fat := 1 ;

            END IF ;

            Nqtprofat := Trunc((Nqtprofat * Nvl(v_Fator.Vl_Fator, 1)) / v_Proced.Vl_Fator_Pro_Fat);



        END IF;

        -- PDA 174061 Fim

        /* pda 145435 - 23/03/2006 - Jose Roberto                      (*)

        Alterando a verifica? da guia, retirando os cursores c_qtdexistente_amb e

        c_qtdexistente_fat para utilizar a nova fun? FNC_RETORNA_GUIA_DISPONIVEL;

        Retiradas as verifica?s nos cursores c_guia, c_itguia e c_itguia_proc_auto;

        Retirado o uso das vari?is totallancado e nqtautorizado;

        Caso NCDGUIA for Nulo, chamando a fun? F_GRAVA_GUIA, alterando o terceiro

        par?tro para nqtprofat;

        Retirado todo o c?ulo feito para atribuir valor as vari?is nqtpart,

        nqtconv e limite;

        Caso retorne uma Guia dispon?l, atribu?a ?ari?l NCDGUIA.         */

        /*PDA 374303 - 25/06/2010 - Juliana Vieira

        Replicando mesma altera? do PDA 312488, por?para outros lan?entos autom?cos.

        na chamada da fun? que retorna se tem uma guia dispon?l, passar sempre o codigo do atendimento

        pai caso tiver, pois o sistma pode criar atendimentos de recem nascido onde n?existe conta para ele e n??ecess?o

        crioar guias para os atendimentos filhos.*/

        IF Ctpproibicao = 'AG'

		     or Nvl(Pkg_Mv2000.Le_Configuracao('FFCV', 'SN_CRIA_GUIA_PED_RX_CENTRALIZADA_SEM_PROIB'),    /*OP 28704*/

           'N') = 'S'

		   THEN   /*JGDO*/



		  /*OP 28704*/

		  vcentralizada := null;

		  if Nvl(Pkg_Mv2000.Le_Configuracao('FFCV', 'SN_CRIA_GUIA_PED_RX_CENTRALIZADA_SEM_PROIB'), 'N') = 'S' then

		     vcentralizada := '#';

		  end if;

		  /*OP 28704*/

		   -- OP 40186- Crirar guia por procedimento

           if Nvl(dbamv.pkg_mv2000.Le_Configuracao('FFCV','SN_AUTORIZACAO_LCTO_AUTO'),'N') = 'S'  then

          		Ncdguia := null ;

        	else

          	Ncdguia := Dbamv.Pkg_Ffcv_Guia.Fnc_Retorna_Guia_Disponivel(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                         v_Mvto.Cd_Atendimento),

                                                                     Nvl(Ncdregfat,

                                                                         Ncdregamb),

                                                                     NULL,

                                                                     v_Proced.Cd_Pro_Fat,

                                                                     Nqtprofat,

                                                                     NULL,

                                                                     vcentralizada,  /*OP 28704*/

                                                                     Nguiapendente);



           		vcentralizada := null;	 /*OP 28704*/

           end if ;

          IF Nvl(v_Config.Sn_Guia_Proc_Auto, 'N') = 'S' THEN

            IF Ncdguia IS NULL THEN

              Ncdguia := Dbamv.f_Grava_Guia(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                v_Mvto.Cd_Atendimento),

                                            v_Mvto.Cd_Convenio,

                                            Nqtprofat,

                                            v_Proced.Cd_Pro_Fat,

                                            'P');

            END IF;

            Nqtpart := 0;

            Nqtconv := Nqtprofat;

            Limite  := 0;

            /* pda 164822 - 28/09/2006 - Amalia Ara??

               Comentado para n?lan? procedimento com proibi? AG em conta particular.

            else

              nQtPart := nQtProFat;

              nQtConv := 0;

              limite  := 1;

            pda 164822 - fim       */

          END IF;

        END IF;

        -- pda 145435 (Fim)

        -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

        IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

          Ncdconta := Ncdregfat;

        ELSE

          Ncdconta := Ncdregamb;

        END IF;

        IF Ctpproibicao = 'AG' THEN

          Csnguia := 'S';

        END IF;

        -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

        -- Prepara? da data que ser?assada na fun?.

        -- A data preparada ir?onter al?da data de lan?ento, a hora de lan?ento.

        Ddthraux := To_Date(To_Char(Ddtrealiznew, 'DD/MM/YYYY') || ' ' ||

                            To_Char(Nvl(Hrlancamento, Ddtrealiznew),

                                    'HH24:MI:SS'),

                            'DD/MM/YYYY HH24:MI:SS');

        -- PDA 221500 (Fim)

        /* pda 363842 - 12/05/2010 - Amalia Ara??- Acertar se a data/hora acima estiver fora do atendimento */

        IF Ddthraux < v_Mvto.Dt_Atendimento THEN

          Ddthraux := v_Mvto.Dt_Atendimento;

        END IF;

        IF Ddthraux > v_Mvto.Dt_Alta THEN

          Ddthraux := v_Mvto.Dt_Alta;

        END IF;

        /* pda 363842 - fim */

        /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

        nQtExcedeu a vari?l retorna justamente a quantidade de procedimentos que deve ser lan?o no procedimento

        que pertence ao pacote, em seguida deve ser inserdio um outro procedimento com o que restou do lan?ento*/

        Nqtexcedeu := NULL;

        --

        /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

        vTpContaPart a vari?l retorna justamente se o procedimento vai ser inserido em uma conta particular ou ira seguir

        o processo normalmente.*/

        Ncdpacote := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Gera_Pacote(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                 v_Mvto.Cd_Atendimento),

                                                             v_Mvto.Tp_Atendimento,

                                                             Ncdconvconta -- ,v_mvto.cd_convenio OP  6182

                                                            ,

                                                             Ncdplanconta -- ,v_mvto.cd_con_pla OP 6182

                                                            ,

                                                             Ncdconta,

                                                             Ncdgrufat,

                                                             v_Proced.Cd_Pro_Fat,

                                                             v_Mvto.Cd_Setor --,NVL (v_mvto.cd_setor_set_exa, v_mvto.cd_setor)   --PDA 386451  -- OP 5615 - 26/03/2013

                                                            ,

                                                             Nprestador

                                                             -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

                                                             -- ,nvl(ddtrealiznew,sysdate)

                                                            ,

                                                             Nvl(Ddthraux,

                                                                 SYSDATE)

                                                             -- PDA 221500 (Fim)

                                                            ,

                                                             Ncdpedrx,

                                                             Ncditpedrx,

                                                             'Imagem',

                                                             Csnguia,

                                                             Nqtprofat,

                                                             Csnpacote,

                                                             Nqtexcedeu -- OP 387

                                                            ,

                                                             Vtpcontapart -- OP 387

                                                            ,

                                                             NULL

                                                             -- PDA 225086 (Inicio)

                                                            ,

                                                             v_Mvto.Cd_Atendimento,

                                                             NULL --pCdProFatPacote

                                                            ,

                                                             Ncdlcto --pCdLancamento_pac

                                                            ,

                                                             NULL); --preserva

        -- PDA 225086 (fim)

        /* pda 481126 - depois da FNC_GERA_PACOTE regravando o cd_lancamento_pac */

        IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

          OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncdregfat);

          FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

            INTO Ncdlcto;

          CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

        ELSE

          OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Ncdregamb);

          FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

            INTO Ncdlcto;

          CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;

        END IF;

        --

        IF Ncdpacote IS NOT NULL THEN

          UPDATE Dbamv.Conta_Pacote

             SET Cd_Lancamento_Pac = Ncdlcto

           WHERE Cd_Conta_Pacote = Ncdpacote;

        END IF;

        /* pda 481126 - fim */

        -- PDA 157145 (Inicio)

        IF Dbamv.Pack_Lanca_Ffcv.Is_Hor_Esp(Ncdconvconta,

                                            Ncdplanconta,

                                            v_Mvto.Tp_Atendimento,

                                            Ddtrealiznew

                                            -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

                                            -- ,nvl(ddtrealiznew,sysdate)

                                           ,

                                            Nvl(Ddthraux, SYSDATE)

                                            -- PDA 221500 (Fim)

                                           ,

                                            Ncdgrufat,

                                            v_Proced.Cd_Pro_Fat

                                            -- PDA 119427 11/04/2005 Henrique Antunes (In?o)

                                            -- Passar NULL para o par?tro de regra

                                           ,

                                            NULL

                                            -- PDA 119427 (FIM)

                                           , --PDA 108041 / 108039 121/11/2004 Sp?ola (INICIO)

                                            --Inserido o paremetro cd_prestador / cd_setor para permitir exce?s de convenios e planos por prestador

                                            Nprestador,

                                            v_Mvto.Cd_Setor --PDA 108041 / 108039 (FIM)

                                            ) THEN

          Csnhoresp := 'S';

        ELSE

          Csnhoresp := 'N';

        END IF;

        IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

          -- PDA 123016 (Inicio) - Henrique Antunes - 06/07/2005

          DECLARE

            Vqtd NUMBER;

          BEGIN

            OPEN Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco(Ncdregfat,

                                                        Ddtrealiznew,

                                                        Nvl(Hrlancamento,

                                                            Ddtrealiznew));

            FETCH Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco

              INTO Vqtd;

            CLOSE Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco;

            IF Nvl(Vqtd, 0) <> 0 THEN

              RAISE Auditoria_In_Loco;

            END IF;

          END;

          -- PDA 123016 (Fim)

          IF Bequipe THEN

            Nprestador := NULL;

            Ccdatimed := NULL; -- OP 38143

          END IF;



          IF Limite <> 1 THEN

            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o procedimento que ira ser inserido abaixo pertence a um pacote, e a qunatidade que sera inserida sera menor que a lan?a, a diferen?

            sera lan?a na rotina mais abaixo atravez da procedure PRC_DESVINCULA_PROCEDIMENTO*/

            /* fazendo tratamento caso o procedimento esteja configurado no gabarito para ser inserido dentro de uma conta particular

            caso a variavel vTpContaPart esteja preenchida e a quantidade de lan?ento extra esteja nula. com iso deve ser procurado uma conta particular

            e um lan?ento para inseririr nesta conta.*/

            Nconta := NULL;

            Nlanc  := NULL;



			/*43289 - quebra de conta por quantidade de procedimento por atendimento*/

			/*A regra de pacote tem prioridade sobre essa regra, conforme vari?l Nqtexcedeu abaixo*/

			IF Nqtexcedeu IS NULL THEN

				if (not vSnCriouContaAuto) then /*OP 46768*/

					  IF DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_EXISTE_CONF_QTD_ATEND_PAC(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																						 v_proced.cd_pro_fat,

																						 pEmpresa) THEN



						  Nqtexcedeu := DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_RETORNA_QTD_LANC_PERIODO(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																									   v_proced.cd_pro_fat,

																									   pEmpresa,

																									   ncdregfat,

																									   nvl(nqtconv, nqtprofat),

																									   pSnChamadoDaTela,

																									   pvSnJaExcedeuQtd,

																									   pvMensagem

																									   );

						  IF pvSnJaExcedeuQtd = 'S' THEN

							  Vtpcontapart := 'ProcPorAtend';

							  Nqtexcedeu   := NULL;

						  ELSE

								IF NVL(Nqtexcedeu,0) > 0 THEN

									Vtpcontapart := 'ProcPorAtend';

								END IF;

						  END IF;

					END IF;

				END IF;	/*OP 46768*/

		    END IF;

			/*43289*/



            IF Nvl(Vtpcontapart, 'X') <> 'X' AND Nqtexcedeu IS NULL THEN

              Nconta := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                         v_Mvto.Cd_Atendimento),

                                                                     Ddthraux);

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Nconta);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                INTO Nlanc;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

            END IF;

            INSERT INTO Dbamv.Itreg_Fat

              (Cd_Reg_Fat,

               Cd_Lancamento,

               Dt_Lancamento,

               Hr_Lancamento,

               Qt_Lancamento,

               Cd_Guia,

               Vl_Percentual_Multipla,

               Cd_Gru_Fat,

               Cd_Pro_Fat,

               Sn_Pertence_Pacote,

               Cd_Prestador,

               Cd_Ati_Med,

               Tp_Pagamento,

               Cd_Setor,

               Cd_Setor_Produziu,

               Sn_Horario_Especial,

               Cd_Usuario,

               Cd_Mvto,

               Tp_Mvto,

               Cd_Itmvto

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Cd_Conta_Pacote

               -- PDA 157145 (Fim)

               ,cd_regra_substituicao_proced

               ) -- pda 116108

            VALUES

              (Nvl(Nconta, Ncdregfat) -- OP 387

              ,

               Nvl(Nlanc, Ncdlcto) -- OP 387

              ,

               Ddthraux,

               Ddthraux,

               Nvl(Nqtexcedeu, Nvl(Nqtconv, Nqtprofat)) -- OP 387

              ,

               Ncdguia,

               Nvl(Pcfaturado, 100),

               Ncdgrufat,

               v_Proced.Cd_Pro_Fat,

               Nvl(Csnpacote, 'N'),

               Nprestador,

               Ccdatimed,

               Ctppgto,

               v_Mvto.Cd_Setor,

               Nvl(v_Mvto.Cd_Setor_Set_Exa, v_Mvto.Cd_Setor),

               Csnhoresp,

               USER

               --                            , ncdpedrx                                           -- PDA 159898

               --                            ,'Imagem'                                            -- PDA 159898

               --                            , ncditpedrx                                         -- PDA 159898

              ,

               Decode(Ncditemformula, NULL, Ncdpedrx, Ncditpedrx) -- PDA 159898

              ,

               Nvl(Vtpcontapart,

                   Decode(Ncditemformula, NULL, 'Imagem', 'Kit-Exame')) -- PDA 159898   -- OP 387

              ,

               Nvl(Ncditemformula, Ncditpedrx) -- PDA 159898

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Ncdpacote

               -- PDA 157145 (Fim)

               ,nRegraSubstituicao

               ); -- pda 116108



        /*OP 41394 - replicar horario especial no lan?ento autom?co. Incialmente implementa? pro cliente HOSCAR*/

        IF (nvl(csnhoresp,'N') = 'S'

            AND (NOT vSnCriouContaAuto) /*n??m item de regra de quebra de conta autom?ca*/

            AND vSnReplicaProc = 'S' )  /*tem regra pra replicar proc de hor?o especial*/

            THEN



             OPEN cProced(v_Proced.Cd_Pro_Fat);

             FETCH cProced INTO vProced;

             CLOSE cProced;



             vRregra := NULL;

             OPEN cRregra(Ncdconvconta,Ncdplanconta);

             FETCH cRregra INTO vRregra;

             CLOSE cRregra;



             vNlsBanco := dbamv.FNC_FFCV_FIRST_DAY_SEMANA_BR('S',null);

             OPEN dbamv.pack_lanca_ffcv.cSnReplicaProcHe(vRregra.cd_regra,

                                   vProced.cd_gru_pro,

                                   v_Proced.Cd_Pro_Fat,

                                   TO_NUMBER(TO_CHAR(Ddtrealiznew, 'd')),

                                   Nvl(Ddthraux, SYSDATE),

                                   v_Mvto.Tp_Atendimento);

             FETCH dbamv.pack_lanca_ffcv.cSnReplicaProcHe INTO vSnReplicaProcHe;

             CLOSE dbamv.pack_lanca_ffcv.cSnReplicaProcHe;

             vNlsBanco := dbamv.FNC_FFCV_FIRST_DAY_SEMANA_BR('N',vNlsBanco);



             IF Nvl(vSnReplicaProcHe.sn_replica_proc,'N') = 'S' THEN



                 dbamv.prc_ffcv_replica_proc_he(Nvl(Nconta, Ncdregfat),        -- pCdConta IN NUMBER ,

                                                 Nvl(Nlanc, Ncdlcto) ,          --pCdLancConta IN NUMBER ,

                                                'I',                            --pTpAtend     IN VARCHAR2,

                                                vSnReplicaProcHe.vl_percentual, --pVlPercent   IN NUMBER DEFAULT null,

                                                'N'                             --pSnInsereConta IN VARCHAR2

                                                );



                 dbamv.prc_ffcv_replica_proc_he(nvl(nConta, ncdregfat),

                                            nvl(nlanc,ncdlcto),

                                            'I',

                                            null,

                                            'S');

             END IF;

        END IF;

        /*OP 41394*/





            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

            os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

            IF Nqtexcedeu IS NOT NULL THEN

              Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregfat,

                                                                  Ncdlcto,

                                                                  (Nvl(Nqtconv,

                                                                       Nqtprofat) -

                                                                  Nqtexcedeu),

                                                                  Vtpcontapart,

                                                                  Ddthraux,

																  nvl(v_mvto.cd_atendimento_pai,v_mvto.cd_atendimento)); /*ALLS OP 43289*/

            END IF;

          END IF;

          IF Nvl(Nqtpart, 0) > 0 AND Ctpproibicao = 'AG' THEN

            Ncdregfat := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento,

                                                                      Ddtrealiznew); -- pda 125871(acrescentada a data)

            INSERT INTO Dbamv.Itreg_Fat

              (Cd_Reg_Fat,

               Cd_Lancamento,

               Dt_Lancamento,

               Hr_Lancamento,

               Qt_Lancamento,

               Cd_Guia,

               Vl_Percentual_Multipla,

               Cd_Gru_Fat,

               Cd_Pro_Fat,

               Sn_Pertence_Pacote,

               Cd_Prestador,

               Cd_Ati_Med,

               Tp_Pagamento,

               Cd_Setor,

               Cd_Setor_Produziu,

               Sn_Horario_Especial,

               Cd_Usuario,

               Cd_Mvto,

               Tp_Mvto,

               Cd_Itmvto

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Cd_Conta_Pacote

               -- PDA 157145 (Fim)

               ,cd_regra_substituicao_proced

               ) -- pda 116108

            VALUES

              (Ncdregfat,

               Ncdlcto

               -- pda 254202(In?o) - Pedro Neiva - 15/10/2008

               /*

                           ,ddtrealiznew

                                             ,NVL (hrlancamento, ddtrealiznew)

                           */,

               Ddthraux,

               Ddthraux

               -- pda 254202(Fim) 15/10/2008

              ,

               Nqtpart, --Alterado por Erik Devido a Solicita? para lcto autom?co na CP, trocado por nqtprofat

               Ncdguia,

               Nvl(Pcfaturado, 100),

               Ncdgrufat,

               v_Proced.Cd_Pro_Fat,

               Nvl(Csnpacote, 'N'),

               Nprestador,

               Ccdatimed,

               Ctppgto,

               v_Mvto.Cd_Setor,

               Nvl(v_Mvto.Cd_Setor_Set_Exa, v_Mvto.Cd_Setor),

               Csnhoresp,

               USER

               --                            , ncdpedrx                                           -- PDA 159898

               --                            ,'Imagem'                                            -- PDA 159898

               --                            , ncditpedrx                                         -- PDA 159898

              ,

               Decode(Ncditemformula, NULL, Ncdpedrx, Ncditpedrx) -- PDA 159898

              ,

               Decode(Ncditemformula, NULL, 'Imagem', 'Kit-Exame') -- PDA 159898

              ,

               Nvl(Ncditemformula, Ncditpedrx) -- PDA 159898

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Ncdpacote

               -- PDA 157145 (Fim)

               ,nRegraSubstituicao

               ); -- pda 116108

          END IF;



              /*OP 42241 - Caso tenha criado a conta por cargo paciente, devemos lan? o item para o convenio, plano, percentual definido na configura

              de quebra de conta por cargo paciente*/

              IF (vSnCriouContaAutoCP) THEN

                  vSnCriouContaAutoCP := FALSE;



                  OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(v_ContaCargoPac(1).cd_reg_fat);

                  FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                  INTO NcdlctoCp;

                  CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;



                   INSERT INTO Dbamv.Itreg_Fat

                    (Cd_Reg_Fat,

                     Cd_Lancamento,

                     Dt_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Vl_Percentual_Multipla,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Sn_Pertence_Pacote,

                     Cd_Prestador,

                     Cd_Ati_Med,

                     Tp_Pagamento,

                     Cd_Guia,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto,

                     Cd_Itmvto ,

                     cd_regra_substituicao_proced

                     )

                  VALUES

                    (v_ContaCargoPac(1).cd_reg_fat,

                     NcdlctoCp,

                     Ddthraux,

                     Ddthraux,

                     Nvl(Nqtexcedeu, Nvl(Nqtconv, Nqtprofat)), /* ALLS - Ajuste OP 42241 */

                     vRegraCriaContaAutoCP(1).vl_percentual_carga_familiar,

                     Ncdgrufat,

                     v_Proced.Cd_Pro_Fat,

                     'N',

                     Nprestador,

                     Ccdatimed,

                     Ctppgto,

                     Ncdguia,

                     v_Mvto.Cd_Setor,

                     Nvl(v_Mvto.Cd_Setor_Set_Exa, v_Mvto.Cd_Setor),

                     'N',

                     USER,

                     Decode(Ncditemformula, NULL, Ncdpedrx, Ncditpedrx),

                     Decode(Ncditemformula, NULL, 'Imagem', 'Kit-Exame'),

                     Nvl(Ncditemformula, Ncditpedrx),

                     nRegraSubstituicao

                     );

              END IF;

              /*OP 42241*/



          IF Bequipe THEN

            OPEN c_Atimed;

            FETCH c_Atimed

              INTO Ccdatimed;

            CLOSE c_Atimed;

            INSERT INTO Dbamv.Itlan_Med

              (Cd_Reg_Fat,

               Cd_Lancamento,

               Cd_Prestador,

               Cd_Ati_Med,

               Tp_Pagamento)

            VALUES

              (NVL(nConta, Ncdregfat), /* Ncdregfat OP 43289 */

               NVL(nLanc, Ncdlcto), /* OP 43289 --Ncdlcto */

               Nprestadorequip,

               Ccdatimed,

               Ctppgto);

          END IF;

          IF NOT

              Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat, Ncdlcto, 'I') THEN

            IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                          Ncdlcto,

                                                          'I') THEN

              Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'I');

            END IF;

          END IF;

          --PDA 108042 22/11/2004 Sp?ola (INICIO)

          --Inserida a rotina de valores relacionados

          -- /* Lancamento dos Valores Relacionados */ --

          DECLARE

            CURSOR Crelacionados IS

              SELECT Rela.Cd_Pro_Fat,

                     Rela.Tp_Atend_Homecare,

                     Rela.Tp_Atend_Externo,

                     Rela.Tp_Atend_Urgeme,

                     Rela.Tp_Atend_Ambulatorial,

                     Rela.Tp_Atend_Internacao

                     --PDA 108042 22/11/2004 Sp?ola (INICIO)

                     --Inserida a coluna qt_lancamento que ir?ultiplicar a quantidade na rotina Dbamv.lanca_ffcv_pro_relacionados

                    ,

                     Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

              --PDA 108042 (FIM)

                FROM Dbamv.Con_Pla,

                     Dbamv.Regra,

                     Dbamv.Val_Pro_Relacionado Rela,

                     Dbamv.Empresa_Con_Pla /* PDA 118607/131598 */

                        ,dbamv.pro_fat             -- OP 32555 *2

               WHERE Empresa_Con_Pla.Cd_Convenio = Con_Pla.Cd_Convenio /* PDA 118607/131598 */

                 AND Empresa_Con_Pla.Cd_Con_Pla = Con_Pla.Cd_Con_Pla /* PDA 118607/131598 */

                 AND Empresa_Con_Pla.Cd_Multi_Empresa =

                     Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/131598 */



					 -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

                     --AND Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat

					 and ( ( rela.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = rela.cd_pro_fat and Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					    or ( rela.cd_pro_fat_pai is null and rela.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                             AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

					     )

				     -- OP 32555 - fim



                 AND Con_Pla.Cd_Convenio = v_Mvto.Cd_Convenio

                 AND Con_Pla.Cd_Con_Pla = v_Mvto.Cd_Con_Pla

                 AND Rela.Tp_Lancamento = 'A'

                 AND Nvl(Rela.Sn_Incidencia_Exame, 'N') = 'N' --145551

                    --PDA 114239 17/01/2005 Sp?ola (INICIO)

                    --Incluida verifica? por tipo de atendimento para os procedimentos relacionados

                 AND ((v_Mvto.Tp_Atendimento = 'H' AND

                     Rela.Tp_Atend_Homecare = 'S') OR

                     (v_Mvto.Tp_Atendimento = 'E' AND

                     Rela.Tp_Atend_Externo = 'S') OR

                     (v_Mvto.Tp_Atendimento = 'U' AND

                     Rela.Tp_Atend_Urgeme = 'S') OR

                     (v_Mvto.Tp_Atendimento = 'A' AND

                     Rela.Tp_Atend_Ambulatorial = 'S') OR

                     (v_Mvto.Tp_Atendimento = 'I' AND

                     Rela.Tp_Atend_Internacao = 'S'))

                    --PDA 114239 (FIM)

                    /* pda 407641 - thiago miranda de oliveira*/

                    --AND con_pla.cd_regra = regra.cd_regra

                 AND Empresa_Con_Pla.Cd_Regra = Regra.Cd_Regra

                    /* fim pda 407641*/

                 AND Rela.Cd_Regra = Regra.Cd_Regra

                    --PDA 97407 - Eduardo Santis 08/07/2004 - (Inicio)

                 AND Dt_Vigencia IN

                     (SELECT MAX(Vpr.Dt_Vigencia)

                        FROM Dbamv.Val_Pro_Relacionado Vpr

                       WHERE Vpr.Dt_Vigencia <= v_Mvto.Dt_Pedido

                            -- PDA 105921 (In?o) - 14/09/2004 - Pollyane K. A. Nunes

                            -- Inclui a verifica? da vig?ia por regra e procedimento

                         AND Vpr.Cd_Regra = Rela.Cd_Regra

                             -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

					         -- AND Vpr.Cd_Pro_Fat_Pai = Rela.Cd_Pro_Fat_Pai

					         -- AND Vpr.Cd_Pro_Fat = Rela.Cd_Pro_Fat

					         and ( ( Vpr.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = Vpr.cd_pro_fat and Vpr.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					            or ( Vpr.cd_pro_fat_pai is null and Vpr.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                                     AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

						          )

						     -- OP 32555 - fim

						 );

            -- PDA 105921 -- (Fim)

            --PDA 97407 - Eduardo Santis 08/07/2004 - (Fim)

            Cretorno       VARCHAR2(1);

            Vcrelacionados Crelacionados%ROWTYPE;

          BEGIN

            FOR Vcrelacionados IN Crelacionados

            LOOP

              -- PDA 189031 Inicio

              -- PDA 225086 (Inicio) - c??o comentado, o mesmo foi colocado antes da chamada da fnc_gera_pacote.

              -- PDA 225086 - Retirado o comentario abaixo

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncdregfat);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                INTO Ncdlctoupdate;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

              -- PDA 225086 (Fim)

              -- PDA 189031 Fim

              Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(v_Mvto.Cd_Atendimento,

                                                            Ncdregfat,

                                                            Ncdlcto,

                                                            Ncdpedrx,

                                                            v_Proced.Cd_Pro_Fat

                                                            /*PDA 116436 14/03/2005 Sp?ola(INICIO)

                                                                                                                       A data de passagem de parametro deve ser ddtrealiznew utilizado no insert da fun?

                                                                                                                       A hora de lancamento deve, assim como a data, se a mesma do insert na itreg_fat*/,

                                                            Ddtrealiznew,

                                                            Nvl(Hrlancamento,

                                                                Ddtrealiznew)

                                                            /*PDA 116436 (FIM)*/,

                                                            v_Mvto.Cd_Setor,

                                                            'P',

                                                            v_Mvto.Tp_Atendimento,

                                                            v_Mvto.Dt_Atendimento,

                                                            Ncdconvconta,

                                                            Ncdplanconta,

                                                            v_Mvto.Cd_Atendimento_Pai,

                                                            v_Mvto.Tp_Convenio,

                                                            v_Mvto.Dt_Alta,

                                                            Vcrelacionados.Cd_Pro_Fat, --PDA 108042 22/11/2004 Sp?ola (INICIO)

                                                            --As quantidades lan?a ser?ultiplicadas pelo fator de quantidade qt_lancamento

                                                            Vcrelacionados.Qt_Lancamento *

                                                            Nvl(Nqtconv,

                                                                Nqtprofat),

                                                            0, --PDA 108042 (FIM)

                                                            'I'

                                                            --PDA 108070 29/12/2004 Sp?ola (INICIO)

                                                            --Inserido o campo do prestador que ser?tilizado apenas para os procedimentos relacionados de ambulatorio

                                                            --lancadados pela prc_ffcv_lanca_atendimento - lancamento automatico do procedimento principal na criacao do atendimento

                                                           ,

                                                            Nvl(Nprestador,

                                                                Nprestadorequip) --PDA 151332

                                                            --PDA 108070 (FIM)

                                                            -- pda 119975 - 29/05/2005 - Amalia Ara??

                                                            -- par?tro de fator relacionado para insert nas tabelas itreg_amb e itreg_fat

                                                           ,

                                                            Vcrelacionados.Qt_Lancamento

                                                            -- pda 119975 - fim

                                                            );

              -- PDA 189031 Inicio

              UPDATE Dbamv.Itreg_Fat

                 SET Cd_Setor_Produziu = v_Mvto.Cd_Setor_Set_Exa

               WHERE Cd_Reg_Fat = Ncdregfat

                 AND Cd_Lancamento = Ncdlctoupdate;

              -- PDA 189031 Fim

            END LOOP;

          END;

          --PDA 108042 (FIM)

          /* PDA 145551 - Rodrigo Valentim - HSR

          * Rotina de cobran?de incid?ia de exames.

          * Rotina realizada na interna?

          */

          IF Nvl(Nsnincidenciaexame, 'N') = 'S' THEN

            DECLARE

              CURSOR Crelacionados IS

                SELECT Rela.Cd_Pro_Fat,

                       Rela.Tp_Atend_Homecare,

                       Rela.Tp_Atend_Externo,

                       Rela.Tp_Atend_Urgeme,

                       Rela.Tp_Atend_Ambulatorial,

                       Rela.Tp_Atend_Internacao

                       --PDA 145551 Rodrigo Valentim (INICIO)

                       --Forcando quantidade 1 para incidencias

                      ,

                       1 Qt_Lancamento

                --PDA 145551 Rodrigo Valentim (FIM)

                  FROM Dbamv.Con_Pla,

                       Dbamv.Regra,

                       Dbamv.Val_Pro_Relacionado Rela,

                       Dbamv.Empresa_Con_Pla /* PDA 118607/131598 */

                        ,dbamv.pro_fat             -- OP 32555 *2

                 WHERE Empresa_Con_Pla.Cd_Convenio = Con_Pla.Cd_Convenio /* PDA 118607/131598 */

                   AND Empresa_Con_Pla.Cd_Con_Pla = Con_Pla.Cd_Con_Pla /* PDA 118607/131598 */

                   AND Empresa_Con_Pla.Cd_Multi_Empresa =

                       Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/131598 */



					 -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

                     --AND Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat

					 and ( ( rela.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = rela.cd_pro_fat and Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					    or ( rela.cd_pro_fat_pai is null and rela.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                             AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

					     )

				     -- OP 32555 - fim



                   AND Con_Pla.Cd_Convenio = v_Mvto.Cd_Convenio

                   AND Con_Pla.Cd_Con_Pla = v_Mvto.Cd_Con_Pla

                   AND Rela.Tp_Lancamento = 'A'

                      -- PDA 145551 (Inicio) So DEVERa LANCAR SE ESTIVER MARCADO COMO INCIDENCIA

                   AND Rela.Sn_Incidencia_Exame = 'S'

                      -- PDA 145551 (Fim)

                      --PDA 114239 17/01/2005 Sp?ola (INICIO)

                      --Incluida verifica? por tipo de atendimento para os procedimentos relacionados

                   AND ((v_Mvto.Tp_Atendimento = 'H' AND

                       Rela.Tp_Atend_Homecare = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'E' AND

                       Rela.Tp_Atend_Externo = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'U' AND

                       Rela.Tp_Atend_Urgeme = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'A' AND

                       Rela.Tp_Atend_Ambulatorial = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'I' AND

                       Rela.Tp_Atend_Internacao = 'S'))

                      --PDA 114239 (FIM)

                      /* pda 407641 - thiago miranda de oliveira*/

                      --AND con_pla.cd_regra = regra.cd_regra

                   AND Empresa_Con_Pla.Cd_Regra = Regra.Cd_Regra

                      /* fim pda 407641*/

                   AND Rela.Cd_Regra = Regra.Cd_Regra

                      --PDA 97407 - Eduardo Santis 08/07/2004 - (Inicio)

                   AND Dt_Vigencia IN

                       (SELECT MAX(Vpr.Dt_Vigencia)

                          FROM Dbamv.Val_Pro_Relacionado Vpr

                         WHERE Vpr.Dt_Vigencia <= v_Mvto.Dt_Pedido

                              -- PDA 105921 (In?o) - 14/09/2004 - Pollyane K. A. Nunes

                              -- Inclui a verifica? da vig?ia por regra e procedimento

                           AND Vpr.Cd_Regra = Rela.Cd_Regra

                             -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

					         -- AND Vpr.Cd_Pro_Fat_Pai = Rela.Cd_Pro_Fat_Pai

					         -- AND Vpr.Cd_Pro_Fat = Rela.Cd_Pro_Fat

					         and ( ( Vpr.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = Vpr.cd_pro_fat and Vpr.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					            or ( Vpr.cd_pro_fat_pai is null and Vpr.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                                     AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

						          )

						     -- OP 32555 - fim

						   );

              -- PDA 105921 -- (Fim)

              --PDA 97407 - Eduardo Santis 08/07/2004 - (Fim)

              Cretorno       VARCHAR2(1);

              Vcrelacionados Crelacionados%ROWTYPE;

            BEGIN

              FOR Vcrelacionados IN Crelacionados

              LOOP

                -- PDA 189031 Inicio

                OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncdregfat);

                FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                  INTO Ncdlctoupdate;

                CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

                -- PDA 189031 Fim

                Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(v_Mvto.Cd_Atendimento,

                                                              Ncdregfat,

                                                              Ncdlcto,

                                                              Ncdpedrx,

                                                              v_Proced.Cd_Pro_Fat

                                                              /*PDA 116436 14/03/2005 Sp?ola(INICIO)

                                                                                                                         A data de passagem de parametro deve ser ddtrealiznew utilizado no insert da fun?

                                                                                                                         A hora de lancamento deve, assim como a data, se a mesma do insert na itreg_fat*/,

                                                              Ddtrealiznew,

                                                              Nvl(Hrlancamento,

                                                                  Ddtrealiznew)

                                                              /*PDA 116436 (FIM)*/,

                                                              v_Mvto.Cd_Setor,

                                                              'P',

                                                              v_Mvto.Tp_Atendimento,

                                                              v_Mvto.Dt_Atendimento,

                                                              Ncdconvconta,

                                                              Ncdplanconta,

                                                              v_Mvto.Cd_Atendimento_Pai,

                                                              v_Mvto.Tp_Convenio,

                                                              v_Mvto.Dt_Alta,

                                                              Vcrelacionados.Cd_Pro_Fat,

                                                              1,

                                                              0, --PDA 108042 (FIM)

                                                              'I'

                                                              --PDA 108070 29/12/2004 Sp?ola (INICIO)

                                                              --Inserido o campo do prestador que ser?tilizado apenas para os procedimentos relacionados de ambulatorio

                                                              --lancadados pela prc_ffcv_lanca_atendimento - lancamento automatico do procedimento principal na criacao do atendimento

                                                             ,

                                                              Nvl(Nprestador,

                                                                  Nprestadorequip) --PDA 151332

                                                              --PDA 108070 (FIM)

                                                              -- pda 119975 - 29/05/2005 - Amalia Ara??

                                                              -- par?tro de fator relacionado para insert nas tabelas itreg_amb e itreg_fat

                                                             ,

                                                              1

                                                              -- pda 119975 - fim

                                                              );

                -- PDA 189031 Inicio

                UPDATE Dbamv.Itreg_Fat

                   SET Cd_Setor_Produziu = v_Mvto.Cd_Setor_Set_Exa

                 WHERE Cd_Reg_Fat = Ncdregfat

                   AND Cd_Lancamento = Ncdlctoupdate;

                -- PDA 189031 Fim

              END LOOP;

            END;

          END IF;

          /* PDA 145551 - Rodrigo Valentim - HSR (FIM)

          * Rotina de cobran?de incid?ia de exames.

          */

        ELSE

          -- Ambulatorial

          --PDA 99802 21/07/2004 Sp?ola (INICIO)

          --Abertura do cursor utilizado para recuperar a data de sess?do atendimento

          OPEN Catendsessao(v_Mvto.Cd_Atendimento);

          FETCH Catendsessao

            INTO Vcatendsessao;

          CLOSE Catendsessao;

          --PDA 99802 (FIM)



          IF nprestador   is not null  then   -- op 38143

              OPEN dbamv.pack_lanca_ffcv.c_forapreatimed(ncdconvconta, ncdgrufat);

              FETCH dbamv.pack_lanca_ffcv.c_forapreatimed INTO v_forapreatimed;

              CLOSE dbamv.pack_lanca_ffcv.c_forapreatimed;



           IF v_forapreatimed.sn_cadastra_ati_med = 'S' then

             vccdatimed := v_config.cd_ati_med_clinico;

           ELSE

             vccdatimed := null;

           END if;

          END if;



          IF Limite <> 1 THEN

            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o procedimento que ira ser inserido abaixo pertence a um pacote, e a qunatidade que sera inserida sera menor que a lan?a, a diferen?

            sera lan?a na rotina mais abaixo atravez da procedure PRC_DESVINCULA_PROCEDIMENTO*/

            /* fazendo tratamento caso o procedimento esteja configurado no gabarito para ser inserido dentro de uma conta particular

            caso a variavel vTpContaPart esteja preenchida e a quantidade de lan?ento extra esteja nula. com iso deve ser procurado uma conta particular

            e um lan?ento para inseririr nesta conta.*/

            Nconta := NULL;

            Nlanc  := NULL;



			/*43289 - quebra de conta por quantidade de procedimento por atendimento*/

			/*A regra de pacote tem prioridade sobre essa regra, conforme vari?l Nqtexcedeu abaixo*/

			IF Nqtexcedeu IS NULL THEN

				if (not vSnCriouContaAutoAmb) then /*OP 46768*/

					  IF DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_EXISTE_CONF_QTD_ATEND_PAC(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																						 v_proced.cd_pro_fat,

																						 pEmpresa) THEN



						  Nqtexcedeu := DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_RETORNA_QTD_LANC_PERIODO(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																									   v_proced.cd_pro_fat,

																									   pEmpresa,

																									   ncdregamb,

																									   nvl(nqtconv, nqtprofat),

																									   pSnChamadoDaTela,

																									   pvSnJaExcedeuQtd,

																									   pvMensagem

																									   );

						  IF pvSnJaExcedeuQtd = 'S' THEN

							  Vtpcontapart := 'ProcPorAtend';

							  Nqtexcedeu   := NULL;

						  ELSE

								IF NVL(Nqtexcedeu,0) > 0 THEN

									Vtpcontapart := 'ProcPorAtend';

								END IF;

						  END IF;

					END IF;

				END IF;/*OP 46768*/

		    END IF;

			/*43289*/



            IF Nvl(Vtpcontapart, 'X') <> 'X' AND Nqtexcedeu IS NULL THEN

              Nconta := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                       v_Mvto.Cd_Atendimento));

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Nconta);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                INTO Nlanc;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;



              /*43289*/

              ncdconvconta := v_particular.cd_convenio;

              ncdplanconta := v_particular.cd_con_pla;

              /*43289*/



            END IF;

            INSERT INTO Dbamv.Itreg_Amb

              (Cd_Reg_Amb,

               Cd_Lancamento,

               Hr_Lancamento,

               Qt_Lancamento,

               Cd_Gru_Fat,

               Cd_Pro_Fat,

               Cd_Atendimento,

               Cd_Con_Pla,

               Cd_Convenio,

               Sn_Fatura_Impressa,

               Sn_Fechada,

               Sn_Conta_Calculada,

               Cd_Guia,

               Sn_Pertence_Pacote,

               Vl_Percentual_Multipla,

               Cd_Setor,

               Cd_Setor_Produziu,

               Cd_Prestador,

               Cd_Ati_Med,

               Tp_Pagamento,

               Sn_Horario_Especial,

               Cd_Usuario,

               Cd_Mvto,

               Tp_Mvto,

               Cd_Itmvto -- pda 116108

              ,

               Dt_Sessao --PDA 99802 09/07/2004 Sp?ola (Comentario mais abaixo)

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Cd_Conta_Pacote

               -- PDA 157145 (Fim)

               ,cd_regra_substituicao_proced

               )

            VALUES

              (Nvl(Nconta, Ncdregamb) -- OP 387

              ,

               Nvl(Nlanc, Ncdlcto) -- OP 387

              ,

               Nvl(Hrlancamento, Ddtrealiznew),

               Nvl(Nqtexcedeu, Nvl(Nqtconv, Nqtprofat)) -- OP 387

              ,

               Ncdgrufat,

               v_Proced.Cd_Pro_Fat,

               Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

               Ncdplanconta,

               Ncdconvconta,

               'N',

               'N',

               'N',

               Ncdguia,

               Nvl(Csnpacote, 'N'),

               Nvl(Pcfaturado, 100),

               v_Mvto.Cd_Setor,

               Nvl(v_Mvto.Cd_Setor_Set_Exa, v_Mvto.Cd_Setor),

               Nprestador,

               vccdatimed,

               Ctppgto,

               Csnhoresp,

               USER

               --                            , ncdpedrx                                           -- PDA 159898

               --                            ,'Imagem'                                            -- PDA 159898

               --                            , ncditpedrx                                         -- PDA 159898

              ,

               Decode(Ncditemformula, NULL, Ncdpedrx, Ncditpedrx) -- PDA 159898

              ,

               Nvl(Vtpcontapart,

                   Decode(Ncditemformula, NULL, 'Imagem', 'Kit-Exame')) -- PDA 159898     -- OP 387

              ,

               Nvl(Ncditemformula, Ncditpedrx) -- PDA 159898

              , --PDA 99802 09/07/2004 Sp?ola (INICIO)

               --Se o quantidade de sesS??for maior que zero e o atendimento filho for de retorno,

               --preencher a data da sessao com a data do atendimento filho.

               Decode(Vcatendsessao.Sn_Retorno,

                      'N',

                      NULL,

                      Decode(Vcatendsessao.Qt_Sessoes,

                             0,

                             NULL,

                             Vcatendsessao.Dt_Atendimento))

               --PDA 99802 (FIM)

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Ncdpacote

               -- PDA 157145 (Fim)

               ,nRegraSubstituicao

               ); -- pda 116108





        /*OP 41394 - replicar horario especial no lan?ento autom?co. Incialmente implementa? pro cliente HOSCAR*/

        IF (nvl(Csnhoresp,'N') = 'S'

            AND (NOT vSnCriouContaAutoAmb) /*n??m item de regra de quebra de conta autom?ca*/

            AND vSnReplicaProc = 'S' )     /*tem regra pra replicar proc de hor?o especial*/

            THEN



             OPEN cProced(v_Proced.Cd_Pro_Fat);

             FETCH cProced INTO vProced;

             CLOSE cProced;



             OPEN cRregra(Ncdconvconta,Ncdplanconta);

             FETCH cRregra INTO vRregra;

             CLOSE cRregra;



             vNlsBanco := dbamv.FNC_FFCV_FIRST_DAY_SEMANA_BR('S',null);

             OPEN dbamv.pack_lanca_ffcv.cSnReplicaProcHe(vRregra.cd_regra,

                                                         vProced.cd_gru_pro,

                                                         v_Proced.Cd_Pro_Fat,

                                                         TO_NUMBER(TO_CHAR(Ddtrealiznew, 'd')),

                                                         Nvl(Ddthraux, SYSDATE),

                                                         v_Mvto.Tp_Atendimento);

             FETCH dbamv.pack_lanca_ffcv.cSnReplicaProcHe INTO vSnReplicaProcHe;

             CLOSE dbamv.pack_lanca_ffcv.cSnReplicaProcHe;

             vNlsBanco := dbamv.FNC_FFCV_FIRST_DAY_SEMANA_BR('N',vNlsBanco);



             IF Nvl(vSnReplicaProcHe.sn_replica_proc,'N') = 'S' THEN



                 dbamv.prc_ffcv_replica_proc_he(nvl(nConta, ncdregamb),         -- pCdConta IN NUMBER ,

                                                nvl(nLanc, ncdlcto),            --pCdLancConta IN NUMBER ,

                                                'A',                            --pTpAtend     IN VARCHAR2,

                                                vSnReplicaProcHe.vl_percentual, --pVlPercent   IN NUMBER DEFAULT null,

                                                'N'                             --pSnInsereConta IN VARCHAR2

                                                );



                 dbamv.prc_ffcv_replica_proc_he(nvl(nConta, ncdregamb),

                                            nvl(nlanc,ncdlcto),

                                            'A',

                                            null,

                                            'S');

             END IF;

        END IF;

        /*OP 41394*/





            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

            os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

            IF Nqtexcedeu IS NOT NULL THEN

              Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregamb,

                                                                  Ncdlcto,

                                                                  (Nvl(Nqtconv,

                                                                       Nqtprofat) -

                                                                  Nqtexcedeu),

                                                                  Vtpcontapart,

                                                                  Nvl(Hrlancamento,

                                                                  Ddtrealiznew),

																  nvl(v_mvto.cd_atendimento_pai, v_mvto.cd_atendimento)); /*ALLS OP 43289*/

            END IF;

          END IF;

          IF Nvl(Nqtpart, 0) > 0 AND Ctpproibicao = 'AG' THEN

            Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(v_Mvto.Cd_Atendimento);

            INSERT INTO Dbamv.Itreg_Amb

              (Cd_Reg_Amb,

               Cd_Lancamento,

               Hr_Lancamento,

               Qt_Lancamento,

               Cd_Gru_Fat,

               Cd_Pro_Fat,

               Cd_Atendimento,

               Cd_Con_Pla,

               Cd_Convenio,

               Sn_Fatura_Impressa,

               Sn_Fechada,

               Sn_Conta_Calculada,

               Cd_Guia,

               Sn_Pertence_Pacote,

               Vl_Percentual_Multipla,

               Cd_Setor,

               Cd_Setor_Produziu,

               Cd_Prestador,

               Cd_Ati_Med,

               Tp_Pagamento,

               Sn_Horario_Especial,

               Cd_Usuario,

               Cd_Mvto,

               Tp_Mvto,

               Cd_Itmvto,

               Dt_Sessao --PDA 99802 09/07/2004 Sp?ola (Comentario mais abaixo)

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Cd_Conta_Pacote

               -- PDA 157145 (Fim)

               ,cd_regra_substituicao_proced

               ) -- pda 116108

            VALUES

              (Ncdregamb,

               Ncdlcto,

               Nvl(Hrlancamento, Ddtrealiznew),

               Nqtpart,

               Ncdgrufat,

               v_Proced.Cd_Pro_Fat,

               Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

               v_Particular.Cd_Con_Pla,

               v_Particular.Cd_Convenio,

               'N',

               'N',

               'N',

               Ncdguia,

               Nvl(Csnpacote, 'N'),

               Nvl(Pcfaturado, 100),

               v_Mvto.Cd_Setor,

               Nvl(v_Mvto.Cd_Setor_Set_Exa, v_Mvto.Cd_Setor),

               Nprestador,

               Ccdatimed,

               Ctppgto,

               Csnhoresp,

               USER

               --                            , ncdpedrx                                           -- PDA 159898

               --                            ,'Imagem'                                            -- PDA 159898

               --                            , ncditpedrx                                         -- PDA 159898

              ,

               Decode(Ncditemformula, NULL, Ncdpedrx, Ncditpedrx) -- PDA 159898

              ,

               Decode(Ncditemformula, NULL, 'Imagem', 'Kit-Exame') -- PDA 159898

              ,

               Nvl(Ncditemformula, Ncditpedrx) -- PDA 159898

              , --PDA 99802 09/07/2004 Sp?ola (INICIO)

               --Se o quantidade de sesS??for maior que zero e o atendimento filho for de retorno,

               --preencher a data da sessao com a data do atendimento filho.

               Decode(Vcatendsessao.Sn_Retorno,

                      'N',

                      NULL,

                      Decode(Vcatendsessao.Qt_Sessoes,

                             0,

                             NULL,

                             Vcatendsessao.Dt_Atendimento))

               --PDA 99802 (FIM)

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Ncdpacote

               -- PDA 157145 (Fim)

               ,nRegraSubstituicao

               ); -- pda 116108

          END IF;



              /*OP 42241 - Caso tenha criado a conta por cargo paciente, devemos lan? o item para o convenio, plano, percentual definido na configura

              de quebra de conta por cargo paciente*/

              IF (vSnCriouContaAutoAmbCP) THEN

                   OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(v_ContaCargoPacAmbu(1).cd_reg_amb);

                   FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                      INTO NcdlctoAmbCp;

                   CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;



                   INSERT INTO Dbamv.Itreg_Amb

                    (Cd_Reg_Amb,

                     Cd_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Cd_Atendimento,

                     Cd_Con_Pla,

                     Cd_Convenio,

                     Sn_Fatura_Impressa,

                     Sn_Fechada,

                     Sn_Conta_Calculada,

                     Cd_Guia,

                     Sn_Pertence_Pacote,

                     Cd_Prestador,

                     Cd_Ati_Med,

                     Tp_Pagamento,

                     Vl_Percentual_Multipla,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto,

                     Dt_Sessao,

                     Cd_Itmvto,

                     cd_regra_substituicao_proced

                     )

                  VALUES

                    (v_ContaCargoPacAmbu(1).cd_reg_amb,

                     NcdlctoAmbCp,

                     Nvl(Hrlancamento, Ddtrealiznew),

                     Nvl(Nqtexcedeu, Nvl(Nqtconv, Nqtprofat)), /* ALLS - Ajuste OP 42241 */

                     Ncdgrufat,

                     v_Proced.Cd_Pro_Fat,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                     vRegraCriaContaAutoCP(1).cd_convenio_destino,

                     'N',

                     'N',

                     'N',

                     Ncdguia,

                     'N',

                     Nprestador,

                     Ccdatimed,

                     Ctppgto,

                     vRegraCriaContaAutoCP(1).vl_percentual_carga_familiar,

                     v_Mvto.Cd_Setor,

                     Nvl(v_Mvto.Cd_Setor_Set_Exa, v_Mvto.Cd_Setor),

                     'N',

                     USER,

                     Decode(Ncditemformula, NULL, Ncdpedrx, Ncditpedrx),

                     Decode(Ncditemformula, NULL, 'Imagem', 'Kit-Exame'),

                     Decode(Vcatendsessao.Sn_Retorno,

                            'N',

                            NULL,

                                Decode(Vcatendsessao.Qt_Sessoes,

                                       0,

                                       NULL,

                                            Vcatendsessao.Dt_Atendimento)),

                     Nvl(Ncditemformula, Ncditpedrx)  ,

                     nRegraSubstituicao

                     );

              END IF;

              /*OP 42241*/



          --

          -- PDA 197953 (In?o) - 08/08/2007 - Diego Costa

          -- inclus?de verifica? a regra de atendimento pro_fat antes da regra de acoplamaneto

          IF NOT

              Dbamv.Pack_Ffcv.Regra_Atendimento_Ambu(Ncdregamb, Ncdlcto, 'I') THEN

            IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Ambu(Ncdregamb,

                                                          Ncdlcto,

                                                          'I') THEN

              Verif_Franquia_Ambu(Ncdregamb, Ncdlcto);

            END IF;

          END IF;

          -- PDA 197953 (Fim)

          --

dbamv.prc_grava_log_erro( 'VAL', Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento), Ncdregamb, 'v_Proced.Cd_Pro_Fat:'||v_Proced.Cd_Pro_Fat||'  Ncdconvconta:'||Ncdconvconta||'  v_mvto.Cd_Convenio:'||v_mvto.Cd_Convenio, 44);

          --PDA 108042 22/11/2004 Sp?ola (INICIO)

          --Inserida a rotina de valores relacionados

          -- /* Lancamento dos Valores Relacionados */ --

          DECLARE

            CURSOR Crelacionados IS

              SELECT Rela.Cd_Pro_Fat,

                     Rela.Tp_Atend_Homecare,

                     Rela.Tp_Atend_Externo,

                     Rela.Tp_Atend_Urgeme,

                     Rela.Tp_Atend_Ambulatorial,

                     Rela.Tp_Atend_Internacao

                     --PDA 108042 22/11/2004 Sp?ola (INICIO)

                     --Inserida a coluna qt_lancamento que ir?ultiplicar a quantidade na rotina Dbamv.lanca_ffcv_pro_relacionados

                    ,

                     Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

              --PDA 108042 (FIM)

                FROM Dbamv.Con_Pla,

                     Dbamv.Regra,

                     Dbamv.Val_Pro_Relacionado Rela,

                     Dbamv.Empresa_Con_Pla /* PDA 118607/131598 */

                        ,dbamv.pro_fat             -- OP 32555 *2

               WHERE Empresa_Con_Pla.Cd_Convenio = Con_Pla.Cd_Convenio /* PDA 118607/131598 */

                 AND Empresa_Con_Pla.Cd_Con_Pla = Con_Pla.Cd_Con_Pla /* PDA 118607/131598 */

                 AND Empresa_Con_Pla.Cd_Multi_Empresa =

                     Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/131598 */



					 -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

                     --AND Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat

					 and ( ( rela.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = rela.cd_pro_fat and Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					    or ( rela.cd_pro_fat_pai is null and rela.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                             AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

					     )

				     -- OP 32555 - fim



                 AND Con_Pla.Cd_Convenio = Ncdconvconta  -- v_Mvto.Cd_Convenio   -- OP 32555

                 AND Con_Pla.Cd_Con_Pla = Ncdplanconta   -- v_Mvto.Cd_Con_Pla    -- OP 32555

                 AND Rela.Tp_Lancamento = 'A'

                 AND Nvl(Rela.Sn_Incidencia_Exame, 'N') = 'N' --PDA - 145551 - NAO LANCAR ITENS DE INCIDENCIA

                    --PDA 114239 17/01/2005 Sp?ola (INICIO)

                    --Incluida verifica? por tipo de atendimento para os procedimentos relacionados

                 AND ((v_Mvto.Tp_Atendimento = 'H' AND

                     Rela.Tp_Atend_Homecare = 'S') OR

                     (v_Mvto.Tp_Atendimento = 'E' AND

                     Rela.Tp_Atend_Externo = 'S') OR

                     (v_Mvto.Tp_Atendimento = 'U' AND

                     Rela.Tp_Atend_Urgeme = 'S') OR

                     (v_Mvto.Tp_Atendimento = 'A' AND

                     Rela.Tp_Atend_Ambulatorial = 'S') OR

                     (v_Mvto.Tp_Atendimento = 'I' AND

                     Rela.Tp_Atend_Internacao = 'S'))

                    --PDA 114239 (FIM)

                    /* pda 407641 - thiago miranda de oliveira*/

                    --AND con_pla.cd_regra = regra.cd_regra

                 AND Empresa_Con_Pla.Cd_Regra = Regra.Cd_Regra

                    /* fim pda 407641*/

                 AND Rela.Cd_Regra = Regra.Cd_Regra

                    --PDA 97407 - Eduardo Santis 08/07/2004 - (Inicio)

                 AND Dt_Vigencia IN

                     (SELECT MAX(Vpr.Dt_Vigencia)

                        FROM Dbamv.Val_Pro_Relacionado Vpr

                       WHERE Vpr.Dt_Vigencia <= v_Mvto.Dt_Pedido

                            -- PDA 105921 (In?o) - 14/09/2004 - Pollyane K. A. Nunes

                            -- Inclui a verifica? da vig?ia por regra e procedimento

                         AND Vpr.Cd_Regra = Rela.Cd_Regra

                             -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

					         -- AND Vpr.Cd_Pro_Fat_Pai = Rela.Cd_Pro_Fat_Pai

					         -- AND Vpr.Cd_Pro_Fat = Rela.Cd_Pro_Fat

					         and ( ( Vpr.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = Vpr.cd_pro_fat and Vpr.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					            or ( Vpr.cd_pro_fat_pai is null and Vpr.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                                     AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

						          )

						     -- OP 32555 - fim

						 );

            -- PDA 105921 -- (Fim)

            --PDA 97407 - Eduardo Santis 08/07/2004 - (Fim)

            Cretorno       VARCHAR2(1);

            Vcrelacionados Crelacionados%ROWTYPE;

          BEGIN

            FOR Vcrelacionados IN Crelacionados

            LOOP

              -- PDA 189031 Inicio

              -- PDA 225086 (Inicio) - c??o comentado, o mesmo foi colocado antes da chamada da fnc_gera_pacote.

              -- PDA 225086 - Retirado o comentario abaixo

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncdregfat);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                INTO Ncdlctoupdate;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

              -- PDA 225086 (Fim)

              -- PDA 189031 Fim

dbamv.prc_grava_log_erro( 'VAL', v_Mvto.Cd_Atendimento, Ncdregamb, 'v_Proced.Cd_Pro_Fat:'||v_Proced.Cd_Pro_Fat||'  Ncdlcto:'||Ncdlcto, 45);

              Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(v_Mvto.Cd_Atendimento,

                                                            Ncdregamb,

                                                            Ncdlcto,

                                                            Ncdpedrx,

                                                            v_Proced.Cd_Pro_Fat,

                                                            v_Mvto.Dt_Pedido

                                                            /*PDA 116436 14/03/2005 Sp?ola (INICIO)

                                                                                                                       A hora de lancamento deve ser semelhando ao do insert na itreg_amb*/,

                                                            Nvl(Hrlancamento,

                                                                Ddtrealiznew)

                                                            /*PDA 116436 (FIM)*/,

                                                            v_Mvto.Cd_Setor,

                                                            'P',

                                                            v_Mvto.Tp_Atendimento,

                                                            v_Mvto.Dt_Atendimento,

                                                            Ncdconvconta,

                                                            Ncdplanconta,

                                                            v_Mvto.Cd_Atendimento_Pai,

                                                            v_Mvto.Tp_Convenio,

                                                            v_Mvto.Dt_Alta,

                                                            Vcrelacionados.Cd_Pro_Fat, --PDA 108042 22/11/2004 Sp?ola (INICIO)

                                                            --As quantidades lan?a ser?ultiplicadas pelo fator de quantidade qt_lancamento

                                                            Vcrelacionados.Qt_Lancamento *

                                                            Nvl(Nqtconv,

                                                                Nqtprofat),

                                                            0, --PDA 108042 (FIM)

                                                            'I'

                                                            --PDA 108070 29/12/2004 Sp?ola (INICIO)

                                                            --Inserido o campo do prestador que ser?tilizado apenas para os procedimentos relacionados de ambulatorio

                                                            --lancadados pela prc_ffcv_lanca_atendimento - lancamento automatico do procedimento principal na criacao do atendimento

                                                           ,

                                                            Nprestador -- PDA 124164 - 25/05/05 - Passando o c??o do prestador, antes era passado nulo.

                                                            --PDA 108070 (FIM)

                                                            -- pda 119975 - 29/05/2005 - Amalia Ara??

                                                            -- par?tro de fator relacionado para insert nas tabelas itreg_amb e itreg_fat

                                                           ,

                                                            Vcrelacionados.Qt_Lancamento

                                                            -- pda 119975 - fim

                                                            );

              -- PDA 189031 Inicio

              UPDATE Dbamv.Itreg_Fat

                 SET Cd_Setor_Produziu = v_Mvto.Cd_Setor_Set_Exa

               WHERE Cd_Reg_Fat = Ncdregfat

                 AND Cd_Lancamento = Ncdlctoupdate;

              -- PDA 189031 Fim

            END LOOP;

          END;

          /* PDA 145551 - Rodrigo Valentim - HSR (INICIO)

          * Rotina de cobran?de incid?ia de exames.

          * Rotina realizada para Ambulatorio

          */

          IF Nvl(Nsnincidenciaexame, 'N') = 'S' THEN

            DECLARE

              CURSOR Crelacionados IS

                SELECT Rela.Cd_Pro_Fat,

                       Rela.Tp_Atend_Homecare,

                       Rela.Tp_Atend_Externo,

                       Rela.Tp_Atend_Urgeme,

                       Rela.Tp_Atend_Ambulatorial,

                       Rela.Tp_Atend_Internacao

                       --PDA 108042 22/11/2004 Sp?ola (INICIO)

                       --Inserida a coluna qt_lancamento que ir?ultiplicar a quantidade na rotina Dbamv.lanca_ffcv_pro_relacionados

                      ,

                       1 Qt_Lancamento

                --PDA 108042 (FIM)

                  FROM Dbamv.Con_Pla,

                       Dbamv.Regra,

                       Dbamv.Val_Pro_Relacionado Rela,

                       Dbamv.Empresa_Con_Pla /* PDA 118607/131598 */

                        ,dbamv.pro_fat             -- OP 32555 *2

                 WHERE Empresa_Con_Pla.Cd_Convenio = Con_Pla.Cd_Convenio /* PDA 118607/131598 */

                   AND Empresa_Con_Pla.Cd_Con_Pla = Con_Pla.Cd_Con_Pla /* PDA 118607/131598 */

                   AND Empresa_Con_Pla.Cd_Multi_Empresa =

                       Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/131598 */



					 -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

                     --AND Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat

					 and ( ( rela.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = rela.cd_pro_fat and Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					    or ( rela.cd_pro_fat_pai is null and rela.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                             AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

					     )

				     -- OP 32555 - fim



                   AND Con_Pla.Cd_Convenio = v_Mvto.Cd_Convenio

                   AND Con_Pla.Cd_Con_Pla = v_Mvto.Cd_Con_Pla

                   AND Rela.Tp_Lancamento = 'A'

                      -- PDA 145551 (Inicio) SO DEVERA LANCAR SE ESTIVER MARCADO COMO INCIDENCIA

                   AND Rela.Sn_Incidencia_Exame = 'S'

                      -- PDA 145551 (Fim)

                      --PDA 114239 17/01/2005 Sp?ola (INICIO)

                      --Incluida verifica? por tipo de atendimento para os procedimentos relacionados

                   AND ((v_Mvto.Tp_Atendimento = 'H' AND

                       Rela.Tp_Atend_Homecare = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'E' AND

                       Rela.Tp_Atend_Externo = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'U' AND

                       Rela.Tp_Atend_Urgeme = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'A' AND

                       Rela.Tp_Atend_Ambulatorial = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'I' AND

                       Rela.Tp_Atend_Internacao = 'S'))

                      --PDA 114239 (FIM)

                      /* pda 407641 - thiago miranda de oliveira*/

                      --AND con_pla.cd_regra = regra.cd_regra

                   AND Empresa_Con_Pla.Cd_Regra = Regra.Cd_Regra

                      /* fim pda 407641*/

                   AND Rela.Cd_Regra = Regra.Cd_Regra

                      --PDA 97407 - Eduardo Santis 08/07/2004 - (Inicio)

                   AND Dt_Vigencia IN

                       (SELECT MAX(Vpr.Dt_Vigencia)

                          FROM Dbamv.Val_Pro_Relacionado Vpr

                         WHERE Vpr.Dt_Vigencia <= v_Mvto.Dt_Pedido

                              -- PDA 105921 (In?o) - 14/09/2004 - Pollyane K. A. Nunes

                              -- Inclui a verifica? da vig?ia por regra e procedimento

                           AND Vpr.Cd_Regra = Rela.Cd_Regra

                             -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

					         -- AND Vpr.Cd_Pro_Fat_Pai = Rela.Cd_Pro_Fat_Pai

					         -- AND Vpr.Cd_Pro_Fat = Rela.Cd_Pro_Fat

					         and ( ( Vpr.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = Vpr.cd_pro_fat and Vpr.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					            or ( Vpr.cd_pro_fat_pai is null and Vpr.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                                     AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

						          )

						     -- OP 32555 - fim

						   );

              -- PDA 105921 -- (Fim)

              --PDA 97407 - Eduardo Santis 08/07/2004 - (Fim)

              Cretorno       VARCHAR2(1);

              Vcrelacionados Crelacionados%ROWTYPE;

            BEGIN

              FOR Vcrelacionados IN Crelacionados

              LOOP

                -- PDA 189031 Inicio

                OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncdregfat);

                FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                  INTO Ncdlctoupdate;

                CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

                -- PDA 189031 Fim

                Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(v_Mvto.Cd_Atendimento,

                                                              Ncdregamb,

                                                              Ncdlcto,

                                                              Ncdpedrx,

                                                              v_Proced.Cd_Pro_Fat,

                                                              v_Mvto.Dt_Pedido

                                                              /*PDA 116436 14/03/2005 Sp?ola (INICIO)

                                                                                                                         A hora de lancamento deve ser semelhando ao do insert na itreg_amb*/,

                                                              Nvl(Hrlancamento,

                                                                  Ddtrealiznew)

                                                              /*PDA 116436 (FIM)*/,

                                                              v_Mvto.Cd_Setor,

                                                              'P',

                                                              v_Mvto.Tp_Atendimento,

                                                              v_Mvto.Dt_Atendimento,

                                                              Ncdconvconta,

                                                              Ncdplanconta,

                                                              v_Mvto.Cd_Atendimento_Pai,

                                                              v_Mvto.Tp_Convenio,

                                                              v_Mvto.Dt_Alta,

                                                              Vcrelacionados.Cd_Pro_Fat,

                                                              1,

                                                              0,

                                                              'I',

                                                              Nprestador,

                                                              1);

                -- PDA 189031 Inicio

                UPDATE Dbamv.Itreg_Fat

                   SET Cd_Setor_Produziu = v_Mvto.Cd_Setor_Set_Exa

                 WHERE Cd_Reg_Fat = Ncdregfat

                   AND Cd_Lancamento = Ncdlctoupdate;

                -- PDA 189031 Fim

              END LOOP;

            END;

          END IF;

          /* PDA 145551 - Rodrigo Valentim - HSR (FIM)

          * Rotina de cobran?de incid?ia de exames.

          */

          --PDA 108042 (FIM)

        END IF;

      END IF;

    END IF;

  EXCEPTION

    WHEN Atend_Sem_Conta THEN

      Gera_Log_Falha(Ncdregfat -- PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500  --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                     --                      ,ncdpedrx      -- PDA 159898

                     --                      ,ncditpedrx    -- PDA 159898

                    ,

                     Npedrx -- PDA 159898

                    ,

                     Nitnrx -- PDA 159898

                    ,

                     v_Proced.Cd_Pro_Fat

                     --                      ,'Imagem'      -- PDA 159898

                    ,

                     Vmeio -- PDA 159898

                    ,

                     '04'

                     --,'Atendimento ' || v_mvto.cd_atendimento || ' n?possui conta aberta/dispon?l'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_4',

                                                       'PACK_LANCA_FFCV',

                                                       'Atendimento %s n?possui Conta aberta/disponivel.',

                                                       Arg_List(v_Mvto.Cd_Atendimento)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtrealiznew);

    WHEN Fora_Da_Conta THEN

      Gera_Log_Falha(Ncdregfat -- PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                     --                      ,ncdpedrx      -- PDA 159898

                     --                      ,ncditpedrx    -- PDA 159898

                    ,

                     Npedrx -- PDA 159898

                    ,

                     Nitnrx -- PDA 159898

                    ,

                     v_Proced.Cd_Pro_Fat

                     --                      ,'Imagem'      -- PDA 159898

                    ,

                     Vmeio -- PDA 159898

                    ,

                     '08'

                     --,'Procedimento com proibi? tipo Fora da Conta'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_8',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento com proibi? tipo Fora da Conta.',



                                                       Arg_List()) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtrealiznew);

    WHEN Prod_Nao_Conf THEN

      Gera_Log_Falha(Ncdregfat -- PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                     --                      ,ncdpedrx      -- PDA 159898

                     --                      ,ncditpedrx    -- PDA 159898

                    ,

                     Npedrx -- PDA 159898

                    ,

                     Nitnrx -- PDA 159898

                    ,

                     v_Proced.Cd_Pro_Fat

                     --                      ,'Imagem'      -- PDA 159898

                    ,

                     Vmeio -- PDA 159898

                    ,

                     '01'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_17',

                                                       'PACK_LANCA_FFCV',

                                                       'Exame de Diagnostico por Imagem n?tem relacionamento com Faturamento de Convenio.',

                                                       Arg_List()) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtrealiznew);

    WHEN Setor_Nao_Conf THEN

      Gera_Log_Falha(Ncdregfat -- PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                     --                      ,ncdpedrx      -- PDA 159898

                     --                      ,ncditpedrx    -- PDA 159898

                    ,

                     Npedrx -- PDA 159898

                    ,

                     Nitnrx -- PDA 159898

                    ,

                     v_Proced.Cd_Pro_Fat

                     --                      ,'Imagem'      -- PDA 159898

                    ,

                     Vmeio -- PDA 159898

                    ,

                     '02'

                     --,'Grupo de Procedimento ' || v_proced.cd_gru_pro || ' n?tem Grupo de Faturamento relacionado'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_14',

                                                       'PACK_LANCA_FFCV',

                                                       'Grupo de Procedimento %s n?tem Grupo de Faturamento relacionado.',



                                                       Arg_List(v_Proced.Cd_Gru_Pro)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtrealiznew);

    WHEN Proc_Proibido THEN

      Gera_Log_Falha(Ncdregfat -- PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                     --                      ,ncdpedrx      -- PDA 159898

                     --                      ,ncditpedrx    -- PDA 159898

                    ,

                     Npedrx -- PDA 159898

                    ,

                     Nitnrx -- PDA 159898

                    ,

                     v_Proced.Cd_Pro_Fat

                     --                      ,'Imagem'      -- PDA 159898

                    ,

                     Vmeio -- PDA 159898

                    ,

                     '05'

                     --,'Procedimento proibido para o Convenio ' || LTRIM (TO_CHAR (v_conta.cd_convenio)) || ' e Plano ' || LTRIM (TO_CHAR (v_conta.cd_con_pla)) --PDA 157595

                     --,'Procedimento proibido para o Convenio ' || LTRIM (TO_CHAR (nCdConvConta)) || ' e Plano ' || LTRIM (TO_CHAR (nCdPlanConta)) --PDA 157595

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_7',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento proibido para o Convenio %s e Plano %s.',

                                                       Arg_List(Ltrim(To_Char(Ncdconvconta)),

                                                                Ltrim(To_Char(Ncdplanconta)))) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtrealiznew);



	-- OP 32555

    WHEN Proc_Proibido_idade THEN

	  -- OP 33697 - 05/10/2015 - Substituindo Gera_Log_Falha por Raise_Application_Error.

      Raise_Application_Error(-20054, Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20','PACK_LANCA_FFCV',

                                'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                Arg_List(v_Proced.Cd_Pro_Fat)));

      /*Gera_Log_Falha(Ncdregfat,

                     Ncdregamb,

                     Npedrx,

                     Nitnrx ,

                     v_Proced.Cd_Pro_Fat,

                     Vmeio ,

                     '05',

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                                       Arg_List(v_Proced.Cd_Pro_Fat))

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtrealiznew);*/





	 WHEN Auditoria_In_Loco THEN

      Gera_Log_Falha(Ncdregfat -- PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL

                     --                      ,ncdpedrx      -- PDA 159898

                     --                      ,ncditpedrx    -- PDA 159898

                    ,

                     Npedrx -- PDA 159898

                    ,

                     Nitnrx -- PDA 159898

                    ,

                     v_Proced.Cd_Pro_Fat

                     --                      ,'Imagem'      -- PDA 159898

                    ,

                     Vmeio -- PDA 159898

                    ,

                     '10'

                     --,'O periodo da conta ' || v_conta.cd_reg_fat || ' est?m auditoria in-loco no momento do lan?ento' --PDA 157595

                     --,'O periodo da conta ' || nCdRegFat || ' est?m auditoria in-loco no momento do lan?ento' --PDA 157595

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_15',

                                                       'PACK_LANCA_FFCV',

                                                       'O periodo da conta %s est?m auditoria in-loco no momento do lan?ento.',

                                                       Arg_List(Ncdregfat)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtrealiznew);

  END;



  PROCEDURE Lanca_Pssd_Ffcv(Ncdpedlab    IN NUMBER,

                            Ncdexalab    IN NUMBER,

                            Ddtrealiznew IN DATE,

                            Ddtrealizold IN DATE,

                            Ncditemmvto  IN NUMBER,

                            Nitsetexa    IN NUMBER,

                            Nitmedexe    IN NUMBER) IS

    --************************************ acrescentado no PDA 76175 : par?tro Cd_Set_Exa

    CURSOR c_Config IS

      SELECT Config_Ffcv.Sn_Sadt_Automatica,

             Config_Ffcv.Cd_Convenio_Fat_Extra,

             Config_Ffcv.Cd_Ati_Med_Clinico,

             Config_Ffcv.Cd_Con_Pla_Fat_Extra,

             Config_Ffcv.Tp_Controle_Lote,

             Config_Ffcv.Sn_Checa_Preco_Lcto,

             Config_Ffcv.Tp_Prestador_Pssd,

             Config_Ffcv.Sn_Guia_Proc_Auto

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    CURSOR c_Proced IS

      SELECT Exa_Lab.Cd_Pro_Fat,

             Gru_Pro.Cd_Gru_Fat,

             Pro_Fat.Cd_Gru_Pro,

             Exa_Lab.Cd_Exa_Lab

        FROM Dbamv.Exa_Lab,

             Dbamv.Pro_Fat,

             Dbamv.Gru_Pro

       WHERE Exa_Lab.Cd_Exa_Lab = Ncdexalab

         AND Pro_Fat.Cd_Pro_Fat(+) = Exa_Lab.Cd_Pro_Fat

         AND Gru_Pro.Cd_Gru_Pro = Pro_Fat.Cd_Gru_Pro;

    --************************************ acrescentado no PDA 76175

    /* pda 460114 - 457450 - adicionando parametro de entrada*/

    CURSOR c_Set_Exa(Pnset IN NUMBER) IS

      SELECT Set_Exa.Cd_Prestador,

             Set_Exa.Cd_Setor,

             Set_Exa.Cd_Set_Exa

			 , set_exa.TP_ORIGEM_PREST_FAT -- OP 32444

        FROM Dbamv.Set_Exa

       WHERE Set_Exa.Cd_Set_Exa = Pnset;

    v_Set_Exa c_Set_Exa%ROWTYPE;

    --************************************ acrescentado no PDA 76175

    /* pda 460114 - 457450 - adicionando parametros na funcao*/

    CURSOR c_Mvto(Pnprestador IN NUMBER, Pnset IN NUMBER, Pnsetexa IN NUMBER) IS

      SELECT NVL(Atendime.CD_ATENDIMENTO_ORIGINAL,Ped_Lab.Cd_Atendimento ) Cd_Atendimento,

             To_Date(To_Char(Ped_Lab.Dt_Pedido, 'dd/mm/yyyy') ||

                     To_Char(Ped_Lab.Hr_Ped_Lab, 'hh24:mi'),

                     'dd/mm/yyyy hh24:mi') Dt_Pedido,

             Ped_Lab.Hr_Ped_Lab Hr_Pedido,

             Ped_Lab.Cd_Setor,

             Nvl(Pnsetexa, Ped_Lab.Cd_Set_Exa) Cd_Set_Exa,

             Nvl(Pnprestador, Set_Exa.Cd_Prestador) Cd_Prestador_Exa,

             Nvl(Pnprestador, Ped_Lab.Cd_Prestador) Cd_Prestador_Lab,

             Nvl(Nitmedexe, Ped_Lab.Cd_Prestador_Resp) Cd_Prestador_Resp,

			 ped_lab.cd_prestador cd_prest_lab,

             Nvl(atendime2.Tp_Atendimento, Atendime.Tp_Atendimento) Tp_Atendimento,

             Nvl(Pnset, Set_Exa.Cd_Setor) Cd_Setor_Set_Exa,

             Nvl(atendime2.Cd_Atendimento_Pai, Atendime.Cd_Atendimento_Pai) Cd_Atendimento_Pai,

             Nvl(atendime2.Sn_Importa_Auto, Atendime.Sn_Importa_Auto) Sn_Importa_Auto,

             Nvl(Ped_Lab.Cd_Convenio, Atendime.Cd_Convenio) Cd_Convenio,

             Nvl(Ped_Lab.Cd_Con_Pla, Atendime.Cd_Con_Pla) Cd_Con_Pla,

             Convenio.Tp_Convenio,

             Nvl(atendime2.Cd_Tip_Acom, Atendime.Cd_Tip_Acom) Cd_Tip_Acom,

             Nvl(atendime2.Cd_Convenio_Secundario, Atendime.Cd_Convenio_Secundario) Cd_Convenio_Secundario,

             Nvl(atendime2.Cd_Con_Pla_Secundario, Atendime.Cd_Con_Pla_Secundario) Cd_Con_Pla_Secundario,

             To_Date(To_Char(Nvl(atendime2.Dt_Atendimento, Atendime.Dt_Atendimento), 'DD/MM/YYYY') || ' ' ||

                     To_Char(Nvl(atendime2.Hr_Atendimento, Atendime.Hr_Atendimento), 'HH24:Mi:SS'),

                     'DD/MM/YYYY HH24:MI:SS') Dt_Atendimento,

             Nvl(atendime2.Hr_Atendimento, Atendime.Hr_Atendimento) Hr_Atendimento,

             To_Date(To_Char(NVL(atendime2.Dt_Alta, Atendime.Dt_Alta), 'dd/mm/yyyy') ||

                     To_Char(NVL(atendime2.Hr_Alta,Atendime.Hr_Alta), 'hh24:mi'),

                     'dd/mm/yyyy hh24:mi') Dt_Alta,

             NVL(atendime2.Cd_Ori_Ate, Atendime.Cd_Ori_Ate) Cd_Ori_Ate

        FROM Dbamv.Ped_Lab,

             Dbamv.Atendime,

             Dbamv.Atendime atendime2, -- FATURCONV-1386 // LPDO

             Dbamv.Set_Exa,

             Dbamv.Convenio,

             Dbamv.Empresa_Convenio

       WHERE Ped_Lab.Cd_Ped_Lab = Ncdpedlab

         AND Convenio.Cd_Convenio = Empresa_Convenio.Cd_Convenio /* PDA 118607/129023*/

         AND Empresa_Convenio.Cd_Multi_Empresa =

             Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/129023*/

         AND Atendime.Cd_Atendimento = Ped_Lab.Cd_Atendimento

         AND atendime.cd_atendimento_original = atendime2.CD_ATENDIMENTO(+)

         AND Ped_Lab.Cd_Set_Exa = Set_Exa.Cd_Set_Exa(+)

         AND Convenio.Cd_Convenio =

             Nvl(Ped_Lab.Cd_Convenio, Atendime.Cd_Convenio)

         AND Convenio.Tp_Convenio IN ('H', 'P', 'C')

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;



    CURSOR c_Grfasetorexame(Ngrpr IN NUMBER, Nsetor IN NUMBER) IS

      SELECT Setor_Gru_Fat.Cd_Gru_Fat

        FROM Dbamv.Setor_Gru_Fat

       WHERE Setor_Gru_Fat.Cd_Setor = Nsetor

         AND Setor_Gru_Fat.Cd_Gru_Pro = Ngrpr;



    CURSOR c_Itreg_Fat_Pssd(Nconta IN Dbamv.Itreg_Fat.Cd_Reg_Fat%TYPE /*NUMBER PDA 254997*/

    , Cprofat IN VARCHAR2, Ppedido IN NUMBER) IS

      SELECT Itreg_Fat.Cd_Lancamento,

             Itreg_Fat.Qt_Lancamento

             -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

            ,

             Itreg_Fat.Cd_Reg_Fat

      -- PDA 167142 (Fim)

        FROM Dbamv.Itreg_Fat

       WHERE Itreg_Fat.Cd_Reg_Fat = Nconta

         AND Itreg_Fat.Cd_Pro_Fat = Cprofat

         AND Itreg_Fat.Cd_Mvto = Ppedido

         AND Itreg_Fat.Tp_Mvto = 'SADT'

            -- PDA 246259 (Inicio) - Henrique Antunes - 29/08/2008

         AND (Itreg_Fat.Cd_Itmvto = Ncditemmvto OR Ncditemmvto IS NULL)

      -- PDA 246259 (Fim)

      -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

      UNION

      SELECT Itreg_Fat.Cd_Lancamento,

             Itreg_Fat.Qt_Lancamento,

             Itreg_Fat.Cd_Reg_Fat

        FROM Dbamv.Itreg_Fat

       WHERE Itreg_Fat.Cd_Conta_Pai = Nconta

         AND Itreg_Fat.Cd_Pro_Fat = Cprofat

         AND Itreg_Fat.Cd_Mvto = Ppedido

         AND Itreg_Fat.Tp_Mvto = 'SADT'

            --ORDER BY itreg_fat.qt_lancamento DESC;

            -- PDA 246259 (Inicio) - Henrique Antunes - 29/08/2008

         AND (Itreg_Fat.Cd_Itmvto = Ncditemmvto OR Ncditemmvto IS NULL)

      -- PDA 246259 (Fim)

       ORDER BY 2 DESC;

    -- PDA 167142 (Fim)

    CURSOR c_Itreg_Amb_Pssd(Nconta IN Dbamv.Itreg_Amb.Cd_Reg_Amb%TYPE /*NUMBER PDA 254997*/

    , Cprofat IN VARCHAR2, Natend IN NUMBER, Pcd_Mvto NUMBER DEFAULT NULL) IS

      SELECT Itreg_Amb.Cd_Lancamento,

             Itreg_Amb.Qt_Lancamento

        FROM Dbamv.Itreg_Amb

       WHERE Itreg_Amb.Cd_Reg_Amb = Nconta

         AND Itreg_Amb.Cd_Pro_Fat = Cprofat

         AND Itreg_Amb.Cd_Atendimento = Natend

         AND Itreg_Amb.Cd_Mvto = Nvl(Pcd_Mvto, Itreg_Amb.Cd_Mvto)

            -- PDA 246259 (Inicio) - Henrique Antunes - 29/08/2008

         AND (Itreg_Amb.Cd_Itmvto = Ncditemmvto OR Ncditemmvto IS NULL)

            -- PDA 246259 (Fim)

         AND Itreg_Amb.Tp_Mvto = 'SADT'

         AND Itreg_Amb.Sn_Fechada = 'N'

       ORDER BY Itreg_Amb.Qt_Lancamento DESC;

    --PDA 99802 09/07/2004 Sp?ola (INICIO)

    --Cursor para coletar dados de atendimento ambulatorial por sess?para o atendimento pai

    CURSOR Catendsessao(Pncdatedimento IN NUMBER --N??o do atendimento de sessao filho

    ) IS

      SELECT Nvl(Atendime_Sessao.Sn_Retorno, 'N') Sn_Retorno,

             Nvl(Atendime.Qt_Sessoes, 0) Qt_Sessoes,

             Atendime_Sessao.Dt_Atendimento Dt_Atendimento

        FROM Dbamv.Atendime Atendime,

             Dbamv.Atendime Atendime_Sessao

       WHERE Atendime_Sessao.Cd_Atendimento = Pncdatedimento

         AND Atendime_Sessao.Cd_Atendimento_Pai = Atendime.Cd_Atendimento

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    --PDA 99802 (FIM)

    --PDA 212965(INICIO)

    CURSOR Cfatfilho(Ncdregfat IN Dbamv.Itreg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/

    , Ncdlcto IN Dbamv.Itreg_Fat.Cd_Lancamento%TYPE /*number pda 254997*/

    ) IS

      SELECT Cd_Reg_Fat,

             Cd_Reg_Fat_Pai,

             Cd_Lancamento_Pai

        FROM Dbamv.Itreg_Fat

       WHERE Cd_Reg_Fat_Pai = Ncdregfat

         AND Cd_Lancamento_Pai = Ncdlcto;

    CURSOR Cfatfechada(Ncdregfat IN Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/

    ) IS

      SELECT Sn_Fechada

        FROM Dbamv.Reg_Fat

       WHERE Cd_Reg_Fat = Ncdregfat;

    CURSOR Cambfilho(Ncdregamb IN Dbamv.Itreg_Amb.Cd_Reg_Amb_Pai%TYPE /*number pda 254997*/

    , Patend IN NUMBER, Ncdlcto IN Dbamv.Itreg_Fat.Cd_Lancamento_Pai%TYPE /*number pda 254997*/

    ) IS

      SELECT Cd_Reg_Amb_Pai,

             Cd_Lancamento_Pai,

             Sn_Fechada,

             Cd_Atendimento

        FROM Dbamv.Itreg_Amb

       WHERE Cd_Reg_Amb_Pai = Ncdregamb

         AND Cd_Lancamento_Pai = Ncdlcto

         AND Cd_Atendimento = Patend;

    /*PDA.: 449578 - 448122 - 11/07/2011 - Emanoel Deivison (inicio)

      Descri?: Verificar se o lan?ento do PSSD est?endo no momento do Pedido (S) ou no Resultado do Laudo (N).

    */

    CURSOR c_Configfaturamentopssd IS

      SELECT Config_Ffcv.Sn_Pssd_Pedido

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    Vc_Configfaturamentopssd c_Configfaturamentopssd%ROWTYPE;

    /*PDA.: 449578 - 448122 - 11/07/2011 - Emanoel Deivison (fim)*/



    /*OP 41394*/

      CURSOR cProced(pProFat IN VARCHAR2) IS

      SELECT pro_fat.cd_gru_pro

        FROM dbamv.pro_fat

      WHERE pro_fat.cd_pro_fat = pProFat;





  CURSOR cRregra(pConvenio IN NUMBER ,

                  pPlano IN NUMBER) IS

    SELECT p.cd_regra

    FROM dbamv.empresa_con_pla p,

        dbamv.empresa_convenio c

    WHERE p.cd_convenio = c.cd_convenio

      AND p.cd_con_pla  = pPlano

      AND c.cd_convenio = pConvenio

      AND c.cd_multi_empresa = DBAMV.PKG_MV2000.LE_EMPRESA;

  /*OP 41394*/



	--FATURCONV-2931 BEG

	CURSOR cEmpresaAtendime IS

	SELECT ATENDIME.CD_MULTI_EMPRESA

      FROM DBAMV.PED_LAB,

		   DBAMV.ATENDIME

     WHERE PED_LAB.CD_ATENDIMENTO = ATENDIME.CD_ATENDIMENTO

       AND PED_LAB.CD_PED_LAB = Ncdpedlab;



	vEmpresaAtendime cEmpresaAtendime%ROWTYPE;

	vCdEmpresaAtual dbamv.atendime.cd_multi_empresa%type;

	--FATURCONV-2931 END



    Vfatfilho   Cfatfilho%ROWTYPE;

    Vfatfechada Cfatfechada%ROWTYPE;

    Vambfilho   Cambfilho%ROWTYPE;

    --PDA 212965(FIM)

    Vcatendsessao Catendsessao%ROWTYPE; --PDA 99802

    Prod_Nao_Conf EXCEPTION;

    Setor_Nao_Conf EXCEPTION;

    Proc_Sem_Preco EXCEPTION;

    Atend_Sem_Conta EXCEPTION;

    Proc_Proibido EXCEPTION;

	proc_proibido_idade  exception;   -- OP 32555

    Auditoria_In_Loco EXCEPTION;

    Fora_Da_Conta EXCEPTION;

    v_Config c_Config%ROWTYPE;

    v_Proced c_Proced%ROWTYPE;

    v_Mvto   c_Mvto%ROWTYPE;

    --PDA 157595(INICIO) 14/04/2008 - Jansen Gallindo

    --v_conta              dbamv.pack_lanca_ffcv.c_conta%ROWTYPE;

    v_Conta Dbamv.Pkg_Ffcv_Conta.Tpconta;

    --v_contaambu          dbamv.pack_lanca_ffcv.c_contaambu%ROWTYPE;

    v_Contaambu Dbamv.Pkg_Ffcv_Conta.Tpcontaambu;

    --v_contapartambu      dbamv.pack_lanca_ffcv.c_contapartambu%ROWTYPE;

    v_Contapartambu Dbamv.Pkg_Ffcv_Conta.Tpcontapartambu;

    --v_contapart          dbamv.pack_lanca_ffcv.c_contapart%ROWTYPE;

    --PDA 157595(FIM) 14/04/2008 - Jansen Gallindo

    v_Itregfat Dbamv.Pack_Lanca_Ffcv.c_Itregfat%ROWTYPE;

    v_Itregamb Dbamv.Pack_Lanca_Ffcv.c_Itregamb%ROWTYPE;

    v_Forapre  Dbamv.Pack_Lanca_Ffcv.c_Forapre%ROWTYPE;

    v_forapreatimed dbamv.pack_lanca_ffcv.c_forapreatimed%rowtype; -- op 38143

    vccdatimed      varchar2(2); -- op 38143

    -- pda 96511 - 23/06/2004 - Amalia Ara??

    Vcgabaritohosp   Dbamv.Pack_Lanca_Ffcv.Cgabaritohosp%ROWTYPE;

    Vcitgabaritohosp Dbamv.Pack_Lanca_Ffcv.Citgabaritohosp%ROWTYPE;

    Vcquantgabarito  Dbamv.Pack_Lanca_Ffcv.Cquantgabarito%ROWTYPE;

    -- pda 96511 - fim

    Nqtprofat          Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Ndiferenca         NUMBER;

    Ncdlcto            Dbamv.Itreg_Fat.Cd_Lancamento%TYPE /*number pda 254997*/

    ;

    Csnpacote          VARCHAR2(1);

    Binsert            BOOLEAN;

    Ctpproibicao       VARCHAR2(2);

    Ncdgrufat          NUMBER;

    Nqtautorizado      NUMBER;

    Ncdguia            NUMBER;

    Bpartic            BOOLEAN := FALSE;

    Ncdregfat          Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/

    ;

    Nprestador         NUMBER;

    Nqtregrateio       NUMBER;

    Ncdlfa             NUMBER;

    Bexclui            BOOLEAN := FALSE;

    Ncdregamb          Dbamv.Reg_Amb.Cd_Reg_Amb%TYPE /*number pda 254997*/

    ;

    Csnpgconv          VARCHAR2(1);

    Ctppgto            VARCHAR2(1);

    Ncdconvconta       NUMBER;

    Ncdplanconta       Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*number pda 254997*/

    ;

    Csnhoresp          VARCHAR2(1);

    Ntpvinculo         VARCHAR2(1);

    Inserting          BOOLEAN := TRUE;

    Nqtpart            Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Nqtconv            Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Nqtlivre           NUMBER;

    v_Qtdexistente_Amb NUMBER;

    v_Qtdexistente_Fat NUMBER;

    Totallancado       NUMBER;

    Limite             NUMBER := 0;

    Bexistepreco       BOOLEAN := TRUE;

    Cmensret           VARCHAR2(2000);

    -- PDA 96161 -- Alexandre Erik C. M. Costa 25/05/2004

    -- Declara? de vari?is

    Nqtdguia      NUMBER;

    Nguiapendente Dbamv.Guia.Cd_Guia%TYPE; -- pda 145435 - 24/03/2006 - Jose Roberto

    Ncdguiaitem   Dbamv.Guia.Cd_Guia%TYPE; /* pda 141006 */

    -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

    Ncdconta  Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE;

    Ncdpacote Dbamv.Conta_Pacote.Cd_Conta_Pacote%TYPE;

    Csnguia   VARCHAR2(1) := 'N';

    -- PDA 157145 (Fim)

    Vsnchecapreconolcto VARCHAR2(01); -- PDA 175957 - 16/03/2007 - Pedro Neiva(Apply)

    --

    Ncdlctoupdate Dbamv.Itreg_Fat.Cd_Lancamento%TYPE /*number pda 254997*/

    ; -- PDA 189031 Inicio/Fim

    Ddthraux      DATE; -- PDA 221500 - 27/03/2008 - Diego Costa

    Nqtexcedeu    NUMBER := NULL; -- OP 387

    Vtpcontapart  Dbamv.Itreg_Fat.Tp_Mvto%TYPE := NULL; -- OP 387

    Nconta        NUMBER := NULL; -- OP 387

    Nlanc         NUMBER := NULL; -- OP 387

    vTemRegraCriaContaAuto BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnCriouContaAuto      BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnCriouContaAutoAmb   BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vRegraCriaContaAuto    Dbamv.Pkg_Ffcv_Conta.TpContaAutomatica; /*OP 35916 - regra para cria? autom?ca de conta*/

    vRegraCriaContaAutoHE    Dbamv.Pkg_Ffcv_Conta.TpContaAutomatica; /*OP 41394*/

    vSnReplicaProcHe dbamv.pack_lanca_ffcv.cSnReplicaProcHe%ROWTYPE; /*OP 41394*/

    vSnReplicaProc   VARCHAR2(1);                                    /*OP 41394*/

    vRregra cRregra%ROWTYPE;                                         /*OP 41394*/

    vNlsBanco VARCHAR2(50);                                          /*OP 41394*/

    vProced   cProced%ROWTYPE;                                       /*OP 41394*/

    v_ContaCargoPac        Dbamv.Pkg_Ffcv_Conta.Tpconta;     /*ALLS OP 42241 */

    v_ContaCargoPacAmbu    Dbamv.Pkg_Ffcv_Conta.Tpcontaambu; /*ALLS OP 42241 */

    vRegraCriaContaAutoCP  Dbamv.Pkg_Ffcv_Conta.TpContaAutomaticaCP; /*ALLS OP 42241* - regra para cria? autom?ca de conta referente a Cargo Paciente*/

    vSnCargoPaciente       Dbamv.Pack_Lanca_Ffcv.cSnCargoPaciente%ROWTYPE; /*ALLS OP 42241*/

    vSnCriouContaAutoCP    BOOLEAN := FALSE; /*ALLS OP 42241 */

    vSnCriouContaAutoAmbCP BOOLEAN := FALSE; /*ALLS OP 42241 */

    NcdlctoCp              NUMBER  ; /*ALLS OP 42241 */

    NcdlctoAmbCp           NUMBER  ; /*ALLS OP 42241 */

    pEmpresa               NUMBER := Pkg_Mv2000.Le_Empresa;/*43289*/

    pvSnJaExcedeuQtd      Varchar2(1):= 'N'; /*43289*/

    pvMensagem             VARCHAR2(2000);    /*43289*/

    pSnChamadoDaTela       VARCHAR2(1) := 'N';       /*43289*/



  BEGIN

    --FATURCONV-2931 BEG

	OPEN cEmpresaAtendime;

	FETCH cEmpresaAtendime INTO VEmpresaAtendime;

	CLOSE cEmpresaAtendime;



	vCdEmpresaAtual := dbamv.pkg_mv2000.le_empresa;

	if(vCdEmpresaAtual <> VEmpresaAtendime.CD_MULTI_EMPRESA) then

		dbamv.pkg_mv2000.atribui_empresa(VEmpresaAtendime.CD_MULTI_EMPRESA);

	end if;

	--FATURCONV-2931 END

	--

    IF Ddtrealizold IS NULL AND Ddtrealiznew IS NOT NULL THEN

      Bexclui := FALSE;

    ELSIF Ddtrealizold IS NOT NULL AND Ddtrealiznew IS NULL THEN

      Bexclui   := TRUE;

      Inserting := FALSE;

    ELSE

      RETURN;

    END IF;

    OPEN c_Config;

    FETCH c_Config

      INTO v_Config;

    CLOSE c_Config;

    OPEN c_Proced;

    FETCH c_Proced

      INTO v_Proced;

    CLOSE c_Proced;

    /* pda 460114 - 457450 - adicionando parametro para a consulta do cursor*/

    v_Set_Exa := NULL;

    OPEN c_Set_Exa(Nitsetexa);

    FETCH c_Set_Exa

      INTO v_Set_Exa;

    CLOSE c_Set_Exa;

    OPEN c_Mvto(v_Set_Exa.Cd_Prestador,

                v_Set_Exa.Cd_Setor,

                v_Set_Exa.Cd_Set_Exa);

    FETCH c_Mvto

      INTO v_Mvto;

    CLOSE c_Mvto;

    /* fim pda 460114 - 457450*/

    -- pda 254202(Incio) - Pedro Neiva - 15/10/2008

    -- Compara a data de referncia com a data de atendimento, se a data de referncia for menor,

    -- ento utiliza a data de atendimento, para evitar item lanados fora da conta.

    Ddthraux := To_Date(To_Char(v_Mvto.Dt_Pedido, 'DD/MM/YYYY') || ' ' ||

                        To_Char(Nvl(v_Mvto.Hr_Pedido, v_Mvto.Dt_Pedido),

                                'HH24:MI:SS'),

                        'DD/MM/YYYY HH24:MI:SS');

    IF Ddthraux < v_Mvto.Dt_Atendimento THEN

      Ddthraux := v_Mvto.Dt_Atendimento;

    END IF;

    IF Ddthraux > v_Mvto.Dt_Alta THEN

      Ddthraux := v_Mvto.Dt_Alta;

    END IF;

    -- pda 254202(Fim)



	if dbamv.fnc_ffcv_proibicao_idade( v_mvto.cd_atendimento, v_mvto.cd_convenio, v_mvto.cd_con_pla, v_proced.cd_pro_fat ) <> 'OK' then

	  raise proc_proibido_idade;

	end if;

	-- OP 32555 - fim



/* OP 38292 (Inicio)

    OPEN Dbamv.Pack_Lanca_Ffcv.c_Proibicao(v_Proced.Cd_Pro_Fat,

                                           v_Mvto.Cd_Convenio,

                                           v_Mvto.Cd_Con_Pla,

                                           v_Mvto.Tp_Atendimento,

                                           v_Mvto.Dt_Pedido,

                                           v_Mvto.Cd_Setor);

    FETCH Dbamv.Pack_Lanca_Ffcv.c_Proibicao

      INTO Ctpproibicao;

    CLOSE Dbamv.Pack_Lanca_Ffcv.c_Proibicao;

    */

     Ctpproibicao := dbamv.pack_ffcv_proibicao.fnc_ffcv_proibicao(v_Proced.Cd_Pro_Fat,

                                              v_Mvto.Cd_Convenio,

                                              v_Mvto.Cd_Con_Pla,

                                              v_Mvto.Tp_Atendimento,

                                              v_Mvto.Dt_Pedido,

                                              v_Mvto.Cd_Setor,

                                                                 v_mvto.cd_atendimento,

                                                                 NULL);

      -- OP 38292 (Fim)





    IF Ctpproibicao = 'FC' THEN

      RAISE Fora_Da_Conta;

    END IF;

    /*PDA.:449578 -  448122 - 11/07/2011 - Emanoel Deivison (inicio)



                 Caso o lan?ento do PSSD esteja configurado para que seja no momento do Pedido (S), ele n?dever?
                 exibir a mensagem de que a conta desde atendimento est?loqueada.

    */

    OPEN c_Configfaturamentopssd;

    FETCH c_Configfaturamentopssd

      INTO Vc_Configfaturamentopssd;

    CLOSE c_Configfaturamentopssd;

    --

    IF Nvl(Vc_Configfaturamentopssd.Sn_Pssd_Pedido, 'N') = 'N' THEN

      IF v_Mvto.Tp_Atendimento IN ('A', 'E', 'U') AND

         v_Mvto.Sn_Importa_Auto = 'S' AND NOT Bexclui THEN

        Raise_Application_Error(-20040

                                --MULTI-IDIOMA: Utiliza? do pkg_rmi_traducao.extrair_msg para mensagens (MSG_1)

                               ,

                                Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_1',

                                                                  'PACK_LANCA_FFCV',

                                                                  'A Conta deste atendimento est?loqueada! A movimenta? da mesma dever?er lan?a para o atendimento de interna? %s',



                                                                  Arg_List(v_Mvto.Cd_Atendimento_Pai)));

      END IF;

    END IF;

    /*PDA.: 449578 - 448122 - 11/07/2011 - Emanoel Deivison (fim)*/

    --PDA 175957 (In?o) 16/03/2007 - Pedro Neiva(Apply)

    Vsnchecapreconolcto := Dbamv.Fnc_Ffcv_Verifica_Preco_Lcto(v_Mvto.Tp_Atendimento);

    -- PDA 187015 (Inicio) - Henrique Antunes - 14/05/2007

    --if nvl (vsnchecapreconolcto,'N') = 'S' AND NOT bexclui THEN -- pda 118991 (colocada 2 condi? p/ n?verificar pre?ao excluir)

    IF Nvl(Vsnchecapreconolcto, 'N') = 'S' AND NOT Bexclui AND

       Nvl(Pkg_Mv2000.Le_Configuracao('FFCV', 'SN_CREDENCIADO_CENTAVOS'),

           'N') = 'N' THEN

      -- PDA 187015 (Fim)

      --IF NVL (v_config.sn_checa_preco_lcto, 'N') = 'S' AND NOT bexclui THEN -- pda 118991 (colocada 2 condi? p/ n?verificar pre?ao excluir)

      --PDA 175957 (Fim) 16/03/2007 - Pedro Neiva(Apply)

      Bexistepreco := Dbamv.Val_Proc_Ffcv_Resumido(v_Proced.Cd_Pro_Fat ||

                                                   v_Mvto.Cd_Setor -- PDA 194962 - Pedro Neiva - 23/08/2007

                                                  ,

                                                   v_Mvto.Dt_Pedido,

                                                   v_Mvto.Hr_Pedido,

                                                   v_Mvto.Cd_Convenio,

                                                   v_Mvto.Cd_Con_Pla,

                                                   v_Mvto.Tp_Atendimento,

                                                   v_Mvto.Cd_Tip_Acom,

                                                   Cmensret,

                                                   'SADT',

                                                   Ncdexalab);

      IF Bexistepreco = FALSE THEN

        Raise_Application_Error(-20050, Cmensret);

      END IF;

    END IF;

    IF (v_Mvto.Tp_Atendimento <> 'S') AND

       ((v_Mvto.Tp_Atendimento IN ('H', 'I') AND

       Nvl(v_Config.Sn_Sadt_Automatica, 'S') IN ('H', 'S')) OR

       (v_Mvto.Tp_Atendimento IN ('A', 'E', 'U') AND

       Nvl(v_Config.Sn_Sadt_Automatica, 'S') IN ('A', 'S'))) THEN

      IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') then

	      /*OR

         v_Mvto.Sn_Importa_Auto = 'S' THEN */ /*OP 21785*/

        --PDA 157595(INICIO) 14/04/2005 - Jansen Gallindo

        /*IF dbamv.pack_lanca_ffcv.c_conta%ISOPEN THEN

           CLOSE dbamv.pack_lanca_ffcv.c_conta;

        END IF;*/

        /*OPEN dbamv.pack_lanca_ffcv.c_conta (v_mvto.cd_atendimento

                                           --PDA 184670(In?o)

                                           --,v_mvto.dt_pedido

                                             ,to_date(to_char(v_mvto.dt_pedido,'dd/mm/yyyy')||' '||to_char(v_mvto.hr_pedido,'hh24:mi'),'dd/mm/yyyy hh24:mi')

                                           --PDA 184670(Fim)

                                           ,v_mvto.cd_convenio

                                           ,v_mvto.cd_atendimento_pai

                                           );

        FETCH dbamv.pack_lanca_ffcv.c_conta INTO v_conta;

        CLOSE dbamv.pack_lanca_ffcv.c_conta;*/

        /*OP 35916 - regra para cria? autom?ca de conta*/

        vSnReplicaProc := NULL;      /*OP 41394*/

        vTemRegraCriaContaAuto  := Dbamv.Pkg_Ffcv_Conta.FNC_TEM_REG_CRIA_CONTA_AUTO;

        IF (vTemRegraCriaContaAuto) THEN



                    /*ALLS OP 42241*/

                    OPEN dbamv.pack_lanca_ffcv.cSnCargoPaciente(v_Mvto.Cd_Atendimento);

                    FETCH dbamv.pack_lanca_ffcv.cSnCargoPaciente INTO vSnCargoPaciente;

					          CLOSE dbamv.pack_lanca_ffcv.cSnCargoPaciente;



					          IF Nvl(vSnCargoPaciente.sn_carga_familiar,'N') = 'S' THEN



                        vRegraCriaContaAutoCP := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTCP(v_Mvto.Cd_Atendimento,

                                                                                                     v_Proced.Cd_Pro_Fat,

                                                                                                     Ddthraux); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAutoCP(1).cd_regra_cria_conta IS NOT NULL ) THEN



                            v_ContaCargoPac :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_HOSP_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                                 null,

                                                                                                 v_Mvto.Cd_Atendimento,

                                                                                                 v_Mvto.Cd_Atendimento_Pai,

                                                                                                 vRegraCriaContaAutoCP(1).cd_convenio_destino,

                                                                                                 vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                                                                                                 Ddthraux,

                                                                                                 vRegraCriaContaAutoCP(1).cd_tipo_arq_cta_envio,

                                                                                                 vRegraCriaContaAutoCP(1).cd_desconto_inst); /*ALLS OP 35921*/

                            vSnCriouContaAutoCP := TRUE;

                        END IF;

                    /*fim ALLS OP 42241*/

                    ELSE



                        vRegraCriaContaAuto := Dbamv.Pkg_Ffcv_Conta.FNC_VERIFIC_REG_CRIA_CONTA_AUT(v_Mvto.Cd_Atendimento,

                                                                                                   v_Proced.Cd_Pro_Fat,

                                                                                                   Ddthraux); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAuto(1).cd_regra_cria_conta IS NOT NULL ) THEN



                            v_Conta :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_HOSP_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                          null,

                                                                                          v_Mvto.Cd_Atendimento,

                                                                                          v_Mvto.Cd_Atendimento_Pai,

                                                                                          vRegraCriaContaAuto(1).cd_convenio_destino,

                                                                                          vRegraCriaContaAuto(1).cd_con_pla_destino,

                                                                                          Ddthraux,

                                                                                          vRegraCriaContaAuto(1).cd_tipo_arq_cta_envio,

                                                                                          vRegraCriaContaAuto(1).cd_desconto_inst); /*ALLS OP 35921*/

                            vSnCriouContaAuto := TRUE;

                        END IF;



                        /*OP 41394*/

                        vRegraCriaContaAutoHE := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTHE(v_Mvto.Cd_Atendimento,v_Proced.Cd_Pro_Fat,Ddthraux); --FATURCONV-1383 - AMBS



                          IF (vRegraCriaContaAutoHE(1).cd_regra_cria_conta IS NOT NULL ) THEN

                            vSnReplicaProc := 'S';

                        END IF;

                        /*OP 41394*/



                    END IF;



        END IF;





        IF (NOT vSnCriouContaAuto) THEN

        /*OP 35916 - regra para cria? autom?ca de conta*/

           v_Conta := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Conta(v_Mvto.Cd_Atendimento

                                                          -- pda 254202(Incio) - Pedro Neiva - 15/10/2008

                                                          /*

                                                                                                           ,to_date(to_char(v_mvto.dt_pedido,'dd/mm/yyyy')||' '||to_char(v_mvto.hr_pedido,'hh24:mi'),'dd/mm/yyyy hh24:mi')

                                                                       */,

                                                          Ddthraux

                                                          -- pda 254202(Fim)

                                                         ,

                                                          v_Mvto.Cd_Convenio,

                                                          v_Mvto.Cd_Atendimento_Pai);

        END IF;/*OP 35916*/



        --IF v_conta.cd_reg_fat IS NULL THEN

        IF v_Conta(1).Cd_Reg_Fat IS NULL THEN

          --PDA 157595(FIM) 14/04/2005 - Jansen Gallindo

          IF v_Mvto.Cd_Convenio_Secundario IS NOT NULL THEN

            Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Verifica_Conta_Secundaria(v_Mvto.Cd_Atendimento

                                                                            -- pda 254202(Incio) - Pedro Neiva - 15/10/2008

                                                                            /*

                                                                                                                              --,v_mvto.dt_pedido

                                                                                                            */,

                                                                            Ddthraux

                                                                            -- pda 254202(Fim)

                                                                           ,

                                                                            v_Mvto.Cd_Convenio_Secundario,

                                                                            v_Mvto.Cd_Atendimento_Pai);

            Ncdconvconta := v_Mvto.Cd_Convenio_Secundario;

            Ncdplanconta := v_Mvto.Cd_Con_Pla_Secundario;

            IF Ncdregfat IS NULL THEN

              RAISE Atend_Sem_Conta;

            END IF;

          ELSE

            -- OP 47071 - Incluida condi? para n?entrar nesse IF caso esteja excluindo/cancelando pedido.

            IF v_Mvto.Tp_Convenio = 'P' AND (NOT bExclui) THEN

              Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento

                                                                           -- pda 254202(Incio) - Pedro Neiva - 15/10/2008

                                                                           /*

                                                                                                                             --,v_mvto.dt_pedido

                                                                                                           */,

                                                                           Ddthraux

                                                                           -- pda 254202(Fim)

                                                                           ); -- pda 125871(acrescentada a data)

              Ncdconvconta := v_Mvto.Cd_Convenio;

              Ncdplanconta := v_Mvto.Cd_Con_Pla;

            ELSE

              RAISE Atend_Sem_Conta;

            END IF;

          END IF;

        ELSE

          Ncdregfat    := v_Conta(1).Cd_Reg_Fat; --ncdregfat := v_conta.cd_reg_fat;--PDA 157595

          Ncdconvconta := v_Conta(1).Cd_Convenio; --ncdconvconta := v_conta.cd_convenio; --PDA 157595

          Ncdplanconta := v_Conta(1).Cd_Con_Pla; --ncdplanconta := v_conta.cd_con_pla; --PDA 157595

        END IF;

      ELSE

        --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

        /*OPEN dbamv.pack_lanca_ffcv.c_contaambu (v_mvto.cd_atendimento

                                               ,v_mvto.dt_pedido

                                               ,v_mvto.cd_convenio

                                               ,v_mvto.cd_atendimento_pai

                                               );

        FETCH dbamv.pack_lanca_ffcv.c_contaambu INTO v_contaambu;

        CLOSE dbamv.pack_lanca_ffcv.c_contaambu;*/

        /*OP 35916 - regra para cria? autom?ca de conta*/

        vSnReplicaProc := NULL;      /*OP 41394*/

        vTemRegraCriaContaAuto  := Dbamv.Pkg_Ffcv_Conta.FNC_TEM_REG_CRIA_CONTA_AUTO;

        IF (vTemRegraCriaContaAuto) THEN



                    /*ALLS OP 42241*/

                    OPEN dbamv.pack_lanca_ffcv.cSnCargoPaciente(v_Mvto.Cd_Atendimento);

                    FETCH dbamv.pack_lanca_ffcv.cSnCargoPaciente INTO vSnCargoPaciente;

					          CLOSE dbamv.pack_lanca_ffcv.cSnCargoPaciente;



					          IF Nvl(vSnCargoPaciente.sn_carga_familiar,'N') = 'S' THEN



                        vRegraCriaContaAutoCP := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTCP(v_Mvto.Cd_Atendimento,

                                                                                                     v_Proced.Cd_Pro_Fat,

                                                                                                     v_Mvto.Dt_Pedido); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAutoCP(1).cd_regra_cria_conta IS NOT NULL ) THEN



                            v_ContaCargoPacAmbu :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_AMB_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                                    null,

                                                                                                    v_Mvto.Cd_Atendimento,

                                                                                                    v_Mvto.Cd_Atendimento_Pai,

                                                                                                    vRegraCriaContaAutoCP(1).cd_convenio_destino,

                                                                                                    vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                                                                                                    v_Mvto.Dt_Pedido,

                                                                                                    vRegraCriaContaAutoCP(1).cd_tipo_arq_cta_envio,

                                                                                                    vRegraCriaContaAutoCP(1).cd_desconto_inst); /*ALLS OP 35921*/

                            vSnCriouContaAutoAmbCP := TRUE;

                        END IF;

                    /*fim ALLS OP 42241*/

                    ELSE



                        vRegraCriaContaAuto := Dbamv.Pkg_Ffcv_Conta.FNC_VERIFIC_REG_CRIA_CONTA_AUT(v_Mvto.Cd_Atendimento,

                                                                                                   v_Proced.Cd_Pro_Fat,

                                                                                                   v_Mvto.Dt_Pedido); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAuto(1).cd_regra_cria_conta IS NOT NULL)  THEN



                            v_Contaambu :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_AMB_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                            null,

                                                                                            v_Mvto.Cd_Atendimento,

                                                                                            v_Mvto.Cd_Atendimento_Pai,

                                                                                            vRegraCriaContaAuto(1).cd_convenio_destino,

                                                                                            vRegraCriaContaAuto(1).cd_con_pla_destino,

                                                                                            v_Mvto.Dt_Pedido,

                                                                                            vRegraCriaContaAuto(1).cd_tipo_arq_cta_envio,

                                                                                            vRegraCriaContaAuto(1).cd_desconto_inst); /*ALLS OP 35921*/

                              vSnCriouContaAutoAmb := TRUE;

                        END IF;



                        /*OP 41394*/

                        vRegraCriaContaAutoHE := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTHE(v_Mvto.Cd_Atendimento,v_Proced.Cd_Pro_Fat,v_Mvto.Dt_Pedido); --FATURCONV-1383 - AMBS



                        IF (vRegraCriaContaAutoHE(1).cd_regra_cria_conta IS NOT NULL ) THEN

                            vSnReplicaProc := 'S';

                        END IF;

                        /*OP 41394*/



                    END IF;



        END IF;



        IF (NOT vSnCriouContaAutoAmb) THEN

        /*OP 35916 - regra para cria? autom?ca de conta*/

        v_Contaambu := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Ccontaambu(v_Mvto.Cd_Atendimento,

                                                                   v_Mvto.Dt_Pedido,

                                                                   v_Mvto.Cd_Convenio,

                                                                   v_Mvto.Cd_Atendimento_Pai);

        END IF; /*OP 35916*/



        --IF NVL (v_contaambu.sn_fechada, 'N') = 'S' THEN

        IF Nvl(v_Contaambu(1).Sn_Fechada, 'N') = 'S' THEN

          --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

          RAISE Atend_Sem_Conta;

        END IF;

        --IF v_contaambu.cd_reg_amb IS NULL THEN --PDA 157595

        IF v_Contaambu(1).Cd_Reg_Amb IS NULL THEN

          --PDA 157595

          -- OP 47071 - Incluida condi? para n?entrar nesse IF caso esteja excluindo/cancelando pedido.

          IF (NOT bExclui) THEN

            IF v_Mvto.Tp_Convenio = 'P' THEN

              Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(v_Mvto.Cd_Atendimento);

            ELSE

              Ncdregamb := Dbamv.Pack_Ffcv.Cria_Conta_Acoplamentoambu(v_Mvto.Cd_Atendimento,

                                                                      'N');

            END IF;

          end if;

          Ncdconvconta := v_Mvto.Cd_Convenio;

          Ncdplanconta := v_Mvto.Cd_Con_Pla;

        ELSE

          Ncdregamb    := v_Contaambu(1).Cd_Reg_Amb; --ncdregamb := v_contaambu.cd_reg_amb; --PDA 157595

          Ncdconvconta := v_Contaambu(1).Cd_Convenio; -- ncdconvconta := v_contaambu.cd_convenio; --PDA 157595

          Ncdplanconta := v_Contaambu(1).Cd_Con_Pla; --ncdplanconta := v_contaambu.cd_con_pla; --PDA 157595

        END IF;

        IF Ncdregamb IS NULL THEN

          RAISE Atend_Sem_Conta;

        END IF;

      END IF;

      IF v_Proced.Cd_Pro_Fat IS NULL THEN

        RAISE Prod_Nao_Conf;

      END IF;

      OPEN c_Grfasetorexame(v_Proced.Cd_Gru_Pro, v_Mvto.Cd_Setor);

      FETCH c_Grfasetorexame

        INTO Ncdgrufat;

      CLOSE c_Grfasetorexame;

      IF Ncdgrufat IS NULL THEN

        Ncdgrufat := v_Proced.Cd_Gru_Fat;

      END IF;

      IF Ncdgrufat IS NULL THEN

        RAISE Setor_Nao_Conf;

      END IF;

      IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

        OPEN Dbamv.Pack_Lanca_Ffcv.c_Forapre(Ncdconvconta, Ncdgrufat);

        FETCH Dbamv.Pack_Lanca_Ffcv.c_Forapre

          INTO v_Forapre;

        CLOSE Dbamv.Pack_Lanca_Ffcv.c_Forapre;

      ELSE

        OPEN Dbamv.Pack_Lanca_Ffcv.c_Forapre(Ncdconvconta, Ncdgrufat);

        FETCH Dbamv.Pack_Lanca_Ffcv.c_Forapre

          INTO v_Forapre;

        CLOSE Dbamv.Pack_Lanca_Ffcv.c_Forapre;

      END IF;

      -- else

      IF v_Forapre.Sn_Prestador = 'S' THEN



	  IF v_set_exa.TP_ORIGEM_PREST_FAT = 'G' THEN   -- OP 32444

        IF Nvl(v_Config.Tp_Prestador_Pssd, 'P') = 'R' THEN

          -- Prestador do Resultado

          Nprestador := Nvl(Nvl(v_Mvto.Cd_Prestador_Resp,

                                v_Mvto.Cd_Prestador_Exa),

                            v_Mvto.Cd_Prestador_Lab);

        ELSE

          -- Prestador do Pedido

          Nprestador := Nvl(v_Mvto.Cd_Prestador_Exa,

                            v_Mvto.Cd_Prestador_Lab);

        END IF;

	  ELSE -- OP 32444 - Inicio

		IF v_set_exa.TP_ORIGEM_PREST_FAT = 'L' THEN  -- Laudo

			 nprestador := NVL (NVL (v_mvto.cd_prestador_resp, v_mvto.cd_prestador_exa), v_mvto.cd_prestador_lab);

		ELSIF v_set_exa.TP_ORIGEM_PREST_FAT = 'S' THEN  -- Solicitante

			nprestador :=  Nvl(v_mvto.cd_prest_lab,v_mvto.cd_prestador_lab);

		ELSIF v_set_exa.TP_ORIGEM_PREST_FAT = 'T' THEN --  Setor

			  nprestador:= v_set_exa.cd_prestador;

		END IF;

	   END IF; -- OP 32444 - Fim

      ELSE

        Nprestador := NULL;

      END IF;

      -- op 38143 (inicio)

      OPEN dbamv.pack_lanca_ffcv.c_forapreatimed(ncdconvconta, ncdgrufat);

      FETCH dbamv.pack_lanca_ffcv.c_forapreatimed

        INTO v_forapreatimed;

      CLOSE dbamv.pack_lanca_ffcv.c_forapreatimed;

      IF v_forapreatimed.sn_cadastra_ati_med = 'S' then

        vccdatimed := v_config.cd_ati_med_clinico;

      ELSE

        vccdatimed := null;

      END if;

      -- op 38143 (fim)



      IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

        IF Nprestador IS NOT NULL THEN

          -- PDA 100970 26/07/2006 Thiago Holder Marcos Silva

          -- Chamada da fun? dbamv.pkg_ffcv_it_conta.fnc_retorna_tp_pagamento();

          -- Esta fun? tamb?verifica se o prestador credenciado tem alguma exce?

          -- caso tenha, o tipo de pagamento ser?rodu?.

          --

          --  OPEN dbamv.pack_lanca_ffcv.c_prescon (nprestador, ncdconvconta);

          --  FETCH dbamv.pack_lanca_ffcv.c_prescon INTO csnpgconv;

          --  CLOSE dbamv.pack_lanca_ffcv.c_prescon;

          --  IF NVL (csnpgconv, 'N') = 'S' THEN

          --     ctppgto := 'C';

          --  ELSE

          --     ctppgto := 'P';

          --  END IF;

          Ctppgto := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Retorna_Tp_Pagamento(Nprestador,

                                                                      Ncdconvconta,

                                                                      v_Mvto.Tp_Atendimento,

                                                                      v_Proced.Cd_Pro_Fat,

                                                                      v_Mvto.Cd_Ori_Ate

                                                                      -- PDA 166691 (Inicio) - Henrique Antunes - 28/11/2006

                                                                     ,

                                                                      v_Mvto.Dt_Pedido,

                                                                      v_Mvto.Hr_Pedido

                                                                      -- PDA 166691 (Fim)

																	  --FATURCONV-1726 INI

																	  ,Ncdplanconta

																	  ,vRregra.cd_regra

																	  ,v_Proced.Cd_Gru_Pro

																	  --FATURCONV-1726 FIM

                                                                      );

        ELSE

          Ctppgto := NULL; -- 'P' ; -- ( pda 84408  setado de null p/ 'P') -- pda 104455 desfazer o que foi feito no pda 84408

        END IF;

      ELSE

        IF Nprestador IS NOT NULL THEN

          --  OPEN dbamv.pack_lanca_ffcv.c_prescon (nprestador, ncdconvconta);

          --  FETCH dbamv.pack_lanca_ffcv.c_prescon INTO csnpgconv;

          --  CLOSE dbamv.pack_lanca_ffcv.c_prescon;

          --  IF NVL (csnpgconv, 'N') = 'S' THEN

          --     ctppgto := 'C';

          --  ELSE

          --     ctppgto := 'P';

          --  END IF;

          Ctppgto := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Retorna_Tp_Pagamento(Nprestador,

                                                                      Ncdconvconta,

                                                                      v_Mvto.Tp_Atendimento,

                                                                      v_Proced.Cd_Pro_Fat,

                                                                      v_Mvto.Cd_Ori_Ate

                                                                      -- PDA 166691 (Inicio) - Henrique Antunes - 28/11/2006

                                                                     ,

                                                                      v_Mvto.Dt_Pedido,

                                                                      v_Mvto.Hr_Pedido

                                                                      -- PDA 166691 (Fim)

																	  --FATURCONV-1726 INI

																	  ,Ncdplanconta

																	  ,vRregra.cd_regra

																	  ,v_Proced.Cd_Gru_Pro

																	  --FATURCONV-1726 FIM

                                                                      );

        ELSE

          Ctppgto := NULL; -- 'P' ; -- ( pda 84408  setado de null p/ 'P')-- pda 104455 desfazer o que foi feito no pda 84408

        END IF;

      END IF;

      -- PDA 187015 (Inicio) - Henrique Antunes - 14/05/2007

      IF Nvl(Vsnchecapreconolcto, 'N') = 'S' AND NOT Bexclui AND

         Nvl(Ctppgto, 'P') <> 'C' AND

         Nvl(Pkg_Mv2000.Le_Configuracao('FFCV', 'SN_CREDENCIADO_CENTAVOS'),

             'N') = 'S' THEN

        Bexistepreco := Dbamv.Val_Proc_Ffcv_Resumido(v_Proced.Cd_Pro_Fat ||

                                                     v_Mvto.Cd_Setor -- PDA 194962 - Pedro Neiva - 23/08/2007

                                                    ,

                                                     v_Mvto.Dt_Pedido,

                                                     v_Mvto.Hr_Pedido,

                                                     v_Mvto.Cd_Convenio,

                                                     v_Mvto.Cd_Con_Pla,

                                                     v_Mvto.Tp_Atendimento,

                                                     v_Mvto.Cd_Tip_Acom,

                                                     Cmensret,

                                                     'SADT',

                                                     Ncdexalab);

        IF Bexistepreco = FALSE THEN

          Raise_Application_Error(-20050, Cmensret);

        END IF;

      END IF;

      -- PDA 187015 (Fim)

      -- IF nprestador IS NOT NULL AND ctppgto = 'P' THEN

      --   SELECT tp_vinculo

      --     INTO ntpvinculo

      --     FROM dbamv.prestador

      --    WHERE cd_prestador = nprestador;

      --   IF ntpvinculo = 'U' THEN

      --      ctppgto := 'F';

      --   END IF;

      -- END IF;

      --PDA 100970(Fim)

      IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

        IF Ctpproibicao = 'NA' THEN

          Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento

                                                                       -- pda 254202(Incio) - Pedro Neiva - 15/10/2008

                                                                       /*

                                                                                           --,v_mvto.dt_pedido

                                                                                           */,

                                                                       Ddthraux

                                                                       -- pda 254202(Fim)15/10/2008

                                                                       ); -- pda 125871(acrescentada a data)

          Ncdconvconta := v_Config.Cd_Convenio_Fat_Extra;

          Ncdplanconta := v_Config.Cd_Con_Pla_Fat_Extra;

          IF Ncdregfat IS NULL THEN

            RAISE Atend_Sem_Conta;

          END IF;

        END IF;

      ELSE

        IF Ctpproibicao = 'NA' THEN

          IF v_Config.Tp_Controle_Lote = 'A' THEN

            --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

            /*OPEN dbamv.pack_lanca_ffcv.c_contapartambu (v_mvto.cd_atendimento, v_mvto.dt_pedido);

            FETCH dbamv.pack_lanca_ffcv.c_contapartambu INTO v_contapartambu;

            CLOSE dbamv.pack_lanca_ffcv.c_contapartambu;*/

            v_Contapartambu := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Ccontapartambu(v_Mvto.Cd_Atendimento,

                                                                               v_Mvto.Dt_Pedido);

            --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

          ELSE

            --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

            /*OPEN dbamv.pack_lanca_ffcv.c_contapartambu_loteunico (v_mvto.cd_atendimento, v_mvto.dt_pedido);

            FETCH dbamv.pack_lanca_ffcv.c_contapartambu_loteunico INTO v_contapartambu;

            CLOSE dbamv.pack_lanca_ffcv.c_contapartambu_loteunico;*/

            v_Contapartambu := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Contpartambulotun(v_Mvto.Cd_Atendimento,

                                                                                  v_Mvto.Dt_Pedido);

            --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

          END IF;

          --IF v_contapartambu.cd_reg_amb IS NULL THEN --PDA 157595

          IF v_Contapartambu(1).Cd_Reg_Amb IS NULL THEN

            --PDA 157595

            Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(v_Mvto.Cd_Atendimento);

          ELSE

            --ncdregamb := v_contapartambu.cd_reg_amb;--PDA 157595

            Ncdregamb := v_Contapartambu(1).Cd_Reg_Amb; --PDA 157595

          END IF;

          IF Ncdregamb IS NULL THEN

            RAISE Atend_Sem_Conta;

          END IF;

          Ncdconvconta := v_Config.Cd_Convenio_Fat_Extra;

          Ncdplanconta := v_Config.Cd_Con_Pla_Fat_Extra;

        END IF;

      END IF;

      Nqtprofat := 1;

      /* pda 145435 - 24/03/2006 - Jose Roberto                   (*)

      Alterando a verifica? da guia, retirando os cursores c_qtdexistente_amb e

      c_qtdexistente_fat para utilizar a nova fun? FNC_RETORNA_GUIA_DISPONIVEL;

      Retiradas as verifica?s nos cursores c_guia, c_itguia e c_itguia_proc_auto;

      Retirado o uso das vari?is totallancado e nqtautorizado;

      Caso NCDGUIA for Nulo, chamando a fun? F_GRAVA_GUIA, alterando o terceiro

      par?tro para nqtprofat;

      Retirado todo o c?ulo feito para atribuir valor as vari?is nqtpart,

      nqtconv e limite;

      Caso retorne uma Guia dispon?l, atribu?a ?ari?l NCDGUIA.         */

      /*PDA 374303 - 25/06/2010 - Juliana Vieira

      na chamada da fun? que retorna se tem uma guia dispon?l, passar sempre o codigo do atendimento

      pai caso tiver, pois o sistma pode criar atendimentos de recem nascido onde n?existe conta para ele e n??ecess?o

      crioar guias para os atendimentos filhos.*/

      IF Ctpproibicao = 'AG' THEN

	    -- Incluido o IF para for? a cria? de uma guia por exame, quando integra? Soul x Safe(IPSEMG) estiver ativada

	    if   Nvl(dbamv.pkg_mv2000.Le_Configuracao('FFCV','SN_AUTORIZACAO_LCTO_AUTO'),'N') = 'S'  then

          Ncdguia := null ;

        else

           Ncdguia := Dbamv.Pkg_Ffcv_Guia.Fnc_Retorna_Guia_Disponivel(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                       v_Mvto.Cd_Atendimento),

                                                                   Nvl(Ncdregfat,

                                                                       Ncdregamb),

                                                                   NULL,

                                                                   v_Proced.Cd_Pro_Fat,

                                                                   Nqtprofat,

                                                                   NULL,

                                                                   NULL,

                                                                   Nguiapendente);

        end if ;

        IF Nvl(v_Config.Sn_Guia_Proc_Auto, 'N') = 'S' THEN

          IF Ncdguia IS NULL THEN

            Ncdguia := Dbamv.f_Grava_Guia(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                              v_Mvto.Cd_Atendimento),

                                          v_Mvto.Cd_Convenio,

                                          Nqtprofat,

                                          v_Proced.Cd_Pro_Fat,

                                          'P');

          END IF;

          Nqtpart := 0;

          Nqtconv := Nqtprofat;

          Limite  := 0;

          /* pda 164822 - 28/09/2006 - Amalia Ara??

             Comentado para n?lan? procedimento com proibi? AG em conta particular.

          else

            nQtPart := nQtProFat;

            nQtConv := 0;

            limite  := 1;

          pda 164822 - fim       */

        END IF;

      END IF;

      -- pda 145435 (Fim)

      -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

      IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

        Ncdconta := Ncdregfat;

      ELSE

        Ncdconta := Ncdregamb;

      END IF;

      IF Ctpproibicao = 'AG' THEN

        Csnguia := 'S';

      END IF;

      -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

      -- Prepara? da data que ser?assada na fun?.

      Ddthraux := To_Date(To_Char(v_Mvto.Dt_Pedido, 'DD/MM/YYYY') || ' ' ||

                          To_Char(Nvl(v_Mvto.Hr_Pedido, v_Mvto.Dt_Pedido),

                                  'HH24:MI:SS'),

                          'DD/MM/YYYY HH24:MI:SS');

      -- PDA 221500 (Fim)

      /* pda 376904/363842 - 15/07/2010 - Amalia Ara??- Acertar se a data/hora acima estiver fora do atendimento */

      IF Ddthraux < v_Mvto.Dt_Atendimento THEN

        Ddthraux := v_Mvto.Dt_Atendimento;

      END IF;

      IF Ddthraux > v_Mvto.Dt_Alta THEN

        Ddthraux := v_Mvto.Dt_Alta;

      END IF;

      /* pda 376904/363842 - fim */

      /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

      nQtExcedeu a vari?l retorna justamente a quantidade de procedimentos que deve ser lan?o no procedimento

      que pertence ao pacote, em seguida deve ser inserdio um outro procedimento com o que restou do lan?ento*/

      Nqtexcedeu := NULL;

      --

      /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

      vTpContaPart a vari?l retorna justamente se o procedimento vai ser inserido em uma conta particular ou ira seguir

      o processo normalmente.*/

      Ncdpacote := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Gera_Pacote(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                               v_Mvto.Cd_Atendimento),

                                                           v_Mvto.Tp_Atendimento,

                                                           Ncdconvconta -- ,v_mvto.cd_convenio OP 6182

                                                          ,

                                                           Ncdplanconta -- ,v_mvto.cd_con_pla OP 6182

                                                          ,

                                                           Ncdconta,

                                                           Ncdgrufat,

                                                           v_Proced.Cd_Pro_Fat,

                                                           v_Mvto.Cd_Setor,

                                                           Nprestador

                                                           -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

                                                           --,v_mvto.dt_pedido

                                                          ,

                                                           Ddthraux

                                                           -- PDA 221500 (Fim)

                                                          ,

                                                           Ncdpedlab,

                                                           Ncditemmvto,

                                                           'SADT',

                                                           Csnguia,

                                                           Nqtprofat,

                                                           Csnpacote,

                                                           Nqtexcedeu -- OP 387

                                                          ,

                                                           Vtpcontapart -- OP 387

                                                          ,

                                                           NULL

                                                           -- PDA 225086 (Inicio)

                                                          ,

                                                           v_Mvto.Cd_Atendimento,

                                                           NULL --pCdProFatPacote

                                                          ,

                                                           Ncdlcto --pCdLancamento_pac

                                                          ,

                                                           NULL); --preserva

      -- PDA 225086 (fim)

      /* pda 481126 - depois da FNC_GERA_PACOTE regravando o cd_lancamento_pac */

      IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

        OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncdregfat);

        FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

          INTO Ncdlcto;

        CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

      ELSE

        OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Ncdregamb);

        FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

          INTO Ncdlcto;

        CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;

      END IF;

      --

      IF Ncdpacote IS NOT NULL THEN

        UPDATE Dbamv.Conta_Pacote

           SET Cd_Lancamento_Pac = Ncdlcto

         WHERE Cd_Conta_Pacote = Ncdpacote;

      END IF;

      /* pda 481126 - fim */

      -- PDA 157145 (Inicio)

      IF Dbamv.Pack_Lanca_Ffcv.Is_Hor_Esp(Ncdconvconta,

                                          Ncdplanconta,

                                          v_Mvto.Tp_Atendimento,

                                          v_Mvto.Dt_Pedido,

                                          v_Mvto.Hr_Pedido,

                                          Ncdgrufat,

                                          v_Proced.Cd_Pro_Fat

                                          -- PDA 119427 11/04/2005 Henrique Antunes (In?o)

                                          -- Passar NULL para o par?tro de regra

                                         ,

                                          NULL

                                          -- PDA 119427 (FIM)

                                         , --PDA 108041 / 108039 12/11/2004 Sp?ola (INICIO)

                                          --Inserido o paremetro cd_prestador / cd_setor para permitir exce?s de convenios e planos por prestador

                                          Nprestador,

                                          v_Mvto.Cd_Setor --PDA 108041 / 108039 (FIM)

                                          ) THEN

        Csnhoresp := 'S';

      ELSE

        Csnhoresp := 'N';

      END IF;

      -- PDA 214903 (Inicio) - Henrique Antunes - 29/01/2008

      IF v_Forapre.Sn_Prestador = 'S' AND Nvl(Nprestador, 0) = 0 THEN

        Nprestador := Nitmedexe;

      END IF;

      -- PDA 214903 (Fim)

      IF Inserting THEN

        IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

          -- PDA 123016 (Inicio) - Henrique Antunes - 06/07/2005

          DECLARE

            Vqtd NUMBER;

          BEGIN

            OPEN Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco(Ncdregfat,

                                                        v_Mvto.Dt_Pedido,

                                                        v_Mvto.Hr_Pedido);

            FETCH Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco

              INTO Vqtd;

            CLOSE Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco;

            IF Nvl(Vqtd, 0) <> 0 THEN

              RAISE Auditoria_In_Loco;

            END IF;

          END;

          -- PDA 123016 (Fim)

          IF Limite <> 1 THEN

            /* OP 387 - Thiago miranda de oliveira - aso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o procedimento que ira ser inserido abaixo pertence a um pacote, e a qunatidade que sera inserida sera menor que a lan?a, a diferen?

            sera lan?a na rotina mais abaixo atravez da procedure PRC_DESVINCULA_PROCEDIMENTO*/

            /* Fazendo tratamento caso o procedimento esteja configurado no gabarito para ser inserido dentro de uma conta particular

            caso a variavel vTpContaPart esteja preenchida e a quantidade de lan?ento extra esteja nula. com iso deve ser procurado uma conta particular

            e um lan?ento para inseririr nesta conta.*/

            Nconta := NULL;

            Nlanc  := NULL;



			/*43289 - quebra de conta por quantidade de procedimento por atendimento*/

			/*A regra de pacote tem prioridade sobre essa regra, conforme vari?l Nqtexcedeu abaixo*/

			IF Nqtexcedeu IS NULL THEN

				if (not vSnCriouContaAuto) then /*OP 46768*/

					  IF DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_EXISTE_CONF_QTD_ATEND_PAC(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																						 v_proced.cd_pro_fat,

																						 pEmpresa) THEN



						  Nqtexcedeu := DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_RETORNA_QTD_LANC_PERIODO(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																									   v_proced.cd_pro_fat,

																									   pEmpresa,

																									   ncdregfat,

																									   nvl(nqtconv, nqtprofat),

																									   pSnChamadoDaTela,

																									   pvSnJaExcedeuQtd,

																									   pvMensagem

																									   );

						  IF pvSnJaExcedeuQtd = 'S' THEN

							  Vtpcontapart := 'ProcPorAtend';

							  Nqtexcedeu   := NULL;

						  ELSE

								IF NVL(Nqtexcedeu,0) > 0 THEN

									Vtpcontapart := 'ProcPorAtend';

								END IF;

						  END IF;

					END IF;

				END IF;	/*OP 46768*/

		    END IF;

			/*43289*/

            IF Nvl(Vtpcontapart, 'X') <> 'X' AND Nqtexcedeu IS NULL THEN

              Nconta := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                         v_Mvto.Cd_Atendimento),

                                                                     Ddthraux);

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Nconta);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                INTO Nlanc;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

            END IF;

            INSERT INTO Dbamv.Itreg_Fat

              (Cd_Reg_Fat,

               Cd_Lancamento,

               Dt_Lancamento,

               Hr_Lancamento,

               Qt_Lancamento,

               Cd_Guia,

               Vl_Percentual_Multipla,

               Cd_Gru_Fat,

               Cd_Pro_Fat,

               Sn_Pertence_Pacote,

               Cd_Prestador,

               Tp_Pagamento,

               Cd_Setor,

               Cd_Setor_Produziu,

               Sn_Horario_Especial,

               cd_ati_med,   -- op 38143

               Cd_Usuario,

               Cd_Mvto,

               Tp_Mvto,

               Cd_Itmvto -- PDA 99872 - 29/12/2005

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Cd_Conta_Pacote

               -- PDA 157145 (Fim)

               )

            VALUES

              (Nvl(Nconta, Ncdregfat) -- OP 387

              ,

               Nvl(Nlanc, Ncdlcto) -- OP 387

              ,

               Ddthraux,

               Ddthraux,

               Nvl(Nqtexcedeu, Nvl(Nqtconv, Nqtprofat)) -- OP 387

              ,

               Ncdguia,

               100,

               Ncdgrufat,

               v_Proced.Cd_Pro_Fat,

               Nvl(Csnpacote, 'N'),

               Nprestador,

               Ctppgto,

               v_Mvto.Cd_Setor,

               Nvl(v_Mvto.Cd_Setor_Set_Exa, v_Mvto.Cd_Setor),

               Csnhoresp,

               vccdatimed, -- OP 38143

               USER,

               Ncdpedlab,

               Nvl(Vtpcontapart, 'SADT') -- OP 387

              ,

               Ncditemmvto -- PDA 99872 - 29/12/2005

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Ncdpacote

               -- PDA 157145 (Fim)

               );



        /*OP 42241 - Caso tenha criado a conta por cargo paciente, devemos lan? o item para o convenio, plano, percentual definido na configura

        de quebra de conta por cargo paciente*/

        IF (vSnCriouContaAutoCP) THEN

            vSnCriouContaAutoCP := FALSE;



            OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(v_ContaCargoPac(1).cd_reg_fat);

            FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

            INTO NcdlctoCp;

            CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;



              INSERT INTO Dbamv.Itreg_Fat

              (Cd_Reg_Fat,

                Cd_Lancamento,

                Dt_Lancamento,

                Hr_Lancamento,

                Qt_Lancamento,

                Vl_Percentual_Multipla,

                Cd_Gru_Fat,

                Cd_Pro_Fat,

                Sn_Pertence_Pacote,

                Cd_Prestador,

                Tp_Pagamento,

                cd_ati_med,

                Cd_Guia,

                Cd_Setor,

                Cd_Setor_Produziu,

                Sn_Horario_Especial,

                Cd_Usuario,

                Cd_Mvto,

                Tp_Mvto,

                Cd_Itmvto

                )

            VALUES

              (v_ContaCargoPac(1).cd_reg_fat,

                NcdlctoCp,

                Ddthraux,

                Ddthraux,

                Nvl(Nqtexcedeu, Nvl(Nqtconv, Nqtprofat)),

                vRegraCriaContaAutoCP(1).vl_percentual_carga_familiar,

                Ncdgrufat,

                v_Proced.Cd_Pro_Fat,

                'N',

                Nprestador,

                Ctppgto,

                vccdatimed,

                Ncdguia,

                v_Mvto.Cd_Setor,

                Nvl(v_Mvto.Cd_Setor_Set_Exa, v_Mvto.Cd_Setor),

                'N',

                USER,

                Ncdpedlab,

                Nvl(Vtpcontapart, 'SADT'),

                Ncditemmvto

                );

        END IF;

        /*OP 42241*/



        /*OP 41394 - replicar horario especial no lan?ento autom?co. Incialmente implementa? pro cliente HOSCAR*/

        IF (nvl(csnhoresp,'N') = 'S'

            AND (NOT vSnCriouContaAuto) /*n??m item de regra de quebra de conta autom?ca*/

            AND vSnReplicaProc = 'S' )  /*tem regra pra replicar proc de hor?o especial*/

            THEN



             OPEN cProced(v_Proced.Cd_Pro_Fat);

             FETCH cProced INTO vProced;

             CLOSE cProced;



             OPEN cRregra(Ncdconvconta,Ncdplanconta);

             FETCH cRregra INTO vRregra;

             CLOSE cRregra;



              vNlsBanco := dbamv.FNC_FFCV_FIRST_DAY_SEMANA_BR('S',null);

             OPEN dbamv.pack_lanca_ffcv.cSnReplicaProcHe(vRregra.cd_regra,

                                   vProced.cd_gru_pro,

                                   v_Proced.Cd_Pro_Fat,

                                   TO_NUMBER(TO_CHAR(v_Mvto.Dt_Pedido, 'd')),

                                   v_Mvto.Hr_Pedido,

                                   v_Mvto.Tp_Atendimento);

             FETCH dbamv.pack_lanca_ffcv.cSnReplicaProcHe INTO vSnReplicaProcHe;

             CLOSE dbamv.pack_lanca_ffcv.cSnReplicaProcHe;

             vNlsBanco := dbamv.FNC_FFCV_FIRST_DAY_SEMANA_BR('N',vNlsBanco);



             IF Nvl(vSnReplicaProcHe.sn_replica_proc,'N') = 'S' THEN



                 dbamv.prc_ffcv_replica_proc_he(Nvl(Nconta, Ncdregfat),        -- pCdConta IN NUMBER ,

                                                 Nvl(Nlanc, Ncdlcto) ,          --pCdLancConta IN NUMBER ,

                                                'I',                            --pTpAtend     IN VARCHAR2,

                                                vSnReplicaProcHe.vl_percentual, --pVlPercent   IN NUMBER DEFAULT null,

                                                'N'                             --pSnInsereConta IN VARCHAR2

                                                );



                 dbamv.prc_ffcv_replica_proc_he(Nvl(Nconta, Ncdregfat),

                                            Nvl(Nlanc, Ncdlcto),

                                            'I',

                                            null,

                                            'S');

             END IF;

        END IF;

        /*OP 41394*/



            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

            os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

            IF Nqtexcedeu IS NOT NULL THEN

              Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregfat,

                                                                  Ncdlcto,

                                                                  (Nvl(Nqtconv,

                                                                       Nqtprofat) -

                                                                  Nqtexcedeu),

                                                                  Vtpcontapart,

                                                                  Ddthraux,

																  nvl(v_mvto.cd_atendimento_pai,  v_mvto.cd_atendimento)); /*ALLS OP 43289*/

            END IF;

            /* OP 387 - Thiago Miranda de oliveira - este trecho de c??o somente sera utilizado se a configura? de gerar o item em conta de particular

            por causa do pacote, n?estiver preenchido*/

            IF Nvl(Vtpcontapart, 'X') = 'X' THEN

              IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                            Ncdlcto,

                                                            'I') THEN

                IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                              Ncdlcto,

                                                              'I') THEN

                  Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'I');

                END IF;

              END IF;

            END IF;

          END IF;

          IF v_Mvto.Tp_Convenio <> 'P' AND Nvl(Nqtpart, 0) > 0 AND

             Ctpproibicao = 'AG' THEN

            Ncdregfat := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento,

                                                                      v_Mvto.Dt_Pedido); -- pda 125871 (acrescentada a data)

            INSERT INTO Dbamv.Itreg_Fat

              (Cd_Reg_Fat,

               Cd_Lancamento,

               Dt_Lancamento,

               Hr_Lancamento,

               Qt_Lancamento,

               Cd_Guia,

               Vl_Percentual_Multipla,

               Cd_Gru_Fat,

               Cd_Pro_Fat,

               Sn_Pertence_Pacote,

               Cd_Prestador,

               Tp_Pagamento,

               Cd_Setor,

               Cd_Setor_Produziu,

               Sn_Horario_Especial,

               Cd_Usuario,

               Cd_Mvto,

               Tp_Mvto,

               Cd_Itmvto -- PDA 99872 - 29/12/2005

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Cd_Conta_Pacote

               -- PDA 157145 (Fim)

               )

            VALUES

              (Ncdregfat,

               Ncdlcto

               -- pda 254202(Incio) - Pedro Neiva - 15/10/2008

               /*

                                ,v_mvto.dt_pedido

                                                  ,v_mvto.hr_pedido

                       */,

               Ddthraux,

               Ddthraux

               -- pda 254202(Fim)

              ,

               Nqtpart,

               Ncdguia,

               100,

               Ncdgrufat,

               v_Proced.Cd_Pro_Fat,

               Nvl(Csnpacote, 'N'),

               Nprestador,

               Ctppgto,

               v_Mvto.Cd_Setor,

               Nvl(v_Mvto.Cd_Setor_Set_Exa, v_Mvto.Cd_Setor),

               Csnhoresp,

               USER,

               Ncdpedlab,

               'SADT',

               Ncditemmvto -- PDA 99872 - 29/12/2005

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Ncdpacote

               -- PDA 157145 (Fim)

               );

          END IF;



          DECLARE

             CURSOR c_Relacionados IS

                  SELECT Rela.Cd_Pro_Fat,

                         Rela.Tp_Atend_Homecare,

                         Rela.Tp_Atend_Externo,

                         Rela.Tp_Atend_Urgeme,

                         Rela.Tp_Atend_Ambulatorial,

                         Rela.Tp_Atend_Internacao,

                         Rela.Sn_Faturamento_Direto,

                         Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

                    FROM Dbamv.Regra,

                         Dbamv.Val_Pro_Relacionado Rela,

                         Dbamv.Empresa_Con_Pla

                   WHERE Empresa_Con_Pla.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

                     AND Rela.Tp_Lancamento = 'A'

                     AND EMPRESA_CON_PLA.CD_CONVENIO = V_MVTO.CD_CONVENIO

                     AND EMPRESA_CON_PLA.CD_CON_PLA = V_MVTO.CD_CON_PLA

                     AND Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat

				             AND ((v_Mvto.Tp_Atendimento = 'H' AND

                         Rela.Tp_Atend_Homecare = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'E' AND

                         Rela.Tp_Atend_Externo = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'U' AND

                         Rela.Tp_Atend_Urgeme = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'A' AND

                         Rela.Tp_Atend_Ambulatorial = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'I' AND

                         Rela.Tp_Atend_Internacao = 'S'))

                    AND Empresa_Con_Pla.Cd_Regra = Regra.Cd_Regra

                    AND Rela.Cd_Regra = Regra.Cd_Regra

                    AND RELA.DT_VIGENCIA IN

                     (SELECT MAX(VPR.DT_VIGENCIA)

                        FROM DBAMV.VAL_PRO_RELACIONADO VPR

                       WHERE VPR.DT_VIGENCIA <= V_MVTO.DT_ATENDIMENTO

                         AND VPR.CD_REGRA = RELA.CD_REGRA

                         AND VPR.CD_PRO_FAT_PAI = RELA.CD_PRO_FAT_PAI

                         AND VPR.CD_PRO_FAT = RELA.CD_PRO_FAT)



					      UNION ALL



              SELECT Rela.Cd_Pro_Fat,

                         Rela.Tp_Atend_Homecare,

                         Rela.Tp_Atend_Externo,

                         Rela.Tp_Atend_Urgeme,

                         Rela.Tp_Atend_Ambulatorial,

                         Rela.Tp_Atend_Internacao,

                         Rela.Sn_Faturamento_Direto,

                         Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

                FROM DBAMV.REGRA,

                     DBAMV.VAL_PRO_RELACIONADO RELA,

                     DBAMV.EMPRESA_CON_PLA --,



               WHERE EMPRESA_CON_PLA.CD_MULTI_EMPRESA = DBAMV.PKG_MV2000.LE_EMPRESA

                 AND RELA.CD_PRO_FAT_PAI IS NULL

                 AND RELA.CD_GRU_PRO_PAI = (SELECT P.CD_GRU_PRO

                                              FROM DBAMV.PRO_FAT P

                                             WHERE CD_PRO_FAT = V_PROCED.CD_PRO_FAT)

                 AND EMPRESA_CON_PLA.CD_CONVENIO = V_MVTO.CD_CONVENIO

                 AND EMPRESA_CON_PLA.CD_CON_PLA = V_MVTO.CD_CON_PLA

                 AND RELA.TP_LANCAMENTO = 'A'

                 AND ((V_MVTO.TP_ATENDIMENTO = 'H' AND RELA.TP_ATEND_HOMECARE = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'E' AND RELA.TP_ATEND_EXTERNO = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'U' AND RELA.TP_ATEND_URGEME = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'A' AND RELA.TP_ATEND_AMBULATORIAL = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'I' AND RELA.TP_ATEND_INTERNACAO = 'S'))

                 AND EMPRESA_CON_PLA.CD_REGRA = REGRA.CD_REGRA

                 AND RELA.CD_REGRA = REGRA.CD_REGRA

                 AND RELA.DT_VIGENCIA IN

                     (SELECT MAX(VPR.DT_VIGENCIA)

                        FROM DBAMV.VAL_PRO_RELACIONADO VPR

                       WHERE VPR.DT_VIGENCIA <= V_MVTO.DT_ATENDIMENTO

                         AND VPR.CD_REGRA = RELA.CD_REGRA

                          AND VPR.CD_GRU_PRO_PAI = RELA.CD_GRU_PRO_PAI

                          AND VPR.CD_PRO_FAT = RELA.CD_PRO_FAT

                      );

            Cretorno VARCHAR2(1);

          BEGIN

            FOR Rec_Rela IN c_Relacionados

            LOOP

              -- PDA 189031 Inicio

              -- PDA 225086 (Inicio) - c??o comentado, o mesmo foi colocado antes da chamada da fnc_gera_pacote.

              -- PDA 225086 - Retirado o comentario abaixo

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncdregfat);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                INTO Ncdlctoupdate;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

              -- PDA 225086 (Fim)

              -- PDA 189031 Fim

              Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(v_Mvto.Cd_Atendimento,

                                                            Ncdregfat,

                                                            Ncdlcto,

                                                            Ncdpedlab,

                                                            v_Proced.Cd_Pro_Fat

                                                            /*PDA 116436 14/03/2005 Sp?ola (INCIO)

                                                                                                                       Data e hora devem ser semelhantes ao do insert na itreg_fat*/,

                                                            v_Mvto.Dt_Pedido,

                                                            v_Mvto.Hr_Pedido

                                                            /*PDA 116436 (FIM)*/,

                                                            v_Mvto.Cd_Setor,

                                                            'P',

                                                            v_Mvto.Tp_Atendimento,

                                                            v_Mvto.Dt_Atendimento,

                                                            v_Mvto.Cd_Convenio,

                                                            v_Mvto.Cd_Con_Pla,

                                                            v_Mvto.Cd_Atendimento_Pai,

                                                            v_Mvto.Tp_Convenio,

                                                            v_Mvto.Dt_Alta,

                                                            Rec_Rela.Cd_Pro_Fat, --PDA 108042 22/11/2004 Sp?ola (INICIO)

                                                            --As quantidades lan?a ser?ultiplicadas pelo fator de quantidade qt_lancamento

                                                            Rec_Rela.Qt_Lancamento *

                                                            Nvl(Nqtconv,

                                                                Nqtprofat), --PDA 108042 (FIM)

                                                            0,

                                                            'I'

                                                            --PDA 108070 29/12/2004 Sp?ola (INICIO)

                                                            --Inserido o campo do prestador que ser?tilizado apenas para os procedimentos relacionados de ambulatorio

                                                            --lancadados pela prc_ffcv_lanca_atendimento - lancamento automatico do procedimento principal na criacao do atendimento

                                                           ,

                                                            Nprestador -- PDA 124164 - 25/05/05 - Passando o c??o do prestador, antes era passado nulo.

                                                            --PDA 108070 (FIM)

                                                            -- pda 119975 - 29/05/2005 - Amalia Ara??

                                                            -- par?tro de fator relacionado para insert nas tabelas itreg_amb e itreg_fat

                                                           ,

                                                            Rec_Rela.Qt_Lancamento

                                                            -- pda 119975 - fim

                                                            );

              -- PDA 189031 Inicio

              UPDATE Dbamv.Itreg_Fat

              -- PDA 252143 (Inicio) - Henrique Antunes - 15/10/2008

              --Set cd_setor_produziu = v_mvto.cd_set_exa

                 SET Cd_Setor_Produziu = Nvl(v_Mvto.Cd_Setor_Set_Exa,

                                             v_Mvto.Cd_Setor)

              -- PDA 252143 (Fim)

               WHERE Cd_Reg_Fat = Ncdregfat

                 AND Cd_Lancamento = Ncdlctoupdate;

              -- PDA 189031 Fim

            END LOOP;

          END;

        ELSE

          --PDA 99802 21/07/2004 Sp?ola (INICIO)

          --Abertura do cursor utilizado para recuperar a data de sess?do atendimento

          OPEN Catendsessao(v_Mvto.Cd_Atendimento);

          FETCH Catendsessao

            INTO Vcatendsessao;

          CLOSE Catendsessao;

          --PDA 99802 (FIM)

          IF Limite <> 1 THEN

            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o procedimento que ira ser inserido abaixo pertence a um pacote, e a qunatidade que sera inserida sera menor que a lan?a, a diferen?

            sera lan?a na rotina mais abaixo atravez da procedure PRC_DESVINCULA_PROCEDIMENTO*/

            /* Fazendo tratamento caso o procedimento esteja configurado no gabarito para ser inserido dentro de uma conta particular

            caso a variavel vTpContaPart esteja preenchida e a quantidade de lan?ento extra esteja nula. com iso deve ser procurado uma conta particular

            e um lan?ento para inseririr nesta conta.*/

            Nconta := NULL;

            Nlanc  := NULL;

			/*43289 - quebra de conta por quantidade de procedimento por atendimento*/

			/*A regra de pacote tem prioridade sobre essa regra, conforme vari?l Nqtexcedeu abaixo*/

			IF Nqtexcedeu IS NULL THEN



					  IF DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_EXISTE_CONF_QTD_ATEND_PAC(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																						 v_proced.cd_pro_fat,

																						 pEmpresa) THEN



						  Nqtexcedeu := DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_RETORNA_QTD_LANC_PERIODO(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																									   v_proced.cd_pro_fat,

																									   pEmpresa,

																									   ncdregamb,

																									   nvl(nqtconv, nqtprofat),

																									   pSnChamadoDaTela,

																									   pvSnJaExcedeuQtd,

																									   pvMensagem

																									   );

						  IF pvSnJaExcedeuQtd = 'S' THEN

							  Vtpcontapart := 'ProcPorAtend';

							  Nqtexcedeu   := NULL;

						  ELSE

								IF NVL(Nqtexcedeu,0) > 0 THEN

									Vtpcontapart := 'ProcPorAtend';

								END IF;

						  END IF;

					END IF;

		    END IF;

			/*43289*/

            IF Nvl(Vtpcontapart, 'X') <> 'X' AND Nqtexcedeu IS NULL THEN

              Nconta := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                       v_Mvto.Cd_Atendimento));

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Nconta);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                INTO Nlanc;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;



              /*43289*/

              ncdconvconta := v_config.cd_convenio_fat_extra;

              ncdplanconta := v_config.cd_con_pla_fat_extra;

              /*43289*/



            END IF;

            INSERT INTO Dbamv.Itreg_Amb

              (Cd_Reg_Amb,

               Cd_Lancamento,

               Hr_Lancamento,

               Qt_Lancamento,

               Cd_Gru_Fat,

               Cd_Pro_Fat,

               Cd_Atendimento,

               Cd_Con_Pla,

               Cd_Convenio,

               Sn_Fatura_Impressa,

               Sn_Fechada,

               Sn_Conta_Calculada,

               Cd_Guia,

               Sn_Pertence_Pacote,

               Vl_Percentual_Multipla,

               Cd_Setor,

               Cd_Setor_Produziu,

               Cd_Prestador,

               Tp_Pagamento,

               Sn_Horario_Especial,

               cd_ati_med, -- op  38143

               Cd_Usuario,

               Cd_Mvto,

               Tp_Mvto, --PDA 99802 09/07/2004 Sp?ola (INICIO) (Comentario mais abaixo)

               Dt_Sessao,

               Cd_Itmvto -- PDA 99872 - 29/12/2005

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Cd_Conta_Pacote

               -- PDA 157145 (Fim)

               )

            --PDA 99802 (FIM)

            VALUES

              (Nvl(Nconta, Ncdregamb) -- OP 387

              ,

               Nvl(Nlanc, Ncdlcto) -- OP 387

              ,

               v_Mvto.Hr_Pedido,

               Nvl(Nqtexcedeu, Nvl(Nqtconv, Nqtprofat)) -- OP 387

              ,

               Ncdgrufat,

               v_Proced.Cd_Pro_Fat,

               Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

               Ncdplanconta,

               Ncdconvconta,

               'N',

               'N',

               'N',

               Ncdguia,

               Nvl(Csnpacote, 'N'),

               100,

               v_Mvto.Cd_Setor,

               Nvl(v_Mvto.Cd_Setor_Set_Exa, v_Mvto.Cd_Setor),

               Nprestador,

               Ctppgto,

               Csnhoresp,

               vccdatimed, -- OP 38143

               USER,

               Ncdpedlab,

               Nvl(Vtpcontapart, 'SADT') -- OP 387

              , --PDA 99802 09/07/2004 Sp?ola (INICIO)

               --Se o quantidade de sesS??for maior que zero e o atendimento filho for de retorno,

               --preencher a data da sessao com a data do atendimento filho.

               Decode(Vcatendsessao.Sn_Retorno,

                      'N',

                      NULL,

                      Decode(Vcatendsessao.Qt_Sessoes,

                             0,

                             NULL,

                             Vcatendsessao.Dt_Atendimento))

               --PDA 99802 (FIM)

              ,

               Ncditemmvto -- PDA 99872 - 29/12/2005

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Ncdpacote

               -- PDA 157145 (Fim)

               );





              /*OP 42241 - Caso tenha criado a conta por cargo paciente, devemos lan? o item para o convenio, plano, percentual definido na configura

              de quebra de conta por cargo paciente*/

              IF (vSnCriouContaAutoAmbCP) THEN

                   OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(v_ContaCargoPacAmbu(1).cd_reg_amb);

                   FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                      INTO NcdlctoAmbCp;

                   CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;



                   INSERT INTO Dbamv.Itreg_Amb

                    (Cd_Reg_Amb,

                     Cd_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Cd_Atendimento,

                     Cd_Con_Pla,

                     Cd_Convenio,

                     Sn_Fatura_Impressa,

                     Sn_Fechada,

                     Sn_Conta_Calculada,

                     Cd_Guia,

                     Sn_Pertence_Pacote,

                     Cd_Prestador,

                     Tp_Pagamento,

                     cd_ati_med,

                     Vl_Percentual_Multipla,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto,

                     Dt_Sessao,

                     Cd_Itmvto

                     )

                  VALUES

                    (v_ContaCargoPacAmbu(1).cd_reg_amb,

                     NcdlctoAmbCp,

                     v_Mvto.Hr_Pedido,

                     Nvl(Nqtexcedeu, Nvl(Nqtconv, Nqtprofat)),

                     Ncdgrufat,

                     v_Proced.Cd_Pro_Fat,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                     vRegraCriaContaAutoCP(1).cd_convenio_destino,

                     'N',

                     'N',

                     'N',

                     Ncdguia,

                     'N',

                     Nprestador,

                     Ctppgto,

                     vccdatimed,

                     vRegraCriaContaAutoCP(1).vl_percentual_carga_familiar,

                     v_Mvto.Cd_Setor,

                     Nvl(v_Mvto.Cd_Setor_Set_Exa, v_Mvto.Cd_Setor),

                     'N',

                     USER,

                     Ncdpedlab,

                     Nvl(Vtpcontapart, 'SADT'),

                     Decode(Vcatendsessao.Sn_Retorno,

                             'N',

                             NULL,

                             Decode(Vcatendsessao.Qt_Sessoes,

                                   0,

                                   NULL,

                                   Vcatendsessao.Dt_Atendimento)),

                     Ncditemmvto

                     );

              END IF;

              /*OP 42241*/



             /*OP 41394 - replicar horario especial no lan?ento autom?co. Incialmente implementa? pro cliente HOSCAR*/

        IF (nvl(Csnhoresp,'N') = 'S'

            AND (NOT vSnCriouContaAutoAmb) /*n??m item de regra de quebra de conta autom?ca*/

            AND vSnReplicaProc = 'S' )     /*tem regra pra replicar proc de hor?o especial*/

            THEN



             OPEN cProced(v_Proced.Cd_Pro_Fat);

             FETCH cProced INTO vProced;

             CLOSE cProced;



             OPEN cRregra(Ncdconvconta,Ncdplanconta);

             FETCH cRregra INTO vRregra;

             CLOSE cRregra;



             vNlsBanco := dbamv.FNC_FFCV_FIRST_DAY_SEMANA_BR('S',null);

             OPEN dbamv.pack_lanca_ffcv.cSnReplicaProcHe(vRregra.cd_regra,

                                                         vProced.cd_gru_pro,

                                                         v_Proced.Cd_Pro_Fat,

                                                         TO_NUMBER(TO_CHAR(v_Mvto.Dt_Pedido, 'd')),

                                                         v_Mvto.Hr_Pedido,

                                                         v_Mvto.Tp_Atendimento);

             FETCH dbamv.pack_lanca_ffcv.cSnReplicaProcHe INTO vSnReplicaProcHe;

             CLOSE dbamv.pack_lanca_ffcv.cSnReplicaProcHe;

             vNlsBanco := dbamv.FNC_FFCV_FIRST_DAY_SEMANA_BR('N',vNlsBanco);



             IF Nvl(vSnReplicaProcHe.sn_replica_proc,'N') = 'S' THEN



                 dbamv.prc_ffcv_replica_proc_he(Nvl(Nconta, Ncdregamb),         -- pCdConta IN NUMBER ,

                                                Nvl(Nlanc, Ncdlcto),            --pCdLancConta IN NUMBER ,

                                                'A',                            --pTpAtend     IN VARCHAR2,

                                                vSnReplicaProcHe.vl_percentual, --pVlPercent   IN NUMBER DEFAULT null,

                                                'N'                             --pSnInsereConta IN VARCHAR2

                                                );



                 dbamv.prc_ffcv_replica_proc_he(Nvl(Nconta, Ncdregamb),

                                            Nvl(Nlanc, Ncdlcto),

                                            'A',

                                            null,

                                            'S');

             END IF;

        END IF;

        /*OP 41394*/



            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

            os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

            IF Nqtexcedeu IS NOT NULL THEN

              Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregamb,

                                                                  Ncdlcto,

                                                                  (Nvl(Nqtconv,

                                                                       Nqtprofat) -

                                                                  Nqtexcedeu),

                                                                  Vtpcontapart,

                                                                  v_Mvto.Hr_Pedido,

																  nvl(v_mvto.cd_atendimento_pai, v_mvto.cd_atendimento)); /*ALLS OP 43289*/



            END IF;

          END IF;

          IF v_Mvto.Tp_Convenio <> 'P' AND Nvl(Nqtpart, 0) > 0 AND

             Ctpproibicao = 'AG' THEN

            Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(v_Mvto.Cd_Atendimento);

            -- pda 101673 inicio (passar o convenio correto p/ a conta extra)

            -- pda 110561 - 18/11/2004 - Amalia Ara??

            --nCdConvConta := V_Mvto.Cd_Convenio_secundario;

            --nCdPlanConta := V_Mvto.Cd_Con_Pla_secundario;

            -- O correto ?egar o plano e convenio extra da config_ffcv

            Ncdconvconta := v_Config.Cd_Convenio_Fat_Extra;

            Ncdplanconta := v_Config.Cd_Con_Pla_Fat_Extra;

            -- pda 110561 - fim

            --- pda 101673 fim

            INSERT INTO Dbamv.Itreg_Amb

              (Cd_Reg_Amb,

               Cd_Lancamento,

               Hr_Lancamento,

               Qt_Lancamento,

               Cd_Gru_Fat,

               Cd_Pro_Fat,

               Cd_Atendimento,

               Cd_Con_Pla,

               Cd_Convenio,

               Sn_Fatura_Impressa,

               Sn_Fechada,

               Sn_Conta_Calculada,

               Cd_Guia,

               Sn_Pertence_Pacote,

               Vl_Percentual_Multipla,

               Cd_Setor,

               Cd_Setor_Produziu,

               Cd_Prestador,

               Tp_Pagamento,

               Sn_Horario_Especial,

               Cd_Usuario,

               Cd_Mvto,

               Tp_Mvto, --PDA 99802 09/07/2004 Sp?ola (INICIO) (Comentario mais abaixo)

               Dt_Sessao,

               Cd_Itmvto -- PDA 99872 - 29/12/2005

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Cd_Conta_Pacote

               -- PDA 157145 (Fim)

               )

            --PDA 99802 (FIM)

            VALUES

              (Ncdregamb,

               Ncdlcto,

               v_Mvto.Hr_Pedido,

               Nqtpart,

               Ncdgrufat,

               v_Proced.Cd_Pro_Fat,

               Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

               Ncdplanconta,

               Ncdconvconta,

               'N',

               'N',

               'N',

               Ncdguia,

               Nvl(Csnpacote, 'N'),

               100,

               v_Mvto.Cd_Setor,

               Nvl(v_Mvto.Cd_Setor_Set_Exa, v_Mvto.Cd_Setor),

               Nprestador,

               Ctppgto,

               Csnhoresp,

               USER,

               Ncdpedlab,

               'SADT', --PDA 99802 09/07/2004 Sp?ola (INICIO)

               --Se o quantidade de sesS??for maior que zero e o atendimento filho for de retorno,

               --preencher a data da sessao com a data do atendimento filho.

               Decode(Vcatendsessao.Sn_Retorno,

                      'N',

                      NULL,

                      Decode(Vcatendsessao.Qt_Sessoes,

                             0,

                             NULL,

                             Vcatendsessao.Dt_Atendimento))

               --PDA 99802 (FIM)

              ,

               Ncditemmvto -- PDA 99872 - 29/12/2005

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Ncdpacote

               -- PDA 157145 (Fim)

               );

          END IF;



          -- PDA 197953 (In?o) - 08/08/2007 - Diego Costa

          -- inclus?de verifica? a regra de atendimento pro_fat antes da regra de acoplamaneto

          IF NOT

              Dbamv.Pack_Ffcv.Regra_Atendimento_Ambu(Ncdregamb, Ncdlcto, 'I') THEN

            IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Ambu(Ncdregamb,

                                                          Ncdlcto,

                                                          'I') THEN

              Verif_Franquia_Ambu(Ncdregamb, Ncdlcto, 'I');

            END IF;

          END IF;

          -- PDA 197953 (Fim)

          -- PDA 134086 (Inicio) - Henrique Antunes - 27/09/2005

          --END IF;

          -- PDA 134086 (Fim)

          DECLARE

             CURSOR c_Relacionados IS

                  SELECT Rela.Cd_Pro_Fat,

                         Rela.Tp_Atend_Homecare,

                         Rela.Tp_Atend_Externo,

                         Rela.Tp_Atend_Urgeme,

                         Rela.Tp_Atend_Ambulatorial,

                         Rela.Tp_Atend_Internacao,

                         Rela.Sn_Faturamento_Direto,

                         Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

                    FROM Dbamv.Regra,

                         Dbamv.Val_Pro_Relacionado Rela,

                         Dbamv.Empresa_Con_Pla

                   WHERE Empresa_Con_Pla.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

                     AND Rela.Tp_Lancamento = 'A'

                     AND EMPRESA_CON_PLA.CD_CONVENIO = V_MVTO.CD_CONVENIO

                     AND EMPRESA_CON_PLA.CD_CON_PLA = V_MVTO.CD_CON_PLA

                     AND Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat

				             AND ((v_Mvto.Tp_Atendimento = 'H' AND

                         Rela.Tp_Atend_Homecare = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'E' AND

                         Rela.Tp_Atend_Externo = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'U' AND

                         Rela.Tp_Atend_Urgeme = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'A' AND

                         Rela.Tp_Atend_Ambulatorial = 'S') OR

                         (v_Mvto.Tp_Atendimento = 'I' AND

                         Rela.Tp_Atend_Internacao = 'S'))

                    AND Empresa_Con_Pla.Cd_Regra = Regra.Cd_Regra

                    AND Rela.Cd_Regra = Regra.Cd_Regra

                    AND RELA.DT_VIGENCIA IN

                     (SELECT MAX(VPR.DT_VIGENCIA)

                        FROM DBAMV.VAL_PRO_RELACIONADO VPR

                       WHERE VPR.DT_VIGENCIA <= V_MVTO.DT_ATENDIMENTO

                         AND VPR.CD_REGRA = RELA.CD_REGRA

                         AND VPR.CD_PRO_FAT_PAI = RELA.CD_PRO_FAT_PAI

                         AND VPR.CD_PRO_FAT = RELA.CD_PRO_FAT)



					      UNION ALL



              SELECT Rela.Cd_Pro_Fat,

                         Rela.Tp_Atend_Homecare,

                         Rela.Tp_Atend_Externo,

                         Rela.Tp_Atend_Urgeme,

                         Rela.Tp_Atend_Ambulatorial,

                         Rela.Tp_Atend_Internacao,

                         Rela.Sn_Faturamento_Direto,

                         Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

                FROM DBAMV.REGRA,

                     DBAMV.VAL_PRO_RELACIONADO RELA,

                     DBAMV.EMPRESA_CON_PLA --,



               WHERE EMPRESA_CON_PLA.CD_MULTI_EMPRESA = DBAMV.PKG_MV2000.LE_EMPRESA

                 AND RELA.CD_PRO_FAT_PAI IS NULL

                 AND RELA.CD_GRU_PRO_PAI = (SELECT P.CD_GRU_PRO

                                              FROM DBAMV.PRO_FAT P

                                             WHERE CD_PRO_FAT = V_PROCED.CD_PRO_FAT)

                 AND EMPRESA_CON_PLA.CD_CONVENIO = V_MVTO.CD_CONVENIO

                 AND EMPRESA_CON_PLA.CD_CON_PLA = V_MVTO.CD_CON_PLA

                 AND RELA.TP_LANCAMENTO = 'A'

                 AND ((V_MVTO.TP_ATENDIMENTO = 'H' AND RELA.TP_ATEND_HOMECARE = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'E' AND RELA.TP_ATEND_EXTERNO = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'U' AND RELA.TP_ATEND_URGEME = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'A' AND RELA.TP_ATEND_AMBULATORIAL = 'S') OR

                     (V_MVTO.TP_ATENDIMENTO = 'I' AND RELA.TP_ATEND_INTERNACAO = 'S'))

                 AND EMPRESA_CON_PLA.CD_REGRA = REGRA.CD_REGRA

                 AND RELA.CD_REGRA = REGRA.CD_REGRA

                 AND RELA.DT_VIGENCIA IN

                     (SELECT MAX(VPR.DT_VIGENCIA)

                        FROM DBAMV.VAL_PRO_RELACIONADO VPR

                       WHERE VPR.DT_VIGENCIA <= V_MVTO.DT_ATENDIMENTO

                         AND VPR.CD_REGRA = RELA.CD_REGRA

                          AND VPR.CD_GRU_PRO_PAI = RELA.CD_GRU_PRO_PAI

                          AND VPR.CD_PRO_FAT = RELA.CD_PRO_FAT

                      );



            Cretorno VARCHAR2(1);

          BEGIN

            FOR Rec_Rela IN c_Relacionados

            LOOP

              -- PDA 189031 Inicio

              -- PDA 252143 (Inicio) - Henrique Antunes - 16/10/2008

              --OPEN dbamv.pack_lanca_ffcv.c_maxlcto (ncdregfat);

              --FETCH dbamv.pack_lanca_ffcv.c_maxlcto INTO ncdlctoUpdate;

              --CLOSE dbamv.pack_lanca_ffcv.c_maxlcto;

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Ncdregamb);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                INTO Ncdlctoupdate;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;

              -- PDA 252143 (Fim)

              -- PDA 189031 Fim

              Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(v_Mvto.Cd_Atendimento,

                                                            Ncdregamb,

                                                            Ncdlcto,

                                                            Ncdpedlab,

                                                            v_Proced.Cd_Pro_Fat,

                                                            v_Mvto.Dt_Atendimento

                                                            /*PDA 116436 14/03/2005 Sp?ola (INICIO)

                                                                                                                      A hora de lancamento deve ser semelhante ao do insert na itreg_amb*/,

                                                            v_Mvto.Hr_Pedido

                                                            /*PDA 116436 (FIM)*/,

                                                            v_Mvto.Cd_Setor,

                                                            'P',

                                                            v_Mvto.Tp_Atendimento,

                                                            v_Mvto.Dt_Atendimento,

                                                            v_Mvto.Cd_Convenio,

                                                            v_Mvto.Cd_Con_Pla,

                                                            v_Mvto.Cd_Atendimento_Pai,

                                                            v_Mvto.Tp_Convenio,

                                                            v_Mvto.Dt_Alta,

                                                            Rec_Rela.Cd_Pro_Fat, --PDA 108042 22/11/2004 Sp?ola (INICIO)

                                                            --As quantidades lan?a ser?ultiplicadas pelo fator de quantidade qt_lancamento

                                                            Rec_Rela.Qt_Lancamento *

                                                            Nvl(Nqtconv,

                                                                Nqtprofat), --PDA 108042 (FIM)

                                                            0,

                                                            'I'

                                                            --PDA 108070 29/12/2004 Sp?ola (INICIO)

                                                            --Inserido o campo do prestador que ser?tilizado apenas para os procedimentos relacionados de ambulatorio

                                                            --lancadados pela prc_ffcv_lanca_atendimento - lancamento automatico do procedimento principal na criacao do atendimento

                                                           ,

                                                            Nprestador -- PDA 124164 - 25/05/05 - Passando o c??o do prestador, antes era passado nulo.

                                                            --PDA 108070 (FIM)

                                                            -- pda 119975 - 29/05/2005 - Amalia Ara??

                                                            -- par?tro de fator relacionado para insert nas tabelas itreg_amb e itreg_fat

                                                           ,

                                                            Rec_Rela.Qt_Lancamento

                                                            -- pda 119975 - fim

                                                            );

              -- PDA 189031 Inicio

              -- PDA 252143 (Inicio) - Henrique Antunes - 16/10/2008

              --Update dbamv.itreg_fat

              --   Set cd_setor_produziu = v_mvto.cd_set_exa

              -- Where cd_reg_fat    = ncdregfat

              --   And cd_lancamento = ncdlctoUpdate;

              UPDATE Dbamv.Itreg_Amb

                 SET Cd_Setor_Produziu = Nvl(v_Mvto.Cd_Setor_Set_Exa,

                                             v_Mvto.Cd_Setor)

               WHERE Cd_Reg_Amb = Ncdregamb

                 AND Cd_Lancamento = Ncdlctoupdate;

              -- PDA 252143 (Fim)

            -- PDA 189031 Fim

            END LOOP;

          END;

          -- PDA 134086 (Inicio) - Henrique Antunes - 27/09/2005

        END IF;

        -- PDA 134086 (Fim)

        --

      ELSE

        --   bExclui

        IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') OR

           v_Mvto.Sn_Importa_Auto = 'S' THEN

          --

          OPEN c_Itreg_Fat_Pssd(Ncdregfat, v_Proced.Cd_Pro_Fat, Ncdpedlab);

          FETCH c_Itreg_Fat_Pssd

            INTO v_Itregfat;

          CLOSE c_Itreg_Fat_Pssd;

          --

          Ndiferenca := -1;

          -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

          Ncdregfat := v_Itregfat.Cd_Reg_Fat;

          -- PDA 167142 (Fim)

          Ncdlcto := v_Itregfat.Cd_Lancamento;

          --

          IF v_Itregfat.Cd_Lancamento IS NOT NULL THEN

            IF v_Itregfat.Qt_Lancamento + Ndiferenca <= 0 THEN

              --

              IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                            Ncdlcto,

                                                            'E') THEN

                IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                              Ncdlcto,

                                                              'E') THEN

                  Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'E');

                END IF;

              END IF;

              --

              --PDA 212965(INICIO)

              OPEN Cfatfilho(Ncdregfat, Ncdlcto);

              FETCH Cfatfilho

                INTO Vfatfilho;

              IF Cfatfilho%FOUND THEN

                CLOSE Cfatfilho;

                OPEN Cfatfechada(Vfatfilho.Cd_Reg_Fat);

                FETCH Cfatfechada

                  INTO Vfatfechada;

                CLOSE Cfatfechada;

                IF Nvl(Vfatfechada.Sn_Fechada, 'N') = 'N' THEN

                  DELETE FROM Dbamv.Itreg_Fat

                   WHERE Itreg_Fat.Cd_Reg_Fat = Vfatfilho.Cd_Reg_Fat

                     AND Itreg_Fat.Cd_Reg_Fat_Pai =

                         Vfatfilho.Cd_Reg_Fat_Pai

                     AND Itreg_Fat.Cd_Lancamento_Pai =

                         Vfatfilho.Cd_Lancamento_Pai;

                ELSE

                  UPDATE Dbamv.Itreg_Fat

                     SET Itreg_Fat.Cd_Reg_Fat_Pai    = NULL,

                         Itreg_Fat.Cd_Lancamento_Pai = NULL

                   WHERE Itreg_Fat.Cd_Reg_Fat = Vfatfilho.Cd_Reg_Fat

                     AND Itreg_Fat.Cd_Reg_Fat_Pai =

                         Vfatfilho.Cd_Reg_Fat_Pai

                     AND Itreg_Fat.Cd_Lancamento_Pai =

                         Vfatfilho.Cd_Lancamento_Pai;

                END IF;

              END IF;

              --PDA 212965(FIM)

              -- pda 137698 inicio  (excluir os relacionados)

              DELETE FROM Dbamv.Itreg_Fat

               WHERE Cd_Reg_Fat = Ncdregfat

                 AND Cd_Lancamento_Rel = Ncdlcto

                 AND Cd_Reg_Fat_Rel = Ncdregfat;

              -- pda 137698 fim

              --

              -- OP 684 - 13/12/2013 - corrigindo local de abertura do cursor, antes de deletar o registro na itreg_fat

              Ncdguiaitem := NULL;

              OPEN Dbamv.Pkg_Ffcv_Guia.Cguianoitem(Ncdregfat,

                                                   Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                       v_Mvto.Cd_Atendimento),

                                                   Ncdlcto);

              FETCH Dbamv.Pkg_Ffcv_Guia.Cguianoitem

                INTO Ncdguiaitem;

              CLOSE Dbamv.Pkg_Ffcv_Guia.Cguianoitem;



              DELETE FROM Dbamv.Itreg_Fat

               WHERE Cd_Reg_Fat = Ncdregfat

                 AND Cd_Lancamento = Ncdlcto;

              --

              /* pda 141006 - 06/06/2006 - Amalia Ara??

              Identificando a guia do item. Caso encontre e a mesma ainda esteja Pendente.

              Retirando o item da guia, caso haja e a guia ainda esteja Pendente.             */

              --

              IF Ncdguiaitem IS NOT NULL THEN

                Dbamv.Pkg_Ffcv_Guia.Prc_Retirar_Item_Guia(Ncdguiaitem,

                                                          v_Proced.Cd_Pro_Fat,

                                                          v_Itregfat.Qt_Lancamento);

              END IF;

              /* pda 141006 - fim */

              --

              /* PDA 288525 - 05/06/2009 - In?o - Fabr?o Oliveira de Miranda */

            ELSE

              --

              UPDATE Dbamv.Itreg_Fat

                 SET Qt_Lancamento           = Qt_Lancamento + Ndiferenca,

                     Vl_Unitario             = NULL,

                     Vl_Filme_Unitario       = NULL,

                     Vl_Acrescimo            = NULL,

                     Vl_Desconto             = NULL,

                     Vl_Honorario_Unitario   = NULL,

                     Vl_Operacional_Unitario = NULL,

                     Vl_Total_Conta          = NULL,

                     Cd_Prestador            = Nprestador

               WHERE Cd_Reg_Fat = Ncdregfat

                 AND Cd_Lancamento = Ncdlcto;

              --

              IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                            Ncdlcto,

                                                            'A') THEN

                --

                IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                              Ncdlcto,

                                                              'A') THEN

                  Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'A');

                END IF;

                --

              END IF;

            END IF;

          END IF;

          --

        ELSE

          --

          OPEN c_Itreg_Amb_Pssd(Ncdregamb,

                                v_Proced.Cd_Pro_Fat,

                                v_Mvto.Cd_Atendimento,

                                Ncdpedlab);

          FETCH c_Itreg_Amb_Pssd

            INTO v_Itregamb;

          CLOSE c_Itreg_Amb_Pssd;

          --

          Ndiferenca := -1;

          Ncdlcto    := v_Itregamb.Cd_Lancamento;

          --

          IF v_Itregamb.Cd_Lancamento IS NOT NULL THEN

            IF v_Itregamb.Qt_Lancamento + Ndiferenca <= 0 THEN

              --

              -- PDA 197953 (In?o) - 08/08/2007 - Diego Costa

              -- inclus?de verifica? a regra de atendimento pro_fat antes da regra de acoplamaneto

              IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Ambu(Ncdregamb,

                                                            Ncdlcto,

                                                            'E') THEN

                IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Ambu(Ncdregamb,

                                                              Ncdlcto,

                                                              'E') THEN

                  Verif_Franquia_Ambu(Ncdregamb, Ncdlcto, 'E');

                END IF;

              END IF;

              -- PDA 197953 (Fim)

              --PDA 212965(INICIO)

              OPEN Cambfilho(Ncdregamb, v_Mvto.Cd_Atendimento, Ncdlcto);

              FETCH Cambfilho

                INTO Vambfilho;

              IF Cambfilho%FOUND THEN

                CLOSE Cambfilho;

                IF Nvl(Vambfilho.Sn_Fechada, 'N') = 'N' THEN

                  DELETE FROM Dbamv.Itreg_Amb

                   WHERE Itreg_Amb.Cd_Reg_Amb_Pai =

                         Vambfilho.Cd_Reg_Amb_Pai

                     AND Itreg_Amb.Cd_Lancamento_Pai =

                         Vambfilho.Cd_Lancamento_Pai

                     AND Itreg_Amb.Cd_Atendimento =

                         Vambfilho.Cd_Atendimento;

                ELSE

                  UPDATE Dbamv.Itreg_Amb

                     SET Itreg_Amb.Cd_Reg_Amb_Pai    = NULL,

                         Itreg_Amb.Cd_Lancamento_Pai = NULL

                   WHERE Itreg_Amb.Cd_Reg_Amb_Pai =

                         Vambfilho.Cd_Reg_Amb_Pai

                     AND Itreg_Amb.Cd_Lancamento_Pai =

                         Vambfilho.Cd_Lancamento_Pai

                     AND Itreg_Amb.Cd_Atendimento =

                         Vambfilho.Cd_Atendimento;

                END IF;

              END IF;

              --PDA 212965(FIM)

              -- pda 137698 inicio  (excluir os relacionados)

              DELETE FROM Dbamv.Itreg_Amb

               WHERE Cd_Lancamento_Rel = Ncdlcto

                 AND Cd_Atendimento = v_Mvto.Cd_Atendimento

                 AND Cd_Reg_Amb_Rel = Ncdregamb

                 AND sn_fechada = 'N';

              -- pda 137698 fim

              --

              -- OP 684 - 13/12/2013 - corrigindo local de abertura do cursor, antes de deletar o registro na itreg_fat

              Ncdguiaitem := NULL;

              OPEN Dbamv.Pkg_Ffcv_Guia.Cguianoitem(Ncdregamb,

                                                   Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                       v_Mvto.Cd_Atendimento),

                                                   Ncdlcto);

              FETCH Dbamv.Pkg_Ffcv_Guia.Cguianoitem

                INTO Ncdguiaitem;

              CLOSE Dbamv.Pkg_Ffcv_Guia.Cguianoitem;

              --

              --

              DELETE FROM Dbamv.Itreg_Amb

               WHERE Cd_Reg_Amb = Ncdregamb

                 AND Cd_Lancamento = Ncdlcto

                 AND Cd_Atendimento = v_Mvto.Cd_Atendimento;

              --

              /* pda 141006 - 06/06/2006 - Amalia Ara??

              Identificando a guia do item. Caso encontre e a mesma ainda esteja Pendente.

              Retirando o item da guia, caso haja e a guia ainda esteja Pendente.             */

              --

              IF Ncdguiaitem IS NOT NULL THEN

                Dbamv.Pkg_Ffcv_Guia.Prc_Retirar_Item_Guia(Ncdguiaitem,

                                                          v_Proced.Cd_Pro_Fat,

                                                          v_Itregamb.Qt_Lancamento);

              END IF;

              /* pda 141006 - fim */

            ELSE

              --

              UPDATE Dbamv.Itreg_Amb

                 SET Qt_Lancamento           = Qt_Lancamento + Ndiferenca,

                     Vl_Unitario             = NULL,

                     Vl_Filme_Unitario       = NULL,

                     Vl_Acrescimo            = NULL,

                     Vl_Desconto             = NULL,

                     Vl_Honorario_Unitario   = NULL,

                     Vl_Operacional_Unitario = NULL,

                     Vl_Total_Conta          = NULL,

                     Cd_Prestador            = Nprestador

               WHERE Cd_Reg_Amb = Ncdregamb

                 AND Cd_Lancamento = Ncdlcto

                 AND Cd_Atendimento = v_Mvto.Cd_Atendimento;

              --

              -- PDA 197953 (In?o) - 08/08/2007 - Diego Costa

              -- inclus?de verifica? a regra de atendimento pro_fat antes da regra de acoplamaneto

              IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Ambu(Ncdregamb,

                                                            Ncdlcto,

                                                            'A') THEN

                IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Ambu(Ncdregamb,

                                                              Ncdlcto,

                                                              'A') THEN

                  Verif_Franquia_Ambu(Ncdregamb, Ncdlcto, 'A');

                END IF;

              END IF;

              -- PDA 197953 (Fim)

              --

            END IF;

          END IF;

        END IF;

      END IF;

    END IF;



	dbamv.pkg_mv2000.atribui_empresa(vCdEmpresaAtual); --FATURCONV-2931



  EXCEPTION

    WHEN Atend_Sem_Conta THEN

	  dbamv.pkg_mv2000.atribui_empresa(vCdEmpresaAtual); --FATURCONV-2931

	  -- FATURCONV-964 - OP 46678 - Se bExclui for true, vai gravar cdigo 13 como indicado no documento, ao invs de 04.

	  if bExclui then

		  Gera_Log_Falha(Ncdregfat,

						         Ncdregamb,

						         Ncdpedlab,

						         Ncditemmvto,

						         v_Proced.Cd_Pro_Fat,

						         'SADT',

						         '13',

                     'Cancelamento/Exclusao de Exame sem Conta Aberta/Disponivel.',

						      /*   Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_21',

														   'PACK_LANCA_FFCV',

														   'Cancelamento/Exclusao de Exame sem Conta Aberta/Disponivel.',

														   Arg_List()),  */

						         v_Mvto.Tp_Atendimento,

						         Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

						         TRUE,

						         Deleting,

						         v_Mvto.Dt_Pedido  );

	  else

	  -- OP 46678 - fim

		  Gera_Log_Falha(Ncdregfat

						,Ncdregamb

						,Ncdpedlab,

						 Ncditemmvto,

						 v_Proced.Cd_Pro_Fat,

						 'SADT',

						 '04'

						,Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_4',

														   'PACK_LANCA_FFCV',

														   'Atendimento %s nao possui Conta aberta/disponivel.',

														   Arg_List(v_Mvto.Cd_Atendimento)) -- OP 10402

						,v_Mvto.Tp_Atendimento,

						 Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

						 TRUE,

						 Deleting,

						 v_Mvto.Dt_Pedido);

	  end if;

    WHEN Fora_Da_Conta THEN

      dbamv.pkg_mv2000.atribui_empresa(vCdEmpresaAtual); --FATURCONV-2931

	  Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdpedlab,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'SADT',

                     '08'

                     --,'Procedimento com proibi? tipo Fora da Conta'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_8',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento com proibi? tipo Fora da Conta.',



                                                       Arg_List()) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     v_Mvto.Dt_Pedido);

    WHEN Prod_Nao_Conf THEN

      dbamv.pkg_mv2000.atribui_empresa(vCdEmpresaAtual); --FATURCONV-2931

	  Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdpedlab,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'SADT',

                     '01'

                     --,'Exame de Diagn??co(PSSD) n?tem relacionamento com Faturamento de Convenio(FFCV)'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_18',

                                                       'PACK_LANCA_FFCV',

                                                       'Exame de Diagnostico Laboratorial n?tem relacionamento com Faturamento de convenio.',

                                                       Arg_List()) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     v_Mvto.Dt_Pedido);

    WHEN Setor_Nao_Conf THEN

      dbamv.pkg_mv2000.atribui_empresa(vCdEmpresaAtual); --FATURCONV-2931

	  Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdpedlab,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'SADT',

                     '02'

                     --, 'Grupo de Procedimento ' || v_proced.cd_gru_pro || ' n?tem Grupo de Faturamento relacionado'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_14',

                                                       'PACK_LANCA_FFCV',

                                                       'Grupo de Procedimento %s n?tem Grupo de Faturamento relacionado.',



                                                       Arg_List(v_Proced.Cd_Gru_Pro)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     v_Mvto.Dt_Pedido);

    WHEN Proc_Proibido THEN

      dbamv.pkg_mv2000.atribui_empresa(vCdEmpresaAtual); --FATURCONV-2931

	  Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdpedlab,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'SADT',

                     '05'

                     --, 'Procedimento proibido para o Convenio ' || LTRIM (TO_CHAR (v_conta.cd_convenio)) || ' e Plano ' || LTRIM (TO_CHAR (v_conta.cd_con_pla)) --PDA 157595

                     --, 'Procedimento proibido para o Convenio ' || LTRIM (TO_CHAR (nCdConvConta)) || ' e Plano ' || LTRIM (TO_CHAR (nCdPlanConta)) --PDA 157595

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_7',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento proibido para o convenio %s e Plano %s.',

                                                       Arg_List(Ltrim(To_Char(Ncdconvconta)),

                                                                Ltrim(To_Char(Ncdplanconta)))) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     v_Mvto.Dt_Pedido);

    -- OP 32555

    WHEN Proc_Proibido_idade THEN

	  dbamv.pkg_mv2000.atribui_empresa(vCdEmpresaAtual); --FATURCONV-2931

	  -- OP 33697 - 05/10/2015 - Substituindo Gera_Log_Falha por Raise_Application_Error.

       Raise_Application_Error(-20054, Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20','PACK_LANCA_FFCV',

                                'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                Arg_List(v_Proced.Cd_Pro_Fat)));

      /*Gera_Log_Falha(Ncdregfat,

                     Ncdregamb ,

                     Ncdpedlab,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'SADT',

                     '05',

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                                       Arg_List(v_Proced.Cd_Pro_Fat))

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     v_Mvto.Dt_Pedido); */

    WHEN Auditoria_In_Loco THEN

      dbamv.pkg_mv2000.atribui_empresa(vCdEmpresaAtual); --FATURCONV-2931

	  Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdpedlab,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'SADT',

                     '10'

                     --, 'O periodo da conta ' || v_conta.cd_reg_fat || ' est?m auditoria in-loco no momento do lan?ento' --PDA 157595

                     --, 'O periodo da conta ' || nCdRegFat || ' est?m auditoria in-loco no momento do lan?ento' --PDA 157595

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_15',

                                                       'PACK_LANCA_FFCV',

                                                       'O periodo da conta %s est?m auditoria in-loco no momento do lan?ento.',

                                                       Arg_List(Ncdregfat)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     v_Mvto.Dt_Pedido);

  END;



  PROCEDURE Lanca_Para_Ffcv(Ncdatendimento IN NUMBER,

                            Cprofat        IN VARCHAR2,

                            Nqtde          IN Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*NUMBER PDA 254997*/,

                            Caction        IN VARCHAR2) IS

    CURSOR c_Mvto IS

      SELECT Atendime.Tp_Atendimento,

             Atendime.Cd_Prestador

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- atendime.dt_atendimento

            ,

             To_Date(To_Char(Atendime.Dt_Atendimento, 'DD/MM/YYYY') || ' ' ||

                     To_Char(Atendime.Hr_Atendimento, 'HH24:Mi:SS'),

                     'DD/MM/YYYY HH24:MI:SS') Dt_Atendimento

             -- PDA 229502 (Fim)

            ,

             Atendime.Hr_Atendimento,

             Ori_Ate.Cd_Setor,

             Atendime.Cd_Convenio,

             Atendime.Cd_Con_Pla,

             Atendime.Cd_Atendimento_Pai,

             Atendime.Cd_Ori_Ate -- PDA 100970 27/06/2006 Thiago Holder Marcos Silva

            ,

             Convenio.Tp_Convenio,

             Atendime.Cd_Atendimento

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- ,atendime.dt_alta

            ,

             To_Date(To_Char(Atendime.Dt_Alta, 'dd/mm/yyyy') ||

                     To_Char(Atendime.Hr_Alta, 'hh24:mi'),

                     'dd/mm/yyyy hh24:mi') Dt_Alta

      -- PDA 229502 (Fim)

        FROM Dbamv.Atendime,

             Dbamv.Ori_Ate,

             Dbamv.Convenio,

             Dbamv.Empresa_Convenio

       WHERE Atendime.Cd_Atendimento = Ncdatendimento

         AND Convenio.Cd_Convenio = Empresa_Convenio.Cd_Convenio /* PDA 118607/129023*/

         AND Empresa_Convenio.Cd_Multi_Empresa =

             Dbamv.Pkg_Mv2000.Le_Empresa

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/129023*/

         AND Ori_Ate.Cd_Ori_Ate = Atendime.Cd_Ori_Ate

         AND Convenio.Cd_Convenio = Atendime.Cd_Convenio

         AND Convenio.Tp_Convenio IN ('H', 'P', 'C');

    CURSOR c_Config IS

      SELECT Config_Ffcv.Sn_Para_Automatica,

             Config_Ffcv.Cd_Ati_Med_Clinico,

             Config_Ffcv.Cd_Convenio_Fat_Extra,

             Config_Ffcv.Cd_Con_Pla_Fat_Extra,

             Config_Ffcv.Tp_Controle_Lote,

             Config_Ffcv.Sn_Guia_Proc_Auto

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    CURSOR c_Grufat(Nsetor IN NUMBER) IS

      SELECT Nvl(Setor_Gru_Fat.Cd_Gru_Fat, Gru_Pro.Cd_Gru_Fat) Cd_Gru_Fat

        FROM Dbamv.Setor_Gru_Fat,

             Dbamv.Pro_Fat,

             Dbamv.Gru_Pro

       WHERE Setor_Gru_Fat.Cd_Setor = Nsetor

         AND Pro_Fat.Cd_Pro_Fat = Cprofat

         AND Setor_Gru_Fat.Cd_Gru_Pro = Pro_Fat.Cd_Gru_Pro

         AND Pro_Fat.Cd_Gru_Pro = Gru_Pro.Cd_Gru_Pro;

    CURSOR c_Existelfaamb(Nconta IN Dbamv.Log_Falha_Importacao.Cd_Reg_Amb%TYPE /*NUMBER PDA 254997*/

    , Nmvtofalha IN NUMBER, Ctperro IN VARCHAR2, Ctpimportacao IN VARCHAR2) IS

      SELECT Lfa.Cd_Log_Falha_Importacao

        FROM Dbamv.Log_Falha_Importacao Lfa

       WHERE Lfa.Cd_Reg_Amb = Nconta

         AND Lfa.Cd_Mvto_Falha = Nmvtofalha

         AND Lfa.Tp_Erro = Ctperro

         AND Lfa.Tp_Importacao = Ctpimportacao;

    CURSOR c_Grupro IS

      SELECT Pro_Fat.Cd_Gru_Pro

        FROM Dbamv.Pro_Fat

       WHERE Pro_Fat.Cd_Pro_Fat = Cprofat;

    CURSOR c_Grufat_Padrao IS

      SELECT Gru_Pro.Cd_Gru_Fat

        FROM Dbamv.Pro_Fat,

             Dbamv.Gru_Pro

       WHERE Gru_Pro.Cd_Gru_Pro = Pro_Fat.Cd_Gru_Pro

         AND Pro_Fat.Cd_Pro_Fat = Cprofat;

    --PDA 99802 09/07/2004 Sp?ola (INICIO)

    --Cursor para coletar dados de atendimento ambulatorial por sess?para o atendimento pai

    CURSOR Catendsessao(Pncdatedimento IN NUMBER --N??o do atendimento de sessao filho

    ) IS

      SELECT Nvl(Atendime_Sessao.Sn_Retorno, 'N') Sn_Retorno,

             Nvl(Atendime.Qt_Sessoes, 0) Qt_Sessoes,

             Atendime_Sessao.Dt_Atendimento Dt_Atendimento

        FROM Dbamv.Atendime Atendime,

             Dbamv.Atendime Atendime_Sessao

       WHERE Atendime_Sessao.Cd_Atendimento = Pncdatedimento

         AND Atendime_Sessao.Cd_Atendimento_Pai = Atendime.Cd_Atendimento

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    Vcatendsessao Catendsessao%ROWTYPE;

    --PDA 99802 (FIM)



    /*OP 41394*/

      CURSOR cProced(pProFat IN VARCHAR2) IS

      SELECT pro_fat.cd_gru_pro

        FROM dbamv.pro_fat

      WHERE pro_fat.cd_pro_fat = pProFat;





  CURSOR cRregra(pConvenio IN NUMBER ,

                  pPlano IN NUMBER) IS

    SELECT p.cd_regra

    FROM dbamv.empresa_con_pla p,

        dbamv.empresa_convenio c

    WHERE p.cd_convenio = c.cd_convenio

      AND p.cd_con_pla  = pPlano

      AND c.cd_convenio = pConvenio

      AND c.cd_multi_empresa = DBAMV.PKG_MV2000.LE_EMPRESA;

  /*OP 41394*/



    Setor_Nao_Conf EXCEPTION;

    Proc_Sem_Preco EXCEPTION;

    Atend_Sem_Conta EXCEPTION;

    Proc_Proibido EXCEPTION;

	proc_proibido_idade   exception;   -- OP 32555

    Fora_Da_Conta EXCEPTION;

    v_Mvto    c_Mvto%ROWTYPE;

    v_Forapre Dbamv.Pack_Lanca_Ffcv.c_Forapre%ROWTYPE;

    --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

    --v_contaambu          dbamv.pack_lanca_ffcv.c_contaambu%ROWTYPE;

    v_Contaambu Dbamv.Pkg_Ffcv_Conta.Tpcontaambu;

    --v_contapartambu      dbamv.pack_lanca_ffcv.c_contapartambu%ROWTYPE;

    v_Contapartambu Dbamv.Pkg_Ffcv_Conta.Tpcontapartambu;

    --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

    v_Itregamb         Dbamv.Pack_Lanca_Ffcv.c_Itregamb%ROWTYPE;

    v_Config           c_Config%ROWTYPE;

    Csnimporta         VARCHAR2(1);

    Ncdgrufat          NUMBER;

    Ncdgrupro          NUMBER;

    Ncdlfa             NUMBER;

    Nprestador         NUMBER;

    Csnpgconv          VARCHAR2(1);

    Ctppgto            VARCHAR2(1);

    Ctpproibicao       VARCHAR2(2);

    Nqtautorizado      NUMBER;

    Ncdregamb          Dbamv.Reg_Amb.Cd_Reg_Amb%TYPE /*number pda 254997*/

    ;

    Ncdconvconta       NUMBER;

    Ncdplanconta       Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*number pda 254997*/

    ;

    Ncdguia            NUMBER;

    Csnhoresp          VARCHAR2(1);

    Csnpacote          VARCHAR2(1);

    Ncdlcto            Dbamv.Itreg_Fat.Cd_Lancamento%TYPE /*number pda 254997*/

    ;

    Ccdatimed          VARCHAR2(2);

    Binsert            BOOLEAN;

    Bpartic            BOOLEAN := FALSE;

    Deleting           BOOLEAN := FALSE;

    Updating           BOOLEAN := FALSE;

    Inserting          BOOLEAN := FALSE;

    Nqtprofat          Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    := 0;

    Nqtpart            Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Nqtconv            Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Nqtlivre           NUMBER;

    v_Qtdexistente_Amb NUMBER;

    v_Qtdexistente_Fat NUMBER;

    Totallancado       NUMBER;

    Limite             NUMBER := 0;

    -- PDA 96161 -- Alexandre Erik C. M. Costa 25/05/2004

    -- Declara? de vari?is

    Nqtdguia NUMBER;

    -- PDA 112220 -- Carlos Diego Cavalcanti Pereira -- Inicio

    -- Declara? da vari?l para armazenar o tipo de v?ulo do prestador

    Ntpvinculo VARCHAR2(1);

    -- PDA 112220 -- Fim

    Nguiapendente Dbamv.Guia.Cd_Guia%TYPE; -- pda 145435 - 24/03/2006 - Jose Roberto

    Ncdguiaitem   Dbamv.Guia.Cd_Guia%TYPE; /* pda 141006 */

    -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

    Ncdpacote Dbamv.Conta_Pacote.Cd_Conta_Pacote%TYPE;

    Csnguia   VARCHAR2(1) := 'N';

    -- PDA 157145 (Fim)

    Ddthraux     DATE; -- PDA 221500 - 27/03/2008 - Diego Costa

    Nqtexcedeu   NUMBER := NULL; -- OP 387

    Vtpcontapart Dbamv.Itreg_Fat.Tp_Mvto%TYPE := NULL; -- OP 387

    Nconta       NUMBER := NULL; -- OP 387

    Nlanc        NUMBER := NULL; -- OP 387

    vTemRegraCriaContaAuto BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnCriouContaAuto      BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnCriouContaAutoAmb   BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vRegraCriaContaAuto    Dbamv.Pkg_Ffcv_Conta.TpContaAutomatica; /*OP 35916 - regra para cria? autom?ca de conta*/

    vRegraCriaContaAutoHE    Dbamv.Pkg_Ffcv_Conta.TpContaAutomatica; /*OP 41394*/

    vSnReplicaProcHe dbamv.pack_lanca_ffcv.cSnReplicaProcHe%ROWTYPE; /*OP 41394*/

    vSnReplicaProc   VARCHAR2(1);                                    /*OP 41394*/

    vRregra cRregra%ROWTYPE;                                         /*OP 41394*/

    vNlsBanco VARCHAR2(50);                                          /*OP 41394*/

    vProced   cProced%ROWTYPE;                                       /*OP 41394*/

    v_ContaCargoPac        Dbamv.Pkg_Ffcv_Conta.Tpconta;     /*ALLS OP 42241 */

    v_ContaCargoPacAmbu    Dbamv.Pkg_Ffcv_Conta.Tpcontaambu; /*ALLS OP 42241 */

    vRegraCriaContaAutoCP  Dbamv.Pkg_Ffcv_Conta.TpContaAutomaticaCP; /*ALLS OP 42241* - regra para cria? autom?ca de conta referente a Cargo Paciente*/

    vSnCargoPaciente       Dbamv.Pack_Lanca_Ffcv.cSnCargoPaciente%ROWTYPE; /*ALLS OP 42241*/

    vSnCriouContaAutoCP    BOOLEAN := FALSE; /*ALLS OP 42241 */

    vSnCriouContaAutoAmbCP BOOLEAN := FALSE; /*ALLS OP 42241 */

    NcdlctoCp              NUMBER  ; /*ALLS OP 42241 */

    NcdlctoAmbCp           NUMBER  ; /*ALLS OP 42241 */

    pEmpresa               NUMBER := Pkg_Mv2000.Le_Empresa;/*43289*/

    pvSnJaExcedeuQtd      Varchar2(1):= 'N'; /*43289*/

    pvMensagem             VARCHAR2(2000);    /*43289*/

    pSnChamadoDaTela       VARCHAR2(1) := 'N';       /*43289*/



  BEGIN

    IF Caction = 'I' THEN

      Inserting := TRUE;

    ELSIF Caction = 'A' THEN

      Inserting := TRUE;

    ELSIF Caction = 'D' THEN

      Deleting := TRUE;

    END IF;

    OPEN c_Config;

    FETCH c_Config

      INTO v_Config;

    CLOSE c_Config;

    OPEN c_Mvto;

    FETCH c_Mvto

      INTO v_Mvto;

    CLOSE c_Mvto;



	--FATURCONV-1726 INI

	OPEN cRregra(	v_Mvto.Cd_Convenio,

                    v_Mvto.Cd_Con_Pla);

	FETCH cRregra INTO vRregra;

	CLOSE cRregra;



	OPEN cProced(Cprofat);

	FETCH cProced INTO vProced;

	CLOSE cProced;

	--FATURCONV-1726 FIM



	-- OP 32555 - 27/09/2015 - verifica? de proibi? por Idade. Retorna OK caso n?haja proibi?, e mensagem para o alert caso haja.

	if dbamv.fnc_ffcv_proibicao_idade( v_mvto.cd_atendimento, v_mvto.cd_convenio, v_mvto.cd_con_pla, Cprofat ) <> 'OK' then

	  raise proc_proibido_idade;

	end if;

	-- OP 32555 - fim

/* OP 38292 (Inicio)

    OPEN Dbamv.Pack_Lanca_Ffcv.c_Proibicao(Cprofat,

                                           v_Mvto.Cd_Convenio,

                                           v_Mvto.Cd_Con_Pla,

                                           v_Mvto.Tp_Atendimento,

                                           v_Mvto.Dt_Atendimento,

                                           v_Mvto.Cd_Setor);

    FETCH Dbamv.Pack_Lanca_Ffcv.c_Proibicao

      INTO Ctpproibicao;

    CLOSE Dbamv.Pack_Lanca_Ffcv.c_Proibicao;*/



     Ctpproibicao := dbamv.pack_ffcv_proibicao.fnc_ffcv_proibicao(Cprofat,

                                              v_Mvto.Cd_Convenio,

                                              v_Mvto.Cd_Con_Pla,

                                              v_Mvto.Tp_Atendimento,

                                              v_Mvto.Dt_Atendimento,

                                              v_Mvto.Cd_Setor,

                                                                 Ncdatendimento,

                                                                 NULL);

      -- OP 38292 (Fim)

    IF Ctpproibicao = 'FC' THEN

      RAISE Fora_Da_Conta;

    END IF;

    IF Nvl(v_Config.Sn_Para_Automatica, 'N') = 'S' AND

       v_Mvto.Tp_Atendimento IN ('A', 'E', 'U') THEN

      --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

      /*OPEN dbamv.pack_lanca_ffcv.c_contaambu (ncdatendimento

                                             ,v_mvto.dt_atendimento

                                             ,NULL

                                             ,v_mvto.cd_atendimento_pai

                                             );

      FETCH dbamv.pack_lanca_ffcv.c_contaambu INTO v_contaambu;

      CLOSE dbamv.pack_lanca_ffcv.c_contaambu;*/

      /*OP 35916 - regra para cria? autom?ca de conta*/

      vTemRegraCriaContaAuto  := Dbamv.Pkg_Ffcv_Conta.FNC_TEM_REG_CRIA_CONTA_AUTO;

      IF (vTemRegraCriaContaAuto) THEN



              /*ALLS OP 42241*/

              OPEN dbamv.pack_lanca_ffcv.cSnCargoPaciente(Ncdatendimento);

              FETCH dbamv.pack_lanca_ffcv.cSnCargoPaciente INTO vSnCargoPaciente;

		          CLOSE dbamv.pack_lanca_ffcv.cSnCargoPaciente;



		          IF Nvl(vSnCargoPaciente.sn_carga_familiar,'N') = 'S' THEN



                  vRegraCriaContaAutoCP := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTCP(Ncdatendimento,

                                                                                               Cprofat,

                                                                                               v_Mvto.Dt_Atendimento); --FATURCONV-1383 - AMBS



                  IF (vRegraCriaContaAutoCP(1).cd_regra_cria_conta IS NOT NULL ) THEN



                      v_ContaCargoPacAmbu :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_AMB_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                              null,

                                                                                              Ncdatendimento,

                                                                                              v_Mvto.Cd_Atendimento_Pai,

                                                                                              vRegraCriaContaAutoCP(1).cd_convenio_destino,

                                                                                              vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                                                                                              v_Mvto.Dt_Atendimento,

                                                                                              vRegraCriaContaAutoCP(1).cd_tipo_arq_cta_envio,

                                                                                              vRegraCriaContaAutoCP(1).cd_desconto_inst); /*ALLS OP 35921*/

                      vSnCriouContaAutoAmbCP := TRUE;

                  END IF;

              /*fim ALLS OP 42241*/

              ELSE



                  vRegraCriaContaAuto := Dbamv.Pkg_Ffcv_Conta.FNC_VERIFIC_REG_CRIA_CONTA_AUT(Ncdatendimento,

                                                                                             Cprofat,

                                                                                             v_Mvto.Dt_Atendimento); --FATURCONV-1383 - AMBS



                  IF (vRegraCriaContaAuto(1).cd_regra_cria_conta IS NOT NULL)  THEN



                      v_Contaambu :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_AMB_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                    null,

                                                                                    Ncdatendimento,

                                                                                    v_Mvto.Cd_Atendimento_Pai,

                                                                                    vRegraCriaContaAuto(1).cd_convenio_destino,

                                                                                    vRegraCriaContaAuto(1).cd_con_pla_destino,

                                                                                    v_Mvto.Dt_Atendimento,

                                                                                    vRegraCriaContaAuto(1).cd_tipo_arq_cta_envio,

                                                                                    vRegraCriaContaAuto(1).cd_desconto_inst); /*ALLS OP 35921*/



                      vSnCriouContaAutoAmb := TRUE;

                  END IF;



              END IF;



      END IF;



      IF (NOT vSnCriouContaAutoAmb) THEN

      /*OP 35916 - regra para cria? autom?ca de conta*/

          v_Contaambu := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Ccontaambu(Ncdatendimento,

                                                                 v_Mvto.Dt_Atendimento,

                                                                 NULL,

                                                                 v_Mvto.Cd_Atendimento_Pai);

      END IF;/*OP 35916*/



      --IF NVL (v_contaambu.sn_fechada, 'N') = 'S' THEN

      IF Nvl(v_Contaambu(1).Sn_Fechada, 'N') = 'S' THEN

        --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

        RAISE Atend_Sem_Conta;

      END IF;

      --IF v_contaambu.cd_reg_amb IS NULL THEN --PDA 157595

      IF v_Contaambu(1).Cd_Reg_Amb IS NULL THEN

        --PDA 157595

        IF v_Mvto.Tp_Convenio = 'P' THEN

          Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(Ncdatendimento);

        ELSE

          Ncdregamb := Dbamv.Pack_Ffcv.Cria_Conta_Acoplamentoambu(Ncdatendimento,

                                                                  'N');

        END IF;

        Ncdconvconta := v_Mvto.Cd_Convenio;

        Ncdplanconta := v_Mvto.Cd_Con_Pla;

      ELSE

        Ncdregamb    := v_Contaambu(1).Cd_Reg_Amb; --ncdregamb := v_contaambu.cd_reg_amb; --PDA 157595

        Ncdconvconta := v_Contaambu(1).Cd_Convenio; --ncdconvconta := v_contaambu.cd_convenio;--PDA 157595

        Ncdplanconta := v_Contaambu(1).Cd_Con_Pla; --ncdplanconta := v_contaambu.cd_con_pla;--PDA 157595

      END IF;

      IF Ncdregamb IS NULL THEN

        RAISE Atend_Sem_Conta;

      END IF;

      OPEN c_Grupro;

      FETCH c_Grupro

        INTO Ncdgrupro;

      CLOSE c_Grupro;

      OPEN c_Grufat(v_Mvto.Cd_Setor);

      FETCH c_Grufat

        INTO Ncdgrufat;

      CLOSE c_Grufat;

      IF Ncdgrufat IS NULL THEN

        OPEN c_Grufat_Padrao;

        FETCH c_Grufat_Padrao

          INTO Ncdgrufat;

        CLOSE c_Grufat_Padrao;

      END IF;

      IF Ncdgrufat IS NULL THEN

        RAISE Setor_Nao_Conf;

      END IF;

      OPEN Dbamv.Pack_Lanca_Ffcv.c_Forapre(Ncdconvconta, Ncdgrufat);

      FETCH Dbamv.Pack_Lanca_Ffcv.c_Forapre

        INTO v_Forapre;

      CLOSE Dbamv.Pack_Lanca_Ffcv.c_Forapre;

      IF v_Forapre.Sn_Prestador = 'S' THEN

        Nprestador := v_Mvto.Cd_Prestador;

      END IF;

      IF Nprestador IS NOT NULL THEN

        -- PDA 100970 26/09/2006 Thiago Holder Marcos Silva

        -- Chamada da fun? dbamv.pkg_ffcv_it_conta.fnc_retorna_tp_pagamento();

        -- Esta fun? tamb?verifica se o prestador credenciado tem exce? cadastrada

        -- caso tenha, o tipo de pagamento ser? - Produ?

        --    OPEN dbamv.pack_lanca_ffcv.c_prescon (nprestador, ncdconvconta);

        --    FETCH dbamv.pack_lanca_ffcv.c_prescon INTO csnpgconv;

        --    CLOSE dbamv.pack_lanca_ffcv.c_prescon;

        Ctppgto := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Retorna_Tp_Pagamento(Nprestador,

                                                                    Ncdconvconta,

                                                                    v_Mvto.Tp_Atendimento,

                                                                    Cprofat,

                                                                    v_Mvto.Cd_Ori_Ate

                                                                    -- PDA 166691 (Inicio) - Henrique Antunes - 28/11/2006

                                                                   ,

                                                                    v_Mvto.Dt_Atendimento,

                                                                    v_Mvto.Hr_Atendimento

                                                                    -- PDA 166691 (Fim)

																	--FATURCONV-1726 INI

																	,Ncdplanconta

																	,vRregra.cd_regra

																	,vProced.Cd_Gru_Pro

																	--FATURCONV-1726 FIM

                                                                    );

      ELSE

        --    csnpgconv := NULL;

        Ctppgto := NULL; -- 'P'  ; -- ( pda 84408  setado de null p/ 'P') -- pda 104455 desfazer o que foi feito no pda 84408

      END IF;

      -- IF csnpgconv IS NOT NULL THEN

      --    IF NVL (csnpgconv, 'N') = 'S' THEN

      --       ctppgto := 'C';

      --    ELSE

      --       ctppgto := 'P';

      --    END IF;

      -- ELSIF nprestador IS NOT NULL THEN

      --   ctppgto := 'P';

      -- END IF;

      -- PDA 112220 -- Carlos Diego Cavalcanti Pereira -- 15/12/2004

      -- Inserida a verifica? do v?ulo empregat?o do prestador

      -- PDA 112220 -- Inicio

      -- IF nprestador IS NOT NULL AND ctppgto = 'P' THEN

      --    SELECT tp_vinculo

      --      INTO ntpvinculo

      --      FROM dbamv.prestador

      --     WHERE cd_prestador = nprestador;

      --    IF ntpvinculo = 'U' THEN

      --       ctppgto := 'F';

      --    END IF;

      -- END IF;

      -- PDA 100970(FIM)

      -- PDA 112220 -- Fim

      IF Ctpproibicao = 'NA' THEN

        IF v_Config.Tp_Controle_Lote = 'A' THEN

          --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

          /*OPEN dbamv.pack_lanca_ffcv.c_contapartambu (ncdatendimento, v_mvto.dt_atendimento);

          FETCH dbamv.pack_lanca_ffcv.c_contapartambu INTO v_contapartambu;

          CLOSE dbamv.pack_lanca_ffcv.c_contapartambu;*/

          v_Contapartambu := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Ccontapartambu(Ncdatendimento,

                                                                             v_Mvto.Dt_Atendimento);

          --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

        ELSE

          --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

          /*OPEN dbamv.pack_lanca_ffcv.c_contapartambu_loteunico (ncdatendimento, v_mvto.dt_atendimento);

          FETCH dbamv.pack_lanca_ffcv.c_contapartambu_loteunico INTO v_contapartambu;

          CLOSE dbamv.pack_lanca_ffcv.c_contapartambu_loteunico;*/

          v_Contapartambu := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Contpartambulotun(Ncdatendimento,

                                                                                v_Mvto.Dt_Atendimento);

          --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

        END IF;

        --IF v_contapartambu.cd_reg_amb IS NULL THEN--PDA 157595

        IF v_Contapartambu(1).Cd_Reg_Amb IS NULL THEN

          --PDA 157595

          Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(Ncdatendimento);

        ELSE

          Ncdregamb := v_Contapartambu(1).Cd_Reg_Amb; --ncdregamb := v_contapartambu.cd_reg_amb;--PDA 157595

        END IF;

        IF Ncdregamb IS NULL THEN

          RAISE Atend_Sem_Conta;

        END IF;

        Ncdconvconta := v_Config.Cd_Convenio_Fat_Extra;

        Ncdplanconta := v_Config.Cd_Con_Pla_Fat_Extra;

      END IF;

      Nqtprofat := Nvl(Nqtde, 0);

      /* pda 145435 - 24/03/2006 - Jose Roberto                            (*)

      Alterando a verifica? da guia, retirando os cursores c_qtdexistente_amb e

      c_qtdexistente_fat para utilizar a nova fun? FNC_RETORNA_GUIA_DISPONIVEL;

      Retiradas as verifica?s nos cursores c_guia, c_itguia e c_itguia_proc_auto;

      Retirado o uso das vari?is totallancado e nqtautorizado;

      Caso NCDGUIA for Nulo, chamando a fun? F_GRAVA_GUIA, alterando o terceiro

      par?tro para nqtprofat;

      Retirado todo o c?ulo feito para atribuir valor as vari?is nqtpart,

      nqtconv e limite;

      Caso retorne uma Guia dispon?l, atribu?a ?ari?l NCDGUIA.         */

      /*PDA 374303 - 25/06/2010 - Juliana Vieira

      Replicando mesma altera? do PDA 312488, por?para outros lan?entos autom?cos.

      na chamada da fun? que retorna se tem uma guia dispon?l, passar sempre o codigo do atendimento

      pai caso tiver, pois o sistma pode criar atendimentos de recem nascido onde n?existe conta para ele e n??ecess?o

      crioar guias para os atendimentos filhos.*/

      IF Ctpproibicao = 'AG' THEN

        Ncdguia := Dbamv.Pkg_Ffcv_Guia.Fnc_Retorna_Guia_Disponivel(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                       v_Mvto.Cd_Atendimento),

                                                                   Ncdregamb,

                                                                   NULL,

                                                                   Cprofat,

                                                                   Nqtprofat,

                                                                   NULL,

                                                                   NULL,

                                                                   Nguiapendente);

        IF Nvl(v_Config.Sn_Guia_Proc_Auto, 'N') = 'S' THEN

          IF Ncdguia IS NULL THEN

            Ncdguia := Dbamv.f_Grava_Guia(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                              v_Mvto.Cd_Atendimento),

                                          v_Mvto.Cd_Convenio,

                                          Nqtprofat,

                                          Cprofat,

                                          'P');

          END IF;

          Nqtpart := 0;

          Nqtconv := Nqtprofat;

          Limite  := 0;

          /* pda 164822 - 28/09/2006 - Amalia Ara??

             Comentado para n?lan? procedimento com proibi? AG em conta particular.

          else

            nQtPart := nQtProFat;

            nQtConv := 0;

            limite  := 1;

          pda 164822 - fim       */

        END IF;

      END IF;

      -- pda 145435 (Fim)

      -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

      IF Ctpproibicao = 'AG' THEN

        Csnguia := 'S';

      END IF;

      -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

      -- Prepara? da data que ser?assada na fun?.

      -- A data preparada ir?onter al?da data de lan?ento, a hora de lan?ento.

      Ddthraux := To_Date(To_Char(v_Mvto.Dt_Atendimento, 'DD/MM/YYYY') || ' ' ||

                          To_Char(Nvl(v_Mvto.Hr_Atendimento,

                                      v_Mvto.Dt_Atendimento),

                                  'HH24:MI:SS'),

                          'DD/MM/YYYY HH24:MI:SS');

      -- PDA 221500 (Fim)

      /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

      nQtExcedeu a vari?l retorna justamente a quantidade de procedimentos que deve ser lan?o no procedimento

      que pertence ao pacote, em seguida deve ser inserdio um outro procedimento com o que restou do lan?ento*/

      Nqtexcedeu := NULL;

      --

      /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

      vTpContaPart a vari?l retorna justamente se o procedimento vai ser inserido em uma conta particular ou ira seguir

      o processo normalmente.*/

      Ncdpacote := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Gera_Pacote(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                               v_Mvto.Cd_Atendimento),

                                                           v_Mvto.Tp_Atendimento,

                                                           Ncdconvconta,

                                                           Ncdplanconta,

                                                           Ncdregamb,

                                                           Ncdgrufat,

                                                           Cprofat,

                                                           v_Mvto.Cd_Setor,

                                                           Nprestador

                                                           -- PDA 221500 (In?o)

                                                           -- ,sysdate

                                                          ,

                                                           Nvl(Ddthraux,

                                                               SYSDATE)

                                                           -- PDA 221500 (Fim)

                                                          ,

                                                           Ncdatendimento,

                                                           NULL,

                                                           'Ambulatorio',

                                                           Csnguia,

                                                           Nqtprofat,

                                                           Csnpacote,

                                                           Nqtexcedeu -- OP 387

                                                          ,

                                                           Vtpcontapart -- OP 387

                                                          ,

                                                           NULL

                                                           -- PDA 225086 (Inicio)

                                                          ,

                                                           v_Mvto.Cd_Atendimento,

                                                           NULL --pCdProFatPacote

                                                          ,

                                                           Ncdlcto --pCdLancamento_pac

                                                          ,

                                                           NULL); --preserva

      -- PDA 225086 (fim)

      /* pda 481126 - depois da FNC_GERA_PACOTE regravando o cd_lancamento_pac */

      IF v_Mvto.Tp_Atendimento IN ('A', 'E', 'U') THEN

        OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Ncdregamb);

        FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

          INTO Ncdlcto;

        CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;

      END IF;

      --

      IF Ncdpacote IS NOT NULL THEN

        UPDATE Dbamv.Conta_Pacote

           SET Cd_Lancamento_Pac = Ncdlcto

         WHERE Cd_Conta_Pacote = Ncdpacote;

      END IF;

      /* pda 481126 - fim */

      /*OPEN dbamv.pack_lanca_ffcv.c_pacote (ncdatendimento, ncdregamb);

      FETCH dbamv.pack_lanca_ffcv.c_pacote INTO csnpacote;

      CLOSE dbamv.pack_lanca_ffcv.c_pacote;*/

      -- PDA 157145 (Inicio)

      IF Dbamv.Pack_Lanca_Ffcv.Is_Hor_Esp(Ncdconvconta,

                                          Ncdplanconta,

                                          v_Mvto.Tp_Atendimento,

                                          v_Mvto.Dt_Atendimento,

                                          v_Mvto.Hr_Atendimento,

                                          Ncdgrufat,

                                          Cprofat

                                          -- PDA 119427 11/04/2005 Henrique Antunes (In?o)

                                          -- Passar NULL para o par?tro de regra

                                         ,

                                          NULL

                                          -- PDA 119427 (FIM)

                                         , --PDA 108041 / 108039 12/11/2004 Sp?ola (INICIO)

                                          --Inserido o paremetro cd_prestador / cd_setor para permitir exce?s de convenios e planos por prestador

                                          Nprestador,

                                          v_Mvto.Cd_Setor --PDA 108041 / 108039 (FIM)

                                          ) THEN

        Csnhoresp := 'S';

      ELSE

        Csnhoresp := 'N';

      END IF;

      IF Inserting THEN

        --PDA 99802 21/07/2004 Sp?ola (INICIO)

        --Abertura do cursor utilizado para recuperar a data de sess?do atendimento

        OPEN Catendsessao(v_Mvto.Cd_Atendimento);

        FETCH Catendsessao

          INTO Vcatendsessao;

        CLOSE Catendsessao;

        --PDA 99802 (FIM)

        IF Limite <> 1 THEN

          /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

          que o procedimento que ira ser inserido abaixo pertence a um pacote, e a qunatidade que sera inserida sera menor que a lan?a, a diferen?

          sera lan?a na rotina mais abaixo atravez da procedure PRC_DESVINCULA_PROCEDIMENTO*/

          /* Fazendo tratamento caso o procedimento esteja configurado no gabarito para ser inserido dentro de uma conta particular

          caso a variavel vTpContaPart esteja preenchida e a quantidade de lan?ento extra esteja nula. com iso deve ser procurado uma conta particular

          e um lan?ento para inseririr nesta conta.*/

          Nconta := NULL;

          Nlanc  := NULL;

			/*43289 - quebra de conta por quantidade de procedimento por atendimento*/

			/*A regra de pacote tem prioridade sobre essa regra, conforme vari?l Nqtexcedeu abaixo*/

			IF Nqtexcedeu IS NULL THEN

				if (not vSnCriouContaAutoAmb) then /*OP 46768*/

					  IF DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_EXISTE_CONF_QTD_ATEND_PAC(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																						                                  cprofat,

																						                                  pEmpresa) THEN



						  Nqtexcedeu := DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_RETORNA_QTD_LANC_PERIODO(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																									                                        cprofat,

																									                                        pEmpresa,

																									                                        ncdregamb,

																									                                        nvl(nqtconv, nqtprofat),

																									                                        pSnChamadoDaTela,

																									                                        pvSnJaExcedeuQtd,

																									                                        pvMensagem

																									                                        );

						  IF pvSnJaExcedeuQtd = 'S' THEN

							  Vtpcontapart := 'ProcPorAtend';

							  Nqtexcedeu   := NULL;

						  ELSE

								IF NVL(Nqtexcedeu,0) > 0 THEN

									Vtpcontapart := 'ProcPorAtend';

								END IF;

						  END IF;

					END IF;

				END IF;	/*OP 46768*/

		    END IF;

			/*43289*/

          IF Nvl(Vtpcontapart, 'X') <> 'X' AND Nqtexcedeu IS NULL THEN

            Nconta := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                     Ncdatendimento));

            OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Nconta);

            FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

              INTO Nlanc;

            CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;

            /*43289*/

            ncdconvconta := v_config.cd_convenio_fat_extra;

            ncdplanconta := v_config.cd_con_pla_fat_extra;

            /*43289*/



          END IF;

          INSERT INTO Dbamv.Itreg_Amb

            (Cd_Reg_Amb,

             Cd_Lancamento,

             Hr_Lancamento,

             Qt_Lancamento,

             Cd_Gru_Fat,

             Cd_Pro_Fat,

             Cd_Atendimento,

             Cd_Con_Pla,

             Cd_Convenio,

             Sn_Fatura_Impressa,

             Sn_Fechada,

             Sn_Conta_Calculada,

             Cd_Guia,

             Sn_Pertence_Pacote,

             Vl_Percentual_Multipla,

             Cd_Setor,

             Cd_Setor_Produziu,

             Sn_Horario_Especial,

             Cd_Prestador,

             Tp_Pagamento,

             Cd_Ati_Med,

             Cd_Usuario,

             Cd_Mvto,

             Tp_Mvto, --PDA 99802 09/07/2004 Sp?ola (INICIO) (Comentario mais abaixo)

             Dt_Sessao

             -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

            ,

             Cd_Conta_Pacote

             -- PDA 157145 (Fim)

             )

          --PDA 99802 (FIM)

          VALUES

            (Nvl(Nconta, Ncdregamb) -- OP 387

            ,

             Nvl(Nlanc, Ncdlcto) -- OP 387

            ,

             v_Mvto.Hr_Atendimento,

             Nvl(Nqtexcedeu, Nvl(Nqtconv, Nqtprofat)) -- OP 387

            ,

             Ncdgrufat,

             Cprofat,

             Nvl(v_Mvto.Cd_Atendimento_Pai, Ncdatendimento),

             Ncdplanconta,

             Ncdconvconta,

             'N',

             'N',

             'N',

             Ncdguia,

             Nvl(Csnpacote, 'N'),

             100,

             v_Mvto.Cd_Setor,

             v_Mvto.Cd_Setor,

             'N',

             Nprestador,

             Ctppgto,

             v_Config.Cd_Ati_Med_Clinico,

             USER,

             Ncdatendimento,

             Nvl(Vtpcontapart, 'Ambulatorio') -- OP 387

            , --PDA 99802 09/07/2004 Sp?ola (INICIO)

             --Se o quantidade de sesS??for maior que zero e o atendimento filho for de retorno,

             --preencher a data da sessao com a data do atendimento filho.

             Decode(Vcatendsessao.Sn_Retorno,

                    'N',

                    NULL,

                    Decode(Vcatendsessao.Qt_Sessoes,

                           0,

                           NULL,

                           Vcatendsessao.Dt_Atendimento))

             --PDA 99802 (FIM)

             -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

            ,

             Ncdpacote

             -- PDA 157145 (Fim)

             );





              /*OP 42241 - Caso tenha criado a conta por cargo paciente, devemos lan? o item para o convenio, plano, percentual definido na configura

              de quebra de conta por cargo paciente*/

              IF (vSnCriouContaAutoAmbCP) THEN

                   OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(v_ContaCargoPacAmbu(1).cd_reg_amb);

                   FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                      INTO NcdlctoAmbCp;

                   CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;



                   INSERT INTO Dbamv.Itreg_Amb

                    (Cd_Reg_Amb,

                     Cd_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Cd_Atendimento,

                     Cd_Con_Pla,

                     Cd_Convenio,

                     Sn_Fatura_Impressa,

                     Sn_Fechada,

                     Sn_Conta_Calculada,

                     Cd_Guia,

                     Sn_Pertence_Pacote,

                     Cd_Prestador,

                     Tp_Pagamento,

                     Cd_Ati_Med,

                     Vl_Percentual_Multipla,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto,

                     Dt_Sessao

                     )

                  VALUES

                    (v_ContaCargoPacAmbu(1).cd_reg_amb,

                     NcdlctoAmbCp,

                     v_Mvto.Hr_Atendimento,

                     Nvl(Nqtexcedeu, Nvl(Nqtconv, Nqtprofat)),

                     Ncdgrufat,

                     Cprofat,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, Ncdatendimento),

                     vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                     vRegraCriaContaAutoCP(1).cd_convenio_destino,

                     'N',

                     'N',

                     'N',

                     Ncdguia,

                     'N',

                     Nprestador,

                     Ctppgto,

                     v_Config.Cd_Ati_Med_Clinico,

                     vRegraCriaContaAutoCP(1).vl_percentual_carga_familiar,

                     v_Mvto.Cd_Setor,

                     v_Mvto.Cd_Setor,

                     'N',

                     USER,

                     Ncdatendimento,

                     Nvl(Vtpcontapart, 'Ambulatorio'),

                     Decode(Vcatendsessao.Sn_Retorno,

                             'N',

                             NULL,

                             Decode(Vcatendsessao.Qt_Sessoes,

                                   0,

                                   NULL,

                                   Vcatendsessao.Dt_Atendimento))

                     );

              END IF;

              /*OP 42241*/



          /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

          que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

          os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

          IF Nqtexcedeu IS NOT NULL THEN

            Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregamb,

                                                                Ncdlcto,

                                                                (Nvl(Nqtconv,

                                                                     Nqtprofat) -

                                                                Nqtexcedeu),

                                                                Vtpcontapart,

                                                                v_Mvto.Hr_Atendimento,

																nvl(v_mvto.cd_atendimento_pai, ncdatendimento)); /*ALLS OP 43289*/

          END IF;

          /* OP 387 - Thiago Miranda de oliveira - este trecho de c??o somente sera utilizado se a configura? de gerar o item em conta de particular

          por causa do pacote, n?estiver preenchido*/

          IF Nvl(Vtpcontapart, 'X') = 'X' THEN

            -- PDA 197953 (In?o) - 08/08/2007 - Diego Costa

            -- inclus?de verifica? a regra de atendimento pro_fat antes da regra de acoplamaneto

            IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Ambu(Ncdregamb,

                                                          Ncdlcto,

                                                          'I') THEN

              IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Ambu(Ncdregamb,

                                                            Ncdlcto,

                                                            'I') THEN

                Verif_Franquia_Ambu(Ncdregamb, Ncdlcto);

              END IF;

            END IF;

            -- PDA 197953 (Fim)

          END IF;

        END IF;

        IF v_Mvto.Tp_Convenio <> 'P' AND Nvl(Nqtpart, 0) > 0 AND

           Ctpproibicao = 'AG' THEN

          Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(Ncdatendimento);

          INSERT INTO Dbamv.Itreg_Amb

            (Cd_Reg_Amb,

             Cd_Lancamento,

             Hr_Lancamento,

             Qt_Lancamento,

             Cd_Gru_Fat,

             Cd_Pro_Fat,

             Cd_Atendimento,

             Cd_Con_Pla,

             Cd_Convenio,

             Sn_Fatura_Impressa,

             Sn_Fechada,

             Sn_Conta_Calculada,

             Cd_Guia,

             Sn_Pertence_Pacote,

             Vl_Percentual_Multipla,

             Cd_Setor,

             Cd_Setor_Produziu,

             Sn_Horario_Especial,

             Cd_Prestador,

             Tp_Pagamento,

             Cd_Ati_Med,

             Cd_Usuario,

             Cd_Mvto,

             Tp_Mvto, --PDA 99802 09/07/2004 Sp?ola (INICIO) (Comentario mais abaixo)

             Dt_Sessao

             -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

            ,

             Cd_Conta_Pacote

             -- PDA 157145 (Fim)

             )

          --PDA 99802 (FIM)

          VALUES

            (Ncdregamb,

             Ncdlcto,

             v_Mvto.Hr_Atendimento,

             Nqtpart,

             Ncdgrufat,

             Cprofat,

             Nvl(v_Mvto.Cd_Atendimento_Pai, Ncdatendimento),

             Ncdplanconta,

             Ncdconvconta,

             'N',

             'N',

             'N',

             Ncdguia,

             Nvl(Csnpacote, 'N'),

             100,

             v_Mvto.Cd_Setor,

             v_Mvto.Cd_Setor,

             'N',

             Nprestador,

             Ctppgto,

             v_Config.Cd_Ati_Med_Clinico,

             USER,

             Ncdatendimento,

             'Ambulatorio', --PDA 99802 09/07/2004 Sp?ola (INICIO)

             --Se o quantidade de sesS??for maior que zero e o atendimento filho for de retorno,

             --preencher a data da sessao com a data do atendimento filho.

             Decode(Vcatendsessao.Sn_Retorno,

                    'N',

                    NULL,

                    Decode(Vcatendsessao.Qt_Sessoes,

                           0,

                           NULL,

                           Vcatendsessao.Dt_Atendimento))

             --PDA 99802 (FIM)

             -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

            ,

             Ncdpacote

             -- PDA 157145 (Fim)

             );

        END IF;



        DECLARE

          CURSOR c_Relacionados IS

            SELECT Rela.Cd_Pro_Fat,

                   Rela.Tp_Atend_Homecare,

                   Rela.Tp_Atend_Externo,

                   Rela.Tp_Atend_Urgeme,

                   Rela.Tp_Atend_Ambulatorial,

                   Rela.Tp_Atend_Internacao

                   --PDA 108042 22/11/2004 Sp?ola (INICIO)

                   --Inserida a coluna qt_lancamento que ir?ultiplicar a quantidade na rotina Dbamv.lanca_ffcv_pro_relacionados

                  ,

                   Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

            --PDA 108042 (FIM)

              FROM Dbamv.Con_Pla,

                   Dbamv.Regra,

                   Dbamv.Val_Pro_Relacionado Rela,

                   Dbamv.Empresa_Con_Pla /* PDA 118607/131598 */

                        ,dbamv.pro_fat             -- OP 32555 *2

             WHERE Empresa_Con_Pla.Cd_Convenio = Con_Pla.Cd_Convenio /* PDA 118607/131598 */

               AND Empresa_Con_Pla.Cd_Con_Pla = Con_Pla.Cd_Con_Pla /* PDA 118607/131598 */

               AND Empresa_Con_Pla.Cd_Multi_Empresa =

                   Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/131598 */



					 -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

                     --AND Rela.Cd_Pro_Fat_Pai = Cprofat

					 and ( ( rela.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = rela.cd_pro_fat and Rela.Cd_Pro_Fat_Pai = Cprofat )

					    or ( rela.cd_pro_fat_pai is null and rela.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = Cprofat)

                             AND pro_fat.cd_pro_fat = Cprofat )

					     )

				     -- OP 32555 - fim



               AND Con_Pla.Cd_Convenio = Ncdconvconta

               AND Con_Pla.Cd_Con_Pla = Ncdplanconta

               AND Rela.Tp_Lancamento = 'A'

                  --PDA 114239 17/01/2005 Sp?ola (INICIO)

                  --Incluida verifica? por tipo de atendimento para os procedimentos relacionados

               AND ((v_Mvto.Tp_Atendimento = 'H' AND

                   Rela.Tp_Atend_Homecare = 'S') OR

                   (v_Mvto.Tp_Atendimento = 'E' AND

                   Rela.Tp_Atend_Externo = 'S') OR

                   (v_Mvto.Tp_Atendimento = 'U' AND

                   Rela.Tp_Atend_Urgeme = 'S') OR

                   (v_Mvto.Tp_Atendimento = 'A' AND

                   Rela.Tp_Atend_Ambulatorial = 'S') OR

                   (v_Mvto.Tp_Atendimento = 'I' AND

                   Rela.Tp_Atend_Internacao = 'S'))

                  --PDA 114239 (FIM)

               AND Con_Pla.Cd_Regra = Regra.Cd_Regra

               AND Rela.Cd_Regra = Regra.Cd_Regra

               AND Rela.Dt_Vigencia IN

                   (SELECT MAX(Vpr.Dt_Vigencia)

                      FROM Dbamv.Val_Pro_Relacionado Vpr

                     WHERE Vpr.Dt_Vigencia <= v_Mvto.Dt_Atendimento

                       AND Vpr.Cd_Regra = Rela.Cd_Regra

					 -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

					 -- AND Vpr.Cd_Pro_Fat_Pai = Rela.Cd_Pro_Fat_Pai

					 -- AND Vpr.Cd_Pro_Fat = Rela.Cd_Pro_Fat

					 and ( ( Vpr.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = Vpr.cd_pro_fat and Vpr.Cd_Pro_Fat_Pai = Cprofat )

						or ( Vpr.cd_pro_fat_pai is null and Vpr.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = Cprofat)

							 AND pro_fat.cd_pro_fat = Cprofat )

						  )

					 -- OP 32555 - fim

					   );

          Cretorno VARCHAR2(1);

        BEGIN

          FOR Rec_Rela IN c_Relacionados

          LOOP

            Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(Ncdatendimento,

                                                          Ncdregamb,

                                                          Ncdlcto,

                                                          Ncdatendimento,

                                                          Cprofat,

                                                          v_Mvto.Dt_Atendimento,

                                                          v_Mvto.Hr_Atendimento,

                                                          v_Mvto.Cd_Setor,

                                                          'P',

                                                          v_Mvto.Tp_Atendimento,

                                                          v_Mvto.Dt_Atendimento,

                                                          Ncdconvconta,

                                                          Ncdplanconta /*  ncdconvconta    pda 131200  */,

                                                          v_Mvto.Cd_Atendimento_Pai,

                                                          v_Mvto.Tp_Convenio,

                                                          v_Mvto.Dt_Alta,

                                                          Rec_Rela.Cd_Pro_Fat, --PDA 108042 22/11/2004 Sp?ola (INICIO)

                                                          --As quantidades lan?a ser?ultiplicadas pelo fator de quantidade qt_lancamento

                                                          Rec_Rela.Qt_Lancamento *

                                                          Nvl(Nqtconv,

                                                              Nqtprofat), --PDA 108042 (FIM)

                                                          0,

                                                          'I'

                                                          --PDA 108070 29/12/2004 Sp?ola (INICIO)

                                                          --Inserido o campo do prestador que ser?tilizado apenas para os procedimentos relacionados de ambulatorio

                                                          --lancadados pela prc_ffcv_lanca_atendimento - lancamento automatico do procedimento principal na criacao do atendimento

                                                         ,

                                                          NULL --cd_prestador

                                                          --PDA 108070 (FIM)

                                                          -- pda 119975 - 29/05/2005 - Amalia Ara??

                                                          -- par?tro de fator relacionado para insert nas tabelas itreg_amb e itreg_fat

                                                         ,

                                                          Rec_Rela.Qt_Lancamento

                                                          -- pda 119975 - fim

                                                          );

          END LOOP;

        END;

        --

      ELSE

        --

        OPEN Dbamv.Pack_Lanca_Ffcv.c_Itregamb(Ncdregamb,

                                              Cprofat,

                                              Ncdatendimento);

        FETCH Dbamv.Pack_Lanca_Ffcv.c_Itregamb

          INTO v_Itregamb;

        CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregamb;

        --

        Ncdlcto := v_Itregamb.Cd_Lancamento;

        --

        IF v_Itregamb.Cd_Lancamento IS NOT NULL THEN

          IF v_Itregamb.Qt_Lancamento + Nqtde <= 0 THEN

            --

            -- PDA 197953 (In?o) - 08/08/2007 - Diego Costa

            -- inclus?de verifica? a regra de atendimento pro_fat antes da regra de acoplamaneto

            IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Ambu(Ncdregamb,

                                                          Ncdlcto,

                                                          'E') THEN

              IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Ambu(Ncdregamb,

                                                            Ncdlcto,

                                                            'E') THEN

                Verif_Franquia_Ambu(Ncdregamb, Ncdlcto, 'E');

              END IF;

            END IF;

            -- PDA 197953 (fim)

            --

            -- OP 684 - 13/12/2013 - corrigindo local de abertura do cursor, antes de deletar o registro na itreg_fat

            Ncdguiaitem := NULL;

            OPEN Dbamv.Pkg_Ffcv_Guia.Cguianoitem(Ncdregamb,

                                                 Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                     v_Mvto.Cd_Atendimento),

                                                 Ncdlcto);

            FETCH Dbamv.Pkg_Ffcv_Guia.Cguianoitem

              INTO Ncdguiaitem;

            CLOSE Dbamv.Pkg_Ffcv_Guia.Cguianoitem;

            --

            DELETE FROM Dbamv.Itreg_Amb

             WHERE Cd_Reg_Amb = Ncdregamb

               AND Cd_Lancamento = Ncdlcto

               AND Cd_Atendimento = Ncdatendimento;

            --

            /* pda 141006 - 06/06/2006 - Amalia Ara??

            Identificando a guia do item. Caso encontre e a mesma ainda esteja Pendente.

            Retirando o item da guia, caso haja e a guia ainda esteja Pendente.                 */

            --

            IF Ncdguiaitem IS NOT NULL THEN

              Dbamv.Pkg_Ffcv_Guia.Prc_Retirar_Item_Guia(Ncdguiaitem,

                                                        Cprofat,

                                                        v_Itregamb.Qt_Lancamento);

            END IF;

            /* pda 141006 - fim */

            /* PDA 288525 - 05/06/2009 - Fim - Fabr?o Oliveira de Miranda */

          ELSE

            --

            UPDATE Dbamv.Itreg_Amb

               SET Qt_Lancamento           = Qt_Lancamento + Nqtde,

                   Vl_Unitario             = NULL,

                   Vl_Filme_Unitario       = NULL,

                   Vl_Acrescimo            = NULL,

                   Vl_Desconto             = NULL,

                   Vl_Honorario_Unitario   = NULL,

                   Vl_Operacional_Unitario = NULL,

                   Vl_Total_Conta          = NULL

             WHERE Cd_Reg_Amb = Ncdregamb

               AND Cd_Lancamento = Ncdlcto

               AND Cd_Atendimento = Ncdatendimento;

            --

            -- PDA 197953 (In?o) - 08/08/2007 - Diego Costa

            -- inclus?de verifica? a regra de atendimento pro_fat antes da regra de acoplamaneto

            IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Ambu(Ncdregamb,

                                                          Ncdlcto,

                                                          'A') THEN

              IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Ambu(Ncdregamb,

                                                            Ncdlcto,

                                                            'A') THEN

                Verif_Franquia_Ambu(Ncdregamb, Ncdlcto, 'A');

              END IF;

            END IF;

            -- PDA 197953 (Fim)

            --

          END IF;

        END IF;

      END IF;

      --

    END IF;

  EXCEPTION

    WHEN Atend_Sem_Conta THEN

      Gera_Log_Falha(NULL,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdatendimento,

                     Cprofat,

                     Cprofat,

                     'Ambulatorio',

                     '04'

                     --, 'Atendimento ' || ncdatendimento || ' n?possui conta aberta/dispon?l'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_4',

                                                       'PACK_LANCA_FFCV',

                                                       'Atendimento %s n?possui Conta aberta/disponivel.',

                                                       Arg_List(Ncdatendimento)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, Ncdatendimento),

                     TRUE,

                     Deleting,

                     v_Mvto.Hr_Atendimento);

    WHEN Fora_Da_Conta THEN

      Gera_Log_Falha(NULL,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdatendimento,

                     Cprofat,

                     Cprofat,

                     'Ambulatorio',

                     '08'

                     --,'Procedimento com proibi? tipo Fora da Conta'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_8',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento com proibi? tipo Fora da Conta.',



                                                       Arg_List()) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, Ncdatendimento),

                     TRUE,

                     Deleting,

                     v_Mvto.Hr_Atendimento);

    WHEN Setor_Nao_Conf THEN

      Gera_Log_Falha(NULL,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdatendimento,

                     Cprofat,

                     Cprofat,

                     'Ambulatorio',

                     '02'

                     --, 'Grupo de Procedimento ' || ncdgrupro || ' n?tem Grupo de Faturamento relacionado'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_14',

                                                       'PACK_LANCA_FFCV',

                                                       'Grupo de Procedimento %s n?tem Grupo de Faturamento relacionado.',



                                                       Arg_List(Ncdgrupro)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, Ncdatendimento),

                     TRUE,

                     Deleting,

                     v_Mvto.Hr_Atendimento);

    WHEN Proc_Proibido THEN

      Gera_Log_Falha(NULL,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdatendimento,

                     Cprofat,

                     Cprofat,

                     'Ambulatorio',

                     '05'

                     --, 'Procedimento proibido para o Convenio ' || LTRIM (TO_CHAR (v_mvto.cd_convenio)) || ' e Plano ' || LTRIM (TO_CHAR (v_mvto.cd_con_pla))

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_7',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento proibido para o convenio %s e Plano %s.',

                                                       Arg_List(Ltrim(To_Char(v_Mvto.Cd_Convenio)),

                                                                Ltrim(To_Char(v_Mvto.Cd_Con_Pla)))) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, Ncdatendimento),

                     TRUE,

                     Deleting,

                     v_Mvto.Hr_Atendimento);

    -- OP 32555

	WHEN Proc_Proibido_idade THEN

	  -- OP 33697 - 05/10/2015 - Substituindo Gera_Log_Falha por Raise_Application_Error.

      Raise_Application_Error(-20054, Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20','PACK_LANCA_FFCV',

                                'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                Arg_List(Cprofat)));

      /*Gera_Log_Falha(NULL,

                     Ncdregamb,

                     Ncdatendimento,

                     Cprofat,

                     Cprofat,

                     'Ambulatorio',

                     '05',

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                                       Arg_List(Cprofat)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, Ncdatendimento),

                     TRUE,

                     Deleting,

                     v_Mvto.Hr_Atendimento);*/

  END;



  PROCEDURE Lanca_Atend_Ffcv(Ncdatend  IN NUMBER,

                             Ctpatend  IN VARCHAR2,

                             Ncdconv   IN NUMBER,

                             Ncdplano  IN Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*number pda 254997*/,

                             Ncdorigem IN NUMBER,

                             Ddtatend  IN DATE,

                             Dhratend  IN DATE,

                             Ncodprest IN NUMBER,

                             Nsetor    IN NUMBER,

                             Nconta    IN Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/) IS

    CURSOR c_Import(Nunid IN NUMBER) IS

      SELECT Cd_Import_Atend, --Inicio PDA 120693 - 22/04/05 - ELias

             --Esse decode ?ara ordernar o registro que estiver mais com maior abrangencia, para que no for loop

             --pegue o primeiro registro e saia do loop

             Decode(Cd_Convenio, NULL, 0, 1) Cd_Convenio,

             Decode(Cd_Con_Pla, NULL, 0, 2) Cd_Con_Pla,

             Decode(Cd_Ori_Ate, NULL, 0, 3) Cd_Ori_Ate,

             Decode(Cd_Unid_Int, NULL, 0, 4) Cd_Unid_Int

      --Fim PDA 120693

        FROM Dbamv.Import_Atend

       WHERE Import_Atend.Tp_Atendimento IN (Ctpatend, 'T')

            -- PDA 218665 (Inicio) - Henrique Antunes - 28/02/2008

         AND Import_Atend.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

            -- PDA 218665 (Fim)

         AND (Import_Atend.Cd_Convenio = Ncdconv OR

             Import_Atend.Cd_Convenio IS NULL)

         AND (Import_Atend.Cd_Con_Pla = Ncdplano OR

             Import_Atend.Cd_Con_Pla IS NULL)

         AND (Import_Atend.Cd_Unid_Int = Nunid OR

             Import_Atend.Cd_Unid_Int IS NULL)

         AND (Import_Atend.Cd_Ori_Ate = Ncdorigem OR

             Import_Atend.Cd_Ori_Ate IS NULL)

      -- Inicio PDA 120693  - 22/07/05 - Elias

       ORDER BY Cd_Convenio DESC,

                Cd_Con_Pla  DESC,

                Cd_Ori_Ate  DESC,

                Cd_Unid_Int DESC;

    -- Fim PDA 120693

    CURSOR c_Proced(Ncdimport IN NUMBER) IS

      SELECT Import_Atend_Pro_Fat.Cd_Pro_Fat,

             Import_Atend_Pro_Fat.Cd_Gru_Fat,

             Import_Atend_Pro_Fat.Qt_Lancada

        FROM Dbamv.Import_Atend_Pro_Fat

       WHERE Import_Atend_Pro_Fat.Cd_Import_Atend = Ncdimport;

    CURSOR c_Config IS

      SELECT Config_Ffcv.Sn_Pro_Fat_Atend_Auto,

             Config_Ffcv.Cd_Ati_Med_Clinico,

             Config_Ffcv.Tp_Controle_Lote,

             Config_Ffcv.Sn_Guia_Proc_Auto

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    -- PDA 108369 -- (INICIO)

    -- Substituir o union pelo union all. Colocar o trunc da data apenas na vari?l dDtAtend.

    CURSOR c_Loteambu(Pcdmultiempresa NUMBER) IS

      SELECT Reg_Amb.Cd_Reg_Amb

        FROM Dbamv.Reg_Amb,

             Dbamv.Convenio,

             Dbamv.Itagrupamento,

             Dbamv.Remessa_Fatura

       WHERE Reg_Amb.Cd_Convenio = Ncdconv

         AND Reg_Amb.Sn_Fechada = 'N'

         AND Reg_Amb.Cd_Multi_Empresa = Pcdmultiempresa

         AND Trunc(Ddtatend) BETWEEN

             Nvl(Reg_Amb.Dt_Lancamento, Trunc(Ddtatend)) AND

             Nvl(Reg_Amb.Dt_Lancamento_Final, Trunc(Ddtatend))

         AND Convenio.Cd_Convenio = Reg_Amb.Cd_Convenio

         AND Itagrupamento.Cd_Ori_Ate = Ncdorigem

         AND Itagrupamento.Cd_Agrupamento = Remessa_Fatura.Cd_Agrupamento

         AND Itagrupamento.Tp_Agrupamento = 'A'

         AND Itagrupamento.Cd_Convenio = Ncdconv

         AND Reg_Amb.Cd_Remessa = Remessa_Fatura.Cd_Remessa

         AND Reg_Amb.Cd_Reg_Amb NOT IN

             (SELECT Itreg_Amb.Cd_Reg_Amb

                FROM Dbamv.Itreg_Amb

               WHERE Itreg_Amb.Cd_Atendimento = Ncdatend

                 AND Itreg_Amb.Cd_Convenio = Ncdconv

                 AND Itreg_Amb.Sn_Fechada = 'S')

      UNION ALL

      SELECT Reg_Amb.Cd_Reg_Amb

        FROM Dbamv.Reg_Amb,

             Dbamv.Convenio

             --       ,dbamv.atendime

            ,

             Dbamv.Remessa_Fatura

       WHERE Reg_Amb.Cd_Convenio = Ncdconv

         AND Reg_Amb.Sn_Fechada = 'N'

         AND Reg_Amb.Cd_Multi_Empresa = Pcdmultiempresa

         AND Trunc(Ddtatend) BETWEEN

             Nvl(Reg_Amb.Dt_Lancamento, Trunc(Ddtatend)) AND

             Nvl(Reg_Amb.Dt_Lancamento_Final, Trunc(Ddtatend))

         AND Convenio.Cd_Convenio = Reg_Amb.Cd_Convenio

            --and reg_amb.cd_remessa = remessa_fatura.cd_remessa -- pda 95641 (colocado um alter join, p/ trazer lotes que estejam sem remessa)

         AND Reg_Amb.Cd_Remessa = Remessa_Fatura.Cd_Remessa(+) -- pda 95641

         AND Remessa_Fatura.Cd_Agrupamento IS NULL

         AND Reg_Amb.Cd_Reg_Amb NOT IN

             (SELECT Itreg_Amb.Cd_Reg_Amb

                FROM Dbamv.Itreg_Amb

               WHERE Itreg_Amb.Cd_Atendimento = Ncdatend

                 AND Itreg_Amb.Cd_Convenio = Ncdconv

                 AND Itreg_Amb.Sn_Fechada = 'S');

    -- PDA 108369 -- (FIM)

    CURSOR c_Tipo_Convenio IS

      SELECT Tp_Convenio

        FROM Dbamv.Convenio,

             Dbamv.Empresa_Convenio

       WHERE Convenio.Cd_Convenio = Ncdconv

         AND Convenio.Cd_Convenio = Empresa_Convenio.Cd_Convenio /* PDA 118607/129023*/

         AND Empresa_Convenio.Cd_Multi_Empresa =

             Dbamv.Pkg_Mv2000.Le_Empresa; /* PDA 118607/129023*/

    CURSOR c_Config_Particular IS

      SELECT Cd_Convenio_Fat_Extra Cd_Convenio,

             Cd_Con_Pla_Fat_Extra  Cd_Con_Pla

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    CURSOR c_Unid_Int IS

      SELECT Leito.Cd_Unid_Int

        FROM Dbamv.Leito,

             Dbamv.Atendime

       WHERE Atendime.Cd_Atendimento = Ncdatend

         AND Atendime.Cd_Leito = Leito.Cd_Leito

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    -- pda 87132 - 07/01/2004 - Amalia Ara??

    -- Atualiza? da ITREG_AMB.DT_SESSAO quando houver atendimento filho com

    -- quantidade de sesS??

    CURSOR Csessao IS

      SELECT 'X'

        FROM Dbamv.Atendime Atendime,

             Dbamv.Atendime Atendime_Pai

       WHERE Atendime.Cd_Atendimento_Pai = Ncdatend

         AND Atendime.Cd_Atendimento_Pai = Atendime_Pai.Cd_Atendimento

         AND Nvl(Atendime_Pai.Qt_Sessoes, 0) > 0

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    -- pda 87132 - fim

    -- PDA 127019 (In?o) 18/07/2005 - Pollyane Kely Alves Nunes

    -- Declara? dos cursores

    -- Retorna o c??o do hospital

    CURSOR Chospital IS

      SELECT Cd_Hospital

        FROM Dbamv.Hospital

       WHERE Hospital.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    -- PDA 190394 (Inicio)

    CURSOR Catend IS

      SELECT Cd_Atendimento_Pai

        FROM Dbamv.Atendime

       WHERE Cd_Atendimento = Ncdatend

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    -- PDA 190394 (Fim)

    -- Retorno o tipo do grupo do procedimento do procedimento que est?entando lan?

    CURSOR Cgrupo(Pcdprofat VARCHAR) IS

      SELECT Gru_Pro.Tp_Gru_Pro

        FROM Dbamv.Gru_Pro,

             Dbamv.Pro_Fat

       WHERE Gru_Pro.Cd_Gru_Pro = Pro_Fat.Cd_Gru_Pro

         AND Pro_Fat.Cd_Pro_Fat = Pcdprofat;

    -- PDA 127019 (Fim)



	-- OP 33980 - Identificar c??o de origem Planserv

	cursor cCarteira is

	  select c.tp_tp_ori_meio_mag

	    from dbamv.carteira c, dbamv.atendime a

	   where a.cd_atendimento = Ncdatend

	     and c.cd_paciente = a.cd_paciente

		   and c.cd_convenio = Ncdconv

       and c.tp_tp_ori_meio_mag is not null

		   and not exists( select cd_atendimento from dbamv.atendime_ori_meio_mag where cd_atendimento = Ncdatend);



     /*OP 41394*/

     CURSOR cProced(pProFat IN varchar2) IS

         SELECT pro_fat.nr_auxiliar

               ,pro_fat.cd_por_ane

               ,pro_fat.cd_gru_pro

           FROM dbamv.pro_fat

          WHERE pro_fat.cd_pro_fat = pProFat;





      CURSOR cRregra(pConvenio IN NUMBER ,

                        pPlano IN NUMBER) IS

            SELECT p.cd_regra

            FROM dbamv.empresa_con_pla p,

                dbamv.empresa_convenio c

            WHERE p.cd_convenio = c.cd_convenio

              AND p.cd_con_pla  = pPlano

              AND c.cd_convenio = pConvenio

              AND c.cd_multi_empresa = DBAMV.PKG_MV2000.LE_EMPRESA;

      /*OP 41394*/





    Proc_Proibido EXCEPTION;

  	proc_proibido_idade   exception;   -- OP 32555

    Atend_Sem_Conta EXCEPTION;

    Fora_Da_Conta EXCEPTION;

    Ncdimport         NUMBER;

    Ctpimport         VARCHAR2(1);

    Ctpproibicao      VARCHAR2(2);

    Ncdregfat         Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/

    ;

    Nqtautorizado     NUMBER;

    Ncdguia           NUMBER;

    Csnpacote         VARCHAR2(1);

    Ncdlcto           Dbamv.Itreg_Fat.Cd_Lancamento%TYPE /*number pda 254997*/

    ;

    Csnhoresp         VARCHAR2(1);

    Nprestador        NUMBER;

    Ccdatimed         VARCHAR2(2);

    Cclinico          VARCHAR2(2);

    Csnpgconv         VARCHAR2(1);

    Ctppgto           VARCHAR2(1);

    Ncdconvconta      NUMBER;

    Ncdplanconta      Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*number pda 254997*/

    ;

    Ncdregamb         Dbamv.Reg_Amb.Cd_Reg_Amb%TYPE /*number pda 254997*/

    ;

    Ncontaambu        Dbamv.Reg_Amb.Cd_Reg_Amb%TYPE /*number pda 254997*/

    ;

    v_Tp_Convenio     VARCHAR2(1);

    Ncdmultiempresa   NUMBER;

    Ncdunidint        NUMBER;

    Vtp_Controle_Lote VARCHAR2(1);

    v_Proced          c_Proced%ROWTYPE;

    v_Forapre         Dbamv.Pack_Lanca_Ffcv.c_Forapre%ROWTYPE;

    v_Particular      c_Config_Particular%ROWTYPE;

    -- pda 96511 - 23/06/2004 - Amalia Ara??

    Vcgabaritohosp   Dbamv.Pack_Lanca_Ffcv.Cgabaritohosp%ROWTYPE;

    Vcitgabaritohosp Dbamv.Pack_Lanca_Ffcv.Citgabaritohosp%ROWTYPE;

    Vcquantgabarito  Dbamv.Pack_Lanca_Ffcv.Cquantgabarito%ROWTYPE;

    -- pda 96511 - fim

    --PDA 95235 05/04/2004 Sp?ola (INICIO)

    --Declaradas variaveis a serem usadas nas excesS??

    Ncdimportatend NUMBER;

    --PDA 95235 (FIM)

    -- pda 87132 - 07/01/2004 - Amalia Ara??

    Vsessao Csessao%ROWTYPE;

    Dsessao DATE;

    -- pda 87132 - fim

    --

    -- PDA 96161 -- Alexandre Erik C. M. Costa 25/05/2004

    -- Declara? de vari?is

    Vsnguiaprocauto VARCHAR2(1);

    Nqtdguia        NUMBER;

    -- PDA 127019 (In?o) - 12/07/2005 - Pollyane K. Alves Nunes

    -- Declara? de vari?is

    Vsnretorno  Dbamv.Atendime.Sn_Retorno%TYPE;

    Vcdhospital Dbamv.Hospital.Cd_Hospital%TYPE;

    Vtpgrupro   Dbamv.Gru_Pro.Tp_Gru_Pro%TYPE;

    -- PDA 127019 (Fim)

    Nguiapendente Dbamv.Guia.Cd_Guia%TYPE; -- pda 145435 - 24/03/2006 - Jose Roberto

    -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

    Ncdpacote Dbamv.Conta_Pacote.Cd_Conta_Pacote%TYPE;

    Csnguia   VARCHAR2(1) := 'N';

    -- PDA 157145 (Fim)

    --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

    --v_contaambu dbamv.pack_lanca_ffcv.c_contaambu%rowtype;

    v_Contaambu Dbamv.Pkg_Ffcv_Conta.Tpcontaambu;

    --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

    Ncdatenpai    NUMBER;

    Ddthraux      DATE; -- PDA 221500 - 27/03/2008 - Diego Costa

    Vcontaambconv Dbamv.Reg_Amb.Cd_Reg_Amb%TYPE; /*PDA 294006*/

    Nqtexcedeu    NUMBER := NULL; -- OP 387

    Vtpcontapart  Dbamv.Itreg_Fat.Tp_Mvto%TYPE := NULL; -- OP 387

    Ncontapart    NUMBER := NULL; -- OP 387

    Nlanc         NUMBER := NULL; -- OP 387

    vSnRastreabilidade  varchar2(1); -- OP 20614

    vpCdLogRastro       Number ;  -- OP 20614

	  vTpOriMeioMag       varchar2(50);   -- OP 33980

    vTemRegraCriaContaAuto BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnCriouContaAuto      BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnCriouContaAutoAmb   BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vRegraCriaContaAuto    Dbamv.Pkg_Ffcv_Conta.TpContaAutomatica; /*OP 35916 - regra para cria? autom?ca de conta*/

    v_Conta Dbamv.Pkg_Ffcv_Conta.Tpconta; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnIntegracaoIpsemg  varchar2(2) ; -- OP 40186

    vRegraCriaContaAutoHE    Dbamv.Pkg_Ffcv_Conta.TpContaAutomatica; /*OP 41394*/

    vSnReplicaProcHe dbamv.pack_lanca_ffcv.cSnReplicaProcHe%ROWTYPE; /*OP 41394*/

    vSnReplicaProc   VARCHAR2(1);                                    /*OP 41394*/

    vRregra cRregra%ROWTYPE;                                         /*OP 41394*/

    vNlsBanco VARCHAR2(50);                                          /*OP 41394*/

    vProced  cProced%ROWTYPE;                                       /*OP 41394*/

    v_ContaCargoPac        Dbamv.Pkg_Ffcv_Conta.Tpconta;     /*ALLS OP 42241 */

    v_ContaCargoPacAmbu    Dbamv.Pkg_Ffcv_Conta.Tpcontaambu; /*ALLS OP 42241 */

    vRegraCriaContaAutoCP  Dbamv.Pkg_Ffcv_Conta.TpContaAutomaticaCP; /*ALLS OP 42241* - regra para cria? autom?ca de conta referente a Cargo Paciente*/

    vSnCargoPaciente       Dbamv.Pack_Lanca_Ffcv.cSnCargoPaciente%ROWTYPE; /*ALLS OP 42241*/

    vSnCriouContaAutoCP    BOOLEAN := FALSE; /*ALLS OP 42241 */

    vSnCriouContaAutoAmbCP BOOLEAN := FALSE; /*ALLS OP 42241 */

    NcdlctoCp              NUMBER  ; /*ALLS OP 42241 */

    NcdlctoAmbCp           NUMBER  ; /*ALLS OP 42241 */

    pEmpresa               NUMBER := Pkg_Mv2000.Le_Empresa;/*43289*/

    pvSnJaExcedeuQtd      Varchar2(1):= 'N'; /*43289*/

    pvMensagem             VARCHAR2(2000);    /*43289*/

    pSnChamadoDaTela       VARCHAR2(1) := 'N';       /*43289*/



  BEGIN



  /**************************** OP 20614 -  RASTREABILIDADE **************************************/

   dbamv.PKG_FFCV_RASTREABILIDADE.prc_existe_rotina_rastro('LANCA_ATEND_FFCV','PACK_LANCA_FFCV');  /*verifica se a rotina j?xiste, caso n? cadastra.*/



   vSnRastreabilidade := dbamv.PKG_FFCV_RASTREABILIDADE.fnc_sn_ativo_rasto('LANCA_ATEND_FFCV'); /*verifica se a rotina est?tiva para gerar log de rastreabilidade*/

   if vSnRastreabilidade = 'S' THEN



		dbamv.PKG_FFCV_RASTREABILIDADE.prc_grava_rastreabilidade(pRotina    => 'LANCA_ATEND_FFCV',

											  pEmpresa   => Dbamv.Pkg_Mv2000.Le_Empresa,

											  pDsConfig  => NULL,

												pCdLogRastro => vpCdLogRastro

															  );

    dbamv.PKG_FFCV_RASTREABILIDADE.prc_grava_it_rastreabilidade(

							pCdLogRastro     => vpCdLogRastro,

							pCdPasso         => 'PASSO1',

							pAtend           =>  Ncdatend,

							pDsParametros    =>  'Ctpatend = '||Ctpatend||' Ncdconv = '||Ncdconv||' Ncdplano = '||Ncdplano||' Ncdorigem = '||Ncdorigem ||' Ddtatend = '

                                   ||Ddtatend||' Dhratend = '||Dhratend||' Ncodprest = '||Ncodprest||' Nsetor = '||Nsetor||' Nconta = '||Nconta,

							pDsPasso         =>  'In?o da rotina ',

							pDsPassoTecnico  =>  ' Lendo parametros de entrada',

							pDsSolucao       =>  NULL,

							pSnSucesso       => 'S',

							pTpInfoPasso    => 'I' ,   /*(I - informa? , A = ALerta , E = Erro)*/

							pReserva         => null

																		 );

    end if;



  /**************************** OP 20614 RASTREABILIDADE **************************************/



    OPEN c_Config;

    FETCH c_Config

      INTO Ctpimport, Cclinico, Vtp_Controle_Lote, Vsnguiaprocauto;

    CLOSE c_Config;

    OPEN c_Config_Particular;

    FETCH c_Config_Particular

      INTO v_Particular;

    CLOSE c_Config_Particular;

    OPEN c_Tipo_Convenio;

    FETCH c_Tipo_Convenio

      INTO v_Tp_Convenio;

    CLOSE c_Tipo_Convenio;

    vSnIntegracaoIpsemg := Nvl(dbamv.pkg_mv2000.Le_Configuracao('FFCV','SN_AUTORIZACAO_LCTO_AUTO'),'N') ; -- OP 40186

    Ncdregfat := Nconta;

    Ncdregamb := Nconta;

    BEGIN

      -- PDA 127019 (In?o) 12/07/2005 - Pollyane K. A. Nunes

      -- inclu? o campo sn_retorno no select.

      SELECT Cd_Multi_Empresa,

             Sn_Retorno

        INTO Ncdmultiempresa,

             Vsnretorno

        FROM Dbamv.Atendime

       WHERE Cd_Atendimento = Ncdatend;

      -- PDA 127019 (Fim)

    EXCEPTION

      WHEN No_Data_Found THEN

        Ncdmultiempresa := NULL;

    END;

    -- PDA 127019 (In?o) 12/07/2005 - Pollyane K. A. Nunes

    -- Retornando o c??o do hospital

    OPEN Chospital;

    FETCH Chospital

      INTO Vcdhospital;

    CLOSE Chospital;

    -- PDA 127019 (Fim)

    IF Ctpatend NOT IN ('A', 'E', 'U') THEN

      OPEN c_Unid_Int;

      FETCH c_Unid_Int

        INTO Ncdunidint;

      CLOSE c_Unid_Int;

    ELSE

      Ncdunidint := NULL;

    END IF;



	-- OP 33980 - Gravando o de-para de origem do atendimento na tabela utilizada na gera? do txt.

	begin

	  vTpOriMeioMag := null;

	  open  cCarteira;

	  fetch cCarteira into vTpOriMeioMag;

	  close cCarteira;

	  if vTpOriMeioMag is not null then

	    insert into dbamv.atendime_ori_meio_mag( cd_atendimento, tp_tp_ori_meio_mag)

		 values( Ncdatend, vTpOriMeioMag);

	  end if;

	exception

	  when others then

	    dbamv.prc_grava_log_erro( 'atendime_ori_meio_mag', Ncdatend, null, 'vTpOriMeioMag:'||vTpOriMeioMag||'  sqlerrm;'||SQLERRM, 1 );

	end;

	-- OP 33980 - fim



    FOR v_Import IN c_Import(Ncdunidint)

    LOOP

      --PDA 95235 05/04/2004 Sp?ola (INICIO)

      --Inicializando varivais com o c??o da importa? do atendimento

      Ncdimportatend := NULL;

      Ncdimportatend := v_Import.Cd_Import_Atend;

      --PDA 95235 (FIM)

      IF Ctpatend IN ('H', 'I') AND Ctpimport IN ('H', 'S') THEN

        -- interna? -> Reg_Fat

        Ncdregfat := Nconta;

        FOR v_Proced IN c_Proced(v_Import.Cd_Import_Atend)

        LOOP



			if dbamv.fnc_ffcv_proibicao_idade( Ncdatend, Ncdconv, Ncdplano, v_proced.cd_pro_fat ) <> 'OK' then



			  raise proc_proibido_idade;

			end if;

			-- OP 32555 - fim



          Ctpproibicao := NULL;

          --PDA 95235 (FIM)

          /* OP 38292 (Inicio)

          OPEN Dbamv.Pack_Lanca_Ffcv.c_Proibicao(v_Proced.Cd_Pro_Fat,

                                                 Ncdconv,

                                                 Ncdplano,

                                                 Ctpatend,

                                                 Ddtatend,

                                                 Nsetor);

          FETCH Dbamv.Pack_Lanca_Ffcv.c_Proibicao

            INTO Ctpproibicao;

          CLOSE Dbamv.Pack_Lanca_Ffcv.c_Proibicao;

          */

          Ctpproibicao := dbamv.pack_ffcv_proibicao.fnc_ffcv_proibicao(v_Proced.Cd_Pro_Fat,

                                                   Ncdconv,

                                                   Ncdplano,

                                                   Ctpatend,

                                                   Ddtatend,

                                                   Nsetor,

                                                                       Ncdatend,

                                                                       NULL);

      -- OP 38292 (Fim)



          IF Nvl(Ctpproibicao, 'X') = 'FC' THEN

            --PDA 95235 05/04/2004 Sp?ola (INICIO)

            --A excess?de fora da conta foi substituida pela chamada da fun? diretamente

            --de forma que quando ha um item com excess?de fora da conta, esta n?paralisa a rotina.

            Gera_Log_Falha(Ncdregfat,

                           NULL,

                           Ncdimportatend,

                           Ncdimportatend,

                           v_Proced.Cd_Pro_Fat,

                           'Atendimento',

                           '08'

                           --,'Procedimento com proibi? tipo Fora da Conta'

                          ,

                           Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_8',

                                                             'PACK_LANCA_FFCV',

                                                             'Procedimento com proibi? tipo Fora da Conta.',

                                                             Arg_List()) -- OP 10402

                          ,

                           Ctpatend,

                           Ncdatend,

                           TRUE,

                           Deleting,

                           Dhratend);

            --PDA 95235 (FIM)

          ELSE



            IF Ctpproibicao = 'NA' THEN

              Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(Ncdatend,

                                                                           Ddtatend); -- pda 125871(acrescentada a data)

              Ncdconvconta := v_Particular.Cd_Convenio;

              Ncdplanconta := v_Particular.Cd_Con_Pla;

              IF Ncdregfat IS NULL THEN

                RAISE Proc_Proibido;

              END IF;

            ELSE



                /*OP 35916 - regra para cria? autom?ca de conta*/

                  vSnReplicaProc := NULL;      /*OP 41394*/

                  vTemRegraCriaContaAuto  := Dbamv.Pkg_Ffcv_Conta.FNC_TEM_REG_CRIA_CONTA_AUTO;



                  IF (vTemRegraCriaContaAuto) THEN



                      /*ALLS OP 42241*/

                      OPEN dbamv.pack_lanca_ffcv.cSnCargoPaciente(Ncdatend);

                      FETCH dbamv.pack_lanca_ffcv.cSnCargoPaciente INTO vSnCargoPaciente;

					            CLOSE dbamv.pack_lanca_ffcv.cSnCargoPaciente;



					            IF Nvl(vSnCargoPaciente.sn_carga_familiar,'N') = 'S' THEN



                          vRegraCriaContaAutoCP := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTCP(Ncdatend,

                                                                                                       v_Proced.Cd_Pro_Fat,

                                                                                                       Ddtatend); --FATURCONV-1383 - AMBS



                          IF (vRegraCriaContaAutoCP(1).cd_regra_cria_conta IS NOT NULL ) THEN



                              v_ContaCargoPac :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_HOSP_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                                  null,

                                                                                                  Ncdatend,

                                                                                                  NULL,

                                                                                                  vRegraCriaContaAutoCP(1).cd_convenio_destino,

                                                                                                  vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                                                                                                  Ddtatend,

                                                                                                  vRegraCriaContaAutoCP(1).cd_tipo_arq_cta_envio,

                                                                                                  vRegraCriaContaAutoCP(1).cd_desconto_inst); /*ALLS OP 35921*/

                              vSnCriouContaAutoCP := TRUE;

                          END IF;

                      /*fim ALLS OP 42241*/

                      ELSE



                          vRegraCriaContaAuto := Dbamv.Pkg_Ffcv_Conta.FNC_VERIFIC_REG_CRIA_CONTA_AUT(Ncdatend,

                                                                                                     v_Proced.Cd_Pro_Fat,

                                                                                                     Ddtatend); --FATURCONV-1383 - AMBS

                          IF (vRegraCriaContaAuto(1).cd_regra_cria_conta IS NOT NULL ) THEN



                                v_Conta :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_HOSP_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                             null,

                                                                                             Ncdatend,

                                                                                             null,

                                                                                             vRegraCriaContaAuto(1).cd_convenio_destino,

                                                                                             vRegraCriaContaAuto(1).cd_con_pla_destino,

                                                                                             Ddtatend,

                                                                                             vRegraCriaContaAuto(1).cd_tipo_arq_cta_envio,

                                                                                             vRegraCriaContaAuto(1).cd_desconto_inst); /*ALLS OP 35921*/

                                vSnCriouContaAuto := TRUE;

                            END IF;



                            /*OP 41394*/

                            vRegraCriaContaAutoHE := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTHE(Ncdatend,v_Proced.Cd_Pro_Fat,Ddtatend); --FATURCONV-1383 - AMBS



                            IF (vRegraCriaContaAutoHE(1).cd_regra_cria_conta IS NOT NULL ) THEN

                              vSnReplicaProc := 'S';

                            END IF;

                            /*OP 41394*/



                      END IF;



                  END IF;



                  IF (vSnCriouContaAuto) THEN



                    Ncdregfat    := v_Conta(1).Cd_Reg_Fat;

                    Ncdconvconta := v_Conta(1).cd_convenio;

                    Ncdplanconta := v_Conta(1).cd_con_pla;



                  ELSE

                  /*OP 35916 - regra para cria? autom?ca de conta*/

                      Ncdregfat    := Nconta;

                      Ncdconvconta := Ncdconv;

                      Ncdplanconta := Ncdplano;

                  END IF; /*OP 35916*/



            END IF;

            /* pda 145435 - 23/03/2006 - Jose Roberto                          (*)

            Alterando a verifica? da guia, retirando os cursores c_qtdexistente_amb e

            c_qtdexistente_fat para utilizar a nova fun? FNC_RETORNA_GUIA_DISPONIVEL;

            Retiradas as verifica?s nos cursores c_guia, c_itguia e c_itguia_proc_auto;

            Retirado o uso das vari?is totallancado e nqtautorizado;

            Caso NCDGUIA for Nulo, chamando a fun? F_GRAVA_GUIA, alterando o terceiro

            par?tro para nqtprofat;

            Retirado todo o c?ulo feito para atribuir valor as vari?is nqtpart,

            nqtconv e limite;

            Caso retorne uma Guia dispon?l, atribu?a ?ari?l NCDGUIA.         */

            IF Ctpproibicao = 'AG' THEN

            -- OP 40186 - incluido IF vSnIntegracaoIpsemg = 'S' THEN

              IF vSnIntegracaoIpsemg = 'S' THEN

                Ncdguia := NULL ;

              ELSE

              Ncdguia := Dbamv.Pkg_Ffcv_Guia.Fnc_Retorna_Guia_Disponivel(Ncdatend,

                                                                         Ncdregfat,

                                                                         NULL,

                                                                         v_Proced.Cd_Pro_Fat,

                                                                         v_Proced.Qt_Lancada,

                                                                         NULL,

                                                                         NULL,

                                                                         Nguiapendente);

               end if ;

              IF Nvl(Vsnguiaprocauto, 'N') = 'S' THEN

                IF Ncdguia IS NULL THEN

                  Ncdguia := Dbamv.f_Grava_Guia(Ncdatend,

                                                Ncdconvconta,

                                                v_Proced.Qt_Lancada,

                                                v_Proced.Cd_Pro_Fat,

                                                'P');

                END IF;

              END IF;

            END IF;

            -- pda 145435 (Fim)

            OPEN Dbamv.Pack_Lanca_Ffcv.c_Forapre(Ncdconvconta,

                                                 v_Proced.Cd_Gru_Fat);

            FETCH Dbamv.Pack_Lanca_Ffcv.c_Forapre

              INTO v_Forapre;

            CLOSE Dbamv.Pack_Lanca_Ffcv.c_Forapre;

            IF v_Forapre.Sn_Prestador = 'S' THEN

              Nprestador := Ncodprest;

              Ccdatimed  := Cclinico;

            ELSE

              Nprestador := NULL;

              Ccdatimed  := NULL;

            END IF;

            IF Nprestador IS NOT NULL THEN

              --   PDA 100970(Inicio) 26/07/2006 Thiago Holder Marcos Silva

              --   Chamada da fun? dbamv.pkg_ffcv_it_conta.fnc_retorna_tp_pagamento();

              --   Esta fun? tamb?verifica se o prestador credenciado tem alguma exce?,

              --   caso tenha, o tipo de pagamento P - Produ?

              --

              --   OPEN dbamv.pack_lanca_ffcv.c_prescon (nprestador, ncdconvconta);

              --   FETCH dbamv.pack_lanca_ffcv.c_prescon INTO csnpgconv;

              --   CLOSE dbamv.pack_lanca_ffcv.c_prescon;

              Ctppgto := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Retorna_Tp_Pagamento(Nprestador,

                                                                          Ncdconvconta,

                                                                          Ctpatend,

                                                                          v_Proced.Cd_Pro_Fat,

                                                                          Ncdorigem

                                                                          -- PDA 166691 (Inicio) - Henrique Antunes - 28/11/2006

                                                                         ,

                                                                          Ddtatend,

                                                                          Dhratend

                                                                          -- PDA 166691 (Fim)

                                                                          );

            ELSE

              Csnpgconv := NULL;

              Ctppgto   := NULL; -- 'P' ; -- ( pda 84408  setado de null p/ 'P') -- pda 104455 desfazer o que foi feito no pda 84408

            END IF;

            IF Dbamv.Pack_Lanca_Ffcv.Is_Hor_Esp(Ncdconvconta,

                                                Ncdplanconta,

                                                Ctpatend,

                                                Ddtatend,

                                                Dhratend,

                                                v_Proced.Cd_Gru_Fat,

                                                v_Proced.Cd_Pro_Fat

                                                -- PDA 119427 11/04/2005 Henrique Antunes (In?o)

                                                -- Passar NULL para o par?tro de regra

                                               ,

                                                NULL

                                                -- PDA 119427 (FIM)

                                               , --PDA 108041 / 108039 12/11/2004 Sp?ola (INICIO)

                                                --Inserido o paremetro cd_prestador / cd_setor para permitir exce?s de convenios e planos por prestador

                                                Nprestador,

                                                Nsetor --PDA 108041 / 108039 (FIM)

                                                ) THEN

              Csnhoresp := 'S';

            ELSE

              Csnhoresp := 'N';

            END IF;

            -- IF csnpgconv IS NOT NULL THEN

            --   IF NVL (csnpgconv, 'N') = 'S' THEN

            --      ctppgto := 'C';

            --   ELSE

            --      ctppgto := 'P';

            --   END IF;

            -- ELSIF nprestador IS NOT NULL THEN

            --   ctppgto := 'P';

            -- END IF;

            -- PDA 100970 26/07/2006 Thiago Holder Marcos Silva

            -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

            IF Ctpproibicao = 'AG' THEN

              Csnguia := 'S';

            END IF;

            -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

            -- Prepara? da data que ser?assada na fun?.

            -- A data preparada ir?onter al?da data de lan?ento, a hora de lan?ento.

            Ddthraux := To_Date(To_Char(Ddtatend, 'DD/MM/YYYY') || ' ' ||

                                To_Char(Nvl(Dhratend, Ddtatend),

                                        'HH24:MI:SS'),

                                'DD/MM/YYYY HH24:MI:SS');

            -- PDA 221500 (Fim)

            /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

            nQtExcedeu a vari?l retorna justamente a quantidade de procedimentos que deve ser lan?o no procedimento

            que pertence ao pacote, em seguida deve ser inserdio um outro procedimento com o que restou do lan?ento*/

            Nqtexcedeu := NULL;

            --

            /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

            vTpContaPart a vari?l retorna justamente se o procedimento vai ser inserido em uma conta particular ou ira seguir

            o processo normalmente.*/

            Ncdpacote := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Gera_Pacote(Ncdatend,

                                                                 Ctpatend,

                                                                 Ncdconvconta,

                                                                 Ncdplanconta

                                                                 -- PDA 249989 (In?o) - 01/10/2008 - Diego Costa

                                                                 -- ,ncdregfat

                                                                ,

                                                                 Ncdregamb

                                                                 -- PDA 249989 (Fim)

                                                                ,

                                                                 v_Proced.Cd_Gru_Fat,

                                                                 v_Proced.Cd_Pro_Fat,

                                                                 Nsetor,

                                                                 Nprestador

                                                                 -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

                                                                 -- ,sysdate

                                                                ,

                                                                 Nvl(Ddthraux,

                                                                     SYSDATE)

                                                                 -- PDA 221500 (Fim)

                                                                ,

                                                                 Ncdatend,

                                                                 NULL,

                                                                 'Atendimento',

                                                                 Csnguia,

                                                                 v_Proced.Qt_Lancada,

                                                                 Csnpacote,

                                                                 Nqtexcedeu -- OP 387

                                                                ,

                                                                 Vtpcontapart -- OP 387

                                                                ,

                                                                 NULL

                                                                 -- PDA 225086 (Inicio)

                                                                ,

                                                                 Ncdatend,

                                                                 NULL --pCdProFatPacote

                                                                ,

                                                                 Ncdlcto --pCdLancamento_pac

                                                                ,

                                                                 NULL); --preserva

            -- PDA 225086 (fim)

            /* pda 481126 - depois da FNC_GERA_PACOTE regravando o cd_lancamento_pac */

            IF Ctpatend NOT IN ('A', 'E', 'U') THEN

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncdregfat);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                INTO Ncdlcto;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

            ELSE

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Ncdregamb);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                INTO Ncdlcto;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;

            END IF;

            --

            IF Ncdpacote IS NOT NULL THEN

              UPDATE Dbamv.Conta_Pacote

                 SET Cd_Lancamento_Pac = Ncdlcto

               WHERE Cd_Conta_Pacote = Ncdpacote;

            END IF;

            /* pda 481126 - fim */

            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o procedimento que ira ser inserido abaixo pertence a um pacote, e a qunatidade que sera inserida sera menor que a lan?a, a diferen?

            sera lan?a na rotina mais abaixo atravez da procedure PRC_DESVINCULA_PROCEDIMENTO*/

            /* Fazendo tratamento caso o procedimento esteja configurado no gabarito para ser inserido dentro de uma conta particular

            caso a variavel vTpContaPart esteja preenchida e a quantidade de lan?ento extra esteja nula. com iso deve ser procurado uma conta particular

            e um lan?ento para inseririr nesta conta.*/

            Ncontapart := NULL;

            Nlanc      := NULL;



			/*43289 - quebra de conta por quantidade de procedimento por atendimento*/

			/*A regra de pacote tem prioridade sobre essa regra, conforme vari?l Nqtexcedeu abaixo*/

			IF Nqtexcedeu IS NULL THEN

				if (not vSnCriouContaAuto) then /*OP 46768*/

					  IF DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_EXISTE_CONF_QTD_ATEND_PAC(nCdAtend,

																						 v_proced.cd_pro_fat,

																						 pEmpresa) THEN



						  Nqtexcedeu := DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_RETORNA_QTD_LANC_PERIODO(nCdAtend,

																									   v_proced.cd_pro_fat,

																									   pEmpresa,

																									   ncdregfat,

																									   v_proced.qt_lancada,

																									   pSnChamadoDaTela,

																									   pvSnJaExcedeuQtd,

																									   pvMensagem

																									   );

						  IF pvSnJaExcedeuQtd = 'S' THEN

							  Vtpcontapart := 'ProcPorAtend';

							  Nqtexcedeu   := NULL;

						  ELSE

								IF NVL(Nqtexcedeu,0) > 0 THEN

									Vtpcontapart := 'ProcPorAtend';

								END IF;

						  END IF;

					END IF;

				END IF;	/*OP 46768*/

		     END IF;

			/*43289*/



            IF Nvl(Vtpcontapart, 'X') <> 'X' AND Nqtexcedeu IS NULL THEN

              Ncontapart := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(Ncdatend,

                                                                         Ddtatend);

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncontapart);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                INTO Nlanc;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

            END IF;

            INSERT INTO Dbamv.Itreg_Fat

              (Cd_Reg_Fat,

               Cd_Lancamento,

               Dt_Lancamento,

               Hr_Lancamento,

               Qt_Lancamento,

               Cd_Guia,

               Vl_Percentual_Multipla,

               Cd_Gru_Fat,

               Cd_Pro_Fat,

               Sn_Pertence_Pacote,

               Cd_Prestador,

               Cd_Ati_Med,

               Tp_Pagamento,

               Cd_Setor,

               Cd_Setor_Produziu,

               Sn_Horario_Especial,

               Cd_Usuario,

               Cd_Mvto,

               Tp_Mvto

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Cd_Conta_Pacote

               -- PDA 157145 (Fim)

               )

            VALUES

              (Nvl(Ncdregfat,Nconta) -- OP 387  -- OP 21437 (694462)  - Invertido variaveis no nvl . antes : Nvl(Nconta, Ncdregfat)

              ,

               Nvl(Nlanc, Ncdlcto) -- OP 387

              ,

               Ddtatend,

               Dhratend,

               Nvl(Nqtexcedeu, v_Proced.Qt_Lancada) -- OP 387

              ,

               Ncdguia,

               100,

               v_Proced.Cd_Gru_Fat,

               v_Proced.Cd_Pro_Fat,

               Nvl(Csnpacote, 'N'),

               Nprestador,

               Ccdatimed,

               Ctppgto,

               Nsetor,

               Nsetor,

               Csnhoresp,

               USER,

               Ncdatend,

               Nvl(Vtpcontapart, 'Atendimento') -- OP 387

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Ncdpacote

               -- PDA 157145 (Fim)

               );





              /*OP 42241 - Caso tenha criado a conta por cargo paciente, devemos lan? o item para o convenio, plano, percentual definido na configura

              de quebra de conta por cargo paciente*/

              IF (vSnCriouContaAutoCP) THEN

                  vSnCriouContaAutoCP := FALSE;



                  OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(v_ContaCargoPac(1).cd_reg_fat);

                  FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                  INTO NcdlctoCp;

                  CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;



                   INSERT INTO Dbamv.Itreg_Fat

                    (Cd_Reg_Fat,

                     Cd_Lancamento,

                     Dt_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Vl_Percentual_Multipla,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Sn_Pertence_Pacote,

                     Cd_Prestador,

                     Cd_Ati_Med,

                     Tp_Pagamento,

                     Cd_Guia,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto

                     )

                  VALUES

                    (v_ContaCargoPac(1).cd_reg_fat,

                     NcdlctoCp,

                     Ddtatend,

                     Ddtatend,

                     Nvl(Nqtexcedeu, v_Proced.Qt_Lancada),

                     vRegraCriaContaAutoCP(1).vl_percentual_carga_familiar,

                     v_Proced.Cd_Gru_Fat,

                     v_Proced.Cd_Pro_Fat,

                     'N',

                     Nprestador,

                     Ccdatimed,

                     Ctppgto,

                     Ncdguia,

                     Nsetor,

                     Nsetor,

                     'N',

                     USER,

                     Ncdatend,

                     Nvl(Vtpcontapart, 'Atendimento')

                     );

              END IF;

              /*OP 42241*/



        /*OP 41394 - replicar horario especial no lan?ento autom?co. Incialmente implementa? pro cliente HOSCAR*/

        IF (nvl(Csnhoresp,'N') = 'S'

            AND (NOT vSnCriouContaAuto) /*n??m item de regra de quebra de conta autom?ca*/

            AND vSnReplicaProc = 'S' )  /*tem regra pra replicar proc de hor?o especial*/

            THEN



             OPEN cProced(v_Proced.Cd_Pro_Fat);

             FETCH cProced INTO vProced;

             CLOSE cProced;



             OPEN cRregra(Ncdconvconta,Ncdplanconta);

             FETCH cRregra INTO vRregra;

             CLOSE cRregra;



             vNlsBanco := dbamv.FNC_FFCV_FIRST_DAY_SEMANA_BR('S',null);

             OPEN dbamv.pack_lanca_ffcv.cSnReplicaProcHe(vRregra.cd_regra,

                                   vProced.cd_gru_pro,

                                   v_Proced.Cd_Pro_Fat,

                                   TO_NUMBER(TO_CHAR(Ddtatend, 'd')),

                                   Dhratend,

                                   Ctpatend);

             FETCH dbamv.pack_lanca_ffcv.cSnReplicaProcHe INTO vSnReplicaProcHe;

             CLOSE dbamv.pack_lanca_ffcv.cSnReplicaProcHe;

             vNlsBanco := dbamv.FNC_FFCV_FIRST_DAY_SEMANA_BR('N',vNlsBanco);



             IF Nvl(vSnReplicaProcHe.sn_replica_proc,'N') = 'S' THEN



                 dbamv.prc_ffcv_replica_proc_he(Nvl(Ncdregfat,Nconta),     -- pCdConta IN NUMBER ,

                                            Nvl(Nlanc, Ncdlcto),             --pCdLancConta IN NUMBER ,

                                            'I',                            --pTpAtend     IN VARCHAR2,

                                            vSnReplicaProcHe.vl_percentual, --pVlPercent   IN NUMBER DEFAULT null,

                                            'N'                             --pSnInsereConta IN VARCHAR2

                                            );



                 dbamv.prc_ffcv_replica_proc_he(Nvl(Ncdregfat,Nconta),

                                            Nvl(Nlanc, Ncdlcto),

                                            'I',

                                            null,

                                            'S');

             END IF;

        END IF;

        /*OP 41394*/



            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

            os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

            IF Nqtexcedeu IS NOT NULL THEN

              Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregfat,

                                                                  Ncdlcto,

                                                                  (v_Proced.Qt_Lancada -

                                                                  Nqtexcedeu),

                                                                  Vtpcontapart,

                                                                  Ddtatend,

																  Ncdatend); /*ALLS OP 43289*/

            END IF;

            /* OP 387 - Thiago Miranda de oliveira - este trecho de c??o somente sera utilizado se a configura? de gerar o item em conta de particular

            por causa do pacote, n?estiver preenchido*/

            IF Nvl(Vtpcontapart, 'X') = 'X' THEN

              IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                            Ncdlcto,

                                                            'I') THEN

                IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                              Ncdlcto,

                                                              'I') THEN

                  Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'I');

                END IF;

              END IF;

            END IF;



            -- PDA 101961 (In?o)  - 17/09/2004 - Pollyane Kely Alves Nunes

            -- inclus?do lan?ento dos valores relacionados na procedure LANCA_ATEND_FFCV

            -- /* Lancamento dos Valores Relacionados */ --

            DECLARE

              CURSOR c_Relacionados IS

                SELECT Rela.Cd_Pro_Fat,

                       Rela.Tp_Atend_Homecare,

                       Rela.Tp_Atend_Externo,

                       Rela.Tp_Atend_Urgeme,

                       Rela.Tp_Atend_Ambulatorial,

                       Rela.Tp_Atend_Internacao

                       --PDA 108042 22/11/2004 Sp?ola (INICIO)

                       --Inserida a coluna qt_lancamento que ir?ultiplicar a quantidade na rotina Dbamv.lanca_ffcv_pro_relacionados

                      ,

                       Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

                --PDA 108042 (FIM)

                  FROM Dbamv.Con_Pla,

                       Dbamv.Regra,

                       Dbamv.Val_Pro_Relacionado Rela,

                       Dbamv.Empresa_Con_Pla /* PDA 118607/131598 */

                        ,dbamv.pro_fat             -- OP 32555 *2

                 WHERE Empresa_Con_Pla.Cd_Convenio = Con_Pla.Cd_Convenio /* PDA 118607/131598 */

                   AND Empresa_Con_Pla.Cd_Con_Pla = Con_Pla.Cd_Con_Pla /* PDA 118607/131598 */

                   AND Empresa_Con_Pla.Cd_Multi_Empresa =

                       Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/131598 */



					 -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

                     --AND Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat

					 and ( ( rela.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = rela.cd_pro_fat and Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					    or ( rela.cd_pro_fat_pai is null and rela.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                             AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

					     )

				     -- OP 32555 - fim



                   AND Con_Pla.Cd_Convenio = Ncdconv

                   AND Con_Pla.Cd_Con_Pla = Ncdplano

                   AND Rela.Tp_Lancamento = 'A'

                      --PDA 114239 17/01/2005 Sp?ola (INICIO)

                      --Incluida verifica? por tipo de atendimento para os procedimentos relacionados

                   AND ((Ctpatend = 'H' AND Rela.Tp_Atend_Homecare = 'S') OR

                       (Ctpatend = 'E' AND Rela.Tp_Atend_Externo = 'S') OR

                       (Ctpatend = 'U' AND Rela.Tp_Atend_Urgeme = 'S') OR

                       (Ctpatend = 'A' AND

                       Rela.Tp_Atend_Ambulatorial = 'S') OR

                       (Ctpatend = 'I' AND Rela.Tp_Atend_Internacao = 'S'))

                      --PDA 114239 (FIM)

                   AND Con_Pla.Cd_Regra = Regra.Cd_Regra

                   AND Rela.Cd_Regra = Regra.Cd_Regra

                   AND Rela.Dt_Vigencia IN

                       (SELECT MAX(Vpr.Dt_Vigencia)

                          FROM Dbamv.Val_Pro_Relacionado Vpr

                         WHERE Vpr.Dt_Vigencia <= Ddtatend

                           AND Vpr.Cd_Regra = Rela.Cd_Regra

                             -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

					         -- AND Vpr.Cd_Pro_Fat_Pai = Rela.Cd_Pro_Fat_Pai

					         -- AND Vpr.Cd_Pro_Fat = Rela.Cd_Pro_Fat

					         and ( ( Vpr.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = Vpr.cd_pro_fat and Vpr.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					            or ( Vpr.cd_pro_fat_pai is null and Vpr.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                                     AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

						          )

						     -- OP 32555 - fim

						   );

              Cretorno VARCHAR2(1);

            BEGIN

              FOR Rec_Rela IN c_Relacionados

              LOOP

                Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(Ncdatend,

                                                              Ncdregfat,

                                                              Ncdlcto,

                                                              Ncdimportatend,

                                                              v_Proced.Cd_Pro_Fat,

                                                              Ddtatend,

                                                              Dhratend,

                                                              Nsetor,

                                                              'P',

                                                              Ctpatend,

                                                              Ddtatend,

                                                              Ncdconvconta, --V_Conta.cd_convenio    ,

                                                              Ncdplanconta /*  ncdconvconta    pda 131200  */, --V_Conta.Cd_con_pla     ,

                                                              NULL

                                                              /*nCd_atendimento_pai*/,

                                                              v_Tp_Convenio,

                                                              NULL,

                                                              Rec_Rela.Cd_Pro_Fat, --PDA 108042 22/11/2004 Sp?ola (INICIO)

                                                              --As quantidades lan?a ser?ultiplicadas pelo fator de quantidade qt_lancamento

                                                              Rec_Rela.Qt_Lancamento *

                                                              v_Proced.Qt_Lancada, --PDA 108042 (FIM)

                                                              0,

                                                              'I'

                                                              --PDA 108070 29/12/2004 Sp?ola (INICIO)

                                                              --Inserido o campo do prestador que ser?tilizado apenas para os procedimentos relacionados de ambulatorio

                                                              --lancadados pela prc_ffcv_lanca_atendimento - lancamento automatico do procedimento principal na criacao do atendimento

                                                             ,

                                                              NULL --cd_prestador

                                                              --PDA 108070 (FIM)

                                                              -- pda 119975 - 29/05/2005 - Amalia Ara??

                                                              -- par?tro de fator relacionado para insert nas tabelas itreg_amb e itreg_fat

                                                             ,

                                                              Rec_Rela.Qt_Lancamento

                                                              -- pda 119975 - fim

                                                              );

              END LOOP;

            END;

            -- PDA 101961 (Fim)

          END IF;

        END LOOP;

      END IF;

      --

      -- PDA 232394 inicio

      OPEN Catend;

      FETCH Catend

        INTO Ncdatenpai;

      CLOSE Catend;

      -- PDA 232394 fim

      --

      IF Ctpatend IN ('A', 'E', 'U') AND Ctpimport IN ('A', 'S') THEN

        -- Ambulat?? -> Reg_Amb

        -- PDA 190394 (Inicio)

        --IF vtp_controle_lote <> 'U' THEN

        --   OPEN c_loteambu (ncdmultiempresa);

        --  FETCH c_loteambu INTO ncontaambu;

        --  CLOSE c_loteambu;

        --   ncdregamb := ncontaambu;

        --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

        /*OPEN dbamv.pack_lanca_ffcv.c_contaambu (nCdAtend,

                                                dDtAtend,

                                                NULL,

                                                nCdAtenPai);

        FETCH dbamv.pack_lanca_ffcv.c_contaambu INTO v_contaambu;

        CLOSE dbamv.pack_lanca_ffcv.c_contaambu;*/

        v_Contaambu := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Ccontaambu(Ncdatend,

                                                                   Ddtatend,

                                                                   NULL,

                                                                   Ncdatenpai);

        --nCdRegAmb := v_contaambu.cd_reg_amb;

        Ncdregamb := v_Contaambu(1).Cd_Reg_Amb;

        --

        --FATURCONV-4264 - Corre? onde se a conta estiver fechada, gerar o log para o cliente, o sistema estava abrindo a conta e lan?do o item.

        IF Nvl(v_Contaambu(1).Sn_Fechada, 'N') = 'S' THEN

          RAISE Atend_Sem_Conta;

        END IF;

        --FATURCONV-4264 - fim



         --

        --FATURCONV-4264 - Corre? onde se a conta estiver fechada, gerar o log para o cliente, o sistema estava abrindo a conta e lan?do o item.

        IF Nvl(v_Contaambu(1).Sn_Fechada, 'N') = 'S' THEN

          RAISE Atend_Sem_Conta;

        END IF;

        --FATURCONV-4264 - fim



        --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

        --ELSE

        --   ncdregamb := NULL;

        --END IF;

        -- PDA 190394 (Fim)

        IF Ncdregamb IS NULL THEN

          IF v_Tp_Convenio = 'P' THEN

            Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(Ncdatend); -- PDA 190394

          ELSE

            Ncdregamb := Dbamv.Pack_Ffcv.Cria_Conta_Acoplamentoambu(Ncdatend,

                                                                    'N'); -- PDA 190394

          END IF;

        END IF;

        /*PDA 294006(inicio) - 29/05/2009 - Jansen Gallindo

        esta vari?l foi criada, pois quando existia mais de um procedimento cadastrado como procedimento do atendimento,

        e um desses tinha proibi? NA, os dois procedimentos estavam sendo lan?os na conta particular criada abaixo.

        Esta guarda a conta de convenio criada logo acima.*/

        Vcontaambconv := Ncdregamb;

        /*PDA 294006(fim) - 29/05/2009 - Jansen Gallindo*/

        FOR v_Proced IN c_Proced(v_Import.Cd_Import_Atend)

        LOOP

          Ncdregamb := Vcontaambconv; /*PDA 294006- 29/05/2009 - Jansen Gallindo */

          -- PDA 127019 (In?o) - 18/07/2005 - Pollyane Kely Alves Nunes

          -- If criado para barrar o lan?ento autom?co, em atendimentos ambulatoriais,

          -- de procedimentos do atendimento do grupo de procedimento do tipo

          -- SP - Servi? Profissionais com algumas excesS??

          OPEN Cgrupo(v_Proced.Cd_Pro_Fat);

          FETCH Cgrupo

            INTO Vtpgrupro;

          CLOSE Cgrupo;

          -- Se n?for retorno ou se for os hospitais 406 e 303 lan?tudo

          IF (Nvl(Vsnretorno, 'N') = 'N' OR

             (To_Number(Nvl(Vcdhospital, '0')) IN (406, 303))) OR -- Se for o hospital 375 para atendimentos de retorno S??oibe os c??os 00010014 e 00010073

             (Nvl(Vsnretorno, 'N') = 'S' AND

             To_Number(Nvl(Vcdhospital, '0')) IN (375) AND

             v_Proced.Cd_Pro_Fat NOT IN ('00010014', '00010073')) OR -- Se for retorno n?lan?procedimentos do grupo SP para os demais hospitais

             (Nvl(Vsnretorno, 'N') = 'S' AND Vtpgrupro <> 'SP' AND

             To_Number(Nvl(Vcdhospital, '0')) NOT IN (303, 375, 406)) THEN

            -- PDA 127019 (Fim)



			-- OP 32555 - 27/09/2015 - verifica? de proibi? por Idade. Retorna OK caso n?haja proibi?, e mensagem para o alert caso haja.

			if dbamv.fnc_ffcv_proibicao_idade( Ncdatend, Ncdconv, Ncdplano, v_proced.cd_pro_fat ) <> 'OK' then

			  raise proc_proibido_idade;

			end if;

			-- OP 32555 - fim



            --PDA 95235 01/04/2003 Sp?ola (INICIO)

            --A vari?l cTpPoribicao n?estava sendo inicializada.

            Ctpproibicao := NULL;

            --PDA 95235 (FIM)

/* OP 38292 (Inicio)

            OPEN Dbamv.Pack_Lanca_Ffcv.c_Proibicao(v_Proced.Cd_Pro_Fat,

                                                   Ncdconv,

                                                   Ncdplano,

                                                   Ctpatend,

                                                   Ddtatend,

                                                   Nsetor);

            FETCH Dbamv.Pack_Lanca_Ffcv.c_Proibicao

              INTO Ctpproibicao;

            CLOSE Dbamv.Pack_Lanca_Ffcv.c_Proibicao;

          */

            Ctpproibicao := dbamv.pack_ffcv_proibicao.fnc_ffcv_proibicao(v_Proced.Cd_Pro_Fat,

                                                     Ncdconv,

                                                     Ncdplano,

                                                     Ctpatend,

                                                     Ddtatend,

                                                     Nsetor,

                                                                         Ncdatend,

                                                                         NULL);

      -- OP 38292 (Fim)



            IF Nvl(Ctpproibicao, 'X') = 'FC' THEN

              --PDA 95235 05/04/2004 Sp?ola (INICIO)

              --A excess?de fora da conta foi substituida pela chamada da fun? diretamente

              --de forma que quando ha um item com excess?de fora da conta, esta n?paralisa a rotina.

              Gera_Log_Falha(NULL,

                             Ncdregamb,

                             Ncdimportatend,

                             Ncdimportatend,

                             v_Proced.Cd_Pro_Fat,

                             'Atendimento',

                             '08'

                             --,'Procedimento com proibi? tipo Fora da Conta'

                            ,

                             Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_8',

                                                               'PACK_LANCA_FFCV',

                                                               'Procedimento com proibi? tipo Fora da Conta.',



                                                               Arg_List()) -- OP 10402

                            ,

                             Ctpatend,

                             Nvl(Ncdatenpai, Ncdatend) -- PDA 190394

                            ,

                             TRUE,

                             Deleting,

                             Dhratend);

              --PDA 95235 (FIM)

            ELSE

              IF Ctpproibicao = 'NA' THEN

                Ncdregamb    := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(Ncdatend);

                Ncdconvconta := v_Particular.Cd_Convenio;

                Ncdplanconta := v_Particular.Cd_Con_Pla;

              ELSE



                  /*OP 35916 - regra para cria? autom?ca de conta*/

                  vSnReplicaProc := NULL;      /*OP 41394*/

                  vTemRegraCriaContaAuto  := Dbamv.Pkg_Ffcv_Conta.FNC_TEM_REG_CRIA_CONTA_AUTO;

                  IF (vTemRegraCriaContaAuto) THEN



                      /*ALLS OP 42241*/

                      OPEN dbamv.pack_lanca_ffcv.cSnCargoPaciente(Ncdatend);

                      FETCH dbamv.pack_lanca_ffcv.cSnCargoPaciente INTO vSnCargoPaciente;

					            CLOSE dbamv.pack_lanca_ffcv.cSnCargoPaciente;



					            IF Nvl(vSnCargoPaciente.sn_carga_familiar,'N') = 'S' THEN



                          vRegraCriaContaAutoCP := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTCP(Ncdatend,

                                                                                                       v_Proced.Cd_Pro_Fat,

                                                                                                       Ddtatend); --FATURCONV-1383 - AMBS



                          IF (vRegraCriaContaAutoCP(1).cd_regra_cria_conta IS NOT NULL ) THEN





                              v_ContaCargoPacAmbu :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_AMB_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                                      null,

                                                                                                      Ncdatend,

                                                                                                      null,

                                                                                                      vRegraCriaContaAutoCP(1).cd_convenio_destino,

                                                                                                      vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                                                                                                      Ddtatend,

                                                                                                      vRegraCriaContaAutoCP(1).cd_tipo_arq_cta_envio,

                                                                                                      vRegraCriaContaAutoCP(1).cd_desconto_inst); /*ALLS OP 35921*/



                              vSnCriouContaAutoAmbCP := TRUE;

                          END IF;

                      /*fim ALLS OP 42241*/

                      ELSE



                          vRegraCriaContaAuto := Dbamv.Pkg_Ffcv_Conta.FNC_VERIFIC_REG_CRIA_CONTA_AUT(Ncdatend,

                                                                                                     v_Proced.Cd_Pro_Fat,

                                                                                                     Ddtatend); --FATURCONV-1383 - AMBS



                          IF (vRegraCriaContaAuto(1).cd_regra_cria_conta IS NOT NULL)  THEN



                              v_Contaambu :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_AMB_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                              null,

                                                                                              Ncdatend,

                                                                                              null,

                                                                                              vRegraCriaContaAuto(1).cd_convenio_destino,

                                                                                              vRegraCriaContaAuto(1).cd_con_pla_destino,

                                                                                              Ddtatend,

                                                                                              vRegraCriaContaAuto(1).cd_tipo_arq_cta_envio,

                                                                                              vRegraCriaContaAuto(1).cd_desconto_inst); /*ALLS OP 35921*/

                              vSnCriouContaAutoAmb := TRUE;

                          END IF;



                          /*OP 41394*/

                          vRegraCriaContaAutoHE := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTHE(Ncdatend,v_Proced.Cd_Pro_Fat,Ddtatend); --FATURCONV-1383 - AMBS



                          IF (vRegraCriaContaAutoHE(1).cd_regra_cria_conta IS NOT NULL ) THEN

                            vSnReplicaProc := 'S';

                          END IF;

                          /*OP 41394*/



                      END IF;

                      /*OP 41394*/



                  END IF;



                  IF ( vSnCriouContaAutoAmb) THEN



                    Ncdregamb := v_Contaambu(1).cd_reg_amb;  -- PDA 190394

                    Ncdconvconta := v_Contaambu(1).cd_convenio;

                    Ncdplanconta := v_Contaambu(1).cd_con_pla;

                  ELSE

                  /*OP 35916 - regra para cria? autom?ca de conta*/

                      --ncdregamb := ncontaambu;  -- PDA 190394

                      Ncdconvconta := Ncdconv;

                      Ncdplanconta := Ncdplano;

                  END IF; /*OP 35916*/

              END IF;

              IF Ncdregamb IS NULL THEN

                RAISE Atend_Sem_Conta;

              END IF;

              /* pda 145435 - 23/03/2006 - Jose Roberto

              Alterando a verifica? da guia, retirando os cursores c_qtdexistente_amb e

              c_qtdexistente_fat para utilizar a nova fun? FNC_RETORNA_GUIA_DISPONIVEL;

              Retiradas as verifica?s nos cursores c_guia, c_itguia e c_itguia_proc_auto;

              Retirado o uso das vari?is totallancado e nqtautorizado;

              Caso NCDGUIA for Nulo, chamando a fun? F_GRAVA_GUIA, alterando o terceiro

              par?tro para nqtprofat;

              Retirado todo o c?ulo feito para atribuir valor as vari?is nqtpart,

              nqtconv e limite;

              Caso retorne uma Guia dispon?l, atribu?a ?ari?l NCDGUIA.         */

              IF Ctpproibicao = 'AG' THEN

                Ncdguia := Dbamv.Pkg_Ffcv_Guia.Fnc_Retorna_Guia_Disponivel(Nvl(Ncdatenpai,

                                                                               Ncdatend), -- PDA 190394

                                                                           Ncdregamb,

                                                                           NULL,

                                                                           v_Proced.Cd_Pro_Fat,

                                                                           v_Proced.Qt_Lancada,

                                                                           NULL,

                                                                           NULL,

                                                                           Nguiapendente);

                IF Nvl(Vsnguiaprocauto, 'N') = 'S' THEN

                  IF Ncdguia IS NULL THEN

                    Ncdguia := Dbamv.f_Grava_Guia(Nvl(Ncdatenpai, Ncdatend), -- PDA 190394

                                                  Ncdconvconta,

                                                  v_Proced.Qt_Lancada,

                                                  v_Proced.Cd_Pro_Fat,

                                                  'P');

                  END IF;

                END IF;

              END IF;

              -- pda 145435 (Fim)

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Forapre(Ncdconvconta,

                                                   v_Proced.Cd_Gru_Fat);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Forapre

                INTO v_Forapre;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Forapre;

              IF v_Forapre.Sn_Prestador = 'S' THEN

                Nprestador := Ncodprest;

                Ccdatimed  := Cclinico;

              ELSE

                Nprestador := NULL;

                Ccdatimed  := NULL;

              END IF;

              IF Nprestador IS NOT NULL THEN

                --   PDA 100970(Inicio) 26/07/2006 Thiago Holder Marcos Silva

                --   Chamada da fun? dbamv.pkg_ffcv_it_conta.fnc_retorna_tp_pagamento();

                --   Esta fun? tamb?verifica se o prestador credenciado tem alguma exce?,

                --   caso tenha, o tipo de pagamento P - Produ?

                --

                --   OPEN dbamv.pack_lanca_ffcv.c_prescon (nprestador, ncdconvconta);

                --   FETCH dbamv.pack_lanca_ffcv.c_prescon INTO csnpgconv;

                --   CLOSE dbamv.pack_lanca_ffcv.c_prescon;

                Ctppgto := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Retorna_Tp_Pagamento(Nprestador,

                                                                            Ncdconvconta,

                                                                            Ctpatend,

                                                                            v_Proced.Cd_Pro_Fat,

                                                                            Ncdorigem

                                                                            -- PDA 166691 (Inicio) - Henrique Antunes - 28/11/2006

                                                                           ,

                                                                            Ddtatend,

                                                                            Dhratend

                                                                            -- PDA 166691 (Fim)

																			--FATURCONV-1726 INI

																			,Ncdplanconta

																			,vRregra.cd_regra

																			,vProced.Cd_Gru_Pro

																			--FATURCONV-1726 FIM

                                                                            );

              ELSE

                Csnpgconv := NULL;

                Ctppgto   := NULL; -- 'P' ; -- ( pda 84408  setado de null p/ 'P') -- pda 104455 desfazer o que foi feito no pda 84408

              END IF;

              --   PDA 100970(Fim)

              -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              IF Ctpproibicao = 'AG' THEN

                Csnguia := 'S';

              END IF;

              -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

              -- Prepara? da data que ser?assada na fun?.

              -- A data preparada ir?onter al?da data de lan?ento, a hora de lan?ento.

              Ddthraux := To_Date(To_Char(Ddtatend, 'DD/MM/YYYY') || ' ' ||

                                  To_Char(Nvl(Dhratend, Ddtatend),

                                          'HH24:MI:SS'),

                                  'DD/MM/YYYY HH24:MI:SS');

              -- PDA 221500 (Fim)

              /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

              nQtExcedeu a vari?l retorna justamente a quantidade de procedimentos que deve ser lan?o no procedimento

              que pertence ao pacote, em seguida deve ser inserdio um outro procedimento com o que restou do lan?ento*/

              Nqtexcedeu := NULL;

              --

              /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

              vTpContaPart a vari?l retorna justamente se o procedimento vai ser inserido em uma conta particular ou ira seguir

              o processo normalmente.*/

              Ncdpacote := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Gera_Pacote(Ncdatend,

                                                                   Ctpatend,

                                                                   Ncdconvconta,

                                                                   Ncdplanconta

                                                                   --,ncdregfat

                                                                  ,

                                                                   Ncdregamb /*PDA 466871 - passando o parametro correto de conta*/,

                                                                   v_Proced.Cd_Gru_Fat,

                                                                   v_Proced.Cd_Pro_Fat,

                                                                   Nsetor,

                                                                   Nprestador

                                                                   -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

                                                                   -- ,sysdate

                                                                  ,

                                                                   Nvl(Ddthraux,

                                                                       SYSDATE)

                                                                   -- PDA 221500 (Fim)

                                                                  ,

                                                                   Ncdatend,

                                                                   NULL,

                                                                   'Atendimento',

                                                                   Csnguia,

                                                                   v_Proced.Qt_Lancada,

                                                                   Csnpacote,

                                                                   Nqtexcedeu -- OP 387

                                                                  ,

                                                                   Vtpcontapart -- OP 387

                                                                  ,

                                                                   NULL

                                                                   -- PDA 225086 (Inicio)

                                                                  ,

                                                                   Ncdatend,

                                                                   NULL --pCdProFatPacote

                                                                  ,

                                                                   Ncdlcto --pCdLancamento_pac

                                                                  ,

                                                                   NULL); --preserva

              -- PDA 225086 (fim)

              /* pda 481126 - depois da FNC_GERA_PACOTE regravando o cd_lancamento_pac */

              IF Ctpatend NOT IN ('A', 'E', 'U') THEN

                OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncdregfat);

                FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                  INTO Ncdlcto;

                CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

              ELSE

                OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Ncdregamb);

                FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                  INTO Ncdlcto;

                CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;

              END IF;

              --

              IF Ncdpacote IS NOT NULL THEN

                UPDATE Dbamv.Conta_Pacote

                   SET Cd_Lancamento_Pac = Ncdlcto

                 WHERE Cd_Conta_Pacote = Ncdpacote;

              END IF;

              /* pda 481126 - fim */

              /*OPEN dbamv.pack_lanca_ffcv.c_pacote (ncdatend, ncdregamb);

              FETCH dbamv.pack_lanca_ffcv.c_pacote INTO csnpacote;

              CLOSE dbamv.pack_lanca_ffcv.c_pacote;*/

              -- PDA 157145 (Fim)

              -- pda 87132 - 07/01/2004 - Amalia Ara??

              OPEN Csessao;

              FETCH Csessao

                INTO Vsessao;

              IF Csessao%FOUND THEN

                Dsessao := Trunc(SYSDATE);

              ELSE

                Dsessao := NULL;

              END IF;

              CLOSE Csessao;

              -- pda 87132 - fim

              IF Dbamv.Pack_Lanca_Ffcv.Is_Hor_Esp(Ncdconvconta,

                                                  Ncdplanconta,

                                                  Ctpatend,

                                                  Ddtatend,

                                                  Dhratend,

                                                  v_Proced.Cd_Gru_Fat,

                                                  v_Proced.Cd_Pro_Fat

                                                  -- PDA 119427 11/04/2005 Henrique Antunes (In?o)

                                                  -- Passar NULL para o par?tro de regra

                                                 ,

                                                  NULL

                                                  -- PDA 119427 (FIM)

                                                 , --PDA 108041 / 108039 12/11/2004 Sp?ola (INICIO)

                                                  --Inserido o paremetro cd_prestador / cd_setor para permitir exce?s de convenios e planos por prestador

                                                  Nprestador,

                                                  Nsetor --PDA 108041 / 108039 (FIM)

                                                  ) THEN

                Csnhoresp := 'S';

              ELSE

                Csnhoresp := 'N';

              END IF;

              /* PDA 284736 - 04/05/2009 - In?o - Fabr?o Oliveira de Miranda */

              DECLARE

                Vcdlanc Dbamv.Itreg_Amb.Cd_Lancamento%TYPE := 0;

                /* Cursor para identificar se o lan?ento j?xiste. */

                CURSOR c_Existelanc IS

                  SELECT Cd_Lancamento

                    FROM Dbamv.Itreg_Amb

                   WHERE Cd_Reg_Amb = Ncdregamb

                     AND Cd_Lancamento = Ncdlcto;

              BEGIN

                /* Verifica se o lan?ento j?xiste.

                Verifica uma S??z, pois a vari?l ncdlcto j?avia sido alimentada com

                o maior lan?ento atual + 1. */

                OPEN c_Existelanc;

                FETCH c_Existelanc

                  INTO Vcdlanc;

                CLOSE c_Existelanc;

                /* Se existir o cd_lancamento na conta, incrementa mais um, pois ocorreu este erro

                no cliente 755 e n?conseguiu-se reproduzir, portanto, apenas ser?revenido. */

                IF Vcdlanc <> 0 THEN

                  Ncdlcto := Ncdlcto + 1;

                END IF;

              END;

              /* PDA 284736 - 04/05/2009 - In?o - Fabr?o Oliveira de Miranda */

              /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

              que o procedimento que ira ser inserido abaixo pertence a um pacote, e a qunatidade que sera inserida sera menor que a lan?a, a diferen?

              sera lan?a na rotina mais abaixo atravez da procedure PRC_DESVINCULA_PROCEDIMENTO*/

              /* Fazendo tratamento caso o procedimento esteja configurado no gabarito para ser inserido dentro de uma conta particular

              caso a variavel vTpContaPart esteja preenchida e a quantidade de lan?ento extra esteja nula. com iso deve ser procurado uma conta particular

              e um lan?ento para inseririr nesta conta.*/

              Ncontapart := NULL;

              Nlanc      := NULL;

				/*43289 - quebra de conta por quantidade de procedimento por atendimento*/

				/*A regra de pacote tem prioridade sobre essa regra, conforme vari?l Nqtexcedeu abaixo*/

				IF Nqtexcedeu IS NULL THEN

					if (not vSnCriouContaAutoAmb) then /*OP 46768*/

						  IF DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_EXISTE_CONF_QTD_ATEND_PAC(Nvl(ncdatenpai, ncdatend),

																							 v_proced.cd_pro_fat,

																							 pEmpresa) THEN



							  Nqtexcedeu := DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_RETORNA_QTD_LANC_PERIODO(Nvl(ncdatenpai, ncdatend),

																										   v_proced.cd_pro_fat,

																										   pEmpresa,

																										   ncdregamb,

																										   v_proced.qt_lancada,

																										   pSnChamadoDaTela,

																										   pvSnJaExcedeuQtd,

																										   pvMensagem

																										   );

							  IF pvSnJaExcedeuQtd = 'S' THEN

								  Vtpcontapart := 'ProcPorAtend';

								  Nqtexcedeu   := NULL;

							  ELSE

									IF NVL(Nqtexcedeu,0) > 0 THEN

										Vtpcontapart := 'ProcPorAtend';

									END IF;

							  END IF;

						END IF;

					END IF;/*OP 46768*/

			    END IF;

				/*43289*/



              IF Nvl(Vtpcontapart, 'X') <> 'X' AND Nqtexcedeu IS NULL THEN

                Ncontapart := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(Nvl(Ncdatenpai,

                                                                             Ncdatend));

                OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Ncontapart);

                FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                  INTO Nlanc;

                CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;

              END IF;

              INSERT INTO Dbamv.Itreg_Amb

                (Cd_Reg_Amb,

                 Cd_Lancamento,

                 Hr_Lancamento,

                 Qt_Lancamento,

                 Cd_Gru_Fat,

                 Cd_Pro_Fat,

                 Cd_Atendimento,

                 Cd_Con_Pla,

                 Cd_Convenio,

                 Sn_Fatura_Impressa,

                 Sn_Fechada,

                 Sn_Conta_Calculada,

                 Cd_Guia,

                 Sn_Pertence_Pacote,

                 Vl_Percentual_Multipla,

                 Cd_Setor,

                 Cd_Setor_Produziu,

                 Cd_Prestador,

                 Cd_Ati_Med,

                 Tp_Pagamento,

                 Sn_Horario_Especial,

                 Cd_Usuario,

                 Cd_Mvto,

                 Dt_Sessao, -- pda 87132 - 07/01/2004 - Amalia Ara??

                 Tp_Mvto

                 -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                ,

                 Cd_Conta_Pacote

                 -- PDA 157145 (Fim)

                 )

              VALUES

                (Nvl(ncontapart, ncdregamb) /* OP 43289 (Nvl(Nconta, Ncdregamb)) -- OP 387 */

                ,

                 Nvl(Nlanc, Ncdlcto) -- OP 387

                ,

                 Dhratend,

                 Nvl(Nqtexcedeu, v_Proced.Qt_Lancada) -- OP 387

                ,

                 v_Proced.Cd_Gru_Fat,

                 v_Proced.Cd_Pro_Fat,

                 Nvl(Ncdatenpai, Ncdatend) -- PDA 190394

                ,

                 Ncdplanconta,

                 Ncdconvconta,

                 'N',

                 'N',

                 'N',

                 Ncdguia,

                 Nvl(Csnpacote, 'N'),

                 100,

                 Nsetor,

                 Nsetor,

                 Nprestador,

                 Ccdatimed,

                 Ctppgto,

                 Csnhoresp,

                 USER,

                 Nvl(Ncdatenpai, Ncdatend) -- PDA 190394

                ,

                 Dsessao, -- pda 87132 - 07/01/2004 - Amalia Ara??

                 Nvl(Vtpcontapart, 'Atendimento') -- OP 387

                 -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

                ,

                 Ncdpacote

                 -- PDA 157145 (Fim)

                 );





              /*OP 42241 - Caso tenha criado a conta por cargo paciente, devemos lan? o item para o convenio, plano, percentual definido na configura

              de quebra de conta por cargo paciente*/

              IF (vSnCriouContaAutoAmbCP) THEN

                   OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(v_ContaCargoPacAmbu(1).cd_reg_amb);

                   FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                      INTO NcdlctoAmbCp;

                   CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;



                   INSERT INTO Dbamv.Itreg_Amb

                    (Cd_Reg_Amb,

                     Cd_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Cd_Atendimento,

                     Cd_Con_Pla,

                     Cd_Convenio,

                     Sn_Fatura_Impressa,

                     Sn_Fechada,

                     Sn_Conta_Calculada,

                     Cd_Guia,

                     Sn_Pertence_Pacote,

                     Cd_Prestador,

                     Cd_Ati_Med,

                     Tp_Pagamento,

                     Vl_Percentual_Multipla,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto,

                     Dt_Sessao

                     )

                  VALUES

                    (v_ContaCargoPacAmbu(1).cd_reg_amb,

                     NcdlctoAmbCp,

                     Dhratend,

                     Nvl(Nqtexcedeu, v_Proced.Qt_Lancada),

                     v_Proced.Cd_Gru_Fat,

                     v_Proced.Cd_Pro_Fat,

                     Nvl(Ncdatenpai, Ncdatend),

                     vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                     vRegraCriaContaAutoCP(1).cd_convenio_destino,

                     'N',

                     'N',

                     'N',

                     Ncdguia,

                     'N',

                     Nprestador,

                     Ccdatimed,

                     Ctppgto,

                     vRegraCriaContaAutoCP(1).vl_percentual_carga_familiar,

                     Nsetor,

                     Nsetor,

                     'N',

                     USER,

                     Nvl(Ncdatenpai, Ncdatend),

                     Nvl(Vtpcontapart, 'Atendimento'),

                     Dsessao

                     );

              END IF;

              /*OP 42241*/



              /*OP 41394 - replicar horario especial no lan?ento autom?co. Incialmente implementa? pro cliente HOSCAR*/

              IF (nvl(Csnhoresp,'N') = 'S'

                  AND (NOT vSnCriouContaAutoAmb) /*n??m item de regra de quebra de conta autom?ca*/

                  AND vSnReplicaProc = 'S' )  /*tem regra pra replicar proc de hor?o especial*/

                  THEN



                  OPEN cProced(v_Proced.Cd_Pro_Fat);

                  FETCH cProced INTO vProced;

                  CLOSE cProced;



                  OPEN cRregra(Ncdconvconta,Ncdplanconta);

                  FETCH cRregra INTO vRregra;

                  CLOSE cRregra;



                  vNlsBanco := dbamv.FNC_FFCV_FIRST_DAY_SEMANA_BR('S',null);

                  OPEN dbamv.pack_lanca_ffcv.cSnReplicaProcHe(vRregra.cd_regra,

                                                              vProced.cd_gru_pro,

                                                              v_Proced.Cd_Pro_Fat,

                                                              TO_NUMBER(TO_CHAR(Ddtatend, 'd')),

                                                              Dhratend,

                                                              Ctpatend);

                  FETCH dbamv.pack_lanca_ffcv.cSnReplicaProcHe INTO vSnReplicaProcHe;

                  CLOSE dbamv.pack_lanca_ffcv.cSnReplicaProcHe;

                  vNlsBanco := dbamv.FNC_FFCV_FIRST_DAY_SEMANA_BR('N',vNlsBanco);



                  IF Nvl(vSnReplicaProcHe.sn_replica_proc,'N') = 'S' THEN



                      dbamv.prc_ffcv_replica_proc_he(Nvl(Nconta, Ncdregamb),      -- pCdConta IN NUMBER ,

                                                  Nvl(Nlanc, Ncdlcto),            --pCdLancConta IN NUMBER ,

                                                  'A',                            --pTpAtend     IN VARCHAR2,

                                                  vSnReplicaProcHe.vl_percentual, --pVlPercent   IN NUMBER DEFAULT null,

                                                  'N'                             --pSnInsereConta IN VARCHAR2

                                                  );



                      dbamv.prc_ffcv_replica_proc_he(Nvl(Nconta, Ncdregamb),

                                                  Nvl(Nlanc, Ncdlcto),

                                                  'A',

                                                  null,

                                                  'S');

                  END IF;

              END IF;

              /*OP 41394*/



              /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

              que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

              os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

              IF Nqtexcedeu IS NOT NULL THEN

                Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregamb,

                                                                    Ncdlcto,

                                                                    (v_Proced.Qt_Lancada -

                                                                    Nqtexcedeu),

                                                                    Vtpcontapart,

                                                                    Dhratend,

																	nvl(ncdatenpai,

                                                                    ncdatend)); /*ALLS OP 43289*/

              END IF;

              /* OP 387 - Thiago Miranda de oliveira - este trecho de c??o somente sera utilizado se a configura? de gerar o item em conta de particular

              por causa do pacote, n?estiver preenchido*/

              IF Nvl(Vtpcontapart, 'X') = 'X' THEN

                -- PDA 197953 (In?o) - 08/08/2007 - Diego Costa

                -- inclus?de verifica? a regra de atendimento pro_fat antes da regra de acoplamaneto

                IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Ambu(Ncdregamb,

                                                              Ncdlcto,

                                                              'I') THEN

                  IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Ambu(Ncdregamb,

                                                                Ncdlcto,

                                                                'I') THEN

                    Verif_Franquia_Ambu(Ncdregamb, Ncdlcto, 'I');

                  END IF;

                END IF;

                -- PDa 197953 (Fim)

              END IF;

              --



              -- PDA 101961 (Inicio) - 17/09/2004 - Pollyane Kely Alves Nunes

              -- inclus?do lan?ento dos valores relacionados na procedure



              -- /* Lancamento dos Valores Relacionados */ --

              DECLARE

                CURSOR c_Relacionados IS

                  SELECT Rela.Cd_Pro_Fat,

                         Rela.Tp_Atend_Homecare,

                         Rela.Tp_Atend_Externo,

                         Rela.Tp_Atend_Urgeme,

                         Rela.Tp_Atend_Ambulatorial,

                         Rela.Tp_Atend_Internacao

                         --PDA 108042 22/11/2004 Sp?ola (INICIO)

                         --Inserida a coluna qt_lancamento que ir?ultiplicar a quantidade na rotina Dbamv.lanca_ffcv_pro_relacionados

                        ,

                         Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

                  --PDA 108042 (FIM)

                    FROM Dbamv.Con_Pla,

                         Dbamv.Regra,

                         Dbamv.Val_Pro_Relacionado Rela,

                         Dbamv.Empresa_Con_Pla /* PDA 118607/131598 */

                        ,dbamv.pro_fat             -- OP 32555 *2

                   WHERE Empresa_Con_Pla.Cd_Convenio = Con_Pla.Cd_Convenio /* PDA 118607/131598 */

                     AND Empresa_Con_Pla.Cd_Con_Pla = Con_Pla.Cd_Con_Pla /* PDA 118607/131598 */

                     AND Empresa_Con_Pla.Cd_Multi_Empresa =

                         Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/131598 */



					 -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

                     --AND Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat

					 and ( ( rela.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = rela.cd_pro_fat and Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					    or ( rela.cd_pro_fat_pai is null and rela.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                             AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

					     )

				     -- OP 32555 - fim



                     AND Con_Pla.Cd_Convenio = Ncdconvconta

                     AND Con_Pla.Cd_Con_Pla = Ncdplanconta

                     AND Rela.Tp_Lancamento = 'A'

                        --PDA 114239 17/01/2005 Sp?ola (INICIO)

                        --Incluida verifica? por tipo de atendimento para os procedimentos relacionados

                     AND ((Ctpatend = 'H' AND Rela.Tp_Atend_Homecare = 'S') OR

                         (Ctpatend = 'E' AND Rela.Tp_Atend_Externo = 'S') OR

                         (Ctpatend = 'U' AND Rela.Tp_Atend_Urgeme = 'S') OR

                         (Ctpatend = 'A' AND

                         Rela.Tp_Atend_Ambulatorial = 'S') OR

                         (Ctpatend = 'I' AND

                         Rela.Tp_Atend_Internacao = 'S'))

                        --PDA 114239 (FIM)

                     AND Con_Pla.Cd_Regra = Regra.Cd_Regra

                     AND Rela.Cd_Regra = Regra.Cd_Regra

                     AND Rela.Dt_Vigencia IN

                         (SELECT MAX(Vpr.Dt_Vigencia)

                            FROM Dbamv.Val_Pro_Relacionado Vpr

                           WHERE Vpr.Dt_Vigencia <= Ddtatend

                             AND Vpr.Cd_Regra = Rela.Cd_Regra

                             -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

					         -- AND Vpr.Cd_Pro_Fat_Pai = Rela.Cd_Pro_Fat_Pai

					         -- AND Vpr.Cd_Pro_Fat = Rela.Cd_Pro_Fat

					         and ( ( Vpr.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = Vpr.cd_pro_fat and Vpr.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					            or ( Vpr.cd_pro_fat_pai is null and Vpr.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                                     AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

						          )

						     -- OP 32555 - fim

							 );

                -- PDA 105921 - (Fim)

                Cretorno VARCHAR2(1);

                --

              BEGIN

                FOR Rec_Rela IN c_Relacionados

                LOOP

                  -- PDA 127019 (In?o) - 12/07/2005 - Pollyane Kely Alves Nunes

                  -- If criado para barrar o lan?ento autom?co, em atendimentos ambulatoriais,

                  -- de procedimentos do atendimento do grupo de procedimento do tipo

                  -- SP - Servi? Profissionais com algumas excesS??

                  OPEN Cgrupo(Rec_Rela.Cd_Pro_Fat);

                  FETCH Cgrupo

                    INTO Vtpgrupro;

                  CLOSE Cgrupo;

                  -- Se n?for retorno ou se for os hospitais 406 e 303 lan?tudo

                  IF (Nvl(Vsnretorno, 'N') = 'N' OR

                     (To_Number(Nvl(Vcdhospital, '0')) IN (406, 303))) OR -- Se for o hospital 375 para atendimentos de retorno S??oibe os c??os 00010014 e 00010073

                     (Nvl(Vsnretorno, 'N') = 'S' AND

                     To_Number(Nvl(Vcdhospital, '0')) IN (375) AND

                     Rec_Rela.Cd_Pro_Fat NOT IN ('00010014', '00010073')) OR -- Se for retorno n?lan?procedimentos do grupo SP para os demais hospitais

                     (Nvl(Vsnretorno, 'N') = 'S' AND Vtpgrupro <> 'SP' AND

                     To_Number(Nvl(Vcdhospital, '0')) NOT IN

                     (303, 375, 406)) THEN

                    -- PDA 127019 (Fim)

                    Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(Nvl(Ncdatenpai,

                                                                      Ncdatend) --PDA 190394

                                                                 ,

                                                                  Ncdregamb,

                                                                  Ncdlcto,

                                                                  Ncdimportatend,

                                                                  v_Proced.Cd_Pro_Fat,

                                                                  Ddtatend,

                                                                  Dhratend,

                                                                  Nsetor,

                                                                  'P',

                                                                  Ctpatend,

                                                                  Ddtatend,

                                                                  Ncdconvconta, --V_Conta.cd_convenio    ,

                                                                  Ncdplanconta /*  ncdconvconta    pda 131200  */, --V_Conta.Cd_con_pla     ,

                                                                  NULL

                                                                  /*nCd_atendimento_pai*/,

                                                                  v_Tp_Convenio,

                                                                  NULL,

                                                                  Rec_Rela.Cd_Pro_Fat, --PDA 108042 22/11/2004 Sp?ola (INICIO)

                                                                  --As quantidades lan?a ser?ultiplicadas pelo fator de quantidade qt_lancamento

                                                                  Rec_Rela.Qt_Lancamento *

                                                                  v_Proced.Qt_Lancada, --PDA 108042 (FIM)

                                                                  0,

                                                                  'I'

                                                                  --PDA 108070 29/12/2004 Sp?ola (INICIO)

                                                                  --Inserido o campo do prestador que ser?tilizado apenas para os procedimentos relacionados de ambulatorio

                                                                  --lancadados pela prc_ffcv_lanca_atendimento - lancamento automatico do procedimento principal na criacao do atendimento

                                                                 ,

                                                                  NULL --cd_prestador

                                                                  --PDA 108070 (FIM)

                                                                  -- pda 119975 - 29/05/2005 - Amalia Ara??

                                                                  -- par?tro de fator relacionado para insert nas tabelas itreg_amb e itreg_fat

                                                                 ,

                                                                  Rec_Rela.Qt_Lancamento

                                                                  -- pda 119975 - fim

                                                                  );

                  END IF; --PDA 127019  - Fim da condi? para atendimentos de retorno

                END LOOP;

              END;

              -- PDA 101961 (Fim)

            END IF;

            -- PDA 127019 (In?o) - 12/07/2005 - Pollyane Kely Alves Nunes

            -- Fim do if para as restri?s de lan?entos para contas de atendimentos de retorno.

          END IF;

          -- PDA 127019 (Fim)

        END LOOP;

      END IF;

      -- Inicio PDA 120693 - 22/04/05 ELias

      -- S??z a leitura do primeiro registro e sai, porque pode haver mais

      -- de um registro com a mesma configura?.

      EXIT;

      -- FIm PDA 120693

    END LOOP;

    --PDA 108037 10/12/2004 Sp?ola (INICIO)

    --Lanca o procedimento principal na conta

    DECLARE

      CURSOR Catendimento(Pnatend IN NUMBER) IS

        SELECT --nvl(cd_atendimento, nCdAtenPai) cd_atendimento --PDA 190394 -- PDA 232394

         Nvl(Cd_Atendimento_Pai, Cd_Atendimento) Cd_Atendimento -- PDA 232394

        ,

         Tp_Atendimento,

         Cd_Convenio,

         Cd_Con_Pla,

         Cd_Ori_Ate,

         Dt_Atendimento,

         Hr_Atendimento,

         Cd_Prestador,

         Cd_Pro_Int

          FROM Dbamv.Atendime

         WHERE Cd_Atendimento = Pnatend

           AND Cd_Pro_Int IS NOT NULL

           AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

      -- OP 8299 - 28/05/2013 - Procedimentos do atendimento lan?os na tela de atendimento ambulatorial

      CURSOR Catendimeproc(Pnatend IN NUMBER) IS

        SELECT Nvl(Atendime.Cd_Atendimento_Pai, Atendime.Cd_Atendimento) Cd_Atendimento,

               Atendime.Tp_Atendimento,

               Atendime.Cd_Convenio,

               Atendime.Cd_Con_Pla,

               Atendime.Cd_Ori_Ate,

               Atendime.Dt_Atendimento,

               Atendime.Hr_Atendimento,

               Atendime.Cd_Prestador,

               Atendime_Pro.Cd_Pro_Int,

               Atendime_Pro.Nr_Quantidade

          FROM Dbamv.Atendime,

               Dbamv.Atendime_Procedimento Atendime_Pro

         WHERE Atendime.Cd_Atendimento = Pnatend

              --AND atendime.cd_pro_int IS NOT NULL

           AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

           AND Atendime_Pro.Cd_Atendimento = Atendime.Cd_Atendimento;

      CURSOR Clancaproc(Ppro IN VARCHAR2) IS

        SELECT Pro_Fat.Sn_Lanca_Pro_Fat_Atend

          FROM Dbamv.Pro_Fat

         WHERE Pro_Fat.Cd_Pro_Fat = Ppro

           AND Upper(Pro_Fat.Sn_Lanca_Pro_Fat_Atend) = 'S';

      CURSOR Cconfffcv IS

        SELECT Nvl(Sn_Lanca_Atendime_Auto, 'N') Sn_Lanca_Atendime_Auto

          FROM Dbamv.Config_Ffcv

         WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

      Vcatendimento Catendimento%ROWTYPE;

      Vclancaproc   Clancaproc%ROWTYPE;

      Vcconfffcv    Cconfffcv%ROWTYPE;

      Nconta        Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*NUMBER PDA 254997*/

      ;

    BEGIN

      OPEN Cconfffcv;

      FETCH Cconfffcv

        INTO Vcconfffcv;

      IF Cconfffcv%FOUND THEN

        CLOSE Cconfffcv;

        OPEN Catendimento(Ncdatend);

        FETCH Catendimento

          INTO Vcatendimento;

        -- PDA 208490 (Inicio) - Henrique Antunes - 27/12/2007

        OPEN Cgrupo(Vcatendimento.Cd_Pro_Int);

        FETCH Cgrupo

          INTO Vtpgrupro;

        CLOSE Cgrupo;

        IF (Nvl(Vsnretorno, 'N') = 'N' OR

           (To_Number(Nvl(Vcdhospital, '0')) IN (406, 303))) OR -- Se for o hospital 375 para atendimentos de retorno S??oibe os c??os 00010014 e 00010073

           (Nvl(Vsnretorno, 'N') = 'S' AND

           To_Number(Nvl(Vcdhospital, '0')) IN (375) AND

           v_Proced.Cd_Pro_Fat NOT IN ('00010014', '00010073')) OR -- Se for retorno n?lan?procedimentos do grupo SP para os demais hospitais

           (Nvl(Vsnretorno, 'N') = 'S' AND Vtpgrupro <> 'SP' AND

           To_Number(Nvl(Vcdhospital, '0')) NOT IN (303, 375, 406)) THEN

          -- PDA 208490 (Fim)

          IF Catendimento%FOUND THEN

            CLOSE Catendimento;

            OPEN Clancaproc(Vcatendimento.Cd_Pro_Int);

            FETCH Clancaproc

              INTO Vclancaproc;

            --Caso o grupo de procedimento seja SD n?dever?er lan?o o procedimeno no momento da cria? do atendimento

            IF Clancaproc%FOUND THEN

              CLOSE Clancaproc;

              IF Vcatendimento.Tp_Atendimento IN ('I', 'A', 'E', 'U', 'H') THEN

                IF Vcatendimento.Tp_Atendimento in ('I', 'H') THEN

                  Nconta := Ncdregfat;

                ELSE

                  Nconta := Ncdregamb;

                END IF;

                -- pda 131200 - 29/08/2005 - Amalia Ara??

                -- Jogando NULL no ??mo par?tro da prc_ffcv_lanca_atendime, porque se o

                -- ??mo procedimento do atendimento for lan?o na conta particular/extra,

                -- o par?tro estava indo com a conta/lote do convenio errado.

                IF Vcconfffcv.Sn_Lanca_Atendime_Auto = 'T' THEN





                  Dbamv.Pack_Aux_Ffcv.Prc_Ffcv_Lanca_Atendime(Vcatendimento.Cd_Atendimento,

                                                              Vcatendimento.Tp_Atendimento,

                                                              Vcatendimento.Cd_Convenio,

                                                              Vcatendimento.Cd_Con_Pla,

                                                              Vcatendimento.Cd_Ori_Ate,

                                                              Vcatendimento.Dt_Atendimento,

                                                              Vcatendimento.Hr_Atendimento,

                                                              Vcatendimento.Cd_Prestador,

                                                              Nsetor,

                                                              Vcatendimento.Cd_Pro_Int,

                                                              NULL); -- ,nconta);  -- pda 131200

                ELSIF Vcconfffcv.Sn_Lanca_Atendime_Auto = 'H' AND

                      Vcatendimento.Tp_Atendimento in ('I', 'H') THEN

                  Dbamv.Pack_Aux_Ffcv.Prc_Ffcv_Lanca_Atendime(Vcatendimento.Cd_Atendimento,

                                                              Vcatendimento.Tp_Atendimento,

                                                              Vcatendimento.Cd_Convenio,

                                                              Vcatendimento.Cd_Con_Pla,

                                                              Vcatendimento.Cd_Ori_Ate,

                                                              Vcatendimento.Dt_Atendimento,

                                                              Vcatendimento.Hr_Atendimento,

                                                              Vcatendimento.Cd_Prestador,

                                                              Nsetor,

                                                              Vcatendimento.Cd_Pro_Int,

                                                              NULL); -- ,nconta);  -- pda 131200

                ELSIF Vcconfffcv.Sn_Lanca_Atendime_Auto = 'A' AND

                      Vcatendimento.Tp_Atendimento IN ('A', 'U', 'E') THEN

                  Dbamv.Pack_Aux_Ffcv.Prc_Ffcv_Lanca_Atendime(Vcatendimento.Cd_Atendimento,

                                                              Vcatendimento.Tp_Atendimento,

                                                              Vcatendimento.Cd_Convenio,

                                                              Vcatendimento.Cd_Con_Pla,

                                                              Vcatendimento.Cd_Ori_Ate,

                                                              Vcatendimento.Dt_Atendimento,

                                                              Vcatendimento.Hr_Atendimento,

                                                              Vcatendimento.Cd_Prestador,

                                                              Nsetor,

                                                              Vcatendimento.Cd_Pro_Int,

                                                              NULL); -- ,nconta);  -- pda 131200

                END IF;

                -- pda 131200 - fim

              END IF;

            ELSE

              CLOSE Clancaproc;

            END IF;

          ELSE

            CLOSE Catendimento;

          END IF;

        END IF; -- PDA 208490

      ELSE

        CLOSE Cconfffcv;

      END IF;

      -- OP 8299 - Loop para lan? na conta os itens informados na tela de atendimento ambulatorial - ATEURG - na tabela dbamv.atendime_procedimento

      -- A diferen?para o lan?ento do principal ?ue n?ser?erificada a configura? se lan?o procedimento do atendimento. Por isso est?ora do IF acima.

      FOR v IN Catendimeproc(Ncdatend)

      LOOP

        IF v.Tp_Atendimento IN ('A', 'U', 'E') THEN

          Dbamv.Pack_Aux_Ffcv.Prc_Ffcv_Lanca_Atendime(v.Cd_Atendimento,

                                                      v.Tp_Atendimento,

                                                      v.Cd_Convenio,

                                                      v.Cd_Con_Pla,

                                                      v.Cd_Ori_Ate,

                                                      v.Dt_Atendimento,

                                                      v.Hr_Atendimento,

                                                      v.Cd_Prestador,

                                                      Nsetor,

                                                      v.Cd_Pro_Int,

                                                      v.Nr_Quantidade -- esse par?tro n?est?endo usado, ent?passaremos a quantidade informada para lan?ento

                                                      );

        END IF;

      END LOOP;

      -- OP 8299 - fim

    END;

    --PDA 108037 (FIM)

   -- OP 40186 - Chamada da integra? Soul x Safe(Ipsemg)

   if vSnIntegracaoIpsemg = 'S' AND USER = 'DBAMV'  THEN



    dbamv.prc_ffcv_autor_atend_ipsemg (Ncdguia,null,'P',Nvl(Ncdatenpai, Ncdatend),null ,Nprestador ,Nprestador ,Nvl(Ncdatenpai, Ncdatend) ,null );

  end if ;

  EXCEPTION

    WHEN Atend_Sem_Conta THEN

      --PDA 95235 05/04/2004 Sp?ola (INICIO)

      --Modificado a forma como a excess?chava a rotina gera_log_falha

      IF Ctpatend IN ('H', 'I') THEN

        Gera_Log_Falha(Nconta,

                       NULL,

                       Ncdimportatend,

                       Ncdimportatend,

                       v_Proced.Cd_Pro_Fat,

                       'Atendimento',

                       '04'

                       --, 'Atendimento ' || ncdatend || ' n?possui conta aberta/dispon?l'

                      ,

                       Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_4',

                                                         'PACK_LANCA_FFCV',

                                                         'Atendimento %s n?possui Conta aberta/dispon?l.',



                                                         Arg_List(Ncdatend)) -- OP 10402

                      ,

                       Ctpatend,

                       Nvl(Ncdatenpai, Ncdatend) --PDA 190394

                      ,

                       TRUE,

                       Deleting,

                       Dhratend);

      ELSE

        Gera_Log_Falha(NULL,

                       Nconta,

                       Ncdimportatend,

                       Ncdimportatend,

                       v_Proced.Cd_Pro_Fat,

                       'Atendimento',

                       '04'

                       --, 'Atendimento ' || ncdatend || ' n?possui conta aberta/dispon?l'

                      ,

                       Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_4',

                                                         'PACK_LANCA_FFCV',

                                                         'Atendimento %s n?possui Conta aberta/dispon?l.',



                                                         Arg_List(Ncdatend)) -- OP 10402

                      ,

                       Ctpatend,

                       Nvl(Ncdatenpai, Ncdatend) --PDA 190394

                      ,

                       TRUE,

                       Deleting,

                       Dhratend);

      END IF;

      --PDA 95235 (FIM)

    WHEN Fora_Da_Conta THEN

      --PDA 95235 05/04/2004 Sp?ola (INICIO)

      --Modificado a forma como a excess?chava a rotina gera_log_falha

      IF Ctpatend IN ('H', 'I') THEN

        Gera_Log_Falha(Nconta,

                       NULL,

                       Ncdimportatend,

                       Ncdimportatend,

                       v_Proced.Cd_Pro_Fat,

                       'Atendimento',

                       '08'

                       --,'Procedimento com proibi? tipo Fora da Conta'

                      ,

                       Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_8',

                                                         'PACK_LANCA_FFCV',

                                                         'Procedimento com proibi? tipo Fora da Conta.',



                                                         Arg_List()) -- OP 10402

                      ,

                       Ctpatend,

                       Nvl(Ncdatenpai, Ncdatend) --PDA 190394

                      ,

                       TRUE,

                       Deleting,

                       Dhratend);

      ELSE

        Gera_Log_Falha(NULL,

                       Nconta,

                       Ncdimportatend,

                       Ncdimportatend,

                       v_Proced.Cd_Pro_Fat,

                       'Atendimento',

                       '08'

                       --,'Procedimento com proibi? tipo Fora da Conta'

                      ,

                       Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_8',

                                                         'PACK_LANCA_FFCV',

                                                         'Procedimento com proibi? tipo Fora da Conta.',



                                                         Arg_List()) -- OP 10402

                      ,

                       Ctpatend,

                       Nvl(Ncdatenpai, Ncdatend) --PDA 190394

                      ,

                       TRUE,

                       Deleting,

                       Dhratend);

      END IF;

      --PDA 95235 (FIM)

    WHEN Proc_Proibido THEN

      --PDA 95235 05/04/2004 Sp?ola (INICIO)

      --Modificado a forma como a excess?chava a rotina gera_log_falha

      IF Ctpatend IN ('H', 'I') THEN

        Gera_Log_Falha(Nconta,

                       NULL,

                       Ncdimportatend,

                       Ncdimportatend,

                       v_Proced.Cd_Pro_Fat,

                       'Atendimento',

                       '05'

                       --, 'Procedimento proibido para o Convenio ' || LTRIM (TO_CHAR (ncdconv)) || ' e Plano ' || LTRIM (TO_CHAR (ncdplano))

                      ,

                       Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_7',

                                                         'PACK_LANCA_FFCV',

                                                         'Procedimento proibido para o convenio %s e Plano %s.',

                                                         Arg_List(Ltrim(To_Char(Ncdconv)),

                                                                  Ltrim(To_Char(Ncdplano)))) -- OP 10402

                      ,

                       Ctpatend,

                       Nvl(Ncdatenpai, Ncdatend) --PDA 190394

                      ,

                       TRUE,

                       Deleting,

                       Dhratend);

      ELSE

        Gera_Log_Falha(Nconta,

                       NULL,

                       Ncdimportatend,

                       Ncdimportatend,

                       v_Proced.Cd_Pro_Fat,

                       'Atendimento',

                       '05'

                       --, 'Procedimento proibido para o Convenio ' || LTRIM (TO_CHAR (ncdconv)) || ' e Plano ' || LTRIM (TO_CHAR (ncdplano))

                      ,

                       Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_7',

                                                         'PACK_LANCA_FFCV',

                                                         'Procedimento proibido para o convenio %s e Plano %s.',

                                                         Arg_List(Ltrim(To_Char(Ncdconv)),

                                                                  Ltrim(To_Char(Ncdplano)))) -- OP 10402

                      ,

                       Ctpatend,

                       Nvl(Ncdatenpai, Ncdatend) --PDA 190394

                      ,

                       TRUE,

                       Deleting,

                       Dhratend);

      END IF;

      --PDA 95235 (FIM)

	-- OP 32555

    WHEN Proc_Proibido_idade THEN

	  -- OP 33697 - 05/10/2015 - Substituindo Gera_Log_Falha por Raise_Application_Error.

      Raise_Application_Error(-20054, Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20','PACK_LANCA_FFCV',

                                'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                Arg_List(v_Proced.Cd_Pro_Fat)));

       /* Gera_Log_Falha(Nconta,

                       NULL,

                       Ncdimportatend,

                       Ncdimportatend,

                       v_Proced.Cd_Pro_Fat,

                       'Atendimento',

                       '05',

                       Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20',

                                                         'PACK_LANCA_FFCV',

                                                         'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                                         Arg_List(v_Proced.Cd_Pro_Fat))

                      ,

                       Ctpatend,

                       Nvl(Ncdatenpai, Ncdatend) --PDA 190394

                      ,

                       TRUE,

                       Deleting,

                       Dhratend);*/

  END;



  FUNCTION Lanca_Mges_Consumo_Ffcv(Ncdproduto  IN NUMBER,

                                   Ncdconsumo  IN NUMBER,

                                   Ncdunipro   IN NUMBER,

                                   Nqtmovnew   IN NUMBER,

                                   Nqtmovold   IN NUMBER,

                                   Caction     IN VARCHAR2,

                                   Ncditemmvto IN NUMBER) RETURN VARCHAR2 IS

    CURSOR c_Importar IS

      SELECT Config_Ffcv.Sn_Estoque_Automatica,

             Config_Ffcv.Tp_Import_Mges,

             Config_Ffcv.Sn_Guia_Proc_Auto,

             Config_Ffcv.Tp_Controle_Lote /* 128810 */

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    CURSOR c_Proced IS

      SELECT Produto.Cd_Pro_Fat,

             Produto.Cd_Classe,

             Produto.Cd_Especie,

			 Produto.Cd_produto,

			 Produto.Cd_sub_cla,

             Nvl(Produto.Vl_Fator_Pro_Fat, 1) Vl_Fator_Pro_Fat

        FROM Dbamv.Produto

       WHERE Produto.Cd_Produto = Ncdproduto

         AND EXISTS

       (SELECT Empresa_Produto.Cd_Produto

                FROM Dbamv.Empresa_Produto

               WHERE Cd_Multi_Empresa = Pkg_Mv2000.Le_Empresa

                 AND Empresa_Produto.Cd_Produto = Produto.Cd_Produto); -- PDA 118607/125883

    -- OP 5830 - 21/03/2013 - alterando mascara dos campos de data para considerar tamb?os segundos

    CURSOR c_Mvto IS

      SELECT Consumo_Paciente.Cd_Atendimento

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- ,consumo_paciente.dt_consumo_paciente dt_mvto_estoque

            ,

             To_Date(To_Char(Consumo_Paciente.Dt_Consumo_Paciente,

                             'dd/mm/yyyy') ||

                     To_Char(Consumo_Paciente.Hr_Consumo_Paciente,

                             'hh24:mi:ss'),

                     'dd/mm/yyyy hh24:mi:ss') Dt_Mvto_Estoque

             -- PDA 229502 (Fim)

            ,

             Consumo_Paciente.Hr_Consumo_Paciente Hr_Mvto_Estoque,

             Consumo_Paciente.Cd_Setor,

             Atendime.Tp_Atendimento,

             Atendime.Cd_Convenio,

             Atendime.Cd_Con_Pla,

             Atendime.Cd_Atendimento_Pai,

             Convenio.Tp_Convenio

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- ,atendime.dt_alta

            ,

             To_Date(To_Char(Atendime.Dt_Alta, 'dd/mm/yyyy') ||

                     To_Char(Atendime.Hr_Alta, 'hh24:mi:ss'),

                     'dd/mm/yyyy hh24:mi:ss') Dt_Alta

             -- PDA 229502 (Fim)

            ,

             Atendime.Cd_Convenio_Secundario,

             Atendime.Cd_Con_Pla_Secundario

             -- PDA 229502 (In?o) - 21/05/2008 - Diego Costa

             -- atendime.dt_atendimento

            ,

             To_Date(To_Char(Atendime.Dt_Atendimento, 'DD/MM/YYYY') || ' ' ||

                     To_Char(Atendime.Hr_Atendimento, 'HH24:Mi:SS'),

                     'DD/MM/YYYY HH24:MI:SS') Dt_Atendimento

             -- PDA 229502 (Fim)

            ,

             Atendime.Hr_Atendimento Hr_Atendimento,

             To_Date(To_Char(Atendime.Dt_Atendimento, 'dd/mm/yyyy') /* pda 128810 */

                     || To_Char(Atendime.Hr_Atendimento, 'hh24:mi:ss'),

                     'dd/mm/yyyy hh24:mi:ss') Data_Atendimento

        FROM Dbamv.Consumo_Paciente,

             Dbamv.Atendime,

             Dbamv.Convenio,

             Dbamv.Empresa_Convenio

       WHERE Consumo_Paciente.Cd_Consumo_Paciente = Ncdconsumo

         AND Convenio.Cd_Convenio = Empresa_Convenio.Cd_Convenio /* PDA 118607/129023*/

         AND Empresa_Convenio.Cd_Multi_Empresa =

             Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/129023*/

         AND Atendime.Cd_Atendimento = Consumo_Paciente.Cd_Atendimento

         AND Convenio.Cd_Convenio = Atendime.Cd_Convenio

         AND Convenio.Tp_Convenio IN ('H', 'P', 'C')

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    CURSOR c_Fator IS

      SELECT Nvl(Uni_Pro.Vl_Fator, 1) Vl_Fator

        FROM Dbamv.Uni_Pro

       WHERE Uni_Pro.Cd_Uni_Pro = Ncdunipro;

    CURSOR c_Grfat(Ncdclasse IN NUMBER, Ncdespecie IN NUMBER, Ncdsetor IN NUMBER) IS

		SELECT Gru_Fat.Cd_Gru_Fat,

             Gru_Fat.Tp_Gru_Fat

        FROM Dbamv.Configu_Importacao_Gru_Fat,

             Dbamv.Gru_Fat

       WHERE Cd_Classe = Ncdclasse

         AND Cd_Especie = Ncdespecie

         AND Cd_Setor = Ncdsetor

         AND Gru_Fat.Cd_Gru_Fat = Configu_Importacao_Gru_Fat.Cd_Gru_Fat;

    CURSOR c_Config_Particular IS

      SELECT Cd_Convenio_Fat_Extra Cd_Convenio,

             Cd_Con_Pla_Fat_Extra  Cd_Con_Pla

        FROM Dbamv.Config_Ffcv

       WHERE Config_Ffcv.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    --Cursor para coletar dados de atendimento ambulatorial por sess?para o atendimento pai

    CURSOR Catendsessao(Pncdatedimento IN NUMBER) IS

      SELECT Nvl(Atendime_Sessao.Sn_Retorno, 'N') Sn_Retorno,

             Nvl(Atendime.Qt_Sessoes, 0) Qt_Sessoes,

             Atendime_Sessao.Dt_Atendimento Dt_Atendimento

        FROM Dbamv.Atendime Atendime,

             Dbamv.Atendime Atendime_Sessao

       WHERE Atendime_Sessao.Cd_Atendimento = Pncdatedimento

         AND Atendime_Sessao.Cd_Atendimento_Pai = Atendime.Cd_Atendimento

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa;

    /* pda 128810 - fim */

    Auditoria_In_Loco EXCEPTION;

    Prod_Nao_Conf EXCEPTION;

    Setor_Nao_Conf EXCEPTION;

    Proc_Sem_Preco EXCEPTION;

    Atend_Sem_Conta EXCEPTION;

    Proc_Proibido EXCEPTION;

	proc_proibido_idade    exception;   -- OP 32555

    Fora_Da_Conta EXCEPTION;

    Conta_Sem_Item EXCEPTION; /* pda 128810 */

    v_Proced c_Proced%ROWTYPE;

    v_Mvto   c_Mvto%ROWTYPE;

    v_Fator  c_Fator%ROWTYPE;

    --PDA 157595(INICIO) 14/04/2008 - Jansen Gallindo

    --v_conta              dbamv.pack_lanca_ffcv.c_conta%ROWTYPE;

    v_Conta Dbamv.Pkg_Ffcv_Conta.Tpconta;

    --v_contaambu          dbamv.pack_lanca_ffcv.c_contaambu%ROWTYPE;

    v_Contaambu Dbamv.Pkg_Ffcv_Conta.Tpcontaambu;

    --v_ambupart           dbamv.pack_lanca_ffcv.c_contapartambu%ROWTYPE;

    v_Ambupart Dbamv.Pkg_Ffcv_Conta.Tpcontapartambu;

    --v_contapart          dbamv.pack_lanca_ffcv.c_contapart%ROWTYPE;

    --PDA 157595(FIM) 14/04/2008 - Jansen Gallindo

    v_Grfat       c_Grfat%ROWTYPE;

    v_Itregfat    Dbamv.Pack_Lanca_Ffcv.c_Itregfat%ROWTYPE;

    v_Itregamb    Dbamv.Pack_Lanca_Ffcv.c_Itregamb%ROWTYPE;

    Vcatendsessao Catendsessao%ROWTYPE; /* pda 128810 */

    -- pda 96511 - 23/06/2004 - Amalia Ara??

    Vcgabaritohosp   Dbamv.Pack_Lanca_Ffcv.Cgabaritohosp%ROWTYPE;

    Vcitgabaritohosp Dbamv.Pack_Lanca_Ffcv.Citgabaritohosp%ROWTYPE;

    Vcquantgabarito  Dbamv.Pack_Lanca_Ffcv.Cquantgabarito%ROWTYPE;

    -- pda 96511 - fim

    v_Particular  c_Config_Particular%ROWTYPE;

    Nqtprofat     Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Noldqtprofat  Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    ;

    Ncdlcto       Dbamv.Itreg_Fat.Cd_Lancamento%TYPE /*number pda 254997*/

    ;

    Csnpacote     VARCHAR2(1);

    Binsert       BOOLEAN;

    Ctpproibicao  VARCHAR2(2);

    Nqtautorizado NUMBER;

    Ncdguia       NUMBER;

    Bpartic       BOOLEAN := FALSE;

    Ncdregfat     Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/

    ;

    Ndiferenca    NUMBER;

    Nqtregrateio  NUMBER;

    Csnimportar   VARCHAR2(1);

    Ncdlfa        NUMBER;

    Ncdregamb     Dbamv.Reg_Amb.Cd_Reg_Amb%TYPE /*number pda 254997*/

    ;

    Updating      BOOLEAN := FALSE;

    Deleting      BOOLEAN := FALSE;

    Inserting     BOOLEAN := FALSE;

    Cgravaatend   VARCHAR2(1);

    Ctpimport     VARCHAR2(1);

    Ddtreferencia DATE;

    Ncdconvconta  NUMBER;

    Ncdplanconta  Dbamv.Con_Pla.Cd_Con_Pla%TYPE /*number pda 254997*/

    ;

    -- PDA 96161 -- Alexandre Erik C. M. Costa 25/05/2004

    -- Declara? de vari?is

    Vsnguiaprocauto    VARCHAR2(1);

    Nqtdguia           NUMBER;

    v_Qtdexistente_Fat NUMBER;

    Totallancado       NUMBER;

    /* pda 128810 - 10/08/2005 - Amalia Ara??*/

    v_Qtdexistente_Amb NUMBER;

    Vtp_Controle_Lote  VARCHAR2(1);

    Nqtaux             Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    := 0;

    Nqtlcto            Dbamv.Itreg_Fat.Qt_Lancamento%TYPE /*number pda 254997*/

    := 0;

    /* pda 128810 - fim */

    Nguiapendente Dbamv.Guia.Cd_Guia%TYPE; -- pda 145435 - 24/03/2006 - Jose Roberto

    Ncdguiaitem   Dbamv.Guia.Cd_Guia%TYPE; /* pda 141006 */

    -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

    Ncdpacote Dbamv.Conta_Pacote.Cd_Conta_Pacote%TYPE;

    Csnguia   VARCHAR2(1) := 'N';

    -- PDA 157145 (Fim)

    Ddthraux     DATE; -- PDA 221500 - 27/03/2008 - Diego Costa

    Nqtexcedeu   NUMBER := NULL; -- OP 387

    Vtpcontapart Dbamv.Itreg_Fat.Tp_Mvto%TYPE := NULL; -- OP 387

    Nconta       NUMBER := NULL; -- OP 387

    Nlanc        NUMBER := NULL; -- OP 387



    vTemRegraCriaContaAuto BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnCriouContaAuto      BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vSnCriouContaAutoAmb   BOOLEAN := FALSE; /*OP 35916 - regra para cria? autom?ca de conta*/

    vRegraCriaContaAuto    Dbamv.Pkg_Ffcv_Conta.TpContaAutomatica; /*OP 35916 - regra para cria? autom?ca de conta*/

    v_ContaCargoPac        Dbamv.Pkg_Ffcv_Conta.Tpconta;     /*ALLS OP 42241 */

    v_ContaCargoPacAmbu    Dbamv.Pkg_Ffcv_Conta.Tpcontaambu; /*ALLS OP 42241 */

    vRegraCriaContaAutoCP  Dbamv.Pkg_Ffcv_Conta.TpContaAutomaticaCP; /*ALLS OP 42241* - regra para cria? autom?ca de conta referente a Cargo Paciente*/

    vSnCargoPaciente       Dbamv.Pack_Lanca_Ffcv.cSnCargoPaciente%ROWTYPE; /*ALLS OP 42241*/

    vSnCriouContaAutoCP    BOOLEAN := FALSE; /*ALLS OP 42241 */

    vSnCriouContaAutoAmbCP BOOLEAN := FALSE; /*ALLS OP 42241 */

    NcdlctoCp              NUMBER  ; /*ALLS OP 42241 */

    NcdlctoAmbCp           NUMBER  ; /*ALLS OP 42241 */



    pEmpresa               NUMBER := Pkg_Mv2000.Le_Empresa;/*43289*/

    pvSnJaExcedeuQtd      Varchar2(1):= 'N'; /*43289*/

    pvMensagem             VARCHAR2(2000);    /*43289*/

    pSnChamadoDaTela       VARCHAR2(1) := 'N';       /*43289*/



  BEGIN

    IF Caction = 'I' THEN

      Inserting := TRUE;

    ELSIF Caction = 'U' THEN

      Updating := TRUE;

    ELSIF Caction = 'D' THEN

      Deleting := TRUE;

    END IF;

    OPEN c_Importar;

    FETCH c_Importar

      INTO Csnimportar, Ctpimport, Vsnguiaprocauto, Vtp_Controle_Lote;

    CLOSE c_Importar;

    OPEN c_Config_Particular;

    FETCH c_Config_Particular

      INTO v_Particular;

    CLOSE c_Config_Particular;

    IF Nvl(Csnimportar, 'S') <> 'N' AND Ctpimport = 'C' THEN

      OPEN c_Mvto;

      FETCH c_Mvto

        INTO v_Mvto;

      CLOSE c_Mvto;

      /* pda 128810 - 09/08/2005 - Amalia Ara??

      altera? no IF para inclus?da rotina Ambulatorial */

      IF (v_Mvto.Tp_Atendimento <> 'S') AND

         ((v_Mvto.Tp_Atendimento IN ('H', 'I') AND

         Nvl(Csnimportar, 'S') IN ('H', 'S')) OR

         (v_Mvto.Tp_Atendimento IN ('A', 'E', 'U') AND

         Nvl(Csnimportar, 'S') IN ('A', 'S'))) THEN

        /* pda 128810 - fim */

        OPEN c_Proced;

        FETCH c_Proced

          INTO v_Proced;

        CLOSE c_Proced;

        IF v_Mvto.Dt_Alta IS NULL THEN

          Ddtreferencia := v_Mvto.Dt_Mvto_Estoque;

        ELSE

          IF v_Mvto.Dt_Mvto_Estoque < v_Mvto.Dt_Alta THEN

            Ddtreferencia := v_Mvto.Dt_Mvto_Estoque;

          ELSE

            Ddtreferencia := v_Mvto.Dt_Alta;

          END IF;

        END IF;

        /* pda 128810 - 11/08/2005 - Amalia Ara??*/

        IF v_Mvto.Tp_Atendimento IN ('A', 'E', 'U') THEN

          Ddtreferencia := v_Mvto.Data_Atendimento;

        END IF;

        -- PDA 229502 (In?o) - 19/05/2008 - Diego Costa

        -- Compara a data de refer?ia com a data de atendimento, se a data de refer?ia for menor,

        -- ent?utiliza a data de atendimento, para evitar item lan?os fora da conta.

        IF Ddtreferencia < v_Mvto.Data_Atendimento THEN

          Ddtreferencia := v_Mvto.Data_Atendimento;

        END IF;

        -- PDA 229502 (Fim)



		if dbamv.fnc_ffcv_proibicao_idade( v_mvto.cd_atendimento, v_mvto.cd_convenio, v_mvto.cd_con_pla, v_proced.cd_pro_fat ) <> 'OK' then

		  raise proc_proibido_idade;

		end if;

		-- OP 32555 - fim



        /* pda 128810 */

/*		OP 38292 (Inicio)

        OPEN Dbamv.Pack_Lanca_Ffcv.c_Proibicao(v_Proced.Cd_Pro_Fat,

                                               v_Mvto.Cd_Convenio,

                                               v_Mvto.Cd_Con_Pla,

                                               v_Mvto.Tp_Atendimento,

                                               Ddtreferencia,

                                               v_Mvto.Cd_Setor);

        FETCH Dbamv.Pack_Lanca_Ffcv.c_Proibicao

          INTO Ctpproibicao;

        CLOSE Dbamv.Pack_Lanca_Ffcv.c_Proibicao;



		*/

      Ctpproibicao := dbamv.pack_ffcv_proibicao.fnc_ffcv_proibicao(v_Proced.Cd_Pro_Fat,

                                               v_Mvto.Cd_Convenio,

                                               v_Mvto.Cd_Con_Pla,

                                               v_Mvto.Tp_Atendimento,

                                               Ddtreferencia,

                                               v_Mvto.Cd_Setor,

                                                                     v_mvto.cd_atendimento,

                                                                     NULL);

      -- OP 38292 (Fim)



        IF Ctpproibicao = 'FC' THEN

          RAISE Fora_Da_Conta;

        END IF;

        Cgravaatend := v_Mvto.Tp_Atendimento;

        IF v_Proced.Cd_Pro_Fat IS NULL THEN

          RAISE Prod_Nao_Conf;

        END IF;

        OPEN c_Grfat(v_Proced.Cd_Classe,

                     v_Proced.Cd_Especie,

                     v_Mvto.Cd_Setor);

        FETCH c_Grfat

          INTO v_Grfat;

        CLOSE c_Grfat;

        IF v_Grfat.Cd_Gru_Fat IS NULL THEN

          RAISE Setor_Nao_Conf;

        END IF;

        IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

          /* pda 128810 */

          --13082007

          --PDA 157595(INICIO) 14/04/2008 - Jansen Gallindo

          /*OPEN dbamv.pack_lanca_ffcv.c_conta (v_mvto.cd_atendimento

                                             ,ddtreferencia

                                             ,NULL

                                             ,v_mvto.cd_atendimento_pai

                                             );

          FETCH dbamv.pack_lanca_ffcv.c_conta INTO v_conta;

          CLOSE dbamv.pack_lanca_ffcv.c_conta;*/

          v_Conta := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Conta(v_Mvto.Cd_Atendimento,

                                                            Ddtreferencia,

                                                            NULL,

                                                            v_Mvto.Cd_Atendimento_Pai);

          --IF v_conta.cd_reg_fat IS NULL THEN

          IF v_Conta(1).Cd_Reg_Fat IS NULL THEN

            --PDA 157595(FIM) 14/04/2008 - Jansen Gallindo

            IF v_Mvto.Cd_Convenio_Secundario IS NOT NULL THEN

              Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Verifica_Conta_Secundaria(v_Mvto.Cd_Atendimento,

                                                                              Ddtreferencia,

                                                                              v_Mvto.Cd_Convenio_Secundario,

                                                                              v_Mvto.Cd_Atendimento_Pai);

              Ncdconvconta := v_Mvto.Cd_Convenio_Secundario;

              Ncdplanconta := v_Mvto.Cd_Con_Pla_Secundario;

              IF Ncdregfat IS NULL THEN

                RAISE Atend_Sem_Conta;

              END IF;

            ELSE

              IF v_Mvto.Tp_Convenio = 'P' THEN

                Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento,

                                                                             Ddtreferencia); -- pda 125871 (acrescentada a data)

                Ncdconvconta := v_Mvto.Cd_Convenio;

                Ncdplanconta := v_Mvto.Cd_Con_Pla;

              ELSE

                RAISE Atend_Sem_Conta;

              END IF;

            END IF;

          ELSE

            Ncdregfat    := v_Conta(1).Cd_Reg_Fat; --ncdregfat := v_conta.cd_reg_fat; --PDA 157595

            Ncdconvconta := v_Conta(1).Cd_Convenio; --ncdconvconta := v_conta.cd_convenio; --PDA 157595

            Ncdplanconta := v_Conta(1).Cd_Con_Pla; --ncdplanconta := v_conta.cd_con_pla; --PDA 157595

          END IF;

          IF Ctpproibicao = 'NA' THEN

            Ncdregfat    := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(v_Mvto.Cd_Atendimento,

                                                                         Ddtreferencia); -- pda 125871 (acrescentada a data)

            Ncdconvconta := v_Particular.Cd_Convenio;

            Ncdplanconta := v_Particular.Cd_Con_Pla;

            IF Ncdregfat IS NULL THEN

              RAISE Atend_Sem_Conta;

            ELSE

              Bpartic := TRUE;

            END IF;

          END IF;

          /* pda 128810 - 09/08/2005 - Amalia Ara??

          verifica? Ambulatorial                       */

        ELSE

          --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

          /*IF dbamv.pack_lanca_ffcv.c_contaambu%ISOPEN THEN

             CLOSE dbamv.pack_lanca_ffcv.c_contaambu;

          END IF;*/

          /*OPEN dbamv.pack_lanca_ffcv.c_contaambu (v_mvto.cd_atendimento

                                                 ,ddtreferencia

                                                 ,NULL

                                                 ,v_mvto.cd_atendimento_pai

                                                 );

          FETCH dbamv.pack_lanca_ffcv.c_contaambu INTO v_contaambu;

          CLOSE dbamv.pack_lanca_ffcv.c_contaambu;*/

          /*OP 35916 - regra para cria? autom?ca de conta*/

          vTemRegraCriaContaAuto  := Dbamv.Pkg_Ffcv_Conta.FNC_TEM_REG_CRIA_CONTA_AUTO;

          IF (vTemRegraCriaContaAuto) THEN



                /*ALLS OP 42241*/

                OPEN dbamv.pack_lanca_ffcv.cSnCargoPaciente(v_Mvto.Cd_Atendimento);

                FETCH dbamv.pack_lanca_ffcv.cSnCargoPaciente INTO vSnCargoPaciente;

			          CLOSE dbamv.pack_lanca_ffcv.cSnCargoPaciente;



			          IF Nvl(vSnCargoPaciente.sn_carga_familiar,'N') = 'S' THEN



                    vRegraCriaContaAutoCP := Dbamv.Pkg_Ffcv_Conta.FNC_VERIF_REG_CRIA_CONTA_AUTCP(v_Mvto.Cd_Atendimento,

                                                                                                 v_Proced.Cd_Pro_Fat,

                                                                                                 Ddtreferencia); --FATURCONV-1383 - AMBS



                    IF (vRegraCriaContaAutoCP(1).cd_regra_cria_conta IS NOT NULL ) THEN



                        v_ContaCargoPacAmbu :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_AMB_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                                null,

                                                                                                v_Mvto.Cd_Atendimento,

                                                                                                v_Mvto.Cd_Atendimento_Pai,

                                                                                                vRegraCriaContaAutoCP(1).cd_convenio_destino,

                                                                                                vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                                                                                                Ddtreferencia,

                                                                                                vRegraCriaContaAutoCP(1).cd_tipo_arq_cta_envio,

                                                                                                vRegraCriaContaAutoCP(1).cd_desconto_inst); /*ALLS OP 35921*/

                        vSnCriouContaAutoAmbCP := TRUE;

                    END IF;

                /*fim ALLS OP 42241*/

                ELSE



                    vRegraCriaContaAuto := Dbamv.Pkg_Ffcv_Conta.FNC_VERIFIC_REG_CRIA_CONTA_AUT(v_Mvto.Cd_Atendimento,

                                                                                               v_Proced.Cd_Pro_Fat,

                                                                                               Ddtreferencia); --FATURCONV-1383 - AMBS



                    IF (vRegraCriaContaAuto(1).cd_regra_cria_conta IS NOT NULL)  THEN



                        v_Contaambu :=  Dbamv.Pkg_Ffcv_Conta.FNC_RETORNA_CONTA_AMB_AUTO(Pkg_Mv2000.Le_Empresa,

                                                                                        null,

                                                                                        v_Mvto.Cd_Atendimento,

                                                                                        v_Mvto.Cd_Atendimento_Pai,

                                                                                        vRegraCriaContaAuto(1).cd_convenio_destino,

                                                                                        vRegraCriaContaAuto(1).cd_con_pla_destino,

                                                                                        Ddtreferencia,

                                                                                        vRegraCriaContaAuto(1).cd_tipo_arq_cta_envio,

                                                                                        vRegraCriaContaAuto(1).cd_desconto_inst); /*ALLS OP 35921*/

                        vSnCriouContaAutoAmb := TRUE;

                    END IF;



                END IF;



          END IF;



          IF (NOT vSnCriouContaAutoAmb) THEN

          /*OP 35916 - regra para cria? autom?ca de conta*/



             v_Contaambu := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Ccontaambu(v_Mvto.Cd_Atendimento,

                                                                     Ddtreferencia,

                                                                     NULL,

                                                                     v_Mvto.Cd_Atendimento_Pai);

          END IF;/*OP 35916*/

          --IF NVL (v_contaambu.sn_fechada, 'N') = 'S' THEN

          IF Nvl(v_Contaambu(1).Sn_Fechada, 'N') = 'S' THEN

            --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

            RAISE Atend_Sem_Conta;

          END IF;

          --IF v_contaambu.cd_reg_amb IS NULL THEN --PDA 157595

          IF v_Contaambu(1).Cd_Reg_Amb IS NULL THEN

            --PDA 157595

            IF v_Mvto.Tp_Convenio = 'P' THEN

              Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(v_Mvto.Cd_Atendimento);

            ELSE

              Ncdregamb := Dbamv.Pack_Ffcv.Cria_Conta_Acoplamentoambu(v_Mvto.Cd_Atendimento,

                                                                      'N');

            END IF;

            Ncdconvconta := v_Mvto.Cd_Convenio;

            Ncdplanconta := v_Mvto.Cd_Con_Pla;

          ELSE

            Ncdregamb    := v_Contaambu(1).Cd_Reg_Amb; --ncdregamb := v_contaambu.cd_reg_amb; --PDA 157595

            Ncdconvconta := v_Contaambu(1).Cd_Convenio; --ncdconvconta := v_contaambu.cd_convenio; --PDA 157595

            Ncdplanconta := v_Contaambu(1).Cd_Con_Pla; --ncdplanconta := v_contaambu.cd_con_pla; --PDA 157595

          END IF;

          IF Ctpproibicao = 'NA' THEN

            IF Vtp_Controle_Lote = 'A' THEN

              --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

              /*OPEN dbamv.pack_lanca_ffcv.c_contapartambu (v_mvto.cd_atendimento, ddtreferencia);

              FETCH dbamv.pack_lanca_ffcv.c_contapartambu INTO v_ambupart;

              CLOSE dbamv.pack_lanca_ffcv.c_contapartambu;*/

              v_Ambupart := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Ccontapartambu(v_Mvto.Cd_Atendimento,

                                                                            Ddtreferencia);

              --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

            ELSE

              --PDA 157595(INICIO) 15/04/2008 - Jansen Gallindo

              /*OPEN dbamv.pack_lanca_ffcv.c_contapartambu_loteunico (v_mvto.cd_atendimento, ddtreferencia);

              FETCH dbamv.pack_lanca_ffcv.c_contapartambu_loteunico INTO v_ambupart;

              CLOSE dbamv.pack_lanca_ffcv.c_contapartambu_loteunico;*/

              v_Ambupart := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Contpartambulotun(v_Mvto.Cd_Atendimento,

                                                                               Ddtreferencia);

              --PDA 157595(FIM) 15/04/2008 - Jansen Gallindo

            END IF;

            --IF v_ambupart.cd_reg_amb IS NULL THEN --PDA 157595

            IF v_Ambupart(1).Cd_Reg_Amb IS NULL THEN

              --PDA 157595

              Ncdregamb := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(v_Mvto.Cd_Atendimento);

            ELSE

              Ncdregamb := v_Ambupart(1).Cd_Reg_Amb; --ncdregamb := v_ambupart.cd_reg_amb; --PDA 157595

            END IF;

            Ncdconvconta := v_Particular.Cd_Convenio;

            Ncdplanconta := v_Particular.Cd_Con_Pla;

            IF Ncdregamb IS NULL THEN

              RAISE Atend_Sem_Conta;

            END IF;

          END IF;

        END IF;

        /* pda 128810 - fim */

        OPEN c_Fator;

        FETCH c_Fator

          INTO v_Fator;

        CLOSE c_Fator;

        IF Nvl(Nqtmovnew, 0) = 0 THEN

          Nqtprofat := 1;

        ELSE

          Nqtprofat := Round((Nqtmovnew * v_Fator.Vl_Fator) /

                             v_Proced.Vl_Fator_Pro_Fat);

        END IF;

        IF Nvl(Nqtmovold, 0) = 0 THEN

          Noldqtprofat := 1;

        ELSE

          Noldqtprofat := Round((Nqtmovold * v_Fator.Vl_Fator) /

                                v_Proced.Vl_Fator_Pro_Fat);

        END IF;

        /* pda 313614 - 18/11/2009 - Amalia Ara??- Evitar lan? quantidade zerada na conta */

        IF Nvl(Nqtprofat, 0) < 1 THEN

          Nqtprofat := 1;

        END IF;

        IF Nvl(Noldqtprofat, 0) < 1 THEN

          Noldqtprofat := 1;

        END IF;

        /* pda 313614 - fim */

        /* pda 145435 - 23/03/2006 - Jose Roberto                              (*)

        Alterando a verifica? da guia, retirando os cursores c_qtdexistente_amb e

        c_qtdexistente_fat para utilizar a nova fun? FNC_RETORNA_GUIA_DISPONIVEL;

        Retiradas as verifica?s nos cursores c_guia, c_itguia e c_itguia_proc_auto;

        Retirado o uso das vari?is totallancado e nqtautorizado;

        Caso NCDGUIA for Nulo, chamando a fun? F_GRAVA_GUIA, alterando o terceiro

        par?tro para nqtprofat;

        Retirado todo o c?ulo feito para atribuir valor as vari?is nqtpart,

        nqtconv e limite;

        Caso retorne uma Guia dispon?l, atribu?a  vari?l NCDGUIA.         */

        /*PDA 374303 - 25/06/2010 - Juliana Vieira

        Replicando mesma altera? do PDA 312488, por?para outros lan?entos autom?cos.

        na chamada da fun? que retorna se tem uma guia dispon?l, passar sempre o codigo do atendimento

        pai caso tiver, pois o sistma pode criar atendimentos de recem nascido onde n?existe conta para ele e n??ecess?o

        crioar guias para os atendimentos filhos.*/

        IF Ctpproibicao = 'AG' THEN

          Ncdguia := Dbamv.Pkg_Ffcv_Guia.Fnc_Retorna_Guia_Disponivel(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                         v_Mvto.Cd_Atendimento),

                                                                     Nvl(Ncdregfat,

                                                                         Ncdregamb),

                                                                     NULL,

                                                                     v_Proced.Cd_Pro_Fat,

                                                                     Nqtprofat,

                                                                     NULL,

                                                                     NULL,

                                                                     Nguiapendente);

          IF Nvl(Vsnguiaprocauto, 'N') = 'S' THEN

            IF Ncdguia IS NULL THEN

              Ncdguia := Dbamv.f_Grava_Guia(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                v_Mvto.Cd_Atendimento),

                                            v_Mvto.Cd_Convenio,

                                            Nqtprofat,

                                            v_Proced.Cd_Pro_Fat,

                                            'P');

            END IF;

          ELSE

            IF Ncdguia IS NULL THEN

              RAISE Proc_Proibido;

            END IF;

          END IF;

        END IF;

        -- pda 145435 (Fim)

        IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

          /* pda 128810 */

          -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

          IF Ctpproibicao = 'AG' THEN

            Csnguia := 'S';

          END IF;

          -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

          -- Prepara? da data que ser?assada na fun?.

          -- A data preparada ir?onter al?da data de lan?ento, a hora de lan?ento.

          Ddthraux := To_Date(To_Char(Ddtreferencia, 'DD/MM/YYYY') || ' ' ||

                              To_Char(Nvl(v_Mvto.Hr_Mvto_Estoque,

                                          Ddtreferencia),

                                      'HH24:MI:SS'),

                              'DD/MM/YYYY HH24:MI:SS');

          -- PDA 221500 (Fim)

          /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

          nQtExcedeu a vari?l retorna justamente a quantidade de procedimentos que deve ser lan?o no procedimento

          que pertence ao pacote, em seguida deve ser inserdio um outro procedimento com o que restou do lan?ento*/

          Nqtexcedeu := NULL;

          --

          /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

          vTpContaPart a vari?l retorna justamente se o procedimento vai ser inserido em uma conta particular ou ira seguir

          o processo normalmente.*/

          Ncdpacote := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Gera_Pacote(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                   v_Mvto.Cd_Atendimento),

                                                               v_Mvto.Tp_Atendimento,

                                                               Ncdconvconta,

                                                               Ncdplanconta,

                                                               Ncdregfat,

                                                               v_Grfat.Cd_Gru_Fat,

                                                               v_Proced.Cd_Pro_Fat,

                                                               v_Mvto.Cd_Setor,

                                                               NULL

                                                               -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

                                                               -- ,nvl(ddtreferencia,sysdate)

                                                              ,

                                                               Nvl(Ddthraux,

                                                                   SYSDATE)

                                                               -- PDA 221500 (Fim)

                                                              ,

                                                               Ncdconsumo,

                                                               NULL,

                                                               'Consumo',

                                                               Csnguia,

                                                               Nqtprofat,

                                                               Csnpacote,

                                                               Nqtexcedeu -- OP 387

                                                              ,

                                                               Vtpcontapart -- OP 387

                                                              ,

                                                               NULL

                                                               -- PDA 225086 (Inicio)

                                                              ,

                                                               v_Mvto.Cd_Atendimento,

                                                               NULL --pCdProFatPacote

                                                              ,

                                                               Ncdlcto --pCdLancamento_pac

                                                              ,

                                                               NULL); --preserva

          -- PDA 225086 (fim)

          /* pda 481126 - depois da FNC_GERA_PACOTE regravando o cd_lancamento_pac */

          IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

            OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncdregfat);

            FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

              INTO Ncdlcto;

            CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

          ELSE

            OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Ncdregamb);

            FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

              INTO Ncdlcto;

            CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;

          END IF;

          --

          IF Ncdpacote IS NOT NULL THEN

            UPDATE Dbamv.Conta_Pacote

               SET Cd_Lancamento_Pac = Ncdlcto

             WHERE Cd_Conta_Pacote = Ncdpacote;

          END IF;

          /* pda 481126 - fim */

          --OPEN dbamv.pack_lanca_ffcv.c_pacotehosp (ncdregfat);

          --FETCH dbamv.pack_lanca_ffcv.c_pacotehosp INTO csnpacote;

          --CLOSE dbamv.pack_lanca_ffcv.c_pacotehosp;

          -- pda 96511 - 23/06/2004 - Amalia Ara??

          -- Alterado o processo. Ap??erificar se ?acote normal, vai verificar se ?
          -- gabarito. Se o procedimento principal n?for gabarito, continua como era.

          -- Se o procedimento principal for gabarito, vai verificar se o item da conta

          -- est?elacionado no gabarito. Se n?estiver, o procedimento ser?ertencente

          -- a pacote (cSnPacote=N). Se estiver, ser?erificado se a quantidade

          -- deste procedimento na conta j?xcedeu a quantidade negociada com o convenio

          -- (qt_gabarito); se n?excedeu, o procedimento ser?acote; se excedeu, s??
          -- ser?acote se o campo SN_PACOTE do gabarito estiver marcado.

          -- pda 96511 - 18/05/2004 - Amalia Ara??

          -- Se n?for pacote, verificar se consta como pacote no cadastro de gabaritos

          /*if nvl(cSnPacote,'N') = 'N' then

             Open dbamv.pack_lanca_ffcv.cGabaritoHosp( nCdRegFat, V_Proced.cd_pro_fat );

             Fetch dbamv.pack_lanca_ffcv.cGabaritoHosp into cSnPacote;

             Close dbamv.pack_lanca_ffcv.cGabaritoHosp;

          end if;  */

          /* OPEN dbamv.pack_lanca_ffcv.cgabaritohosp (ncdregfat);

          FETCH dbamv.pack_lanca_ffcv.cgabaritohosp INTO vcgabaritohosp;



          IF dbamv.pack_lanca_ffcv.cgabaritohosp%NOTFOUND THEN

             NULL;

          ELSE

             OPEN dbamv.pack_lanca_ffcv.citgabaritohosp (v_proced.cd_pro_fat, vcgabaritohosp.cd_gabarito);

             FETCH dbamv.pack_lanca_ffcv.citgabaritohosp INTO vcitgabaritohosp;



             IF dbamv.pack_lanca_ffcv.citgabaritohosp%NOTFOUND THEN

                csnpacote := 'N';

             ELSE

                csnpacote := 'S';

                vcquantgabarito.qt_lancamento := NULL;

                OPEN dbamv.pack_lanca_ffcv.cquantgabarito (ncdregfat, v_proced.cd_pro_fat);

                FETCH dbamv.pack_lanca_ffcv.cquantgabarito INTO vcquantgabarito;



                IF NVL (nqtprofat + vcquantgabarito.qt_lancamento, 0) > NVL (vcitgabaritohosp.qt_gabarito, 0) THEN

                   csnpacote := NVL (vcitgabaritohosp.sn_pacote, 'N');

                ELSE

                   csnpacote := 'S';

                END IF;



                CLOSE dbamv.pack_lanca_ffcv.cquantgabarito;

             END IF;



             CLOSE dbamv.pack_lanca_ffcv.citgabaritohosp;

          END IF;



          CLOSE dbamv.pack_lanca_ffcv.cgabaritohosp;*/

          -- pda 96511 - fim

          -- PDA 157145 (Fim)

          IF Inserting THEN

            -- PDA 123016 (Inicio) - Henrique Antunes - 06/07/2005

            DECLARE

              Vqtd NUMBER;

            BEGIN

              OPEN Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco(Ncdregfat,

                                                          Ddtreferencia,

                                                          v_Mvto.Hr_Mvto_Estoque);

              FETCH Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco

                INTO Vqtd;

              CLOSE Dbamv.Pack_Lanca_Ffcv.Cauditoriainloco;

              IF Nvl(Vqtd, 0) <> 0 THEN

                RAISE Auditoria_In_Loco;

              END IF;

            END;

            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o procedimento que ira ser inserido abaixo pertence a um pacote, e a qunatidade que sera inserida sera menor que a lan?a, a diferen?

            sera lan?a na rotina mais abaixo atravez da procedure PRC_DESVINCULA_PROCEDIMENTO*/

            /* Fazendo tratamento caso o procedimento esteja configurado no gabarito para ser inserido dentro de uma conta particular

            caso a variavel vTpContaPart esteja preenchida e a quantidade de lan?ento extra esteja nula. com iso deve ser procurado uma conta particular

            e um lan?ento para inseririr nesta conta.*/

            Nconta := NULL;

            Nlanc  := NULL;



			/*43289 - quebra de conta por quantidade de procedimento por atendimento*/

			/*A regra de pacote tem prioridade sobre essa regra, conforme vari?l Nqtexcedeu abaixo*/

			IF Nqtexcedeu IS NULL THEN

				if (not vSnCriouContaAuto) then /*OP 46768*/

					  IF DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_EXISTE_CONF_QTD_ATEND_PAC(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																						 v_proced.cd_pro_fat,

																						 pEmpresa) THEN



						  Nqtexcedeu := DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_RETORNA_QTD_LANC_PERIODO(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																									   v_proced.cd_pro_fat,

																									   pEmpresa,

																									   ncdregfat,

																									   nqtprofat,

																									   pSnChamadoDaTela,

																									   pvSnJaExcedeuQtd,

																									   pvMensagem

																									   );

						  IF pvSnJaExcedeuQtd = 'S' THEN

							  Vtpcontapart := 'ProcPorAtend';

							  Nqtexcedeu   := NULL;

						  ELSE

								IF NVL(Nqtexcedeu,0) > 0 THEN

									Vtpcontapart := 'ProcPorAtend';

								END IF;

						  END IF;

					END IF;

				END IF;/*OP 46768*/

		    END IF;

			/*43289*/



            IF Nvl(Vtpcontapart, 'X') <> 'X' AND Nqtexcedeu IS NULL THEN

              Nconta := Dbamv.Pack_Lanca_Ffcv.Cria_Conta_Pacparthosp(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                         v_Mvto.Cd_Atendimento),

                                                                     Ddtreferencia);

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Nconta);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                INTO Nlanc;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

            END IF;

            -- PDA 123016 (Fim)

            INSERT INTO Dbamv.Itreg_Fat

              (Cd_Reg_Fat,

               Cd_Lancamento,

               Dt_Lancamento,

               Hr_Lancamento,

               Qt_Lancamento,

               Vl_Percentual_Multipla,

               Cd_Gru_Fat,

               Cd_Pro_Fat,

               Sn_Pertence_Pacote,

               Cd_Guia,

               Cd_Setor,

               Cd_Setor_Produziu,

               Sn_Horario_Especial,

               Cd_Usuario,

               Cd_Mvto,

               Tp_Mvto

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Cd_Conta_Pacote

               -- PDA 157145 (Fim)

               )

            VALUES

              (Nvl(Nconta, Ncdregfat) -- OP 387

              ,

               Nvl(Nlanc, Ncdlcto) -- OP 387

              ,

               Ddtreferencia,

               v_Mvto.Hr_Mvto_Estoque,

               Nvl(Nqtexcedeu, Nqtprofat) -- OP 387

              ,

               100,

               v_Grfat.Cd_Gru_Fat,

               v_Proced.Cd_Pro_Fat,

               Nvl(Csnpacote, 'N'),

               Ncdguia,

               v_Mvto.Cd_Setor,

               v_Mvto.Cd_Setor,

               'N',

               USER,

               Ncdconsumo,

               Nvl(Vtpcontapart, 'Consumo') -- OP 387

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Ncdpacote

               -- PDA 157145 (Fim)

               );





              /*OP 42241 - Caso tenha criado a conta por cargo paciente, devemos lan? o item para o convenio, plano, percentual definido na configura

              de quebra de conta por cargo paciente*/

              IF (vSnCriouContaAutoCP) THEN

                  vSnCriouContaAutoCP := FALSE;



                  OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(v_ContaCargoPac(1).cd_reg_fat);

                  FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                  INTO NcdlctoCp;

                  CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;



                   INSERT INTO Dbamv.Itreg_Fat

                    (Cd_Reg_Fat,

                     Cd_Lancamento,

                     Dt_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Vl_Percentual_Multipla,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Sn_Pertence_Pacote,

                     Cd_Guia,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto

                     )

                  VALUES

                    (v_ContaCargoPac(1).cd_reg_fat,

                     NcdlctoCp,

                     Ddtreferencia,

                     v_Mvto.Hr_Mvto_Estoque,

                     Nvl(Nqtexcedeu, Nqtprofat),

                     vRegraCriaContaAutoCP(1).vl_percentual_carga_familiar,

                     v_Grfat.Cd_Gru_Fat,

                     v_Proced.Cd_Pro_Fat,

                     'N',

                     Ncdguia,

                     v_Mvto.Cd_Setor,

                     v_Mvto.Cd_Setor,

                     'N',

                     USER,

                     Ncdconsumo,

                     Nvl(Vtpcontapart, 'Consumo')

                     );

              END IF;

              /*OP 42241*/



            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

            os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

            IF Nqtexcedeu IS NOT NULL THEN

              Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregfat,

                                                                  Ncdlcto,

                                                                  (Nqtprofat -

                                                                  Nqtexcedeu),

                                                                  Vtpcontapart,

                                                                  Ddtreferencia);

            END IF;





            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

            os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

            IF Nqtexcedeu IS NOT NULL THEN

              Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregfat,

                                                                  Ncdlcto,

                                                                  (Nqtprofat -

                                                                  Nqtexcedeu),

                                                                  Vtpcontapart,

                                                                  Ddtreferencia,

																  nvl(v_mvto.cd_atendimento_pai,

                                                                      v_mvto.cd_atendimento)); /*ALLS OP 43289*/

            END IF;

            DECLARE

              CURSOR c_Relacionados IS

                SELECT Rela.Cd_Pro_Fat,

                       Rela.Tp_Atend_Homecare,

                       Rela.Tp_Atend_Externo,

                       Rela.Tp_Atend_Urgeme,

                       Rela.Tp_Atend_Ambulatorial,

                       Rela.Tp_Atend_Internacao

                       --PDA 108042 22/11/2004 Sp?ola (INICIO)

                       --Inserida a coluna qt_lancamento que ir?ultiplicar a quantidade na rotina Dbamv.lanca_ffcv_pro_relacionados

                      ,

                       Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

                --PDA 108042 (FIM)

                  FROM Dbamv.Con_Pla,

                       Dbamv.Regra,

                       Dbamv.Val_Pro_Relacionado Rela,

                       Dbamv.Empresa_Con_Pla /* PDA 118607/131598 */

                        ,dbamv.pro_fat             -- OP 32555 *2

                 WHERE Empresa_Con_Pla.Cd_Convenio = Con_Pla.Cd_Convenio /* PDA 118607/131598 */

                   AND Empresa_Con_Pla.Cd_Con_Pla = Con_Pla.Cd_Con_Pla /* PDA 118607/131598 */

                   AND Empresa_Con_Pla.Cd_Multi_Empresa =

                       Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/131598 */



					 -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

                     --AND Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat

					 and ( ( rela.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = rela.cd_pro_fat and Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					    or ( rela.cd_pro_fat_pai is null and rela.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                             AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

					     )

				     -- OP 32555 - fim



                   AND Con_Pla.Cd_Convenio = v_Mvto.Cd_Convenio

                   AND Con_Pla.Cd_Con_Pla = v_Mvto.Cd_Con_Pla

                   AND Rela.Tp_Lancamento = 'A'

                      --PDA 114239 17/01/2005 Sp?ola (INICIO)

                      --Incluida verifica? por tipo de atendimento para os procedimentos relacionados

                   AND ((v_Mvto.Tp_Atendimento = 'H' AND

                       Rela.Tp_Atend_Homecare = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'E' AND

                       Rela.Tp_Atend_Externo = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'U' AND

                       Rela.Tp_Atend_Urgeme = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'A' AND

                       Rela.Tp_Atend_Ambulatorial = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'I' AND

                       Rela.Tp_Atend_Internacao = 'S'))

                      --PDA 114239 (FIM)

                   AND Con_Pla.Cd_Regra = Regra.Cd_Regra

                   AND Rela.Cd_Regra = Regra.Cd_Regra

                   AND Rela.Dt_Vigencia IN

                       (SELECT MAX(Vpr.Dt_Vigencia)

                          FROM Dbamv.Val_Pro_Relacionado Vpr

                         WHERE Vpr.Dt_Vigencia <= v_Mvto.Dt_Atendimento

                           AND Vpr.Cd_Regra = Rela.Cd_Regra

                             -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

					         -- AND Vpr.Cd_Pro_Fat_Pai = Rela.Cd_Pro_Fat_Pai

					         -- AND Vpr.Cd_Pro_Fat = Rela.Cd_Pro_Fat

					         and ( ( Vpr.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = Vpr.cd_pro_fat and Vpr.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					            or ( Vpr.cd_pro_fat_pai is null and Vpr.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                                     AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

						          )

						     -- OP 32555 - fim

						   );

              Cretorno VARCHAR2(1);

            BEGIN

              FOR Rec_Rela IN c_Relacionados

              LOOP

                Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(v_Mvto.Cd_Atendimento,

                                                              Ncdregfat,

                                                              Ncdlcto,

                                                              Ncdconsumo,

                                                              v_Proced.Cd_Pro_Fat

                                                              /*PDA 116436 14/03/2005 Sp?ola(INICIO)

                                                                                                                            A data de passagem de parametro deve ser ddtreferencia utilizado no insert da fun?*/,

                                                              Ddtreferencia

                                                              /*PDA 116436 (FIM)*/,

                                                              v_Mvto.Hr_Atendimento,

                                                              v_Mvto.Cd_Setor,

                                                              'P',

                                                              v_Mvto.Tp_Atendimento,

                                                              v_Mvto.Dt_Atendimento,

                                                              v_Mvto.Cd_Convenio,

                                                              v_Mvto.Cd_Con_Pla,

                                                              v_Mvto.Cd_Atendimento_Pai,

                                                              v_Mvto.Tp_Convenio,

                                                              v_Mvto.Dt_Alta,

                                                              Rec_Rela.Cd_Pro_Fat, --PDA 108042 22/11/2004 Sp?ola (INICIO)

                                                              --As quantidades lan?a ser?ultiplicadas pelo fator de quantidade qt_lancamento

                                                              Rec_Rela.Qt_Lancamento *

                                                              Nqtprofat, --PDA 108042 (FIM)

                                                              0,

                                                              'I'

                                                              --PDA 108070 29/12/2004 Sp?ola (INICIO)

                                                              --Inserido o campo do prestador que ser?tilizado apenas para os procedimentos relacionados de ambulatorio

                                                              --lancadados pela prc_ffcv_lanca_atendimento - lancamento automatico do procedimento principal na criacao do atendimento

                                                             ,

                                                              NULL --cd_prestador

                                                              --PDA 108070 (FIM)

                                                              -- pda 119975 - 29/05/2005 - Amalia Ara??

                                                              -- par?tro de fator relacionado para insert nas tabelas itreg_amb e itreg_fat

                                                             ,

                                                              Rec_Rela.Qt_Lancamento

                                                              -- pda 119975 - fim

                                                              );

              END LOOP;

            END;

            IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                          Ncdlcto,

                                                          'I') THEN

              IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                            Ncdlcto,

                                                            'I') THEN

                Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'I');

              END IF;

            END IF;

          ELSE

            IF Deleting AND Nqtprofat = 1 THEN

              Nqtprofat := 0;

            END IF;

            IF Updating OR Deleting THEN

              Ndiferenca := Nqtprofat - Noldqtprofat;

            ELSE

              Ndiferenca := Nqtprofat;

            END IF;

            OPEN Dbamv.Pack_Lanca_Ffcv.c_Itregfat(Ncdregfat,

                                                  v_Proced.Cd_Pro_Fat);

            FETCH Dbamv.Pack_Lanca_Ffcv.c_Itregfat

              INTO v_Itregfat;

            CLOSE Dbamv.Pack_Lanca_Ffcv.c_Itregfat;

            -- PDA 167142 (Inicio) - Henrique Antunes - 27/10/2006

            Ncdregfat := v_Itregfat.Cd_Reg_Fat;

            -- PDA 167142 (Fim)

            Ncdlcto := v_Itregfat.Cd_Lancamento;

            IF v_Itregfat.Cd_Lancamento IS NOT NULL THEN

              IF v_Itregfat.Qt_Lancamento + Ndiferenca <= 0 THEN

                --IF NVL (v_conta.sn_abate_devolucao, 'S') = 'S' THEN --PDA 157595

                IF Nvl(v_Conta(1).Sn_Abate_Devolucao, 'S') = 'S' THEN

                  --PDA 157595

                  IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                                Ncdlcto,

                                                                'E') THEN

                    IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                                  Ncdlcto,

                                                                  'E') THEN

                      Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'E');

                    END IF;

                  END IF;

                  --

                  -- OP 684 - 13/12/2013 - corrigindo local de abertura do cursor, antes de deletar o registro na itreg_fat

                  Ncdguiaitem := NULL;

                  OPEN Dbamv.Pkg_Ffcv_Guia.Cguianoitem(Ncdregfat,

                                                       Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                           v_Mvto.Cd_Atendimento),

                                                       Ncdlcto);

                  FETCH Dbamv.Pkg_Ffcv_Guia.Cguianoitem

                    INTO Ncdguiaitem;

                  CLOSE Dbamv.Pkg_Ffcv_Guia.Cguianoitem;

                  --

                  DELETE Dbamv.Itreg_Fat

                   WHERE Cd_Reg_Fat = Ncdregfat

                     AND Cd_Lancamento = Ncdlcto;

                  /* pda 141006 - 06/06/2006 - Amalia Ara??

                  Identificando a guia do item. Caso encontre e a mesma ainda esteja Pendente.

                  Retirando o item da guia, caso haja e a guia ainda esteja Pendente. */

                  --

                  IF Ncdguiaitem IS NOT NULL THEN

                    Dbamv.Pkg_Ffcv_Guia.Prc_Retirar_Item_Guia(Ncdguiaitem,

                                                              v_Proced.Cd_Pro_Fat,

                                                              Nvl(Nqtlcto,

                                                                  0));

                  END IF;

                  /* pda 141006 - fim */

                  /* PDA 288525 - 05/06/2009 - Fim - Fabr?o Oliveira de Miranda */

                  --

                END IF;

              ELSE

                UPDATE Dbamv.Itreg_Fat

                   SET Qt_Lancamento           = Qt_Lancamento + Ndiferenca,

                       Vl_Unitario             = NULL,

                       Vl_Filme_Unitario       = NULL,

                       Vl_Acrescimo            = NULL,

                       Vl_Desconto             = NULL,

                       Vl_Honorario_Unitario   = NULL,

                       Vl_Operacional_Unitario = NULL,

                       Vl_Total_Conta          = NULL

                 WHERE Cd_Reg_Fat = Ncdregfat

                   AND Cd_Lancamento = Ncdlcto;

                IF NOT Dbamv.Pack_Ffcv.Regra_Atendimento_Hosp(Ncdregfat,

                                                              Ncdlcto,

                                                              'A') THEN

                  IF NOT Dbamv.Pack_Ffcv.Verif_Acoplamento_Hosp(Ncdregfat,

                                                                Ncdlcto,

                                                                'A') THEN

                    Verif_Franquia_Hosp(Ncdregfat, Ncdlcto, 'A');

                  END IF;

                END IF;

              END IF;

            END IF;

          END IF;

          /* pda 128810 - 10/08/2005 - Amalia Ara??

          Gravando registro Ambulatorial do Consumo.

          Obs.: n?existe devolu? de Consumo, por isso s??mos a rotina do Insert. */

        ELSE

          IF Inserting THEN

            -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

            IF Ctpproibicao = 'AG' THEN

              Csnguia := 'S';

            END IF;

            -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

            -- Prepara? da data que ser?assada na fun?.

            -- A data preparada ir?onter al?da data de lan?ento, a hora de lan?ento.

            Ddthraux := To_Date(To_Char(Ddtreferencia, 'DD/MM/YYYY') || ' ' ||

                                To_Char(Nvl(v_Mvto.Hr_Mvto_Estoque,

                                            Ddtreferencia),

                                        'HH24:MI:SS'),

                                'DD/MM/YYYY HH24:MI:SS');

            -- PDA 221500 (Fim)

            /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

            nQtExcedeu a vari?l retorna justamente a quantidade de procedimentos que deve ser lan?o no procedimento

            que pertence ao pacote, em seguida deve ser inserdio um outro procedimento com o que restou do lan?ento*/

            Nqtexcedeu := NULL;

            --

            /* OP 387 - Thiago Miranda de oliveira - Foi criado um novo par?tro de saida da fun? fnc_gera_pacote

            vTpContaPart a vari?l retorna justamente se o procedimento vai ser inserido em uma conta particular ou ira seguir

            o processo normalmente.*/

            Ncdpacote := Dbamv.Pkg_Ffcv_It_Conta.Fnc_Gera_Pacote(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                     v_Mvto.Cd_Atendimento),

                                                                 v_Mvto.Tp_Atendimento,

                                                                 Ncdconvconta,

                                                                 Ncdplanconta,

                                                                 Ncdregamb,

                                                                 v_Grfat.Cd_Gru_Fat,

                                                                 v_Proced.Cd_Pro_Fat,

                                                                 v_Mvto.Cd_Setor,

                                                                 NULL

                                                                 -- PDA 221500 (In?o) - 27/03/2008 - Diego Costa

                                                                 -- ,nvl(ddtreferencia,sysdate)

                                                                ,

                                                                 Nvl(Ddthraux,

                                                                     SYSDATE)

                                                                 -- PDA 221500 (Fim)

                                                                ,

                                                                 Ncdconsumo,

                                                                 NULL,

                                                                 'Consumo',

                                                                 Csnguia,

                                                                 Nqtprofat,

                                                                 Csnpacote,

                                                                 Nqtexcedeu -- OP 387

                                                                ,

                                                                 Vtpcontapart -- OP 387

                                                                ,

                                                                 NULL

                                                                 -- PDA 225086 (Inicio)

                                                                ,

                                                                 v_Mvto.Cd_Atendimento,

                                                                 NULL --pCdProFatPacote

                                                                ,

                                                                 Ncdlcto --pCdLancamento_pac

                                                                ,

                                                                 NULL); --preserva

            -- PDA 225086 (fim)

            /* pda 481126 - depois da FNC_GERA_PACOTE regravando o cd_lancamento_pac */

            IF v_Mvto.Tp_Atendimento NOT IN ('A', 'E', 'U') THEN

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlcto(Ncdregfat);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlcto

                INTO Ncdlcto;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlcto;

            ELSE

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Ncdregamb);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                INTO Ncdlcto;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;

            END IF;

            --

            IF Ncdpacote IS NOT NULL THEN

              UPDATE Dbamv.Conta_Pacote

                 SET Cd_Lancamento_Pac = Ncdlcto

               WHERE Cd_Conta_Pacote = Ncdpacote;

            END IF;

            /* pda 481126 - fim */

            /*OPEN dbamv.pack_lanca_ffcv.c_pacote (v_mvto.cd_atendimento, ncdregamb);

            FETCH dbamv.pack_lanca_ffcv.c_pacote INTO csnpacote;

            CLOSE dbamv.pack_lanca_ffcv.c_pacote;*/

            -- PDA 157145 (Fim)

            OPEN Catendsessao(v_Mvto.Cd_Atendimento);

            FETCH Catendsessao

              INTO Vcatendsessao;

            CLOSE Catendsessao;

            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o procedimento que ira ser inserido abaixo pertence a um pacote, e a qunatidade que sera inserida sera menor que a lan?a, a diferen?

            sera lan?a na rotina mais abaixo atravez da procedure PRC_DESVINCULA_PROCEDIMENTO*/

            /* Fazendo tratamento caso o procedimento esteja configurado no gabarito para ser inserido dentro de uma conta particular

            caso a variavel vTpContaPart esteja preenchida e a quantidade de lan?ento extra esteja nula. com iso deve ser procurado uma conta particular

            e um lan?ento para inseririr nesta conta.*/

            Nconta := NULL;

            Nlanc  := NULL;



			/*43289 - quebra de conta por quantidade de procedimento por atendimento*/

			/*A regra de pacote tem prioridade sobre essa regra, conforme vari?l Nqtexcedeu abaixo*/

			IF Nqtexcedeu IS NULL THEN

				if (not vSnCriouContaAutoAmb) then /*OP 46768*/

					  IF DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_EXISTE_CONF_QTD_ATEND_PAC(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																						 v_proced.cd_pro_fat,

																						 pEmpresa) THEN



						  Nqtexcedeu := DBAMV.pkg_ffcv_qtd_proc_atend_pac.FNC_RETORNA_QTD_LANC_PERIODO(Nvl(v_Mvto.Cd_Atendimento_Pai,v_Mvto.Cd_Atendimento),

																									   v_proced.cd_pro_fat,

																									   pEmpresa,

																									   ncdregamb,

																									   nqtprofat,

																									   pSnChamadoDaTela,

																									   pvSnJaExcedeuQtd,

																									   pvMensagem

																									   );

						  IF pvSnJaExcedeuQtd = 'S' THEN

							  Vtpcontapart := 'ProcPorAtend';

							  Nqtexcedeu   := NULL;

						  ELSE

								IF NVL(Nqtexcedeu,0) > 0 THEN

									Vtpcontapart := 'ProcPorAtend';

								END IF;

						  END IF;

					END IF;

				END IF;	/*OP 46768*/

		    END IF;

			/*43289*/



            IF Nvl(Vtpcontapart, 'X') <> 'X' AND Nqtexcedeu IS NULL THEN

              Nconta := Dbamv.Pack_Lanca_Ffcv.Criacontapacpartambu(Nvl(v_Mvto.Cd_Atendimento_Pai,

                                                                       v_Mvto.Cd_Atendimento));

              OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(Nconta);

              FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                INTO Nlanc;

              CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;



              /*43289*/

              ncdconvconta := v_particular.cd_convenio;

              ncdplanconta := v_particular.cd_con_pla;

              /*43289*/



            END IF;

            INSERT INTO Dbamv.Itreg_Amb

              (Cd_Reg_Amb,

               Cd_Lancamento,

               Hr_Lancamento,

               Qt_Lancamento,

               Cd_Gru_Fat,

               Cd_Pro_Fat,

               Cd_Atendimento,

               Cd_Con_Pla,

               Cd_Convenio,

               Sn_Fatura_Impressa,

               Sn_Fechada,

               Sn_Conta_Calculada,

               Cd_Guia,

               Sn_Pertence_Pacote,

               Vl_Percentual_Multipla,

               Cd_Setor,

               Cd_Setor_Produziu,

               Sn_Horario_Especial,

               Cd_Usuario,

               Cd_Mvto,

               Tp_Mvto,

               Dt_Sessao,

               Cd_Itmvto -- pda 114164

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Cd_Conta_Pacote

               -- PDA 157145 (Fim)

               )

            VALUES

              (Nvl(Nconta, Ncdregamb) -- OP 387

              ,

               Nvl(Nlanc, Ncdlcto) -- OP 387

              ,

               v_Mvto.Hr_Mvto_Estoque,

               Nvl(Nqtexcedeu, Nqtprofat) -- OP 387

              ,

               v_Grfat.Cd_Gru_Fat,

               v_Proced.Cd_Pro_Fat,

               Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

               Ncdplanconta,

               Ncdconvconta,

               'N',

               'N',

               'N',

               Ncdguia,

               Nvl(Csnpacote, 'N'),

               100,

               v_Mvto.Cd_Setor,

               v_Mvto.Cd_Setor,

               'N',

               USER,

               Ncdconsumo,

               Nvl(Vtpcontapart, 'Consumo') -- OP 387

              ,

               Decode(Vcatendsessao.Sn_Retorno,

                      'N',

                      NULL,

                      Decode(Vcatendsessao.Qt_Sessoes,

                             0,

                             NULL,

                             Vcatendsessao.Dt_Atendimento)),

               Ncditemmvto -- pda 114164

               -- PDA 157145 (Inicio) - Henrique Antunes - 04/12/2006

              ,

               Ncdpacote

               -- PDA 157145 (Fim)

               );



              /*OP 42241 - Caso tenha criado a conta por cargo paciente, devemos lan? o item para o convenio, plano, percentual definido na configura



              de quebra de conta por cargo paciente*/

              IF (vSnCriouContaAutoAmbCP) THEN

                   OPEN Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu(v_ContaCargoPacAmbu(1).cd_reg_amb);

                   FETCH Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu

                      INTO NcdlctoAmbCp;

                   CLOSE Dbamv.Pack_Lanca_Ffcv.c_Maxlctoambu;



                   INSERT INTO Dbamv.Itreg_Amb

                    (Cd_Reg_Amb,

                     Cd_Lancamento,

                     Hr_Lancamento,

                     Qt_Lancamento,

                     Cd_Gru_Fat,

                     Cd_Pro_Fat,

                     Cd_Atendimento,

                     Cd_Con_Pla,

                     Cd_Convenio,

                     Sn_Fatura_Impressa,

                     Sn_Fechada,

                     Sn_Conta_Calculada,

                     Cd_Guia,

                     Sn_Pertence_Pacote,

                     Vl_Percentual_Multipla,

                     Cd_Setor,

                     Cd_Setor_Produziu,

                     Sn_Horario_Especial,

                     Cd_Usuario,

                     Cd_Mvto,

                     Tp_Mvto,

                     Dt_Sessao,

                     Cd_Itmvto

                     )

                  VALUES

                    (v_ContaCargoPacAmbu(1).cd_reg_amb,

                     NcdlctoAmbCp,

                     v_Mvto.Hr_Mvto_Estoque,

                     Nvl(Nqtexcedeu, Nqtprofat),

                     v_Grfat.Cd_Gru_Fat,

                     v_Proced.Cd_Pro_Fat,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     vRegraCriaContaAutoCP(1).cd_con_pla_destino,

                     vRegraCriaContaAutoCP(1).cd_convenio_destino,

                     'N',

                     'N',

                     'N',

                     Ncdguia,

                     'N',

                     vRegraCriaContaAutoCP(1).vl_percentual_carga_familiar,

                     v_Mvto.Cd_Setor,

                     v_Mvto.Cd_Setor,

                     'N',

                     USER,

                     Ncdconsumo,

                     Nvl(Vtpcontapart, 'Consumo'),

                     Decode(Vcatendsessao.Sn_Retorno,

                            'N',

                             NULL,

                                  Decode(Vcatendsessao.Qt_Sessoes,

                                         0,

                                         NULL,

                                              Vcatendsessao.Dt_Atendimento)),

                     Ncditemmvto

                     );

              END IF;

              /*OP 42241*/



            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

            os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

            IF Nqtexcedeu IS NOT NULL THEN

              Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregamb,

                                                                  Ncdlcto,

                                                                  (Nqtprofat -

                                                                  Nqtexcedeu),

                                                                  Vtpcontapart,

                                                                  v_Mvto.Hr_Mvto_Estoque);

            END IF;





            /* OP 387 - Thiago miranda de oliveira - caso a rotina fnc_gera_pacote retornar com a vari?l   nQtExcedeu preenchida, significa

            que o lan?ento de pacote foi quebrado em dois procedimentos, um contendo os itens que pertencem ao pacote, e o outro contendo

            os itens que excederam ao pacote, sendo inserido em um outro procedimento atravez desta rotina abaixo.*/

            IF Nqtexcedeu IS NOT NULL THEN

              Dbamv.Pkg_Ffcv_It_Conta.Prc_Desvincula_Procedimento(Ncdregamb,

                                                                  Ncdlcto,

                                                                  (Nqtprofat -

                                                                  Nqtexcedeu),

                                                                  Vtpcontapart,

                                                                  v_Mvto.Hr_Mvto_Estoque,

																  nvl(v_mvto.cd_atendimento_pai,

                                                                      v_mvto.cd_atendimento)); /*ALLS OP 43289*/

            END IF;



            DECLARE

              CURSOR c_Relacionados IS

                SELECT Rela.Cd_Pro_Fat,

                       Rela.Tp_Atend_Homecare,

                       Rela.Tp_Atend_Externo,

                       Rela.Tp_Atend_Urgeme,

                       Rela.Tp_Atend_Ambulatorial,

                       Rela.Tp_Atend_Internacao,

                       Nvl(Rela.Qt_Lancamento, 1) Qt_Lancamento

                  FROM Dbamv.Con_Pla,

                       Dbamv.Regra,

                       Dbamv.Val_Pro_Relacionado Rela,

                       Dbamv.Empresa_Con_Pla /* PDA 118607/131598 */

                        ,dbamv.pro_fat             -- OP 32555 *2

                 WHERE Empresa_Con_Pla.Cd_Convenio = Con_Pla.Cd_Convenio /* PDA 118607/131598 */

                   AND Empresa_Con_Pla.Cd_Con_Pla = Con_Pla.Cd_Con_Pla /* PDA 118607/131598 */

                   AND Empresa_Con_Pla.Cd_Multi_Empresa =

                       Dbamv.Pkg_Mv2000.Le_Empresa /* PDA 118607/131598 */



					 -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

                     --AND Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat

					 and ( ( rela.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = rela.cd_pro_fat and Rela.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					    or ( rela.cd_pro_fat_pai is null and rela.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                             AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

					     )

				     -- OP 32555 - fim



                   AND Con_Pla.Cd_Convenio = v_Mvto.Cd_Convenio

                   AND Con_Pla.Cd_Con_Pla = v_Mvto.Cd_Con_Pla

                   AND Rela.Tp_Lancamento = 'A'

                   AND ((v_Mvto.Tp_Atendimento = 'H' AND

                       Rela.Tp_Atend_Homecare = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'E' AND

                       Rela.Tp_Atend_Externo = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'U' AND

                       Rela.Tp_Atend_Urgeme = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'A' AND

                       Rela.Tp_Atend_Ambulatorial = 'S') OR

                       (v_Mvto.Tp_Atendimento = 'I' AND

                       Rela.Tp_Atend_Internacao = 'S'))

                   AND Con_Pla.Cd_Regra = Regra.Cd_Regra

                   AND Rela.Cd_Regra = Regra.Cd_Regra

                   AND Rela.Dt_Vigencia IN

                       (SELECT MAX(Vpr.Dt_Vigencia)

                          FROM Dbamv.Val_Pro_Relacionado Vpr

                         WHERE Vpr.Dt_Vigencia <= v_Mvto.Dt_Mvto_Estoque

                           AND Vpr.Cd_Regra = Rela.Cd_Regra

                             -- OP 32555 *2 - op? por procedimento ou por grupo de procedimento

					         -- AND Vpr.Cd_Pro_Fat_Pai = Rela.Cd_Pro_Fat_Pai

					         -- AND Vpr.Cd_Pro_Fat = Rela.Cd_Pro_Fat

					         and ( ( Vpr.cd_pro_fat_pai is not null and pro_fat.cd_pro_fat = Vpr.cd_pro_fat and Vpr.Cd_Pro_Fat_Pai = v_Proced.Cd_Pro_Fat )

					            or ( Vpr.cd_pro_fat_pai is null and Vpr.cd_gru_pro_pai = (SELECT p.cd_gru_pro FROM dbamv.pro_fat p WHERE cd_pro_fat = v_Proced.Cd_Pro_Fat)

                                     AND pro_fat.cd_pro_fat = v_Proced.Cd_Pro_Fat )

						          )

						     -- OP 32555 - fim

						   );

              Cretorno VARCHAR2(1);

              Lentrar  VARCHAR2(1) := 'N';

            BEGIN

              FOR Rec_Rela IN c_Relacionados

              LOOP

                IF v_Mvto.Tp_Atendimento = 'U' AND

                   Rec_Rela.Tp_Atend_Urgeme = 'S' THEN

                  Lentrar := 'S';

                ELSIF v_Mvto.Tp_Atendimento = 'E' AND

                      Rec_Rela.Tp_Atend_Externo = 'S' THEN

                  Lentrar := 'S';

                ELSIF v_Mvto.Tp_Atendimento = 'A' AND

                      Rec_Rela.Tp_Atend_Ambulatorial = 'S' THEN

                  Lentrar := 'S';

                END IF;

                --

                IF Lentrar = 'S' THEN

                  --

                  Cretorno := Dbamv.Lanca_Ffcv_Pro_Relacionados(v_Mvto.Cd_Atendimento,

                                                                Ncdregamb,

                                                                Ncdlcto,

                                                                Ncdconsumo,

                                                                v_Proced.Cd_Pro_Fat,

                                                                v_Mvto.Dt_Mvto_Estoque,

                                                                v_Mvto.Hr_Mvto_Estoque,

                                                                v_Mvto.Cd_Setor,

                                                                'P',

                                                                v_Mvto.Tp_Atendimento,

                                                                NULL /*PDA 116436 14/03/2005 Sp?ola - Parametro tp_convenio n?utilizado pela fun?*/,

                                                                Ncdconvconta,

                                                                Ncdplanconta,

                                                                NULL,

                                                                NULL /*PDA 116436 14/03/2005 Sp?ola - Parametro tp_convenio n?utilizado pela fun?*/,

                                                                v_Mvto.Dt_Alta,

                                                                Rec_Rela.Cd_Pro_Fat

                                                                /* PDA 187369 (inicio) 16/05/2007 - FLAVIO LAGO */

                                                                /* || '@' */

                                                                /* || TO_CHAR (rec_rela.qt_lancamento) */

                                                                /* PDA 187369 (fim) 16/05/2007 - FLAVIO LAGO */

                                                                /* Procedimento Relacionado e Fator Relacionado */,

                                                                Rec_Rela.Qt_Lancamento *

                                                                Nqtprofat,

                                                                Rec_Rela.Qt_Lancamento *

                                                                Nqtprofat,

                                                                Caction,

                                                                NULL --cd_prestador

                                                                );

                END IF; -- IF lentrar = 'S' THEN

              END LOOP; -- FOR rec_rela IN c_relacionados LOOP

            END;

          END IF; -- IF INSERTING THEN

        END IF; -- ELSE (In?o do lan?ento na cta ambulatorial

      END IF; -- IF (v_mvto.tp_atendimento <> 'S') AND ...

      /* pda 128810 - fim */

    END IF;

    RETURN Cgravaatend;

  EXCEPTION

    WHEN Atend_Sem_Conta THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500 --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdconsumo,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Consumo',

                     '04'

                     --, 'Atendimento ' || v_mvto.cd_atendimento || ' n?possui conta aberta dispon?l'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_4',

                                                       'PACK_LANCA_FFCV',

                                                       'Atendimento %s n?possui Conta aberta/dispon?l.',



                                                       Arg_List(v_Mvto.Cd_Atendimento)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;

      /* pda 128810 - 12/08/2005 - Amalia Ara??

      Exception para rotina ambulatorial    */

    WHEN Conta_Sem_Item THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500  --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdconsumo,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Consumo',

                     '09'

                     --,'devolu? ou exclus?n?encontrou item na conta para efetuar a exclus?'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_10',

                                                       'PACK_LANCA_FFCV',

                                                       'devolu? ou Exclus?n?encontrou item na conta para efetuar a exclus?',

                                                       Arg_List()) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;

      /* pda 128810 - fim */

    WHEN Fora_Da_Conta THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500  --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdconsumo,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Consumo',

                     '08'

                     --,'Procedimento com proibi? tipo Fora da Conta'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_8',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento com proibi? tipo Fora da Conta.',



                                                       Arg_List()) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;

    WHEN Prod_Nao_Conf THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500  --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdconsumo,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Consumo',

                     '01'

                     --, 'Produto Na ' || ncdproduto || ' do Estoque(MGES) n?tem relacionamento com Faturamento de Convenio(FFCV)' -- pda 109477

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_5',

                                                       'PACK_LANCA_FFCV',

                                                       'Produto %s do Estoque n?tem relacionamento com Faturamento de convenio.',

                                                       Arg_List(Ncdproduto)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;

    WHEN Setor_Nao_Conf THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500  --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdconsumo,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Consumo',

                     '02'

                     --,    'Setor '

                     --  || LTRIM (TO_CHAR (v_mvto.cd_setor))

                     --  || ', Esp?e '

                     --  || LTRIM (TO_CHAR (v_proced.cd_especie))

                     --  || ' e Classe '

                     --  || LTRIM (TO_CHAR (v_proced.cd_classe))

                     --  || ' n?configurado para lan?ento'

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_6',

                                                       'PACK_LANCA_FFCV',

                                                       'Setor %s, especie %s e classe %s n?configurados para lan?ento.',

                                                       Arg_List(Ltrim(To_Char(v_Mvto.Cd_Setor)),

                                                                Ltrim(To_Char(v_Proced.Cd_Especie)),

                                                                Ltrim(To_Char(v_Proced.Cd_Classe)))) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;

    WHEN Proc_Proibido THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     Ncdregamb --PDA 233500  --v_contaambu(1).cd_reg_amb --v_contaambu.cd_reg_amb --PDA 157595

                    ,

                     Ncdconsumo,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Consumo',

                     '05'

                     --, 'Procedimento proibido para o Convenio ' || LTRIM (TO_CHAR (v_conta.cd_convenio)) || ' e Plano ' || LTRIM (TO_CHAR (v_conta.cd_con_pla)) --PDA 157595

                     --, 'Procedimento proibido para o Convenio ' || LTRIM (TO_CHAR (nCdConvConta)) || ' e Plano ' || LTRIM (TO_CHAR (nCdPlanConta)) --PDA 157595

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_7',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento proibido para o convenio %s e Plano %s.',

                                                       Arg_List(Ltrim(To_Char(Ncdconvconta)),

                                                                Ltrim(To_Char(Ncdplanconta)))) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;

	-- OP 32555

    WHEN Proc_Proibido_idade THEN

	  -- OP 33697 - 05/10/2015 - Substituindo Gera_Log_Falha por Raise_Application_Error.

      Raise_Application_Error(-20054, Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20','PACK_LANCA_FFCV',

                                'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.',

                                Arg_List(v_Proced.Cd_Pro_Fat)));

      /*Gera_Log_Falha(Ncdregfat ,

                     Ncdregamb,

                     Ncdconsumo,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Consumo',

                     '05',

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_20',

                                                       'PACK_LANCA_FFCV',

                                                       'Procedimento %s n?permitido para a Idade do Paciente! Verifique configura? no cadastro do Plano do convenio.' ,

                                                       Arg_List(v_Proced.Cd_Pro_Fat))

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);  */

      RETURN Cgravaatend;

    WHEN Auditoria_In_Loco THEN

      Gera_Log_Falha(Ncdregfat --PDA 233500 --v_conta(1).cd_reg_fat --v_conta.cd_reg_fat --PDA 157595

                    ,

                     NULL,

                     Ncdconsumo,

                     Ncditemmvto,

                     v_Proced.Cd_Pro_Fat,

                     'Consumo',

                     '10'

                     --, 'O periodo da conta ' || v_conta.cd_reg_fat || ' est?m auditoria in-loco no momento do lan?ento' --PDA 157595

                     --, 'O periodo da conta ' || v_conta(1).cd_reg_fat || ' est?m auditoria in-loco no momento do lan?ento' --PDA 157595

                    ,

                     Pkg_Rmi_Traducao.Extrair_Proc_Msg('MSG_15',

                                                       'PACK_LANCA_FFCV',

                                                       'O periodo da conta %s est?m auditoria in-loco no momento do lan?ento.',

                                                       Arg_List(v_Conta(1)

                                                                .Cd_Reg_Fat)) -- OP 10402

                    ,

                     v_Mvto.Tp_Atendimento,

                     Nvl(v_Mvto.Cd_Atendimento_Pai, v_Mvto.Cd_Atendimento),

                     TRUE,

                     Deleting,

                     Ddtreferencia);

      RETURN Cgravaatend;

  END;



  FUNCTION Verifica_Conta_Secundaria(Pcdatendimento    IN NUMBER,

                                     Pdtreferencia     IN DATE,

                                     Pcdconvenio       IN NUMBER,

                                     Pcdatendimentopai IN NUMBER)

    RETURN NUMBER IS

    CURSOR c_Acoplamento IS

      SELECT 'S'

        FROM Dbamv.Atendime,

             Dbamv.Regra_Acoplamento

       WHERE Atendime.Cd_Atendimento = Pcdatendimento

         AND Atendime.Cd_Multi_Empresa = Dbamv.Pkg_Mv2000.Le_Empresa

         AND Regra_Acoplamento.Cd_Convenio_Conta = Atendime.Cd_Convenio

         AND Regra_Acoplamento.Cd_Con_Pla_Conta = Atendime.Cd_Con_Pla

         AND Regra_Acoplamento.Cd_Convenio =

             Atendime.Cd_Convenio_Secundario

         AND Regra_Acoplamento.Cd_Con_Pla = Atendime.Cd_Con_Pla_Secundario

         AND Regra_Acoplamento.Tp_Atendimento IN ('T', 'I');

    --PDA 157595(INICIO) 14/04/2008 - Jansen Gallindo

    --v_contas              dbamv.pack_lanca_ffcv.c_conta%ROWTYPE;

    v_Contas Dbamv.Pkg_Ffcv_Conta.Tpconta;

    --PDA 157595(FIM) 14/04/2008 - Jansen Gallindo

    Vsn_Tem_Acoplamento VARCHAR2(1);

    Ncdregfat           Dbamv.Reg_Fat.Cd_Reg_Fat%TYPE /*number pda 254997*/

    ;

  BEGIN

    Vsn_Tem_Acoplamento := 'N';

    OPEN c_Acoplamento;

    FETCH c_Acoplamento

      INTO Vsn_Tem_Acoplamento;

    CLOSE c_Acoplamento;

    IF Nvl(Vsn_Tem_Acoplamento, 'N') = 'N' THEN

      --PDA 157595(INICIO) 14/04/2008 - Jansen Gallindo

      /*OPEN dbamv.pack_lanca_ffcv.c_conta (pcdatendimento

                                         ,pdtreferencia

                                         ,pcdconvenio

                                         ,pcdatendimentopai

                                         );

      FETCH dbamv.pack_lanca_ffcv.c_conta INTO v_contas;

      CLOSE dbamv.pack_lanca_ffcv.c_conta;*/

      v_Contas := Dbamv.Pkg_Ffcv_Conta.Fnc_Retorna_Conta(Pcdatendimento,

                                                         Pdtreferencia,

                                                         Pcdconvenio,

                                                         Pcdatendimentopai);

      --IF v_contas.cd_reg_fat IS NULL THEN

      IF v_Contas(1).Cd_Reg_Fat IS NULL THEN

        --PDA 157595(FIM) 14/04/2008 - Jansen Gallindo

        Ncdregfat := NULL;

      ELSE

        --ncdregfat := v_contas.cd_reg_fat; --PDA 157595

        Ncdregfat := v_Contas(1).Cd_Reg_Fat; --PDA 157595

      END IF;

    ELSE

      Ncdregfat := NULL;

    END IF;

    RETURN Ncdregfat;

  END;



  -- PDA 174061 02/03/2007 - Anderson Marcel - Apply

  FUNCTION Fnc_Substituicao_Procedimento(Pncdempresa  NUMBER,

                                         Pncdsetor    NUMBER,

                                         Pvprofat     VARCHAR2,

                                         Pddtvigencia DATE,

                                         Pvtpatend    VARCHAR2,

                                         Pvtpretorno  VARCHAR2,

										                     PcdConvenio  NUMBER DEFAULT NULL,   /*OP 28803*/

                                         pnRegraSubs  IN OUT NOCOPY NUMBER,  /*OP 44895*/

                                         pnCdPlano    NUMBER DEFAULT NULL,   /*OP 44895*/

                                         pnCdRegra    NUMBER DEFAULT NULL    /*OP 44895*/

                                         )

    RETURN VARCHAR2 IS

    Vregra VARCHAR2(8);

    /*

     PDA.: 289688 - 29/05/2009 - Emanoel Deivison (inicio)

     Descri?: Efetuado ajustes no cursor: "cProFat" da fun?: "FNC_SUBSTITUICAO_PROCEDIMENTO"

     onde foi trocado o sinal de igualdade "=" por um "in" e adicionado tamb?o valor: "T" (Todos) ficando

     assim: "in (pvTpAtend,'T')" Essa altera?s foram devido a necessidade de cobran?de mais de uma unidade

     para um mesmo medicamento.

    */

    CURSOR Cprofat IS

      SELECT Regra_Substituicao_Proced.Cd_Pro_Fat,

             Regra_Substituicao_Proced.cd_regra_substituicao_proced      /*OP 44895*/

        FROM Dbamv.Regra_Substituicao_Proced

       WHERE Regra_Substituicao_Proced.Cd_Multi_Empresa = Pncdempresa

         AND (Regra_Substituicao_Proced.Cd_Setor = Pncdsetor or Regra_Substituicao_Proced.Cd_Setor is null)   -- FATURCONV-2878

         AND Regra_Substituicao_Proced.Cd_Pro_Fat_Substituto = Pvprofat

         AND Regra_Substituicao_Proced.Dt_Vigencia <= Pddtvigencia

         AND Regra_Substituicao_Proced.Tp_Atendimento IN (Pvtpatend, 'T')

		     AND (Regra_Substituicao_Proced.cd_convenio = PcdConvenio OR Regra_Substituicao_Proced.cd_convenio IS NULL)

		     AND (Regra_Substituicao_Proced.cd_con_pla = pnCdPlano OR Regra_Substituicao_Proced.cd_con_pla IS NULL)       /* OP 44895 */

		     AND (Regra_Substituicao_Proced.cd_regra = pnCdRegra OR Regra_Substituicao_Proced.cd_regra IS NULL)           /* OP 44895 */

         ORDER BY cd_convenio, cd_con_pla, cd_regra;                                                                  /* OP 44895 */

    /*PDA.: 289688 - 29/05/2009 - Emanoel Deivison (fim)*/

    CURSOR Cprofatsub IS

      SELECT Regra_Substituicao_Proced.Cd_Pro_Fat_Substituto,

             Regra_Substituicao_Proced.cd_regra_substituicao_proced      /*OP 44895*/

        FROM Dbamv.Regra_Substituicao_Proced

       WHERE Regra_Substituicao_Proced.Cd_Multi_Empresa = Pncdempresa

         AND (Regra_Substituicao_Proced.Cd_Setor = Pncdsetor or Regra_Substituicao_Proced.Cd_Setor is null)   -- FATURCONV-2878

         AND Regra_Substituicao_Proced.Cd_Pro_Fat = Pvprofat

         AND Regra_Substituicao_Proced.Dt_Vigencia <= Pddtvigencia

         AND Regra_Substituicao_Proced.Tp_Atendimento IN (Pvtpatend, 'T')

		     AND (Regra_Substituicao_Proced.cd_convenio = PcdConvenio OR Regra_Substituicao_Proced.cd_convenio IS NULL)

		     AND (Regra_Substituicao_Proced.cd_con_pla = pnCdPlano OR Regra_Substituicao_Proced.cd_con_pla IS NULL)       /* OP 44895 */

		     AND (Regra_Substituicao_Proced.cd_regra = pnCdRegra OR Regra_Substituicao_Proced.cd_regra IS NULL)           /* OP 44895 */

         ORDER BY cd_convenio, cd_con_pla, cd_regra;                                                                  /* OP 44895 */

    -- PDA 230530 (Fim) - Jamerson Nunes Delfino

  BEGIN

    IF Pvtpretorno = 'P' THEN

      OPEN Cprofat;

      FETCH Cprofat INTO Vregra, pnRegraSubs;

      IF Cprofat%NOTFOUND THEN

        RETURN Pvprofat;

      ELSE

        RETURN Vregra;

      END IF;

      CLOSE Cprofat;

    ELSIF Pvtpretorno = 'S' THEN

      OPEN Cprofatsub;

      FETCH Cprofatsub INTO Vregra, pnRegraSubs;

      IF Cprofatsub%NOTFOUND THEN

        RETURN Pvprofat;

      ELSE

        RETURN Vregra;

      END IF;

      CLOSE Cprofatsub;

    END IF;

  END;



  FUNCTION Fnc_Substituicao_Procedimento2(Pncdempresa  NUMBER,

                                         Pncdsetor    NUMBER,

                                         Pvprofat     VARCHAR2,

                                         Pddtvigencia DATE,

                                         Pvtpatend    VARCHAR2,

                                         Pvtpretorno  VARCHAR2,

										                     PcdConvenio  NUMBER DEFAULT NULL,   /*OP 28803*/

                                       --  pnRegraSubs  IN OUT NOCOPY NUMBER,  /*OP 44895*/

                                         pnCdPlano    NUMBER DEFAULT NULL,   /*OP 44895*/

                                         pnCdRegra    NUMBER DEFAULT NULL    /*OP 44895*/

                                         )

    RETURN VARCHAR2 IS



    vProFat  VARCHAR2(100);

    nRegraSubstituicao  NUMBER := NULL;

  BEGIN



    vProFat := Fnc_Substituicao_Procedimento(Pncdempresa,

                                             Pncdsetor,

                                             Pvprofat,

                                             Pddtvigencia,

                                             Pvtpatend,

                                             Pvtpretorno,

                                             PcdConvenio,

                                             nRegraSubstituicao,

                                             pnCdPlano,

                                             pnCdRegra

                                              );

    RETURN vProFat;

  END;



  FUNCTION Fnc_Substituicao_Proced_Fator(Pncdempresa  NUMBER,

                                         Pncdsetor    NUMBER,

                                         Pvprofat     VARCHAR2,

                                         Pddtvigencia DATE,

                                         Pvtpatend    VARCHAR2,

                                         Pvtpretorno  VARCHAR2,

                                         Pnvalor      NUMBER,

                                         PcdConvenio  NUMBER DEFAULT NULL,   /*OP 28803*/

                                         pnCdPlano    NUMBER DEFAULT NULL,   /*OP 44895*/

                                         pnCdRegra    NUMBER DEFAULT NULL    /*OP 44895*/

                                         ) RETURN NUMBER IS



    Vfator   Dbamv.Regra_Substituicao_Proced.Vl_Fator_Multiplicacao%TYPE;

    Ctpfator Dbamv.Regra_Substituicao_Proced.Tp_Fator%TYPE;

    CURSOR Cdivisao IS

      SELECT Regra_Substituicao_Proced.Vl_Fator_Divisao,

             Regra_Substituicao_Proced.Tp_Fator

        FROM Dbamv.Regra_Substituicao_Proced

       WHERE Regra_Substituicao_Proced.Cd_Multi_Empresa = Pncdempresa

         AND (Regra_Substituicao_Proced.Cd_Setor = Pncdsetor or Regra_Substituicao_Proced.Cd_Setor is null)   -- FATURCONV-2878

         AND Regra_Substituicao_Proced.Cd_Pro_Fat_SUBSTITUTO = Pvprofat    -- OP 20083 - 28/05/2014 - trocando coluna cd_pro_fat por cd_pro_fat_substituto

         AND Regra_Substituicao_Proced.Dt_Vigencia <= Pddtvigencia

         AND Regra_Substituicao_Proced.Tp_Atendimento IN (Pvtpatend, 'T')

 		     AND (Regra_Substituicao_Proced.cd_convenio = PcdConvenio OR Regra_Substituicao_Proced.cd_convenio IS NULL)

		     AND (Regra_Substituicao_Proced.cd_con_pla = pnCdPlano OR Regra_Substituicao_Proced.cd_con_pla IS NULL)       /* OP 44895 */

		     AND (Regra_Substituicao_Proced.cd_regra = pnCdRegra OR Regra_Substituicao_Proced.cd_regra IS NULL)           /* OP 44895 */

         ORDER BY cd_convenio, cd_con_pla, cd_regra, Dt_Vigencia DESC ; -- 48600                                                                  /* OP 44895 */

    -- PDA 174061 (Fim)

    CURSOR Cmultiplicacao IS

      SELECT Regra_Substituicao_Proced.Vl_Fator_Multiplicacao,

             Regra_Substituicao_Proced.Tp_Fator

        FROM Dbamv.Regra_Substituicao_Proced

       WHERE Regra_Substituicao_Proced.Cd_Multi_Empresa = Pncdempresa

         AND (Regra_Substituicao_Proced.Cd_Setor = Pncdsetor or Regra_Substituicao_Proced.Cd_Setor is null)   -- FATURCONV-2878

		 AND Regra_Substituicao_Proced.Cd_Pro_Fat_Substituto = Pvprofat

         AND Regra_Substituicao_Proced.Dt_Vigencia <= Pddtvigencia

         AND Regra_Substituicao_Proced.Tp_Atendimento IN (Pvtpatend, 'T')

 		     AND (Regra_Substituicao_Proced.cd_convenio = PcdConvenio OR Regra_Substituicao_Proced.cd_convenio IS NULL)

		     AND (Regra_Substituicao_Proced.cd_con_pla = pnCdPlano OR Regra_Substituicao_Proced.cd_con_pla IS NULL)       /* OP 44895 */

		     AND (Regra_Substituicao_Proced.cd_regra = pnCdRegra OR Regra_Substituicao_Proced.cd_regra IS NULL)           /* OP 44895 */

         ORDER BY cd_convenio, cd_con_pla, cd_regra, Dt_Vigencia DESC; -- 48600                                                                  /* OP 44895 */

    -- PDA 174061 (Fim)

    nValor NUMBER ;

    vSnFatorInteSubs VARCHAR2(2);   -- RDBS

  BEGIN



  vSnFatorInteSubs :=  Nvl(dbamv.pkg_mv2000.le_configuracao ('FFCV' ,'SN_LANCA_FATOR_INTEIRO_REG_SUBST'),'N');   -- rdbs  -  ajuste na implementa? do pda 837922



    IF Pvtpretorno = 'P' THEN

      OPEN Cdivisao;

      FETCH Cdivisao

        INTO Vfator, Ctpfator;

      IF Cdivisao%NOTFOUND THEN

        RETURN Pnvalor;

      ELSE

        -- PDA 174061 (Inicio) - Henrique Antunes - 24/04/2007

        IF Nvl(Ctpfator, 'DQMV') = 'DQMV' THEN

          RETURN Pnvalor * Vfator;

        ELSE

        -- rdbs - inicio - ajuste na implementa? do pda 837922

          IF vSnFatorInteSubs = 'N'  THEN

            RETURN Pnvalor / Vfator;

          ELSE

            nValor := Pnvalor / Vfator ;

            IF Mod (Pnvalor ,Vfator  ) <> 0  THEN

              nValor := trunc(nValor) + 1 ;    -- OP 43062 - colocado trunc por orienta? de Raphanelli.



            END IF ;

            RETURN nValor ;

          END IF  ;

          -- rdbs - fim

        END IF;

        -- PDA 174061 (Fim)

      END IF;

      CLOSE Cdivisao;

    ELSIF Pvtpretorno = 'S' THEN

      OPEN Cmultiplicacao;

      FETCH Cmultiplicacao

        INTO Vfator, Ctpfator;

      IF Cmultiplicacao%NOTFOUND THEN

        RETURN Pnvalor;

      ELSE

        -- PDA 174061 (Inicio) - Henrique Antunes - 24/04/2007

        IF Nvl(Ctpfator, 'DQMV') = 'DQMV' THEN

          -- rdbs - inicio - ajuste na implementa? do pda 837922

          IF vSnFatorInteSubs = 'N'  THEN

            RETURN Pnvalor / Vfator;

          ELSE

            nValor := Pnvalor / Vfator ;

            IF Mod (Pnvalor ,Vfator  ) <> 0  THEN  -- rdbs

              nValor := trunc(nValor) + 1 ;    -- OP 43062 - colocado trunc por orienta? de Raphanelli.

            END IF ;

            RETURN nValor ;

          END IF  ;

          -- rdbs - fim

        ELSE

          RETURN Pnvalor * Vfator;

        END IF;

        -- PDA 174061 (Fim)

      END IF;

      CLOSE Cmultiplicacao;

    END IF;

  END;



  -- PDA 174061 Fim

END;
/

GRANT EXECUTE ON dbamv.pack_lanca_ffcv TO biconexao;
GRANT EXECUTE ON dbamv.pack_lanca_ffcv TO dbadw;
GRANT EXECUTE ON dbamv.pack_lanca_ffcv TO dbadwbi;
GRANT EXECUTE ON dbamv.pack_lanca_ffcv TO dbaportal;
GRANT EXECUTE ON dbamv.pack_lanca_ffcv TO dbaps;
GRANT EXECUTE ON dbamv.pack_lanca_ffcv TO dbasgu;
GRANT EXECUTE ON dbamv.pack_lanca_ffcv TO mv2000;
GRANT EXECUTE ON dbamv.pack_lanca_ffcv TO mvintegra;
GRANT EXECUTE ON dbamv.pack_lanca_ffcv TO ro_acsc_dbamv_exe_pack;
