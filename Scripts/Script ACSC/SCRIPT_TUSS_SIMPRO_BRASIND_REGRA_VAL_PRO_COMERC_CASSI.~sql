-- cassi,
with regconv as (
select
      distinct
      conv.cd_convenio,
     --  cpla.cd_con_pla,
       cpla.cd_regra,
       rg.ds_regra,
       irg.cd_gru_pro,
       irg.cd_tab_fat,
       irg.vl_percetual_pago,
       econv.cd_multi_empresa
        from convenio conv
inner join empresa_convenio econv on econv.cd_convenio = conv.cd_convenio
inner join con_pla cpla on cpla.cd_convenio = econv.cd_convenio
inner join empresa_con_pla ecpla on ecpla.cd_con_pla = cpla.cd_con_pla
and ecpla.cd_convenio = econv.cd_convenio
inner join regra rg on rg.cd_regra = cpla.Cd_Regra
inner join itregra irg on irg.cd_regra = rg.cd_regra
where conv.cd_convenio = 12 
--and ecpla.cd_con_pla = 1
)

select
*
from
(
select
distinct
pd.cd_produto,
pd.ds_produto,
pd.cd_especie,
esp.ds_especie,
pd.cd_classe,
cls.ds_classe,
pd.cd_sub_cla,
scl.ds_sub_cla,
epd.cd_registro anvisa,
CASE WHEN pd.ds_produto not like '%REF%' THEN null
     else SubStr(pd.ds_produto,instr(pd.ds_produto,' REF')+5,50)
     end REFERENCIA,
pf.cd_pro_fat,
pf.ds_pro_fat,
ts.cd_tuss,
ts.ds_tuss,
imp.cd_simpro,
ibra.cd_tiss cd_brasindice,
pf.cd_gru_pro,
gp.ds_gru_pro,
gp.cd_gru_fat,
gf.ds_gru_fat,
recon.cd_regra,
recon.ds_regra,
recon.cd_tab_Fat,
tf.ds_tab_fat,
recon.vl_percetual_pago,
pd.vl_ultima_entrada,
nvl(vp.vl_total,0)vl_puro,
(nvl(vp.vl_total,0)* recon.vl_percetual_pago)/100 vl_cassi
from
gru_pro gp
inner join pro_fat pf on pf.cd_gru_pro = gp.cd_gru_pro and pf.sn_ativo = 'S'
inner join gru_fat gf on gf.cd_gru_fat = gp.cd_gru_fat
inner join regconv recon on recon.cd_gru_pro = gp.cd_gru_pro
inner join tab_fat tf on tf.cd_tab_fat = recon.cd_tab_Fat
left join val_pro vp on vp.cd_pro_fat = pf.cd_pro_fat and vp.cd_tab_fat = recon.cd_tab_Fat
inner join produto pd on pd.cd_pro_fat = pf.cd_pro_fat
left join lab_pro epd on epd.cd_produto = pd.cd_produto
inner join especie esp on esp.cd_especie = pd.cd_especie
inner join classe cls on cls.cd_classe = pd.cd_classe and cls.cd_especie = esp.cd_especie
inner join sub_clas scl on scl.cd_sub_cla = pd.cd_sub_cla and scl.cd_classe = cls.cd_classe and scl.cd_especie = pd.cd_especie
left join imp_simpro imp on imp.cd_pro_fat = pf.cd_pro_fat and imp.cd_tab_fat = vp.cd_tab_fat
left join imp_bra ibra on ibra.cd_pro_fat = pf.cd_pro_fat and ibra.cd_tab_fat = vp.cd_tab_fat
left join tuss ts on ts.cd_pro_fat = pf.cd_pro_fat  and ts.cd_multi_empresa = recon.cd_multi_empresa
and ts.cd_tip_tuss in (20,19,00) --and ts.cd_convenio = recon.cd_convenio 
left join empresa_produto epr on epr.cd_produto = pd.cd_produto and epr.cd_multi_empresa = recon.cd_multi_empresa
where vp.dt_vigencia = (select MAX(vx.dt_vigencia) from val_pro vx where vx.cd_pro_fat = vp.cd_pro_fat and vx.cd_tab_fat = vp.cd_tab_fat)
---and ts.cd_tuss = '73295965'--
--and vp.cd_pro_fat in ('70264325')
and  gp.cd_gru_pro IN (91,8,95,89,96,7,43,15,71,94,92,12,44,9)
order by 1
)
;



--select * from tuss where cd_tip_tuss in (19,20,00) and cd_pro_fat = '70264325' 
/*select * from pro_fat where cd_pro_fat = '70264325'
select distinct cd_tab_fat, cd_pro_fat ,vl_total from val_pro where cd_TAb_FAt in (32,33,93,181,2127,2128,2129) and cd_pro_Fat in ('72471131')

'70263655',
'70263655',
'70852235',
'70852235',
'71349537',
'70846855',
'70846855',
'70860904',
'70860904',
'70903247',
'78217300',
'70862044',
'71377417',
'70193576',
'70193576',
'71348514',
'78259215',
'78259215',
'78401585',
'78337330',
'78271487',
'78271487',
'76073823',
'78377277',
'70259577',
'70259771',
'70259771',
'70259720',
'70259720',
'70259720',
'70259739',
'70259739',
'70223793',
'70224692',
'70373868',
'70903581',
'70908800',
'71054332',
'71054413',
'76073823',
'76076628',
'76245934',
'78234476',
'78234476',
'78259215',
'78337330',
'78349346',
'78350336',
'70705100',
'78377277',
'78401585',
'70270449',
'70116482',
'70265755',
'70268290',
'70268410',
'70852162',
'70853649',
'70855021',
'70880514',
'71187618',
'78275717',
'78343151',
'70270449',
'70116482',
'70852162',
'71955356',
'70855021',
'70265755',
'70268290',
'70268410',
'70270449',
'70701032',
'71355693',
'71355715',
'71377522',
'78343151',
'70116482',
'70268290',
'70268410',
'70270449',
'70852162',
'71187618',
'71348590',
'71355715',
'71377590',
'78275717',
'78282560',
'74010840',
'78282560',
'70194084',
'70200076',
'70270414',
'70270422',
'70270465',
'70270473',
'70358214',
'70853649',
'70880468',
'70880514',
'70360880',
'71955356',
'78282560',
'74010840',
'75385694',
'75856255',
'74658603',
'73682667',
'70200076',
'70051402',
'70240590',
'70259895',
'70265291',
'70265674',
'70265763',
'70051488',
'70091935',
'70240582',
'70240604',
'70240671',
'70259879',
'70263620',
'70265470',
'70857350',
'70857369',
'70857377',
'70902968',
'70902976',
'70968926',
'71347852',
'70265674',
'70051402',
'70240590',
'70259895',
'70265291',
'70265674',
'70265763',
'70051402',
'70051488',
'70051496',
'70712905',
'70857350',
'70857369',
'70857377',
'70051496',
'70265674',
'70360839',
'70861994',
'70862001',
'71323724',
'71348107',
'70240671',
'71348476',
'70862010',
'71347852',
'70265291',
'70862060',
'70019835',
'70091935',
'70240604',
'70259879',
'70259895',
'70263620',
'70265763',
'70862028',
'70051488',
'70240582',
'70240590',
'70240680',
'70259895',
'70265470',
'70857350',
'70857369',
'70857377',
'70902968',
'70902976',
'70968926',
'70071012',
'70895155',
'70265437',
'70265488',
'73813982',
'70014566',
'70017441',
'70051534',
'70260931',
'70264740',
'70265461',
'70268274',
'70268282',
'70360774',
'70856230',
'70856311',
'70245150',
'70851034',
'78221641',
'70258430',
'70242283',
'70242216',
'70242283',
'70265771',
'70265780',
'70270031',
'70270635',
'70270660',
'70853614',
'70853690',
'70243255',
'70258422',
'70258970',
'70259038',
'70259062',
'70259070',
'70259089',
'70259364',
'70259518',
'70259968',
'70260150',
'70260567',
'70260613',
'70260630',
'70264325',
'70267367',
'70269904',
'70269912',
'70269963',
'70270040',
'70270066',
'70270198',
'70270546',
'70358001',
'70853720',
'70861978',
'70902992',
'70242216',
'70242283',
'70265771',
'70265780',
'70270031',
'70270635',
'70270660',
'70853614',
'70853690',
'70861986',
'70034184',
'70259038',
'70861978',
'70861986',
'70242283',
'70258970',
'70259062',
'70265771',
'70270660',
'70259518',
'70264325',
'70270090',
'70265313',
'70271089',
'70242216',
'70260150',
'70260613',
'70260630',
'70269904',
'70270031',
'70243255',
'70259070',
'70259089',
'70260567',
'70265780',
'70267367',
'70269912',
'70269963',
'70270066',
'70270198',
'70270554',
'70270635',
'70272964',
'70853614',
'70853690',
'70853720',
'70902992',
'70242283',
'70243255',
'70259070',
'70259968',
'70269912',
'70270040',
'70270546',
'70358001',
'70853614',
'70853720',
'70902992',
'70034184',
'70259046',
'70259364',
'70882444',
'70861978',
'70861986',
'70034184',
'70270759',
'70259046',
'70240850',
'70242330',
'70242500',
'70242739',
'70244413',
'70244421',
'70259950',
'70265720',
'70267820',
'70271399',
'70242623',
'70243018',
'70243301',
'70243573',
'70258260',
'70259402',
'70259550',
'70260125',
'70260290',
'70261954',
'70264430',
'70265038',
'70265852',
'70267626',
'70270210',
'70270252',
'70270287',
'70271348',
'70855080',
'70855170',
'70241791',
'70240850',
'70242330',
'70242500',
'70242739',
'70244405',
'70244413',
'70244421',
'70259950',
'70264287',
'70265720',
'70267820',
'70271399',
'70243018',
'70258260',
'70259402',
'70261954',
'70265658',
'70716935',
'70259470',
'70242500',
'70244421',
'70260125',
'70267626',
'70034540',
'70259534',
'70259615',
'70265682',
'70270147',
'70270805',
'70241791',
'70265720',
'70272441',
'70242739',
'70259585',
'70242895',
'70243948',
'70244413',
'70271399',
'70240850',
'70242330',
'70242623',
'70265038',
'70265852',
'70270210',
'70243301',
'70243573',
'70244405',
'70260290',
'70264287',
'70267820',
'70270244',
'70270252',
'70270287',
'70271348',
'70855080',
'70855161',
'70855170',
'70243301',
'70243573',
'70259950',
'70261954',
'70270287',
'78283078',
'70244154',
'70264430',
'74014196',
'74014412',
'74014676',
'74015095',
'74015273',
'74015303',
'78283078',
'70240922',
'70241791',
'70243280',
'70243344',
'70243646',
'70244430',
'70244758',
'70261709',
'70262241',
'70262756',
'70262950',
'70270228',
'70270295',
'70270317',
'70699224',
'70716811',
'70716820',
'70716919',
'70716943',
'70716986',
'70765561',
'70858489',
'70883939',
'70959919',
'70034621',
'70270805',
'70699224',
'78283078',
'72471131',
'70034214',
'70852316',
'72471131',
'70020051',
'70033935',
'70852316',
'70852316',
'70705283',
'70852316')
*/


--SELECT * FROM IMP_BRA

